<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Evaluating Soil Legacy Data Sampling for DSM | Technical Manual on Soil Sampling Design.</title>
  <meta name="description" content="Chapter 2 Evaluating Soil Legacy Data Sampling for DSM | Technical Manual on Soil Sampling Design." />
  <meta name="generator" content="bookdown 0.36 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Evaluating Soil Legacy Data Sampling for DSM | Technical Manual on Soil Sampling Design." />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Chapter 2 Evaluating Soil Legacy Data Sampling for DSM | Technical Manual on Soil Sampling Design." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Evaluating Soil Legacy Data Sampling for DSM | Technical Manual on Soil Sampling Design." />
  
  <meta name="twitter:description" content="Chapter 2 Evaluating Soil Legacy Data Sampling for DSM | Technical Manual on Soil Sampling Design." />
  

<meta name="author" content="RodrÃ­guez Lado, L., Angelini, M.E, Naypewe, N., Luotto, I., Yigini, Y." />


<meta name="date" content="2023-12-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="creating-a-new-sampling-design.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="libs/plotly-binding-4.10.0/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil Sampling Design</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#conditioned-latin-hypercube-sampling-clhs"><i class="fa fa-check"></i>Conditioned Latin Hypercube Sampling (cLHS)</a></li>
</ul></li>
<li class="part"><span><b>Part one - Soil Legacy Data</b></span></li>
<li class="chapter" data-level="2" data-path="legacy_data.html"><a href="legacy_data.html"><i class="fa fa-check"></i><b>2</b> Evaluating Soil Legacy Data Sampling for DSM</a>
<ul>
<li class="chapter" data-level="2.1" data-path="legacy_data.html"><a href="legacy_data.html#data-preparation"><i class="fa fa-check"></i><b>2.1</b> Data Preparation</a></li>
<li class="chapter" data-level="2.2" data-path="legacy_data.html"><a href="legacy_data.html#representativeness-of-the-legacy-soil-data"><i class="fa fa-check"></i><b>2.2</b> Representativeness of the Legacy Soil Data</a></li>
</ul></li>
<li class="part"><span><b>I Part two - Soil Sampling Design</b></span></li>
<li class="chapter" data-level="3" data-path="creating-a-new-sampling-design.html"><a href="creating-a-new-sampling-design.html"><i class="fa fa-check"></i><b>3</b> Creating a new sampling design</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Global Soil Partnership</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Technical Manual on Soil Sampling Design.</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="legacy_data" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">Chapter 2</span> Evaluating Soil Legacy Data Sampling for DSM<a href="legacy_data.html#legacy_data" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Modelling techniques in Digital Soil Mapping involve the use of sampling point soil data, with its associated soil properties database, and a number of environmental covariates that will be used to ascertain the relationships of soil properties and the environment to then generalize the findings to locations where no samples have been compiled.</p>
<p>In soil sampling design, a crucial issue is to determine both the locations and the number of the samples to be compiled. In an optimal situation, soil sample database should adequately cover all the environmental diversity space in the study area with a frequency relative to the extent of the diversity in the environmental covariates.</p>
<p>When dealing with legacy soil data, a question that arises is if the data is representative of the environmental diversity within the study area. In this Chapter we present a method to answer this question and to build an alternative how many samples can be retrieved to cover the same environmental space as the existing soil data. The method follows the main findings in <span class="citation">(<a href="#ref-Malone" role="doc-biblioref">Malone, Minansy, and Brungard 2019</a>)</span> and developed as <code>R</code> scripts.</p>
<p>We adapted the original scripts to make use of vector <code>shp</code> and raster <code>tif</code> files, as these are data formats commonly used by GIS analysts and in which both soil and environmental data is often stored. We also made some changes in order to simplify the number of R packages and to avoid the use of deprecated packages as it appears in the original code.</p>
<div id="data-preparation" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> Data Preparation<a href="legacy_data.html#data-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We must first load the required packages and data for the analyses. We make use of the packages <code>sp</code> and <code>terra</code> to manipulate spatial data, <code>clhs</code> for Conditioned Latin Hypercube Sampling, <code>entropy</code> to compute Kullback-Leibler (KL) divergence indexes, <code>tripack</code> for Delaunay triangulation and <code>manipulate</code> for interactive plotting within RStudio. Ensure that all these packages are installed in your system before the execution of the script.</p>
<p>In this manual we recommend to use a common structure for the project, where R scripts appear in the root of the working directory and data files are in a <code>data/</code> directory within the root directory (<code>shp</code> and <code>tif</code> files should be within the sub folders <code>data/shapes</code> and <code>data/rasters</code> respectively. Following this recommendation simplifies the definition of paths and execution of the scripts. If users want to change their storage paths they have to be properly adjusted in the script.</p>
<p>We define the working directory to the directory in which the actual file is located and load the soil legacy sampling points and the environmental rasters from the <code>data</code> folder. To avoid the definition of each environmental covariate, we first retrieve all files with the <code>.tif</code> extension and then create a <code>SpatRaster</code> object with all of them in a row.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="legacy_data.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set working directory to source file location</span></span>
<span id="cb1-2"><a href="legacy_data.html#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="legacy_data.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Load soil legacy point data</span></span>
<span id="cb2-2"><a href="legacy_data.html#cb2-2" aria-hidden="true" tabindex="-1"></a>  p.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">vect</span>(<span class="st">&quot;data/shapes/legacy_soils.shp&quot;</span>)</span>
<span id="cb2-3"><a href="legacy_data.html#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="legacy_data.html#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Load raster covariate data----</span></span>
<span id="cb2-5"><a href="legacy_data.html#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb2-6"><a href="legacy_data.html#cb2-6" aria-hidden="true" tabindex="-1"></a>  rasters <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters&quot;</span></span>
<span id="cb2-7"><a href="legacy_data.html#cb2-7" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(rasters, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-8"><a href="legacy_data.html#cb2-8" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="legacy_data.html#cb3-1" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(cov.dat)</span></code></pre></div>
<div class="figure">
<img src="Technical_Manual-on-Sampling-Design_files/figure-html/plot_covdata-1.png" alt="Plot of the covariates" width="672" />
<p class="caption">
(#fig:plot_covdata)Plot of the covariates
</p>
</div>
</div>
<div id="representativeness-of-the-legacy-soil-data" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Representativeness of the Legacy Soil Data<a href="legacy_data.html#representativeness-of-the-legacy-soil-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The next step involves the determination of the distributions of environmental values in the soil samples data and its comparison with the existing distributions of each environmental variable to determine the representativeness of the soil points in the environmental space.</p>
<p>The comparison of distributions is performed through the Kullback-Leibler divergence (KL). It is a measure used to quantify the difference between two probability distributions.
KL-divergence compares an âobjectiveâ or reference probability distribution (here, the distribution of covariates in the complete covariate space - P) with a âmodelâ or approximate probability distribution (the space of covariates in the soil samples - Q). The main idea is to determine how much information is lost when Q is used to approximate P. In other words, KL-divergence measures how much the Q distribution deviates from the P distribution.</p>
<p>We cross soil and environmental data to create a dataset with the values of the environmental parameters at the locations of the soil samples.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="legacy_data.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract environmental data from rasters at soil locations ----</span></span>
<span id="cb4-2"><a href="legacy_data.html#cb4-2" aria-hidden="true" tabindex="-1"></a>  p.dat_I <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(cov.dat, p.dat)</span>
<span id="cb4-3"><a href="legacy_data.html#cb4-3" aria-hidden="true" tabindex="-1"></a>  p.dat_I <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(p.dat_I) <span class="co"># Remove soil points outside study area</span></span>
<span id="cb4-4"><a href="legacy_data.html#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>(p.dat_I)</span></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    238 obs. of  5 variables:
##  $ ID       : num  1 2 3 4 5 6 7 8 9 10 ...
##  $ ECd      : num  7.48 5.86 7.4 6.84 6.2 ...
##  $ ECs      : num  7.86 5.67 7.81 6.99 5.51 ...
##  $ elevation: num  127 127 127 127 127 ...
##  $ yield    : num  3.03 3.79 3.37 2.62 3.69 ...</code></pre>
<p>We first calculate a <code>n-matrix</code> with the values of the covariates dividing their distributions into <code>n</code> equally-spaced bins. Each bin captures the environmental variability within its interval in the total distribution. In this exercise, <code>n</code> equals to 25. The result is a 26Ã4 matrix, where the rows represent the upper and lower limit of the bin and (thus, 26 rows are required to represent 25 bins), and 4 correspond to the number of variables used as environmental proxies.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="legacy_data.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Number of bins</span></span>
<span id="cb6-2"><a href="legacy_data.html#cb6-2" aria-hidden="true" tabindex="-1"></a>  nb<span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb6-3"><a href="legacy_data.html#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#quantile matrix (of the covariate data)</span></span>
<span id="cb6-4"><a href="legacy_data.html#cb6-4" aria-hidden="true" tabindex="-1"></a>  q.mat<span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span>(nb<span class="sc">+</span><span class="dv">1</span>), <span class="at">ncol=</span> <span class="fu">nlyr</span>(cov.dat))</span>
<span id="cb6-5"><a href="legacy_data.html#cb6-5" aria-hidden="true" tabindex="-1"></a>  j<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb6-6"><a href="legacy_data.html#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(cov.dat)){ <span class="co">#note the index start here</span></span>
<span id="cb6-7"><a href="legacy_data.html#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#get a quantile matrix together of the covariates</span></span>
<span id="cb6-8"><a href="legacy_data.html#cb6-8" aria-hidden="true" tabindex="-1"></a>    ran1 <span class="ot">&lt;-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>]</span>
<span id="cb6-9"><a href="legacy_data.html#cb6-9" aria-hidden="true" tabindex="-1"></a>    step1<span class="ot">&lt;-</span> ran1<span class="sc">/</span>nb </span>
<span id="cb6-10"><a href="legacy_data.html#cb6-10" aria-hidden="true" tabindex="-1"></a>    q.mat[,j]<span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>], <span class="at">to =</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>], <span class="at">by =</span>step1)</span>
<span id="cb6-11"><a href="legacy_data.html#cb6-11" aria-hidden="true" tabindex="-1"></a>    j<span class="ot">&lt;-</span> j<span class="sc">+</span><span class="dv">1</span>}</span></code></pre></div>
<p>From this matrix, we compute the hypercube matrix of covariates in the whole covariate space.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="legacy_data.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hypercube of &quot;objective&quot; distribution (P) - covariates</span></span>
<span id="cb7-2"><a href="legacy_data.html#cb7-2" aria-hidden="true" tabindex="-1"></a>  cov.dat.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(cov.dat) <span class="co"># convert SpatRaster to dataframe</span></span>
<span id="cb7-3"><a href="legacy_data.html#cb7-3" aria-hidden="true" tabindex="-1"></a>  cov.mat<span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow=</span>nb, <span class="at">ncol=</span><span class="fu">ncol</span>(q.mat))</span>
<span id="cb7-4"><a href="legacy_data.html#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cov.dat.df)){ <span class="co"># the number of pixels</span></span>
<span id="cb7-5"><a href="legacy_data.html#cb7-5" aria-hidden="true" tabindex="-1"></a>      cntj<span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb7-6"><a href="legacy_data.html#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.df)){ <span class="co">#for each column</span></span>
<span id="cb7-7"><a href="legacy_data.html#cb7-7" aria-hidden="true" tabindex="-1"></a>      dd<span class="ot">&lt;-</span> cov.dat.df[i,j]  </span>
<span id="cb7-8"><a href="legacy_data.html#cb7-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb){  <span class="co">#for each quantile</span></span>
<span id="cb7-9"><a href="legacy_data.html#cb7-9" aria-hidden="true" tabindex="-1"></a>        kl<span class="ot">&lt;-</span> q.mat[k, cntj] </span>
<span id="cb7-10"><a href="legacy_data.html#cb7-10" aria-hidden="true" tabindex="-1"></a>        ku<span class="ot">&lt;-</span> q.mat[k<span class="sc">+</span><span class="dv">1</span>, cntj] </span>
<span id="cb7-11"><a href="legacy_data.html#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.na</span>(dd)) {</span>
<span id="cb7-12"><a href="legacy_data.html#cb7-12" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(<span class="st">&#39;Missing&#39;</span>)</span>
<span id="cb7-13"><a href="legacy_data.html#cb7-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-14"><a href="legacy_data.html#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;</span> dd <span class="sc">&lt;=</span> ku){cov.mat[k, cntj]<span class="ot">&lt;-</span> cov.mat[k, cntj] <span class="sc">+</span> <span class="dv">1</span>} </span>
<span id="cb7-15"><a href="legacy_data.html#cb7-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-16"><a href="legacy_data.html#cb7-16" aria-hidden="true" tabindex="-1"></a>      cntj<span class="ot">&lt;-</span> cntj<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb7-17"><a href="legacy_data.html#cb7-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-18"><a href="legacy_data.html#cb7-18" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>We then calculate the hypercube matrix of covariates in the sample space.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="legacy_data.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample data hypercube</span></span>
<span id="cb8-2"><a href="legacy_data.html#cb8-2" aria-hidden="true" tabindex="-1"></a>  h.mat<span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow=</span>nb, <span class="at">ncol=</span><span class="fu">ncol</span>(q.mat))</span>
<span id="cb8-3"><a href="legacy_data.html#cb8-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-4"><a href="legacy_data.html#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (ii <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p.dat_I)){ <span class="co"># the number of observations</span></span>
<span id="cb8-5"><a href="legacy_data.html#cb8-5" aria-hidden="true" tabindex="-1"></a>    cntj<span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb8-6"><a href="legacy_data.html#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (jj <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(p.dat_I)){ <span class="co">#for each column</span></span>
<span id="cb8-7"><a href="legacy_data.html#cb8-7" aria-hidden="true" tabindex="-1"></a>      dd<span class="ot">&lt;-</span> p.dat_I[ii,jj]  </span>
<span id="cb8-8"><a href="legacy_data.html#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (kk <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb){  <span class="co">#for each bin</span></span>
<span id="cb8-9"><a href="legacy_data.html#cb8-9" aria-hidden="true" tabindex="-1"></a>        kl<span class="ot">&lt;-</span> q.mat[kk, cntj] </span>
<span id="cb8-10"><a href="legacy_data.html#cb8-10" aria-hidden="true" tabindex="-1"></a>        ku<span class="ot">&lt;-</span> q.mat[kk<span class="sc">+</span><span class="dv">1</span>, cntj] </span>
<span id="cb8-11"><a href="legacy_data.html#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;</span> dd <span class="sc">&lt;=</span> ku){h.mat[kk, cntj]<span class="ot">&lt;-</span> h.mat[kk, cntj] <span class="sc">+</span> <span class="dv">1</span>}</span>
<span id="cb8-12"><a href="legacy_data.html#cb8-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-13"><a href="legacy_data.html#cb8-13" aria-hidden="true" tabindex="-1"></a>      cntj<span class="ot">&lt;-</span> cntj<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb8-14"><a href="legacy_data.html#cb8-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-15"><a href="legacy_data.html#cb8-15" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<ul>
<li><strong>KL-divergence</strong></li>
</ul>
<p>We calculate the KL-divergence to measure how much the distribution of covariates in tbe sample space (Q) deviates from the distribution of covariates in the complete study area space (P).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="legacy_data.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Compare covariate distributions in P and Q with Kullback-Leibler (KL) divergence</span></span>
<span id="cb9-2"><a href="legacy_data.html#cb9-2" aria-hidden="true" tabindex="-1"></a>    kl.index <span class="ot">&lt;-</span><span class="fu">c</span>()</span>
<span id="cb9-3"><a href="legacy_data.html#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.df)){</span>
<span id="cb9-4"><a href="legacy_data.html#cb9-4" aria-hidden="true" tabindex="-1"></a>      kl <span class="ot">&lt;-</span>    <span class="fu">KL.empirical</span>(<span class="fu">c</span>(cov.mat[,i]), <span class="fu">c</span>(h.mat[,i]))</span>
<span id="cb9-5"><a href="legacy_data.html#cb9-5" aria-hidden="true" tabindex="-1"></a>      kl.index <span class="ot">&lt;-</span> <span class="fu">c</span>(kl.index,kl)</span>
<span id="cb9-6"><a href="legacy_data.html#cb9-6" aria-hidden="true" tabindex="-1"></a>      klo <span class="ot">&lt;-</span>  <span class="fu">mean</span>(kl.index)</span>
<span id="cb9-7"><a href="legacy_data.html#cb9-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-8"><a href="legacy_data.html#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(kl.index) <span class="co"># KL divergences of each covariate</span></span></code></pre></div>
<pre><code>## [1] 0.04115895 0.04241792 0.02779852 0.04328375</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="legacy_data.html#cb11-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(klo) <span class="co"># KL divergence in the existing soil samples</span></span></code></pre></div>
<pre><code>## [1] 0.03866478</code></pre>
<p>The KL-divergence is always greater than or equal to zero, and reaches its minimum value (zero) only when P and Q are identical. Thus, lower values of KL-divergence are indicative of a good match between both the sample and the study area spaces, indicating that the sample space is a fair representation of the environmental conditions in the study area.</p>
<p>In this case, the KL-divergence value is 0.039, indicating that the legacy samples capture most of the environmental variability in the study area.</p>
<ul>
<li><strong>Percent of representativeness in relation to the overall environmental conditions</strong></li>
</ul>
<p>Finally, we can also determine the degree in which our legacy soil dataset is representative of the existing environmental conditions in the study area. For that, we calculate the proportion of pixels in the study area that would fall within the convex hull polygon delineated upon the environmental conditions found at the soil legacy data locations only. The convex hull polygon is created upon a Principal Component transformation of the covariate data in the soil legacy data and using the outter limits of the scores of the points projected on the two main Components.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="legacy_data.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Representativeness of the Legacy Dataset: ----</span></span>
<span id="cb13-2"><a href="legacy_data.html#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate the proportion of &quot;env. variables&quot; in the covariate spectra that fall within the convex hull of variables in the &quot;environmental sample space&quot;</span></span>
<span id="cb13-3"><a href="legacy_data.html#cb13-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-4"><a href="legacy_data.html#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Principal component of the legacy data sample</span></span>
<span id="cb13-5"><a href="legacy_data.html#cb13-5" aria-hidden="true" tabindex="-1"></a>    pca.s <span class="ot">=</span> <span class="fu">prcomp</span>(p.dat_I[,<span class="dv">2</span><span class="sc">:</span>(<span class="fu">ncol</span>(cov.dat.df)<span class="sc">+</span><span class="dv">1</span>)],<span class="at">scale=</span><span class="cn">TRUE</span>, <span class="at">center=</span><span class="cn">TRUE</span>)</span>
<span id="cb13-6"><a href="legacy_data.html#cb13-6" aria-hidden="true" tabindex="-1"></a>    scores_pca1 <span class="ot">=</span> <span class="fu">as.data.frame</span>(pca.s<span class="sc">$</span>x)</span>
<span id="cb13-7"><a href="legacy_data.html#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the first 2 principal components and convex hull</span></span>
<span id="cb13-8"><a href="legacy_data.html#cb13-8" aria-hidden="true" tabindex="-1"></a>    rand.tr <span class="ot">&lt;-</span> <span class="fu">tri.mesh</span>(scores_pca1[,<span class="dv">1</span>],scores_pca1[,<span class="dv">2</span>],<span class="st">&quot;remove&quot;</span>) <span class="co"># Delaunay triangulation </span></span>
<span id="cb13-9"><a href="legacy_data.html#cb13-9" aria-hidden="true" tabindex="-1"></a>    rand.ch<span class="ot">&lt;-</span><span class="fu">convex.hull</span>(rand.tr, <span class="at">plot.it=</span>F) <span class="co"># convex hull</span></span>
<span id="cb13-10"><a href="legacy_data.html#cb13-10" aria-hidden="true" tabindex="-1"></a>    pr_poly <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x=</span><span class="fu">c</span>(rand.ch<span class="sc">$</span>x),<span class="at">y=</span><span class="fu">c</span>(rand.ch<span class="sc">$</span>y)) <span class="co"># save the convex hull vertices</span></span>
<span id="cb13-11"><a href="legacy_data.html#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(scores_pca1[,<span class="dv">1</span>], scores_pca1[,<span class="dv">2</span>], <span class="at">xlab=</span><span class="st">&quot;PCA 1&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;PCA 2&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])),<span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">main=</span><span class="st">&#39;Convex hull of soil legacy data&#39;</span>)</span>
<span id="cb13-12"><a href="legacy_data.html#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(<span class="fu">c</span>(rand.ch<span class="sc">$</span>x,rand.ch<span class="sc">$</span>x[<span class="dv">1</span>]), <span class="fu">c</span>(rand.ch<span class="sc">$</span>y,rand.ch<span class="sc">$</span>y[<span class="dv">1</span>]),<span class="at">col=</span><span class="st">&quot;red&quot;</span>,<span class="at">lwd=</span><span class="dv">1</span>) <span class="co"># draw the convex hull (domain of legacy data)</span></span></code></pre></div>
<p><img src="Technical_Manual-on-Sampling-Design_files/figure-html/legacy_data_adequacy-1.png" width="672" /></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="legacy_data.html#cb14-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PCA projection of study area population onto the principal components</span></span>
<span id="cb14-2"><a href="legacy_data.html#cb14-2" aria-hidden="true" tabindex="-1"></a>    PCA_projection<span class="ot">&lt;-</span> <span class="fu">predict</span>(pca.s, cov.dat.df) <span class="co"># Project study area population onto sample PC</span></span>
<span id="cb14-3"><a href="legacy_data.html#cb14-3" aria-hidden="true" tabindex="-1"></a>    newScores <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x=</span>PCA_projection[,<span class="dv">1</span>],<span class="at">y=</span>PCA_projection[,<span class="dv">2</span>]) <span class="co"># PC scores of projected population</span></span>
<span id="cb14-4"><a href="legacy_data.html#cb14-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-5"><a href="legacy_data.html#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the polygon and all points to be checked</span></span>
<span id="cb14-6"><a href="legacy_data.html#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(newScores, <span class="at">xlab=</span><span class="st">&quot;PCA 1&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;PCA 2&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">col=</span><span class="st">&#39;black&#39;</span>, <span class="at">main=</span><span class="st">&#39;Environmental space plots over the convex hull of soil legacy data&#39;</span>)</span>
<span id="cb14-7"><a href="legacy_data.html#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">polygon</span>(pr_poly,<span class="at">col=</span><span class="st">&#39;#99999990&#39;</span>)</span>
<span id="cb14-8"><a href="legacy_data.html#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check which points fall within the polygon</span></span>
<span id="cb14-9"><a href="legacy_data.html#cb14-9" aria-hidden="true" tabindex="-1"></a>    pip <span class="ot">&lt;-</span> <span class="fu">point.in.polygon</span>(newScores[,<span class="dv">2</span>], newScores[,<span class="dv">1</span>], pr_poly[,<span class="dv">2</span>],pr_poly[,<span class="dv">1</span>],<span class="at">mode.checked=</span><span class="cn">FALSE</span>)</span>
<span id="cb14-10"><a href="legacy_data.html#cb14-10" aria-hidden="true" tabindex="-1"></a>    newScores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(newScores, pip))</span>
<span id="cb14-11"><a href="legacy_data.html#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot points outside convex hull  </span></span>
<span id="cb14-12"><a href="legacy_data.html#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(newScores[<span class="fu">which</span>(newScores<span class="sc">$</span>pip<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="at">pch=</span><span class="st">&#39;X&#39;</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="Technical_Manual-on-Sampling-Design_files/figure-html/legacy_data_adequacy-2.png" width="672" /></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="legacy_data.html#cb15-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Proportion of the conditions in the study area that fall within the convex hull</span></span>
<span id="cb15-2"><a href="legacy_data.html#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(newScores<span class="sc">$</span>pip)<span class="sc">/</span><span class="fu">nrow</span>(newScores)<span class="sc">*</span><span class="dv">100</span> </span></code></pre></div>
<pre><code>## [1] 96.50188</code></pre>
<p>This indicates that 96.5% of the existing conditions in the study area fall within the convex hull delineated with the data in the soil samples, showing the adecquacy of the proposed legacy data for DSM.</p>

</div>
</div>



<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Malone" class="csl-entry">
Malone, Brendan P, Budiman Minansy, and Colby Brungard. 2019. <span>âSome Methods to Improve the Utility of Conditioned Latin Hypercube Sampling.â</span> <em>PeerJ</em> 7: e6451. <a href="https://doi.org/10.7717/peerj.6451">https://doi.org/10.7717/peerj.6451</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="creating-a-new-sampling-design.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/luislado/bookdown-tutorial/edit/master/02-legacy_data.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Technical_Manual on Sampling Design.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
