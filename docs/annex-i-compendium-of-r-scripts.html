<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Annex I: Compendium of R scripts |  Soil Sampling Design</title>
  <meta name="description" content="Soil Sampling Design - SoilFer Project" />
  <meta name="generator" content="bookdown 0.36 and GitBook 2.6.7" />

  <meta property="og:title" content="Annex I: Compendium of R scripts |  Soil Sampling Design" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/images/frontcover.png" />
  <meta property="og:description" content="Soil Sampling Design - SoilFer Project" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Annex I: Compendium of R scripts |  Soil Sampling Design" />
  
  <meta name="twitter:description" content="Soil Sampling Design - SoilFer Project" />
  <meta name="twitter:image" content="/images/frontcover.png" />

<meta name="author" content="Rodríguez Lado, L., Angelini, M.E, Naypewe, N., Luotto, I., Yigini, Y." />


<meta name="date" content="2024-01-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="conditioned-latin-hypercube-sampling.html"/>
<link rel="next" href="references.html"/>
<script src="assets/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="assets/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="assets/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="assets/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="assets/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="assets/plotly-binding-4.10.0/plotly.js"></script>
<script src="assets/typedarray-0.1/typedarray.min.js"></script>
<link href="assets/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="assets/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="assets/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="assets/plotly-main-2.5.1/plotly-latest.min.js"></script>
<link href="assets/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="assets/leaflet-1.3.1/leaflet.js"></script>
<link href="assets/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="assets/proj4-2.6.2/proj4.min.js"></script>
<script src="assets/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="assets/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="assets/leaflet-binding-2.1.1/leaflet.js"></script>
<link href="assets/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="assets/HomeButton-0.0.1/home-button.js"></script>
<script src="assets/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="assets/clipboard-0.0.1/setClipboardText.js"></script>
<link href="assets/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="assets/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="assets/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="assets/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil Samping Design</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#training-material"><i class="fa fa-check"></i><b>1.1</b> Training material</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html"><i class="fa fa-check"></i><b>2</b> Setting-up the software environment</a>
<ul>
<li class="chapter" data-level="2.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#use-of-r-rstudio-and-r-packages"><i class="fa fa-check"></i><b>2.1</b> Use of R, RStudio and R Packages</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-r"><i class="fa fa-check"></i><b>2.1.1</b> Obtaining and installing R</a></li>
<li class="chapter" data-level="2.1.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-rstudio"><i class="fa fa-check"></i><b>2.1.2</b> Obtaining and installing RStudio</a></li>
<li class="chapter" data-level="2.1.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#getting-started-with-r"><i class="fa fa-check"></i><b>2.1.3</b> Getting started with R</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-packages"><i class="fa fa-check"></i><b>2.2</b> R packages</a></li>
<li class="chapter" data-level="2.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#gee---google-earth-engine"><i class="fa fa-check"></i><b>2.3</b> GEE - google earth engine</a></li>
</ul></li>
<li class="part"><span><b>Part one – Soil Legacy Data</b></span></li>
<li class="chapter" data-level="3" data-path="legacy_data.html"><a href="legacy_data.html"><i class="fa fa-check"></i><b>3</b> Evaluating Soil Legacy Data Sampling for DSM</a>
<ul>
<li class="chapter" data-level="3.1" data-path="legacy_data.html"><a href="legacy_data.html#data-preparation"><i class="fa fa-check"></i><b>3.1</b> Data Preparation</a></li>
<li class="chapter" data-level="3.2" data-path="legacy_data.html"><a href="legacy_data.html#representativeness-of-the-legacy-soil-data"><i class="fa fa-check"></i><b>3.2</b> Representativeness of the Legacy Soil Data</a></li>
</ul></li>
<li class="part"><span><b>I Part two – Soil Sampling Design</b></span></li>
<li class="chapter" data-level="4" data-path="determining-the-minimum-sampling-size.html"><a href="determining-the-minimum-sampling-size.html"><i class="fa fa-check"></i><b>4</b> Determining the minimum sampling size</a></li>
<li class="chapter" data-level="5" data-path="stratified-simple-random-sampling.html"><a href="stratified-simple-random-sampling.html"><i class="fa fa-check"></i><b>5</b> Stratified Simple Random Sampling</a>
<ul>
<li class="chapter" data-level="5.1" data-path="stratified-simple-random-sampling.html"><a href="stratified-simple-random-sampling.html#general-procedure"><i class="fa fa-check"></i><b>5.1</b> General Procedure</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="stratified-simple-random-sampling.html"><a href="stratified-simple-random-sampling.html#strata-creation"><i class="fa fa-check"></i><b>5.1.1</b> Strata creation</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="stratified-simple-random-sampling.html"><a href="stratified-simple-random-sampling.html#stratified-random-sampling"><i class="fa fa-check"></i><b>5.2</b> Stratified random sampling</a></li>
<li class="chapter" data-level="5.3" data-path="stratified-simple-random-sampling.html"><a href="stratified-simple-random-sampling.html#stratified-simple-random-sampling-for-large-areas"><i class="fa fa-check"></i><b>5.3</b> Stratified simple random sampling for large areas</a></li>
<li class="chapter" data-level="5.4" data-path="stratified-simple-random-sampling.html"><a href="stratified-simple-random-sampling.html#stratified-simple-regular-sampling"><i class="fa fa-check"></i><b>5.4</b> Stratified simple regular sampling</a></li>
<li class="chapter" data-level="5.5" data-path="stratified-simple-random-sampling.html"><a href="stratified-simple-random-sampling.html#simple-random-sampling-based-on-a-stratified-raster"><i class="fa fa-check"></i><b>5.5</b> Simple Random Sampling based on a stratified raster</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html"><i class="fa fa-check"></i><b>6</b> Conditioned Latin Hypercube Sampling</a>
<ul>
<li class="chapter" data-level="6.1" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#clhs-design"><i class="fa fa-check"></i><b>6.1</b> cLHS Design</a></li>
<li class="chapter" data-level="6.2" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#including-existing-legacy-data-in-a-clhs-sampling-design"><i class="fa fa-check"></i><b>6.2</b> Including existing legacy data in a cLHS sampling design</a></li>
<li class="chapter" data-level="6.3" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#working-with-large-raster-data"><i class="fa fa-check"></i><b>6.3</b> Working with large raster data</a></li>
<li class="chapter" data-level="6.4" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#implementation-of-costconstrained-clhs-sampling"><i class="fa fa-check"></i><b>6.4</b> Implementation of cost–constrained cLHS sampling</a></li>
<li class="chapter" data-level="6.5" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#replacement-areas-in-clhs-design"><i class="fa fa-check"></i><b>6.5</b> Replacement areas in cLHS design</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html"><i class="fa fa-check"></i>Annex I: Compendium of R scripts</a>
<ul>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-1-introduction-to-r"><i class="fa fa-check"></i>Script 1: Introduction to R</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-2-download-environmental-covariates"><i class="fa fa-check"></i>Script 2: Download environmental covariates</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-3-evaluate-legacy-data"><i class="fa fa-check"></i>Script 3: Evaluate Legacy Data</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-4-calculate-minimum-sample-size"><i class="fa fa-check"></i>Script 4: Calculate Minimum Sample Size</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-5-stratified-sampling-on-vector-and-raster-data"><i class="fa fa-check"></i>Script 5: Stratified sampling on vector and raster data</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-6-conditional-latin-hypercube-sampling"><i class="fa fa-check"></i>Script 6: Conditional Latin Hypercube Sampling</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://www.fao.org/global-soil-partnership/" target="blank">Global Soil Partnership</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p><img src="images/frontcover.jpg" style="top:0px;height:150px;" align="right" />
Soil Sampling Design</p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="annex-i-compendium-of-r-scripts" class="section level1 unnumbered hasAnchor">
<h1>Annex I: Compendium of R scripts<a href="annex-i-compendium-of-r-scripts.html#annex-i-compendium-of-r-scripts" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter compiles the complete list of R scripts involved in the process of soil sampling design.</p>
<div id="script-1-introduction-to-r" class="section level2 unnumbered hasAnchor">
<h2>Script 1: Introduction to R<a href="annex-i-compendium-of-r-scripts.html#script-1-introduction-to-r" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="annex-i-compendium-of-r-scripts.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduction to R</span></span>
<span id="cb66-2"><a href="annex-i-compendium-of-r-scripts.html#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="annex-i-compendium-of-r-scripts.html#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 0. Playground =================================================</span></span>
<span id="cb66-4"><a href="annex-i-compendium-of-r-scripts.html#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="annex-i-compendium-of-r-scripts.html#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co"># learn important keyboard shortcuts</span></span>
<span id="cb66-6"><a href="annex-i-compendium-of-r-scripts.html#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ctrl + enter for running code</span></span>
<span id="cb66-7"><a href="annex-i-compendium-of-r-scripts.html#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># tab after writing the first three </span></span>
<span id="cb66-8"><a href="annex-i-compendium-of-r-scripts.html#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co"># characters of the function name</span></span>
<span id="cb66-9"><a href="annex-i-compendium-of-r-scripts.html#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># F1 to access the help</span></span>
<span id="cb66-10"><a href="annex-i-compendium-of-r-scripts.html#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="annex-i-compendium-of-r-scripts.html#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="co"># explore the use of &lt;-, $, [], ==, !=, c(), :, </span></span>
<span id="cb66-12"><a href="annex-i-compendium-of-r-scripts.html#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="co"># data.frame(), list(), as.factor()</span></span>
<span id="cb66-13"><a href="annex-i-compendium-of-r-scripts.html#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="annex-i-compendium-of-r-scripts.html#cb66-14" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">15</span></span>
<span id="cb66-15"><a href="annex-i-compendium-of-r-scripts.html#cb66-15" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">2</span>]</span>
<span id="cb66-16"><a href="annex-i-compendium-of-r-scripts.html#cb66-16" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb66-17"><a href="annex-i-compendium-of-r-scripts.html#cb66-17" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;a&quot;</span>, a )</span>
<span id="cb66-18"><a href="annex-i-compendium-of-r-scripts.html#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(b)</span>
<span id="cb66-19"><a href="annex-i-compendium-of-r-scripts.html#cb66-19" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">column_a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="at">column_b =</span> b)</span>
<span id="cb66-20"><a href="annex-i-compendium-of-r-scripts.html#cb66-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-21"><a href="annex-i-compendium-of-r-scripts.html#cb66-21" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">1</span>]</span>
<span id="cb66-22"><a href="annex-i-compendium-of-r-scripts.html#cb66-22" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>column_b</span>
<span id="cb66-23"><a href="annex-i-compendium-of-r-scripts.html#cb66-23" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(df<span class="sc">$</span>column_b)</span>
<span id="cb66-24"><a href="annex-i-compendium-of-r-scripts.html#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df)</span>
<span id="cb66-25"><a href="annex-i-compendium-of-r-scripts.html#cb66-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-26"><a href="annex-i-compendium-of-r-scripts.html#cb66-26" aria-hidden="true" tabindex="-1"></a>df[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,]</span>
<span id="cb66-27"><a href="annex-i-compendium-of-r-scripts.html#cb66-27" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">1</span>]</span>
<span id="cb66-28"><a href="annex-i-compendium-of-r-scripts.html#cb66-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-29"><a href="annex-i-compendium-of-r-scripts.html#cb66-29" aria-hidden="true" tabindex="-1"></a><span class="fu">as.factor</span>(b)</span>
<span id="cb66-30"><a href="annex-i-compendium-of-r-scripts.html#cb66-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-31"><a href="annex-i-compendium-of-r-scripts.html#cb66-31" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">list</span>(a, b, df)</span>
<span id="cb66-32"><a href="annex-i-compendium-of-r-scripts.html#cb66-32" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb66-33"><a href="annex-i-compendium-of-r-scripts.html#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d)</span>
<span id="cb66-34"><a href="annex-i-compendium-of-r-scripts.html#cb66-34" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;numeric_vector&quot;</span>, <span class="st">&quot;character_vector&quot;</span>, <span class="st">&quot;dataframe&quot;</span>)</span>
<span id="cb66-35"><a href="annex-i-compendium-of-r-scripts.html#cb66-35" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb66-36"><a href="annex-i-compendium-of-r-scripts.html#cb66-36" aria-hidden="true" tabindex="-1"></a>d[[<span class="dv">1</span>]]</span>
<span id="cb66-37"><a href="annex-i-compendium-of-r-scripts.html#cb66-37" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>numeric_vector</span>
<span id="cb66-38"><a href="annex-i-compendium-of-r-scripts.html#cb66-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-39"><a href="annex-i-compendium-of-r-scripts.html#cb66-39" aria-hidden="true" tabindex="-1"></a>a <span class="sc">==</span> b</span>
<span id="cb66-40"><a href="annex-i-compendium-of-r-scripts.html#cb66-40" aria-hidden="true" tabindex="-1"></a>a <span class="sc">!=</span> b</span>
<span id="cb66-41"><a href="annex-i-compendium-of-r-scripts.html#cb66-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-42"><a href="annex-i-compendium-of-r-scripts.html#cb66-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Set working directory ======================================</span></span>
<span id="cb66-43"><a href="annex-i-compendium-of-r-scripts.html#cb66-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Set working directory to a specific location</span></span>
<span id="cb66-44"><a href="annex-i-compendium-of-r-scripts.html#cb66-44" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;C:/GIT/Digital-Soil-Mapping/&quot;</span>)</span>
<span id="cb66-45"><a href="annex-i-compendium-of-r-scripts.html#cb66-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Set working directory to source file location</span></span>
<span id="cb66-46"><a href="annex-i-compendium-of-r-scripts.html#cb66-46" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb66-47"><a href="annex-i-compendium-of-r-scripts.html#cb66-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-48"><a href="annex-i-compendium-of-r-scripts.html#cb66-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Install and load packages ==================================</span></span>
<span id="cb66-49"><a href="annex-i-compendium-of-r-scripts.html#cb66-49" aria-hidden="true" tabindex="-1"></a><span class="co"># readxl, tidyverse, and data.table packages using the functions</span></span>
<span id="cb66-50"><a href="annex-i-compendium-of-r-scripts.html#cb66-50" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb66-51"><a href="annex-i-compendium-of-r-scripts.html#cb66-51" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb66-52"><a href="annex-i-compendium-of-r-scripts.html#cb66-52" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;data.table&quot;</span>)</span>
<span id="cb66-53"><a href="annex-i-compendium-of-r-scripts.html#cb66-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb66-54"><a href="annex-i-compendium-of-r-scripts.html#cb66-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb66-55"><a href="annex-i-compendium-of-r-scripts.html#cb66-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb66-56"><a href="annex-i-compendium-of-r-scripts.html#cb66-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Install packages from other repository than CRAN</span></span>
<span id="cb66-57"><a href="annex-i-compendium-of-r-scripts.html#cb66-57" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;remotes&quot;</span>)</span>
<span id="cb66-58"><a href="annex-i-compendium-of-r-scripts.html#cb66-58" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;lemuscanovas/synoptReg&quot;</span>)</span>
<span id="cb66-59"><a href="annex-i-compendium-of-r-scripts.html#cb66-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-60"><a href="annex-i-compendium-of-r-scripts.html#cb66-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-61"><a href="annex-i-compendium-of-r-scripts.html#cb66-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Import an spreadsheet ======================================</span></span>
<span id="cb66-62"><a href="annex-i-compendium-of-r-scripts.html#cb66-62" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.1 Read the MS Excel file -----------------------------------</span></span>
<span id="cb66-63"><a href="annex-i-compendium-of-r-scripts.html#cb66-63" aria-hidden="true" tabindex="-1"></a><span class="co">#Read the soil_data.xlsx file, spreadsheet 2, using read_excel </span></span>
<span id="cb66-64"><a href="annex-i-compendium-of-r-scripts.html#cb66-64" aria-hidden="true" tabindex="-1"></a><span class="fu">read_excel</span>(<span class="at">path =</span> <span class="st">&quot;data/other/soil_data.xlsx&quot;</span>, <span class="at">sheet =</span> <span class="dv">2</span>)</span>
<span id="cb66-65"><a href="annex-i-compendium-of-r-scripts.html#cb66-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-66"><a href="annex-i-compendium-of-r-scripts.html#cb66-66" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.2 Read the csv file with the native function ---------------</span></span>
<span id="cb66-67"><a href="annex-i-compendium-of-r-scripts.html#cb66-67" aria-hidden="true" tabindex="-1"></a><span class="co"># 01-Data/horizon.csv</span></span>
<span id="cb66-68"><a href="annex-i-compendium-of-r-scripts.html#cb66-68" aria-hidden="true" tabindex="-1"></a><span class="fu">read.csv</span>(<span class="st">&quot;data/other/soil_profile_data.csv&quot;</span>)</span>
<span id="cb66-69"><a href="annex-i-compendium-of-r-scripts.html#cb66-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-70"><a href="annex-i-compendium-of-r-scripts.html#cb66-70" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.3 Read the csv file with the tidyverse function ------------</span></span>
<span id="cb66-71"><a href="annex-i-compendium-of-r-scripts.html#cb66-71" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">&quot;data/other/soil_profile_data.csv&quot;</span>)</span>
<span id="cb66-72"><a href="annex-i-compendium-of-r-scripts.html#cb66-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-73"><a href="annex-i-compendium-of-r-scripts.html#cb66-73" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.4 Read the csv file with the data.table function -----------</span></span>
<span id="cb66-74"><a href="annex-i-compendium-of-r-scripts.html#cb66-74" aria-hidden="true" tabindex="-1"></a><span class="fu">fread</span>(<span class="st">&quot;data/other/soil_profile_data.csv&quot;</span>)</span>
<span id="cb66-75"><a href="annex-i-compendium-of-r-scripts.html#cb66-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-76"><a href="annex-i-compendium-of-r-scripts.html#cb66-76" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.5 Assign the dataframe to an object called dat -------------</span></span>
<span id="cb66-77"><a href="annex-i-compendium-of-r-scripts.html#cb66-77" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;data/other/soil_profile_data.csv&quot;</span>)</span>
<span id="cb66-78"><a href="annex-i-compendium-of-r-scripts.html#cb66-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-79"><a href="annex-i-compendium-of-r-scripts.html#cb66-79" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Tidyverse functions ========================================</span></span>
<span id="cb66-80"><a href="annex-i-compendium-of-r-scripts.html#cb66-80" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.1 Select pid, hip, top, bottom, ph_h2o, cec from dat -------</span></span>
<span id="cb66-81"><a href="annex-i-compendium-of-r-scripts.html#cb66-81" aria-hidden="true" tabindex="-1"></a>dat_1 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb66-82"><a href="annex-i-compendium-of-r-scripts.html#cb66-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id_prof, id_hor, top, bottom, ph_h2o, cec)</span>
<span id="cb66-83"><a href="annex-i-compendium-of-r-scripts.html#cb66-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-84"><a href="annex-i-compendium-of-r-scripts.html#cb66-84" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.2 Filter: pick observations by their values ----------------</span></span>
<span id="cb66-85"><a href="annex-i-compendium-of-r-scripts.html#cb66-85" aria-hidden="true" tabindex="-1"></a><span class="co"># filter observations with cec &gt; 50 cmolc/100g</span></span>
<span id="cb66-86"><a href="annex-i-compendium-of-r-scripts.html#cb66-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-87"><a href="annex-i-compendium-of-r-scripts.html#cb66-87" aria-hidden="true" tabindex="-1"></a>dat_2 <span class="ot">&lt;-</span> dat_1 <span class="sc">%&gt;%</span> </span>
<span id="cb66-88"><a href="annex-i-compendium-of-r-scripts.html#cb66-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(cec <span class="sc">&gt;</span> <span class="dv">30</span>)</span>
<span id="cb66-89"><a href="annex-i-compendium-of-r-scripts.html#cb66-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-90"><a href="annex-i-compendium-of-r-scripts.html#cb66-90" aria-hidden="true" tabindex="-1"></a>dat_2</span>
<span id="cb66-91"><a href="annex-i-compendium-of-r-scripts.html#cb66-91" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.3 Mutate: create a new variable ----------------------------</span></span>
<span id="cb66-92"><a href="annex-i-compendium-of-r-scripts.html#cb66-92" aria-hidden="true" tabindex="-1"></a><span class="co"># thickness = top - bottom</span></span>
<span id="cb66-93"><a href="annex-i-compendium-of-r-scripts.html#cb66-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-94"><a href="annex-i-compendium-of-r-scripts.html#cb66-94" aria-hidden="true" tabindex="-1"></a>dat_3 <span class="ot">&lt;-</span> dat_2 <span class="sc">%&gt;%</span> </span>
<span id="cb66-95"><a href="annex-i-compendium-of-r-scripts.html#cb66-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">thickness =</span> bottom <span class="sc">-</span> top)</span>
<span id="cb66-96"><a href="annex-i-compendium-of-r-scripts.html#cb66-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-97"><a href="annex-i-compendium-of-r-scripts.html#cb66-97" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.4 Group_by and summarise -----------------------------------</span></span>
<span id="cb66-98"><a href="annex-i-compendium-of-r-scripts.html#cb66-98" aria-hidden="true" tabindex="-1"></a><span class="co"># group by variable pid</span></span>
<span id="cb66-99"><a href="annex-i-compendium-of-r-scripts.html#cb66-99" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise taking the mean of pH and cec</span></span>
<span id="cb66-100"><a href="annex-i-compendium-of-r-scripts.html#cb66-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-101"><a href="annex-i-compendium-of-r-scripts.html#cb66-101" aria-hidden="true" tabindex="-1"></a>dat_4 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb66-102"><a href="annex-i-compendium-of-r-scripts.html#cb66-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_prof) <span class="sc">%&gt;%</span> </span>
<span id="cb66-103"><a href="annex-i-compendium-of-r-scripts.html#cb66-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_ph =</span> <span class="fu">mean</span>(ph_h2o),</span>
<span id="cb66-104"><a href="annex-i-compendium-of-r-scripts.html#cb66-104" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_cec =</span> <span class="fu">mean</span>(cec))</span>
<span id="cb66-105"><a href="annex-i-compendium-of-r-scripts.html#cb66-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-106"><a href="annex-i-compendium-of-r-scripts.html#cb66-106" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.5 Reshape the table using pivot_longer ---------------------</span></span>
<span id="cb66-107"><a href="annex-i-compendium-of-r-scripts.html#cb66-107" aria-hidden="true" tabindex="-1"></a><span class="co"># use dat_3</span></span>
<span id="cb66-108"><a href="annex-i-compendium-of-r-scripts.html#cb66-108" aria-hidden="true" tabindex="-1"></a><span class="co"># put the names of the variables ph_h2o, </span></span>
<span id="cb66-109"><a href="annex-i-compendium-of-r-scripts.html#cb66-109" aria-hidden="true" tabindex="-1"></a><span class="co"># cec and thickness in the column </span></span>
<span id="cb66-110"><a href="annex-i-compendium-of-r-scripts.html#cb66-110" aria-hidden="true" tabindex="-1"></a><span class="co"># variable and keep the rest of the table. Save in dat_5 </span></span>
<span id="cb66-111"><a href="annex-i-compendium-of-r-scripts.html#cb66-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-112"><a href="annex-i-compendium-of-r-scripts.html#cb66-112" aria-hidden="true" tabindex="-1"></a>dat_5 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb66-113"><a href="annex-i-compendium-of-r-scripts.html#cb66-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(ph_h2o<span class="sc">:</span>thickness, <span class="at">names_to =</span> <span class="st">&quot;soil_property&quot;</span>,</span>
<span id="cb66-114"><a href="annex-i-compendium-of-r-scripts.html#cb66-114" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>)</span>
<span id="cb66-115"><a href="annex-i-compendium-of-r-scripts.html#cb66-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-116"><a href="annex-i-compendium-of-r-scripts.html#cb66-116" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.6 Join the table sites.csv with dat_3 ----------------------</span></span>
<span id="cb66-117"><a href="annex-i-compendium-of-r-scripts.html#cb66-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Load soil_phys_data030.csv (in 01-Data folder) </span></span>
<span id="cb66-118"><a href="annex-i-compendium-of-r-scripts.html#cb66-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Join its columns with dat_3 keeping all the rows of dat_3</span></span>
<span id="cb66-119"><a href="annex-i-compendium-of-r-scripts.html#cb66-119" aria-hidden="true" tabindex="-1"></a><span class="co"># save the result as dat_6</span></span>
<span id="cb66-120"><a href="annex-i-compendium-of-r-scripts.html#cb66-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-121"><a href="annex-i-compendium-of-r-scripts.html#cb66-121" aria-hidden="true" tabindex="-1"></a>phys <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;data/other/soil_phys_data030_2.csv&quot;</span>)</span>
<span id="cb66-122"><a href="annex-i-compendium-of-r-scripts.html#cb66-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-123"><a href="annex-i-compendium-of-r-scripts.html#cb66-123" aria-hidden="true" tabindex="-1"></a>phys <span class="ot">&lt;-</span> phys <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">id_prof =</span> <span class="st">&quot;ProfID&quot;</span>)</span>
<span id="cb66-124"><a href="annex-i-compendium-of-r-scripts.html#cb66-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-125"><a href="annex-i-compendium-of-r-scripts.html#cb66-125" aria-hidden="true" tabindex="-1"></a>dat_6 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb66-126"><a href="annex-i-compendium-of-r-scripts.html#cb66-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(phys)</span>
<span id="cb66-127"><a href="annex-i-compendium-of-r-scripts.html#cb66-127" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb66-128"><a href="annex-i-compendium-of-r-scripts.html#cb66-128" aria-hidden="true" tabindex="-1"></a>dat_6 <span class="ot">&lt;-</span> phys <span class="sc">%&gt;%</span> </span>
<span id="cb66-129"><a href="annex-i-compendium-of-r-scripts.html#cb66-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(dat_3)</span>
<span id="cb66-130"><a href="annex-i-compendium-of-r-scripts.html#cb66-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-131"><a href="annex-i-compendium-of-r-scripts.html#cb66-131" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Data visualization with ggplot2 ============================</span></span>
<span id="cb66-132"><a href="annex-i-compendium-of-r-scripts.html#cb66-132" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.1 1D plot: histograms --------------------------------------</span></span>
<span id="cb66-133"><a href="annex-i-compendium-of-r-scripts.html#cb66-133" aria-hidden="true" tabindex="-1"></a><span class="co"># histograms of cec and ph_h2o</span></span>
<span id="cb66-134"><a href="annex-i-compendium-of-r-scripts.html#cb66-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-135"><a href="annex-i-compendium-of-r-scripts.html#cb66-135" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x=</span>cec)) <span class="sc">+</span> <span class="fu">geom_histogram</span>()</span>
<span id="cb66-136"><a href="annex-i-compendium-of-r-scripts.html#cb66-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-137"><a href="annex-i-compendium-of-r-scripts.html#cb66-137" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.2 2D plot: scatterplot -------------------------------------</span></span>
<span id="cb66-138"><a href="annex-i-compendium-of-r-scripts.html#cb66-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot bottom vs. ph_h2o</span></span>
<span id="cb66-139"><a href="annex-i-compendium-of-r-scripts.html#cb66-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-140"><a href="annex-i-compendium-of-r-scripts.html#cb66-140" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o)) <span class="sc">+</span> </span>
<span id="cb66-141"><a href="annex-i-compendium-of-r-scripts.html#cb66-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() </span>
<span id="cb66-142"><a href="annex-i-compendium-of-r-scripts.html#cb66-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-143"><a href="annex-i-compendium-of-r-scripts.html#cb66-143" aria-hidden="true" tabindex="-1"></a><span class="co"># add a fitting line</span></span>
<span id="cb66-144"><a href="annex-i-compendium-of-r-scripts.html#cb66-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-145"><a href="annex-i-compendium-of-r-scripts.html#cb66-145" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o)) <span class="sc">+</span> </span>
<span id="cb66-146"><a href="annex-i-compendium-of-r-scripts.html#cb66-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb66-147"><a href="annex-i-compendium-of-r-scripts.html#cb66-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span> )</span>
<span id="cb66-148"><a href="annex-i-compendium-of-r-scripts.html#cb66-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-149"><a href="annex-i-compendium-of-r-scripts.html#cb66-149" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.3 3D plot: scatterplot -------------------------------------</span></span>
<span id="cb66-150"><a href="annex-i-compendium-of-r-scripts.html#cb66-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot bottom vs. ph_h2o, add clay as color </span></span>
<span id="cb66-151"><a href="annex-i-compendium-of-r-scripts.html#cb66-151" aria-hidden="true" tabindex="-1"></a><span class="co"># and size inside the </span></span>
<span id="cb66-152"><a href="annex-i-compendium-of-r-scripts.html#cb66-152" aria-hidden="true" tabindex="-1"></a><span class="co"># function aes()</span></span>
<span id="cb66-153"><a href="annex-i-compendium-of-r-scripts.html#cb66-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-154"><a href="annex-i-compendium-of-r-scripts.html#cb66-154" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, </span>
<span id="cb66-155"><a href="annex-i-compendium-of-r-scripts.html#cb66-155" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o, <span class="at">color =</span> cec, <span class="at">size =</span> cec)) <span class="sc">+</span> </span>
<span id="cb66-156"><a href="annex-i-compendium-of-r-scripts.html#cb66-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span>
<span id="cb66-157"><a href="annex-i-compendium-of-r-scripts.html#cb66-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-158"><a href="annex-i-compendium-of-r-scripts.html#cb66-158" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Geospatial data with terra =================================</span></span>
<span id="cb66-159"><a href="annex-i-compendium-of-r-scripts.html#cb66-159" aria-hidden="true" tabindex="-1"></a><span class="do">## Load packages (install them if needed)</span></span>
<span id="cb66-160"><a href="annex-i-compendium-of-r-scripts.html#cb66-160" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb66-161"><a href="annex-i-compendium-of-r-scripts.html#cb66-161" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.1 Load a raster and a vector layer -------------------------</span></span>
<span id="cb66-162"><a href="annex-i-compendium-of-r-scripts.html#cb66-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data/other/landcover2013.tif using rast() function, then plot it</span></span>
<span id="cb66-163"><a href="annex-i-compendium-of-r-scripts.html#cb66-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data/shapes/landcover.shp using vect() function and </span></span>
<span id="cb66-164"><a href="annex-i-compendium-of-r-scripts.html#cb66-164" aria-hidden="true" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb66-165"><a href="annex-i-compendium-of-r-scripts.html#cb66-165" aria-hidden="true" tabindex="-1"></a><span class="co"># explore the attributes of these layers</span></span>
<span id="cb66-166"><a href="annex-i-compendium-of-r-scripts.html#cb66-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-167"><a href="annex-i-compendium-of-r-scripts.html#cb66-167" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;data/other/landcover2013.tif&quot;</span>)</span>
<span id="cb66-168"><a href="annex-i-compendium-of-r-scripts.html#cb66-168" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb66-169"><a href="annex-i-compendium-of-r-scripts.html#cb66-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-170"><a href="annex-i-compendium-of-r-scripts.html#cb66-170" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">vect</span>(<span class="st">&quot;data/shapes/landcover.shp&quot;</span>)</span>
<span id="cb66-171"><a href="annex-i-compendium-of-r-scripts.html#cb66-171" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v)</span>
<span id="cb66-172"><a href="annex-i-compendium-of-r-scripts.html#cb66-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-173"><a href="annex-i-compendium-of-r-scripts.html#cb66-173" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.2 Load a raster and a vector layer -------------------------</span></span>
<span id="cb66-174"><a href="annex-i-compendium-of-r-scripts.html#cb66-174" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the current CRS (EPSG) of the raster and the vector. </span></span>
<span id="cb66-175"><a href="annex-i-compendium-of-r-scripts.html#cb66-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Find a *projected* CRS in http://epsg.io for Vietnam and </span></span>
<span id="cb66-176"><a href="annex-i-compendium-of-r-scripts.html#cb66-176" aria-hidden="true" tabindex="-1"></a><span class="co"># copy the number</span></span>
<span id="cb66-177"><a href="annex-i-compendium-of-r-scripts.html#cb66-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the Arguments of function project (?project) that need to</span></span>
<span id="cb66-178"><a href="annex-i-compendium-of-r-scripts.html#cb66-178" aria-hidden="true" tabindex="-1"></a><span class="co"># be defined</span></span>
<span id="cb66-179"><a href="annex-i-compendium-of-r-scripts.html#cb66-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the new object as r_proj and v_proj</span></span>
<span id="cb66-180"><a href="annex-i-compendium-of-r-scripts.html#cb66-180" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both objects</span></span>
<span id="cb66-181"><a href="annex-i-compendium-of-r-scripts.html#cb66-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-182"><a href="annex-i-compendium-of-r-scripts.html#cb66-182" aria-hidden="true" tabindex="-1"></a>r_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="at">x =</span> r, <span class="at">y =</span> <span class="st">&quot;epsg:3405&quot;</span>, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>,</span>
<span id="cb66-183"><a href="annex-i-compendium-of-r-scripts.html#cb66-183" aria-hidden="true" tabindex="-1"></a>                  <span class="at">res =</span> <span class="dv">250</span>)</span>
<span id="cb66-184"><a href="annex-i-compendium-of-r-scripts.html#cb66-184" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_proj)</span>
<span id="cb66-185"><a href="annex-i-compendium-of-r-scripts.html#cb66-185" aria-hidden="true" tabindex="-1"></a>v_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="at">x =</span> v, <span class="at">y =</span> <span class="st">&quot;epsg:3405&quot;</span>)</span>
<span id="cb66-186"><a href="annex-i-compendium-of-r-scripts.html#cb66-186" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v_proj, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-187"><a href="annex-i-compendium-of-r-scripts.html#cb66-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-188"><a href="annex-i-compendium-of-r-scripts.html#cb66-188" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.3 Cropping and masking a raster ----------------------------</span></span>
<span id="cb66-189"><a href="annex-i-compendium-of-r-scripts.html#cb66-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the area of the polygons in v_proj </span></span>
<span id="cb66-190"><a href="annex-i-compendium-of-r-scripts.html#cb66-190" aria-hidden="true" tabindex="-1"></a><span class="co"># (search for a function) and</span></span>
<span id="cb66-191"><a href="annex-i-compendium-of-r-scripts.html#cb66-191" aria-hidden="true" tabindex="-1"></a><span class="co"># assign the values to a new column named area</span></span>
<span id="cb66-192"><a href="annex-i-compendium-of-r-scripts.html#cb66-192" aria-hidden="true" tabindex="-1"></a><span class="co"># select the largest polygon using [], $, == and max() func. </span></span>
<span id="cb66-193"><a href="annex-i-compendium-of-r-scripts.html#cb66-193" aria-hidden="true" tabindex="-1"></a><span class="co"># and save it as pol</span></span>
<span id="cb66-194"><a href="annex-i-compendium-of-r-scripts.html#cb66-194" aria-hidden="true" tabindex="-1"></a><span class="co"># crop the raster with pol using the crop() function and save </span></span>
<span id="cb66-195"><a href="annex-i-compendium-of-r-scripts.html#cb66-195" aria-hidden="true" tabindex="-1"></a><span class="co">#it as r_pol</span></span>
<span id="cb66-196"><a href="annex-i-compendium-of-r-scripts.html#cb66-196" aria-hidden="true" tabindex="-1"></a><span class="co"># mask the raster r_pol with the polygon pol and save it </span></span>
<span id="cb66-197"><a href="annex-i-compendium-of-r-scripts.html#cb66-197" aria-hidden="true" tabindex="-1"></a><span class="co"># with the same name</span></span>
<span id="cb66-198"><a href="annex-i-compendium-of-r-scripts.html#cb66-198" aria-hidden="true" tabindex="-1"></a><span class="co"># plot each result</span></span>
<span id="cb66-199"><a href="annex-i-compendium-of-r-scripts.html#cb66-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-200"><a href="annex-i-compendium-of-r-scripts.html#cb66-200" aria-hidden="true" tabindex="-1"></a>v_proj<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">expanse</span>(v_proj, <span class="at">unit =</span> <span class="st">&quot;ha&quot;</span>)</span>
<span id="cb66-201"><a href="annex-i-compendium-of-r-scripts.html#cb66-201" aria-hidden="true" tabindex="-1"></a>pol <span class="ot">&lt;-</span> v_proj[v_proj<span class="sc">$</span>area <span class="sc">==</span> <span class="fu">max</span>(v_proj<span class="sc">$</span>area)]</span>
<span id="cb66-202"><a href="annex-i-compendium-of-r-scripts.html#cb66-202" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol)</span>
<span id="cb66-203"><a href="annex-i-compendium-of-r-scripts.html#cb66-203" aria-hidden="true" tabindex="-1"></a>r_pol <span class="ot">&lt;-</span> <span class="fu">crop</span>(r_proj, pol)</span>
<span id="cb66-204"><a href="annex-i-compendium-of-r-scripts.html#cb66-204" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb66-205"><a href="annex-i-compendium-of-r-scripts.html#cb66-205" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-206"><a href="annex-i-compendium-of-r-scripts.html#cb66-206" aria-hidden="true" tabindex="-1"></a>r_pol <span class="ot">&lt;-</span> <span class="fu">mask</span>(r_pol, pol)</span>
<span id="cb66-207"><a href="annex-i-compendium-of-r-scripts.html#cb66-207" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb66-208"><a href="annex-i-compendium-of-r-scripts.html#cb66-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-209"><a href="annex-i-compendium-of-r-scripts.html#cb66-209" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.4 Replace values in a raster by filtering their cells ------</span></span>
<span id="cb66-210"><a href="annex-i-compendium-of-r-scripts.html#cb66-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore the following link to understand how terra </span></span>
<span id="cb66-211"><a href="annex-i-compendium-of-r-scripts.html#cb66-211" aria-hidden="true" tabindex="-1"></a><span class="co">#manage cell values</span></span>
<span id="cb66-212"><a href="annex-i-compendium-of-r-scripts.html#cb66-212" aria-hidden="true" tabindex="-1"></a><span class="co"># https://rspatial.org/terra/pkg/4-algebra.html </span></span>
<span id="cb66-213"><a href="annex-i-compendium-of-r-scripts.html#cb66-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace values lower than 5 in r+pol by 0</span></span>
<span id="cb66-214"><a href="annex-i-compendium-of-r-scripts.html#cb66-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-215"><a href="annex-i-compendium-of-r-scripts.html#cb66-215" aria-hidden="true" tabindex="-1"></a>r_pol[r_pol<span class="sc">$</span>landcover2013 <span class="sc">&lt;</span> <span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb66-216"><a href="annex-i-compendium-of-r-scripts.html#cb66-216" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb66-217"><a href="annex-i-compendium-of-r-scripts.html#cb66-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-218"><a href="annex-i-compendium-of-r-scripts.html#cb66-218" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.5 Rasterize a vector layer ---------------------------------</span></span>
<span id="cb66-219"><a href="annex-i-compendium-of-r-scripts.html#cb66-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Use rasterize() function to convert v_proj to raster</span></span>
<span id="cb66-220"><a href="annex-i-compendium-of-r-scripts.html#cb66-220" aria-hidden="true" tabindex="-1"></a><span class="co"># Use r_proj as reference raster</span></span>
<span id="cb66-221"><a href="annex-i-compendium-of-r-scripts.html#cb66-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Use field landcover to assign cell values, and plot the new map</span></span>
<span id="cb66-222"><a href="annex-i-compendium-of-r-scripts.html#cb66-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-223"><a href="annex-i-compendium-of-r-scripts.html#cb66-223" aria-hidden="true" tabindex="-1"></a>v_class <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="at">x =</span> v_proj, <span class="at">y =</span> r_proj, <span class="at">field =</span> <span class="st">&quot;landcover&quot;</span> )</span>
<span id="cb66-224"><a href="annex-i-compendium-of-r-scripts.html#cb66-224" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v_class)</span>
<span id="cb66-225"><a href="annex-i-compendium-of-r-scripts.html#cb66-225" aria-hidden="true" tabindex="-1"></a>v_class</span>
<span id="cb66-226"><a href="annex-i-compendium-of-r-scripts.html#cb66-226" aria-hidden="true" tabindex="-1"></a><span class="fu">activeCat</span>(v_class) <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb66-227"><a href="annex-i-compendium-of-r-scripts.html#cb66-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-228"><a href="annex-i-compendium-of-r-scripts.html#cb66-228" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.6 Extracting raster values using points --------------------</span></span>
<span id="cb66-229"><a href="annex-i-compendium-of-r-scripts.html#cb66-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Covert dat_6 to spatial points using vect() function </span></span>
<span id="cb66-230"><a href="annex-i-compendium-of-r-scripts.html#cb66-230" aria-hidden="true" tabindex="-1"></a><span class="co"># (check help of vect())</span></span>
<span id="cb66-231"><a href="annex-i-compendium-of-r-scripts.html#cb66-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the EPSG number is 3405</span></span>
<span id="cb66-232"><a href="annex-i-compendium-of-r-scripts.html#cb66-232" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the points as s</span></span>
<span id="cb66-233"><a href="annex-i-compendium-of-r-scripts.html#cb66-233" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot s and r_proj together in the same map (Argument add=TRUE)</span></span>
<span id="cb66-234"><a href="annex-i-compendium-of-r-scripts.html#cb66-234" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the values of the raster using extract() </span></span>
<span id="cb66-235"><a href="annex-i-compendium-of-r-scripts.html#cb66-235" aria-hidden="true" tabindex="-1"></a><span class="co"># function (check the help)</span></span>
<span id="cb66-236"><a href="annex-i-compendium-of-r-scripts.html#cb66-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the ID column of the extracted values</span></span>
<span id="cb66-237"><a href="annex-i-compendium-of-r-scripts.html#cb66-237" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the extracted data with s using cbind() function</span></span>
<span id="cb66-238"><a href="annex-i-compendium-of-r-scripts.html#cb66-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert s as a dataframe</span></span>
<span id="cb66-239"><a href="annex-i-compendium-of-r-scripts.html#cb66-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-240"><a href="annex-i-compendium-of-r-scripts.html#cb66-240" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">vect</span>(dat_6, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="st">&quot;epsg:4326&quot;</span>)</span>
<span id="cb66-241"><a href="annex-i-compendium-of-r-scripts.html#cb66-241" aria-hidden="true" tabindex="-1"></a>  <span class="co">#s &lt;- project(x = s, y = &quot;epsg:3405&quot;)</span></span>
<span id="cb66-242"><a href="annex-i-compendium-of-r-scripts.html#cb66-242" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_proj)</span>
<span id="cb66-243"><a href="annex-i-compendium-of-r-scripts.html#cb66-243" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(s, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-244"><a href="annex-i-compendium-of-r-scripts.html#cb66-244" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">extract</span>(r_proj,s, <span class="at">ID=</span><span class="cn">FALSE</span>)</span>
<span id="cb66-245"><a href="annex-i-compendium-of-r-scripts.html#cb66-245" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">cbind</span>(s,x)</span>
<span id="cb66-246"><a href="annex-i-compendium-of-r-scripts.html#cb66-246" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(s)</span>
<span id="cb66-247"><a href="annex-i-compendium-of-r-scripts.html#cb66-247" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb66-248"><a href="annex-i-compendium-of-r-scripts.html#cb66-248" aria-hidden="true" tabindex="-1"></a><span class="co">#GGally::ggscatmat(d)</span></span>
<span id="cb66-249"><a href="annex-i-compendium-of-r-scripts.html#cb66-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-250"><a href="annex-i-compendium-of-r-scripts.html#cb66-250" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.7 Zonal statistics using polygons and rasters --------------</span></span>
<span id="cb66-251"><a href="annex-i-compendium-of-r-scripts.html#cb66-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the extract() func. to estimate the mean value of </span></span>
<span id="cb66-252"><a href="annex-i-compendium-of-r-scripts.html#cb66-252" aria-hidden="true" tabindex="-1"></a><span class="co"># distance_proj at each polygon</span></span>
<span id="cb66-253"><a href="annex-i-compendium-of-r-scripts.html#cb66-253" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the fun= argument (check the help)</span></span>
<span id="cb66-254"><a href="annex-i-compendium-of-r-scripts.html#cb66-254" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the cbind() func. to merge v_proj and the extracted values</span></span>
<span id="cb66-255"><a href="annex-i-compendium-of-r-scripts.html#cb66-255" aria-hidden="true" tabindex="-1"></a><span class="co"># convert v_proj to a dataframe</span></span>
<span id="cb66-256"><a href="annex-i-compendium-of-r-scripts.html#cb66-256" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a ggplot boxplot (geom_boxplot) with x=landcover</span></span>
<span id="cb66-257"><a href="annex-i-compendium-of-r-scripts.html#cb66-257" aria-hidden="true" tabindex="-1"></a><span class="co"># and y=dist2access </span></span>
<span id="cb66-258"><a href="annex-i-compendium-of-r-scripts.html#cb66-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-259"><a href="annex-i-compendium-of-r-scripts.html#cb66-259" aria-hidden="true" tabindex="-1"></a>distance <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;data/other/nghe_d2roads.tif&quot;</span>)</span>
<span id="cb66-260"><a href="annex-i-compendium-of-r-scripts.html#cb66-260" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(distance)</span>
<span id="cb66-261"><a href="annex-i-compendium-of-r-scripts.html#cb66-261" aria-hidden="true" tabindex="-1"></a>distance_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="at">x =</span> distance, <span class="at">y =</span> <span class="st">&quot;epsg:3405&quot;</span>, <span class="at">method =</span> <span class="st">&quot;bilinear&quot;</span>,</span>
<span id="cb66-262"><a href="annex-i-compendium-of-r-scripts.html#cb66-262" aria-hidden="true" tabindex="-1"></a>                  <span class="at">res =</span> <span class="dv">250</span>)</span>
<span id="cb66-263"><a href="annex-i-compendium-of-r-scripts.html#cb66-263" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(distance_proj)</span>
<span id="cb66-264"><a href="annex-i-compendium-of-r-scripts.html#cb66-264" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">extract</span>(distance_proj, v_proj, <span class="at">fun =</span> mean, <span class="at">ID=</span><span class="cn">FALSE</span>)</span>
<span id="cb66-265"><a href="annex-i-compendium-of-r-scripts.html#cb66-265" aria-hidden="true" tabindex="-1"></a>v_proj <span class="ot">&lt;-</span> <span class="fu">cbind</span>(v_proj, x)</span>
<span id="cb66-266"><a href="annex-i-compendium-of-r-scripts.html#cb66-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-267"><a href="annex-i-compendium-of-r-scripts.html#cb66-267" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(v_proj)</span>
<span id="cb66-268"><a href="annex-i-compendium-of-r-scripts.html#cb66-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-269"><a href="annex-i-compendium-of-r-scripts.html#cb66-269" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> </span>
<span id="cb66-270"><a href="annex-i-compendium-of-r-scripts.html#cb66-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span>landcover, <span class="at">y =</span> dist2access, <span class="at">fill =</span> landcover)) <span class="sc">+</span></span>
<span id="cb66-271"><a href="annex-i-compendium-of-r-scripts.html#cb66-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb66-272"><a href="annex-i-compendium-of-r-scripts.html#cb66-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Distance to roads&quot;</span>)</span>
<span id="cb66-273"><a href="annex-i-compendium-of-r-scripts.html#cb66-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-274"><a href="annex-i-compendium-of-r-scripts.html#cb66-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-275"><a href="annex-i-compendium-of-r-scripts.html#cb66-275" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="re">END</span></span></code></pre></div>
</div>
<div id="script-2-download-environmental-covariates" class="section level2 unnumbered hasAnchor">
<h2>Script 2: Download environmental covariates<a href="annex-i-compendium-of-r-scripts.html#script-2-download-environmental-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb67"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb67-1"><a href="annex-i-compendium-of-r-scripts.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assets <span class="op">=</span> </span>
<span id="cb67-2"><a href="annex-i-compendium-of-r-scripts.html#cb67-2" aria-hidden="true" tabindex="-1"></a>[<span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio1&quot;</span><span class="op">,</span></span>
<span id="cb67-3"><a href="annex-i-compendium-of-r-scripts.html#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio12&quot;</span><span class="op">,</span></span>
<span id="cb67-4"><a href="annex-i-compendium-of-r-scripts.html#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio13&quot;</span><span class="op">,</span></span>
<span id="cb67-5"><a href="annex-i-compendium-of-r-scripts.html#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio14&quot;</span><span class="op">,</span></span>
<span id="cb67-6"><a href="annex-i-compendium-of-r-scripts.html#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio16&quot;</span><span class="op">,</span></span>
<span id="cb67-7"><a href="annex-i-compendium-of-r-scripts.html#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio17&quot;</span><span class="op">,</span></span>
<span id="cb67-8"><a href="annex-i-compendium-of-r-scripts.html#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio5&quot;</span><span class="op">,</span></span>
<span id="cb67-9"><a href="annex-i-compendium-of-r-scripts.html#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio6&quot;</span><span class="op">,</span></span>
<span id="cb67-10"><a href="annex-i-compendium-of-r-scripts.html#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/ngd10&quot;</span><span class="op">,</span></span>
<span id="cb67-11"><a href="annex-i-compendium-of-r-scripts.html#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_max&quot;</span><span class="op">,</span></span>
<span id="cb67-12"><a href="annex-i-compendium-of-r-scripts.html#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-13"><a href="annex-i-compendium-of-r-scripts.html#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_min&quot;</span><span class="op">,</span></span>
<span id="cb67-14"><a href="annex-i-compendium-of-r-scripts.html#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_range&quot;</span><span class="op">,</span></span>
<span id="cb67-15"><a href="annex-i-compendium-of-r-scripts.html#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_max&quot;</span><span class="op">,</span></span>
<span id="cb67-16"><a href="annex-i-compendium-of-r-scripts.html#cb67-16" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-17"><a href="annex-i-compendium-of-r-scripts.html#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_range&quot;</span><span class="op">,</span></span>
<span id="cb67-18"><a href="annex-i-compendium-of-r-scripts.html#cb67-18" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_030405_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-19"><a href="annex-i-compendium-of-r-scripts.html#cb67-19" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_030405_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-20"><a href="annex-i-compendium-of-r-scripts.html#cb67-20" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_060708_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-21"><a href="annex-i-compendium-of-r-scripts.html#cb67-21" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_060708_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-22"><a href="annex-i-compendium-of-r-scripts.html#cb67-22" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_091011_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-23"><a href="annex-i-compendium-of-r-scripts.html#cb67-23" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_091011_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-24"><a href="annex-i-compendium-of-r-scripts.html#cb67-24" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_120102_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-25"><a href="annex-i-compendium-of-r-scripts.html#cb67-25" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_120102_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-26"><a href="annex-i-compendium-of-r-scripts.html#cb67-26" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_030405_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-27"><a href="annex-i-compendium-of-r-scripts.html#cb67-27" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_030405_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-28"><a href="annex-i-compendium-of-r-scripts.html#cb67-28" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_060708_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-29"><a href="annex-i-compendium-of-r-scripts.html#cb67-29" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_060708_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-30"><a href="annex-i-compendium-of-r-scripts.html#cb67-30" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_091011_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-31"><a href="annex-i-compendium-of-r-scripts.html#cb67-31" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_091011_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-32"><a href="annex-i-compendium-of-r-scripts.html#cb67-32" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_120102_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-33"><a href="annex-i-compendium-of-r-scripts.html#cb67-33" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_120102_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-34"><a href="annex-i-compendium-of-r-scripts.html#cb67-34" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_030405_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-35"><a href="annex-i-compendium-of-r-scripts.html#cb67-35" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_030405_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-36"><a href="annex-i-compendium-of-r-scripts.html#cb67-36" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_060708_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-37"><a href="annex-i-compendium-of-r-scripts.html#cb67-37" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_060708_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-38"><a href="annex-i-compendium-of-r-scripts.html#cb67-38" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_091011_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-39"><a href="annex-i-compendium-of-r-scripts.html#cb67-39" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_091011_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-40"><a href="annex-i-compendium-of-r-scripts.html#cb67-40" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_120102_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-41"><a href="annex-i-compendium-of-r-scripts.html#cb67-41" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_120102_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-42"><a href="annex-i-compendium-of-r-scripts.html#cb67-42" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_030405_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-43"><a href="annex-i-compendium-of-r-scripts.html#cb67-43" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_030405_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-44"><a href="annex-i-compendium-of-r-scripts.html#cb67-44" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_060708_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-45"><a href="annex-i-compendium-of-r-scripts.html#cb67-45" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_060708_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-46"><a href="annex-i-compendium-of-r-scripts.html#cb67-46" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_091011_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-47"><a href="annex-i-compendium-of-r-scripts.html#cb67-47" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_091011_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-48"><a href="annex-i-compendium-of-r-scripts.html#cb67-48" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_120102_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-49"><a href="annex-i-compendium-of-r-scripts.html#cb67-49" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_120102_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb67-50"><a href="annex-i-compendium-of-r-scripts.html#cb67-50" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/snow_cover&quot;</span><span class="op">,</span></span>
<span id="cb67-51"><a href="annex-i-compendium-of-r-scripts.html#cb67-51" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/swir_060708_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb67-52"><a href="annex-i-compendium-of-r-scripts.html#cb67-52" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/crops&quot;</span><span class="op">,</span></span>
<span id="cb67-53"><a href="annex-i-compendium-of-r-scripts.html#cb67-53" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/flooded_vegetation&quot;</span><span class="op">,</span></span>
<span id="cb67-54"><a href="annex-i-compendium-of-r-scripts.html#cb67-54" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/grass&quot;</span><span class="op">,</span></span>
<span id="cb67-55"><a href="annex-i-compendium-of-r-scripts.html#cb67-55" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/shrub_and_scrub&quot;</span><span class="op">,</span></span>
<span id="cb67-56"><a href="annex-i-compendium-of-r-scripts.html#cb67-56" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/trees&quot;</span><span class="op">,</span></span>
<span id="cb67-57"><a href="annex-i-compendium-of-r-scripts.html#cb67-57" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_curvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-58"><a href="annex-i-compendium-of-r-scripts.html#cb67-58" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_downslopecurvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-59"><a href="annex-i-compendium-of-r-scripts.html#cb67-59" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_dvm2_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-60"><a href="annex-i-compendium-of-r-scripts.html#cb67-60" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_dvm_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-61"><a href="annex-i-compendium-of-r-scripts.html#cb67-61" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_elevation_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-62"><a href="annex-i-compendium-of-r-scripts.html#cb67-62" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_mrn_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-63"><a href="annex-i-compendium-of-r-scripts.html#cb67-63" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_neg_openness_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-64"><a href="annex-i-compendium-of-r-scripts.html#cb67-64" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_pos_openness_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-65"><a href="annex-i-compendium-of-r-scripts.html#cb67-65" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_slope_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-66"><a href="annex-i-compendium-of-r-scripts.html#cb67-66" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_tpi_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-67"><a href="annex-i-compendium-of-r-scripts.html#cb67-67" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_twi_500m&quot;</span><span class="op">,</span></span>
<span id="cb67-68"><a href="annex-i-compendium-of-r-scripts.html#cb67-68" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_upslopecurvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb67-69"><a href="annex-i-compendium-of-r-scripts.html#cb67-69" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_vbf_250m&quot;</span>]<span class="op">;</span></span>
<span id="cb67-70"><a href="annex-i-compendium-of-r-scripts.html#cb67-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-71"><a href="annex-i-compendium-of-r-scripts.html#cb67-71" aria-hidden="true" tabindex="-1"></a><span class="co">// Load borders </span></span>
<span id="cb67-72"><a href="annex-i-compendium-of-r-scripts.html#cb67-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-73"><a href="annex-i-compendium-of-r-scripts.html#cb67-73" aria-hidden="true" tabindex="-1"></a><span class="co">/// Using UN 2020 (replace the countries to download)</span></span>
<span id="cb67-74"><a href="annex-i-compendium-of-r-scripts.html#cb67-74" aria-hidden="true" tabindex="-1"></a><span class="co">/// var ISO = [&#39;ITA&#39;];</span></span>
<span id="cb67-75"><a href="annex-i-compendium-of-r-scripts.html#cb67-75" aria-hidden="true" tabindex="-1"></a><span class="co">/// var aoi =</span></span>
<span id="cb67-76"><a href="annex-i-compendium-of-r-scripts.html#cb67-76" aria-hidden="true" tabindex="-1"></a><span class="co">/// ee.FeatureCollection(</span></span>
<span id="cb67-77"><a href="annex-i-compendium-of-r-scripts.html#cb67-77" aria-hidden="true" tabindex="-1"></a><span class="co">/// &#39;projects/digital-soil-mapping-gsp-fao/assets/UN_BORDERS/BNDA_CTY&#39;</span></span>
<span id="cb67-78"><a href="annex-i-compendium-of-r-scripts.html#cb67-78" aria-hidden="true" tabindex="-1"></a><span class="co">/// )</span></span>
<span id="cb67-79"><a href="annex-i-compendium-of-r-scripts.html#cb67-79" aria-hidden="true" tabindex="-1"></a><span class="co">///   .filter(ee.Filter.inList(&#39;ISO3CD&#39;, ISO));</span></span>
<span id="cb67-80"><a href="annex-i-compendium-of-r-scripts.html#cb67-80" aria-hidden="true" tabindex="-1"></a><span class="co">/// var region = aoi.geometry();</span></span>
<span id="cb67-81"><a href="annex-i-compendium-of-r-scripts.html#cb67-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-82"><a href="annex-i-compendium-of-r-scripts.html#cb67-82" aria-hidden="true" tabindex="-1"></a><span class="co">/// Using a shapefile</span></span>
<span id="cb67-83"><a href="annex-i-compendium-of-r-scripts.html#cb67-83" aria-hidden="true" tabindex="-1"></a><span class="co">/// 1. Upload the borders of your countries as an asset</span></span>
<span id="cb67-84"><a href="annex-i-compendium-of-r-scripts.html#cb67-84" aria-hidden="true" tabindex="-1"></a><span class="co">/// 2. Replace &#39;your_shapefile&#39; with the path to your shapefile</span></span>
<span id="cb67-85"><a href="annex-i-compendium-of-r-scripts.html#cb67-85" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> shapefile <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;projects/digital-soil-mapping-gsp-fao/assets/Nghe_An&#39;</span>)<span class="op">;</span></span>
<span id="cb67-86"><a href="annex-i-compendium-of-r-scripts.html#cb67-86" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> region <span class="op">=</span> shapefile<span class="op">.</span><span class="fu">geometry</span>()<span class="op">.</span><span class="fu">bounds</span>()<span class="op">;</span></span>
<span id="cb67-87"><a href="annex-i-compendium-of-r-scripts.html#cb67-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-88"><a href="annex-i-compendium-of-r-scripts.html#cb67-88" aria-hidden="true" tabindex="-1"></a><span class="co">// Load assets as ImageCollection</span></span>
<span id="cb67-89"><a href="annex-i-compendium-of-r-scripts.html#cb67-89" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assetsCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(assets)<span class="op">;</span></span>
<span id="cb67-90"><a href="annex-i-compendium-of-r-scripts.html#cb67-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-91"><a href="annex-i-compendium-of-r-scripts.html#cb67-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Clip each image in the collection to the region of interest</span></span>
<span id="cb67-92"><a href="annex-i-compendium-of-r-scripts.html#cb67-92" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clippedCollection <span class="op">=</span> assetsCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(img){</span>
<span id="cb67-93"><a href="annex-i-compendium-of-r-scripts.html#cb67-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> img<span class="op">.</span><span class="fu">clip</span>(region)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb67-94"><a href="annex-i-compendium-of-r-scripts.html#cb67-94" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb67-95"><a href="annex-i-compendium-of-r-scripts.html#cb67-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-96"><a href="annex-i-compendium-of-r-scripts.html#cb67-96" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to replace masked values with zeroes for fpar bands</span></span>
<span id="cb67-97"><a href="annex-i-compendium-of-r-scripts.html#cb67-97" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">replaceMaskedFpar</span>(img) {</span>
<span id="cb67-98"><a href="annex-i-compendium-of-r-scripts.html#cb67-98" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> allBands <span class="op">=</span> img<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb67-99"><a href="annex-i-compendium-of-r-scripts.html#cb67-99" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fparBands <span class="op">=</span></span>
<span id="cb67-100"><a href="annex-i-compendium-of-r-scripts.html#cb67-100" aria-hidden="true" tabindex="-1"></a>  allBands<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">stringStartsWith</span>(<span class="st">&#39;item&#39;</span><span class="op">,</span> <span class="st">&#39;fpar&#39;</span>))<span class="op">;</span></span>
<span id="cb67-101"><a href="annex-i-compendium-of-r-scripts.html#cb67-101" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> nonFparBands <span class="op">=</span> allBands<span class="op">.</span><span class="fu">removeAll</span>(fparBands)<span class="op">;</span></span>
<span id="cb67-102"><a href="annex-i-compendium-of-r-scripts.html#cb67-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-103"><a href="annex-i-compendium-of-r-scripts.html#cb67-103" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fparImg <span class="op">=</span> img<span class="op">.</span><span class="fu">select</span>(fparBands)<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb67-104"><a href="annex-i-compendium-of-r-scripts.html#cb67-104" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> nonFparImg <span class="op">=</span> img<span class="op">.</span><span class="fu">select</span>(nonFparBands)<span class="op">;</span></span>
<span id="cb67-105"><a href="annex-i-compendium-of-r-scripts.html#cb67-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-106"><a href="annex-i-compendium-of-r-scripts.html#cb67-106" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If there are no fpar bands, return the original image</span></span>
<span id="cb67-107"><a href="annex-i-compendium-of-r-scripts.html#cb67-107" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(fparBands<span class="op">.</span><span class="fu">length</span>()<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb67-108"><a href="annex-i-compendium-of-r-scripts.html#cb67-108" aria-hidden="true" tabindex="-1"></a>                                 img<span class="op">,</span></span>
<span id="cb67-109"><a href="annex-i-compendium-of-r-scripts.html#cb67-109" aria-hidden="true" tabindex="-1"></a>                                 nonFparImg<span class="op">.</span><span class="fu">addBands</span>(fparImg))<span class="op">;</span></span>
<span id="cb67-110"><a href="annex-i-compendium-of-r-scripts.html#cb67-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-111"><a href="annex-i-compendium-of-r-scripts.html#cb67-111" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(result)<span class="op">;</span></span>
<span id="cb67-112"><a href="annex-i-compendium-of-r-scripts.html#cb67-112" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-113"><a href="annex-i-compendium-of-r-scripts.html#cb67-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-114"><a href="annex-i-compendium-of-r-scripts.html#cb67-114" aria-hidden="true" tabindex="-1"></a><span class="co">// Clip each image in the collection to the region of </span></span>
<span id="cb67-115"><a href="annex-i-compendium-of-r-scripts.html#cb67-115" aria-hidden="true" tabindex="-1"></a><span class="co">//interest and replace masked values for fpar bands</span></span>
<span id="cb67-116"><a href="annex-i-compendium-of-r-scripts.html#cb67-116" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clippedCollection <span class="op">=</span> assetsCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(img){</span>
<span id="cb67-117"><a href="annex-i-compendium-of-r-scripts.html#cb67-117" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> clippedImg <span class="op">=</span> img<span class="op">.</span><span class="fu">clip</span>(region)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb67-118"><a href="annex-i-compendium-of-r-scripts.html#cb67-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">replaceMaskedFpar</span>(clippedImg)<span class="op">;</span></span>
<span id="cb67-119"><a href="annex-i-compendium-of-r-scripts.html#cb67-119" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb67-120"><a href="annex-i-compendium-of-r-scripts.html#cb67-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-121"><a href="annex-i-compendium-of-r-scripts.html#cb67-121" aria-hidden="true" tabindex="-1"></a><span class="co">// Stack the layers and maintain the </span></span>
<span id="cb67-122"><a href="annex-i-compendium-of-r-scripts.html#cb67-122" aria-hidden="true" tabindex="-1"></a><span class="co">//layer names in the final file</span></span>
<span id="cb67-123"><a href="annex-i-compendium-of-r-scripts.html#cb67-123" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stacked <span class="op">=</span> clippedCollection<span class="op">.</span><span class="fu">toBands</span>()<span class="op">;</span></span>
<span id="cb67-124"><a href="annex-i-compendium-of-r-scripts.html#cb67-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-125"><a href="annex-i-compendium-of-r-scripts.html#cb67-125" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the list of asset names</span></span>
<span id="cb67-126"><a href="annex-i-compendium-of-r-scripts.html#cb67-126" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assetNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(assets)<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(asset) {</span>
<span id="cb67-127"><a href="annex-i-compendium-of-r-scripts.html#cb67-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">String</span>(asset)<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">get</span>(<span class="op">-</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb67-128"><a href="annex-i-compendium-of-r-scripts.html#cb67-128" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb67-129"><a href="annex-i-compendium-of-r-scripts.html#cb67-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-130"><a href="annex-i-compendium-of-r-scripts.html#cb67-130" aria-hidden="true" tabindex="-1"></a><span class="co">// Rename the bands with asset names</span></span>
<span id="cb67-131"><a href="annex-i-compendium-of-r-scripts.html#cb67-131" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> renamed <span class="op">=</span> stacked<span class="op">.</span><span class="fu">rename</span>(assetNames)<span class="op">;</span></span>
<span id="cb67-132"><a href="annex-i-compendium-of-r-scripts.html#cb67-132" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(renamed<span class="op">,</span> <span class="st">&#39;Covariates to be exported&#39;</span>)</span>
<span id="cb67-133"><a href="annex-i-compendium-of-r-scripts.html#cb67-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-134"><a href="annex-i-compendium-of-r-scripts.html#cb67-134" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize the result</span></span>
<span id="cb67-135"><a href="annex-i-compendium-of-r-scripts.html#cb67-135" aria-hidden="true" tabindex="-1"></a><span class="co">// Set a visualization parameter </span></span>
<span id="cb67-136"><a href="annex-i-compendium-of-r-scripts.html#cb67-136" aria-hidden="true" tabindex="-1"></a><span class="co">// (you can adjust the colors as desired)</span></span>
<span id="cb67-137"><a href="annex-i-compendium-of-r-scripts.html#cb67-137" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb67-138"><a href="annex-i-compendium-of-r-scripts.html#cb67-138" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> <span class="st">&#39;bio1&#39;</span><span class="op">,</span></span>
<span id="cb67-139"><a href="annex-i-compendium-of-r-scripts.html#cb67-139" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb67-140"><a href="annex-i-compendium-of-r-scripts.html#cb67-140" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb67-141"><a href="annex-i-compendium-of-r-scripts.html#cb67-141" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;yellow&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>]</span>
<span id="cb67-142"><a href="annex-i-compendium-of-r-scripts.html#cb67-142" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb67-143"><a href="annex-i-compendium-of-r-scripts.html#cb67-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-144"><a href="annex-i-compendium-of-r-scripts.html#cb67-144" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the layer to the map</span></span>
<span id="cb67-145"><a href="annex-i-compendium-of-r-scripts.html#cb67-145" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(renamed<span class="op">,</span> <span class="dv">6</span>)</span>
<span id="cb67-146"><a href="annex-i-compendium-of-r-scripts.html#cb67-146" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(renamed<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Covariates&#39;</span>)<span class="op">;</span></span>
<span id="cb67-147"><a href="annex-i-compendium-of-r-scripts.html#cb67-147" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the stacked image to Google Drive</span></span>
<span id="cb67-148"><a href="annex-i-compendium-of-r-scripts.html#cb67-148" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb67-149"><a href="annex-i-compendium-of-r-scripts.html#cb67-149" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> renamed<span class="op">,</span></span>
<span id="cb67-150"><a href="annex-i-compendium-of-r-scripts.html#cb67-150" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;covariates&#39;</span><span class="op">,</span></span>
<span id="cb67-151"><a href="annex-i-compendium-of-r-scripts.html#cb67-151" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;GEE&#39;</span><span class="op">,</span></span>
<span id="cb67-152"><a href="annex-i-compendium-of-r-scripts.html#cb67-152" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb67-153"><a href="annex-i-compendium-of-r-scripts.html#cb67-153" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span><span class="op">,</span></span>
<span id="cb67-154"><a href="annex-i-compendium-of-r-scripts.html#cb67-154" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> region</span>
<span id="cb67-155"><a href="annex-i-compendium-of-r-scripts.html#cb67-155" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb67-156"><a href="annex-i-compendium-of-r-scripts.html#cb67-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-157"><a href="annex-i-compendium-of-r-scripts.html#cb67-157" aria-hidden="true" tabindex="-1"></a><span class="co">/* Create mask for croplands ----------------------------*/</span></span>
<span id="cb67-158"><a href="annex-i-compendium-of-r-scripts.html#cb67-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-159"><a href="annex-i-compendium-of-r-scripts.html#cb67-159" aria-hidden="true" tabindex="-1"></a><span class="co">// Load the Copernicus Global Land Service image collection</span></span>
<span id="cb67-160"><a href="annex-i-compendium-of-r-scripts.html#cb67-160" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> imageCollection <span class="op">=</span> </span>
<span id="cb67-161"><a href="annex-i-compendium-of-r-scripts.html#cb67-161" aria-hidden="true" tabindex="-1"></a>ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;COPERNICUS/Landcover/100m/Proba-V-C3/Global/2019&quot;</span>)</span>
<span id="cb67-162"><a href="annex-i-compendium-of-r-scripts.html#cb67-162" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;discrete_classification&quot;</span>)</span>
<span id="cb67-163"><a href="annex-i-compendium-of-r-scripts.html#cb67-163" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>(region)</span>
<span id="cb67-164"><a href="annex-i-compendium-of-r-scripts.html#cb67-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-165"><a href="annex-i-compendium-of-r-scripts.html#cb67-165" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> crs <span class="op">=</span> <span class="st">&#39;EPSG:4326&#39;</span><span class="op">;</span> <span class="co">// WGS84</span></span>
<span id="cb67-166"><a href="annex-i-compendium-of-r-scripts.html#cb67-166" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> res <span class="op">=</span> <span class="dv">250</span><span class="op">;</span> <span class="co">// Resolution in decimal degrees</span></span>
<span id="cb67-167"><a href="annex-i-compendium-of-r-scripts.html#cb67-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-168"><a href="annex-i-compendium-of-r-scripts.html#cb67-168" aria-hidden="true" tabindex="-1"></a><span class="co">// Default resampling is nearest neighbor</span></span>
<span id="cb67-169"><a href="annex-i-compendium-of-r-scripts.html#cb67-169" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image1 <span class="op">=</span> imageCollection<span class="op">.</span><span class="fu">resample</span>()</span>
<span id="cb67-170"><a href="annex-i-compendium-of-r-scripts.html#cb67-170" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">reproject</span>({</span>
<span id="cb67-171"><a href="annex-i-compendium-of-r-scripts.html#cb67-171" aria-hidden="true" tabindex="-1"></a>    <span class="dt">crs</span><span class="op">:</span> crs<span class="op">,</span> <span class="co">// Add your desired CRS here</span></span>
<span id="cb67-172"><a href="annex-i-compendium-of-r-scripts.html#cb67-172" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> res <span class="co">// Add your desired scale here</span></span>
<span id="cb67-173"><a href="annex-i-compendium-of-r-scripts.html#cb67-173" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb67-174"><a href="annex-i-compendium-of-r-scripts.html#cb67-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-175"><a href="annex-i-compendium-of-r-scripts.html#cb67-175" aria-hidden="true" tabindex="-1"></a><span class="co">// Reclassify the land cover classes</span></span>
<span id="cb67-176"><a href="annex-i-compendium-of-r-scripts.html#cb67-176" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> inList <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">80</span><span class="op">,</span> <span class="dv">90</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> </span>
<span id="cb67-177"><a href="annex-i-compendium-of-r-scripts.html#cb67-177" aria-hidden="true" tabindex="-1"></a>               <span class="dv">111</span><span class="op">,</span> <span class="dv">112</span><span class="op">,</span> <span class="dv">113</span><span class="op">,</span> <span class="dv">114</span><span class="op">,</span> <span class="dv">115</span><span class="op">,</span> <span class="dv">116</span><span class="op">,</span> </span>
<span id="cb67-178"><a href="annex-i-compendium-of-r-scripts.html#cb67-178" aria-hidden="true" tabindex="-1"></a>              <span class="dv">121</span><span class="op">,</span> <span class="dv">122</span><span class="op">,</span> <span class="dv">123</span><span class="op">,</span> <span class="dv">124</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">126</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">;</span></span>
<span id="cb67-179"><a href="annex-i-compendium-of-r-scripts.html#cb67-179" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> outList <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb67-180"><a href="annex-i-compendium-of-r-scripts.html#cb67-180" aria-hidden="true" tabindex="-1"></a>               <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb67-181"><a href="annex-i-compendium-of-r-scripts.html#cb67-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-182"><a href="annex-i-compendium-of-r-scripts.html#cb67-182" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> FAO_lu <span class="op">=</span> image1<span class="op">.</span><span class="fu">remap</span>(inList<span class="op">,</span> outList)</span>
<span id="cb67-183"><a href="annex-i-compendium-of-r-scripts.html#cb67-183" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">toDouble</span>()</span>
<span id="cb67-184"><a href="annex-i-compendium-of-r-scripts.html#cb67-184" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>(region)<span class="op">;</span></span>
<span id="cb67-185"><a href="annex-i-compendium-of-r-scripts.html#cb67-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-186"><a href="annex-i-compendium-of-r-scripts.html#cb67-186" aria-hidden="true" tabindex="-1"></a><span class="co">// print(FAO_lu)</span></span>
<span id="cb67-187"><a href="annex-i-compendium-of-r-scripts.html#cb67-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-188"><a href="annex-i-compendium-of-r-scripts.html#cb67-188" aria-hidden="true" tabindex="-1"></a><span class="co">// Convert 0 to NA</span></span>
<span id="cb67-189"><a href="annex-i-compendium-of-r-scripts.html#cb67-189" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mask <span class="op">=</span> FAO_lu<span class="op">.</span><span class="fu">neq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb67-190"><a href="annex-i-compendium-of-r-scripts.html#cb67-190" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mask)</span>
<span id="cb67-191"><a href="annex-i-compendium-of-r-scripts.html#cb67-191" aria-hidden="true" tabindex="-1"></a>FAO_lu <span class="op">=</span> FAO_lu<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb67-192"><a href="annex-i-compendium-of-r-scripts.html#cb67-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-193"><a href="annex-i-compendium-of-r-scripts.html#cb67-193" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(FAO_lu<span class="op">,</span> <span class="st">&quot;Mask&quot;</span>)</span>
<span id="cb67-194"><a href="annex-i-compendium-of-r-scripts.html#cb67-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-195"><a href="annex-i-compendium-of-r-scripts.html#cb67-195" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb67-196"><a href="annex-i-compendium-of-r-scripts.html#cb67-196" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> <span class="st">&#39;remapped&#39;</span><span class="op">,</span></span>
<span id="cb67-197"><a href="annex-i-compendium-of-r-scripts.html#cb67-197" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb67-198"><a href="annex-i-compendium-of-r-scripts.html#cb67-198" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb67-199"><a href="annex-i-compendium-of-r-scripts.html#cb67-199" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;yellow&#39;</span>]</span>
<span id="cb67-200"><a href="annex-i-compendium-of-r-scripts.html#cb67-200" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb67-201"><a href="annex-i-compendium-of-r-scripts.html#cb67-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-202"><a href="annex-i-compendium-of-r-scripts.html#cb67-202" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the layer to the map</span></span>
<span id="cb67-203"><a href="annex-i-compendium-of-r-scripts.html#cb67-203" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(FAO_lu<span class="op">,</span>visParams <span class="op">,</span><span class="st">&#39;Mask&#39;</span>)<span class="op">;</span></span>
<span id="cb67-204"><a href="annex-i-compendium-of-r-scripts.html#cb67-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-205"><a href="annex-i-compendium-of-r-scripts.html#cb67-205" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the land cover image as a raster to Google Drive</span></span>
<span id="cb67-206"><a href="annex-i-compendium-of-r-scripts.html#cb67-206" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb67-207"><a href="annex-i-compendium-of-r-scripts.html#cb67-207" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> FAO_lu<span class="op">,</span></span>
<span id="cb67-208"><a href="annex-i-compendium-of-r-scripts.html#cb67-208" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;GEE&#39;</span><span class="op">,</span></span>
<span id="cb67-209"><a href="annex-i-compendium-of-r-scripts.html#cb67-209" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;mask&#39;</span><span class="op">,</span></span>
<span id="cb67-210"><a href="annex-i-compendium-of-r-scripts.html#cb67-210" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> res<span class="op">,</span> <span class="co">// Add your desired scale here</span></span>
<span id="cb67-211"><a href="annex-i-compendium-of-r-scripts.html#cb67-211" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb67-212"><a href="annex-i-compendium-of-r-scripts.html#cb67-212" aria-hidden="true" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> crs<span class="op">,</span> <span class="co">// Add your desired CRS here</span></span>
<span id="cb67-213"><a href="annex-i-compendium-of-r-scripts.html#cb67-213" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span> <span class="co">// Add a maximum number of pixels </span></span>
<span id="cb67-214"><a href="annex-i-compendium-of-r-scripts.html#cb67-214" aria-hidden="true" tabindex="-1"></a>  <span class="co">//for export if needed</span></span>
<span id="cb67-215"><a href="annex-i-compendium-of-r-scripts.html#cb67-215" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="script-3-evaluate-legacy-data" class="section level2 unnumbered hasAnchor">
<h2>Script 3: Evaluate Legacy Data<a href="annex-i-compendium-of-r-scripts.html#script-3-evaluate-legacy-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="annex-i-compendium-of-r-scripts.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb68-2"><a href="annex-i-compendium-of-r-scripts.html#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb68-3"><a href="annex-i-compendium-of-r-scripts.html#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb68-4"><a href="annex-i-compendium-of-r-scripts.html#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluation of Legacy Data</span></span>
<span id="cb68-5"><a href="annex-i-compendium-of-r-scripts.html#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb68-6"><a href="annex-i-compendium-of-r-scripts.html#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb68-7"><a href="annex-i-compendium-of-r-scripts.html#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb68-8"><a href="annex-i-compendium-of-r-scripts.html#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="annex-i-compendium-of-r-scripts.html#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb68-10"><a href="annex-i-compendium-of-r-scripts.html#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="annex-i-compendium-of-r-scripts.html#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Empty environment and cache </span></span>
<span id="cb68-12"><a href="annex-i-compendium-of-r-scripts.html#cb68-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb68-13"><a href="annex-i-compendium-of-r-scripts.html#cb68-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb68-14"><a href="annex-i-compendium-of-r-scripts.html#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="annex-i-compendium-of-r-scripts.html#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script ========================================</span></span>
<span id="cb68-16"><a href="annex-i-compendium-of-r-scripts.html#cb68-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-17"><a href="annex-i-compendium-of-r-scripts.html#cb68-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Script for evaluation the degree of representativeness of a soil legacy dataset</span></span>
<span id="cb68-18"><a href="annex-i-compendium-of-r-scripts.html#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="co"># relative to the diversity of the environmental conditions described in a set </span></span>
<span id="cb68-19"><a href="annex-i-compendium-of-r-scripts.html#cb68-19" aria-hidden="true" tabindex="-1"></a><span class="co"># of rasterb covariates.</span></span>
<span id="cb68-20"><a href="annex-i-compendium-of-r-scripts.html#cb68-20" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb68-21"><a href="annex-i-compendium-of-r-scripts.html#cb68-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load packages</span></span>
<span id="cb68-22"><a href="annex-i-compendium-of-r-scripts.html#cb68-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb68-23"><a href="annex-i-compendium-of-r-scripts.html#cb68-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Extract environmental data from rasters at soil locations</span></span>
<span id="cb68-24"><a href="annex-i-compendium-of-r-scripts.html#cb68-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Extract environmental data from rasters at soil locations</span></span>
<span id="cb68-25"><a href="annex-i-compendium-of-r-scripts.html#cb68-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Compute variability matrix in covariates</span></span>
<span id="cb68-26"><a href="annex-i-compendium-of-r-scripts.html#cb68-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Calculate hypercube of &quot;covariates&quot; distribution (P)</span></span>
<span id="cb68-27"><a href="annex-i-compendium-of-r-scripts.html#cb68-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Calculate hypercube of &quot;sample&quot; distribution (Q)</span></span>
<span id="cb68-28"><a href="annex-i-compendium-of-r-scripts.html#cb68-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Calculate Representativeness of the Legacy Dataset</span></span>
<span id="cb68-29"><a href="annex-i-compendium-of-r-scripts.html#cb68-29" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb68-30"><a href="annex-i-compendium-of-r-scripts.html#cb68-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-31"><a href="annex-i-compendium-of-r-scripts.html#cb68-31" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb68-32"><a href="annex-i-compendium-of-r-scripts.html#cb68-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-33"><a href="annex-i-compendium-of-r-scripts.html#cb68-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load packages =================================</span></span>
<span id="cb68-34"><a href="annex-i-compendium-of-r-scripts.html#cb68-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-35"><a href="annex-i-compendium-of-r-scripts.html#cb68-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#remotes::install_github(&quot;lemuscanovas/synoptReg&quot;)</span></span>
<span id="cb68-36"><a href="annex-i-compendium-of-r-scripts.html#cb68-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-37"><a href="annex-i-compendium-of-r-scripts.html#cb68-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb68-38"><a href="annex-i-compendium-of-r-scripts.html#cb68-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb68-39"><a href="annex-i-compendium-of-r-scripts.html#cb68-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb68-40"><a href="annex-i-compendium-of-r-scripts.html#cb68-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-41"><a href="annex-i-compendium-of-r-scripts.html#cb68-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of packages</span></span>
<span id="cb68-42"><a href="annex-i-compendium-of-r-scripts.html#cb68-42" aria-hidden="true" tabindex="-1"></a>  packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;terra&quot;</span>,<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sf&quot;</span>,<span class="st">&quot;clhs&quot;</span>, <span class="st">&quot;sgsR&quot;</span>,<span class="st">&quot;entropy&quot;</span>, <span class="st">&quot;tripack&quot;</span>,</span>
<span id="cb68-43"><a href="annex-i-compendium-of-r-scripts.html#cb68-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;manipulate&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;synoptReg&quot;</span>)</span>
<span id="cb68-44"><a href="annex-i-compendium-of-r-scripts.html#cb68-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages</span></span>
<span id="cb68-45"><a href="annex-i-compendium-of-r-scripts.html#cb68-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-46"><a href="annex-i-compendium-of-r-scripts.html#cb68-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove object to save memory space</span></span>
<span id="cb68-47"><a href="annex-i-compendium-of-r-scripts.html#cb68-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(packages) </span>
<span id="cb68-48"><a href="annex-i-compendium-of-r-scripts.html#cb68-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-49"><a href="annex-i-compendium-of-r-scripts.html#cb68-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-50"><a href="annex-i-compendium-of-r-scripts.html#cb68-50" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb68-51"><a href="annex-i-compendium-of-r-scripts.html#cb68-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to rasters</span></span>
<span id="cb68-52"><a href="annex-i-compendium-of-r-scripts.html#cb68-52" aria-hidden="true" tabindex="-1"></a>  raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters&quot;</span></span>
<span id="cb68-53"><a href="annex-i-compendium-of-r-scripts.html#cb68-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to shapes</span></span>
<span id="cb68-54"><a href="annex-i-compendium-of-r-scripts.html#cb68-54" aria-hidden="true" tabindex="-1"></a>  shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes&quot;</span></span>
<span id="cb68-55"><a href="annex-i-compendium-of-r-scripts.html#cb68-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to results</span></span>
<span id="cb68-56"><a href="annex-i-compendium-of-r-scripts.html#cb68-56" aria-hidden="true" tabindex="-1"></a>  results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb68-57"><a href="annex-i-compendium-of-r-scripts.html#cb68-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to additional data</span></span>
<span id="cb68-58"><a href="annex-i-compendium-of-r-scripts.html#cb68-58" aria-hidden="true" tabindex="-1"></a>  other.path <span class="ot">&lt;-</span> <span class="st">&quot;data/other/&quot;</span></span>
<span id="cb68-59"><a href="annex-i-compendium-of-r-scripts.html#cb68-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregation factor for up-scaling raster covariates (optional)</span></span>
<span id="cb68-60"><a href="annex-i-compendium-of-r-scripts.html#cb68-60" aria-hidden="true" tabindex="-1"></a>  agg.factor <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb68-61"><a href="annex-i-compendium-of-r-scripts.html#cb68-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-62"><a href="annex-i-compendium-of-r-scripts.html#cb68-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-63"><a href="annex-i-compendium-of-r-scripts.html#cb68-63" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Prepare data ============================================================</span></span>
<span id="cb68-64"><a href="annex-i-compendium-of-r-scripts.html#cb68-64" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Load raster covariate data</span></span>
<span id="cb68-65"><a href="annex-i-compendium-of-r-scripts.html#cb68-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb68-66"><a href="annex-i-compendium-of-r-scripts.html#cb68-66" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(raster.path, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-67"><a href="annex-i-compendium-of-r-scripts.html#cb68-67" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat) <span class="co"># SpatRaster from terra</span></span>
<span id="cb68-68"><a href="annex-i-compendium-of-r-scripts.html#cb68-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate stack to simplify data rasters for calculations </span></span>
<span id="cb68-69"><a href="annex-i-compendium-of-r-scripts.html#cb68-69" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(cov.dat, <span class="at">fact=</span>agg.factor, <span class="at">fun=</span><span class="st">&quot;mean&quot;</span>)</span>
<span id="cb68-70"><a href="annex-i-compendium-of-r-scripts.html#cb68-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-71"><a href="annex-i-compendium-of-r-scripts.html#cb68-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load shape of district</span></span>
<span id="cb68-72"><a href="annex-i-compendium-of-r-scripts.html#cb68-72" aria-hidden="true" tabindex="-1"></a>  nghe <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/Nghe_An.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb68-73"><a href="annex-i-compendium-of-r-scripts.html#cb68-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-74"><a href="annex-i-compendium-of-r-scripts.html#cb68-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crop covariates on administrative boundary</span></span>
<span id="cb68-75"><a href="annex-i-compendium-of-r-scripts.html#cb68-75" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb68-76"><a href="annex-i-compendium-of-r-scripts.html#cb68-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-77"><a href="annex-i-compendium-of-r-scripts.html#cb68-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform raster information with PCA</span></span>
<span id="cb68-78"><a href="annex-i-compendium-of-r-scripts.html#cb68-78" aria-hidden="true" tabindex="-1"></a>  pca <span class="ot">&lt;-</span> <span class="fu">raster_pca</span>(cov.dat)</span>
<span id="cb68-79"><a href="annex-i-compendium-of-r-scripts.html#cb68-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-80"><a href="annex-i-compendium-of-r-scripts.html#cb68-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get SpatRaster layers</span></span>
<span id="cb68-81"><a href="annex-i-compendium-of-r-scripts.html#cb68-81" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb68-82"><a href="annex-i-compendium-of-r-scripts.html#cb68-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a raster stack to be used as input in the clhs::clhs function </span></span>
<span id="cb68-83"><a href="annex-i-compendium-of-r-scripts.html#cb68-83" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat) </span>
<span id="cb68-84"><a href="annex-i-compendium-of-r-scripts.html#cb68-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset rasters</span></span>
<span id="cb68-85"><a href="annex-i-compendium-of-r-scripts.html#cb68-85" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb68-86"><a href="annex-i-compendium-of-r-scripts.html#cb68-86" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span>  cov.dat.ras[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb68-87"><a href="annex-i-compendium-of-r-scripts.html#cb68-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-88"><a href="annex-i-compendium-of-r-scripts.html#cb68-88" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 - Extract environmental data from rasters at soil locations ===============</span></span>
<span id="cb68-89"><a href="annex-i-compendium-of-r-scripts.html#cb68-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load legacy soil data</span></span>
<span id="cb68-90"><a href="annex-i-compendium-of-r-scripts.html#cb68-90" aria-hidden="true" tabindex="-1"></a>  p.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">vect</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/legacy_soils.shp&quot;</span>)))</span>
<span id="cb68-91"><a href="annex-i-compendium-of-r-scripts.html#cb68-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract data</span></span>
<span id="cb68-92"><a href="annex-i-compendium-of-r-scripts.html#cb68-92" aria-hidden="true" tabindex="-1"></a>  p.dat_I <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(cov.dat, p.dat)</span>
<span id="cb68-93"><a href="annex-i-compendium-of-r-scripts.html#cb68-93" aria-hidden="true" tabindex="-1"></a>  p.dat_I <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(p.dat_I) <span class="co"># Remove soil points outside study area</span></span>
<span id="cb68-94"><a href="annex-i-compendium-of-r-scripts.html#cb68-94" aria-hidden="true" tabindex="-1"></a>  p.dat_I.df <span class="ot">&lt;-</span> p.dat_I[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb68-95"><a href="annex-i-compendium-of-r-scripts.html#cb68-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>(p.dat_I.df)</span>
<span id="cb68-96"><a href="annex-i-compendium-of-r-scripts.html#cb68-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-97"><a href="annex-i-compendium-of-r-scripts.html#cb68-97" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 - Compute variability matrix in the covariates ====================================</span></span>
<span id="cb68-98"><a href="annex-i-compendium-of-r-scripts.html#cb68-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define Number of bins</span></span>
<span id="cb68-99"><a href="annex-i-compendium-of-r-scripts.html#cb68-99" aria-hidden="true" tabindex="-1"></a>  nb <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb68-100"><a href="annex-i-compendium-of-r-scripts.html#cb68-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Quantile matrix of the covariate data</span></span>
<span id="cb68-101"><a href="annex-i-compendium-of-r-scripts.html#cb68-101" aria-hidden="true" tabindex="-1"></a>  q.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> (nb <span class="sc">+</span> <span class="dv">1</span>), <span class="at">ncol =</span> <span class="fu">nlyr</span>(cov.dat))</span>
<span id="cb68-102"><a href="annex-i-compendium-of-r-scripts.html#cb68-102" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb68-103"><a href="annex-i-compendium-of-r-scripts.html#cb68-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(cov.dat)) {</span>
<span id="cb68-104"><a href="annex-i-compendium-of-r-scripts.html#cb68-104" aria-hidden="true" tabindex="-1"></a>    ran1 <span class="ot">&lt;-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>]</span>
<span id="cb68-105"><a href="annex-i-compendium-of-r-scripts.html#cb68-105" aria-hidden="true" tabindex="-1"></a>    step1 <span class="ot">&lt;-</span> ran1 <span class="sc">/</span> nb</span>
<span id="cb68-106"><a href="annex-i-compendium-of-r-scripts.html#cb68-106" aria-hidden="true" tabindex="-1"></a>    q.mat[, j] <span class="ot">&lt;-</span></span>
<span id="cb68-107"><a href="annex-i-compendium-of-r-scripts.html#cb68-107" aria-hidden="true" tabindex="-1"></a>      <span class="fu">seq</span>(<span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>],</span>
<span id="cb68-108"><a href="annex-i-compendium-of-r-scripts.html#cb68-108" aria-hidden="true" tabindex="-1"></a>          <span class="at">to =</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>],</span>
<span id="cb68-109"><a href="annex-i-compendium-of-r-scripts.html#cb68-109" aria-hidden="true" tabindex="-1"></a>          <span class="at">by =</span> step1)</span>
<span id="cb68-110"><a href="annex-i-compendium-of-r-scripts.html#cb68-110" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb68-111"><a href="annex-i-compendium-of-r-scripts.html#cb68-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-112"><a href="annex-i-compendium-of-r-scripts.html#cb68-112" aria-hidden="true" tabindex="-1"></a>  q.mat</span>
<span id="cb68-113"><a href="annex-i-compendium-of-r-scripts.html#cb68-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-114"><a href="annex-i-compendium-of-r-scripts.html#cb68-114" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 - Calculate hypercube of &quot;covariates&quot; distribution (P)  ===================  </span></span>
<span id="cb68-115"><a href="annex-i-compendium-of-r-scripts.html#cb68-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert SpatRaster to dataframe for calculations</span></span>
<span id="cb68-116"><a href="annex-i-compendium-of-r-scripts.html#cb68-116" aria-hidden="true" tabindex="-1"></a>  cov.dat.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(cov.dat) </span>
<span id="cb68-117"><a href="annex-i-compendium-of-r-scripts.html#cb68-117" aria-hidden="true" tabindex="-1"></a>  cov.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb68-118"><a href="annex-i-compendium-of-r-scripts.html#cb68-118" aria-hidden="true" tabindex="-1"></a>  cov.dat.mx <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cov.dat.df)</span>
<span id="cb68-119"><a href="annex-i-compendium-of-r-scripts.html#cb68-119" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cov.dat.mx)) {</span>
<span id="cb68-120"><a href="annex-i-compendium-of-r-scripts.html#cb68-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.mx)) {</span>
<span id="cb68-121"><a href="annex-i-compendium-of-r-scripts.html#cb68-121" aria-hidden="true" tabindex="-1"></a>      dd <span class="ot">&lt;-</span> cov.dat.mx[[i, j]]</span>
<span id="cb68-122"><a href="annex-i-compendium-of-r-scripts.html#cb68-122" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb68-123"><a href="annex-i-compendium-of-r-scripts.html#cb68-123" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb68-124"><a href="annex-i-compendium-of-r-scripts.html#cb68-124" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb68-125"><a href="annex-i-compendium-of-r-scripts.html#cb68-125" aria-hidden="true" tabindex="-1"></a>          kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb68-126"><a href="annex-i-compendium-of-r-scripts.html#cb68-126" aria-hidden="true" tabindex="-1"></a>          ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb68-127"><a href="annex-i-compendium-of-r-scripts.html#cb68-127" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb68-128"><a href="annex-i-compendium-of-r-scripts.html#cb68-128" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb68-129"><a href="annex-i-compendium-of-r-scripts.html#cb68-129" aria-hidden="true" tabindex="-1"></a>            cov.mat[k, j] <span class="ot">&lt;-</span> cov.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb68-130"><a href="annex-i-compendium-of-r-scripts.html#cb68-130" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb68-131"><a href="annex-i-compendium-of-r-scripts.html#cb68-131" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb68-132"><a href="annex-i-compendium-of-r-scripts.html#cb68-132" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb68-133"><a href="annex-i-compendium-of-r-scripts.html#cb68-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb68-134"><a href="annex-i-compendium-of-r-scripts.html#cb68-134" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-135"><a href="annex-i-compendium-of-r-scripts.html#cb68-135" aria-hidden="true" tabindex="-1"></a>  cov.mat</span>
<span id="cb68-136"><a href="annex-i-compendium-of-r-scripts.html#cb68-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-137"><a href="annex-i-compendium-of-r-scripts.html#cb68-137" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 - Calculate hypercube of &quot;sample&quot; distribution (Q) ========================  </span></span>
<span id="cb68-138"><a href="annex-i-compendium-of-r-scripts.html#cb68-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-139"><a href="annex-i-compendium-of-r-scripts.html#cb68-139" aria-hidden="true" tabindex="-1"></a>  h.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb68-140"><a href="annex-i-compendium-of-r-scripts.html#cb68-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p.dat_I.df)) {</span>
<span id="cb68-141"><a href="annex-i-compendium-of-r-scripts.html#cb68-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(p.dat_I.df)) {</span>
<span id="cb68-142"><a href="annex-i-compendium-of-r-scripts.html#cb68-142" aria-hidden="true" tabindex="-1"></a>      dd <span class="ot">&lt;-</span> p.dat_I.df[i, j]</span>
<span id="cb68-143"><a href="annex-i-compendium-of-r-scripts.html#cb68-143" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb68-144"><a href="annex-i-compendium-of-r-scripts.html#cb68-144" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb68-145"><a href="annex-i-compendium-of-r-scripts.html#cb68-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb68-146"><a href="annex-i-compendium-of-r-scripts.html#cb68-146" aria-hidden="true" tabindex="-1"></a>          kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb68-147"><a href="annex-i-compendium-of-r-scripts.html#cb68-147" aria-hidden="true" tabindex="-1"></a>          ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb68-148"><a href="annex-i-compendium-of-r-scripts.html#cb68-148" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb68-149"><a href="annex-i-compendium-of-r-scripts.html#cb68-149" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb68-150"><a href="annex-i-compendium-of-r-scripts.html#cb68-150" aria-hidden="true" tabindex="-1"></a>            h.mat[k, j] <span class="ot">&lt;-</span> h.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb68-151"><a href="annex-i-compendium-of-r-scripts.html#cb68-151" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb68-152"><a href="annex-i-compendium-of-r-scripts.html#cb68-152" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb68-153"><a href="annex-i-compendium-of-r-scripts.html#cb68-153" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb68-154"><a href="annex-i-compendium-of-r-scripts.html#cb68-154" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb68-155"><a href="annex-i-compendium-of-r-scripts.html#cb68-155" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-156"><a href="annex-i-compendium-of-r-scripts.html#cb68-156" aria-hidden="true" tabindex="-1"></a>  h.mat </span>
<span id="cb68-157"><a href="annex-i-compendium-of-r-scripts.html#cb68-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-158"><a href="annex-i-compendium-of-r-scripts.html#cb68-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-159"><a href="annex-i-compendium-of-r-scripts.html#cb68-159" aria-hidden="true" tabindex="-1"></a><span class="do">## 7 - Calculate Representativeness of the Legacy Dataset ==================    </span></span>
<span id="cb68-160"><a href="annex-i-compendium-of-r-scripts.html#cb68-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-161"><a href="annex-i-compendium-of-r-scripts.html#cb68-161" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate the proportion of &quot;variables&quot; in the covariate spectra that fall within the convex hull of variables in the &quot;environmental sample space&quot;</span></span>
<span id="cb68-162"><a href="annex-i-compendium-of-r-scripts.html#cb68-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Principal component of the legacy data sample</span></span>
<span id="cb68-163"><a href="annex-i-compendium-of-r-scripts.html#cb68-163" aria-hidden="true" tabindex="-1"></a>  pca.s <span class="ot">=</span> <span class="fu">prcomp</span>(p.dat_I[,<span class="dv">2</span><span class="sc">:</span>(<span class="fu">ncol</span>(cov.dat.df)<span class="sc">+</span><span class="dv">1</span>)],<span class="at">scale=</span><span class="cn">TRUE</span>, <span class="at">center=</span><span class="cn">TRUE</span>)</span>
<span id="cb68-164"><a href="annex-i-compendium-of-r-scripts.html#cb68-164" aria-hidden="true" tabindex="-1"></a>  scores_pca1 <span class="ot">=</span> <span class="fu">as.data.frame</span>(pca.s<span class="sc">$</span>x)</span>
<span id="cb68-165"><a href="annex-i-compendium-of-r-scripts.html#cb68-165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the first 2 principal components and convex hull</span></span>
<span id="cb68-166"><a href="annex-i-compendium-of-r-scripts.html#cb68-166" aria-hidden="true" tabindex="-1"></a>  rand.tr <span class="ot">&lt;-</span> <span class="fu">tri.mesh</span>(scores_pca1[,<span class="dv">1</span>],scores_pca1[,<span class="dv">2</span>],<span class="st">&quot;remove&quot;</span>) <span class="co"># Delaunay triangulation </span></span>
<span id="cb68-167"><a href="annex-i-compendium-of-r-scripts.html#cb68-167" aria-hidden="true" tabindex="-1"></a>  rand.ch <span class="ot">&lt;-</span> <span class="fu">convex.hull</span>(rand.tr, <span class="at">plot.it=</span>F) <span class="co"># convex hull</span></span>
<span id="cb68-168"><a href="annex-i-compendium-of-r-scripts.html#cb68-168" aria-hidden="true" tabindex="-1"></a>  pr_poly <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x=</span><span class="fu">c</span>(rand.ch<span class="sc">$</span>x),<span class="at">y=</span><span class="fu">c</span>(rand.ch<span class="sc">$</span>y)) <span class="co"># save the convex hull vertices</span></span>
<span id="cb68-169"><a href="annex-i-compendium-of-r-scripts.html#cb68-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(scores_pca1[,<span class="dv">1</span>], scores_pca1[,<span class="dv">2</span>], <span class="at">xlab=</span><span class="st">&quot;PCA 1&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;PCA 2&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])),<span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">main=</span><span class="st">&#39;Convex hull of soil legacy data&#39;</span>)</span>
<span id="cb68-170"><a href="annex-i-compendium-of-r-scripts.html#cb68-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">c</span>(rand.ch<span class="sc">$</span>x,rand.ch<span class="sc">$</span>x[<span class="dv">1</span>]), <span class="fu">c</span>(rand.ch<span class="sc">$</span>y,rand.ch<span class="sc">$</span>y[<span class="dv">1</span>]),<span class="at">col=</span><span class="st">&quot;red&quot;</span>,<span class="at">lwd=</span><span class="dv">1</span>) <span class="co"># draw the convex hull (domain of legacy data)</span></span>
<span id="cb68-171"><a href="annex-i-compendium-of-r-scripts.html#cb68-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-172"><a href="annex-i-compendium-of-r-scripts.html#cb68-172" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PCA projection of study area population onto the principal components</span></span>
<span id="cb68-173"><a href="annex-i-compendium-of-r-scripts.html#cb68-173" aria-hidden="true" tabindex="-1"></a>  PCA_projection <span class="ot">&lt;-</span> <span class="fu">predict</span>(pca.s, cov.dat.df) <span class="co"># Project study area population onto sample PC</span></span>
<span id="cb68-174"><a href="annex-i-compendium-of-r-scripts.html#cb68-174" aria-hidden="true" tabindex="-1"></a>  newScores <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x=</span>PCA_projection[,<span class="dv">1</span>],<span class="at">y=</span>PCA_projection[,<span class="dv">2</span>]) <span class="co"># PC scores of projected population</span></span>
<span id="cb68-175"><a href="annex-i-compendium-of-r-scripts.html#cb68-175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-176"><a href="annex-i-compendium-of-r-scripts.html#cb68-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the polygon and all points to be checked</span></span>
<span id="cb68-177"><a href="annex-i-compendium-of-r-scripts.html#cb68-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(newScores, <span class="at">xlab=</span><span class="st">&quot;PCA 1&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;PCA 2&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">col=</span><span class="st">&#39;black&#39;</span>, <span class="at">main=</span><span class="st">&#39;Environmental space plots over the convex hull of soil legacy data&#39;</span>)</span>
<span id="cb68-178"><a href="annex-i-compendium-of-r-scripts.html#cb68-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(pr_poly,<span class="at">col=</span><span class="st">&#39;#99999990&#39;</span>)</span>
<span id="cb68-179"><a href="annex-i-compendium-of-r-scripts.html#cb68-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check which points fall within the polygon</span></span>
<span id="cb68-180"><a href="annex-i-compendium-of-r-scripts.html#cb68-180" aria-hidden="true" tabindex="-1"></a>  pip <span class="ot">&lt;-</span> <span class="fu">point.in.polygon</span>(newScores[,<span class="dv">2</span>], newScores[,<span class="dv">1</span>], pr_poly[,<span class="dv">2</span>],pr_poly[,<span class="dv">1</span>],<span class="at">mode.checked=</span><span class="cn">FALSE</span>)</span>
<span id="cb68-181"><a href="annex-i-compendium-of-r-scripts.html#cb68-181" aria-hidden="true" tabindex="-1"></a>  newScores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(newScores, pip))</span>
<span id="cb68-182"><a href="annex-i-compendium-of-r-scripts.html#cb68-182" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot points outside convex hull  </span></span>
<span id="cb68-183"><a href="annex-i-compendium-of-r-scripts.html#cb68-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(newScores[<span class="fu">which</span>(newScores<span class="sc">$</span>pip<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="at">pch=</span><span class="st">&#39;X&#39;</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb68-184"><a href="annex-i-compendium-of-r-scripts.html#cb68-184" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-185"><a href="annex-i-compendium-of-r-scripts.html#cb68-185" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  Proportion of the conditions in the study area that fall within the convex hull of sample conditions</span></span>
<span id="cb68-186"><a href="annex-i-compendium-of-r-scripts.html#cb68-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">nrow</span>(newScores[newScores<span class="sc">$</span>pip<span class="sc">&gt;</span><span class="dv">0</span>,]))<span class="sc">/</span><span class="fu">nrow</span>(newScores)<span class="sc">*</span><span class="dv">100</span> </span>
<span id="cb68-187"><a href="annex-i-compendium-of-r-scripts.html#cb68-187" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-188"><a href="annex-i-compendium-of-r-scripts.html#cb68-188" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="re">END</span></span></code></pre></div>
</div>
<div id="script-4-calculate-minimum-sample-size" class="section level2 unnumbered hasAnchor">
<h2>Script 4: Calculate Minimum Sample Size<a href="annex-i-compendium-of-r-scripts.html#script-4-calculate-minimum-sample-size" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="annex-i-compendium-of-r-scripts.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb69-2"><a href="annex-i-compendium-of-r-scripts.html#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb69-3"><a href="annex-i-compendium-of-r-scripts.html#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb69-4"><a href="annex-i-compendium-of-r-scripts.html#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimizing Sample Size</span></span>
<span id="cb69-5"><a href="annex-i-compendium-of-r-scripts.html#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb69-6"><a href="annex-i-compendium-of-r-scripts.html#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb69-7"><a href="annex-i-compendium-of-r-scripts.html#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb69-8"><a href="annex-i-compendium-of-r-scripts.html#cb69-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-9"><a href="annex-i-compendium-of-r-scripts.html#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb69-10"><a href="annex-i-compendium-of-r-scripts.html#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="annex-i-compendium-of-r-scripts.html#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Empty environment and cache </span></span>
<span id="cb69-12"><a href="annex-i-compendium-of-r-scripts.html#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb69-13"><a href="annex-i-compendium-of-r-scripts.html#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb69-14"><a href="annex-i-compendium-of-r-scripts.html#cb69-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-15"><a href="annex-i-compendium-of-r-scripts.html#cb69-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script ========================================</span></span>
<span id="cb69-16"><a href="annex-i-compendium-of-r-scripts.html#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="co"># The goal of this script is to determine the minimum sample size required to describe an area</span></span>
<span id="cb69-17"><a href="annex-i-compendium-of-r-scripts.html#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="co"># while retaining for a 95% of coincidence in the environmental variability of covariates</span></span>
<span id="cb69-18"><a href="annex-i-compendium-of-r-scripts.html#cb69-18" aria-hidden="true" tabindex="-1"></a><span class="co"># in the area </span></span>
<span id="cb69-19"><a href="annex-i-compendium-of-r-scripts.html#cb69-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb69-20"><a href="annex-i-compendium-of-r-scripts.html#cb69-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load necessary packages</span></span>
<span id="cb69-21"><a href="annex-i-compendium-of-r-scripts.html#cb69-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb69-22"><a href="annex-i-compendium-of-r-scripts.html#cb69-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import national data </span></span>
<span id="cb69-23"><a href="annex-i-compendium-of-r-scripts.html#cb69-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Calculate the minimum sample size to describe the area</span></span>
<span id="cb69-24"><a href="annex-i-compendium-of-r-scripts.html#cb69-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Plot covariate diversity as PCA scores </span></span>
<span id="cb69-25"><a href="annex-i-compendium-of-r-scripts.html#cb69-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - KL divergence and % similarity results for growing N samples</span></span>
<span id="cb69-26"><a href="annex-i-compendium-of-r-scripts.html#cb69-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Model KL divergence</span></span>
<span id="cb69-27"><a href="annex-i-compendium-of-r-scripts.html#cb69-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Determine the minimum sample size for 95% coincidence</span></span>
<span id="cb69-28"><a href="annex-i-compendium-of-r-scripts.html#cb69-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Determine the optimal iteration according to the minimum N size </span></span>
<span id="cb69-29"><a href="annex-i-compendium-of-r-scripts.html#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot minimum points from best iteration</span></span>
<span id="cb69-30"><a href="annex-i-compendium-of-r-scripts.html#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb69-31"><a href="annex-i-compendium-of-r-scripts.html#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="annex-i-compendium-of-r-scripts.html#cb69-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-33"><a href="annex-i-compendium-of-r-scripts.html#cb69-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load necessary packages =======================</span></span>
<span id="cb69-34"><a href="annex-i-compendium-of-r-scripts.html#cb69-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-35"><a href="annex-i-compendium-of-r-scripts.html#cb69-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Set working directory to source file location</span></span>
<span id="cb69-36"><a href="annex-i-compendium-of-r-scripts.html#cb69-36" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb69-37"><a href="annex-i-compendium-of-r-scripts.html#cb69-37" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb69-38"><a href="annex-i-compendium-of-r-scripts.html#cb69-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-39"><a href="annex-i-compendium-of-r-scripts.html#cb69-39" aria-hidden="true" tabindex="-1"></a><span class="co"># List of packages</span></span>
<span id="cb69-40"><a href="annex-i-compendium-of-r-scripts.html#cb69-40" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;terra&quot;</span>,<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sf&quot;</span>,<span class="st">&quot;clhs&quot;</span>,</span>
<span id="cb69-41"><a href="annex-i-compendium-of-r-scripts.html#cb69-41" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;sgsR&quot;</span>,<span class="st">&quot;entropy&quot;</span>, <span class="st">&quot;tripack&quot;</span>,</span>
<span id="cb69-42"><a href="annex-i-compendium-of-r-scripts.html#cb69-42" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;manipulate&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;plotly&quot;</span>,<span class="st">&quot;synoptReg&quot;</span>)</span>
<span id="cb69-43"><a href="annex-i-compendium-of-r-scripts.html#cb69-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-44"><a href="annex-i-compendium-of-r-scripts.html#cb69-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb69-45"><a href="annex-i-compendium-of-r-scripts.html#cb69-45" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>) </span>
<span id="cb69-46"><a href="annex-i-compendium-of-r-scripts.html#cb69-46" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(packages) <span class="co"># Remove object to save memory space</span></span>
<span id="cb69-47"><a href="annex-i-compendium-of-r-scripts.html#cb69-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-48"><a href="annex-i-compendium-of-r-scripts.html#cb69-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-49"><a href="annex-i-compendium-of-r-scripts.html#cb69-49" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb69-50"><a href="annex-i-compendium-of-r-scripts.html#cb69-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to rasters</span></span>
<span id="cb69-51"><a href="annex-i-compendium-of-r-scripts.html#cb69-51" aria-hidden="true" tabindex="-1"></a>raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters/&quot;</span></span>
<span id="cb69-52"><a href="annex-i-compendium-of-r-scripts.html#cb69-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to shapes</span></span>
<span id="cb69-53"><a href="annex-i-compendium-of-r-scripts.html#cb69-53" aria-hidden="true" tabindex="-1"></a>shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes/&quot;</span></span>
<span id="cb69-54"><a href="annex-i-compendium-of-r-scripts.html#cb69-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to results</span></span>
<span id="cb69-55"><a href="annex-i-compendium-of-r-scripts.html#cb69-55" aria-hidden="true" tabindex="-1"></a>results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb69-56"><a href="annex-i-compendium-of-r-scripts.html#cb69-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to additional data</span></span>
<span id="cb69-57"><a href="annex-i-compendium-of-r-scripts.html#cb69-57" aria-hidden="true" tabindex="-1"></a>other.path <span class="ot">&lt;-</span> <span class="st">&quot;data/other/&quot;</span></span>
<span id="cb69-58"><a href="annex-i-compendium-of-r-scripts.html#cb69-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregation factor for up-scaling raster covariates (optional)</span></span>
<span id="cb69-59"><a href="annex-i-compendium-of-r-scripts.html#cb69-59" aria-hidden="true" tabindex="-1"></a>agg.factor <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb69-60"><a href="annex-i-compendium-of-r-scripts.html#cb69-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-61"><a href="annex-i-compendium-of-r-scripts.html#cb69-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Define parameters to determine minimum sampling size</span></span>
<span id="cb69-62"><a href="annex-i-compendium-of-r-scripts.html#cb69-62" aria-hidden="true" tabindex="-1"></a>initial.n <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="co"># Initial sampling size to test</span></span>
<span id="cb69-63"><a href="annex-i-compendium-of-r-scripts.html#cb69-63" aria-hidden="true" tabindex="-1"></a>final.n <span class="ot">&lt;-</span> <span class="dv">250</span> <span class="co"># Final sampling size to test</span></span>
<span id="cb69-64"><a href="annex-i-compendium-of-r-scripts.html#cb69-64" aria-hidden="true" tabindex="-1"></a>by.n <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># Increment size</span></span>
<span id="cb69-65"><a href="annex-i-compendium-of-r-scripts.html#cb69-65" aria-hidden="true" tabindex="-1"></a>iters <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># Number of trials on each size</span></span>
<span id="cb69-66"><a href="annex-i-compendium-of-r-scripts.html#cb69-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-67"><a href="annex-i-compendium-of-r-scripts.html#cb69-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-68"><a href="annex-i-compendium-of-r-scripts.html#cb69-68" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Import national data ====================================================</span></span>
<span id="cb69-69"><a href="annex-i-compendium-of-r-scripts.html#cb69-69" aria-hidden="true" tabindex="-1"></a><span class="do">## Load raster covariate data</span></span>
<span id="cb69-70"><a href="annex-i-compendium-of-r-scripts.html#cb69-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb69-71"><a href="annex-i-compendium-of-r-scripts.html#cb69-71" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(raster.path, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-72"><a href="annex-i-compendium-of-r-scripts.html#cb69-72" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat) <span class="co"># SpatRaster from terra</span></span>
<span id="cb69-73"><a href="annex-i-compendium-of-r-scripts.html#cb69-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate stack to simplify data rasters for calculations </span></span>
<span id="cb69-74"><a href="annex-i-compendium-of-r-scripts.html#cb69-74" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(cov.dat, <span class="at">fact=</span>agg.factor, <span class="at">fun=</span><span class="st">&quot;mean&quot;</span>)</span>
<span id="cb69-75"><a href="annex-i-compendium-of-r-scripts.html#cb69-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Load shape of district</span></span>
<span id="cb69-76"><a href="annex-i-compendium-of-r-scripts.html#cb69-76" aria-hidden="true" tabindex="-1"></a>nghe <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/Nghe_An.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb69-77"><a href="annex-i-compendium-of-r-scripts.html#cb69-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-78"><a href="annex-i-compendium-of-r-scripts.html#cb69-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop covariates on administrative boundary</span></span>
<span id="cb69-79"><a href="annex-i-compendium-of-r-scripts.html#cb69-79" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb69-80"><a href="annex-i-compendium-of-r-scripts.html#cb69-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Store elevation and slope separately</span></span>
<span id="cb69-81"><a href="annex-i-compendium-of-r-scripts.html#cb69-81" aria-hidden="true" tabindex="-1"></a>elevation <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_elevation_250m</span>
<span id="cb69-82"><a href="annex-i-compendium-of-r-scripts.html#cb69-82" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_slope_250m</span>
<span id="cb69-83"><a href="annex-i-compendium-of-r-scripts.html#cb69-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-84"><a href="annex-i-compendium-of-r-scripts.html#cb69-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Load roads</span></span>
<span id="cb69-85"><a href="annex-i-compendium-of-r-scripts.html#cb69-85" aria-hidden="true" tabindex="-1"></a>roads <span class="ot">&lt;-</span>  <span class="fu">vect</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/roads.shp&quot;</span>)))</span>
<span id="cb69-86"><a href="annex-i-compendium-of-r-scripts.html#cb69-86" aria-hidden="true" tabindex="-1"></a>roads <span class="ot">&lt;-</span> <span class="fu">crop</span>(roads, nghe)</span>
<span id="cb69-87"><a href="annex-i-compendium-of-r-scripts.html#cb69-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-88"><a href="annex-i-compendium-of-r-scripts.html#cb69-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplify raster information with PCA</span></span>
<span id="cb69-89"><a href="annex-i-compendium-of-r-scripts.html#cb69-89" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> <span class="fu">raster_pca</span>(cov.dat)</span>
<span id="cb69-90"><a href="annex-i-compendium-of-r-scripts.html#cb69-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-91"><a href="annex-i-compendium-of-r-scripts.html#cb69-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Get SpatRaster layers</span></span>
<span id="cb69-92"><a href="annex-i-compendium-of-r-scripts.html#cb69-92" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb69-93"><a href="annex-i-compendium-of-r-scripts.html#cb69-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset rasters</span></span>
<span id="cb69-94"><a href="annex-i-compendium-of-r-scripts.html#cb69-94" aria-hidden="true" tabindex="-1"></a>cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb69-95"><a href="annex-i-compendium-of-r-scripts.html#cb69-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot covariates</span></span>
<span id="cb69-96"><a href="annex-i-compendium-of-r-scripts.html#cb69-96" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cov.dat)</span>
<span id="cb69-97"><a href="annex-i-compendium-of-r-scripts.html#cb69-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-98"><a href="annex-i-compendium-of-r-scripts.html#cb69-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-99"><a href="annex-i-compendium-of-r-scripts.html#cb69-99" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Calculate the minimum sample size to describe the area ===================</span></span>
<span id="cb69-100"><a href="annex-i-compendium-of-r-scripts.html#cb69-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Start computations ----</span></span>
<span id="cb69-101"><a href="annex-i-compendium-of-r-scripts.html#cb69-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize empty vectors to store results</span></span>
<span id="cb69-102"><a href="annex-i-compendium-of-r-scripts.html#cb69-102" aria-hidden="true" tabindex="-1"></a>number_of_samples <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb69-103"><a href="annex-i-compendium-of-r-scripts.html#cb69-103" aria-hidden="true" tabindex="-1"></a>prop_explained <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb69-104"><a href="annex-i-compendium-of-r-scripts.html#cb69-104" aria-hidden="true" tabindex="-1"></a>klo_samples <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb69-105"><a href="annex-i-compendium-of-r-scripts.html#cb69-105" aria-hidden="true" tabindex="-1"></a>samples_storage <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb69-106"><a href="annex-i-compendium-of-r-scripts.html#cb69-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-107"><a href="annex-i-compendium-of-r-scripts.html#cb69-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert SpatRaster to dataframe</span></span>
<span id="cb69-108"><a href="annex-i-compendium-of-r-scripts.html#cb69-108" aria-hidden="true" tabindex="-1"></a>cov.dat.df <span class="ot">&lt;-</span>  <span class="fu">as.data.frame</span>(cov.dat)</span>
<span id="cb69-109"><a href="annex-i-compendium-of-r-scripts.html#cb69-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-110"><a href="annex-i-compendium-of-r-scripts.html#cb69-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Start evaluation with growing sample sizes</span></span>
<span id="cb69-111"><a href="annex-i-compendium-of-r-scripts.html#cb69-111" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (trial <span class="cf">in</span> <span class="fu">seq</span>(initial.n, final.n, <span class="at">by =</span> by.n)) {</span>
<span id="cb69-112"><a href="annex-i-compendium-of-r-scripts.html#cb69-112" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (iteration <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>iters) {</span>
<span id="cb69-113"><a href="annex-i-compendium-of-r-scripts.html#cb69-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate stratified clhs samples</span></span>
<span id="cb69-114"><a href="annex-i-compendium-of-r-scripts.html#cb69-114" aria-hidden="true" tabindex="-1"></a>    p.dat_I <span class="ot">&lt;-</span>  <span class="fu">sample_clhs</span>(cov.dat,</span>
<span id="cb69-115"><a href="annex-i-compendium-of-r-scripts.html#cb69-115" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nSamp =</span> trial, <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb69-116"><a href="annex-i-compendium-of-r-scripts.html#cb69-116" aria-hidden="true" tabindex="-1"></a>                     <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-117"><a href="annex-i-compendium-of-r-scripts.html#cb69-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-118"><a href="annex-i-compendium-of-r-scripts.html#cb69-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get covariate values as dataframe and delete NAs, avoid geometry</span></span>
<span id="cb69-119"><a href="annex-i-compendium-of-r-scripts.html#cb69-119" aria-hidden="true" tabindex="-1"></a>    p.dat_I.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(p.dat_I) <span class="sc">%&gt;%</span></span>
<span id="cb69-120"><a href="annex-i-compendium-of-r-scripts.html#cb69-120" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">!</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb69-121"><a href="annex-i-compendium-of-r-scripts.html#cb69-121" aria-hidden="true" tabindex="-1"></a>      <span class="fu">na.omit</span>()</span>
<span id="cb69-122"><a href="annex-i-compendium-of-r-scripts.html#cb69-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-123"><a href="annex-i-compendium-of-r-scripts.html#cb69-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store samples as list</span></span>
<span id="cb69-124"><a href="annex-i-compendium-of-r-scripts.html#cb69-124" aria-hidden="true" tabindex="-1"></a>    samples_storage[[<span class="fu">paste0</span>(<span class="st">&quot;N&quot;</span>, trial, <span class="st">&quot;_&quot;</span>, iteration)]] <span class="ot">&lt;-</span> p.dat_I</span>
<span id="cb69-125"><a href="annex-i-compendium-of-r-scripts.html#cb69-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-126"><a href="annex-i-compendium-of-r-scripts.html#cb69-126" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Comparison of population and sample distributions - Kullback-Leibler (KL) divergence</span></span>
<span id="cb69-127"><a href="annex-i-compendium-of-r-scripts.html#cb69-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define quantiles of the study area (number of bins)</span></span>
<span id="cb69-128"><a href="annex-i-compendium-of-r-scripts.html#cb69-128" aria-hidden="true" tabindex="-1"></a>    nb <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb69-129"><a href="annex-i-compendium-of-r-scripts.html#cb69-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile matrix of the covariate data</span></span>
<span id="cb69-130"><a href="annex-i-compendium-of-r-scripts.html#cb69-130" aria-hidden="true" tabindex="-1"></a>    q.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> (nb <span class="sc">+</span> <span class="dv">1</span>), <span class="at">ncol =</span> <span class="fu">nlyr</span>(cov.dat))</span>
<span id="cb69-131"><a href="annex-i-compendium-of-r-scripts.html#cb69-131" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb69-132"><a href="annex-i-compendium-of-r-scripts.html#cb69-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(cov.dat)) {</span>
<span id="cb69-133"><a href="annex-i-compendium-of-r-scripts.html#cb69-133" aria-hidden="true" tabindex="-1"></a>      ran1 <span class="ot">&lt;-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>]</span>
<span id="cb69-134"><a href="annex-i-compendium-of-r-scripts.html#cb69-134" aria-hidden="true" tabindex="-1"></a>      step1 <span class="ot">&lt;-</span> ran1 <span class="sc">/</span> nb</span>
<span id="cb69-135"><a href="annex-i-compendium-of-r-scripts.html#cb69-135" aria-hidden="true" tabindex="-1"></a>      q.mat[, j] <span class="ot">&lt;-</span></span>
<span id="cb69-136"><a href="annex-i-compendium-of-r-scripts.html#cb69-136" aria-hidden="true" tabindex="-1"></a>        <span class="fu">seq</span>(<span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>],</span>
<span id="cb69-137"><a href="annex-i-compendium-of-r-scripts.html#cb69-137" aria-hidden="true" tabindex="-1"></a>            <span class="at">to =</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>],</span>
<span id="cb69-138"><a href="annex-i-compendium-of-r-scripts.html#cb69-138" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> step1)</span>
<span id="cb69-139"><a href="annex-i-compendium-of-r-scripts.html#cb69-139" aria-hidden="true" tabindex="-1"></a>      j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb69-140"><a href="annex-i-compendium-of-r-scripts.html#cb69-140" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb69-141"><a href="annex-i-compendium-of-r-scripts.html#cb69-141" aria-hidden="true" tabindex="-1"></a>    q.mat</span>
<span id="cb69-142"><a href="annex-i-compendium-of-r-scripts.html#cb69-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-143"><a href="annex-i-compendium-of-r-scripts.html#cb69-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hypercube of covariates in study area</span></span>
<span id="cb69-144"><a href="annex-i-compendium-of-r-scripts.html#cb69-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize the covariate matrix</span></span>
<span id="cb69-145"><a href="annex-i-compendium-of-r-scripts.html#cb69-145" aria-hidden="true" tabindex="-1"></a>    cov.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb69-146"><a href="annex-i-compendium-of-r-scripts.html#cb69-146" aria-hidden="true" tabindex="-1"></a>    cov.dat.mx <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cov.dat.df)</span>
<span id="cb69-147"><a href="annex-i-compendium-of-r-scripts.html#cb69-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cov.dat.mx)) {</span>
<span id="cb69-148"><a href="annex-i-compendium-of-r-scripts.html#cb69-148" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.mx)) {</span>
<span id="cb69-149"><a href="annex-i-compendium-of-r-scripts.html#cb69-149" aria-hidden="true" tabindex="-1"></a>        dd <span class="ot">&lt;-</span> cov.dat.mx[[i, j]]</span>
<span id="cb69-150"><a href="annex-i-compendium-of-r-scripts.html#cb69-150" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-151"><a href="annex-i-compendium-of-r-scripts.html#cb69-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb69-152"><a href="annex-i-compendium-of-r-scripts.html#cb69-152" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb69-153"><a href="annex-i-compendium-of-r-scripts.html#cb69-153" aria-hidden="true" tabindex="-1"></a>            kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb69-154"><a href="annex-i-compendium-of-r-scripts.html#cb69-154" aria-hidden="true" tabindex="-1"></a>            ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb69-155"><a href="annex-i-compendium-of-r-scripts.html#cb69-155" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb69-156"><a href="annex-i-compendium-of-r-scripts.html#cb69-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb69-157"><a href="annex-i-compendium-of-r-scripts.html#cb69-157" aria-hidden="true" tabindex="-1"></a>              cov.mat[k, j] <span class="ot">&lt;-</span> cov.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb69-158"><a href="annex-i-compendium-of-r-scripts.html#cb69-158" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb69-159"><a href="annex-i-compendium-of-r-scripts.html#cb69-159" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb69-160"><a href="annex-i-compendium-of-r-scripts.html#cb69-160" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb69-161"><a href="annex-i-compendium-of-r-scripts.html#cb69-161" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb69-162"><a href="annex-i-compendium-of-r-scripts.html#cb69-162" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb69-163"><a href="annex-i-compendium-of-r-scripts.html#cb69-163" aria-hidden="true" tabindex="-1"></a>    cov.mat</span>
<span id="cb69-164"><a href="annex-i-compendium-of-r-scripts.html#cb69-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-165"><a href="annex-i-compendium-of-r-scripts.html#cb69-165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare whole study area covariate space with the selected sample</span></span>
<span id="cb69-166"><a href="annex-i-compendium-of-r-scripts.html#cb69-166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample data hypercube (the same as for the raster data but on the sample data)</span></span>
<span id="cb69-167"><a href="annex-i-compendium-of-r-scripts.html#cb69-167" aria-hidden="true" tabindex="-1"></a>    h.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb69-168"><a href="annex-i-compendium-of-r-scripts.html#cb69-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p.dat_I.df)) {</span>
<span id="cb69-169"><a href="annex-i-compendium-of-r-scripts.html#cb69-169" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(p.dat_I.df)) {</span>
<span id="cb69-170"><a href="annex-i-compendium-of-r-scripts.html#cb69-170" aria-hidden="true" tabindex="-1"></a>        dd <span class="ot">&lt;-</span> p.dat_I.df[i, j]</span>
<span id="cb69-171"><a href="annex-i-compendium-of-r-scripts.html#cb69-171" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-172"><a href="annex-i-compendium-of-r-scripts.html#cb69-172" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb69-173"><a href="annex-i-compendium-of-r-scripts.html#cb69-173" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb69-174"><a href="annex-i-compendium-of-r-scripts.html#cb69-174" aria-hidden="true" tabindex="-1"></a>            kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb69-175"><a href="annex-i-compendium-of-r-scripts.html#cb69-175" aria-hidden="true" tabindex="-1"></a>            ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb69-176"><a href="annex-i-compendium-of-r-scripts.html#cb69-176" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb69-177"><a href="annex-i-compendium-of-r-scripts.html#cb69-177" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb69-178"><a href="annex-i-compendium-of-r-scripts.html#cb69-178" aria-hidden="true" tabindex="-1"></a>              h.mat[k, j] <span class="ot">&lt;-</span> h.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb69-179"><a href="annex-i-compendium-of-r-scripts.html#cb69-179" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb69-180"><a href="annex-i-compendium-of-r-scripts.html#cb69-180" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb69-181"><a href="annex-i-compendium-of-r-scripts.html#cb69-181" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb69-182"><a href="annex-i-compendium-of-r-scripts.html#cb69-182" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb69-183"><a href="annex-i-compendium-of-r-scripts.html#cb69-183" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb69-184"><a href="annex-i-compendium-of-r-scripts.html#cb69-184" aria-hidden="true" tabindex="-1"></a>    h.mat</span>
<span id="cb69-185"><a href="annex-i-compendium-of-r-scripts.html#cb69-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-186"><a href="annex-i-compendium-of-r-scripts.html#cb69-186" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Compute Kullback-Leibler (KL) divergence</span></span>
<span id="cb69-187"><a href="annex-i-compendium-of-r-scripts.html#cb69-187" aria-hidden="true" tabindex="-1"></a>    kl.index <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb69-188"><a href="annex-i-compendium-of-r-scripts.html#cb69-188" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.df)) {</span>
<span id="cb69-189"><a href="annex-i-compendium-of-r-scripts.html#cb69-189" aria-hidden="true" tabindex="-1"></a>      kl <span class="ot">&lt;-</span>    <span class="fu">KL.empirical</span>(<span class="fu">c</span>(cov.mat[, i]), <span class="fu">c</span>(h.mat[, i]))</span>
<span id="cb69-190"><a href="annex-i-compendium-of-r-scripts.html#cb69-190" aria-hidden="true" tabindex="-1"></a>      kl.index <span class="ot">&lt;-</span> <span class="fu">c</span>(kl.index, kl)</span>
<span id="cb69-191"><a href="annex-i-compendium-of-r-scripts.html#cb69-191" aria-hidden="true" tabindex="-1"></a>      klo <span class="ot">&lt;-</span>  <span class="fu">mean</span>(kl.index)</span>
<span id="cb69-192"><a href="annex-i-compendium-of-r-scripts.html#cb69-192" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb69-193"><a href="annex-i-compendium-of-r-scripts.html#cb69-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-194"><a href="annex-i-compendium-of-r-scripts.html#cb69-194" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Calculate the proportion of &quot;env. variables&quot; in the covariate spectra that fall within the convex hull of variables in the &quot;environmental sample space&quot;</span></span>
<span id="cb69-195"><a href="annex-i-compendium-of-r-scripts.html#cb69-195" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Principal component of the data sample</span></span>
<span id="cb69-196"><a href="annex-i-compendium-of-r-scripts.html#cb69-196" aria-hidden="true" tabindex="-1"></a>    pca.s <span class="ot">=</span> <span class="fu">prcomp</span>(p.dat_I.df, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-197"><a href="annex-i-compendium-of-r-scripts.html#cb69-197" aria-hidden="true" tabindex="-1"></a>    scores_pca1 <span class="ot">=</span> <span class="fu">as.data.frame</span>(pca.s<span class="sc">$</span>x)</span>
<span id="cb69-198"><a href="annex-i-compendium-of-r-scripts.html#cb69-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the first 2 principal components and convex hull</span></span>
<span id="cb69-199"><a href="annex-i-compendium-of-r-scripts.html#cb69-199" aria-hidden="true" tabindex="-1"></a>    rand.tr <span class="ot">&lt;-</span></span>
<span id="cb69-200"><a href="annex-i-compendium-of-r-scripts.html#cb69-200" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tri.mesh</span>(scores_pca1[, <span class="dv">1</span>], scores_pca1[, <span class="dv">2</span>], <span class="st">&quot;remove&quot;</span>) <span class="co"># Delaunay triangulation</span></span>
<span id="cb69-201"><a href="annex-i-compendium-of-r-scripts.html#cb69-201" aria-hidden="true" tabindex="-1"></a>    rand.ch <span class="ot">&lt;-</span> <span class="fu">convex.hull</span>(rand.tr, <span class="at">plot.it =</span> F) <span class="co"># convex hull</span></span>
<span id="cb69-202"><a href="annex-i-compendium-of-r-scripts.html#cb69-202" aria-hidden="true" tabindex="-1"></a>    pr_poly <span class="ot">&lt;-</span></span>
<span id="cb69-203"><a href="annex-i-compendium-of-r-scripts.html#cb69-203" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cbind</span>(<span class="at">x =</span> <span class="fu">c</span>(rand.ch<span class="sc">$</span>x), <span class="at">y =</span> <span class="fu">c</span>(rand.ch<span class="sc">$</span>y)) <span class="co"># save the convex hull vertices</span></span>
<span id="cb69-204"><a href="annex-i-compendium-of-r-scripts.html#cb69-204" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PCA projection of study area population onto the principal components</span></span>
<span id="cb69-205"><a href="annex-i-compendium-of-r-scripts.html#cb69-205" aria-hidden="true" tabindex="-1"></a>    PCA_projection <span class="ot">&lt;-</span></span>
<span id="cb69-206"><a href="annex-i-compendium-of-r-scripts.html#cb69-206" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(pca.s, cov.dat.df) <span class="co"># Project study area population onto sample PC</span></span>
<span id="cb69-207"><a href="annex-i-compendium-of-r-scripts.html#cb69-207" aria-hidden="true" tabindex="-1"></a>    newScores <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x =</span> PCA_projection[, <span class="dv">1</span>], <span class="at">y =</span> PCA_projection[, <span class="dv">2</span>]) <span class="co"># PC scores of projected population</span></span>
<span id="cb69-208"><a href="annex-i-compendium-of-r-scripts.html#cb69-208" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check which points fall within the polygon</span></span>
<span id="cb69-209"><a href="annex-i-compendium-of-r-scripts.html#cb69-209" aria-hidden="true" tabindex="-1"></a>    pip <span class="ot">&lt;-</span></span>
<span id="cb69-210"><a href="annex-i-compendium-of-r-scripts.html#cb69-210" aria-hidden="true" tabindex="-1"></a>      <span class="fu">point.in.polygon</span>(newScores[, <span class="dv">2</span>], newScores[, <span class="dv">1</span>], pr_poly[, <span class="dv">2</span>], pr_poly[, <span class="dv">1</span>], <span class="at">mode.checked =</span></span>
<span id="cb69-211"><a href="annex-i-compendium-of-r-scripts.html#cb69-211" aria-hidden="true" tabindex="-1"></a>                         <span class="cn">FALSE</span>)</span>
<span id="cb69-212"><a href="annex-i-compendium-of-r-scripts.html#cb69-212" aria-hidden="true" tabindex="-1"></a>    newScores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(newScores, pip))</span>
<span id="cb69-213"><a href="annex-i-compendium-of-r-scripts.html#cb69-213" aria-hidden="true" tabindex="-1"></a>    klo_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(klo_samples, klo)</span>
<span id="cb69-214"><a href="annex-i-compendium-of-r-scripts.html#cb69-214" aria-hidden="true" tabindex="-1"></a>    prop_explained <span class="ot">&lt;-</span></span>
<span id="cb69-215"><a href="annex-i-compendium-of-r-scripts.html#cb69-215" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(prop_explained, <span class="fu">sum</span>(newScores<span class="sc">$</span>pip) <span class="sc">/</span> <span class="fu">nrow</span>(newScores) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb69-216"><a href="annex-i-compendium-of-r-scripts.html#cb69-216" aria-hidden="true" tabindex="-1"></a>    number_of_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(number_of_samples, trial)</span>
<span id="cb69-217"><a href="annex-i-compendium-of-r-scripts.html#cb69-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(</span>
<span id="cb69-218"><a href="annex-i-compendium-of-r-scripts.html#cb69-218" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(</span>
<span id="cb69-219"><a href="annex-i-compendium-of-r-scripts.html#cb69-219" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;N samples = &quot;</span>,</span>
<span id="cb69-220"><a href="annex-i-compendium-of-r-scripts.html#cb69-220" aria-hidden="true" tabindex="-1"></a>        trial,</span>
<span id="cb69-221"><a href="annex-i-compendium-of-r-scripts.html#cb69-221" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot; out of &quot;</span>,</span>
<span id="cb69-222"><a href="annex-i-compendium-of-r-scripts.html#cb69-222" aria-hidden="true" tabindex="-1"></a>        final.n,</span>
<span id="cb69-223"><a href="annex-i-compendium-of-r-scripts.html#cb69-223" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;; iteration = &quot;</span>,</span>
<span id="cb69-224"><a href="annex-i-compendium-of-r-scripts.html#cb69-224" aria-hidden="true" tabindex="-1"></a>        iteration,</span>
<span id="cb69-225"><a href="annex-i-compendium-of-r-scripts.html#cb69-225" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;; KL = &quot;</span>,</span>
<span id="cb69-226"><a href="annex-i-compendium-of-r-scripts.html#cb69-226" aria-hidden="true" tabindex="-1"></a>        klo,</span>
<span id="cb69-227"><a href="annex-i-compendium-of-r-scripts.html#cb69-227" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;; Proportion = &quot;</span>,</span>
<span id="cb69-228"><a href="annex-i-compendium-of-r-scripts.html#cb69-228" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(newScores<span class="sc">$</span>pip) <span class="sc">/</span> <span class="fu">nrow</span>(newScores) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb69-229"><a href="annex-i-compendium-of-r-scripts.html#cb69-229" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb69-230"><a href="annex-i-compendium-of-r-scripts.html#cb69-230" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-231"><a href="annex-i-compendium-of-r-scripts.html#cb69-231" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb69-232"><a href="annex-i-compendium-of-r-scripts.html#cb69-232" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-233"><a href="annex-i-compendium-of-r-scripts.html#cb69-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-234"><a href="annex-i-compendium-of-r-scripts.html#cb69-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-235"><a href="annex-i-compendium-of-r-scripts.html#cb69-235" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Plot covariate diversity as PCA scores ===================================</span></span>
<span id="cb69-236"><a href="annex-i-compendium-of-r-scripts.html#cb69-236" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb69-237"><a href="annex-i-compendium-of-r-scripts.html#cb69-237" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;PCA 1&quot;</span>,</span>
<span id="cb69-238"><a href="annex-i-compendium-of-r-scripts.html#cb69-238" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;PCA 2&quot;</span>,</span>
<span id="cb69-239"><a href="annex-i-compendium-of-r-scripts.html#cb69-239" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T)),</span>
<span id="cb69-240"><a href="annex-i-compendium-of-r-scripts.html#cb69-240" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T)),</span>
<span id="cb69-241"><a href="annex-i-compendium-of-r-scripts.html#cb69-241" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">&#39;black&#39;</span>,</span>
<span id="cb69-242"><a href="annex-i-compendium-of-r-scripts.html#cb69-242" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&#39;Environmental space plots on convex hull of soil samples&#39;</span>)</span>
<span id="cb69-243"><a href="annex-i-compendium-of-r-scripts.html#cb69-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-244"><a href="annex-i-compendium-of-r-scripts.html#cb69-244" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(pr_poly, <span class="at">col =</span> <span class="st">&#39;#99999990&#39;</span>)</span>
<span id="cb69-245"><a href="annex-i-compendium-of-r-scripts.html#cb69-245" aria-hidden="true" tabindex="-1"></a><span class="co"># # Plot points outside convex hull</span></span>
<span id="cb69-246"><a href="annex-i-compendium-of-r-scripts.html#cb69-246" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(newScores[<span class="fu">which</span>(newScores<span class="sc">$</span>pip <span class="sc">==</span> <span class="dv">0</span>), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb69-247"><a href="annex-i-compendium-of-r-scripts.html#cb69-247" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">&#39;red&#39;</span>,</span>
<span id="cb69-248"><a href="annex-i-compendium-of-r-scripts.html#cb69-248" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="dv">12</span>,</span>
<span id="cb69-249"><a href="annex-i-compendium-of-r-scripts.html#cb69-249" aria-hidden="true" tabindex="-1"></a>       <span class="at">cex =</span> <span class="dv">1</span>)</span>
<span id="cb69-250"><a href="annex-i-compendium-of-r-scripts.html#cb69-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-251"><a href="annex-i-compendium-of-r-scripts.html#cb69-251" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - KL divergence and % coincidence for growing N samples =============</span></span>
<span id="cb69-252"><a href="annex-i-compendium-of-r-scripts.html#cb69-252" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge data from number of samples, KL divergence and % coincidence</span></span>
<span id="cb69-253"><a href="annex-i-compendium-of-r-scripts.html#cb69-253" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(number_of_samples, klo_samples, prop_explained)</span>
<span id="cb69-254"><a href="annex-i-compendium-of-r-scripts.html#cb69-254" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(results) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;N&quot;</span>, <span class="st">&quot;KL&quot;</span>, <span class="st">&quot;Perc&quot;</span>)</span>
<span id="cb69-255"><a href="annex-i-compendium-of-r-scripts.html#cb69-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-256"><a href="annex-i-compendium-of-r-scripts.html#cb69-256" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean results by N size</span></span>
<span id="cb69-257"><a href="annex-i-compendium-of-r-scripts.html#cb69-257" aria-hidden="true" tabindex="-1"></a>mean_result <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb69-258"><a href="annex-i-compendium-of-r-scripts.html#cb69-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(N) <span class="sc">%&gt;%</span></span>
<span id="cb69-259"><a href="annex-i-compendium-of-r-scripts.html#cb69-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_all</span>(mean)</span>
<span id="cb69-260"><a href="annex-i-compendium-of-r-scripts.html#cb69-260" aria-hidden="true" tabindex="-1"></a>mean_result</span>
<span id="cb69-261"><a href="annex-i-compendium-of-r-scripts.html#cb69-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-262"><a href="annex-i-compendium-of-r-scripts.html#cb69-262" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot dispersion on KL and % by N</span></span>
<span id="cb69-263"><a href="annex-i-compendium-of-r-scripts.html#cb69-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-264"><a href="annex-i-compendium-of-r-scripts.html#cb69-264" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb69-265"><a href="annex-i-compendium-of-r-scripts.html#cb69-265" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(</span>
<span id="cb69-266"><a href="annex-i-compendium-of-r-scripts.html#cb69-266" aria-hidden="true" tabindex="-1"></a>  Perc <span class="sc">~</span> N,</span>
<span id="cb69-267"><a href="annex-i-compendium-of-r-scripts.html#cb69-267" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> results,</span>
<span id="cb69-268"><a href="annex-i-compendium-of-r-scripts.html#cb69-268" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>),</span>
<span id="cb69-269"><a href="annex-i-compendium-of-r-scripts.html#cb69-269" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;% coincidence&quot;</span></span>
<span id="cb69-270"><a href="annex-i-compendium-of-r-scripts.html#cb69-270" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-271"><a href="annex-i-compendium-of-r-scripts.html#cb69-271" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">&quot;KL divergence&quot;</span>, <span class="at">side =</span> <span class="dv">4</span>, <span class="at">line =</span> <span class="dv">3</span>)</span>
<span id="cb69-272"><a href="annex-i-compendium-of-r-scripts.html#cb69-272" aria-hidden="true" tabindex="-1"></a><span class="co"># Add new plot</span></span>
<span id="cb69-273"><a href="annex-i-compendium-of-r-scripts.html#cb69-273" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">new =</span> <span class="cn">TRUE</span>, <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb69-274"><a href="annex-i-compendium-of-r-scripts.html#cb69-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Box plot</span></span>
<span id="cb69-275"><a href="annex-i-compendium-of-r-scripts.html#cb69-275" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(</span>
<span id="cb69-276"><a href="annex-i-compendium-of-r-scripts.html#cb69-276" aria-hidden="true" tabindex="-1"></a>  KL <span class="sc">~</span> N,</span>
<span id="cb69-277"><a href="annex-i-compendium-of-r-scripts.html#cb69-277" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> results,</span>
<span id="cb69-278"><a href="annex-i-compendium-of-r-scripts.html#cb69-278" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb69-279"><a href="annex-i-compendium-of-r-scripts.html#cb69-279" aria-hidden="true" tabindex="-1"></a>  <span class="at">outline =</span> <span class="cn">FALSE</span>,</span>
<span id="cb69-280"><a href="annex-i-compendium-of-r-scripts.html#cb69-280" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="fl">0.8</span>, <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>),</span>
<span id="cb69-281"><a href="annex-i-compendium-of-r-scripts.html#cb69-281" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb69-282"><a href="annex-i-compendium-of-r-scripts.html#cb69-282" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-283"><a href="annex-i-compendium-of-r-scripts.html#cb69-283" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(</span>
<span id="cb69-284"><a href="annex-i-compendium-of-r-scripts.html#cb69-284" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>,</span>
<span id="cb69-285"><a href="annex-i-compendium-of-r-scripts.html#cb69-285" aria-hidden="true" tabindex="-1"></a>  <span class="at">at =</span> <span class="fu">seq</span>(<span class="fl">0.02</span>, <span class="fl">0.36</span>, <span class="at">by =</span> .<span class="dv">06</span>),</span>
<span id="cb69-286"><a href="annex-i-compendium-of-r-scripts.html#cb69-286" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="fu">seq</span>(<span class="fl">0.02</span>, <span class="fl">0.36</span>, <span class="at">by =</span> .<span class="dv">06</span>),</span>
<span id="cb69-287"><a href="annex-i-compendium-of-r-scripts.html#cb69-287" aria-hidden="true" tabindex="-1"></a>  <span class="at">las =</span> <span class="dv">3</span></span>
<span id="cb69-288"><a href="annex-i-compendium-of-r-scripts.html#cb69-288" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-289"><a href="annex-i-compendium-of-r-scripts.html#cb69-289" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw legend</span></span>
<span id="cb69-290"><a href="annex-i-compendium-of-r-scripts.html#cb69-290" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">xpd=</span><span class="cn">TRUE</span>)</span>
<span id="cb69-291"><a href="annex-i-compendium-of-r-scripts.html#cb69-291" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;top&quot;</span>, <span class="at">inset=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span>.<span class="dv">15</span>) ,<span class="fu">c</span>(<span class="st">&quot;% coincidence&quot;</span>, <span class="st">&quot;KL divergence&quot;</span>), <span class="at">horiz=</span>T,<span class="at">cex=</span>.<span class="dv">9</span>,</span>
<span id="cb69-292"><a href="annex-i-compendium-of-r-scripts.html#cb69-292" aria-hidden="true" tabindex="-1"></a>       <span class="at">box.lty=</span><span class="dv">0</span>,<span class="at">fill =</span> <span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>), <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="fl">0.8</span>, <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)))</span>
<span id="cb69-293"><a href="annex-i-compendium-of-r-scripts.html#cb69-293" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">xpd=</span><span class="cn">FALSE</span>)</span>
<span id="cb69-294"><a href="annex-i-compendium-of-r-scripts.html#cb69-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-295"><a href="annex-i-compendium-of-r-scripts.html#cb69-295" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Model KL divergence ======================================================</span></span>
<span id="cb69-296"><a href="annex-i-compendium-of-r-scripts.html#cb69-296" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an exponential decay function of the KL divergence</span></span>
<span id="cb69-297"><a href="annex-i-compendium-of-r-scripts.html#cb69-297" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> mean_result<span class="sc">$</span>N</span>
<span id="cb69-298"><a href="annex-i-compendium-of-r-scripts.html#cb69-298" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> (mean_result<span class="sc">$</span>KL <span class="sc">-</span> <span class="fu">min</span>(mean_result<span class="sc">$</span>KL)) <span class="sc">/</span> (<span class="fu">max</span>(mean_result<span class="sc">$</span>KL) <span class="sc">-</span> <span class="fu">min</span>(mean_result<span class="sc">$</span>KL)) <span class="co">#KL</span></span>
<span id="cb69-299"><a href="annex-i-compendium-of-r-scripts.html#cb69-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-300"><a href="annex-i-compendium-of-r-scripts.html#cb69-300" aria-hidden="true" tabindex="-1"></a><span class="co"># Parametrize Exponential decay function</span></span>
<span id="cb69-301"><a href="annex-i-compendium-of-r-scripts.html#cb69-301" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span>  <span class="fu">list</span>()     <span class="co"># Initialize an empty list for the starting values</span></span>
<span id="cb69-302"><a href="annex-i-compendium-of-r-scripts.html#cb69-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-303"><a href="annex-i-compendium-of-r-scripts.html#cb69-303" aria-hidden="true" tabindex="-1"></a><span class="co">#fit function</span></span>
<span id="cb69-304"><a href="annex-i-compendium-of-r-scripts.html#cb69-304" aria-hidden="true" tabindex="-1"></a>k <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb69-305"><a href="annex-i-compendium-of-r-scripts.html#cb69-305" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb69-306"><a href="annex-i-compendium-of-r-scripts.html#cb69-306" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb69-307"><a href="annex-i-compendium-of-r-scripts.html#cb69-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-308"><a href="annex-i-compendium-of-r-scripts.html#cb69-308" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span></span>
<span id="cb69-309"><a href="annex-i-compendium-of-r-scripts.html#cb69-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nls</span>(</span>
<span id="cb69-310"><a href="annex-i-compendium-of-r-scripts.html#cb69-310" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> k <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>b1 <span class="sc">*</span> x) <span class="sc">+</span> b0,</span>
<span id="cb69-311"><a href="annex-i-compendium-of-r-scripts.html#cb69-311" aria-hidden="true" tabindex="-1"></a>    <span class="at">start =</span> <span class="fu">list</span>(<span class="at">k =</span> k, <span class="at">b0 =</span> b0, <span class="at">b1 =</span> b1),</span>
<span id="cb69-312"><a href="annex-i-compendium-of-r-scripts.html#cb69-312" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxiter =</span> <span class="dv">500</span>),</span>
<span id="cb69-313"><a href="annex-i-compendium-of-r-scripts.html#cb69-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">trace =</span> T</span>
<span id="cb69-314"><a href="annex-i-compendium-of-r-scripts.html#cb69-314" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-315"><a href="annex-i-compendium-of-r-scripts.html#cb69-315" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span>
<span id="cb69-316"><a href="annex-i-compendium-of-r-scripts.html#cb69-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-317"><a href="annex-i-compendium-of-r-scripts.html#cb69-317" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot fit</span></span>
<span id="cb69-318"><a href="annex-i-compendium-of-r-scripts.html#cb69-318" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, final.n, <span class="dv">1</span>)</span>
<span id="cb69-319"><a href="annex-i-compendium-of-r-scripts.html#cb69-319" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, y)</span>
<span id="cb69-320"><a href="annex-i-compendium-of-r-scripts.html#cb69-320" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(xx, <span class="fu">predict</span>(fit1, <span class="fu">list</span>(<span class="at">x =</span> xx)))</span>
<span id="cb69-321"><a href="annex-i-compendium-of-r-scripts.html#cb69-321" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict with vfit function</span></span>
<span id="cb69-322"><a href="annex-i-compendium-of-r-scripts.html#cb69-322" aria-hidden="true" tabindex="-1"></a>jj <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit1, <span class="fu">list</span>(<span class="at">x =</span> xx))</span>
<span id="cb69-323"><a href="annex-i-compendium-of-r-scripts.html#cb69-323" aria-hidden="true" tabindex="-1"></a>normalized <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> (jj <span class="sc">-</span> <span class="fu">min</span>(jj)) <span class="sc">/</span> (<span class="fu">max</span>(jj) <span class="sc">-</span> <span class="fu">min</span>(jj))</span>
<span id="cb69-324"><a href="annex-i-compendium-of-r-scripts.html#cb69-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-325"><a href="annex-i-compendium-of-r-scripts.html#cb69-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-326"><a href="annex-i-compendium-of-r-scripts.html#cb69-326" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Determine the minimum sample size to account for 95% of cumulative probability of the covariate diversity ====</span></span>
<span id="cb69-327"><a href="annex-i-compendium-of-r-scripts.html#cb69-327" aria-hidden="true" tabindex="-1"></a>minimum_n <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">which</span>(normalized <span class="sc">&lt;</span> <span class="fl">0.95</span>)) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb69-328"><a href="annex-i-compendium-of-r-scripts.html#cb69-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-329"><a href="annex-i-compendium-of-r-scripts.html#cb69-329" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot cdf and minimum sampling point</span></span>
<span id="cb69-330"><a href="annex-i-compendium-of-r-scripts.html#cb69-330" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> xx</span>
<span id="cb69-331"><a href="annex-i-compendium-of-r-scripts.html#cb69-331" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> normalized</span>
<span id="cb69-332"><a href="annex-i-compendium-of-r-scripts.html#cb69-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-333"><a href="annex-i-compendium-of-r-scripts.html#cb69-333" aria-hidden="true" tabindex="-1"></a>mydata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x, y)</span>
<span id="cb69-334"><a href="annex-i-compendium-of-r-scripts.html#cb69-334" aria-hidden="true" tabindex="-1"></a>opti <span class="ot">&lt;-</span> mydata[mydata<span class="sc">$</span>x <span class="sc">==</span> minimum_n, ]</span>
<span id="cb69-335"><a href="annex-i-compendium-of-r-scripts.html#cb69-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-336"><a href="annex-i-compendium-of-r-scripts.html#cb69-336" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ly</span>(</span>
<span id="cb69-337"><a href="annex-i-compendium-of-r-scripts.html#cb69-337" aria-hidden="true" tabindex="-1"></a>  mydata,</span>
<span id="cb69-338"><a href="annex-i-compendium-of-r-scripts.html#cb69-338" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="sc">~</span> x,</span>
<span id="cb69-339"><a href="annex-i-compendium-of-r-scripts.html#cb69-339" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="sc">~</span> normalized,</span>
<span id="cb69-340"><a href="annex-i-compendium-of-r-scripts.html#cb69-340" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">&quot;lines+markers&quot;</span>,</span>
<span id="cb69-341"><a href="annex-i-compendium-of-r-scripts.html#cb69-341" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;scatter&quot;</span>,</span>
<span id="cb69-342"><a href="annex-i-compendium-of-r-scripts.html#cb69-342" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">&quot;CDF (1–KL divergence)&quot;</span></span>
<span id="cb69-343"><a href="annex-i-compendium-of-r-scripts.html#cb69-343" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb69-344"><a href="annex-i-compendium-of-r-scripts.html#cb69-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_trace</span>(</span>
<span id="cb69-345"><a href="annex-i-compendium-of-r-scripts.html#cb69-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">~</span> x,</span>
<span id="cb69-346"><a href="annex-i-compendium-of-r-scripts.html#cb69-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="sc">~</span> jj,</span>
<span id="cb69-347"><a href="annex-i-compendium-of-r-scripts.html#cb69-347" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">&quot;lines+markers&quot;</span>,</span>
<span id="cb69-348"><a href="annex-i-compendium-of-r-scripts.html#cb69-348" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">&quot;scatter&quot;</span>,</span>
<span id="cb69-349"><a href="annex-i-compendium-of-r-scripts.html#cb69-349" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxis =</span> <span class="st">&quot;y2&quot;</span>,</span>
<span id="cb69-350"><a href="annex-i-compendium-of-r-scripts.html#cb69-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;KL divergence&quot;</span></span>
<span id="cb69-351"><a href="annex-i-compendium-of-r-scripts.html#cb69-351" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">%&gt;%</span></span>
<span id="cb69-352"><a href="annex-i-compendium-of-r-scripts.html#cb69-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_trace</span>(</span>
<span id="cb69-353"><a href="annex-i-compendium-of-r-scripts.html#cb69-353" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">~</span> opti<span class="sc">$</span>x,</span>
<span id="cb69-354"><a href="annex-i-compendium-of-r-scripts.html#cb69-354" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="sc">~</span> opti<span class="sc">$</span>y,</span>
<span id="cb69-355"><a href="annex-i-compendium-of-r-scripts.html#cb69-355" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxis =</span> <span class="st">&quot;y&quot;</span>,</span>
<span id="cb69-356"><a href="annex-i-compendium-of-r-scripts.html#cb69-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">&quot;markers&quot;</span>,</span>
<span id="cb69-357"><a href="annex-i-compendium-of-r-scripts.html#cb69-357" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;Minimum N&quot;</span>,</span>
<span id="cb69-358"><a href="annex-i-compendium-of-r-scripts.html#cb69-358" aria-hidden="true" tabindex="-1"></a>    <span class="at">marker =</span> <span class="fu">list</span>(</span>
<span id="cb69-359"><a href="annex-i-compendium-of-r-scripts.html#cb69-359" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">8</span>,</span>
<span id="cb69-360"><a href="annex-i-compendium-of-r-scripts.html#cb69-360" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&#39;#d62728&#39;</span>,</span>
<span id="cb69-361"><a href="annex-i-compendium-of-r-scripts.html#cb69-361" aria-hidden="true" tabindex="-1"></a>      <span class="at">line =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">&#39;black&#39;</span>, <span class="at">width =</span> <span class="dv">1</span>)</span>
<span id="cb69-362"><a href="annex-i-compendium-of-r-scripts.html#cb69-362" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-363"><a href="annex-i-compendium-of-r-scripts.html#cb69-363" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb69-364"><a href="annex-i-compendium-of-r-scripts.html#cb69-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(</span>
<span id="cb69-365"><a href="annex-i-compendium-of-r-scripts.html#cb69-365" aria-hidden="true" tabindex="-1"></a>    <span class="at">xaxis =</span> <span class="fu">list</span>(</span>
<span id="cb69-366"><a href="annex-i-compendium-of-r-scripts.html#cb69-366" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;N&quot;</span>,</span>
<span id="cb69-367"><a href="annex-i-compendium-of-r-scripts.html#cb69-367" aria-hidden="true" tabindex="-1"></a>      <span class="at">showgrid =</span> T,</span>
<span id="cb69-368"><a href="annex-i-compendium-of-r-scripts.html#cb69-368" aria-hidden="true" tabindex="-1"></a>      <span class="at">dtick =</span> <span class="dv">50</span>,</span>
<span id="cb69-369"><a href="annex-i-compendium-of-r-scripts.html#cb69-369" aria-hidden="true" tabindex="-1"></a>      <span class="at">tickfont =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb69-370"><a href="annex-i-compendium-of-r-scripts.html#cb69-370" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb69-371"><a href="annex-i-compendium-of-r-scripts.html#cb69-371" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">&quot;1–KL divergence (% CDF)&quot;</span>, <span class="at">showgrid =</span> F),</span>
<span id="cb69-372"><a href="annex-i-compendium-of-r-scripts.html#cb69-372" aria-hidden="true" tabindex="-1"></a>    <span class="at">yaxis2 =</span> <span class="fu">list</span>(</span>
<span id="cb69-373"><a href="annex-i-compendium-of-r-scripts.html#cb69-373" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;KL divergence&quot;</span>,</span>
<span id="cb69-374"><a href="annex-i-compendium-of-r-scripts.html#cb69-374" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlaying =</span> <span class="st">&quot;y&quot;</span>,</span>
<span id="cb69-375"><a href="annex-i-compendium-of-r-scripts.html#cb69-375" aria-hidden="true" tabindex="-1"></a>      <span class="at">side =</span> <span class="st">&quot;right&quot;</span></span>
<span id="cb69-376"><a href="annex-i-compendium-of-r-scripts.html#cb69-376" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb69-377"><a href="annex-i-compendium-of-r-scripts.html#cb69-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend =</span> <span class="fu">list</span>(</span>
<span id="cb69-378"><a href="annex-i-compendium-of-r-scripts.html#cb69-378" aria-hidden="true" tabindex="-1"></a>      <span class="at">orientation =</span> <span class="st">&quot;h&quot;</span>,</span>
<span id="cb69-379"><a href="annex-i-compendium-of-r-scripts.html#cb69-379" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fl">1.2</span>,</span>
<span id="cb69-380"><a href="annex-i-compendium-of-r-scripts.html#cb69-380" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fl">0.1</span>,</span>
<span id="cb69-381"><a href="annex-i-compendium-of-r-scripts.html#cb69-381" aria-hidden="true" tabindex="-1"></a>      <span class="at">traceorder =</span> <span class="st">&quot;normal&quot;</span></span>
<span id="cb69-382"><a href="annex-i-compendium-of-r-scripts.html#cb69-382" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb69-383"><a href="annex-i-compendium-of-r-scripts.html#cb69-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">margin =</span> <span class="fu">list</span>(</span>
<span id="cb69-384"><a href="annex-i-compendium-of-r-scripts.html#cb69-384" aria-hidden="true" tabindex="-1"></a>      <span class="at">t =</span> <span class="dv">50</span>,</span>
<span id="cb69-385"><a href="annex-i-compendium-of-r-scripts.html#cb69-385" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="dv">50</span>,</span>
<span id="cb69-386"><a href="annex-i-compendium-of-r-scripts.html#cb69-386" aria-hidden="true" tabindex="-1"></a>      <span class="at">r =</span> <span class="dv">100</span>,</span>
<span id="cb69-387"><a href="annex-i-compendium-of-r-scripts.html#cb69-387" aria-hidden="true" tabindex="-1"></a>      <span class="at">l =</span> <span class="dv">80</span></span>
<span id="cb69-388"><a href="annex-i-compendium-of-r-scripts.html#cb69-388" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb69-389"><a href="annex-i-compendium-of-r-scripts.html#cb69-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">hovermode =</span> <span class="st">&#39;x&#39;</span></span>
<span id="cb69-390"><a href="annex-i-compendium-of-r-scripts.html#cb69-390" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">%&gt;%</span></span>
<span id="cb69-391"><a href="annex-i-compendium-of-r-scripts.html#cb69-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">config</span>(<span class="at">displayModeBar =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-392"><a href="annex-i-compendium-of-r-scripts.html#cb69-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-393"><a href="annex-i-compendium-of-r-scripts.html#cb69-393" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Determine the optimal iteration according to the minimum N size ==========</span></span>
<span id="cb69-394"><a href="annex-i-compendium-of-r-scripts.html#cb69-394" aria-hidden="true" tabindex="-1"></a>optimal_iteration <span class="ot">&lt;-</span> results[<span class="fu">which</span>(<span class="fu">abs</span>(results<span class="sc">$</span>N <span class="sc">-</span> minimum_n) <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">abs</span>(results<span class="sc">$</span>N <span class="sc">-</span> minimum_n))), ] <span class="sc">%&gt;%</span></span>
<span id="cb69-395"><a href="annex-i-compendium-of-r-scripts.html#cb69-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">IDX =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb69-396"><a href="annex-i-compendium-of-r-scripts.html#cb69-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Perc <span class="sc">==</span> <span class="fu">max</span>(Perc))</span>
<span id="cb69-397"><a href="annex-i-compendium-of-r-scripts.html#cb69-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-398"><a href="annex-i-compendium-of-r-scripts.html#cb69-398" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot minimum points from best iteration ==================================</span></span>
<span id="cb69-399"><a href="annex-i-compendium-of-r-scripts.html#cb69-399" aria-hidden="true" tabindex="-1"></a>N_final <span class="ot">&lt;-</span> samples_storage[<span class="fu">paste0</span>(<span class="st">&quot;N&quot;</span>, optimal_iteration<span class="sc">$</span>N, <span class="st">&quot;_&quot;</span>, optimal_iteration<span class="sc">$</span>IDX)][[<span class="dv">1</span>]]</span>
<span id="cb69-400"><a href="annex-i-compendium-of-r-scripts.html#cb69-400" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]])</span>
<span id="cb69-401"><a href="annex-i-compendium-of-r-scripts.html#cb69-401" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(N_final,<span class="at">add=</span>T,<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb69-402"><a href="annex-i-compendium-of-r-scripts.html#cb69-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-403"><a href="annex-i-compendium-of-r-scripts.html#cb69-403" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="re">END</span></span></code></pre></div>
</div>
<div id="script-5-stratified-sampling-on-vector-and-raster-data" class="section level2 unnumbered hasAnchor">
<h2>Script 5: Stratified sampling on vector and raster data<a href="annex-i-compendium-of-r-scripts.html#script-5-stratified-sampling-on-vector-and-raster-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This script uses soil and landcover classes to define polygon ‘strata’ for an area weighted stratified sampling design.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="annex-i-compendium-of-r-scripts.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb70-2"><a href="annex-i-compendium-of-r-scripts.html#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb70-3"><a href="annex-i-compendium-of-r-scripts.html#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb70-4"><a href="annex-i-compendium-of-r-scripts.html#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified Sampling on &#39;soil-landuse&#39; strata</span></span>
<span id="cb70-5"><a href="annex-i-compendium-of-r-scripts.html#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb70-6"><a href="annex-i-compendium-of-r-scripts.html#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb70-7"><a href="annex-i-compendium-of-r-scripts.html#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co">#          Marcos.Angelini@fao.org</span></span>
<span id="cb70-8"><a href="annex-i-compendium-of-r-scripts.html#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb70-9"><a href="annex-i-compendium-of-r-scripts.html#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="annex-i-compendium-of-r-scripts.html#cb70-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empty environment and cache </span></span>
<span id="cb70-11"><a href="annex-i-compendium-of-r-scripts.html#cb70-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb70-12"><a href="annex-i-compendium-of-r-scripts.html#cb70-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb70-13"><a href="annex-i-compendium-of-r-scripts.html#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="annex-i-compendium-of-r-scripts.html#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script =======================================================</span></span>
<span id="cb70-15"><a href="annex-i-compendium-of-r-scripts.html#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="co"># The goal of this script is to perform random and regular stratified</span></span>
<span id="cb70-16"><a href="annex-i-compendium-of-r-scripts.html#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="co"># soil sampling designs using soil/landcover classes as &#39;strata&#39;</span></span>
<span id="cb70-17"><a href="annex-i-compendium-of-r-scripts.html#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="co"># The distribution of samples on the strata is based on a</span></span>
<span id="cb70-18"><a href="annex-i-compendium-of-r-scripts.html#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co"># weighted area distribution with the requirement of at least 2 sampling points</span></span>
<span id="cb70-19"><a href="annex-i-compendium-of-r-scripts.html#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="co"># by strata. Small polygons (&lt; 100 has) are eliminated from calculations.</span></span>
<span id="cb70-20"><a href="annex-i-compendium-of-r-scripts.html#cb70-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Only &#39;strata&#39; classes prone to be samples are included in the analyses.</span></span>
<span id="cb70-21"><a href="annex-i-compendium-of-r-scripts.html#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="co"># The final sample data includes &#39;target&#39; points - i.e. primary sampling points,</span></span>
<span id="cb70-22"><a href="annex-i-compendium-of-r-scripts.html#cb70-22" aria-hidden="true" tabindex="-1"></a><span class="co"># and &#39;replacement&#39; points - i.e. points to be used as replacements in case</span></span>
<span id="cb70-23"><a href="annex-i-compendium-of-r-scripts.html#cb70-23" aria-hidden="true" tabindex="-1"></a><span class="co"># that the corresponding &#39;target&#39; point cannot be sampled for any reason.</span></span>
<span id="cb70-24"><a href="annex-i-compendium-of-r-scripts.html#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb70-25"><a href="annex-i-compendium-of-r-scripts.html#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load packages</span></span>
<span id="cb70-26"><a href="annex-i-compendium-of-r-scripts.html#cb70-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb70-27"><a href="annex-i-compendium-of-r-scripts.html#cb70-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import data </span></span>
<span id="cb70-28"><a href="annex-i-compendium-of-r-scripts.html#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Delineate soil strata</span></span>
<span id="cb70-29"><a href="annex-i-compendium-of-r-scripts.html#cb70-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Delineate land-use strata </span></span>
<span id="cb70-30"><a href="annex-i-compendium-of-r-scripts.html#cb70-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Create sampling strata</span></span>
<span id="cb70-31"><a href="annex-i-compendium-of-r-scripts.html#cb70-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Accommodate strata to requirements</span></span>
<span id="cb70-32"><a href="annex-i-compendium-of-r-scripts.html#cb70-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Plot strata</span></span>
<span id="cb70-33"><a href="annex-i-compendium-of-r-scripts.html#cb70-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Stratified random sampling</span></span>
<span id="cb70-34"><a href="annex-i-compendium-of-r-scripts.html#cb70-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot points over strata</span></span>
<span id="cb70-35"><a href="annex-i-compendium-of-r-scripts.html#cb70-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 10 - Calculate replacement areas for points</span></span>
<span id="cb70-36"><a href="annex-i-compendium-of-r-scripts.html#cb70-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 11 - Stratified regular sampling</span></span>
<span id="cb70-37"><a href="annex-i-compendium-of-r-scripts.html#cb70-37" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb70-38"><a href="annex-i-compendium-of-r-scripts.html#cb70-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-39"><a href="annex-i-compendium-of-r-scripts.html#cb70-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-40"><a href="annex-i-compendium-of-r-scripts.html#cb70-40" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load packages =================================</span></span>
<span id="cb70-41"><a href="annex-i-compendium-of-r-scripts.html#cb70-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-42"><a href="annex-i-compendium-of-r-scripts.html#cb70-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages as a vector objects</span></span>
<span id="cb70-43"><a href="annex-i-compendium-of-r-scripts.html#cb70-43" aria-hidden="true" tabindex="-1"></a>    packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sf&quot;</span>, <span class="st">&quot;terra&quot;</span>, <span class="st">&quot;tidyverse&quot;</span>, <span class="st">&quot;rmapshaper&quot;</span>,</span>
<span id="cb70-44"><a href="annex-i-compendium-of-r-scripts.html#cb70-44" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;units&quot;</span>,<span class="st">&quot;plyr&quot;</span>, <span class="st">&quot;mapview&quot;</span>, <span class="st">&quot;leaflet&quot;</span>)</span>
<span id="cb70-45"><a href="annex-i-compendium-of-r-scripts.html#cb70-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>) <span class="co"># Load packages</span></span>
<span id="cb70-46"><a href="annex-i-compendium-of-r-scripts.html#cb70-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(packages) <span class="co"># Remove object to save memory space </span></span>
<span id="cb70-47"><a href="annex-i-compendium-of-r-scripts.html#cb70-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-48"><a href="annex-i-compendium-of-r-scripts.html#cb70-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb70-49"><a href="annex-i-compendium-of-r-scripts.html#cb70-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb70-50"><a href="annex-i-compendium-of-r-scripts.html#cb70-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-51"><a href="annex-i-compendium-of-r-scripts.html#cb70-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-52"><a href="annex-i-compendium-of-r-scripts.html#cb70-52" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb70-53"><a href="annex-i-compendium-of-r-scripts.html#cb70-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Path to rasters</span></span>
<span id="cb70-54"><a href="annex-i-compendium-of-r-scripts.html#cb70-54" aria-hidden="true" tabindex="-1"></a>    raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters&quot;</span></span>
<span id="cb70-55"><a href="annex-i-compendium-of-r-scripts.html#cb70-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Path to shapes</span></span>
<span id="cb70-56"><a href="annex-i-compendium-of-r-scripts.html#cb70-56" aria-hidden="true" tabindex="-1"></a>    shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes&quot;</span></span>
<span id="cb70-57"><a href="annex-i-compendium-of-r-scripts.html#cb70-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Path to results</span></span>
<span id="cb70-58"><a href="annex-i-compendium-of-r-scripts.html#cb70-58" aria-hidden="true" tabindex="-1"></a>    results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb70-59"><a href="annex-i-compendium-of-r-scripts.html#cb70-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Path to additional data</span></span>
<span id="cb70-60"><a href="annex-i-compendium-of-r-scripts.html#cb70-60" aria-hidden="true" tabindex="-1"></a>    other.path <span class="ot">&lt;-</span> <span class="st">&quot;data/other/&quot;</span></span>
<span id="cb70-61"><a href="annex-i-compendium-of-r-scripts.html#cb70-61" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="dv">242</span></span>
<span id="cb70-62"><a href="annex-i-compendium-of-r-scripts.html#cb70-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-63"><a href="annex-i-compendium-of-r-scripts.html#cb70-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-64"><a href="annex-i-compendium-of-r-scripts.html#cb70-64" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Import data ====================================================</span></span>
<span id="cb70-65"><a href="annex-i-compendium-of-r-scripts.html#cb70-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load soil data</span></span>
<span id="cb70-66"><a href="annex-i-compendium-of-r-scripts.html#cb70-66" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/soils.shp&quot;</span>),<span class="at">promote_to_multi =</span> <span class="cn">FALSE</span>)  </span>
<span id="cb70-67"><a href="annex-i-compendium-of-r-scripts.html#cb70-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load Landcover data</span></span>
<span id="cb70-68"><a href="annex-i-compendium-of-r-scripts.html#cb70-68" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/landcover.shp&quot;</span>))</span>
<span id="cb70-69"><a href="annex-i-compendium-of-r-scripts.html#cb70-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-70"><a href="annex-i-compendium-of-r-scripts.html#cb70-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define a bounding area (optional).</span></span>
<span id="cb70-71"><a href="annex-i-compendium-of-r-scripts.html#cb70-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If BOUNDING = TRUE, then a bounding–area shapefile (bb) must be specified</span></span>
<span id="cb70-72"><a href="annex-i-compendium-of-r-scripts.html#cb70-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and the line in the code below must be uncommented</span></span>
<span id="cb70-73"><a href="annex-i-compendium-of-r-scripts.html#cb70-73" aria-hidden="true" tabindex="-1"></a>    BOUNDING <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb70-74"><a href="annex-i-compendium-of-r-scripts.html#cb70-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">#bb &lt;- st_read(paste0(shp.path,&quot;/your_bounding_area.shp&quot;))</span></span>
<span id="cb70-75"><a href="annex-i-compendium-of-r-scripts.html#cb70-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-76"><a href="annex-i-compendium-of-r-scripts.html#cb70-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute replacement areas (optional).</span></span>
<span id="cb70-77"><a href="annex-i-compendium-of-r-scripts.html#cb70-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If REPLACEMENT = TRUE, then replacement areas are calculated around a </span></span>
<span id="cb70-78"><a href="annex-i-compendium-of-r-scripts.html#cb70-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># specified buffer distance from target points within the same stratum class</span></span>
<span id="cb70-79"><a href="annex-i-compendium-of-r-scripts.html#cb70-79" aria-hidden="true" tabindex="-1"></a>    REPLACEMENT <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb70-80"><a href="annex-i-compendium-of-r-scripts.html#cb70-80" aria-hidden="true" tabindex="-1"></a>    distance.buffer <span class="ot">=</span> <span class="dv">500</span> <span class="co"># Distance must be adjusted to the coordinate system</span></span>
<span id="cb70-81"><a href="annex-i-compendium-of-r-scripts.html#cb70-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">#bb &lt;- st_read(paste0(shp.path,&quot;/your_bounding_area.shp&quot;))</span></span>
<span id="cb70-82"><a href="annex-i-compendium-of-r-scripts.html#cb70-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-83"><a href="annex-i-compendium-of-r-scripts.html#cb70-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-84"><a href="annex-i-compendium-of-r-scripts.html#cb70-84" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Delineate soil strata =====================================================</span></span>
<span id="cb70-85"><a href="annex-i-compendium-of-r-scripts.html#cb70-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-86"><a href="annex-i-compendium-of-r-scripts.html#cb70-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clip soil data  by bounding area if defined</span></span>
<span id="cb70-87"><a href="annex-i-compendium-of-r-scripts.html#cb70-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (BOUNDING) {</span>
<span id="cb70-88"><a href="annex-i-compendium-of-r-scripts.html#cb70-88" aria-hidden="true" tabindex="-1"></a>      soil <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(soil, bb)</span>
<span id="cb70-89"><a href="annex-i-compendium-of-r-scripts.html#cb70-89" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb70-90"><a href="annex-i-compendium-of-r-scripts.html#cb70-90" aria-hidden="true" tabindex="-1"></a>      soil <span class="ot">&lt;-</span> soil</span>
<span id="cb70-91"><a href="annex-i-compendium-of-r-scripts.html#cb70-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-92"><a href="annex-i-compendium-of-r-scripts.html#cb70-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check geometry</span></span>
<span id="cb70-93"><a href="annex-i-compendium-of-r-scripts.html#cb70-93" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(soil)</span>
<span id="cb70-94"><a href="annex-i-compendium-of-r-scripts.html#cb70-94" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(soil, <span class="st">&quot;MULTIPOLYGON&quot;</span>)</span>
<span id="cb70-95"><a href="annex-i-compendium-of-r-scripts.html#cb70-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Aggregate information by reference soil group (SRG)</span></span>
<span id="cb70-96"><a href="annex-i-compendium-of-r-scripts.html#cb70-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">#unique(soil$RSG)</span></span>
<span id="cb70-97"><a href="annex-i-compendium-of-r-scripts.html#cb70-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove NAs (water bodies are deleted)</span></span>
<span id="cb70-98"><a href="annex-i-compendium-of-r-scripts.html#cb70-98" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> soil[<span class="sc">!</span><span class="fu">is.na</span>(soil<span class="sc">$</span>RSG),]</span>
<span id="cb70-99"><a href="annex-i-compendium-of-r-scripts.html#cb70-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">#unique(soil$RSG)</span></span>
<span id="cb70-100"><a href="annex-i-compendium-of-r-scripts.html#cb70-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dissolve polygons by reference soil group</span></span>
<span id="cb70-101"><a href="annex-i-compendium-of-r-scripts.html#cb70-101" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> soil <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(RSG) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">summarize</span>() </span>
<span id="cb70-102"><a href="annex-i-compendium-of-r-scripts.html#cb70-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write soil strata to disk</span></span>
<span id="cb70-103"><a href="annex-i-compendium-of-r-scripts.html#cb70-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(soil, <span class="fu">paste0</span>(results.path,<span class="st">&quot;soil_classes.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-104"><a href="annex-i-compendium-of-r-scripts.html#cb70-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-105"><a href="annex-i-compendium-of-r-scripts.html#cb70-105" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Plot aggregated soil classes</span></span>
<span id="cb70-106"><a href="annex-i-compendium-of-r-scripts.html#cb70-106" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="dv">8</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-107"><a href="annex-i-compendium-of-r-scripts.html#cb70-107" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb70-108"><a href="annex-i-compendium-of-r-scripts.html#cb70-108" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil[<span class="st">&quot;RSG&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;soils&quot;</span>, <span class="at">map=</span>map)</span>
<span id="cb70-109"><a href="annex-i-compendium-of-r-scripts.html#cb70-109" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb70-110"><a href="annex-i-compendium-of-r-scripts.html#cb70-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ggplot() + geom_sf(data=soil, aes(fill = factor(RSG)))</span></span>
<span id="cb70-111"><a href="annex-i-compendium-of-r-scripts.html#cb70-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-112"><a href="annex-i-compendium-of-r-scripts.html#cb70-112" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Delineate land-use strata =================================================</span></span>
<span id="cb70-113"><a href="annex-i-compendium-of-r-scripts.html#cb70-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-114"><a href="annex-i-compendium-of-r-scripts.html#cb70-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clip landcover data  by bounding area if exist</span></span>
<span id="cb70-115"><a href="annex-i-compendium-of-r-scripts.html#cb70-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (BOUNDING) {</span>
<span id="cb70-116"><a href="annex-i-compendium-of-r-scripts.html#cb70-116" aria-hidden="true" tabindex="-1"></a>      lc <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(lc, bb)</span>
<span id="cb70-117"><a href="annex-i-compendium-of-r-scripts.html#cb70-117" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb70-118"><a href="annex-i-compendium-of-r-scripts.html#cb70-118" aria-hidden="true" tabindex="-1"></a>      lc <span class="ot">&lt;-</span> lc</span>
<span id="cb70-119"><a href="annex-i-compendium-of-r-scripts.html#cb70-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-120"><a href="annex-i-compendium-of-r-scripts.html#cb70-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check geometry</span></span>
<span id="cb70-121"><a href="annex-i-compendium-of-r-scripts.html#cb70-121" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(lc)</span>
<span id="cb70-122"><a href="annex-i-compendium-of-r-scripts.html#cb70-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Agregate units</span></span>
<span id="cb70-123"><a href="annex-i-compendium-of-r-scripts.html#cb70-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(lc<span class="sc">$</span>landcover)</span>
<span id="cb70-124"><a href="annex-i-compendium-of-r-scripts.html#cb70-124" aria-hidden="true" tabindex="-1"></a>    lc<span class="sc">$</span>landcover[lc<span class="sc">$</span>landcover<span class="sc">==</span><span class="st">&quot;Broadleaf forest&quot;</span>]<span class="ot">&lt;-</span> <span class="st">&quot;Forest&quot;</span></span>
<span id="cb70-125"><a href="annex-i-compendium-of-r-scripts.html#cb70-125" aria-hidden="true" tabindex="-1"></a>    lc<span class="sc">$</span>landcover[lc<span class="sc">$</span>landcover<span class="sc">==</span><span class="st">&quot;Needleleaf forest&quot;</span>]<span class="ot">&lt;-</span> <span class="st">&quot;Forest&quot;</span></span>
<span id="cb70-126"><a href="annex-i-compendium-of-r-scripts.html#cb70-126" aria-hidden="true" tabindex="-1"></a>    lc<span class="sc">$</span>landcover[lc<span class="sc">$</span>landcover<span class="sc">==</span><span class="st">&quot;Mixed forest&quot;</span>]<span class="ot">&lt;-</span> <span class="st">&quot;Forest&quot;</span></span>
<span id="cb70-127"><a href="annex-i-compendium-of-r-scripts.html#cb70-127" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> lc[lc<span class="sc">$</span>landcover<span class="sc">!=</span><span class="st">&quot;Water body&quot;</span>,]</span>
<span id="cb70-128"><a href="annex-i-compendium-of-r-scripts.html#cb70-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(lc<span class="sc">$</span>landcover)</span>
<span id="cb70-129"><a href="annex-i-compendium-of-r-scripts.html#cb70-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-130"><a href="annex-i-compendium-of-r-scripts.html#cb70-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dissolve polygons by reference soil group</span></span>
<span id="cb70-131"><a href="annex-i-compendium-of-r-scripts.html#cb70-131" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> lc <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(landcover) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">summarize</span>() </span>
<span id="cb70-132"><a href="annex-i-compendium-of-r-scripts.html#cb70-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-133"><a href="annex-i-compendium-of-r-scripts.html#cb70-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write landcover strata as shapefile</span></span>
<span id="cb70-134"><a href="annex-i-compendium-of-r-scripts.html#cb70-134" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(lc, <span class="fu">paste0</span>(results.path,<span class="st">&quot;lc_classes.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-135"><a href="annex-i-compendium-of-r-scripts.html#cb70-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-136"><a href="annex-i-compendium-of-r-scripts.html#cb70-136" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Plot map with the land cover information</span></span>
<span id="cb70-137"><a href="annex-i-compendium-of-r-scripts.html#cb70-137" aria-hidden="true" tabindex="-1"></a>      map <span class="ot">=</span> <span class="fu">leaflet</span>() <span class="sc">%&gt;%</span></span>
<span id="cb70-138"><a href="annex-i-compendium-of-r-scripts.html#cb70-138" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addTiles</span>()</span>
<span id="cb70-139"><a href="annex-i-compendium-of-r-scripts.html#cb70-139" aria-hidden="true" tabindex="-1"></a>      mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(lc[<span class="st">&quot;landcover&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Landcover&quot;</span>, <span class="at">map=</span>map)</span>
<span id="cb70-140"><a href="annex-i-compendium-of-r-scripts.html#cb70-140" aria-hidden="true" tabindex="-1"></a>      mv<span class="sc">@</span>map</span>
<span id="cb70-141"><a href="annex-i-compendium-of-r-scripts.html#cb70-141" aria-hidden="true" tabindex="-1"></a>      <span class="co">#ggplot() + geom_sf(data=lc, aes(fill = factor(landcover)))</span></span>
<span id="cb70-142"><a href="annex-i-compendium-of-r-scripts.html#cb70-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-143"><a href="annex-i-compendium-of-r-scripts.html#cb70-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-144"><a href="annex-i-compendium-of-r-scripts.html#cb70-144" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Create sampling strata ===================================================</span></span>
<span id="cb70-145"><a href="annex-i-compendium-of-r-scripts.html#cb70-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-146"><a href="annex-i-compendium-of-r-scripts.html#cb70-146" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Combine soil and landcover layers</span></span>
<span id="cb70-147"><a href="annex-i-compendium-of-r-scripts.html#cb70-147" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sf_use_s2</span>(<span class="cn">FALSE</span>)</span>
<span id="cb70-148"><a href="annex-i-compendium-of-r-scripts.html#cb70-148" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(<span class="fu">st_make_valid</span>(soil), <span class="fu">st_make_valid</span>(lc))  </span>
<span id="cb70-149"><a href="annex-i-compendium-of-r-scripts.html#cb70-149" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>soil_lc <span class="ot">&lt;-</span> <span class="fu">paste0</span>(soil_lc<span class="sc">$</span>RSG, <span class="st">&quot;_&quot;</span>, soil_lc<span class="sc">$</span>landcover)</span>
<span id="cb70-150"><a href="annex-i-compendium-of-r-scripts.html#cb70-150" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> soil_lc <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(soil_lc, geometry)</span>
<span id="cb70-151"><a href="annex-i-compendium-of-r-scripts.html#cb70-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-152"><a href="annex-i-compendium-of-r-scripts.html#cb70-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-153"><a href="annex-i-compendium-of-r-scripts.html#cb70-153" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Accommodate strata to requirements =======================================</span></span>
<span id="cb70-154"><a href="annex-i-compendium-of-r-scripts.html#cb70-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-155"><a href="annex-i-compendium-of-r-scripts.html#cb70-155" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Select by Area. Convert to area to ha and select polygons with more than 100 has</span></span>
<span id="cb70-156"><a href="annex-i-compendium-of-r-scripts.html#cb70-156" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(soil_lc)<span class="sc">/</span><span class="dv">10000</span> </span>
<span id="cb70-157"><a href="annex-i-compendium-of-r-scripts.html#cb70-157" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(soil_lc<span class="sc">$</span>area)</span>
<span id="cb70-158"><a href="annex-i-compendium-of-r-scripts.html#cb70-158" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> soil_lc <span class="sc">%&gt;%</span> </span>
<span id="cb70-159"><a href="annex-i-compendium-of-r-scripts.html#cb70-159" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(soil_lc) <span class="sc">%&gt;%</span> </span>
<span id="cb70-160"><a href="annex-i-compendium-of-r-scripts.html#cb70-160" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">area =</span> <span class="fu">sum</span>(area))</span>
<span id="cb70-161"><a href="annex-i-compendium-of-r-scripts.html#cb70-161" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> soil_lc[soil_lc<span class="sc">$</span>area <span class="sc">&gt;</span> <span class="dv">100</span>,]</span>
<span id="cb70-162"><a href="annex-i-compendium-of-r-scripts.html#cb70-162" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(soil_lc[<span class="dv">1</span>])</span>
<span id="cb70-163"><a href="annex-i-compendium-of-r-scripts.html#cb70-163" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-164"><a href="annex-i-compendium-of-r-scripts.html#cb70-164" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Replace blank spaces with underscore symbol to keep names uniform</span></span>
<span id="cb70-165"><a href="annex-i-compendium-of-r-scripts.html#cb70-165" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>soil_lc <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(soil_lc<span class="sc">$</span>soil_lc, <span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>)</span>
<span id="cb70-166"><a href="annex-i-compendium-of-r-scripts.html#cb70-166" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-167"><a href="annex-i-compendium-of-r-scripts.html#cb70-167" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create a column of strata numeric codes</span></span>
<span id="cb70-168"><a href="annex-i-compendium-of-r-scripts.html#cb70-168" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>code <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(soil_lc<span class="sc">$</span>soil_lc)))</span>
<span id="cb70-169"><a href="annex-i-compendium-of-r-scripts.html#cb70-169" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-170"><a href="annex-i-compendium-of-r-scripts.html#cb70-170" aria-hidden="true" tabindex="-1"></a>      <span class="co"># List final strata</span></span>
<span id="cb70-171"><a href="annex-i-compendium-of-r-scripts.html#cb70-171" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unique</span>(soil_lc<span class="sc">$</span>soil_lc)</span>
<span id="cb70-172"><a href="annex-i-compendium-of-r-scripts.html#cb70-172" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-173"><a href="annex-i-compendium-of-r-scripts.html#cb70-173" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Write final sampling strata map</span></span>
<span id="cb70-174"><a href="annex-i-compendium-of-r-scripts.html#cb70-174" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(soil_lc, <span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-175"><a href="annex-i-compendium-of-r-scripts.html#cb70-175" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-176"><a href="annex-i-compendium-of-r-scripts.html#cb70-176" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Plot strata ==============================================================</span></span>
<span id="cb70-177"><a href="annex-i-compendium-of-r-scripts.html#cb70-177" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-178"><a href="annex-i-compendium-of-r-scripts.html#cb70-178" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Plot final map of stratum</span></span>
<span id="cb70-179"><a href="annex-i-compendium-of-r-scripts.html#cb70-179" aria-hidden="true" tabindex="-1"></a>      map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">8.3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-180"><a href="annex-i-compendium-of-r-scripts.html#cb70-180" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addTiles</span>()</span>
<span id="cb70-181"><a href="annex-i-compendium-of-r-scripts.html#cb70-181" aria-hidden="true" tabindex="-1"></a>      mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>, <span class="at">map=</span>map)</span>
<span id="cb70-182"><a href="annex-i-compendium-of-r-scripts.html#cb70-182" aria-hidden="true" tabindex="-1"></a>      mv<span class="sc">@</span>map</span>
<span id="cb70-183"><a href="annex-i-compendium-of-r-scripts.html#cb70-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-184"><a href="annex-i-compendium-of-r-scripts.html#cb70-184" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Stratified random sampling ===============================================</span></span>
<span id="cb70-185"><a href="annex-i-compendium-of-r-scripts.html#cb70-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-186"><a href="annex-i-compendium-of-r-scripts.html#cb70-186" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read already created strata shapefile</span></span>
<span id="cb70-187"><a href="annex-i-compendium-of-r-scripts.html#cb70-187" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>))</span>
<span id="cb70-188"><a href="annex-i-compendium-of-r-scripts.html#cb70-188" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(REPLACEMENT){</span>
<span id="cb70-189"><a href="annex-i-compendium-of-r-scripts.html#cb70-189" aria-hidden="true" tabindex="-1"></a>      polygons <span class="ot">=</span> <span class="fu">st_intersection</span>(polygons,distance.buffer)</span>
<span id="cb70-190"><a href="annex-i-compendium-of-r-scripts.html#cb70-190" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-191"><a href="annex-i-compendium-of-r-scripts.html#cb70-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-192"><a href="annex-i-compendium-of-r-scripts.html#cb70-192" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the area of each polygon  </span></span>
<span id="cb70-193"><a href="annex-i-compendium-of-r-scripts.html#cb70-193" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(polygons) </span>
<span id="cb70-194"><a href="annex-i-compendium-of-r-scripts.html#cb70-194" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-195"><a href="annex-i-compendium-of-r-scripts.html#cb70-195" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a new column to group polygons by a common attribute</span></span>
<span id="cb70-196"><a href="annex-i-compendium-of-r-scripts.html#cb70-196" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>group <span class="ot">&lt;-</span> polygons<span class="sc">$</span>soil_lc</span>
<span id="cb70-197"><a href="annex-i-compendium-of-r-scripts.html#cb70-197" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop units to allow computations</span></span>
<span id="cb70-198"><a href="annex-i-compendium-of-r-scripts.html#cb70-198" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">drop_units</span>(polygons)</span>
<span id="cb70-199"><a href="annex-i-compendium-of-r-scripts.html#cb70-199" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-200"><a href="annex-i-compendium-of-r-scripts.html#cb70-200" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the total area of all polygons in each group</span></span>
<span id="cb70-201"><a href="annex-i-compendium-of-r-scripts.html#cb70-201" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span></span>
<span id="cb70-202"><a href="annex-i-compendium-of-r-scripts.html#cb70-202" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(group)  <span class="sc">%&gt;%</span> </span>
<span id="cb70-203"><a href="annex-i-compendium-of-r-scripts.html#cb70-203" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">total_area =</span> <span class="fu">sum</span>(area))</span>
<span id="cb70-204"><a href="annex-i-compendium-of-r-scripts.html#cb70-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a code to each group</span></span>
<span id="cb70-205"><a href="annex-i-compendium-of-r-scripts.html#cb70-205" aria-hidden="true" tabindex="-1"></a>    group_codes <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb70-206"><a href="annex-i-compendium-of-r-scripts.html#cb70-206" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">code =</span> <span class="fu">first</span>(code)) </span>
<span id="cb70-207"><a href="annex-i-compendium-of-r-scripts.html#cb70-207" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join polygon strata and codes   </span></span>
<span id="cb70-208"><a href="annex-i-compendium-of-r-scripts.html#cb70-208" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">st_drop_geometry</span>(group_codes), <span class="at">by =</span> <span class="st">&quot;group&quot;</span>)</span>
<span id="cb70-209"><a href="annex-i-compendium-of-r-scripts.html#cb70-209" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-210"><a href="annex-i-compendium-of-r-scripts.html#cb70-210" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure minimum of 2 samples at each polygon in each group</span></span>
<span id="cb70-211"><a href="annex-i-compendium-of-r-scripts.html#cb70-211" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb70-212"><a href="annex-i-compendium-of-r-scripts.html#cb70-212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-213"><a href="annex-i-compendium-of-r-scripts.html#cb70-213" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the number of samples per group based on relative area</span></span>
<span id="cb70-214"><a href="annex-i-compendium-of-r-scripts.html#cb70-214" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> </span>
<span id="cb70-215"><a href="annex-i-compendium-of-r-scripts.html#cb70-215" aria-hidden="true" tabindex="-1"></a>      group_areas<span class="sc">$</span>sample_count <span class="sc">+</span> </span>
<span id="cb70-216"><a href="annex-i-compendium-of-r-scripts.html#cb70-216" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(group_areas<span class="sc">$</span>total_area<span class="sc">/</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>total_area) <span class="sc">*</span></span>
<span id="cb70-217"><a href="annex-i-compendium-of-r-scripts.html#cb70-217" aria-hidden="true" tabindex="-1"></a>              (n<span class="sc">-</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count)))</span>
<span id="cb70-218"><a href="annex-i-compendium-of-r-scripts.html#cb70-218" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Adjust sample size on classes</span></span>
<span id="cb70-219"><a href="annex-i-compendium-of-r-scripts.html#cb70-219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">!=</span> n) {</span>
<span id="cb70-220"><a href="annex-i-compendium-of-r-scripts.html#cb70-220" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">&gt;</span> n) {</span>
<span id="cb70-221"><a href="annex-i-compendium-of-r-scripts.html#cb70-221" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Reduce sample count for the largest polygon until total count is n</span></span>
<span id="cb70-222"><a href="annex-i-compendium-of-r-scripts.html#cb70-222" aria-hidden="true" tabindex="-1"></a>        max_index <span class="ot">&lt;-</span> <span class="fu">which.max</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb70-223"><a href="annex-i-compendium-of-r-scripts.html#cb70-223" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[max_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[max_index] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb70-224"><a href="annex-i-compendium-of-r-scripts.html#cb70-224" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb70-225"><a href="annex-i-compendium-of-r-scripts.html#cb70-225" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Increase sample count for the smallest polygon until total count is n</span></span>
<span id="cb70-226"><a href="annex-i-compendium-of-r-scripts.html#cb70-226" aria-hidden="true" tabindex="-1"></a>        min_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb70-227"><a href="annex-i-compendium-of-r-scripts.html#cb70-227" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[min_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[min_index] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb70-228"><a href="annex-i-compendium-of-r-scripts.html#cb70-228" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-229"><a href="annex-i-compendium-of-r-scripts.html#cb70-229" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-230"><a href="annex-i-compendium-of-r-scripts.html#cb70-230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count the total samples. It must be equal to the sampling size</span></span>
<span id="cb70-231"><a href="annex-i-compendium-of-r-scripts.html#cb70-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) </span>
<span id="cb70-232"><a href="annex-i-compendium-of-r-scripts.html#cb70-232" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-233"><a href="annex-i-compendium-of-r-scripts.html#cb70-233" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">left_join</span>(polygons, <span class="fu">st_drop_geometry</span>(group_areas),</span>
<span id="cb70-234"><a href="annex-i-compendium-of-r-scripts.html#cb70-234" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;soil_lc&quot;</span><span class="ot">=</span><span class="st">&quot;group&quot;</span>))</span>
<span id="cb70-235"><a href="annex-i-compendium-of-r-scripts.html#cb70-235" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(polygons, soil_lc, code.x, sample_count, geometry)</span>
<span id="cb70-236"><a href="annex-i-compendium-of-r-scripts.html#cb70-236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-237"><a href="annex-i-compendium-of-r-scripts.html#cb70-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate random points within each strata of size 3 times</span></span>
<span id="cb70-238"><a href="annex-i-compendium-of-r-scripts.html#cb70-238" aria-hidden="true" tabindex="-1"></a>  <span class="co">#the required samples for each strata</span></span>
<span id="cb70-239"><a href="annex-i-compendium-of-r-scripts.html#cb70-239" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas),</span>
<span id="cb70-240"><a href="annex-i-compendium-of-r-scripts.html#cb70-240" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> group_areas<span class="sc">$</span>sample_count <span class="sc">*</span> <span class="dv">3</span>, <span class="at">method =</span> <span class="st">&quot;random&quot;</span>)</span>
<span id="cb70-241"><a href="annex-i-compendium-of-r-scripts.html#cb70-241" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-242"><a href="annex-i-compendium-of-r-scripts.html#cb70-242" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute sampling points for strata</span></span>
<span id="cb70-243"><a href="annex-i-compendium-of-r-scripts.html#cb70-243" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb70-244"><a href="annex-i-compendium-of-r-scripts.html#cb70-244" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb70-245"><a href="annex-i-compendium-of-r-scripts.html#cb70-245" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb70-246"><a href="annex-i-compendium-of-r-scripts.html#cb70-246" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb70-247"><a href="annex-i-compendium-of-r-scripts.html#cb70-247" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb70-248"><a href="annex-i-compendium-of-r-scripts.html#cb70-248" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb70-249"><a href="annex-i-compendium-of-r-scripts.html#cb70-249" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb70-250"><a href="annex-i-compendium-of-r-scripts.html#cb70-250" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb70-251"><a href="annex-i-compendium-of-r-scripts.html#cb70-251" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-252"><a href="annex-i-compendium-of-r-scripts.html#cb70-252" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find classes with missing samples</span></span>
<span id="cb70-253"><a href="annex-i-compendium-of-r-scripts.html#cb70-253" aria-hidden="true" tabindex="-1"></a>    missing.data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">data.frame</span>(z) <span class="sc">%&gt;%</span></span>
<span id="cb70-254"><a href="annex-i-compendium-of-r-scripts.html#cb70-254" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">filter</span>(type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb70-255"><a href="annex-i-compendium-of-r-scripts.html#cb70-255" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span></span>
<span id="cb70-256"><a href="annex-i-compendium-of-r-scripts.html#cb70-256" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">tally</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb70-257"><a href="annex-i-compendium-of-r-scripts.html#cb70-257" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diff=</span>sample_count<span class="sc">-</span>n)</span>
<span id="cb70-258"><a href="annex-i-compendium-of-r-scripts.html#cb70-258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-259"><a href="annex-i-compendium-of-r-scripts.html#cb70-259" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine missing sampled strata</span></span>
<span id="cb70-260"><a href="annex-i-compendium-of-r-scripts.html#cb70-260" aria-hidden="true" tabindex="-1"></a>    missing.strata <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(missing.data<span class="sc">$</span>diff))</span>
<span id="cb70-261"><a href="annex-i-compendium-of-r-scripts.html#cb70-261" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-262"><a href="annex-i-compendium-of-r-scripts.html#cb70-262" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine missing sampling point in strata (undersampled strata)</span></span>
<span id="cb70-263"><a href="annex-i-compendium-of-r-scripts.html#cb70-263" aria-hidden="true" tabindex="-1"></a>    missing.sample <span class="ot">=</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb70-264"><a href="annex-i-compendium-of-r-scripts.html#cb70-264" aria-hidden="true" tabindex="-1"></a>    missing.number <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">st_drop_geometry</span>(missing.data[(missing.sample <span class="ot">&lt;-</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)),<span class="dv">7</span>])))</span>
<span id="cb70-265"><a href="annex-i-compendium-of-r-scripts.html#cb70-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-266"><a href="annex-i-compendium-of-r-scripts.html#cb70-266" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute sampling points for missing sampled strata</span></span>
<span id="cb70-267"><a href="annex-i-compendium-of-r-scripts.html#cb70-267" aria-hidden="true" tabindex="-1"></a>    x.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb70-268"><a href="annex-i-compendium-of-r-scripts.html#cb70-268" aria-hidden="true" tabindex="-1"></a>    x.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb70-269"><a href="annex-i-compendium-of-r-scripts.html#cb70-269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-270"><a href="annex-i-compendium-of-r-scripts.html#cb70-270" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.strata){</span>
<span id="cb70-271"><a href="annex-i-compendium-of-r-scripts.html#cb70-271" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb70-272"><a href="annex-i-compendium-of-r-scripts.html#cb70-272" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb70-273"><a href="annex-i-compendium-of-r-scripts.html#cb70-273" aria-hidden="true" tabindex="-1"></a>      nn<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb70-274"><a href="annex-i-compendium-of-r-scripts.html#cb70-274" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> </span>
<span id="cb70-275"><a href="annex-i-compendium-of-r-scripts.html#cb70-275" aria-hidden="true" tabindex="-1"></a>             group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>) {</span>
<span id="cb70-276"><a href="annex-i-compendium-of-r-scripts.html#cb70-276" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-277"><a href="annex-i-compendium-of-r-scripts.html#cb70-277" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span>(nn <span class="sc">&lt;</span> group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>){</span>
<span id="cb70-278"><a href="annex-i-compendium-of-r-scripts.html#cb70-278" aria-hidden="true" tabindex="-1"></a>          my.missing.strata <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb70-279"><a href="annex-i-compendium-of-r-scripts.html#cb70-279" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">size =</span>  group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>,</span>
<span id="cb70-280"><a href="annex-i-compendium-of-r-scripts.html#cb70-280" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">method =</span> <span class="st">&quot;random&quot;</span>)</span>
<span id="cb70-281"><a href="annex-i-compendium-of-r-scripts.html#cb70-281" aria-hidden="true" tabindex="-1"></a>          nn <span class="ot">&lt;-</span> nn <span class="sc">+</span> <span class="fu">nrow</span>(<span class="fu">data.frame</span>(my.missing.strata))</span>
<span id="cb70-282"><a href="annex-i-compendium-of-r-scripts.html#cb70-282" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-283"><a href="annex-i-compendium-of-r-scripts.html#cb70-283" aria-hidden="true" tabindex="-1"></a>        xx.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.strata,my.missing.strata)</span>
<span id="cb70-284"><a href="annex-i-compendium-of-r-scripts.html#cb70-284" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count))</span>
<span id="cb70-285"><a href="annex-i-compendium-of-r-scripts.html#cb70-285" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-286"><a href="annex-i-compendium-of-r-scripts.html#cb70-286" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb70-287"><a href="annex-i-compendium-of-r-scripts.html#cb70-287" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.strata)</span>
<span id="cb70-288"><a href="annex-i-compendium-of-r-scripts.html#cb70-288" aria-hidden="true" tabindex="-1"></a>      x.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.strata,xx.missing.strata)</span>
<span id="cb70-289"><a href="annex-i-compendium-of-r-scripts.html#cb70-289" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-290"><a href="annex-i-compendium-of-r-scripts.html#cb70-290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-291"><a href="annex-i-compendium-of-r-scripts.html#cb70-291" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join initial sampling with missing sampling strata data</span></span>
<span id="cb70-292"><a href="annex-i-compendium-of-r-scripts.html#cb70-292" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.strata)</span>
<span id="cb70-293"><a href="annex-i-compendium-of-r-scripts.html#cb70-293" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-294"><a href="annex-i-compendium-of-r-scripts.html#cb70-294" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute sampling points for missing samples (random sampling)</span></span>
<span id="cb70-295"><a href="annex-i-compendium-of-r-scripts.html#cb70-295" aria-hidden="true" tabindex="-1"></a>    x.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb70-296"><a href="annex-i-compendium-of-r-scripts.html#cb70-296" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-297"><a href="annex-i-compendium-of-r-scripts.html#cb70-297" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.sample){</span>
<span id="cb70-298"><a href="annex-i-compendium-of-r-scripts.html#cb70-298" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb70-299"><a href="annex-i-compendium-of-r-scripts.html#cb70-299" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb70-300"><a href="annex-i-compendium-of-r-scripts.html#cb70-300" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>)) {</span>
<span id="cb70-301"><a href="annex-i-compendium-of-r-scripts.html#cb70-301" aria-hidden="true" tabindex="-1"></a>        my.missing.sample <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb70-302"><a href="annex-i-compendium-of-r-scripts.html#cb70-302" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">size =</span> <span class="fu">as.numeric</span>(<span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,])[[<span class="dv">4</span>]])<span class="sc">+</span></span>
<span id="cb70-303"><a href="annex-i-compendium-of-r-scripts.html#cb70-303" aria-hidden="true" tabindex="-1"></a>                                          (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>), <span class="at">method =</span> <span class="st">&quot;random&quot;</span>)</span>
<span id="cb70-304"><a href="annex-i-compendium-of-r-scripts.html#cb70-304" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-305"><a href="annex-i-compendium-of-r-scripts.html#cb70-305" aria-hidden="true" tabindex="-1"></a>        xx.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.sample,my.missing.sample)</span>
<span id="cb70-306"><a href="annex-i-compendium-of-r-scripts.html#cb70-306" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count))</span>
<span id="cb70-307"><a href="annex-i-compendium-of-r-scripts.html#cb70-307" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-308"><a href="annex-i-compendium-of-r-scripts.html#cb70-308" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb70-309"><a href="annex-i-compendium-of-r-scripts.html#cb70-309" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.sample)</span>
<span id="cb70-310"><a href="annex-i-compendium-of-r-scripts.html#cb70-310" aria-hidden="true" tabindex="-1"></a>      x.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.sample,xx.missing.sample)</span>
<span id="cb70-311"><a href="annex-i-compendium-of-r-scripts.html#cb70-311" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-312"><a href="annex-i-compendium-of-r-scripts.html#cb70-312" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-313"><a href="annex-i-compendium-of-r-scripts.html#cb70-313" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join initial sampling with missing sampling strata data and with missing samples </span></span>
<span id="cb70-314"><a href="annex-i-compendium-of-r-scripts.html#cb70-314" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.sample)</span>
<span id="cb70-315"><a href="annex-i-compendium-of-r-scripts.html#cb70-315" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-316"><a href="annex-i-compendium-of-r-scripts.html#cb70-316" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove extra artificial replacements </span></span>
<span id="cb70-317"><a href="annex-i-compendium-of-r-scripts.html#cb70-317" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x[x<span class="sc">$</span>sample_count <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb70-318"><a href="annex-i-compendium-of-r-scripts.html#cb70-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-319"><a href="annex-i-compendium-of-r-scripts.html#cb70-319" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert and export to shapefile</span></span>
<span id="cb70-320"><a href="annex-i-compendium-of-r-scripts.html#cb70-320" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb70-321"><a href="annex-i-compendium-of-r-scripts.html#cb70-321" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb70-322"><a href="annex-i-compendium-of-r-scripts.html#cb70-322" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb70-323"><a href="annex-i-compendium-of-r-scripts.html#cb70-323" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb70-324"><a href="annex-i-compendium-of-r-scripts.html#cb70-324" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb70-325"><a href="annex-i-compendium-of-r-scripts.html#cb70-325" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb70-326"><a href="annex-i-compendium-of-r-scripts.html#cb70-326" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb70-327"><a href="annex-i-compendium-of-r-scripts.html#cb70-327" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb70-328"><a href="annex-i-compendium-of-r-scripts.html#cb70-328" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeVector</span>(z,</span>
<span id="cb70-329"><a href="annex-i-compendium-of-r-scripts.html#cb70-329" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(results.path,<span class="st">&quot;strat_randm_samples.shp&quot;</span>, <span class="at">overwrite=</span><span class="cn">TRUE</span>))</span>
<span id="cb70-330"><a href="annex-i-compendium-of-r-scripts.html#cb70-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-331"><a href="annex-i-compendium-of-r-scripts.html#cb70-331" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the number of initial target points equals the final target points </span></span>
<span id="cb70-332"><a href="annex-i-compendium-of-r-scripts.html#cb70-332" aria-hidden="true" tabindex="-1"></a>    n<span class="sc">==</span><span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb70-333"><a href="annex-i-compendium-of-r-scripts.html#cb70-333" aria-hidden="true" tabindex="-1"></a>    n;<span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb70-334"><a href="annex-i-compendium-of-r-scripts.html#cb70-334" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-335"><a href="annex-i-compendium-of-r-scripts.html#cb70-335" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot points over strata ==================================================</span></span>
<span id="cb70-336"><a href="annex-i-compendium-of-r-scripts.html#cb70-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-337"><a href="annex-i-compendium-of-r-scripts.html#cb70-337" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">11.4</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-338"><a href="annex-i-compendium-of-r-scripts.html#cb70-338" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb70-339"><a href="annex-i-compendium-of-r-scripts.html#cb70-339" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>) <span class="sc">+</span> </span>
<span id="cb70-340"><a href="annex-i-compendium-of-r-scripts.html#cb70-340" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(sf<span class="sc">::</span><span class="fu">st_as_sf</span>(z), <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;royalblue&#39;</span>, <span class="st">&#39;tomato&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Samples&quot;</span>)</span>
<span id="cb70-341"><a href="annex-i-compendium-of-r-scripts.html#cb70-341" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb70-342"><a href="annex-i-compendium-of-r-scripts.html#cb70-342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-343"><a href="annex-i-compendium-of-r-scripts.html#cb70-343" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-344"><a href="annex-i-compendium-of-r-scripts.html#cb70-344" aria-hidden="true" tabindex="-1"></a><span class="co"># 10 - Calculate replacement areas for points ==================================    </span></span>
<span id="cb70-345"><a href="annex-i-compendium-of-r-scripts.html#cb70-345" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-346"><a href="annex-i-compendium-of-r-scripts.html#cb70-346" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(REPLACEMENT){</span>
<span id="cb70-347"><a href="annex-i-compendium-of-r-scripts.html#cb70-347" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Load strata</span></span>
<span id="cb70-348"><a href="annex-i-compendium-of-r-scripts.html#cb70-348" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>))</span>
<span id="cb70-349"><a href="annex-i-compendium-of-r-scripts.html#cb70-349" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-350"><a href="annex-i-compendium-of-r-scripts.html#cb70-350" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Read sampling. points from previous step</span></span>
<span id="cb70-351"><a href="annex-i-compendium-of-r-scripts.html#cb70-351" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strat_randm_samples.shp&quot;</span>))</span>
<span id="cb70-352"><a href="annex-i-compendium-of-r-scripts.html#cb70-352" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-353"><a href="annex-i-compendium-of-r-scripts.html#cb70-353" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Apply buffer of 500 meters</span></span>
<span id="cb70-354"><a href="annex-i-compendium-of-r-scripts.html#cb70-354" aria-hidden="true" tabindex="-1"></a>      buf.samples <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(z, <span class="at">dist=</span>distance.buffer)</span>
<span id="cb70-355"><a href="annex-i-compendium-of-r-scripts.html#cb70-355" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-356"><a href="annex-i-compendium-of-r-scripts.html#cb70-356" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Intersect buffers</span></span>
<span id="cb70-357"><a href="annex-i-compendium-of-r-scripts.html#cb70-357" aria-hidden="true" tabindex="-1"></a>      samples_buffer <span class="ot">=</span> <span class="fu">st_intersection</span>(soil_lc, buf.samples)</span>
<span id="cb70-358"><a href="annex-i-compendium-of-r-scripts.html#cb70-358" aria-hidden="true" tabindex="-1"></a>      samples_buffer <span class="ot">&lt;-</span> samples_buffer[samples_buffer<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,]</span>
<span id="cb70-359"><a href="annex-i-compendium-of-r-scripts.html#cb70-359" aria-hidden="true" tabindex="-1"></a>      samples_buffer <span class="ot">&lt;-</span> samples_buffer[samples_buffer<span class="sc">$</span>soil_lc<span class="sc">==</span>samples_buffer<span class="sc">$</span>group,]</span>
<span id="cb70-360"><a href="annex-i-compendium-of-r-scripts.html#cb70-360" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-361"><a href="annex-i-compendium-of-r-scripts.html#cb70-361" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save Sampling areas</span></span>
<span id="cb70-362"><a href="annex-i-compendium-of-r-scripts.html#cb70-362" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(samples_buffer, <span class="fu">paste0</span>(results.path,<span class="st">&quot;replacement_areas.shp&quot;</span>),</span>
<span id="cb70-363"><a href="annex-i-compendium-of-r-scripts.html#cb70-363" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-364"><a href="annex-i-compendium-of-r-scripts.html#cb70-364" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Write target points only</span></span>
<span id="cb70-365"><a href="annex-i-compendium-of-r-scripts.html#cb70-365" aria-hidden="true" tabindex="-1"></a>      targets <span class="ot">&lt;-</span> z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,]</span>
<span id="cb70-366"><a href="annex-i-compendium-of-r-scripts.html#cb70-366" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(targets, <span class="fu">paste0</span>(results.path,<span class="st">&quot;target_points.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-367"><a href="annex-i-compendium-of-r-scripts.html#cb70-367" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-368"><a href="annex-i-compendium-of-r-scripts.html#cb70-368" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-369"><a href="annex-i-compendium-of-r-scripts.html#cb70-369" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-370"><a href="annex-i-compendium-of-r-scripts.html#cb70-370" aria-hidden="true" tabindex="-1"></a><span class="co"># 11 - Stratified regular sampling ==================================    </span></span>
<span id="cb70-371"><a href="annex-i-compendium-of-r-scripts.html#cb70-371" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read already created strata shapefile</span></span>
<span id="cb70-372"><a href="annex-i-compendium-of-r-scripts.html#cb70-372" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>))</span>
<span id="cb70-373"><a href="annex-i-compendium-of-r-scripts.html#cb70-373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(REPLACEMENT){</span>
<span id="cb70-374"><a href="annex-i-compendium-of-r-scripts.html#cb70-374" aria-hidden="true" tabindex="-1"></a>      polygons <span class="ot">=</span> <span class="fu">st_intersection</span>(polygons,distance.buffer)</span>
<span id="cb70-375"><a href="annex-i-compendium-of-r-scripts.html#cb70-375" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-376"><a href="annex-i-compendium-of-r-scripts.html#cb70-376" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-377"><a href="annex-i-compendium-of-r-scripts.html#cb70-377" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the area of each polygon  </span></span>
<span id="cb70-378"><a href="annex-i-compendium-of-r-scripts.html#cb70-378" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(polygons) </span>
<span id="cb70-379"><a href="annex-i-compendium-of-r-scripts.html#cb70-379" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-380"><a href="annex-i-compendium-of-r-scripts.html#cb70-380" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new column to group polygons by a common attribute</span></span>
<span id="cb70-381"><a href="annex-i-compendium-of-r-scripts.html#cb70-381" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>group <span class="ot">&lt;-</span> polygons<span class="sc">$</span>soil_lc</span>
<span id="cb70-382"><a href="annex-i-compendium-of-r-scripts.html#cb70-382" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop units to allow computations</span></span>
<span id="cb70-383"><a href="annex-i-compendium-of-r-scripts.html#cb70-383" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">drop_units</span>(polygons)</span>
<span id="cb70-384"><a href="annex-i-compendium-of-r-scripts.html#cb70-384" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-385"><a href="annex-i-compendium-of-r-scripts.html#cb70-385" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the total area of all polygons in each group</span></span>
<span id="cb70-386"><a href="annex-i-compendium-of-r-scripts.html#cb70-386" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span></span>
<span id="cb70-387"><a href="annex-i-compendium-of-r-scripts.html#cb70-387" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(group)  <span class="sc">%&gt;%</span> </span>
<span id="cb70-388"><a href="annex-i-compendium-of-r-scripts.html#cb70-388" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">total_area =</span> <span class="fu">sum</span>(area))</span>
<span id="cb70-389"><a href="annex-i-compendium-of-r-scripts.html#cb70-389" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a code to each group</span></span>
<span id="cb70-390"><a href="annex-i-compendium-of-r-scripts.html#cb70-390" aria-hidden="true" tabindex="-1"></a>    group_codes <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb70-391"><a href="annex-i-compendium-of-r-scripts.html#cb70-391" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">code =</span> <span class="fu">first</span>(code)) </span>
<span id="cb70-392"><a href="annex-i-compendium-of-r-scripts.html#cb70-392" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join polygon strata and codes   </span></span>
<span id="cb70-393"><a href="annex-i-compendium-of-r-scripts.html#cb70-393" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">st_drop_geometry</span>(group_codes), <span class="at">by =</span> <span class="st">&quot;group&quot;</span>)</span>
<span id="cb70-394"><a href="annex-i-compendium-of-r-scripts.html#cb70-394" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-395"><a href="annex-i-compendium-of-r-scripts.html#cb70-395" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure minimum of 2 samples at each polygon in each group</span></span>
<span id="cb70-396"><a href="annex-i-compendium-of-r-scripts.html#cb70-396" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb70-397"><a href="annex-i-compendium-of-r-scripts.html#cb70-397" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-398"><a href="annex-i-compendium-of-r-scripts.html#cb70-398" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the number of samples per group based on relative area</span></span>
<span id="cb70-399"><a href="annex-i-compendium-of-r-scripts.html#cb70-399" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> </span>
<span id="cb70-400"><a href="annex-i-compendium-of-r-scripts.html#cb70-400" aria-hidden="true" tabindex="-1"></a>      group_areas<span class="sc">$</span>sample_count <span class="sc">+</span> </span>
<span id="cb70-401"><a href="annex-i-compendium-of-r-scripts.html#cb70-401" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(group_areas<span class="sc">$</span>total_area<span class="sc">/</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>total_area) <span class="sc">*</span></span>
<span id="cb70-402"><a href="annex-i-compendium-of-r-scripts.html#cb70-402" aria-hidden="true" tabindex="-1"></a>              (n<span class="sc">-</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count)))</span>
<span id="cb70-403"><a href="annex-i-compendium-of-r-scripts.html#cb70-403" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust sample size on classes</span></span>
<span id="cb70-404"><a href="annex-i-compendium-of-r-scripts.html#cb70-404" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">!=</span> n) {</span>
<span id="cb70-405"><a href="annex-i-compendium-of-r-scripts.html#cb70-405" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">&gt;</span> n) {</span>
<span id="cb70-406"><a href="annex-i-compendium-of-r-scripts.html#cb70-406" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reduce sample count for the largest polygon until total count is n</span></span>
<span id="cb70-407"><a href="annex-i-compendium-of-r-scripts.html#cb70-407" aria-hidden="true" tabindex="-1"></a>        max_index <span class="ot">&lt;-</span> <span class="fu">which.max</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb70-408"><a href="annex-i-compendium-of-r-scripts.html#cb70-408" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[max_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[max_index] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb70-409"><a href="annex-i-compendium-of-r-scripts.html#cb70-409" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb70-410"><a href="annex-i-compendium-of-r-scripts.html#cb70-410" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Increase sample count for the smallest polygon until total count is n</span></span>
<span id="cb70-411"><a href="annex-i-compendium-of-r-scripts.html#cb70-411" aria-hidden="true" tabindex="-1"></a>        min_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb70-412"><a href="annex-i-compendium-of-r-scripts.html#cb70-412" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[min_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[min_index] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb70-413"><a href="annex-i-compendium-of-r-scripts.html#cb70-413" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-414"><a href="annex-i-compendium-of-r-scripts.html#cb70-414" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-415"><a href="annex-i-compendium-of-r-scripts.html#cb70-415" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count the total samples. It must be equal to the sampling size</span></span>
<span id="cb70-416"><a href="annex-i-compendium-of-r-scripts.html#cb70-416" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) </span>
<span id="cb70-417"><a href="annex-i-compendium-of-r-scripts.html#cb70-417" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-418"><a href="annex-i-compendium-of-r-scripts.html#cb70-418" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">left_join</span>(polygons, <span class="fu">st_drop_geometry</span>(group_areas),</span>
<span id="cb70-419"><a href="annex-i-compendium-of-r-scripts.html#cb70-419" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;soil_lc&quot;</span><span class="ot">=</span><span class="st">&quot;group&quot;</span>))</span>
<span id="cb70-420"><a href="annex-i-compendium-of-r-scripts.html#cb70-420" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(polygons, soil_lc, code.x, sample_count, geometry)</span>
<span id="cb70-421"><a href="annex-i-compendium-of-r-scripts.html#cb70-421" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-422"><a href="annex-i-compendium-of-r-scripts.html#cb70-422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate regular points within each strata of size 3 times</span></span>
<span id="cb70-423"><a href="annex-i-compendium-of-r-scripts.html#cb70-423" aria-hidden="true" tabindex="-1"></a>    <span class="co">#the required samples for each strata</span></span>
<span id="cb70-424"><a href="annex-i-compendium-of-r-scripts.html#cb70-424" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas),</span>
<span id="cb70-425"><a href="annex-i-compendium-of-r-scripts.html#cb70-425" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> group_areas<span class="sc">$</span>sample_count <span class="sc">*</span> <span class="dv">3</span>, <span class="at">method =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb70-426"><a href="annex-i-compendium-of-r-scripts.html#cb70-426" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-427"><a href="annex-i-compendium-of-r-scripts.html#cb70-427" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points for strata</span></span>
<span id="cb70-428"><a href="annex-i-compendium-of-r-scripts.html#cb70-428" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb70-429"><a href="annex-i-compendium-of-r-scripts.html#cb70-429" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb70-430"><a href="annex-i-compendium-of-r-scripts.html#cb70-430" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb70-431"><a href="annex-i-compendium-of-r-scripts.html#cb70-431" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb70-432"><a href="annex-i-compendium-of-r-scripts.html#cb70-432" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb70-433"><a href="annex-i-compendium-of-r-scripts.html#cb70-433" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb70-434"><a href="annex-i-compendium-of-r-scripts.html#cb70-434" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb70-435"><a href="annex-i-compendium-of-r-scripts.html#cb70-435" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb70-436"><a href="annex-i-compendium-of-r-scripts.html#cb70-436" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-437"><a href="annex-i-compendium-of-r-scripts.html#cb70-437" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find classes with missing samples</span></span>
<span id="cb70-438"><a href="annex-i-compendium-of-r-scripts.html#cb70-438" aria-hidden="true" tabindex="-1"></a>    missing.data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">data.frame</span>(z) <span class="sc">%&gt;%</span></span>
<span id="cb70-439"><a href="annex-i-compendium-of-r-scripts.html#cb70-439" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">filter</span>(type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb70-440"><a href="annex-i-compendium-of-r-scripts.html#cb70-440" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span></span>
<span id="cb70-441"><a href="annex-i-compendium-of-r-scripts.html#cb70-441" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">tally</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb70-442"><a href="annex-i-compendium-of-r-scripts.html#cb70-442" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diff=</span>sample_count<span class="sc">-</span>n)</span>
<span id="cb70-443"><a href="annex-i-compendium-of-r-scripts.html#cb70-443" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-444"><a href="annex-i-compendium-of-r-scripts.html#cb70-444" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine missing sampled strata</span></span>
<span id="cb70-445"><a href="annex-i-compendium-of-r-scripts.html#cb70-445" aria-hidden="true" tabindex="-1"></a>    missing.strata <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(missing.data<span class="sc">$</span>diff))</span>
<span id="cb70-446"><a href="annex-i-compendium-of-r-scripts.html#cb70-446" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-447"><a href="annex-i-compendium-of-r-scripts.html#cb70-447" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine missing sampling point in strata (undersampled strata)</span></span>
<span id="cb70-448"><a href="annex-i-compendium-of-r-scripts.html#cb70-448" aria-hidden="true" tabindex="-1"></a>    missing.sample <span class="ot">=</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb70-449"><a href="annex-i-compendium-of-r-scripts.html#cb70-449" aria-hidden="true" tabindex="-1"></a>    missing.number <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">st_drop_geometry</span>(missing.data[(missing.sample <span class="ot">&lt;-</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)),<span class="dv">7</span>])))</span>
<span id="cb70-450"><a href="annex-i-compendium-of-r-scripts.html#cb70-450" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-451"><a href="annex-i-compendium-of-r-scripts.html#cb70-451" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points for missing sampled strata</span></span>
<span id="cb70-452"><a href="annex-i-compendium-of-r-scripts.html#cb70-452" aria-hidden="true" tabindex="-1"></a>    x.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb70-453"><a href="annex-i-compendium-of-r-scripts.html#cb70-453" aria-hidden="true" tabindex="-1"></a>    x.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb70-454"><a href="annex-i-compendium-of-r-scripts.html#cb70-454" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-455"><a href="annex-i-compendium-of-r-scripts.html#cb70-455" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.strata){</span>
<span id="cb70-456"><a href="annex-i-compendium-of-r-scripts.html#cb70-456" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb70-457"><a href="annex-i-compendium-of-r-scripts.html#cb70-457" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb70-458"><a href="annex-i-compendium-of-r-scripts.html#cb70-458" aria-hidden="true" tabindex="-1"></a>      nn<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb70-459"><a href="annex-i-compendium-of-r-scripts.html#cb70-459" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> </span>
<span id="cb70-460"><a href="annex-i-compendium-of-r-scripts.html#cb70-460" aria-hidden="true" tabindex="-1"></a>             group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>) {</span>
<span id="cb70-461"><a href="annex-i-compendium-of-r-scripts.html#cb70-461" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-462"><a href="annex-i-compendium-of-r-scripts.html#cb70-462" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span>(nn <span class="sc">&lt;</span> group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>){</span>
<span id="cb70-463"><a href="annex-i-compendium-of-r-scripts.html#cb70-463" aria-hidden="true" tabindex="-1"></a>          my.missing.strata <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb70-464"><a href="annex-i-compendium-of-r-scripts.html#cb70-464" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">size =</span>  group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>,</span>
<span id="cb70-465"><a href="annex-i-compendium-of-r-scripts.html#cb70-465" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">method =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb70-466"><a href="annex-i-compendium-of-r-scripts.html#cb70-466" aria-hidden="true" tabindex="-1"></a>          nn <span class="ot">&lt;-</span> nn <span class="sc">+</span> <span class="fu">nrow</span>(<span class="fu">data.frame</span>(my.missing.strata))</span>
<span id="cb70-467"><a href="annex-i-compendium-of-r-scripts.html#cb70-467" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-468"><a href="annex-i-compendium-of-r-scripts.html#cb70-468" aria-hidden="true" tabindex="-1"></a>        xx.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.strata,my.missing.strata)</span>
<span id="cb70-469"><a href="annex-i-compendium-of-r-scripts.html#cb70-469" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count))</span>
<span id="cb70-470"><a href="annex-i-compendium-of-r-scripts.html#cb70-470" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-471"><a href="annex-i-compendium-of-r-scripts.html#cb70-471" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb70-472"><a href="annex-i-compendium-of-r-scripts.html#cb70-472" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.strata)</span>
<span id="cb70-473"><a href="annex-i-compendium-of-r-scripts.html#cb70-473" aria-hidden="true" tabindex="-1"></a>      x.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.strata,xx.missing.strata)</span>
<span id="cb70-474"><a href="annex-i-compendium-of-r-scripts.html#cb70-474" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-475"><a href="annex-i-compendium-of-r-scripts.html#cb70-475" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-476"><a href="annex-i-compendium-of-r-scripts.html#cb70-476" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join initial sampling with missing sampling strata data</span></span>
<span id="cb70-477"><a href="annex-i-compendium-of-r-scripts.html#cb70-477" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.strata)</span>
<span id="cb70-478"><a href="annex-i-compendium-of-r-scripts.html#cb70-478" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-479"><a href="annex-i-compendium-of-r-scripts.html#cb70-479" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points for missing samples (regular sampling)</span></span>
<span id="cb70-480"><a href="annex-i-compendium-of-r-scripts.html#cb70-480" aria-hidden="true" tabindex="-1"></a>    x.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb70-481"><a href="annex-i-compendium-of-r-scripts.html#cb70-481" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-482"><a href="annex-i-compendium-of-r-scripts.html#cb70-482" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.sample){</span>
<span id="cb70-483"><a href="annex-i-compendium-of-r-scripts.html#cb70-483" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb70-484"><a href="annex-i-compendium-of-r-scripts.html#cb70-484" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb70-485"><a href="annex-i-compendium-of-r-scripts.html#cb70-485" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>)) {</span>
<span id="cb70-486"><a href="annex-i-compendium-of-r-scripts.html#cb70-486" aria-hidden="true" tabindex="-1"></a>        my.missing.sample <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb70-487"><a href="annex-i-compendium-of-r-scripts.html#cb70-487" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">size =</span> <span class="fu">as.numeric</span>(<span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,])[[<span class="dv">4</span>]])<span class="sc">+</span></span>
<span id="cb70-488"><a href="annex-i-compendium-of-r-scripts.html#cb70-488" aria-hidden="true" tabindex="-1"></a>                                          (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>), <span class="at">method =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb70-489"><a href="annex-i-compendium-of-r-scripts.html#cb70-489" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-490"><a href="annex-i-compendium-of-r-scripts.html#cb70-490" aria-hidden="true" tabindex="-1"></a>        xx.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.sample,my.missing.sample)</span>
<span id="cb70-491"><a href="annex-i-compendium-of-r-scripts.html#cb70-491" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count))</span>
<span id="cb70-492"><a href="annex-i-compendium-of-r-scripts.html#cb70-492" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-493"><a href="annex-i-compendium-of-r-scripts.html#cb70-493" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb70-494"><a href="annex-i-compendium-of-r-scripts.html#cb70-494" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.sample)</span>
<span id="cb70-495"><a href="annex-i-compendium-of-r-scripts.html#cb70-495" aria-hidden="true" tabindex="-1"></a>      x.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.sample,xx.missing.sample)</span>
<span id="cb70-496"><a href="annex-i-compendium-of-r-scripts.html#cb70-496" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-497"><a href="annex-i-compendium-of-r-scripts.html#cb70-497" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-498"><a href="annex-i-compendium-of-r-scripts.html#cb70-498" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join initial sampling with missing sampling strata data and with missing samples </span></span>
<span id="cb70-499"><a href="annex-i-compendium-of-r-scripts.html#cb70-499" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.sample)</span>
<span id="cb70-500"><a href="annex-i-compendium-of-r-scripts.html#cb70-500" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-501"><a href="annex-i-compendium-of-r-scripts.html#cb70-501" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove extra artificial replacements </span></span>
<span id="cb70-502"><a href="annex-i-compendium-of-r-scripts.html#cb70-502" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x[x<span class="sc">$</span>sample_count <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb70-503"><a href="annex-i-compendium-of-r-scripts.html#cb70-503" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-504"><a href="annex-i-compendium-of-r-scripts.html#cb70-504" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert and export to shapefile</span></span>
<span id="cb70-505"><a href="annex-i-compendium-of-r-scripts.html#cb70-505" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb70-506"><a href="annex-i-compendium-of-r-scripts.html#cb70-506" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb70-507"><a href="annex-i-compendium-of-r-scripts.html#cb70-507" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb70-508"><a href="annex-i-compendium-of-r-scripts.html#cb70-508" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb70-509"><a href="annex-i-compendium-of-r-scripts.html#cb70-509" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb70-510"><a href="annex-i-compendium-of-r-scripts.html#cb70-510" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb70-511"><a href="annex-i-compendium-of-r-scripts.html#cb70-511" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb70-512"><a href="annex-i-compendium-of-r-scripts.html#cb70-512" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb70-513"><a href="annex-i-compendium-of-r-scripts.html#cb70-513" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeVector</span>(z,</span>
<span id="cb70-514"><a href="annex-i-compendium-of-r-scripts.html#cb70-514" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(results.path,<span class="st">&quot;strat_randm_samples.shp&quot;</span>, <span class="at">overwrite=</span><span class="cn">TRUE</span>))</span>
<span id="cb70-515"><a href="annex-i-compendium-of-r-scripts.html#cb70-515" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-516"><a href="annex-i-compendium-of-r-scripts.html#cb70-516" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the number of initial target points equals the final target points </span></span>
<span id="cb70-517"><a href="annex-i-compendium-of-r-scripts.html#cb70-517" aria-hidden="true" tabindex="-1"></a>    n<span class="sc">==</span><span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb70-518"><a href="annex-i-compendium-of-r-scripts.html#cb70-518" aria-hidden="true" tabindex="-1"></a>    n;<span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb70-519"><a href="annex-i-compendium-of-r-scripts.html#cb70-519" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-520"><a href="annex-i-compendium-of-r-scripts.html#cb70-520" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb70-521"><a href="annex-i-compendium-of-r-scripts.html#cb70-521" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">11.4</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-522"><a href="annex-i-compendium-of-r-scripts.html#cb70-522" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb70-523"><a href="annex-i-compendium-of-r-scripts.html#cb70-523" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>) <span class="sc">+</span> </span>
<span id="cb70-524"><a href="annex-i-compendium-of-r-scripts.html#cb70-524" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(sf<span class="sc">::</span><span class="fu">st_as_sf</span>(z), <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;royalblue&#39;</span>, <span class="st">&#39;tomato&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Samples&quot;</span>)</span>
<span id="cb70-525"><a href="annex-i-compendium-of-r-scripts.html#cb70-525" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb70-526"><a href="annex-i-compendium-of-r-scripts.html#cb70-526" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-527"><a href="annex-i-compendium-of-r-scripts.html#cb70-527" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-528"><a href="annex-i-compendium-of-r-scripts.html#cb70-528" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Random Sampling based on a stratified raster</span></span>
<span id="cb70-529"><a href="annex-i-compendium-of-r-scripts.html#cb70-529" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>),<span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-530"><a href="annex-i-compendium-of-r-scripts.html#cb70-530" aria-hidden="true" tabindex="-1"></a>    strata<span class="sc">$</span>code <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(strata<span class="sc">$</span>code)</span>
<span id="cb70-531"><a href="annex-i-compendium-of-r-scripts.html#cb70-531" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-532"><a href="annex-i-compendium-of-r-scripts.html#cb70-532" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create stratification raster </span></span>
<span id="cb70-533"><a href="annex-i-compendium-of-r-scripts.html#cb70-533" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">st_rasterize</span>(strata[<span class="st">&quot;code&quot;</span>],<span class="fu">st_as_stars</span>(<span class="fu">st_bbox</span>(strata), <span class="at">nx =</span> <span class="dv">250</span>, <span class="at">ny =</span> <span class="dv">250</span>)))</span>
<span id="cb70-534"><a href="annex-i-compendium-of-r-scripts.html#cb70-534" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(strata) <span class="ot">&lt;-</span> <span class="st">&quot;strata&quot;</span></span>
<span id="cb70-535"><a href="annex-i-compendium-of-r-scripts.html#cb70-535" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> <span class="fu">crop</span>(strata, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb70-536"><a href="annex-i-compendium-of-r-scripts.html#cb70-536" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-537"><a href="annex-i-compendium-of-r-scripts.html#cb70-537" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create stratified random sampling</span></span>
<span id="cb70-538"><a href="annex-i-compendium-of-r-scripts.html#cb70-538" aria-hidden="true" tabindex="-1"></a>    target <span class="ot">&lt;-</span> <span class="fu">sample_strat</span>(</span>
<span id="cb70-539"><a href="annex-i-compendium-of-r-scripts.html#cb70-539" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb70-540"><a href="annex-i-compendium-of-r-scripts.html#cb70-540" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSamp =</span> <span class="dv">200</span></span>
<span id="cb70-541"><a href="annex-i-compendium-of-r-scripts.html#cb70-541" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-542"><a href="annex-i-compendium-of-r-scripts.html#cb70-542" aria-hidden="true" tabindex="-1"></a>    target<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;target&quot;</span></span>
<span id="cb70-543"><a href="annex-i-compendium-of-r-scripts.html#cb70-543" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-544"><a href="annex-i-compendium-of-r-scripts.html#cb70-544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Histogram of frequencies for targets</span></span>
<span id="cb70-545"><a href="annex-i-compendium-of-r-scripts.html#cb70-545" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_representation</span>(</span>
<span id="cb70-546"><a href="annex-i-compendium-of-r-scripts.html#cb70-546" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb70-547"><a href="annex-i-compendium-of-r-scripts.html#cb70-547" aria-hidden="true" tabindex="-1"></a>      <span class="at">existing =</span> target,</span>
<span id="cb70-548"><a href="annex-i-compendium-of-r-scripts.html#cb70-548" aria-hidden="true" tabindex="-1"></a>      <span class="at">drop=</span><span class="dv">0</span>,</span>
<span id="cb70-549"><a href="annex-i-compendium-of-r-scripts.html#cb70-549" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="cn">TRUE</span> </span>
<span id="cb70-550"><a href="annex-i-compendium-of-r-scripts.html#cb70-550" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-551"><a href="annex-i-compendium-of-r-scripts.html#cb70-551" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-552"><a href="annex-i-compendium-of-r-scripts.html#cb70-552" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add index by strata</span></span>
<span id="cb70-553"><a href="annex-i-compendium-of-r-scripts.html#cb70-553" aria-hidden="true" tabindex="-1"></a>    target <span class="ot">&lt;-</span> target <span class="sc">%&gt;%</span> </span>
<span id="cb70-554"><a href="annex-i-compendium-of-r-scripts.html#cb70-554" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb70-555"><a href="annex-i-compendium-of-r-scripts.html#cb70-555" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(strata) <span class="sc">%&gt;%</span> </span>
<span id="cb70-556"><a href="annex-i-compendium-of-r-scripts.html#cb70-556" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">sum</span>(n),</span>
<span id="cb70-557"><a href="annex-i-compendium-of-r-scripts.html#cb70-557" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(strata),</span>
<span id="cb70-558"><a href="annex-i-compendium-of-r-scripts.html#cb70-558" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(strata, <span class="st">&quot;.&quot;</span>, order)) <span class="sc">%&gt;%</span> </span>
<span id="cb70-559"><a href="annex-i-compendium-of-r-scripts.html#cb70-559" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb70-560"><a href="annex-i-compendium-of-r-scripts.html#cb70-560" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-561"><a href="annex-i-compendium-of-r-scripts.html#cb70-561" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Histogram of frequencies for replacements</span></span>
<span id="cb70-562"><a href="annex-i-compendium-of-r-scripts.html#cb70-562" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_representation</span>(</span>
<span id="cb70-563"><a href="annex-i-compendium-of-r-scripts.html#cb70-563" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb70-564"><a href="annex-i-compendium-of-r-scripts.html#cb70-564" aria-hidden="true" tabindex="-1"></a>      <span class="at">existing =</span> replacement,</span>
<span id="cb70-565"><a href="annex-i-compendium-of-r-scripts.html#cb70-565" aria-hidden="true" tabindex="-1"></a>      <span class="at">drop=</span><span class="dv">0</span>,</span>
<span id="cb70-566"><a href="annex-i-compendium-of-r-scripts.html#cb70-566" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="cn">TRUE</span> </span>
<span id="cb70-567"><a href="annex-i-compendium-of-r-scripts.html#cb70-567" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-568"><a href="annex-i-compendium-of-r-scripts.html#cb70-568" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-569"><a href="annex-i-compendium-of-r-scripts.html#cb70-569" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add index by strata</span></span>
<span id="cb70-570"><a href="annex-i-compendium-of-r-scripts.html#cb70-570" aria-hidden="true" tabindex="-1"></a>    replacement <span class="ot">&lt;-</span> replacement <span class="sc">%&gt;%</span> </span>
<span id="cb70-571"><a href="annex-i-compendium-of-r-scripts.html#cb70-571" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb70-572"><a href="annex-i-compendium-of-r-scripts.html#cb70-572" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(strata) <span class="sc">%&gt;%</span> </span>
<span id="cb70-573"><a href="annex-i-compendium-of-r-scripts.html#cb70-573" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">sum</span>(n),</span>
<span id="cb70-574"><a href="annex-i-compendium-of-r-scripts.html#cb70-574" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(strata),</span>
<span id="cb70-575"><a href="annex-i-compendium-of-r-scripts.html#cb70-575" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(strata, <span class="st">&quot;.&quot;</span>, order)) <span class="sc">%&gt;%</span> </span>
<span id="cb70-576"><a href="annex-i-compendium-of-r-scripts.html#cb70-576" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb70-577"><a href="annex-i-compendium-of-r-scripts.html#cb70-577" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-578"><a href="annex-i-compendium-of-r-scripts.html#cb70-578" aria-hidden="true" tabindex="-1"></a>    replacement <span class="ot">&lt;-</span> <span class="fu">sample_strat</span>(</span>
<span id="cb70-579"><a href="annex-i-compendium-of-r-scripts.html#cb70-579" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb70-580"><a href="annex-i-compendium-of-r-scripts.html#cb70-580" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSamp =</span> <span class="dv">200</span><span class="sc">*</span><span class="dv">3</span></span>
<span id="cb70-581"><a href="annex-i-compendium-of-r-scripts.html#cb70-581" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-582"><a href="annex-i-compendium-of-r-scripts.html#cb70-582" aria-hidden="true" tabindex="-1"></a>    replacement<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;replacement&quot;</span></span>
<span id="cb70-583"><a href="annex-i-compendium-of-r-scripts.html#cb70-583" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-584"><a href="annex-i-compendium-of-r-scripts.html#cb70-584" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot samples over strata</span></span>
<span id="cb70-585"><a href="annex-i-compendium-of-r-scripts.html#cb70-585" aria-hidden="true" tabindex="-1"></a>      <span class="co"># plot(strata, main=&quot;Strata and random samples&quot;)</span></span>
<span id="cb70-586"><a href="annex-i-compendium-of-r-scripts.html#cb70-586" aria-hidden="true" tabindex="-1"></a>      <span class="co"># plot(nghe[1], col=&quot;transparent&quot;, add=TRUE)</span></span>
<span id="cb70-587"><a href="annex-i-compendium-of-r-scripts.html#cb70-587" aria-hidden="true" tabindex="-1"></a>      <span class="co"># points(target,col=&quot;red&quot;)</span></span>
<span id="cb70-588"><a href="annex-i-compendium-of-r-scripts.html#cb70-588" aria-hidden="true" tabindex="-1"></a>      <span class="co"># points(replacement,col=&quot;dodgerblue&quot;)</span></span>
<span id="cb70-589"><a href="annex-i-compendium-of-r-scripts.html#cb70-589" aria-hidden="true" tabindex="-1"></a>      <span class="co"># legend(&quot;topleft&quot;, legend = c(&quot;target&quot;,&quot;replacement&quot;), pch = 20, xpd=NA, bg=&quot;white&quot;, col=c(&quot;red&quot;,&quot;dodgerblue&quot;))</span></span>
<span id="cb70-590"><a href="annex-i-compendium-of-r-scripts.html#cb70-590" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-591"><a href="annex-i-compendium-of-r-scripts.html#cb70-591" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">8.3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-592"><a href="annex-i-compendium-of-r-scripts.html#cb70-592" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb70-593"><a href="annex-i-compendium-of-r-scripts.html#cb70-593" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>) <span class="sc">+</span> </span>
<span id="cb70-594"><a href="annex-i-compendium-of-r-scripts.html#cb70-594" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(target, <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;tomato&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Target&quot;</span>) <span class="sc">+</span> </span>
<span id="cb70-595"><a href="annex-i-compendium-of-r-scripts.html#cb70-595" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(replacement, <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;royalblue&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Replacement&quot;</span>)</span>
<span id="cb70-596"><a href="annex-i-compendium-of-r-scripts.html#cb70-596" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span></code></pre></div>
</div>
<div id="script-6-conditional-latin-hypercube-sampling" class="section level2 unnumbered hasAnchor">
<h2>Script 6: Conditional Latin Hypercube Sampling<a href="annex-i-compendium-of-r-scripts.html#script-6-conditional-latin-hypercube-sampling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="annex-i-compendium-of-r-scripts.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb71-2"><a href="annex-i-compendium-of-r-scripts.html#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb71-3"><a href="annex-i-compendium-of-r-scripts.html#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb71-4"><a href="annex-i-compendium-of-r-scripts.html#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co"># conditional Latin Hypercube Sampling</span></span>
<span id="cb71-5"><a href="annex-i-compendium-of-r-scripts.html#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb71-6"><a href="annex-i-compendium-of-r-scripts.html#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb71-7"><a href="annex-i-compendium-of-r-scripts.html#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb71-8"><a href="annex-i-compendium-of-r-scripts.html#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="annex-i-compendium-of-r-scripts.html#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb71-10"><a href="annex-i-compendium-of-r-scripts.html#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="annex-i-compendium-of-r-scripts.html#cb71-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empty environment and cache </span></span>
<span id="cb71-12"><a href="annex-i-compendium-of-r-scripts.html#cb71-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb71-13"><a href="annex-i-compendium-of-r-scripts.html#cb71-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb71-14"><a href="annex-i-compendium-of-r-scripts.html#cb71-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-15"><a href="annex-i-compendium-of-r-scripts.html#cb71-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script ========================================</span></span>
<span id="cb71-16"><a href="annex-i-compendium-of-r-scripts.html#cb71-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-17"><a href="annex-i-compendium-of-r-scripts.html#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Script for creating a sampling design based on conditioned Latin Hypercube Sampling.</span></span>
<span id="cb71-18"><a href="annex-i-compendium-of-r-scripts.html#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Given a suite of covariates this algorithm will assess the optimal location of</span></span>
<span id="cb71-19"><a href="annex-i-compendium-of-r-scripts.html#cb71-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  samples based on the amount of information in the set of covariates.</span></span>
<span id="cb71-20"><a href="annex-i-compendium-of-r-scripts.html#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb71-21"><a href="annex-i-compendium-of-r-scripts.html#cb71-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load packages</span></span>
<span id="cb71-22"><a href="annex-i-compendium-of-r-scripts.html#cb71-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb71-23"><a href="annex-i-compendium-of-r-scripts.html#cb71-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import national data </span></span>
<span id="cb71-24"><a href="annex-i-compendium-of-r-scripts.html#cb71-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Compute clhs</span></span>
<span id="cb71-25"><a href="annex-i-compendium-of-r-scripts.html#cb71-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Including existing legacy data in a cLHS sampling design </span></span>
<span id="cb71-26"><a href="annex-i-compendium-of-r-scripts.html#cb71-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Working with large raster data</span></span>
<span id="cb71-27"><a href="annex-i-compendium-of-r-scripts.html#cb71-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Cost–constrained cLHS sampling</span></span>
<span id="cb71-28"><a href="annex-i-compendium-of-r-scripts.html#cb71-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Replacement areas in cLHS design</span></span>
<span id="cb71-29"><a href="annex-i-compendium-of-r-scripts.html#cb71-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Polygonize replacement areas by similarity   </span></span>
<span id="cb71-30"><a href="annex-i-compendium-of-r-scripts.html#cb71-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Constrained cLHS sampling accounting for accessibility and legacy data  </span></span>
<span id="cb71-31"><a href="annex-i-compendium-of-r-scripts.html#cb71-31" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb71-32"><a href="annex-i-compendium-of-r-scripts.html#cb71-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-33"><a href="annex-i-compendium-of-r-scripts.html#cb71-33" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb71-34"><a href="annex-i-compendium-of-r-scripts.html#cb71-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-35"><a href="annex-i-compendium-of-r-scripts.html#cb71-35" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load packages =================================</span></span>
<span id="cb71-36"><a href="annex-i-compendium-of-r-scripts.html#cb71-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-37"><a href="annex-i-compendium-of-r-scripts.html#cb71-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#remotes::install_github(&quot;lemuscanovas/synoptReg&quot;)</span></span>
<span id="cb71-38"><a href="annex-i-compendium-of-r-scripts.html#cb71-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-39"><a href="annex-i-compendium-of-r-scripts.html#cb71-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb71-40"><a href="annex-i-compendium-of-r-scripts.html#cb71-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb71-41"><a href="annex-i-compendium-of-r-scripts.html#cb71-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb71-42"><a href="annex-i-compendium-of-r-scripts.html#cb71-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-43"><a href="annex-i-compendium-of-r-scripts.html#cb71-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of packages</span></span>
<span id="cb71-44"><a href="annex-i-compendium-of-r-scripts.html#cb71-44" aria-hidden="true" tabindex="-1"></a>  packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;terra&quot;</span>,<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sf&quot;</span>,<span class="st">&quot;clhs&quot;</span>, <span class="st">&quot;sgsR&quot;</span>,<span class="st">&quot;entropy&quot;</span>, <span class="st">&quot;tripack&quot;</span>,</span>
<span id="cb71-45"><a href="annex-i-compendium-of-r-scripts.html#cb71-45" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;manipulate&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;synoptReg&quot;</span>)</span>
<span id="cb71-46"><a href="annex-i-compendium-of-r-scripts.html#cb71-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages</span></span>
<span id="cb71-47"><a href="annex-i-compendium-of-r-scripts.html#cb71-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-48"><a href="annex-i-compendium-of-r-scripts.html#cb71-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove object to save memory space</span></span>
<span id="cb71-49"><a href="annex-i-compendium-of-r-scripts.html#cb71-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(packages) </span>
<span id="cb71-50"><a href="annex-i-compendium-of-r-scripts.html#cb71-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-51"><a href="annex-i-compendium-of-r-scripts.html#cb71-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-52"><a href="annex-i-compendium-of-r-scripts.html#cb71-52" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb71-53"><a href="annex-i-compendium-of-r-scripts.html#cb71-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to rasters</span></span>
<span id="cb71-54"><a href="annex-i-compendium-of-r-scripts.html#cb71-54" aria-hidden="true" tabindex="-1"></a>  raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters/&quot;</span></span>
<span id="cb71-55"><a href="annex-i-compendium-of-r-scripts.html#cb71-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to shapes</span></span>
<span id="cb71-56"><a href="annex-i-compendium-of-r-scripts.html#cb71-56" aria-hidden="true" tabindex="-1"></a>  shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes/&quot;</span></span>
<span id="cb71-57"><a href="annex-i-compendium-of-r-scripts.html#cb71-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to results</span></span>
<span id="cb71-58"><a href="annex-i-compendium-of-r-scripts.html#cb71-58" aria-hidden="true" tabindex="-1"></a>  results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb71-59"><a href="annex-i-compendium-of-r-scripts.html#cb71-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to additional data</span></span>
<span id="cb71-60"><a href="annex-i-compendium-of-r-scripts.html#cb71-60" aria-hidden="true" tabindex="-1"></a>  other.path <span class="ot">&lt;-</span> <span class="st">&quot;data/other/&quot;</span></span>
<span id="cb71-61"><a href="annex-i-compendium-of-r-scripts.html#cb71-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Buffer distance for replacement areas (clhs)</span></span>
<span id="cb71-62"><a href="annex-i-compendium-of-r-scripts.html#cb71-62" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co"># Buffer distance to calculate replacement areas </span></span>
<span id="cb71-63"><a href="annex-i-compendium-of-r-scripts.html#cb71-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the minimum sample size. By default it uses the value calculated previously</span></span>
<span id="cb71-64"><a href="annex-i-compendium-of-r-scripts.html#cb71-64" aria-hidden="true" tabindex="-1"></a>  minimum_n <span class="ot">&lt;-</span> <span class="dv">180</span></span>
<span id="cb71-65"><a href="annex-i-compendium-of-r-scripts.html#cb71-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregation factor for up-scaling raster covariates (optional)</span></span>
<span id="cb71-66"><a href="annex-i-compendium-of-r-scripts.html#cb71-66" aria-hidden="true" tabindex="-1"></a>  agg.factor <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb71-67"><a href="annex-i-compendium-of-r-scripts.html#cb71-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-68"><a href="annex-i-compendium-of-r-scripts.html#cb71-68" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Import national data ====================================================</span></span>
<span id="cb71-69"><a href="annex-i-compendium-of-r-scripts.html#cb71-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-70"><a href="annex-i-compendium-of-r-scripts.html#cb71-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb71-71"><a href="annex-i-compendium-of-r-scripts.html#cb71-71" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(raster.path, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-72"><a href="annex-i-compendium-of-r-scripts.html#cb71-72" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat) <span class="co"># SpatRaster from terra</span></span>
<span id="cb71-73"><a href="annex-i-compendium-of-r-scripts.html#cb71-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load shape of district</span></span>
<span id="cb71-74"><a href="annex-i-compendium-of-r-scripts.html#cb71-74" aria-hidden="true" tabindex="-1"></a>  nghe <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/Nghe_An.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-75"><a href="annex-i-compendium-of-r-scripts.html#cb71-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-76"><a href="annex-i-compendium-of-r-scripts.html#cb71-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crop covariates on administrative boundary</span></span>
<span id="cb71-77"><a href="annex-i-compendium-of-r-scripts.html#cb71-77" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-78"><a href="annex-i-compendium-of-r-scripts.html#cb71-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store elevation and slope separately</span></span>
<span id="cb71-79"><a href="annex-i-compendium-of-r-scripts.html#cb71-79" aria-hidden="true" tabindex="-1"></a>  elevation <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_elevation_250m</span>
<span id="cb71-80"><a href="annex-i-compendium-of-r-scripts.html#cb71-80" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_slope_250m</span>
<span id="cb71-81"><a href="annex-i-compendium-of-r-scripts.html#cb71-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-82"><a href="annex-i-compendium-of-r-scripts.html#cb71-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load roads</span></span>
<span id="cb71-83"><a href="annex-i-compendium-of-r-scripts.html#cb71-83" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span>  sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/roads.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-84"><a href="annex-i-compendium-of-r-scripts.html#cb71-84" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span>  <span class="fu">st_intersection</span>(roads, nghe)</span>
<span id="cb71-85"><a href="annex-i-compendium-of-r-scripts.html#cb71-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-86"><a href="annex-i-compendium-of-r-scripts.html#cb71-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simplify raster information with PCA</span></span>
<span id="cb71-87"><a href="annex-i-compendium-of-r-scripts.html#cb71-87" aria-hidden="true" tabindex="-1"></a>  pca <span class="ot">&lt;-</span> <span class="fu">raster_pca</span>(cov.dat)</span>
<span id="cb71-88"><a href="annex-i-compendium-of-r-scripts.html#cb71-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-89"><a href="annex-i-compendium-of-r-scripts.html#cb71-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get SpatRaster layers</span></span>
<span id="cb71-90"><a href="annex-i-compendium-of-r-scripts.html#cb71-90" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb71-91"><a href="annex-i-compendium-of-r-scripts.html#cb71-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset rasters</span></span>
<span id="cb71-92"><a href="annex-i-compendium-of-r-scripts.html#cb71-92" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb71-93"><a href="annex-i-compendium-of-r-scripts.html#cb71-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove pca stack</span></span>
<span id="cb71-94"><a href="annex-i-compendium-of-r-scripts.html#cb71-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(pca)</span>
<span id="cb71-95"><a href="annex-i-compendium-of-r-scripts.html#cb71-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-96"><a href="annex-i-compendium-of-r-scripts.html#cb71-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate stack to simplify data rasters for calculations </span></span>
<span id="cb71-97"><a href="annex-i-compendium-of-r-scripts.html#cb71-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cov.dat &lt;- aggregate(cov.dat, fact=10, fun=&quot;mean&quot;)</span></span>
<span id="cb71-98"><a href="annex-i-compendium-of-r-scripts.html#cb71-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-99"><a href="annex-i-compendium-of-r-scripts.html#cb71-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot of covariates</span></span>
<span id="cb71-100"><a href="annex-i-compendium-of-r-scripts.html#cb71-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat)</span>
<span id="cb71-101"><a href="annex-i-compendium-of-r-scripts.html#cb71-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-102"><a href="annex-i-compendium-of-r-scripts.html#cb71-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-103"><a href="annex-i-compendium-of-r-scripts.html#cb71-103" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 - Compute clhs ============================================================</span></span>
<span id="cb71-104"><a href="annex-i-compendium-of-r-scripts.html#cb71-104" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb71-105"><a href="annex-i-compendium-of-r-scripts.html#cb71-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Distribute sampling points with clhs</span></span>
<span id="cb71-106"><a href="annex-i-compendium-of-r-scripts.html#cb71-106" aria-hidden="true" tabindex="-1"></a>  pts <span class="ot">&lt;-</span>  <span class="fu">sample_clhs</span>(cov.dat, <span class="at">nSamp =</span> <span class="dv">100</span>, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb71-107"><a href="annex-i-compendium-of-r-scripts.html#cb71-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot cLHS samples on map</span></span>
<span id="cb71-108"><a href="annex-i-compendium-of-r-scripts.html#cb71-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples&quot;</span>)</span>
<span id="cb71-109"><a href="annex-i-compendium-of-r-scripts.html#cb71-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(pts, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb71-110"><a href="annex-i-compendium-of-r-scripts.html#cb71-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-111"><a href="annex-i-compendium-of-r-scripts.html#cb71-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-112"><a href="annex-i-compendium-of-r-scripts.html#cb71-112" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 - Including existing legacy data in a cLHS sampling design ================</span></span>
<span id="cb71-113"><a href="annex-i-compendium-of-r-scripts.html#cb71-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-114"><a href="annex-i-compendium-of-r-scripts.html#cb71-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create an artificial random legacy dataset of 50 samples over the study area as an example</span></span>
<span id="cb71-115"><a href="annex-i-compendium-of-r-scripts.html#cb71-115" aria-hidden="true" tabindex="-1"></a>  legacy.data <span class="ot">&lt;-</span> <span class="fu">sample_srs</span>( <span class="at">raster =</span> cov.dat, <span class="at">nSamp =</span> <span class="dv">50</span>)</span>
<span id="cb71-116"><a href="annex-i-compendium-of-r-scripts.html#cb71-116" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb71-117"><a href="annex-i-compendium-of-r-scripts.html#cb71-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate clhs 100 points plus locations of legacy data</span></span>
<span id="cb71-118"><a href="annex-i-compendium-of-r-scripts.html#cb71-118" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span>  <span class="fu">sample_clhs</span>(cov.dat, <span class="at">nSamp =</span> <span class="dv">150</span>, <span class="at">existing=</span>legacy.data, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb71-119"><a href="annex-i-compendium-of-r-scripts.html#cb71-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-120"><a href="annex-i-compendium-of-r-scripts.html#cb71-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot points</span></span>
<span id="cb71-121"><a href="annex-i-compendium-of-r-scripts.html#cb71-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples (blue circles) and legacy samples (red diamonds)&quot;</span>)</span>
<span id="cb71-122"><a href="annex-i-compendium-of-r-scripts.html#cb71-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(res, <span class="at">col=</span><span class="st">&quot;navy&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb71-123"><a href="annex-i-compendium-of-r-scripts.html#cb71-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(res[res<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;existing&quot;</span>,], <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">5</span>, <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb71-124"><a href="annex-i-compendium-of-r-scripts.html#cb71-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-125"><a href="annex-i-compendium-of-r-scripts.html#cb71-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-126"><a href="annex-i-compendium-of-r-scripts.html#cb71-126" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 - Working with large raster data ==========================================</span></span>
<span id="cb71-127"><a href="annex-i-compendium-of-r-scripts.html#cb71-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-128"><a href="annex-i-compendium-of-r-scripts.html#cb71-128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scaling covariates</span></span>
<span id="cb71-129"><a href="annex-i-compendium-of-r-scripts.html#cb71-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregation of covariates by a factor of 10. </span></span>
<span id="cb71-130"><a href="annex-i-compendium-of-r-scripts.html#cb71-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The original grid resolution is up-scaled using the mean value of the pixels in the grid</span></span>
<span id="cb71-131"><a href="annex-i-compendium-of-r-scripts.html#cb71-131" aria-hidden="true" tabindex="-1"></a>    cov.dat2 <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(cov.dat, <span class="at">fact=</span><span class="dv">10</span>, <span class="at">fun=</span><span class="st">&quot;mean&quot;</span>)</span>
<span id="cb71-132"><a href="annex-i-compendium-of-r-scripts.html#cb71-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create clhs samples upon the resamples rasters  </span></span>
<span id="cb71-133"><a href="annex-i-compendium-of-r-scripts.html#cb71-133" aria-hidden="true" tabindex="-1"></a>    resampled.clhs <span class="ot">&lt;-</span> <span class="fu">sample_clhs</span>(cov.dat2, <span class="at">nSamp =</span> <span class="dv">150</span>, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb71-134"><a href="annex-i-compendium-of-r-scripts.html#cb71-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the points over the 1st raster</span></span>
<span id="cb71-135"><a href="annex-i-compendium-of-r-scripts.html#cb71-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat2[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;Regular resampled data&quot;</span>)</span>
<span id="cb71-136"><a href="annex-i-compendium-of-r-scripts.html#cb71-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(resampled.clhs , <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb71-137"><a href="annex-i-compendium-of-r-scripts.html#cb71-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(cov.dat2)</span>
<span id="cb71-138"><a href="annex-i-compendium-of-r-scripts.html#cb71-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-139"><a href="annex-i-compendium-of-r-scripts.html#cb71-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sampling to regular points</span></span>
<span id="cb71-140"><a href="annex-i-compendium-of-r-scripts.html#cb71-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a regular grid of 1000 points on the covariate space</span></span>
<span id="cb71-141"><a href="annex-i-compendium-of-r-scripts.html#cb71-141" aria-hidden="true" tabindex="-1"></a>    regular.sample <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(cov.dat, <span class="at">size =</span> <span class="dv">1000</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">method=</span><span class="st">&quot;regular&quot;</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-142"><a href="annex-i-compendium-of-r-scripts.html#cb71-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot the points over the 1st raster</span></span>
<span id="cb71-143"><a href="annex-i-compendium-of-r-scripts.html#cb71-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;Regular resampled data&quot;</span>)</span>
<span id="cb71-144"><a href="annex-i-compendium-of-r-scripts.html#cb71-144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(regular.sample, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb71-145"><a href="annex-i-compendium-of-r-scripts.html#cb71-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-146"><a href="annex-i-compendium-of-r-scripts.html#cb71-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create clhs samples upon the regular grid  </span></span>
<span id="cb71-147"><a href="annex-i-compendium-of-r-scripts.html#cb71-147" aria-hidden="true" tabindex="-1"></a>    regular.sample.clhs <span class="ot">&lt;-</span> <span class="fu">clhs</span>(regular.sample, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb71-148"><a href="annex-i-compendium-of-r-scripts.html#cb71-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot points of clhs samples</span></span>
<span id="cb71-149"><a href="annex-i-compendium-of-r-scripts.html#cb71-149" aria-hidden="true" tabindex="-1"></a>    points <span class="ot">&lt;-</span> regular.sample.clhs<span class="sc">$</span>sampled_data <span class="co"># Get point coordinates of clhs sampling</span></span>
<span id="cb71-150"><a href="annex-i-compendium-of-r-scripts.html#cb71-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples (red) and covariate resampled points (blue)&quot;</span>)</span>
<span id="cb71-151"><a href="annex-i-compendium-of-r-scripts.html#cb71-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(regular.sample, <span class="at">col=</span><span class="st">&quot;navy&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb71-152"><a href="annex-i-compendium-of-r-scripts.html#cb71-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(points, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">cex=</span><span class="dv">1</span>)</span>
<span id="cb71-153"><a href="annex-i-compendium-of-r-scripts.html#cb71-153" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb71-154"><a href="annex-i-compendium-of-r-scripts.html#cb71-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-155"><a href="annex-i-compendium-of-r-scripts.html#cb71-155" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 - Cost–constrained cLHS sampling</span></span>
<span id="cb71-156"><a href="annex-i-compendium-of-r-scripts.html#cb71-156" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use &#39;Distance to roads&#39; as cost surface</span></span>
<span id="cb71-157"><a href="annex-i-compendium-of-r-scripts.html#cb71-157" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate distance to roads with te same spatial definition than the covariates</span></span>
<span id="cb71-158"><a href="annex-i-compendium-of-r-scripts.html#cb71-158" aria-hidden="true" tabindex="-1"></a>      <span class="co"># dist2access &lt;- terra::distance(cov.dat[[1]], roads, progress=TRUE)</span></span>
<span id="cb71-159"><a href="annex-i-compendium-of-r-scripts.html#cb71-159" aria-hidden="true" tabindex="-1"></a>      <span class="co"># names(dist2access) &lt;- &quot;dist2access&quot;</span></span>
<span id="cb71-160"><a href="annex-i-compendium-of-r-scripts.html#cb71-160" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save cost surface to disk</span></span>
<span id="cb71-161"><a href="annex-i-compendium-of-r-scripts.html#cb71-161" aria-hidden="true" tabindex="-1"></a>      <span class="co"># writeRaster(dist2access, paste0(other.path,&quot;nghe_d2roads.tif&quot;), overwrite=TRUE)</span></span>
<span id="cb71-162"><a href="annex-i-compendium-of-r-scripts.html#cb71-162" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb71-163"><a href="annex-i-compendium-of-r-scripts.html#cb71-163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load pre-calculated distance–to–roads surface</span></span>
<span id="cb71-164"><a href="annex-i-compendium-of-r-scripts.html#cb71-164" aria-hidden="true" tabindex="-1"></a>    dist2access <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="fu">paste0</span>(other.path,<span class="st">&quot;nghe_d2roads.tif&quot;</span>))</span>
<span id="cb71-165"><a href="annex-i-compendium-of-r-scripts.html#cb71-165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate to the same soatial definition</span></span>
<span id="cb71-166"><a href="annex-i-compendium-of-r-scripts.html#cb71-166" aria-hidden="true" tabindex="-1"></a>     <span class="co"># dist2access &lt;- aggregate(dist2access, fact=10, fun=&quot;mean&quot;)</span></span>
<span id="cb71-167"><a href="annex-i-compendium-of-r-scripts.html#cb71-167" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(dist2access)</span>
<span id="cb71-168"><a href="annex-i-compendium-of-r-scripts.html#cb71-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(nghe, <span class="at">col=</span><span class="st">&quot;transparent&quot;</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-169"><a href="annex-i-compendium-of-r-scripts.html#cb71-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-170"><a href="annex-i-compendium-of-r-scripts.html#cb71-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add cost surface (distance to roads) as layer</span></span>
<span id="cb71-171"><a href="annex-i-compendium-of-r-scripts.html#cb71-171" aria-hidden="true" tabindex="-1"></a>    cov.dat <span class="ot">&lt;-</span> <span class="fu">c</span>(cov.dat,dist2access)</span>
<span id="cb71-172"><a href="annex-i-compendium-of-r-scripts.html#cb71-172" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(cov.dat)</span>
<span id="cb71-173"><a href="annex-i-compendium-of-r-scripts.html#cb71-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-174"><a href="annex-i-compendium-of-r-scripts.html#cb71-174" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Harmonize NAs</span></span>
<span id="cb71-175"><a href="annex-i-compendium-of-r-scripts.html#cb71-175" aria-hidden="true" tabindex="-1"></a>    cov.dat<span class="sc">$</span>dist2access <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dist2access <span class="sc">*</span> cov.dat[[<span class="dv">1</span>]]<span class="sc">/</span>cov.dat[[<span class="dv">1</span>]]</span>
<span id="cb71-176"><a href="annex-i-compendium-of-r-scripts.html#cb71-176" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat<span class="sc">$</span>dist2access)</span>
<span id="cb71-177"><a href="annex-i-compendium-of-r-scripts.html#cb71-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(nghe, <span class="at">col=</span><span class="st">&quot;transparent&quot;</span>,<span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-178"><a href="annex-i-compendium-of-r-scripts.html#cb71-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-179"><a href="annex-i-compendium-of-r-scripts.html#cb71-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points</span></span>
<span id="cb71-180"><a href="annex-i-compendium-of-r-scripts.html#cb71-180" aria-hidden="true" tabindex="-1"></a>    cost.clhs <span class="ot">&lt;-</span> <span class="fu">sample_clhs</span>(cov.dat, <span class="at">nSamp =</span> minimum_n, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">cost =</span> <span class="st">&#39;dist2access&#39;</span>,  <span class="at">use.cpp =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-181"><a href="annex-i-compendium-of-r-scripts.html#cb71-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-182"><a href="annex-i-compendium-of-r-scripts.html#cb71-182" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot samples</span></span>
<span id="cb71-183"><a href="annex-i-compendium-of-r-scripts.html#cb71-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="st">&#39;dist2access&#39;</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples with &#39;cost&#39; constraints&quot;</span>)</span>
<span id="cb71-184"><a href="annex-i-compendium-of-r-scripts.html#cb71-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cost.clhs, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">cex=</span><span class="dv">1</span>,<span class="at">add=</span>T)</span>
<span id="cb71-185"><a href="annex-i-compendium-of-r-scripts.html#cb71-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-186"><a href="annex-i-compendium-of-r-scripts.html#cb71-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-187"><a href="annex-i-compendium-of-r-scripts.html#cb71-187" aria-hidden="true" tabindex="-1"></a><span class="do">## 7 - Replacement areas in cLHS design (requires raster package)</span></span>
<span id="cb71-188"><a href="annex-i-compendium-of-r-scripts.html#cb71-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-189"><a href="annex-i-compendium-of-r-scripts.html#cb71-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the similarity to points in a buffer of distance &#39;D&#39;</span></span>
<span id="cb71-190"><a href="annex-i-compendium-of-r-scripts.html#cb71-190" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the buffers around points # cov25??</span></span>
<span id="cb71-191"><a href="annex-i-compendium-of-r-scripts.html#cb71-191" aria-hidden="true" tabindex="-1"></a>    gw <span class="ot">&lt;-</span> <span class="fu">similarity_buffer</span>(raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat) ,  <span class="fu">as</span>(cost.clhs, <span class="st">&quot;Spatial&quot;</span>), <span class="at">buffer =</span> D)</span>
<span id="cb71-192"><a href="annex-i-compendium-of-r-scripts.html#cb71-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-193"><a href="annex-i-compendium-of-r-scripts.html#cb71-193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb71-194"><a href="annex-i-compendium-of-r-scripts.html#cb71-194" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(elevation, <span class="at">legend=</span><span class="cn">TRUE</span>,<span class="at">main=</span><span class="fu">paste</span>(<span class="st">&quot;Similarity probability over elevation&quot;</span>))</span>
<span id="cb71-195"><a href="annex-i-compendium-of-r-scripts.html#cb71-195" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Overlay points</span></span>
<span id="cb71-196"><a href="annex-i-compendium-of-r-scripts.html#cb71-196" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(cost.clhs, <span class="at">col =</span> <span class="st">&quot;dodgerblue&quot;</span>, <span class="at">pch =</span> <span class="dv">3</span>)</span>
<span id="cb71-197"><a href="annex-i-compendium-of-r-scripts.html#cb71-197" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Overlay probability stack for point 1</span></span>
<span id="cb71-198"><a href="annex-i-compendium-of-r-scripts.html#cb71-198" aria-hidden="true" tabindex="-1"></a>    colors <span class="ot">&lt;-</span> <span class="fu">c</span>((RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">9</span>, <span class="st">&quot;YlOrRd&quot;</span>)))</span>
<span id="cb71-199"><a href="annex-i-compendium-of-r-scripts.html#cb71-199" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">plot</span>(gw[[<span class="dv">1</span>]], <span class="at">add=</span><span class="cn">TRUE</span> ,  <span class="at">legend=</span><span class="cn">FALSE</span>, <span class="at">col=</span>colors)</span>
<span id="cb71-200"><a href="annex-i-compendium-of-r-scripts.html#cb71-200" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Overlay 1st cLHS point</span></span>
<span id="cb71-201"><a href="annex-i-compendium-of-r-scripts.html#cb71-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(cost.clhs[<span class="dv">1</span>,], <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">12</span>,<span class="at">cex=</span><span class="dv">1</span>)</span>
<span id="cb71-202"><a href="annex-i-compendium-of-r-scripts.html#cb71-202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-203"><a href="annex-i-compendium-of-r-scripts.html#cb71-203" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Polygonize replacement areas by similarity    </span></span>
<span id="cb71-204"><a href="annex-i-compendium-of-r-scripts.html#cb71-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-205"><a href="annex-i-compendium-of-r-scripts.html#cb71-205" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine a threshold break to delineate replacement areas</span></span>
<span id="cb71-206"><a href="annex-i-compendium-of-r-scripts.html#cb71-206" aria-hidden="true" tabindex="-1"></a>    similarity_threshold <span class="ot">&lt;-</span> <span class="fl">0.90</span></span>
<span id="cb71-207"><a href="annex-i-compendium-of-r-scripts.html#cb71-207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reclassify buffer raster data according to the threshold break of probability</span></span>
<span id="cb71-208"><a href="annex-i-compendium-of-r-scripts.html#cb71-208" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1 = similarity &gt;= similarity_break; NA =  similarity &lt;  similarity_break</span></span>
<span id="cb71-209"><a href="annex-i-compendium-of-r-scripts.html#cb71-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a vector with the break intervals and the output values (NA,1) </span></span>
<span id="cb71-210"><a href="annex-i-compendium-of-r-scripts.html#cb71-210" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, similarity_threshold, <span class="cn">NA</span>, similarity_threshold, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb71-211"><a href="annex-i-compendium-of-r-scripts.html#cb71-211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to a matrix</span></span>
<span id="cb71-212"><a href="annex-i-compendium-of-r-scripts.html#cb71-212" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">matrix</span>(breaks, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-213"><a href="annex-i-compendium-of-r-scripts.html#cb71-213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reclassify the data in the layers from probabilities to (NA,)</span></span>
<span id="cb71-214"><a href="annex-i-compendium-of-r-scripts.html#cb71-214" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">=</span> <span class="fu">stack</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>raster<span class="sc">::</span><span class="fu">nlayers</span>(gw), <span class="cf">function</span>(i){raster<span class="sc">::</span><span class="fu">reclassify</span>(gw[[i]], breaks, <span class="at">right=</span><span class="cn">FALSE</span>)}))</span>
<span id="cb71-215"><a href="annex-i-compendium-of-r-scripts.html#cb71-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-216"><a href="annex-i-compendium-of-r-scripts.html#cb71-216" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Polygonize replacement areas </span></span>
<span id="cb71-217"><a href="annex-i-compendium-of-r-scripts.html#cb71-217" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">as.list</span>(s), rasterToPolygons, <span class="at">dissolve=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-218"><a href="annex-i-compendium-of-r-scripts.html#cb71-218" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">bind</span>(s,<span class="at">keepnames=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-219"><a href="annex-i-compendium-of-r-scripts.html#cb71-219" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the identifier of the corresponding target point</span></span>
<span id="cb71-220"><a href="annex-i-compendium-of-r-scripts.html#cb71-220" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(s)){</span>
<span id="cb71-221"><a href="annex-i-compendium-of-r-scripts.html#cb71-221" aria-hidden="true" tabindex="-1"></a>      s<span class="sc">@</span>data<span class="sc">$</span>ID[i] <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(stringr<span class="sc">::</span><span class="fu">str_replace</span>(s<span class="sc">@</span>polygons[[i]]<span class="sc">@</span>ID,<span class="st">&quot;1.&quot;</span>,<span class="st">&quot;&quot;</span>))</span>
<span id="cb71-222"><a href="annex-i-compendium-of-r-scripts.html#cb71-222" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb71-223"><a href="annex-i-compendium-of-r-scripts.html#cb71-223" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean the data by storing target ID data only</span></span>
<span id="cb71-224"><a href="annex-i-compendium-of-r-scripts.html#cb71-224" aria-hidden="true" tabindex="-1"></a>    s<span class="sc">@</span>data <span class="ot">&lt;-</span> s<span class="sc">@</span>data[<span class="st">&quot;ID&quot;</span>]</span>
<span id="cb71-225"><a href="annex-i-compendium-of-r-scripts.html#cb71-225" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-226"><a href="annex-i-compendium-of-r-scripts.html#cb71-226" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb71-227"><a href="annex-i-compendium-of-r-scripts.html#cb71-227" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="fu">paste</span>(<span class="st">&quot;cLHS samples and replacement areas for threshold = &quot;</span>, similarity_threshold))</span>
<span id="cb71-228"><a href="annex-i-compendium-of-r-scripts.html#cb71-228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(s,<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="cn">NA</span>, <span class="at">border=</span><span class="st">&quot;gray40&quot;</span>)</span>
<span id="cb71-229"><a href="annex-i-compendium-of-r-scripts.html#cb71-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(cost.clhs, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">3</span>)</span>
<span id="cb71-230"><a href="annex-i-compendium-of-r-scripts.html#cb71-230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-231"><a href="annex-i-compendium-of-r-scripts.html#cb71-231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Export replacement areas to shapefile </span></span>
<span id="cb71-232"><a href="annex-i-compendium-of-r-scripts.html#cb71-232" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(s)</span>
<span id="cb71-233"><a href="annex-i-compendium-of-r-scripts.html#cb71-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(s, <span class="fu">file.path</span>(<span class="fu">paste0</span>(results.path,<span class="st">&#39;replacement_areas_&#39;</span>, D, <span class="st">&#39;.shp&#39;</span>)), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-234"><a href="annex-i-compendium-of-r-scripts.html#cb71-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-235"><a href="annex-i-compendium-of-r-scripts.html#cb71-235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write cLHS sampling points to shapefile</span></span>
<span id="cb71-236"><a href="annex-i-compendium-of-r-scripts.html#cb71-236" aria-hidden="true" tabindex="-1"></a>    cost.clhs<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="fu">row</span>(cost.clhs)[,<span class="dv">1</span>] <span class="co"># Add identifier</span></span>
<span id="cb71-237"><a href="annex-i-compendium-of-r-scripts.html#cb71-237" aria-hidden="true" tabindex="-1"></a>    out.pts <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(cost.clhs)</span>
<span id="cb71-238"><a href="annex-i-compendium-of-r-scripts.html#cb71-238" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(out.pts, <span class="fu">paste0</span>(results.path,<span class="st">&#39;target_clhs.shp&#39;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-239"><a href="annex-i-compendium-of-r-scripts.html#cb71-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-240"><a href="annex-i-compendium-of-r-scripts.html#cb71-240" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb71-241"><a href="annex-i-compendium-of-r-scripts.html#cb71-241" aria-hidden="true" tabindex="-1"></a><span class="do">## 9 - Constrained cLHS sampling taking into account accessibility and legacy data  </span></span>
<span id="cb71-242"><a href="annex-i-compendium-of-r-scripts.html#cb71-242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load legacy data </span></span>
<span id="cb71-243"><a href="annex-i-compendium-of-r-scripts.html#cb71-243" aria-hidden="true" tabindex="-1"></a>    legacy <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/legacy_soils.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-244"><a href="annex-i-compendium-of-r-scripts.html#cb71-244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-245"><a href="annex-i-compendium-of-r-scripts.html#cb71-245" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add slope to the stack</span></span>
<span id="cb71-246"><a href="annex-i-compendium-of-r-scripts.html#cb71-246" aria-hidden="true" tabindex="-1"></a>    cov.dat<span class="sc">$</span>slope <span class="ot">&lt;-</span> slope</span>
<span id="cb71-247"><a href="annex-i-compendium-of-r-scripts.html#cb71-247" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate clhs points with legacy, cost and buffer to roads</span></span>
<span id="cb71-248"><a href="annex-i-compendium-of-r-scripts.html#cb71-248" aria-hidden="true" tabindex="-1"></a>    buff_inner<span class="ot">=</span><span class="dv">20</span>;</span>
<span id="cb71-249"><a href="annex-i-compendium-of-r-scripts.html#cb71-249" aria-hidden="true" tabindex="-1"></a>    buff_outer<span class="ot">=</span><span class="dv">3000</span></span>
<span id="cb71-250"><a href="annex-i-compendium-of-r-scripts.html#cb71-250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert roads to sf object and cast to multilinestring</span></span>
<span id="cb71-251"><a href="annex-i-compendium-of-r-scripts.html#cb71-251" aria-hidden="true" tabindex="-1"></a>    roads <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(roads) <span class="sc">%&gt;%</span></span>
<span id="cb71-252"><a href="annex-i-compendium-of-r-scripts.html#cb71-252" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_cast</span>(<span class="st">&quot;MULTILINESTRING&quot;</span>) </span>
<span id="cb71-253"><a href="annex-i-compendium-of-r-scripts.html#cb71-253" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-254"><a href="annex-i-compendium-of-r-scripts.html#cb71-254" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate clhs samples using slope as cost surface, distance to roads as</span></span>
<span id="cb71-255"><a href="annex-i-compendium-of-r-scripts.html#cb71-255" aria-hidden="true" tabindex="-1"></a>    <span class="co"># access limitations, and including existing legacy data</span></span>
<span id="cb71-256"><a href="annex-i-compendium-of-r-scripts.html#cb71-256" aria-hidden="true" tabindex="-1"></a>    aa <span class="ot">&lt;-</span> sgsR<span class="sc">::</span><span class="fu">sample_clhs</span>(<span class="at">mraster =</span> cov.dat, <span class="at">nSamp =</span> minimum_n, <span class="at">existing =</span> legacy,</span>
<span id="cb71-257"><a href="annex-i-compendium-of-r-scripts.html#cb71-257" aria-hidden="true" tabindex="-1"></a>                            <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">details =</span> <span class="cn">TRUE</span>, <span class="at">cost=</span><span class="st">&quot;slope&quot;</span>, <span class="at">access=</span>roads,</span>
<span id="cb71-258"><a href="annex-i-compendium-of-r-scripts.html#cb71-258" aria-hidden="true" tabindex="-1"></a>                            <span class="at">buff_inner=</span>buff_inner, <span class="at">buff_outer=</span>buff_outer)</span>
<span id="cb71-259"><a href="annex-i-compendium-of-r-scripts.html#cb71-259" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-260"><a href="annex-i-compendium-of-r-scripts.html#cb71-260" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Plot distances, roads, clhs points and legacy data </span></span>
<span id="cb71-261"><a href="annex-i-compendium-of-r-scripts.html#cb71-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat<span class="sc">$</span>dist2access, <span class="at">main=</span><span class="st">&quot;New (red) and existing (blue) samples&quot;</span>)</span>
<span id="cb71-262"><a href="annex-i-compendium-of-r-scripts.html#cb71-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(roads,<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">&quot;gray60&quot;</span>)</span>
<span id="cb71-263"><a href="annex-i-compendium-of-r-scripts.html#cb71-263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(aa<span class="sc">$</span>samples[aa<span class="sc">$</span>samples<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;new&quot;</span>,], <span class="at">col=</span> <span class="st">&quot;tomato&quot;</span>,<span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-264"><a href="annex-i-compendium-of-r-scripts.html#cb71-264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(aa<span class="sc">$</span>samples[aa<span class="sc">$</span>samples<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;existing&quot;</span>,], <span class="at">col=</span> <span class="st">&quot;dodgerblue2&quot;</span>,<span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-265"><a href="annex-i-compendium-of-r-scripts.html#cb71-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-266"><a href="annex-i-compendium-of-r-scripts.html#cb71-266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write samples as shapefile</span></span>
<span id="cb71-267"><a href="annex-i-compendium-of-r-scripts.html#cb71-267" aria-hidden="true" tabindex="-1"></a>    aa<span class="sc">$</span>samples[<span class="fu">c</span>(<span class="st">&quot;type&quot;</span>,<span class="st">&quot;dist2access&quot;</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb71-268"><a href="annex-i-compendium-of-r-scripts.html#cb71-268" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(<span class="fu">paste0</span>(results.path,<span class="st">&#39;const_clhs.shp&#39;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-269"><a href="annex-i-compendium-of-r-scripts.html#cb71-269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-270"><a href="annex-i-compendium-of-r-scripts.html#cb71-270" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-271"><a href="annex-i-compendium-of-r-scripts.html#cb71-271" aria-hidden="true" tabindex="-1"></a><span class="do">## 10 - Calculate COOBS ========================================================</span></span>
<span id="cb71-272"><a href="annex-i-compendium-of-r-scripts.html#cb71-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_coobs</span>(</span>
<span id="cb71-273"><a href="annex-i-compendium-of-r-scripts.html#cb71-273" aria-hidden="true" tabindex="-1"></a>      <span class="at">mraster =</span> cov.dat,</span>
<span id="cb71-274"><a href="annex-i-compendium-of-r-scripts.html#cb71-274" aria-hidden="true" tabindex="-1"></a>      <span class="at">existing =</span> cost.clhs,</span>
<span id="cb71-275"><a href="annex-i-compendium-of-r-scripts.html#cb71-275" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="cn">TRUE</span>,</span>
<span id="cb71-276"><a href="annex-i-compendium-of-r-scripts.html#cb71-276" aria-hidden="true" tabindex="-1"></a>      <span class="at">cores =</span> <span class="dv">4</span></span>
<span id="cb71-277"><a href="annex-i-compendium-of-r-scripts.html#cb71-277" aria-hidden="true" tabindex="-1"></a>    )    </span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="conditioned-latin-hypercube-sampling.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/luislado/Sampling_Design_GSP/edit/master/11-Compendium-of-code.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Technical Manual Soil Sampling Design.pdf", "Technical Manual Soil Sampling Design.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "static"
}
});
});
</script>

</body>

</html>
