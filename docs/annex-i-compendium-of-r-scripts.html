<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Annex I: Compendium of R scripts |  Soil Sampling Design</title>
  <meta name="description" content="Soil Sampling Design - SoilFer Project" />
  <meta name="generator" content="bookdown 0.36 and GitBook 2.6.7" />

  <meta property="og:title" content="Annex I: Compendium of R scripts |  Soil Sampling Design" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/images/frontcover.png" />
  <meta property="og:description" content="Soil Sampling Design - SoilFer Project" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Annex I: Compendium of R scripts |  Soil Sampling Design" />
  
  <meta name="twitter:description" content="Soil Sampling Design - SoilFer Project" />
  <meta name="twitter:image" content="/images/frontcover.png" />

<meta name="author" content="Rodríguez Lado, L., Angelini, M.E, Naypewe, N., Luotto, I., Yigini, Y." />


<meta name="date" content="2024-01-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="conditioned-latin-hypercube-sampling.html"/>
<link rel="next" href="references.html"/>
<script src="assets/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="assets/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="assets/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="assets/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="assets/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="assets/plotly-binding-4.10.0/plotly.js"></script>
<script src="assets/typedarray-0.1/typedarray.min.js"></script>
<link href="assets/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="assets/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="assets/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="assets/plotly-main-2.5.1/plotly-latest.min.js"></script>
<link href="assets/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="assets/leaflet-1.3.1/leaflet.js"></script>
<link href="assets/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="assets/proj4-2.6.2/proj4.min.js"></script>
<script src="assets/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="assets/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="assets/leaflet-binding-2.1.1/leaflet.js"></script>
<link href="assets/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="assets/HomeButton-0.0.1/home-button.js"></script>
<script src="assets/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="assets/clipboard-0.0.1/setClipboardText.js"></script>
<link href="assets/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="assets/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="assets/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="assets/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil Samping Design</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#training-material"><i class="fa fa-check"></i><b>1.1</b> Training material</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html"><i class="fa fa-check"></i><b>2</b> Setting-up the software environment</a>
<ul>
<li class="chapter" data-level="2.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#use-of-r-rstudio-and-r-packages"><i class="fa fa-check"></i><b>2.1</b> Use of R, RStudio and R Packages</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-r"><i class="fa fa-check"></i><b>2.1.1</b> Obtaining and installing R</a></li>
<li class="chapter" data-level="2.1.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-rstudio"><i class="fa fa-check"></i><b>2.1.2</b> Obtaining and installing RStudio</a></li>
<li class="chapter" data-level="2.1.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#getting-started-with-r"><i class="fa fa-check"></i><b>2.1.3</b> Getting started with R</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-packages"><i class="fa fa-check"></i><b>2.2</b> R packages</a></li>
<li class="chapter" data-level="2.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#gee---google-earth-engine"><i class="fa fa-check"></i><b>2.3</b> GEE - google earth engine</a></li>
</ul></li>
<li class="part"><span><b>Part one – Soil Legacy Data</b></span></li>
<li class="chapter" data-level="3" data-path="legacy_data.html"><a href="legacy_data.html"><i class="fa fa-check"></i><b>3</b> Evaluating Soil Legacy Data Sampling for DSM</a>
<ul>
<li class="chapter" data-level="3.1" data-path="legacy_data.html"><a href="legacy_data.html#data-preparation"><i class="fa fa-check"></i><b>3.1</b> Data Preparation</a></li>
<li class="chapter" data-level="3.2" data-path="legacy_data.html"><a href="legacy_data.html#representativeness-of-the-legacy-soil-data"><i class="fa fa-check"></i><b>3.2</b> Representativeness of the Legacy Soil Data</a></li>
</ul></li>
<li class="part"><span><b>I Part two – Soil Sampling Design</b></span></li>
<li class="chapter" data-level="4" data-path="determining-the-minimum-sampling-size.html"><a href="determining-the-minimum-sampling-size.html"><i class="fa fa-check"></i><b>4</b> Determining the minimum sampling size</a></li>
<li class="chapter" data-level="5" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html"><i class="fa fa-check"></i><b>5</b> Stratified Sampling Design</a>
<ul>
<li class="chapter" data-level="5.1" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#general-procedure"><i class="fa fa-check"></i><b>5.1</b> General Procedure</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#strata-creation"><i class="fa fa-check"></i><b>5.1.1</b> Strata creation</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#stratified-random-sampling"><i class="fa fa-check"></i><b>5.2</b> Stratified random sampling</a></li>
<li class="chapter" data-level="5.3" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#stratified-random-sampling-for-large-areas"><i class="fa fa-check"></i><b>5.3</b> Stratified random sampling for large areas</a></li>
<li class="chapter" data-level="5.4" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#stratified-regular-sampling"><i class="fa fa-check"></i><b>5.4</b> Stratified regular sampling</a></li>
<li class="chapter" data-level="5.5" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#random-sampling-based-on-a-stratified-raster"><i class="fa fa-check"></i><b>5.5</b> Random Sampling based on a stratified raster</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html"><i class="fa fa-check"></i><b>6</b> Conditioned Latin Hypercube Sampling</a>
<ul>
<li class="chapter" data-level="6.1" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#clhs-design"><i class="fa fa-check"></i><b>6.1</b> cLHS Design</a></li>
<li class="chapter" data-level="6.2" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#including-existing-legacy-data-in-a-clhs-sampling-design"><i class="fa fa-check"></i><b>6.2</b> Including existing legacy data in a cLHS sampling design</a></li>
<li class="chapter" data-level="6.3" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#working-with-large-raster-data"><i class="fa fa-check"></i><b>6.3</b> Working with large raster data</a></li>
<li class="chapter" data-level="6.4" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#implementation-of-costconstrained-clhs-sampling"><i class="fa fa-check"></i><b>6.4</b> Implementation of cost–constrained cLHS sampling</a></li>
<li class="chapter" data-level="6.5" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#replacement-areas-in-clhs-design"><i class="fa fa-check"></i><b>6.5</b> Replacement areas in cLHS design</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html"><i class="fa fa-check"></i>Annex I: Compendium of R scripts</a>
<ul>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-1-introduction-to-r"><i class="fa fa-check"></i>Script 1: Introduction to R</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-2-download-environmental-covariates"><i class="fa fa-check"></i>Script 2: Download environmental covariates</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-3-evaluate-legacy-data"><i class="fa fa-check"></i>Script 3: Evaluate Legacy Data</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-4-calculate-minimum-sample-size"><i class="fa fa-check"></i>Script 4: Calculate Minimum Sample Size</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-5-stratified-sampling-on-vector-data"><i class="fa fa-check"></i>Script 5: Stratified sampling on vector data</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-6-conditional-latin-hypercube-sampling"><i class="fa fa-check"></i>Script 6: Conditional Latin Hypercube Sampling</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://www.fao.org/global-soil-partnership/" target="blank">Global Soil Partnership</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p><img src="images/frontcover.jpg" style="top:0px;height:150px;" align="right" />
Soil Sampling Design</p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="annex-i-compendium-of-r-scripts" class="section level1 unnumbered hasAnchor">
<h1>Annex I: Compendium of R scripts<a href="annex-i-compendium-of-r-scripts.html#annex-i-compendium-of-r-scripts" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter compiles the complete list of R scripts involved in the process of soil sampling design.</p>
<div id="script-1-introduction-to-r" class="section level2 unnumbered hasAnchor">
<h2>Script 1: Introduction to R<a href="annex-i-compendium-of-r-scripts.html#script-1-introduction-to-r" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="annex-i-compendium-of-r-scripts.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduction to R</span></span>
<span id="cb50-2"><a href="annex-i-compendium-of-r-scripts.html#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="annex-i-compendium-of-r-scripts.html#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 0. Playground =================================================</span></span>
<span id="cb50-4"><a href="annex-i-compendium-of-r-scripts.html#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="annex-i-compendium-of-r-scripts.html#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># learn important keyboard shortcuts</span></span>
<span id="cb50-6"><a href="annex-i-compendium-of-r-scripts.html#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ctrl + enter for running code</span></span>
<span id="cb50-7"><a href="annex-i-compendium-of-r-scripts.html#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co"># tab after writing the first three </span></span>
<span id="cb50-8"><a href="annex-i-compendium-of-r-scripts.html#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co"># characters of the function name</span></span>
<span id="cb50-9"><a href="annex-i-compendium-of-r-scripts.html#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="co"># F1 to access the help</span></span>
<span id="cb50-10"><a href="annex-i-compendium-of-r-scripts.html#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="annex-i-compendium-of-r-scripts.html#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="co"># explore the use of &lt;-, $, [], ==, !=, c(), :, </span></span>
<span id="cb50-12"><a href="annex-i-compendium-of-r-scripts.html#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="co"># data.frame(), list(), as.factor()</span></span>
<span id="cb50-13"><a href="annex-i-compendium-of-r-scripts.html#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="annex-i-compendium-of-r-scripts.html#cb50-14" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">15</span></span>
<span id="cb50-15"><a href="annex-i-compendium-of-r-scripts.html#cb50-15" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">2</span>]</span>
<span id="cb50-16"><a href="annex-i-compendium-of-r-scripts.html#cb50-16" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb50-17"><a href="annex-i-compendium-of-r-scripts.html#cb50-17" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;a&quot;</span>, a )</span>
<span id="cb50-18"><a href="annex-i-compendium-of-r-scripts.html#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(b)</span>
<span id="cb50-19"><a href="annex-i-compendium-of-r-scripts.html#cb50-19" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">column_a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="at">column_b =</span> b)</span>
<span id="cb50-20"><a href="annex-i-compendium-of-r-scripts.html#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="annex-i-compendium-of-r-scripts.html#cb50-21" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">1</span>]</span>
<span id="cb50-22"><a href="annex-i-compendium-of-r-scripts.html#cb50-22" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>column_b</span>
<span id="cb50-23"><a href="annex-i-compendium-of-r-scripts.html#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(df<span class="sc">$</span>column_b)</span>
<span id="cb50-24"><a href="annex-i-compendium-of-r-scripts.html#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df)</span>
<span id="cb50-25"><a href="annex-i-compendium-of-r-scripts.html#cb50-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-26"><a href="annex-i-compendium-of-r-scripts.html#cb50-26" aria-hidden="true" tabindex="-1"></a>df[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,]</span>
<span id="cb50-27"><a href="annex-i-compendium-of-r-scripts.html#cb50-27" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">1</span>]</span>
<span id="cb50-28"><a href="annex-i-compendium-of-r-scripts.html#cb50-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-29"><a href="annex-i-compendium-of-r-scripts.html#cb50-29" aria-hidden="true" tabindex="-1"></a><span class="fu">as.factor</span>(b)</span>
<span id="cb50-30"><a href="annex-i-compendium-of-r-scripts.html#cb50-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-31"><a href="annex-i-compendium-of-r-scripts.html#cb50-31" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">list</span>(a, b, df)</span>
<span id="cb50-32"><a href="annex-i-compendium-of-r-scripts.html#cb50-32" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb50-33"><a href="annex-i-compendium-of-r-scripts.html#cb50-33" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d)</span>
<span id="cb50-34"><a href="annex-i-compendium-of-r-scripts.html#cb50-34" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;numeric_vector&quot;</span>, <span class="st">&quot;character_vector&quot;</span>, <span class="st">&quot;dataframe&quot;</span>)</span>
<span id="cb50-35"><a href="annex-i-compendium-of-r-scripts.html#cb50-35" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb50-36"><a href="annex-i-compendium-of-r-scripts.html#cb50-36" aria-hidden="true" tabindex="-1"></a>d[[<span class="dv">1</span>]]</span>
<span id="cb50-37"><a href="annex-i-compendium-of-r-scripts.html#cb50-37" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>numeric_vector</span>
<span id="cb50-38"><a href="annex-i-compendium-of-r-scripts.html#cb50-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-39"><a href="annex-i-compendium-of-r-scripts.html#cb50-39" aria-hidden="true" tabindex="-1"></a>a <span class="sc">==</span> b</span>
<span id="cb50-40"><a href="annex-i-compendium-of-r-scripts.html#cb50-40" aria-hidden="true" tabindex="-1"></a>a <span class="sc">!=</span> b</span>
<span id="cb50-41"><a href="annex-i-compendium-of-r-scripts.html#cb50-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-42"><a href="annex-i-compendium-of-r-scripts.html#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Set working directory ======================================</span></span>
<span id="cb50-43"><a href="annex-i-compendium-of-r-scripts.html#cb50-43" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;C:/GIT/Digital-Soil-Mapping/&quot;</span>)</span>
<span id="cb50-44"><a href="annex-i-compendium-of-r-scripts.html#cb50-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-45"><a href="annex-i-compendium-of-r-scripts.html#cb50-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Install and load packages ==================================</span></span>
<span id="cb50-46"><a href="annex-i-compendium-of-r-scripts.html#cb50-46" aria-hidden="true" tabindex="-1"></a><span class="co"># readxl, tidyverse, and data.table packages using the functions</span></span>
<span id="cb50-47"><a href="annex-i-compendium-of-r-scripts.html#cb50-47" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb50-48"><a href="annex-i-compendium-of-r-scripts.html#cb50-48" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb50-49"><a href="annex-i-compendium-of-r-scripts.html#cb50-49" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;data.table&quot;</span>)</span>
<span id="cb50-50"><a href="annex-i-compendium-of-r-scripts.html#cb50-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb50-51"><a href="annex-i-compendium-of-r-scripts.html#cb50-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb50-52"><a href="annex-i-compendium-of-r-scripts.html#cb50-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb50-53"><a href="annex-i-compendium-of-r-scripts.html#cb50-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-54"><a href="annex-i-compendium-of-r-scripts.html#cb50-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Import an spreadsheet ======================================</span></span>
<span id="cb50-55"><a href="annex-i-compendium-of-r-scripts.html#cb50-55" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.1 Read the MS Excel file -----------------------------------</span></span>
<span id="cb50-56"><a href="annex-i-compendium-of-r-scripts.html#cb50-56" aria-hidden="true" tabindex="-1"></a><span class="co">#Read the soil_data.xlsx file, spreadsheet 2, using read_excel </span></span>
<span id="cb50-57"><a href="annex-i-compendium-of-r-scripts.html#cb50-57" aria-hidden="true" tabindex="-1"></a><span class="fu">read_excel</span>(<span class="at">path =</span> <span class="st">&quot;01-Data/soil_data.xlsx&quot;</span>, <span class="at">sheet =</span> <span class="dv">2</span>)</span>
<span id="cb50-58"><a href="annex-i-compendium-of-r-scripts.html#cb50-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-59"><a href="annex-i-compendium-of-r-scripts.html#cb50-59" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.2 Read the csv file with the native function ---------------</span></span>
<span id="cb50-60"><a href="annex-i-compendium-of-r-scripts.html#cb50-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 01-Data/horizon.csv</span></span>
<span id="cb50-61"><a href="annex-i-compendium-of-r-scripts.html#cb50-61" aria-hidden="true" tabindex="-1"></a><span class="fu">read.csv</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb50-62"><a href="annex-i-compendium-of-r-scripts.html#cb50-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-63"><a href="annex-i-compendium-of-r-scripts.html#cb50-63" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.3 Read the csv file with the tidyverse function ------------</span></span>
<span id="cb50-64"><a href="annex-i-compendium-of-r-scripts.html#cb50-64" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb50-65"><a href="annex-i-compendium-of-r-scripts.html#cb50-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-66"><a href="annex-i-compendium-of-r-scripts.html#cb50-66" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.4 Read the csv file with the data.table function -----------</span></span>
<span id="cb50-67"><a href="annex-i-compendium-of-r-scripts.html#cb50-67" aria-hidden="true" tabindex="-1"></a><span class="fu">fread</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb50-68"><a href="annex-i-compendium-of-r-scripts.html#cb50-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-69"><a href="annex-i-compendium-of-r-scripts.html#cb50-69" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.5 Assign the dataframe to an object called dat -------------</span></span>
<span id="cb50-70"><a href="annex-i-compendium-of-r-scripts.html#cb50-70" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb50-71"><a href="annex-i-compendium-of-r-scripts.html#cb50-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-72"><a href="annex-i-compendium-of-r-scripts.html#cb50-72" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Tidyverse functions ========================================</span></span>
<span id="cb50-73"><a href="annex-i-compendium-of-r-scripts.html#cb50-73" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.1 Select pid, hip, top, bottom, ph_h2o, cec from dat -------</span></span>
<span id="cb50-74"><a href="annex-i-compendium-of-r-scripts.html#cb50-74" aria-hidden="true" tabindex="-1"></a>dat_1 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb50-75"><a href="annex-i-compendium-of-r-scripts.html#cb50-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id_prof, id_hor, top, bottom, ph_h2o, cec)</span>
<span id="cb50-76"><a href="annex-i-compendium-of-r-scripts.html#cb50-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-77"><a href="annex-i-compendium-of-r-scripts.html#cb50-77" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.2 Filter: pick observations by their values ----------------</span></span>
<span id="cb50-78"><a href="annex-i-compendium-of-r-scripts.html#cb50-78" aria-hidden="true" tabindex="-1"></a><span class="co"># filter observations with cec &gt; 50 cmolc/100g</span></span>
<span id="cb50-79"><a href="annex-i-compendium-of-r-scripts.html#cb50-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-80"><a href="annex-i-compendium-of-r-scripts.html#cb50-80" aria-hidden="true" tabindex="-1"></a>dat_2 <span class="ot">&lt;-</span> dat_1 <span class="sc">%&gt;%</span> </span>
<span id="cb50-81"><a href="annex-i-compendium-of-r-scripts.html#cb50-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(cec <span class="sc">&gt;</span> <span class="dv">30</span>)</span>
<span id="cb50-82"><a href="annex-i-compendium-of-r-scripts.html#cb50-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-83"><a href="annex-i-compendium-of-r-scripts.html#cb50-83" aria-hidden="true" tabindex="-1"></a>dat_2</span>
<span id="cb50-84"><a href="annex-i-compendium-of-r-scripts.html#cb50-84" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.3 Mutate: create a new variable ----------------------------</span></span>
<span id="cb50-85"><a href="annex-i-compendium-of-r-scripts.html#cb50-85" aria-hidden="true" tabindex="-1"></a><span class="co"># thickness = top - bottom</span></span>
<span id="cb50-86"><a href="annex-i-compendium-of-r-scripts.html#cb50-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-87"><a href="annex-i-compendium-of-r-scripts.html#cb50-87" aria-hidden="true" tabindex="-1"></a>dat_3 <span class="ot">&lt;-</span> dat_2 <span class="sc">%&gt;%</span> </span>
<span id="cb50-88"><a href="annex-i-compendium-of-r-scripts.html#cb50-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">thickness =</span> bottom <span class="sc">-</span> top)</span>
<span id="cb50-89"><a href="annex-i-compendium-of-r-scripts.html#cb50-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-90"><a href="annex-i-compendium-of-r-scripts.html#cb50-90" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.4 Group_by and summarise -----------------------------------</span></span>
<span id="cb50-91"><a href="annex-i-compendium-of-r-scripts.html#cb50-91" aria-hidden="true" tabindex="-1"></a><span class="co"># group by variable pid</span></span>
<span id="cb50-92"><a href="annex-i-compendium-of-r-scripts.html#cb50-92" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise taking the mean of pH and cec</span></span>
<span id="cb50-93"><a href="annex-i-compendium-of-r-scripts.html#cb50-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-94"><a href="annex-i-compendium-of-r-scripts.html#cb50-94" aria-hidden="true" tabindex="-1"></a>dat_4 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb50-95"><a href="annex-i-compendium-of-r-scripts.html#cb50-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_prof) <span class="sc">%&gt;%</span> </span>
<span id="cb50-96"><a href="annex-i-compendium-of-r-scripts.html#cb50-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_ph =</span> <span class="fu">mean</span>(ph_h2o),</span>
<span id="cb50-97"><a href="annex-i-compendium-of-r-scripts.html#cb50-97" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_cec =</span> <span class="fu">mean</span>(cec))</span>
<span id="cb50-98"><a href="annex-i-compendium-of-r-scripts.html#cb50-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-99"><a href="annex-i-compendium-of-r-scripts.html#cb50-99" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.5 Reshape the table using pivot_longer ---------------------</span></span>
<span id="cb50-100"><a href="annex-i-compendium-of-r-scripts.html#cb50-100" aria-hidden="true" tabindex="-1"></a><span class="co"># use dat_3</span></span>
<span id="cb50-101"><a href="annex-i-compendium-of-r-scripts.html#cb50-101" aria-hidden="true" tabindex="-1"></a><span class="co"># put the names of the variables ph_h2o, </span></span>
<span id="cb50-102"><a href="annex-i-compendium-of-r-scripts.html#cb50-102" aria-hidden="true" tabindex="-1"></a><span class="co"># cec and thickness in the column </span></span>
<span id="cb50-103"><a href="annex-i-compendium-of-r-scripts.html#cb50-103" aria-hidden="true" tabindex="-1"></a><span class="co"># variable and keep the rest of the table. Save in dat_5 </span></span>
<span id="cb50-104"><a href="annex-i-compendium-of-r-scripts.html#cb50-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-105"><a href="annex-i-compendium-of-r-scripts.html#cb50-105" aria-hidden="true" tabindex="-1"></a>dat_5 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb50-106"><a href="annex-i-compendium-of-r-scripts.html#cb50-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(ph_h2o<span class="sc">:</span>thickness, <span class="at">names_to =</span> <span class="st">&quot;soil_property&quot;</span>,</span>
<span id="cb50-107"><a href="annex-i-compendium-of-r-scripts.html#cb50-107" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>)</span>
<span id="cb50-108"><a href="annex-i-compendium-of-r-scripts.html#cb50-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-109"><a href="annex-i-compendium-of-r-scripts.html#cb50-109" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.6 Join the table sites.csv with dat_3 ----------------------</span></span>
<span id="cb50-110"><a href="annex-i-compendium-of-r-scripts.html#cb50-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Load soil_phys_data030.csv (in 01-Data folder) </span></span>
<span id="cb50-111"><a href="annex-i-compendium-of-r-scripts.html#cb50-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Join its columns with dat_3 keeping all the rows of dat_3</span></span>
<span id="cb50-112"><a href="annex-i-compendium-of-r-scripts.html#cb50-112" aria-hidden="true" tabindex="-1"></a><span class="co"># save the result as dat_6</span></span>
<span id="cb50-113"><a href="annex-i-compendium-of-r-scripts.html#cb50-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-114"><a href="annex-i-compendium-of-r-scripts.html#cb50-114" aria-hidden="true" tabindex="-1"></a>phys <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/soil_phys_data030.csv&quot;</span>)</span>
<span id="cb50-115"><a href="annex-i-compendium-of-r-scripts.html#cb50-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-116"><a href="annex-i-compendium-of-r-scripts.html#cb50-116" aria-hidden="true" tabindex="-1"></a>phys <span class="ot">&lt;-</span> phys <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">id_prof =</span> <span class="st">&quot;ProfID&quot;</span>)</span>
<span id="cb50-117"><a href="annex-i-compendium-of-r-scripts.html#cb50-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-118"><a href="annex-i-compendium-of-r-scripts.html#cb50-118" aria-hidden="true" tabindex="-1"></a>dat_6 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb50-119"><a href="annex-i-compendium-of-r-scripts.html#cb50-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(phys)</span>
<span id="cb50-120"><a href="annex-i-compendium-of-r-scripts.html#cb50-120" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb50-121"><a href="annex-i-compendium-of-r-scripts.html#cb50-121" aria-hidden="true" tabindex="-1"></a>dat_6 <span class="ot">&lt;-</span> phys <span class="sc">%&gt;%</span> </span>
<span id="cb50-122"><a href="annex-i-compendium-of-r-scripts.html#cb50-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(dat_3)</span>
<span id="cb50-123"><a href="annex-i-compendium-of-r-scripts.html#cb50-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-124"><a href="annex-i-compendium-of-r-scripts.html#cb50-124" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Data visualization with ggplot2 ============================</span></span>
<span id="cb50-125"><a href="annex-i-compendium-of-r-scripts.html#cb50-125" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.1 1D plot: histograms --------------------------------------</span></span>
<span id="cb50-126"><a href="annex-i-compendium-of-r-scripts.html#cb50-126" aria-hidden="true" tabindex="-1"></a><span class="co"># histograms of cec and ph_h2o</span></span>
<span id="cb50-127"><a href="annex-i-compendium-of-r-scripts.html#cb50-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-128"><a href="annex-i-compendium-of-r-scripts.html#cb50-128" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x=</span>cec)) <span class="sc">+</span> <span class="fu">geom_histogram</span>()</span>
<span id="cb50-129"><a href="annex-i-compendium-of-r-scripts.html#cb50-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-130"><a href="annex-i-compendium-of-r-scripts.html#cb50-130" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.2 2D plot: scatterplot -------------------------------------</span></span>
<span id="cb50-131"><a href="annex-i-compendium-of-r-scripts.html#cb50-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot bottom vs. ph_h2o</span></span>
<span id="cb50-132"><a href="annex-i-compendium-of-r-scripts.html#cb50-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-133"><a href="annex-i-compendium-of-r-scripts.html#cb50-133" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o)) <span class="sc">+</span> </span>
<span id="cb50-134"><a href="annex-i-compendium-of-r-scripts.html#cb50-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() </span>
<span id="cb50-135"><a href="annex-i-compendium-of-r-scripts.html#cb50-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-136"><a href="annex-i-compendium-of-r-scripts.html#cb50-136" aria-hidden="true" tabindex="-1"></a><span class="co"># add a fitting line</span></span>
<span id="cb50-137"><a href="annex-i-compendium-of-r-scripts.html#cb50-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-138"><a href="annex-i-compendium-of-r-scripts.html#cb50-138" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o)) <span class="sc">+</span> </span>
<span id="cb50-139"><a href="annex-i-compendium-of-r-scripts.html#cb50-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb50-140"><a href="annex-i-compendium-of-r-scripts.html#cb50-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span> )</span>
<span id="cb50-141"><a href="annex-i-compendium-of-r-scripts.html#cb50-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-142"><a href="annex-i-compendium-of-r-scripts.html#cb50-142" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.3 3D plot: scatterplot -------------------------------------</span></span>
<span id="cb50-143"><a href="annex-i-compendium-of-r-scripts.html#cb50-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot bottom vs. ph_h2o, add clay as color </span></span>
<span id="cb50-144"><a href="annex-i-compendium-of-r-scripts.html#cb50-144" aria-hidden="true" tabindex="-1"></a><span class="co"># and size inside the </span></span>
<span id="cb50-145"><a href="annex-i-compendium-of-r-scripts.html#cb50-145" aria-hidden="true" tabindex="-1"></a><span class="co"># function aes()</span></span>
<span id="cb50-146"><a href="annex-i-compendium-of-r-scripts.html#cb50-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-147"><a href="annex-i-compendium-of-r-scripts.html#cb50-147" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, </span>
<span id="cb50-148"><a href="annex-i-compendium-of-r-scripts.html#cb50-148" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o, <span class="at">color =</span> cec, <span class="at">size =</span> cec)) <span class="sc">+</span> </span>
<span id="cb50-149"><a href="annex-i-compendium-of-r-scripts.html#cb50-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span>
<span id="cb50-150"><a href="annex-i-compendium-of-r-scripts.html#cb50-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-151"><a href="annex-i-compendium-of-r-scripts.html#cb50-151" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Geospatial data with terra =================================</span></span>
<span id="cb50-152"><a href="annex-i-compendium-of-r-scripts.html#cb50-152" aria-hidden="true" tabindex="-1"></a><span class="do">## Load packages (install them if needed)</span></span>
<span id="cb50-153"><a href="annex-i-compendium-of-r-scripts.html#cb50-153" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb50-154"><a href="annex-i-compendium-of-r-scripts.html#cb50-154" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.1 Load a raster and a vector layer -------------------------</span></span>
<span id="cb50-155"><a href="annex-i-compendium-of-r-scripts.html#cb50-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Load 01-Data/covs/grass.tif using rast() function, then plot it</span></span>
<span id="cb50-156"><a href="annex-i-compendium-of-r-scripts.html#cb50-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Load 01-Data/soil map/SoilTypes.shp using vect() function and </span></span>
<span id="cb50-157"><a href="annex-i-compendium-of-r-scripts.html#cb50-157" aria-hidden="true" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb50-158"><a href="annex-i-compendium-of-r-scripts.html#cb50-158" aria-hidden="true" tabindex="-1"></a><span class="co"># explore the attributes of these layers</span></span>
<span id="cb50-159"><a href="annex-i-compendium-of-r-scripts.html#cb50-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-160"><a href="annex-i-compendium-of-r-scripts.html#cb50-160" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/Macedonia/grass.tif&quot;</span>)</span>
<span id="cb50-161"><a href="annex-i-compendium-of-r-scripts.html#cb50-161" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb50-162"><a href="annex-i-compendium-of-r-scripts.html#cb50-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-163"><a href="annex-i-compendium-of-r-scripts.html#cb50-163" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">vect</span>(<span class="st">&quot;01-Data/Macedonia/SoilTypes.shp&quot;</span>)</span>
<span id="cb50-164"><a href="annex-i-compendium-of-r-scripts.html#cb50-164" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v)</span>
<span id="cb50-165"><a href="annex-i-compendium-of-r-scripts.html#cb50-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-166"><a href="annex-i-compendium-of-r-scripts.html#cb50-166" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.2 Load a raster and a vector layer -------------------------</span></span>
<span id="cb50-167"><a href="annex-i-compendium-of-r-scripts.html#cb50-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the current CRS (EPSG) of the raster and the vector. </span></span>
<span id="cb50-168"><a href="annex-i-compendium-of-r-scripts.html#cb50-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Find a *projected* CRS in http://epsg.io for Macedonia and </span></span>
<span id="cb50-169"><a href="annex-i-compendium-of-r-scripts.html#cb50-169" aria-hidden="true" tabindex="-1"></a><span class="co"># copy the number</span></span>
<span id="cb50-170"><a href="annex-i-compendium-of-r-scripts.html#cb50-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the Arguments of function project (?project) that need to</span></span>
<span id="cb50-171"><a href="annex-i-compendium-of-r-scripts.html#cb50-171" aria-hidden="true" tabindex="-1"></a><span class="co"># be defined</span></span>
<span id="cb50-172"><a href="annex-i-compendium-of-r-scripts.html#cb50-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the new object as r_proj and v_proj</span></span>
<span id="cb50-173"><a href="annex-i-compendium-of-r-scripts.html#cb50-173" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both objects</span></span>
<span id="cb50-174"><a href="annex-i-compendium-of-r-scripts.html#cb50-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-175"><a href="annex-i-compendium-of-r-scripts.html#cb50-175" aria-hidden="true" tabindex="-1"></a>r_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="at">x =</span> r, <span class="at">y =</span> <span class="st">&quot;epsg:6204&quot;</span>, <span class="at">method =</span> <span class="st">&quot;bilinear&quot;</span>,</span>
<span id="cb50-176"><a href="annex-i-compendium-of-r-scripts.html#cb50-176" aria-hidden="true" tabindex="-1"></a>                  <span class="at">res =</span> <span class="dv">250</span>)</span>
<span id="cb50-177"><a href="annex-i-compendium-of-r-scripts.html#cb50-177" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_proj)</span>
<span id="cb50-178"><a href="annex-i-compendium-of-r-scripts.html#cb50-178" aria-hidden="true" tabindex="-1"></a>v_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="at">x =</span> v, <span class="at">y =</span> <span class="st">&quot;epsg:6204&quot;</span>)</span>
<span id="cb50-179"><a href="annex-i-compendium-of-r-scripts.html#cb50-179" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v_proj, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-180"><a href="annex-i-compendium-of-r-scripts.html#cb50-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-181"><a href="annex-i-compendium-of-r-scripts.html#cb50-181" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.3 Cropping and masking a raster ----------------------------</span></span>
<span id="cb50-182"><a href="annex-i-compendium-of-r-scripts.html#cb50-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the area of the polygons in v_proj </span></span>
<span id="cb50-183"><a href="annex-i-compendium-of-r-scripts.html#cb50-183" aria-hidden="true" tabindex="-1"></a><span class="co"># (search for a function) and</span></span>
<span id="cb50-184"><a href="annex-i-compendium-of-r-scripts.html#cb50-184" aria-hidden="true" tabindex="-1"></a><span class="co"># assign the values to a new column named area</span></span>
<span id="cb50-185"><a href="annex-i-compendium-of-r-scripts.html#cb50-185" aria-hidden="true" tabindex="-1"></a><span class="co"># select the largest polygon using [], $, == and max() func. </span></span>
<span id="cb50-186"><a href="annex-i-compendium-of-r-scripts.html#cb50-186" aria-hidden="true" tabindex="-1"></a><span class="co"># and save it as pol</span></span>
<span id="cb50-187"><a href="annex-i-compendium-of-r-scripts.html#cb50-187" aria-hidden="true" tabindex="-1"></a><span class="co"># crop the raster with pol using the crop() function and save </span></span>
<span id="cb50-188"><a href="annex-i-compendium-of-r-scripts.html#cb50-188" aria-hidden="true" tabindex="-1"></a><span class="co">#it as r_pol</span></span>
<span id="cb50-189"><a href="annex-i-compendium-of-r-scripts.html#cb50-189" aria-hidden="true" tabindex="-1"></a><span class="co"># mask the raster r_pol with the polygon pol and save it </span></span>
<span id="cb50-190"><a href="annex-i-compendium-of-r-scripts.html#cb50-190" aria-hidden="true" tabindex="-1"></a><span class="co"># with the same name</span></span>
<span id="cb50-191"><a href="annex-i-compendium-of-r-scripts.html#cb50-191" aria-hidden="true" tabindex="-1"></a><span class="co"># plot each result</span></span>
<span id="cb50-192"><a href="annex-i-compendium-of-r-scripts.html#cb50-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-193"><a href="annex-i-compendium-of-r-scripts.html#cb50-193" aria-hidden="true" tabindex="-1"></a>v_proj<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">expanse</span>(v_proj, <span class="at">unit =</span> <span class="st">&quot;ha&quot;</span>)</span>
<span id="cb50-194"><a href="annex-i-compendium-of-r-scripts.html#cb50-194" aria-hidden="true" tabindex="-1"></a>pol <span class="ot">&lt;-</span> v_proj[v_proj<span class="sc">$</span>area <span class="sc">==</span> <span class="fu">max</span>(v_proj<span class="sc">$</span>area)]</span>
<span id="cb50-195"><a href="annex-i-compendium-of-r-scripts.html#cb50-195" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol)</span>
<span id="cb50-196"><a href="annex-i-compendium-of-r-scripts.html#cb50-196" aria-hidden="true" tabindex="-1"></a>r_pol <span class="ot">&lt;-</span> <span class="fu">crop</span>(r_proj, pol)</span>
<span id="cb50-197"><a href="annex-i-compendium-of-r-scripts.html#cb50-197" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb50-198"><a href="annex-i-compendium-of-r-scripts.html#cb50-198" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-199"><a href="annex-i-compendium-of-r-scripts.html#cb50-199" aria-hidden="true" tabindex="-1"></a>r_pol <span class="ot">&lt;-</span> <span class="fu">mask</span>(r_pol, pol)</span>
<span id="cb50-200"><a href="annex-i-compendium-of-r-scripts.html#cb50-200" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb50-201"><a href="annex-i-compendium-of-r-scripts.html#cb50-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-202"><a href="annex-i-compendium-of-r-scripts.html#cb50-202" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.4 Replace values in a raster by filtering their cells ------</span></span>
<span id="cb50-203"><a href="annex-i-compendium-of-r-scripts.html#cb50-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore the following link to understand how terra </span></span>
<span id="cb50-204"><a href="annex-i-compendium-of-r-scripts.html#cb50-204" aria-hidden="true" tabindex="-1"></a><span class="co">#manage cell values</span></span>
<span id="cb50-205"><a href="annex-i-compendium-of-r-scripts.html#cb50-205" aria-hidden="true" tabindex="-1"></a><span class="co"># https://rspatial.org/terra/pkg/4-algebra.html </span></span>
<span id="cb50-206"><a href="annex-i-compendium-of-r-scripts.html#cb50-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace values lower than 5 in r+pol by 0</span></span>
<span id="cb50-207"><a href="annex-i-compendium-of-r-scripts.html#cb50-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-208"><a href="annex-i-compendium-of-r-scripts.html#cb50-208" aria-hidden="true" tabindex="-1"></a>r_pol[r_pol<span class="sc">$</span>grass <span class="sc">&lt;</span> <span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb50-209"><a href="annex-i-compendium-of-r-scripts.html#cb50-209" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb50-210"><a href="annex-i-compendium-of-r-scripts.html#cb50-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-211"><a href="annex-i-compendium-of-r-scripts.html#cb50-211" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.5 Rasterize a vector layer ---------------------------------</span></span>
<span id="cb50-212"><a href="annex-i-compendium-of-r-scripts.html#cb50-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Use rasterize() function to convert v_proj to raster</span></span>
<span id="cb50-213"><a href="annex-i-compendium-of-r-scripts.html#cb50-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Use r_proj as reference raster</span></span>
<span id="cb50-214"><a href="annex-i-compendium-of-r-scripts.html#cb50-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Use field Symbol to assign cell values, and plot the new map</span></span>
<span id="cb50-215"><a href="annex-i-compendium-of-r-scripts.html#cb50-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-216"><a href="annex-i-compendium-of-r-scripts.html#cb50-216" aria-hidden="true" tabindex="-1"></a>v_class <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="at">x =</span> v_proj, <span class="at">y =</span> r_proj, <span class="at">field =</span> <span class="st">&quot;Symbol&quot;</span> )</span>
<span id="cb50-217"><a href="annex-i-compendium-of-r-scripts.html#cb50-217" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v_class)</span>
<span id="cb50-218"><a href="annex-i-compendium-of-r-scripts.html#cb50-218" aria-hidden="true" tabindex="-1"></a>v_class</span>
<span id="cb50-219"><a href="annex-i-compendium-of-r-scripts.html#cb50-219" aria-hidden="true" tabindex="-1"></a><span class="fu">activeCat</span>(v_class) <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb50-220"><a href="annex-i-compendium-of-r-scripts.html#cb50-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-221"><a href="annex-i-compendium-of-r-scripts.html#cb50-221" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.6 Extracting raster values using points --------------------</span></span>
<span id="cb50-222"><a href="annex-i-compendium-of-r-scripts.html#cb50-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Covert dat_6 to spatial points using vect() function </span></span>
<span id="cb50-223"><a href="annex-i-compendium-of-r-scripts.html#cb50-223" aria-hidden="true" tabindex="-1"></a><span class="co"># (check help of vect())</span></span>
<span id="cb50-224"><a href="annex-i-compendium-of-r-scripts.html#cb50-224" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the EPSG number is 6204</span></span>
<span id="cb50-225"><a href="annex-i-compendium-of-r-scripts.html#cb50-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the points as s</span></span>
<span id="cb50-226"><a href="annex-i-compendium-of-r-scripts.html#cb50-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot s and r_proj together in the same map (Argument add=TRUE)</span></span>
<span id="cb50-227"><a href="annex-i-compendium-of-r-scripts.html#cb50-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the values of the raster using extract() </span></span>
<span id="cb50-228"><a href="annex-i-compendium-of-r-scripts.html#cb50-228" aria-hidden="true" tabindex="-1"></a><span class="co"># function (check the help)</span></span>
<span id="cb50-229"><a href="annex-i-compendium-of-r-scripts.html#cb50-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the ID column of the extracted values</span></span>
<span id="cb50-230"><a href="annex-i-compendium-of-r-scripts.html#cb50-230" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the extracted data with s using cbind() function</span></span>
<span id="cb50-231"><a href="annex-i-compendium-of-r-scripts.html#cb50-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert s as a dataframe</span></span>
<span id="cb50-232"><a href="annex-i-compendium-of-r-scripts.html#cb50-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-233"><a href="annex-i-compendium-of-r-scripts.html#cb50-233" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">vect</span>(dat_6, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="st">&quot;epsg:6204&quot;</span>)</span>
<span id="cb50-234"><a href="annex-i-compendium-of-r-scripts.html#cb50-234" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_proj)</span>
<span id="cb50-235"><a href="annex-i-compendium-of-r-scripts.html#cb50-235" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(s, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb50-236"><a href="annex-i-compendium-of-r-scripts.html#cb50-236" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">extract</span>(r_proj,s, <span class="at">ID=</span><span class="cn">FALSE</span>)</span>
<span id="cb50-237"><a href="annex-i-compendium-of-r-scripts.html#cb50-237" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">cbind</span>(s,x)</span>
<span id="cb50-238"><a href="annex-i-compendium-of-r-scripts.html#cb50-238" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(s)</span>
<span id="cb50-239"><a href="annex-i-compendium-of-r-scripts.html#cb50-239" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb50-240"><a href="annex-i-compendium-of-r-scripts.html#cb50-240" aria-hidden="true" tabindex="-1"></a><span class="co">#GGally::ggscatmat(d)</span></span>
<span id="cb50-241"><a href="annex-i-compendium-of-r-scripts.html#cb50-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-242"><a href="annex-i-compendium-of-r-scripts.html#cb50-242" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.7 Zonal statistics using polygons and rasters --------------</span></span>
<span id="cb50-243"><a href="annex-i-compendium-of-r-scripts.html#cb50-243" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the extract() func. to estimate the mean value of </span></span>
<span id="cb50-244"><a href="annex-i-compendium-of-r-scripts.html#cb50-244" aria-hidden="true" tabindex="-1"></a><span class="co"># r_proj at each polygon</span></span>
<span id="cb50-245"><a href="annex-i-compendium-of-r-scripts.html#cb50-245" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the fun= argument (check the help)</span></span>
<span id="cb50-246"><a href="annex-i-compendium-of-r-scripts.html#cb50-246" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the cbind() func. to merge v_proj and the extracted values</span></span>
<span id="cb50-247"><a href="annex-i-compendium-of-r-scripts.html#cb50-247" aria-hidden="true" tabindex="-1"></a><span class="co"># convert v_proj to a dataframe</span></span>
<span id="cb50-248"><a href="annex-i-compendium-of-r-scripts.html#cb50-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a ggplot boxplot (geom_boxplot) with x=Symbol</span></span>
<span id="cb50-249"><a href="annex-i-compendium-of-r-scripts.html#cb50-249" aria-hidden="true" tabindex="-1"></a><span class="co"># and y=grass </span></span>
<span id="cb50-250"><a href="annex-i-compendium-of-r-scripts.html#cb50-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-251"><a href="annex-i-compendium-of-r-scripts.html#cb50-251" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">extract</span>(r_proj, v_proj, <span class="at">fun =</span> mean, <span class="at">ID=</span><span class="cn">FALSE</span>)</span>
<span id="cb50-252"><a href="annex-i-compendium-of-r-scripts.html#cb50-252" aria-hidden="true" tabindex="-1"></a>v_proj <span class="ot">&lt;-</span> <span class="fu">cbind</span>(v_proj, x)</span>
<span id="cb50-253"><a href="annex-i-compendium-of-r-scripts.html#cb50-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-254"><a href="annex-i-compendium-of-r-scripts.html#cb50-254" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(v_proj)</span>
<span id="cb50-255"><a href="annex-i-compendium-of-r-scripts.html#cb50-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-256"><a href="annex-i-compendium-of-r-scripts.html#cb50-256" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> </span>
<span id="cb50-257"><a href="annex-i-compendium-of-r-scripts.html#cb50-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span>Symbol, <span class="at">y =</span> grass, <span class="at">fill =</span> Symbol)) <span class="sc">+</span></span>
<span id="cb50-258"><a href="annex-i-compendium-of-r-scripts.html#cb50-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb50-259"><a href="annex-i-compendium-of-r-scripts.html#cb50-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Grass probability&quot;</span>)</span>
<span id="cb50-260"><a href="annex-i-compendium-of-r-scripts.html#cb50-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-261"><a href="annex-i-compendium-of-r-scripts.html#cb50-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-262"><a href="annex-i-compendium-of-r-scripts.html#cb50-262" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="re">END</span></span></code></pre></div>
</div>
<div id="script-2-download-environmental-covariates" class="section level2 unnumbered hasAnchor">
<h2>Script 2: Download environmental covariates<a href="annex-i-compendium-of-r-scripts.html#script-2-download-environmental-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb51"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb51-1"><a href="annex-i-compendium-of-r-scripts.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assets <span class="op">=</span> </span>
<span id="cb51-2"><a href="annex-i-compendium-of-r-scripts.html#cb51-2" aria-hidden="true" tabindex="-1"></a>[<span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio1&quot;</span><span class="op">,</span></span>
<span id="cb51-3"><a href="annex-i-compendium-of-r-scripts.html#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio12&quot;</span><span class="op">,</span></span>
<span id="cb51-4"><a href="annex-i-compendium-of-r-scripts.html#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio13&quot;</span><span class="op">,</span></span>
<span id="cb51-5"><a href="annex-i-compendium-of-r-scripts.html#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio14&quot;</span><span class="op">,</span></span>
<span id="cb51-6"><a href="annex-i-compendium-of-r-scripts.html#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio16&quot;</span><span class="op">,</span></span>
<span id="cb51-7"><a href="annex-i-compendium-of-r-scripts.html#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio17&quot;</span><span class="op">,</span></span>
<span id="cb51-8"><a href="annex-i-compendium-of-r-scripts.html#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio5&quot;</span><span class="op">,</span></span>
<span id="cb51-9"><a href="annex-i-compendium-of-r-scripts.html#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio6&quot;</span><span class="op">,</span></span>
<span id="cb51-10"><a href="annex-i-compendium-of-r-scripts.html#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/ngd10&quot;</span><span class="op">,</span></span>
<span id="cb51-11"><a href="annex-i-compendium-of-r-scripts.html#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_max&quot;</span><span class="op">,</span></span>
<span id="cb51-12"><a href="annex-i-compendium-of-r-scripts.html#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-13"><a href="annex-i-compendium-of-r-scripts.html#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_min&quot;</span><span class="op">,</span></span>
<span id="cb51-14"><a href="annex-i-compendium-of-r-scripts.html#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_range&quot;</span><span class="op">,</span></span>
<span id="cb51-15"><a href="annex-i-compendium-of-r-scripts.html#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_max&quot;</span><span class="op">,</span></span>
<span id="cb51-16"><a href="annex-i-compendium-of-r-scripts.html#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-17"><a href="annex-i-compendium-of-r-scripts.html#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_range&quot;</span><span class="op">,</span></span>
<span id="cb51-18"><a href="annex-i-compendium-of-r-scripts.html#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_030405_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-19"><a href="annex-i-compendium-of-r-scripts.html#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_030405_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-20"><a href="annex-i-compendium-of-r-scripts.html#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_060708_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-21"><a href="annex-i-compendium-of-r-scripts.html#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_060708_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-22"><a href="annex-i-compendium-of-r-scripts.html#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_091011_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-23"><a href="annex-i-compendium-of-r-scripts.html#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_091011_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-24"><a href="annex-i-compendium-of-r-scripts.html#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_120102_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-25"><a href="annex-i-compendium-of-r-scripts.html#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_120102_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-26"><a href="annex-i-compendium-of-r-scripts.html#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_030405_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-27"><a href="annex-i-compendium-of-r-scripts.html#cb51-27" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_030405_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-28"><a href="annex-i-compendium-of-r-scripts.html#cb51-28" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_060708_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-29"><a href="annex-i-compendium-of-r-scripts.html#cb51-29" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_060708_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-30"><a href="annex-i-compendium-of-r-scripts.html#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_091011_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-31"><a href="annex-i-compendium-of-r-scripts.html#cb51-31" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_091011_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-32"><a href="annex-i-compendium-of-r-scripts.html#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_120102_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-33"><a href="annex-i-compendium-of-r-scripts.html#cb51-33" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_120102_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-34"><a href="annex-i-compendium-of-r-scripts.html#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_030405_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-35"><a href="annex-i-compendium-of-r-scripts.html#cb51-35" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_030405_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-36"><a href="annex-i-compendium-of-r-scripts.html#cb51-36" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_060708_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-37"><a href="annex-i-compendium-of-r-scripts.html#cb51-37" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_060708_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-38"><a href="annex-i-compendium-of-r-scripts.html#cb51-38" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_091011_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-39"><a href="annex-i-compendium-of-r-scripts.html#cb51-39" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_091011_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-40"><a href="annex-i-compendium-of-r-scripts.html#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_120102_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-41"><a href="annex-i-compendium-of-r-scripts.html#cb51-41" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_120102_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-42"><a href="annex-i-compendium-of-r-scripts.html#cb51-42" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_030405_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-43"><a href="annex-i-compendium-of-r-scripts.html#cb51-43" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_030405_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-44"><a href="annex-i-compendium-of-r-scripts.html#cb51-44" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_060708_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-45"><a href="annex-i-compendium-of-r-scripts.html#cb51-45" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_060708_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-46"><a href="annex-i-compendium-of-r-scripts.html#cb51-46" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_091011_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-47"><a href="annex-i-compendium-of-r-scripts.html#cb51-47" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_091011_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-48"><a href="annex-i-compendium-of-r-scripts.html#cb51-48" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_120102_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-49"><a href="annex-i-compendium-of-r-scripts.html#cb51-49" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_120102_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb51-50"><a href="annex-i-compendium-of-r-scripts.html#cb51-50" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/snow_cover&quot;</span><span class="op">,</span></span>
<span id="cb51-51"><a href="annex-i-compendium-of-r-scripts.html#cb51-51" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/swir_060708_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb51-52"><a href="annex-i-compendium-of-r-scripts.html#cb51-52" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/crops&quot;</span><span class="op">,</span></span>
<span id="cb51-53"><a href="annex-i-compendium-of-r-scripts.html#cb51-53" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/flooded_vegetation&quot;</span><span class="op">,</span></span>
<span id="cb51-54"><a href="annex-i-compendium-of-r-scripts.html#cb51-54" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/grass&quot;</span><span class="op">,</span></span>
<span id="cb51-55"><a href="annex-i-compendium-of-r-scripts.html#cb51-55" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/shrub_and_scrub&quot;</span><span class="op">,</span></span>
<span id="cb51-56"><a href="annex-i-compendium-of-r-scripts.html#cb51-56" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/trees&quot;</span><span class="op">,</span></span>
<span id="cb51-57"><a href="annex-i-compendium-of-r-scripts.html#cb51-57" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_curvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-58"><a href="annex-i-compendium-of-r-scripts.html#cb51-58" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_downslopecurvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-59"><a href="annex-i-compendium-of-r-scripts.html#cb51-59" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_dvm2_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-60"><a href="annex-i-compendium-of-r-scripts.html#cb51-60" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_dvm_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-61"><a href="annex-i-compendium-of-r-scripts.html#cb51-61" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_elevation_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-62"><a href="annex-i-compendium-of-r-scripts.html#cb51-62" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_mrn_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-63"><a href="annex-i-compendium-of-r-scripts.html#cb51-63" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_neg_openness_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-64"><a href="annex-i-compendium-of-r-scripts.html#cb51-64" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_pos_openness_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-65"><a href="annex-i-compendium-of-r-scripts.html#cb51-65" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_slope_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-66"><a href="annex-i-compendium-of-r-scripts.html#cb51-66" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_tpi_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-67"><a href="annex-i-compendium-of-r-scripts.html#cb51-67" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_twi_500m&quot;</span><span class="op">,</span></span>
<span id="cb51-68"><a href="annex-i-compendium-of-r-scripts.html#cb51-68" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_upslopecurvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb51-69"><a href="annex-i-compendium-of-r-scripts.html#cb51-69" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_vbf_250m&quot;</span>]<span class="op">;</span></span>
<span id="cb51-70"><a href="annex-i-compendium-of-r-scripts.html#cb51-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-71"><a href="annex-i-compendium-of-r-scripts.html#cb51-71" aria-hidden="true" tabindex="-1"></a><span class="co">// Load borders </span></span>
<span id="cb51-72"><a href="annex-i-compendium-of-r-scripts.html#cb51-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-73"><a href="annex-i-compendium-of-r-scripts.html#cb51-73" aria-hidden="true" tabindex="-1"></a><span class="co">/// Using UN 2020 (replace the countries to download)</span></span>
<span id="cb51-74"><a href="annex-i-compendium-of-r-scripts.html#cb51-74" aria-hidden="true" tabindex="-1"></a><span class="co">/// var ISO = [&#39;ITA&#39;];</span></span>
<span id="cb51-75"><a href="annex-i-compendium-of-r-scripts.html#cb51-75" aria-hidden="true" tabindex="-1"></a><span class="co">/// var aoi =</span></span>
<span id="cb51-76"><a href="annex-i-compendium-of-r-scripts.html#cb51-76" aria-hidden="true" tabindex="-1"></a><span class="co">/// ee.FeatureCollection(</span></span>
<span id="cb51-77"><a href="annex-i-compendium-of-r-scripts.html#cb51-77" aria-hidden="true" tabindex="-1"></a><span class="co">/// &#39;projects/digital-soil-mapping-gsp-fao/assets/UN_BORDERS/BNDA_CTY&#39;</span></span>
<span id="cb51-78"><a href="annex-i-compendium-of-r-scripts.html#cb51-78" aria-hidden="true" tabindex="-1"></a><span class="co">/// )</span></span>
<span id="cb51-79"><a href="annex-i-compendium-of-r-scripts.html#cb51-79" aria-hidden="true" tabindex="-1"></a><span class="co">///   .filter(ee.Filter.inList(&#39;ISO3CD&#39;, ISO));</span></span>
<span id="cb51-80"><a href="annex-i-compendium-of-r-scripts.html#cb51-80" aria-hidden="true" tabindex="-1"></a><span class="co">/// var region = aoi.geometry();</span></span>
<span id="cb51-81"><a href="annex-i-compendium-of-r-scripts.html#cb51-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-82"><a href="annex-i-compendium-of-r-scripts.html#cb51-82" aria-hidden="true" tabindex="-1"></a><span class="co">/// Using a shapefile</span></span>
<span id="cb51-83"><a href="annex-i-compendium-of-r-scripts.html#cb51-83" aria-hidden="true" tabindex="-1"></a><span class="co">/// 1. Upload the borders of your countries as an asset</span></span>
<span id="cb51-84"><a href="annex-i-compendium-of-r-scripts.html#cb51-84" aria-hidden="true" tabindex="-1"></a><span class="co">/// 2. Replace &#39;your_shapefile&#39; with the path to your shapefile</span></span>
<span id="cb51-85"><a href="annex-i-compendium-of-r-scripts.html#cb51-85" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> shapefile <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;projects/digital-soil-mapping-gsp-fao/assets/Nghe_An&#39;</span>)<span class="op">;</span></span>
<span id="cb51-86"><a href="annex-i-compendium-of-r-scripts.html#cb51-86" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> region <span class="op">=</span> shapefile<span class="op">.</span><span class="fu">geometry</span>()<span class="op">.</span><span class="fu">bounds</span>()<span class="op">;</span></span>
<span id="cb51-87"><a href="annex-i-compendium-of-r-scripts.html#cb51-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-88"><a href="annex-i-compendium-of-r-scripts.html#cb51-88" aria-hidden="true" tabindex="-1"></a><span class="co">// Load assets as ImageCollection</span></span>
<span id="cb51-89"><a href="annex-i-compendium-of-r-scripts.html#cb51-89" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assetsCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(assets)<span class="op">;</span></span>
<span id="cb51-90"><a href="annex-i-compendium-of-r-scripts.html#cb51-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-91"><a href="annex-i-compendium-of-r-scripts.html#cb51-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Clip each image in the collection to the region of interest</span></span>
<span id="cb51-92"><a href="annex-i-compendium-of-r-scripts.html#cb51-92" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clippedCollection <span class="op">=</span> assetsCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(img){</span>
<span id="cb51-93"><a href="annex-i-compendium-of-r-scripts.html#cb51-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> img<span class="op">.</span><span class="fu">clip</span>(region)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb51-94"><a href="annex-i-compendium-of-r-scripts.html#cb51-94" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-95"><a href="annex-i-compendium-of-r-scripts.html#cb51-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-96"><a href="annex-i-compendium-of-r-scripts.html#cb51-96" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to replace masked values with zeroes for fpar bands</span></span>
<span id="cb51-97"><a href="annex-i-compendium-of-r-scripts.html#cb51-97" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">replaceMaskedFpar</span>(img) {</span>
<span id="cb51-98"><a href="annex-i-compendium-of-r-scripts.html#cb51-98" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> allBands <span class="op">=</span> img<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb51-99"><a href="annex-i-compendium-of-r-scripts.html#cb51-99" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fparBands <span class="op">=</span></span>
<span id="cb51-100"><a href="annex-i-compendium-of-r-scripts.html#cb51-100" aria-hidden="true" tabindex="-1"></a>  allBands<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">stringStartsWith</span>(<span class="st">&#39;item&#39;</span><span class="op">,</span> <span class="st">&#39;fpar&#39;</span>))<span class="op">;</span></span>
<span id="cb51-101"><a href="annex-i-compendium-of-r-scripts.html#cb51-101" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> nonFparBands <span class="op">=</span> allBands<span class="op">.</span><span class="fu">removeAll</span>(fparBands)<span class="op">;</span></span>
<span id="cb51-102"><a href="annex-i-compendium-of-r-scripts.html#cb51-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-103"><a href="annex-i-compendium-of-r-scripts.html#cb51-103" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fparImg <span class="op">=</span> img<span class="op">.</span><span class="fu">select</span>(fparBands)<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb51-104"><a href="annex-i-compendium-of-r-scripts.html#cb51-104" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> nonFparImg <span class="op">=</span> img<span class="op">.</span><span class="fu">select</span>(nonFparBands)<span class="op">;</span></span>
<span id="cb51-105"><a href="annex-i-compendium-of-r-scripts.html#cb51-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-106"><a href="annex-i-compendium-of-r-scripts.html#cb51-106" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If there are no fpar bands, return the original image</span></span>
<span id="cb51-107"><a href="annex-i-compendium-of-r-scripts.html#cb51-107" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(fparBands<span class="op">.</span><span class="fu">length</span>()<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb51-108"><a href="annex-i-compendium-of-r-scripts.html#cb51-108" aria-hidden="true" tabindex="-1"></a>                                 img<span class="op">,</span></span>
<span id="cb51-109"><a href="annex-i-compendium-of-r-scripts.html#cb51-109" aria-hidden="true" tabindex="-1"></a>                                 nonFparImg<span class="op">.</span><span class="fu">addBands</span>(fparImg))<span class="op">;</span></span>
<span id="cb51-110"><a href="annex-i-compendium-of-r-scripts.html#cb51-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-111"><a href="annex-i-compendium-of-r-scripts.html#cb51-111" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(result)<span class="op">;</span></span>
<span id="cb51-112"><a href="annex-i-compendium-of-r-scripts.html#cb51-112" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-113"><a href="annex-i-compendium-of-r-scripts.html#cb51-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-114"><a href="annex-i-compendium-of-r-scripts.html#cb51-114" aria-hidden="true" tabindex="-1"></a><span class="co">// Clip each image in the collection to the region of </span></span>
<span id="cb51-115"><a href="annex-i-compendium-of-r-scripts.html#cb51-115" aria-hidden="true" tabindex="-1"></a><span class="co">//interest and replace masked values for fpar bands</span></span>
<span id="cb51-116"><a href="annex-i-compendium-of-r-scripts.html#cb51-116" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clippedCollection <span class="op">=</span> assetsCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(img){</span>
<span id="cb51-117"><a href="annex-i-compendium-of-r-scripts.html#cb51-117" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> clippedImg <span class="op">=</span> img<span class="op">.</span><span class="fu">clip</span>(region)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb51-118"><a href="annex-i-compendium-of-r-scripts.html#cb51-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">replaceMaskedFpar</span>(clippedImg)<span class="op">;</span></span>
<span id="cb51-119"><a href="annex-i-compendium-of-r-scripts.html#cb51-119" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-120"><a href="annex-i-compendium-of-r-scripts.html#cb51-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-121"><a href="annex-i-compendium-of-r-scripts.html#cb51-121" aria-hidden="true" tabindex="-1"></a><span class="co">// Stack the layers and maintain the </span></span>
<span id="cb51-122"><a href="annex-i-compendium-of-r-scripts.html#cb51-122" aria-hidden="true" tabindex="-1"></a><span class="co">//layer names in the final file</span></span>
<span id="cb51-123"><a href="annex-i-compendium-of-r-scripts.html#cb51-123" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stacked <span class="op">=</span> clippedCollection<span class="op">.</span><span class="fu">toBands</span>()<span class="op">;</span></span>
<span id="cb51-124"><a href="annex-i-compendium-of-r-scripts.html#cb51-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-125"><a href="annex-i-compendium-of-r-scripts.html#cb51-125" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the list of asset names</span></span>
<span id="cb51-126"><a href="annex-i-compendium-of-r-scripts.html#cb51-126" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assetNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(assets)<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(asset) {</span>
<span id="cb51-127"><a href="annex-i-compendium-of-r-scripts.html#cb51-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">String</span>(asset)<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">get</span>(<span class="op">-</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb51-128"><a href="annex-i-compendium-of-r-scripts.html#cb51-128" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-129"><a href="annex-i-compendium-of-r-scripts.html#cb51-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-130"><a href="annex-i-compendium-of-r-scripts.html#cb51-130" aria-hidden="true" tabindex="-1"></a><span class="co">// Rename the bands with asset names</span></span>
<span id="cb51-131"><a href="annex-i-compendium-of-r-scripts.html#cb51-131" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> renamed <span class="op">=</span> stacked<span class="op">.</span><span class="fu">rename</span>(assetNames)<span class="op">;</span></span>
<span id="cb51-132"><a href="annex-i-compendium-of-r-scripts.html#cb51-132" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(renamed<span class="op">,</span> <span class="st">&#39;Covariates to be exported&#39;</span>)</span>
<span id="cb51-133"><a href="annex-i-compendium-of-r-scripts.html#cb51-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-134"><a href="annex-i-compendium-of-r-scripts.html#cb51-134" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize the result</span></span>
<span id="cb51-135"><a href="annex-i-compendium-of-r-scripts.html#cb51-135" aria-hidden="true" tabindex="-1"></a><span class="co">// Set a visualization parameter </span></span>
<span id="cb51-136"><a href="annex-i-compendium-of-r-scripts.html#cb51-136" aria-hidden="true" tabindex="-1"></a><span class="co">// (you can adjust the colors as desired)</span></span>
<span id="cb51-137"><a href="annex-i-compendium-of-r-scripts.html#cb51-137" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb51-138"><a href="annex-i-compendium-of-r-scripts.html#cb51-138" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> <span class="st">&#39;bio1&#39;</span><span class="op">,</span></span>
<span id="cb51-139"><a href="annex-i-compendium-of-r-scripts.html#cb51-139" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb51-140"><a href="annex-i-compendium-of-r-scripts.html#cb51-140" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb51-141"><a href="annex-i-compendium-of-r-scripts.html#cb51-141" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;yellow&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>]</span>
<span id="cb51-142"><a href="annex-i-compendium-of-r-scripts.html#cb51-142" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-143"><a href="annex-i-compendium-of-r-scripts.html#cb51-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-144"><a href="annex-i-compendium-of-r-scripts.html#cb51-144" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the layer to the map</span></span>
<span id="cb51-145"><a href="annex-i-compendium-of-r-scripts.html#cb51-145" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(renamed<span class="op">,</span> <span class="dv">6</span>)</span>
<span id="cb51-146"><a href="annex-i-compendium-of-r-scripts.html#cb51-146" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(renamed<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Covariates&#39;</span>)<span class="op">;</span></span>
<span id="cb51-147"><a href="annex-i-compendium-of-r-scripts.html#cb51-147" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the stacked image to Google Drive</span></span>
<span id="cb51-148"><a href="annex-i-compendium-of-r-scripts.html#cb51-148" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb51-149"><a href="annex-i-compendium-of-r-scripts.html#cb51-149" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> renamed<span class="op">,</span></span>
<span id="cb51-150"><a href="annex-i-compendium-of-r-scripts.html#cb51-150" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;covariates&#39;</span><span class="op">,</span></span>
<span id="cb51-151"><a href="annex-i-compendium-of-r-scripts.html#cb51-151" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;GEE&#39;</span><span class="op">,</span></span>
<span id="cb51-152"><a href="annex-i-compendium-of-r-scripts.html#cb51-152" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb51-153"><a href="annex-i-compendium-of-r-scripts.html#cb51-153" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span><span class="op">,</span></span>
<span id="cb51-154"><a href="annex-i-compendium-of-r-scripts.html#cb51-154" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> region</span>
<span id="cb51-155"><a href="annex-i-compendium-of-r-scripts.html#cb51-155" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-156"><a href="annex-i-compendium-of-r-scripts.html#cb51-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-157"><a href="annex-i-compendium-of-r-scripts.html#cb51-157" aria-hidden="true" tabindex="-1"></a><span class="co">/* Create mask for croplands ----------------------------*/</span></span>
<span id="cb51-158"><a href="annex-i-compendium-of-r-scripts.html#cb51-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-159"><a href="annex-i-compendium-of-r-scripts.html#cb51-159" aria-hidden="true" tabindex="-1"></a><span class="co">// Load the Copernicus Global Land Service image collection</span></span>
<span id="cb51-160"><a href="annex-i-compendium-of-r-scripts.html#cb51-160" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> imageCollection <span class="op">=</span> </span>
<span id="cb51-161"><a href="annex-i-compendium-of-r-scripts.html#cb51-161" aria-hidden="true" tabindex="-1"></a>ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;COPERNICUS/Landcover/100m/Proba-V-C3/Global/2019&quot;</span>)</span>
<span id="cb51-162"><a href="annex-i-compendium-of-r-scripts.html#cb51-162" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;discrete_classification&quot;</span>)</span>
<span id="cb51-163"><a href="annex-i-compendium-of-r-scripts.html#cb51-163" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>(region)</span>
<span id="cb51-164"><a href="annex-i-compendium-of-r-scripts.html#cb51-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-165"><a href="annex-i-compendium-of-r-scripts.html#cb51-165" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> crs <span class="op">=</span> <span class="st">&#39;EPSG:4326&#39;</span><span class="op">;</span> <span class="co">// WGS84</span></span>
<span id="cb51-166"><a href="annex-i-compendium-of-r-scripts.html#cb51-166" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> res <span class="op">=</span> <span class="dv">250</span><span class="op">;</span> <span class="co">// Resolution in decimal degrees</span></span>
<span id="cb51-167"><a href="annex-i-compendium-of-r-scripts.html#cb51-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-168"><a href="annex-i-compendium-of-r-scripts.html#cb51-168" aria-hidden="true" tabindex="-1"></a><span class="co">// Default resampling is nearest neighbor</span></span>
<span id="cb51-169"><a href="annex-i-compendium-of-r-scripts.html#cb51-169" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image1 <span class="op">=</span> imageCollection<span class="op">.</span><span class="fu">resample</span>()</span>
<span id="cb51-170"><a href="annex-i-compendium-of-r-scripts.html#cb51-170" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">reproject</span>({</span>
<span id="cb51-171"><a href="annex-i-compendium-of-r-scripts.html#cb51-171" aria-hidden="true" tabindex="-1"></a>    <span class="dt">crs</span><span class="op">:</span> crs<span class="op">,</span> <span class="co">// Add your desired CRS here</span></span>
<span id="cb51-172"><a href="annex-i-compendium-of-r-scripts.html#cb51-172" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> res <span class="co">// Add your desired scale here</span></span>
<span id="cb51-173"><a href="annex-i-compendium-of-r-scripts.html#cb51-173" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb51-174"><a href="annex-i-compendium-of-r-scripts.html#cb51-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-175"><a href="annex-i-compendium-of-r-scripts.html#cb51-175" aria-hidden="true" tabindex="-1"></a><span class="co">// Reclassify the land cover classes</span></span>
<span id="cb51-176"><a href="annex-i-compendium-of-r-scripts.html#cb51-176" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> inList <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">80</span><span class="op">,</span> <span class="dv">90</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> </span>
<span id="cb51-177"><a href="annex-i-compendium-of-r-scripts.html#cb51-177" aria-hidden="true" tabindex="-1"></a>               <span class="dv">111</span><span class="op">,</span> <span class="dv">112</span><span class="op">,</span> <span class="dv">113</span><span class="op">,</span> <span class="dv">114</span><span class="op">,</span> <span class="dv">115</span><span class="op">,</span> <span class="dv">116</span><span class="op">,</span> </span>
<span id="cb51-178"><a href="annex-i-compendium-of-r-scripts.html#cb51-178" aria-hidden="true" tabindex="-1"></a>              <span class="dv">121</span><span class="op">,</span> <span class="dv">122</span><span class="op">,</span> <span class="dv">123</span><span class="op">,</span> <span class="dv">124</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">126</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">;</span></span>
<span id="cb51-179"><a href="annex-i-compendium-of-r-scripts.html#cb51-179" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> outList <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb51-180"><a href="annex-i-compendium-of-r-scripts.html#cb51-180" aria-hidden="true" tabindex="-1"></a>               <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb51-181"><a href="annex-i-compendium-of-r-scripts.html#cb51-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-182"><a href="annex-i-compendium-of-r-scripts.html#cb51-182" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> FAO_lu <span class="op">=</span> image1<span class="op">.</span><span class="fu">remap</span>(inList<span class="op">,</span> outList)</span>
<span id="cb51-183"><a href="annex-i-compendium-of-r-scripts.html#cb51-183" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">toDouble</span>()</span>
<span id="cb51-184"><a href="annex-i-compendium-of-r-scripts.html#cb51-184" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>(region)<span class="op">;</span></span>
<span id="cb51-185"><a href="annex-i-compendium-of-r-scripts.html#cb51-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-186"><a href="annex-i-compendium-of-r-scripts.html#cb51-186" aria-hidden="true" tabindex="-1"></a><span class="co">// print(FAO_lu)</span></span>
<span id="cb51-187"><a href="annex-i-compendium-of-r-scripts.html#cb51-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-188"><a href="annex-i-compendium-of-r-scripts.html#cb51-188" aria-hidden="true" tabindex="-1"></a><span class="co">// Convert 0 to NA</span></span>
<span id="cb51-189"><a href="annex-i-compendium-of-r-scripts.html#cb51-189" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mask <span class="op">=</span> FAO_lu<span class="op">.</span><span class="fu">neq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb51-190"><a href="annex-i-compendium-of-r-scripts.html#cb51-190" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mask)</span>
<span id="cb51-191"><a href="annex-i-compendium-of-r-scripts.html#cb51-191" aria-hidden="true" tabindex="-1"></a>FAO_lu <span class="op">=</span> FAO_lu<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb51-192"><a href="annex-i-compendium-of-r-scripts.html#cb51-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-193"><a href="annex-i-compendium-of-r-scripts.html#cb51-193" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(FAO_lu<span class="op">,</span> <span class="st">&quot;Mask&quot;</span>)</span>
<span id="cb51-194"><a href="annex-i-compendium-of-r-scripts.html#cb51-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-195"><a href="annex-i-compendium-of-r-scripts.html#cb51-195" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb51-196"><a href="annex-i-compendium-of-r-scripts.html#cb51-196" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> <span class="st">&#39;remapped&#39;</span><span class="op">,</span></span>
<span id="cb51-197"><a href="annex-i-compendium-of-r-scripts.html#cb51-197" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb51-198"><a href="annex-i-compendium-of-r-scripts.html#cb51-198" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb51-199"><a href="annex-i-compendium-of-r-scripts.html#cb51-199" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;yellow&#39;</span>]</span>
<span id="cb51-200"><a href="annex-i-compendium-of-r-scripts.html#cb51-200" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-201"><a href="annex-i-compendium-of-r-scripts.html#cb51-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-202"><a href="annex-i-compendium-of-r-scripts.html#cb51-202" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the layer to the map</span></span>
<span id="cb51-203"><a href="annex-i-compendium-of-r-scripts.html#cb51-203" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(FAO_lu<span class="op">,</span>visParams <span class="op">,</span><span class="st">&#39;Mask&#39;</span>)<span class="op">;</span></span>
<span id="cb51-204"><a href="annex-i-compendium-of-r-scripts.html#cb51-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-205"><a href="annex-i-compendium-of-r-scripts.html#cb51-205" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the land cover image as a raster to Google Drive</span></span>
<span id="cb51-206"><a href="annex-i-compendium-of-r-scripts.html#cb51-206" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb51-207"><a href="annex-i-compendium-of-r-scripts.html#cb51-207" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> FAO_lu<span class="op">,</span></span>
<span id="cb51-208"><a href="annex-i-compendium-of-r-scripts.html#cb51-208" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;GEE&#39;</span><span class="op">,</span></span>
<span id="cb51-209"><a href="annex-i-compendium-of-r-scripts.html#cb51-209" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;mask&#39;</span><span class="op">,</span></span>
<span id="cb51-210"><a href="annex-i-compendium-of-r-scripts.html#cb51-210" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> res<span class="op">,</span> <span class="co">// Add your desired scale here</span></span>
<span id="cb51-211"><a href="annex-i-compendium-of-r-scripts.html#cb51-211" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb51-212"><a href="annex-i-compendium-of-r-scripts.html#cb51-212" aria-hidden="true" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> crs<span class="op">,</span> <span class="co">// Add your desired CRS here</span></span>
<span id="cb51-213"><a href="annex-i-compendium-of-r-scripts.html#cb51-213" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span> <span class="co">// Add a maximum number of pixels </span></span>
<span id="cb51-214"><a href="annex-i-compendium-of-r-scripts.html#cb51-214" aria-hidden="true" tabindex="-1"></a>  <span class="co">//for export if needed</span></span>
<span id="cb51-215"><a href="annex-i-compendium-of-r-scripts.html#cb51-215" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="script-3-evaluate-legacy-data" class="section level2 unnumbered hasAnchor">
<h2>Script 3: Evaluate Legacy Data<a href="annex-i-compendium-of-r-scripts.html#script-3-evaluate-legacy-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="annex-i-compendium-of-r-scripts.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb52-2"><a href="annex-i-compendium-of-r-scripts.html#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb52-3"><a href="annex-i-compendium-of-r-scripts.html#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb52-4"><a href="annex-i-compendium-of-r-scripts.html#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluation of Legacy Data</span></span>
<span id="cb52-5"><a href="annex-i-compendium-of-r-scripts.html#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb52-6"><a href="annex-i-compendium-of-r-scripts.html#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb52-7"><a href="annex-i-compendium-of-r-scripts.html#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb52-8"><a href="annex-i-compendium-of-r-scripts.html#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="annex-i-compendium-of-r-scripts.html#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb52-10"><a href="annex-i-compendium-of-r-scripts.html#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="annex-i-compendium-of-r-scripts.html#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Empty environment and cache </span></span>
<span id="cb52-12"><a href="annex-i-compendium-of-r-scripts.html#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb52-13"><a href="annex-i-compendium-of-r-scripts.html#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb52-14"><a href="annex-i-compendium-of-r-scripts.html#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="annex-i-compendium-of-r-scripts.html#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script ========================================</span></span>
<span id="cb52-16"><a href="annex-i-compendium-of-r-scripts.html#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="annex-i-compendium-of-r-scripts.html#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Script for evaluation the degree of representativeness of a soil legacy dataset</span></span>
<span id="cb52-18"><a href="annex-i-compendium-of-r-scripts.html#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="co"># relative to the diversity of the environmental conditions described in a set </span></span>
<span id="cb52-19"><a href="annex-i-compendium-of-r-scripts.html#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="co"># of rasterb covariates.</span></span>
<span id="cb52-20"><a href="annex-i-compendium-of-r-scripts.html#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb52-21"><a href="annex-i-compendium-of-r-scripts.html#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load packages</span></span>
<span id="cb52-22"><a href="annex-i-compendium-of-r-scripts.html#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb52-23"><a href="annex-i-compendium-of-r-scripts.html#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Extract environmental data from rasters at soil locations</span></span>
<span id="cb52-24"><a href="annex-i-compendium-of-r-scripts.html#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Extract environmental data from rasters at soil locations</span></span>
<span id="cb52-25"><a href="annex-i-compendium-of-r-scripts.html#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Compute variability matrix in covariates</span></span>
<span id="cb52-26"><a href="annex-i-compendium-of-r-scripts.html#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Calculate hypercube of &quot;covariates&quot; distribution (P)</span></span>
<span id="cb52-27"><a href="annex-i-compendium-of-r-scripts.html#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Calculate hypercube of &quot;sample&quot; distribution (Q)</span></span>
<span id="cb52-28"><a href="annex-i-compendium-of-r-scripts.html#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Calculate Representativeness of the Legacy Dataset</span></span>
<span id="cb52-29"><a href="annex-i-compendium-of-r-scripts.html#cb52-29" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb52-30"><a href="annex-i-compendium-of-r-scripts.html#cb52-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-31"><a href="annex-i-compendium-of-r-scripts.html#cb52-31" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb52-32"><a href="annex-i-compendium-of-r-scripts.html#cb52-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-33"><a href="annex-i-compendium-of-r-scripts.html#cb52-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load packages =================================</span></span>
<span id="cb52-34"><a href="annex-i-compendium-of-r-scripts.html#cb52-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-35"><a href="annex-i-compendium-of-r-scripts.html#cb52-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#remotes::install_github(&quot;lemuscanovas/synoptReg&quot;)</span></span>
<span id="cb52-36"><a href="annex-i-compendium-of-r-scripts.html#cb52-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-37"><a href="annex-i-compendium-of-r-scripts.html#cb52-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb52-38"><a href="annex-i-compendium-of-r-scripts.html#cb52-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb52-39"><a href="annex-i-compendium-of-r-scripts.html#cb52-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb52-40"><a href="annex-i-compendium-of-r-scripts.html#cb52-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-41"><a href="annex-i-compendium-of-r-scripts.html#cb52-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of packages</span></span>
<span id="cb52-42"><a href="annex-i-compendium-of-r-scripts.html#cb52-42" aria-hidden="true" tabindex="-1"></a>  packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;terra&quot;</span>,<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sf&quot;</span>,<span class="st">&quot;clhs&quot;</span>, <span class="st">&quot;sgsR&quot;</span>,<span class="st">&quot;entropy&quot;</span>, <span class="st">&quot;tripack&quot;</span>,</span>
<span id="cb52-43"><a href="annex-i-compendium-of-r-scripts.html#cb52-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;manipulate&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;synoptReg&quot;</span>)</span>
<span id="cb52-44"><a href="annex-i-compendium-of-r-scripts.html#cb52-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages</span></span>
<span id="cb52-45"><a href="annex-i-compendium-of-r-scripts.html#cb52-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-46"><a href="annex-i-compendium-of-r-scripts.html#cb52-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove object to save memory space</span></span>
<span id="cb52-47"><a href="annex-i-compendium-of-r-scripts.html#cb52-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(packages) </span>
<span id="cb52-48"><a href="annex-i-compendium-of-r-scripts.html#cb52-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-49"><a href="annex-i-compendium-of-r-scripts.html#cb52-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-50"><a href="annex-i-compendium-of-r-scripts.html#cb52-50" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb52-51"><a href="annex-i-compendium-of-r-scripts.html#cb52-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to rasters</span></span>
<span id="cb52-52"><a href="annex-i-compendium-of-r-scripts.html#cb52-52" aria-hidden="true" tabindex="-1"></a>  raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters&quot;</span></span>
<span id="cb52-53"><a href="annex-i-compendium-of-r-scripts.html#cb52-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to shapes</span></span>
<span id="cb52-54"><a href="annex-i-compendium-of-r-scripts.html#cb52-54" aria-hidden="true" tabindex="-1"></a>  shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes&quot;</span></span>
<span id="cb52-55"><a href="annex-i-compendium-of-r-scripts.html#cb52-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to results</span></span>
<span id="cb52-56"><a href="annex-i-compendium-of-r-scripts.html#cb52-56" aria-hidden="true" tabindex="-1"></a>  results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb52-57"><a href="annex-i-compendium-of-r-scripts.html#cb52-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregation factor for up-scaling raster covariates (optional)</span></span>
<span id="cb52-58"><a href="annex-i-compendium-of-r-scripts.html#cb52-58" aria-hidden="true" tabindex="-1"></a>  agg.factor <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb52-59"><a href="annex-i-compendium-of-r-scripts.html#cb52-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-60"><a href="annex-i-compendium-of-r-scripts.html#cb52-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-61"><a href="annex-i-compendium-of-r-scripts.html#cb52-61" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Prepare data ============================================================</span></span>
<span id="cb52-62"><a href="annex-i-compendium-of-r-scripts.html#cb52-62" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Load raster covariate data</span></span>
<span id="cb52-63"><a href="annex-i-compendium-of-r-scripts.html#cb52-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb52-64"><a href="annex-i-compendium-of-r-scripts.html#cb52-64" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(raster.path, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-65"><a href="annex-i-compendium-of-r-scripts.html#cb52-65" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat) <span class="co"># SpatRaster from terra</span></span>
<span id="cb52-66"><a href="annex-i-compendium-of-r-scripts.html#cb52-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate stack to simplify data rasters for calculations </span></span>
<span id="cb52-67"><a href="annex-i-compendium-of-r-scripts.html#cb52-67" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(cov.dat, <span class="at">fact=</span>agg.factor, <span class="at">fun=</span><span class="st">&quot;mean&quot;</span>)</span>
<span id="cb52-68"><a href="annex-i-compendium-of-r-scripts.html#cb52-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-69"><a href="annex-i-compendium-of-r-scripts.html#cb52-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load shape of district</span></span>
<span id="cb52-70"><a href="annex-i-compendium-of-r-scripts.html#cb52-70" aria-hidden="true" tabindex="-1"></a>  nghe <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/Nghe_An.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb52-71"><a href="annex-i-compendium-of-r-scripts.html#cb52-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-72"><a href="annex-i-compendium-of-r-scripts.html#cb52-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crop covariates on administrative boundary</span></span>
<span id="cb52-73"><a href="annex-i-compendium-of-r-scripts.html#cb52-73" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb52-74"><a href="annex-i-compendium-of-r-scripts.html#cb52-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-75"><a href="annex-i-compendium-of-r-scripts.html#cb52-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform raster information with PCA</span></span>
<span id="cb52-76"><a href="annex-i-compendium-of-r-scripts.html#cb52-76" aria-hidden="true" tabindex="-1"></a>  pca <span class="ot">&lt;-</span> <span class="fu">raster_pca</span>(cov.dat)</span>
<span id="cb52-77"><a href="annex-i-compendium-of-r-scripts.html#cb52-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-78"><a href="annex-i-compendium-of-r-scripts.html#cb52-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get SpatRaster layers</span></span>
<span id="cb52-79"><a href="annex-i-compendium-of-r-scripts.html#cb52-79" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb52-80"><a href="annex-i-compendium-of-r-scripts.html#cb52-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a raster stack to be used as input in the clhs::clhs function </span></span>
<span id="cb52-81"><a href="annex-i-compendium-of-r-scripts.html#cb52-81" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat) </span>
<span id="cb52-82"><a href="annex-i-compendium-of-r-scripts.html#cb52-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset rasters</span></span>
<span id="cb52-83"><a href="annex-i-compendium-of-r-scripts.html#cb52-83" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb52-84"><a href="annex-i-compendium-of-r-scripts.html#cb52-84" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span>  cov.dat.ras[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb52-85"><a href="annex-i-compendium-of-r-scripts.html#cb52-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-86"><a href="annex-i-compendium-of-r-scripts.html#cb52-86" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 - Extract environmental data from rasters at soil locations ===============</span></span>
<span id="cb52-87"><a href="annex-i-compendium-of-r-scripts.html#cb52-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load legacy soil data</span></span>
<span id="cb52-88"><a href="annex-i-compendium-of-r-scripts.html#cb52-88" aria-hidden="true" tabindex="-1"></a>  p.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">vect</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/legacy_soils.shp&quot;</span>)))</span>
<span id="cb52-89"><a href="annex-i-compendium-of-r-scripts.html#cb52-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract data</span></span>
<span id="cb52-90"><a href="annex-i-compendium-of-r-scripts.html#cb52-90" aria-hidden="true" tabindex="-1"></a>  p.dat_I <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(cov.dat, p.dat)</span>
<span id="cb52-91"><a href="annex-i-compendium-of-r-scripts.html#cb52-91" aria-hidden="true" tabindex="-1"></a>  p.dat_I <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(p.dat_I) <span class="co"># Remove soil points outside study area</span></span>
<span id="cb52-92"><a href="annex-i-compendium-of-r-scripts.html#cb52-92" aria-hidden="true" tabindex="-1"></a>  p.dat_I.df <span class="ot">&lt;-</span> p.dat_I[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb52-93"><a href="annex-i-compendium-of-r-scripts.html#cb52-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>(p.dat_I.df)</span>
<span id="cb52-94"><a href="annex-i-compendium-of-r-scripts.html#cb52-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-95"><a href="annex-i-compendium-of-r-scripts.html#cb52-95" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 - Compute variability matrix in the covariates ====================================</span></span>
<span id="cb52-96"><a href="annex-i-compendium-of-r-scripts.html#cb52-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define Number of bins</span></span>
<span id="cb52-97"><a href="annex-i-compendium-of-r-scripts.html#cb52-97" aria-hidden="true" tabindex="-1"></a>  nb <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb52-98"><a href="annex-i-compendium-of-r-scripts.html#cb52-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Quantile matrix of the covariate data</span></span>
<span id="cb52-99"><a href="annex-i-compendium-of-r-scripts.html#cb52-99" aria-hidden="true" tabindex="-1"></a>  q.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> (nb <span class="sc">+</span> <span class="dv">1</span>), <span class="at">ncol =</span> <span class="fu">nlyr</span>(cov.dat))</span>
<span id="cb52-100"><a href="annex-i-compendium-of-r-scripts.html#cb52-100" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb52-101"><a href="annex-i-compendium-of-r-scripts.html#cb52-101" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(cov.dat)) {</span>
<span id="cb52-102"><a href="annex-i-compendium-of-r-scripts.html#cb52-102" aria-hidden="true" tabindex="-1"></a>    ran1 <span class="ot">&lt;-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>]</span>
<span id="cb52-103"><a href="annex-i-compendium-of-r-scripts.html#cb52-103" aria-hidden="true" tabindex="-1"></a>    step1 <span class="ot">&lt;-</span> ran1 <span class="sc">/</span> nb</span>
<span id="cb52-104"><a href="annex-i-compendium-of-r-scripts.html#cb52-104" aria-hidden="true" tabindex="-1"></a>    q.mat[, j] <span class="ot">&lt;-</span></span>
<span id="cb52-105"><a href="annex-i-compendium-of-r-scripts.html#cb52-105" aria-hidden="true" tabindex="-1"></a>      <span class="fu">seq</span>(<span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>],</span>
<span id="cb52-106"><a href="annex-i-compendium-of-r-scripts.html#cb52-106" aria-hidden="true" tabindex="-1"></a>          <span class="at">to =</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>],</span>
<span id="cb52-107"><a href="annex-i-compendium-of-r-scripts.html#cb52-107" aria-hidden="true" tabindex="-1"></a>          <span class="at">by =</span> step1)</span>
<span id="cb52-108"><a href="annex-i-compendium-of-r-scripts.html#cb52-108" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb52-109"><a href="annex-i-compendium-of-r-scripts.html#cb52-109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-110"><a href="annex-i-compendium-of-r-scripts.html#cb52-110" aria-hidden="true" tabindex="-1"></a>  q.mat</span>
<span id="cb52-111"><a href="annex-i-compendium-of-r-scripts.html#cb52-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-112"><a href="annex-i-compendium-of-r-scripts.html#cb52-112" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 - Calculate hypercube of &quot;covariates&quot; distribution (P)  ===================  </span></span>
<span id="cb52-113"><a href="annex-i-compendium-of-r-scripts.html#cb52-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert SpatRaster to dataframe for calculations</span></span>
<span id="cb52-114"><a href="annex-i-compendium-of-r-scripts.html#cb52-114" aria-hidden="true" tabindex="-1"></a>  cov.dat.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(cov.dat) </span>
<span id="cb52-115"><a href="annex-i-compendium-of-r-scripts.html#cb52-115" aria-hidden="true" tabindex="-1"></a>  cov.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb52-116"><a href="annex-i-compendium-of-r-scripts.html#cb52-116" aria-hidden="true" tabindex="-1"></a>  cov.dat.mx <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cov.dat.df)</span>
<span id="cb52-117"><a href="annex-i-compendium-of-r-scripts.html#cb52-117" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cov.dat.mx)) {</span>
<span id="cb52-118"><a href="annex-i-compendium-of-r-scripts.html#cb52-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.mx)) {</span>
<span id="cb52-119"><a href="annex-i-compendium-of-r-scripts.html#cb52-119" aria-hidden="true" tabindex="-1"></a>      dd <span class="ot">&lt;-</span> cov.dat.mx[[i, j]]</span>
<span id="cb52-120"><a href="annex-i-compendium-of-r-scripts.html#cb52-120" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb52-121"><a href="annex-i-compendium-of-r-scripts.html#cb52-121" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb52-122"><a href="annex-i-compendium-of-r-scripts.html#cb52-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb52-123"><a href="annex-i-compendium-of-r-scripts.html#cb52-123" aria-hidden="true" tabindex="-1"></a>          kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb52-124"><a href="annex-i-compendium-of-r-scripts.html#cb52-124" aria-hidden="true" tabindex="-1"></a>          ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb52-125"><a href="annex-i-compendium-of-r-scripts.html#cb52-125" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb52-126"><a href="annex-i-compendium-of-r-scripts.html#cb52-126" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb52-127"><a href="annex-i-compendium-of-r-scripts.html#cb52-127" aria-hidden="true" tabindex="-1"></a>            cov.mat[k, j] <span class="ot">&lt;-</span> cov.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb52-128"><a href="annex-i-compendium-of-r-scripts.html#cb52-128" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb52-129"><a href="annex-i-compendium-of-r-scripts.html#cb52-129" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb52-130"><a href="annex-i-compendium-of-r-scripts.html#cb52-130" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb52-131"><a href="annex-i-compendium-of-r-scripts.html#cb52-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-132"><a href="annex-i-compendium-of-r-scripts.html#cb52-132" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-133"><a href="annex-i-compendium-of-r-scripts.html#cb52-133" aria-hidden="true" tabindex="-1"></a>  cov.mat</span>
<span id="cb52-134"><a href="annex-i-compendium-of-r-scripts.html#cb52-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-135"><a href="annex-i-compendium-of-r-scripts.html#cb52-135" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 - Calculate hypercube of &quot;sample&quot; distribution (Q) ========================  </span></span>
<span id="cb52-136"><a href="annex-i-compendium-of-r-scripts.html#cb52-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-137"><a href="annex-i-compendium-of-r-scripts.html#cb52-137" aria-hidden="true" tabindex="-1"></a>  h.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb52-138"><a href="annex-i-compendium-of-r-scripts.html#cb52-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p.dat_I.df)) {</span>
<span id="cb52-139"><a href="annex-i-compendium-of-r-scripts.html#cb52-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(p.dat_I.df)) {</span>
<span id="cb52-140"><a href="annex-i-compendium-of-r-scripts.html#cb52-140" aria-hidden="true" tabindex="-1"></a>      dd <span class="ot">&lt;-</span> p.dat_I.df[i, j]</span>
<span id="cb52-141"><a href="annex-i-compendium-of-r-scripts.html#cb52-141" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb52-142"><a href="annex-i-compendium-of-r-scripts.html#cb52-142" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb52-143"><a href="annex-i-compendium-of-r-scripts.html#cb52-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb52-144"><a href="annex-i-compendium-of-r-scripts.html#cb52-144" aria-hidden="true" tabindex="-1"></a>          kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb52-145"><a href="annex-i-compendium-of-r-scripts.html#cb52-145" aria-hidden="true" tabindex="-1"></a>          ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb52-146"><a href="annex-i-compendium-of-r-scripts.html#cb52-146" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb52-147"><a href="annex-i-compendium-of-r-scripts.html#cb52-147" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb52-148"><a href="annex-i-compendium-of-r-scripts.html#cb52-148" aria-hidden="true" tabindex="-1"></a>            h.mat[k, j] <span class="ot">&lt;-</span> h.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb52-149"><a href="annex-i-compendium-of-r-scripts.html#cb52-149" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb52-150"><a href="annex-i-compendium-of-r-scripts.html#cb52-150" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb52-151"><a href="annex-i-compendium-of-r-scripts.html#cb52-151" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb52-152"><a href="annex-i-compendium-of-r-scripts.html#cb52-152" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-153"><a href="annex-i-compendium-of-r-scripts.html#cb52-153" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-154"><a href="annex-i-compendium-of-r-scripts.html#cb52-154" aria-hidden="true" tabindex="-1"></a>  h.mat </span>
<span id="cb52-155"><a href="annex-i-compendium-of-r-scripts.html#cb52-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-156"><a href="annex-i-compendium-of-r-scripts.html#cb52-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-157"><a href="annex-i-compendium-of-r-scripts.html#cb52-157" aria-hidden="true" tabindex="-1"></a><span class="do">## 7 - Calculate Representativeness of the Legacy Dataset ==================    </span></span>
<span id="cb52-158"><a href="annex-i-compendium-of-r-scripts.html#cb52-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-159"><a href="annex-i-compendium-of-r-scripts.html#cb52-159" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate the proportion of &quot;variables&quot; in the covariate spectra that fall within the convex hull of variables in the &quot;environmental sample space&quot;</span></span>
<span id="cb52-160"><a href="annex-i-compendium-of-r-scripts.html#cb52-160" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Principal component of the legacy data sample</span></span>
<span id="cb52-161"><a href="annex-i-compendium-of-r-scripts.html#cb52-161" aria-hidden="true" tabindex="-1"></a>  pca.s <span class="ot">=</span> <span class="fu">prcomp</span>(p.dat_I[,<span class="dv">2</span><span class="sc">:</span>(<span class="fu">ncol</span>(cov.dat.df)<span class="sc">+</span><span class="dv">1</span>)],<span class="at">scale=</span><span class="cn">TRUE</span>, <span class="at">center=</span><span class="cn">TRUE</span>)</span>
<span id="cb52-162"><a href="annex-i-compendium-of-r-scripts.html#cb52-162" aria-hidden="true" tabindex="-1"></a>  scores_pca1 <span class="ot">=</span> <span class="fu">as.data.frame</span>(pca.s<span class="sc">$</span>x)</span>
<span id="cb52-163"><a href="annex-i-compendium-of-r-scripts.html#cb52-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the first 2 principal components and convex hull</span></span>
<span id="cb52-164"><a href="annex-i-compendium-of-r-scripts.html#cb52-164" aria-hidden="true" tabindex="-1"></a>  rand.tr <span class="ot">&lt;-</span> <span class="fu">tri.mesh</span>(scores_pca1[,<span class="dv">1</span>],scores_pca1[,<span class="dv">2</span>],<span class="st">&quot;remove&quot;</span>) <span class="co"># Delaunay triangulation </span></span>
<span id="cb52-165"><a href="annex-i-compendium-of-r-scripts.html#cb52-165" aria-hidden="true" tabindex="-1"></a>  rand.ch <span class="ot">&lt;-</span> <span class="fu">convex.hull</span>(rand.tr, <span class="at">plot.it=</span>F) <span class="co"># convex hull</span></span>
<span id="cb52-166"><a href="annex-i-compendium-of-r-scripts.html#cb52-166" aria-hidden="true" tabindex="-1"></a>  pr_poly <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x=</span><span class="fu">c</span>(rand.ch<span class="sc">$</span>x),<span class="at">y=</span><span class="fu">c</span>(rand.ch<span class="sc">$</span>y)) <span class="co"># save the convex hull vertices</span></span>
<span id="cb52-167"><a href="annex-i-compendium-of-r-scripts.html#cb52-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(scores_pca1[,<span class="dv">1</span>], scores_pca1[,<span class="dv">2</span>], <span class="at">xlab=</span><span class="st">&quot;PCA 1&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;PCA 2&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])),<span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">main=</span><span class="st">&#39;Convex hull of soil legacy data&#39;</span>)</span>
<span id="cb52-168"><a href="annex-i-compendium-of-r-scripts.html#cb52-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">c</span>(rand.ch<span class="sc">$</span>x,rand.ch<span class="sc">$</span>x[<span class="dv">1</span>]), <span class="fu">c</span>(rand.ch<span class="sc">$</span>y,rand.ch<span class="sc">$</span>y[<span class="dv">1</span>]),<span class="at">col=</span><span class="st">&quot;red&quot;</span>,<span class="at">lwd=</span><span class="dv">1</span>) <span class="co"># draw the convex hull (domain of legacy data)</span></span>
<span id="cb52-169"><a href="annex-i-compendium-of-r-scripts.html#cb52-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-170"><a href="annex-i-compendium-of-r-scripts.html#cb52-170" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PCA projection of study area population onto the principal components</span></span>
<span id="cb52-171"><a href="annex-i-compendium-of-r-scripts.html#cb52-171" aria-hidden="true" tabindex="-1"></a>  PCA_projection <span class="ot">&lt;-</span> <span class="fu">predict</span>(pca.s, cov.dat.df) <span class="co"># Project study area population onto sample PC</span></span>
<span id="cb52-172"><a href="annex-i-compendium-of-r-scripts.html#cb52-172" aria-hidden="true" tabindex="-1"></a>  newScores <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x=</span>PCA_projection[,<span class="dv">1</span>],<span class="at">y=</span>PCA_projection[,<span class="dv">2</span>]) <span class="co"># PC scores of projected population</span></span>
<span id="cb52-173"><a href="annex-i-compendium-of-r-scripts.html#cb52-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-174"><a href="annex-i-compendium-of-r-scripts.html#cb52-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the polygon and all points to be checked</span></span>
<span id="cb52-175"><a href="annex-i-compendium-of-r-scripts.html#cb52-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(newScores, <span class="at">xlab=</span><span class="st">&quot;PCA 1&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;PCA 2&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">col=</span><span class="st">&#39;black&#39;</span>, <span class="at">main=</span><span class="st">&#39;Environmental space plots over the convex hull of soil legacy data&#39;</span>)</span>
<span id="cb52-176"><a href="annex-i-compendium-of-r-scripts.html#cb52-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(pr_poly,<span class="at">col=</span><span class="st">&#39;#99999990&#39;</span>)</span>
<span id="cb52-177"><a href="annex-i-compendium-of-r-scripts.html#cb52-177" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check which points fall within the polygon</span></span>
<span id="cb52-178"><a href="annex-i-compendium-of-r-scripts.html#cb52-178" aria-hidden="true" tabindex="-1"></a>  pip <span class="ot">&lt;-</span> <span class="fu">point.in.polygon</span>(newScores[,<span class="dv">2</span>], newScores[,<span class="dv">1</span>], pr_poly[,<span class="dv">2</span>],pr_poly[,<span class="dv">1</span>],<span class="at">mode.checked=</span><span class="cn">FALSE</span>)</span>
<span id="cb52-179"><a href="annex-i-compendium-of-r-scripts.html#cb52-179" aria-hidden="true" tabindex="-1"></a>  newScores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(newScores, pip))</span>
<span id="cb52-180"><a href="annex-i-compendium-of-r-scripts.html#cb52-180" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot points outside convex hull  </span></span>
<span id="cb52-181"><a href="annex-i-compendium-of-r-scripts.html#cb52-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(newScores[<span class="fu">which</span>(newScores<span class="sc">$</span>pip<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="at">pch=</span><span class="st">&#39;X&#39;</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb52-182"><a href="annex-i-compendium-of-r-scripts.html#cb52-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-183"><a href="annex-i-compendium-of-r-scripts.html#cb52-183" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  Proportion of the conditions in the study area that fall within the convex hull of sample conditions</span></span>
<span id="cb52-184"><a href="annex-i-compendium-of-r-scripts.html#cb52-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">nrow</span>(newScores[newScores<span class="sc">$</span>pip<span class="sc">&gt;</span><span class="dv">0</span>,]))<span class="sc">/</span><span class="fu">nrow</span>(newScores)<span class="sc">*</span><span class="dv">100</span> </span>
<span id="cb52-185"><a href="annex-i-compendium-of-r-scripts.html#cb52-185" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-186"><a href="annex-i-compendium-of-r-scripts.html#cb52-186" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="re">END</span></span></code></pre></div>
</div>
<div id="script-4-calculate-minimum-sample-size" class="section level2 unnumbered hasAnchor">
<h2>Script 4: Calculate Minimum Sample Size<a href="annex-i-compendium-of-r-scripts.html#script-4-calculate-minimum-sample-size" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="annex-i-compendium-of-r-scripts.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb53-2"><a href="annex-i-compendium-of-r-scripts.html#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb53-3"><a href="annex-i-compendium-of-r-scripts.html#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb53-4"><a href="annex-i-compendium-of-r-scripts.html#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimizing Sample Size</span></span>
<span id="cb53-5"><a href="annex-i-compendium-of-r-scripts.html#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb53-6"><a href="annex-i-compendium-of-r-scripts.html#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb53-7"><a href="annex-i-compendium-of-r-scripts.html#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb53-8"><a href="annex-i-compendium-of-r-scripts.html#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="annex-i-compendium-of-r-scripts.html#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb53-10"><a href="annex-i-compendium-of-r-scripts.html#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="annex-i-compendium-of-r-scripts.html#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Empty environment and cache </span></span>
<span id="cb53-12"><a href="annex-i-compendium-of-r-scripts.html#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb53-13"><a href="annex-i-compendium-of-r-scripts.html#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb53-14"><a href="annex-i-compendium-of-r-scripts.html#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="annex-i-compendium-of-r-scripts.html#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script ========================================</span></span>
<span id="cb53-16"><a href="annex-i-compendium-of-r-scripts.html#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="co"># The goal of this script is to determine the minimum sample size required to describe an area</span></span>
<span id="cb53-17"><a href="annex-i-compendium-of-r-scripts.html#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># while retaining for a 95% of representativeness in the environmental variability of covariates</span></span>
<span id="cb53-18"><a href="annex-i-compendium-of-r-scripts.html#cb53-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in the area </span></span>
<span id="cb53-19"><a href="annex-i-compendium-of-r-scripts.html#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb53-20"><a href="annex-i-compendium-of-r-scripts.html#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load necessary packages</span></span>
<span id="cb53-21"><a href="annex-i-compendium-of-r-scripts.html#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb53-22"><a href="annex-i-compendium-of-r-scripts.html#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import national data </span></span>
<span id="cb53-23"><a href="annex-i-compendium-of-r-scripts.html#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Calculate the minimum sample size to describe the area</span></span>
<span id="cb53-24"><a href="annex-i-compendium-of-r-scripts.html#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Plot covariate diversity as PCA scores </span></span>
<span id="cb53-25"><a href="annex-i-compendium-of-r-scripts.html#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - KL divergence and % similarity results for growing N samples</span></span>
<span id="cb53-26"><a href="annex-i-compendium-of-r-scripts.html#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Model KL divergence</span></span>
<span id="cb53-27"><a href="annex-i-compendium-of-r-scripts.html#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Determine the minimum sample size for 95% representativeness</span></span>
<span id="cb53-28"><a href="annex-i-compendium-of-r-scripts.html#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Determine the optimal iteration according to the minimum N size </span></span>
<span id="cb53-29"><a href="annex-i-compendium-of-r-scripts.html#cb53-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot minimum points from best iteration</span></span>
<span id="cb53-30"><a href="annex-i-compendium-of-r-scripts.html#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb53-31"><a href="annex-i-compendium-of-r-scripts.html#cb53-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-32"><a href="annex-i-compendium-of-r-scripts.html#cb53-32" aria-hidden="true" tabindex="-1"></a> start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb53-33"><a href="annex-i-compendium-of-r-scripts.html#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-34"><a href="annex-i-compendium-of-r-scripts.html#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load necessary packages =======================</span></span>
<span id="cb53-35"><a href="annex-i-compendium-of-r-scripts.html#cb53-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-36"><a href="annex-i-compendium-of-r-scripts.html#cb53-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb53-37"><a href="annex-i-compendium-of-r-scripts.html#cb53-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb53-38"><a href="annex-i-compendium-of-r-scripts.html#cb53-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb53-39"><a href="annex-i-compendium-of-r-scripts.html#cb53-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-40"><a href="annex-i-compendium-of-r-scripts.html#cb53-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of packages</span></span>
<span id="cb53-41"><a href="annex-i-compendium-of-r-scripts.html#cb53-41" aria-hidden="true" tabindex="-1"></a>  packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;terra&quot;</span>,<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sf&quot;</span>,<span class="st">&quot;clhs&quot;</span>,</span>
<span id="cb53-42"><a href="annex-i-compendium-of-r-scripts.html#cb53-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;sgsR&quot;</span>,<span class="st">&quot;entropy&quot;</span>, <span class="st">&quot;tripack&quot;</span>,</span>
<span id="cb53-43"><a href="annex-i-compendium-of-r-scripts.html#cb53-43" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;manipulate&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;plotly&quot;</span>,<span class="st">&quot;synoptReg&quot;</span>)</span>
<span id="cb53-44"><a href="annex-i-compendium-of-r-scripts.html#cb53-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-45"><a href="annex-i-compendium-of-r-scripts.html#cb53-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages</span></span>
<span id="cb53-46"><a href="annex-i-compendium-of-r-scripts.html#cb53-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>) </span>
<span id="cb53-47"><a href="annex-i-compendium-of-r-scripts.html#cb53-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(packages) <span class="co"># Remove object to save memory space</span></span>
<span id="cb53-48"><a href="annex-i-compendium-of-r-scripts.html#cb53-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-49"><a href="annex-i-compendium-of-r-scripts.html#cb53-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-50"><a href="annex-i-compendium-of-r-scripts.html#cb53-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-51"><a href="annex-i-compendium-of-r-scripts.html#cb53-51" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb53-52"><a href="annex-i-compendium-of-r-scripts.html#cb53-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to rasters</span></span>
<span id="cb53-53"><a href="annex-i-compendium-of-r-scripts.html#cb53-53" aria-hidden="true" tabindex="-1"></a>  raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters/&quot;</span></span>
<span id="cb53-54"><a href="annex-i-compendium-of-r-scripts.html#cb53-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to shapes</span></span>
<span id="cb53-55"><a href="annex-i-compendium-of-r-scripts.html#cb53-55" aria-hidden="true" tabindex="-1"></a>  shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes/&quot;</span></span>
<span id="cb53-56"><a href="annex-i-compendium-of-r-scripts.html#cb53-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to results</span></span>
<span id="cb53-57"><a href="annex-i-compendium-of-r-scripts.html#cb53-57" aria-hidden="true" tabindex="-1"></a>  results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb53-58"><a href="annex-i-compendium-of-r-scripts.html#cb53-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregation factor for up-scaling raster covariates (optional)</span></span>
<span id="cb53-59"><a href="annex-i-compendium-of-r-scripts.html#cb53-59" aria-hidden="true" tabindex="-1"></a>  agg.factor <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb53-60"><a href="annex-i-compendium-of-r-scripts.html#cb53-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-61"><a href="annex-i-compendium-of-r-scripts.html#cb53-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Define parameters to determine minimum sampling size</span></span>
<span id="cb53-62"><a href="annex-i-compendium-of-r-scripts.html#cb53-62" aria-hidden="true" tabindex="-1"></a>  initial.n <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="co"># Initial sampling size to test</span></span>
<span id="cb53-63"><a href="annex-i-compendium-of-r-scripts.html#cb53-63" aria-hidden="true" tabindex="-1"></a>  final.n <span class="ot">&lt;-</span> <span class="dv">300</span> <span class="co"># Final sampling size to test</span></span>
<span id="cb53-64"><a href="annex-i-compendium-of-r-scripts.html#cb53-64" aria-hidden="true" tabindex="-1"></a>  by.n <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># Increment size</span></span>
<span id="cb53-65"><a href="annex-i-compendium-of-r-scripts.html#cb53-65" aria-hidden="true" tabindex="-1"></a>  iters <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># Number of trials on each size</span></span>
<span id="cb53-66"><a href="annex-i-compendium-of-r-scripts.html#cb53-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-67"><a href="annex-i-compendium-of-r-scripts.html#cb53-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-68"><a href="annex-i-compendium-of-r-scripts.html#cb53-68" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Import national data ====================================================</span></span>
<span id="cb53-69"><a href="annex-i-compendium-of-r-scripts.html#cb53-69" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Load raster covariate data</span></span>
<span id="cb53-70"><a href="annex-i-compendium-of-r-scripts.html#cb53-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb53-71"><a href="annex-i-compendium-of-r-scripts.html#cb53-71" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(raster.path, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-72"><a href="annex-i-compendium-of-r-scripts.html#cb53-72" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat) <span class="co"># SpatRaster from terra</span></span>
<span id="cb53-73"><a href="annex-i-compendium-of-r-scripts.html#cb53-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate stack to simplify data rasters for calculations </span></span>
<span id="cb53-74"><a href="annex-i-compendium-of-r-scripts.html#cb53-74" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(cov.dat, <span class="at">fact=</span>agg.factor, <span class="at">fun=</span><span class="st">&quot;mean&quot;</span>)</span>
<span id="cb53-75"><a href="annex-i-compendium-of-r-scripts.html#cb53-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load shape of district</span></span>
<span id="cb53-76"><a href="annex-i-compendium-of-r-scripts.html#cb53-76" aria-hidden="true" tabindex="-1"></a>  nghe <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/Nghe_An.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb53-77"><a href="annex-i-compendium-of-r-scripts.html#cb53-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-78"><a href="annex-i-compendium-of-r-scripts.html#cb53-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crop covariates on administrative boundary</span></span>
<span id="cb53-79"><a href="annex-i-compendium-of-r-scripts.html#cb53-79" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb53-80"><a href="annex-i-compendium-of-r-scripts.html#cb53-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store elevation and slope separately</span></span>
<span id="cb53-81"><a href="annex-i-compendium-of-r-scripts.html#cb53-81" aria-hidden="true" tabindex="-1"></a>  elevation <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_elevation_250m</span>
<span id="cb53-82"><a href="annex-i-compendium-of-r-scripts.html#cb53-82" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_slope_250m</span>
<span id="cb53-83"><a href="annex-i-compendium-of-r-scripts.html#cb53-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-84"><a href="annex-i-compendium-of-r-scripts.html#cb53-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load roads</span></span>
<span id="cb53-85"><a href="annex-i-compendium-of-r-scripts.html#cb53-85" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span>  <span class="fu">vect</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/roads.shp&quot;</span>)))</span>
<span id="cb53-86"><a href="annex-i-compendium-of-r-scripts.html#cb53-86" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span> <span class="fu">crop</span>(roads, nghe)</span>
<span id="cb53-87"><a href="annex-i-compendium-of-r-scripts.html#cb53-87" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb53-88"><a href="annex-i-compendium-of-r-scripts.html#cb53-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simplify raster information with PCA</span></span>
<span id="cb53-89"><a href="annex-i-compendium-of-r-scripts.html#cb53-89" aria-hidden="true" tabindex="-1"></a>  pca <span class="ot">&lt;-</span> <span class="fu">raster_pca</span>(cov.dat)</span>
<span id="cb53-90"><a href="annex-i-compendium-of-r-scripts.html#cb53-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-91"><a href="annex-i-compendium-of-r-scripts.html#cb53-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get SpatRaster layers</span></span>
<span id="cb53-92"><a href="annex-i-compendium-of-r-scripts.html#cb53-92" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb53-93"><a href="annex-i-compendium-of-r-scripts.html#cb53-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a raster stack to be used as input in the clhs::clhs function </span></span>
<span id="cb53-94"><a href="annex-i-compendium-of-r-scripts.html#cb53-94" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat) </span>
<span id="cb53-95"><a href="annex-i-compendium-of-r-scripts.html#cb53-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset rasters</span></span>
<span id="cb53-96"><a href="annex-i-compendium-of-r-scripts.html#cb53-96" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb53-97"><a href="annex-i-compendium-of-r-scripts.html#cb53-97" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span>  cov.dat.ras[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb53-98"><a href="annex-i-compendium-of-r-scripts.html#cb53-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot covariates</span></span>
<span id="cb53-99"><a href="annex-i-compendium-of-r-scripts.html#cb53-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat)</span>
<span id="cb53-100"><a href="annex-i-compendium-of-r-scripts.html#cb53-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-101"><a href="annex-i-compendium-of-r-scripts.html#cb53-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-102"><a href="annex-i-compendium-of-r-scripts.html#cb53-102" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Calculate the minimum sample size to describe the area ===================</span></span>
<span id="cb53-103"><a href="annex-i-compendium-of-r-scripts.html#cb53-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start computations ----</span></span>
<span id="cb53-104"><a href="annex-i-compendium-of-r-scripts.html#cb53-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize empty vectors to store results</span></span>
<span id="cb53-105"><a href="annex-i-compendium-of-r-scripts.html#cb53-105" aria-hidden="true" tabindex="-1"></a>  number_of_samples <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb53-106"><a href="annex-i-compendium-of-r-scripts.html#cb53-106" aria-hidden="true" tabindex="-1"></a>  prop_explained <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb53-107"><a href="annex-i-compendium-of-r-scripts.html#cb53-107" aria-hidden="true" tabindex="-1"></a>  klo_samples <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb53-108"><a href="annex-i-compendium-of-r-scripts.html#cb53-108" aria-hidden="true" tabindex="-1"></a>  samples_storage <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb53-109"><a href="annex-i-compendium-of-r-scripts.html#cb53-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-110"><a href="annex-i-compendium-of-r-scripts.html#cb53-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert SpatRaster to dataframe</span></span>
<span id="cb53-111"><a href="annex-i-compendium-of-r-scripts.html#cb53-111" aria-hidden="true" tabindex="-1"></a>  cov.dat.df <span class="ot">&lt;-</span>  <span class="fu">as.data.frame</span>(cov.dat)</span>
<span id="cb53-112"><a href="annex-i-compendium-of-r-scripts.html#cb53-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-113"><a href="annex-i-compendium-of-r-scripts.html#cb53-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start evaluation with growing sample sizes</span></span>
<span id="cb53-114"><a href="annex-i-compendium-of-r-scripts.html#cb53-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (trial <span class="cf">in</span> <span class="fu">seq</span>(initial.n, final.n, <span class="at">by =</span> by.n)) {</span>
<span id="cb53-115"><a href="annex-i-compendium-of-r-scripts.html#cb53-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (iteration <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>iters) {</span>
<span id="cb53-116"><a href="annex-i-compendium-of-r-scripts.html#cb53-116" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Generate stratified clhs samples</span></span>
<span id="cb53-117"><a href="annex-i-compendium-of-r-scripts.html#cb53-117" aria-hidden="true" tabindex="-1"></a>      p.dat_I <span class="ot">&lt;-</span>  <span class="fu">clhs</span>(cov.dat.ras,</span>
<span id="cb53-118"><a href="annex-i-compendium-of-r-scripts.html#cb53-118" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> trial, <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb53-119"><a href="annex-i-compendium-of-r-scripts.html#cb53-119" aria-hidden="true" tabindex="-1"></a>          <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb53-120"><a href="annex-i-compendium-of-r-scripts.html#cb53-120" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-121"><a href="annex-i-compendium-of-r-scripts.html#cb53-121" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Get covariate values and coordinates for each point</span></span>
<span id="cb53-122"><a href="annex-i-compendium-of-r-scripts.html#cb53-122" aria-hidden="true" tabindex="-1"></a>      p.dat_I <span class="ot">&lt;-</span> p.dat_I<span class="sc">$</span>sampled_data</span>
<span id="cb53-123"><a href="annex-i-compendium-of-r-scripts.html#cb53-123" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Get covariate values as dataframe and delete NAs</span></span>
<span id="cb53-124"><a href="annex-i-compendium-of-r-scripts.html#cb53-124" aria-hidden="true" tabindex="-1"></a>      p.dat_I.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(p.dat_I<span class="sc">@</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb53-125"><a href="annex-i-compendium-of-r-scripts.html#cb53-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">na.omit</span>()</span>
<span id="cb53-126"><a href="annex-i-compendium-of-r-scripts.html#cb53-126" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-127"><a href="annex-i-compendium-of-r-scripts.html#cb53-127" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Store samples as list</span></span>
<span id="cb53-128"><a href="annex-i-compendium-of-r-scripts.html#cb53-128" aria-hidden="true" tabindex="-1"></a>      samples_storage[[<span class="fu">paste0</span>(<span class="st">&quot;N&quot;</span>, trial, <span class="st">&quot;_&quot;</span>, iteration)]] <span class="ot">&lt;-</span> p.dat_I</span>
<span id="cb53-129"><a href="annex-i-compendium-of-r-scripts.html#cb53-129" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-130"><a href="annex-i-compendium-of-r-scripts.html#cb53-130" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Comparison of population and sample distributions - Kullback-Leibler (KL) divergence</span></span>
<span id="cb53-131"><a href="annex-i-compendium-of-r-scripts.html#cb53-131" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Define quantiles of the study area (number of bins)</span></span>
<span id="cb53-132"><a href="annex-i-compendium-of-r-scripts.html#cb53-132" aria-hidden="true" tabindex="-1"></a>      nb <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb53-133"><a href="annex-i-compendium-of-r-scripts.html#cb53-133" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Quantile matrix of the covariate data</span></span>
<span id="cb53-134"><a href="annex-i-compendium-of-r-scripts.html#cb53-134" aria-hidden="true" tabindex="-1"></a>      q.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> (nb <span class="sc">+</span> <span class="dv">1</span>), <span class="at">ncol =</span> <span class="fu">nlyr</span>(cov.dat))</span>
<span id="cb53-135"><a href="annex-i-compendium-of-r-scripts.html#cb53-135" aria-hidden="true" tabindex="-1"></a>      j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb53-136"><a href="annex-i-compendium-of-r-scripts.html#cb53-136" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(cov.dat)) {</span>
<span id="cb53-137"><a href="annex-i-compendium-of-r-scripts.html#cb53-137" aria-hidden="true" tabindex="-1"></a>        ran1 <span class="ot">&lt;-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>]</span>
<span id="cb53-138"><a href="annex-i-compendium-of-r-scripts.html#cb53-138" aria-hidden="true" tabindex="-1"></a>        step1 <span class="ot">&lt;-</span> ran1 <span class="sc">/</span> nb</span>
<span id="cb53-139"><a href="annex-i-compendium-of-r-scripts.html#cb53-139" aria-hidden="true" tabindex="-1"></a>        q.mat[, j] <span class="ot">&lt;-</span></span>
<span id="cb53-140"><a href="annex-i-compendium-of-r-scripts.html#cb53-140" aria-hidden="true" tabindex="-1"></a>          <span class="fu">seq</span>(<span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>],</span>
<span id="cb53-141"><a href="annex-i-compendium-of-r-scripts.html#cb53-141" aria-hidden="true" tabindex="-1"></a>              <span class="at">to =</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>],</span>
<span id="cb53-142"><a href="annex-i-compendium-of-r-scripts.html#cb53-142" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> step1)</span>
<span id="cb53-143"><a href="annex-i-compendium-of-r-scripts.html#cb53-143" aria-hidden="true" tabindex="-1"></a>        j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb53-144"><a href="annex-i-compendium-of-r-scripts.html#cb53-144" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb53-145"><a href="annex-i-compendium-of-r-scripts.html#cb53-145" aria-hidden="true" tabindex="-1"></a>      <span class="co"># q.mat</span></span>
<span id="cb53-146"><a href="annex-i-compendium-of-r-scripts.html#cb53-146" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-147"><a href="annex-i-compendium-of-r-scripts.html#cb53-147" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Hypercube of covariates in study area</span></span>
<span id="cb53-148"><a href="annex-i-compendium-of-r-scripts.html#cb53-148" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Initialize the covariate matrix</span></span>
<span id="cb53-149"><a href="annex-i-compendium-of-r-scripts.html#cb53-149" aria-hidden="true" tabindex="-1"></a>      cov.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb53-150"><a href="annex-i-compendium-of-r-scripts.html#cb53-150" aria-hidden="true" tabindex="-1"></a>      cov.dat.mx <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cov.dat.df)</span>
<span id="cb53-151"><a href="annex-i-compendium-of-r-scripts.html#cb53-151" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cov.dat.mx)) {</span>
<span id="cb53-152"><a href="annex-i-compendium-of-r-scripts.html#cb53-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.mx)) {</span>
<span id="cb53-153"><a href="annex-i-compendium-of-r-scripts.html#cb53-153" aria-hidden="true" tabindex="-1"></a>          dd <span class="ot">&lt;-</span> cov.dat.mx[[i, j]]</span>
<span id="cb53-154"><a href="annex-i-compendium-of-r-scripts.html#cb53-154" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-155"><a href="annex-i-compendium-of-r-scripts.html#cb53-155" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb53-156"><a href="annex-i-compendium-of-r-scripts.html#cb53-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb53-157"><a href="annex-i-compendium-of-r-scripts.html#cb53-157" aria-hidden="true" tabindex="-1"></a>              kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb53-158"><a href="annex-i-compendium-of-r-scripts.html#cb53-158" aria-hidden="true" tabindex="-1"></a>              ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb53-159"><a href="annex-i-compendium-of-r-scripts.html#cb53-159" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb53-160"><a href="annex-i-compendium-of-r-scripts.html#cb53-160" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb53-161"><a href="annex-i-compendium-of-r-scripts.html#cb53-161" aria-hidden="true" tabindex="-1"></a>                cov.mat[k, j] <span class="ot">&lt;-</span> cov.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb53-162"><a href="annex-i-compendium-of-r-scripts.html#cb53-162" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb53-163"><a href="annex-i-compendium-of-r-scripts.html#cb53-163" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb53-164"><a href="annex-i-compendium-of-r-scripts.html#cb53-164" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb53-165"><a href="annex-i-compendium-of-r-scripts.html#cb53-165" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb53-166"><a href="annex-i-compendium-of-r-scripts.html#cb53-166" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb53-167"><a href="annex-i-compendium-of-r-scripts.html#cb53-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-168"><a href="annex-i-compendium-of-r-scripts.html#cb53-168" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compare whole study area covariate space with the selected sample</span></span>
<span id="cb53-169"><a href="annex-i-compendium-of-r-scripts.html#cb53-169" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Sample data hypercube (the same as for the raster data but on the sample data)</span></span>
<span id="cb53-170"><a href="annex-i-compendium-of-r-scripts.html#cb53-170" aria-hidden="true" tabindex="-1"></a>      h.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb53-171"><a href="annex-i-compendium-of-r-scripts.html#cb53-171" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p.dat_I.df)) {</span>
<span id="cb53-172"><a href="annex-i-compendium-of-r-scripts.html#cb53-172" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(p.dat_I.df)) {</span>
<span id="cb53-173"><a href="annex-i-compendium-of-r-scripts.html#cb53-173" aria-hidden="true" tabindex="-1"></a>          dd <span class="ot">&lt;-</span> p.dat_I.df[i, j]</span>
<span id="cb53-174"><a href="annex-i-compendium-of-r-scripts.html#cb53-174" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb53-175"><a href="annex-i-compendium-of-r-scripts.html#cb53-175" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb53-176"><a href="annex-i-compendium-of-r-scripts.html#cb53-176" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb53-177"><a href="annex-i-compendium-of-r-scripts.html#cb53-177" aria-hidden="true" tabindex="-1"></a>              kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb53-178"><a href="annex-i-compendium-of-r-scripts.html#cb53-178" aria-hidden="true" tabindex="-1"></a>              ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb53-179"><a href="annex-i-compendium-of-r-scripts.html#cb53-179" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb53-180"><a href="annex-i-compendium-of-r-scripts.html#cb53-180" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb53-181"><a href="annex-i-compendium-of-r-scripts.html#cb53-181" aria-hidden="true" tabindex="-1"></a>                h.mat[k, j] <span class="ot">&lt;-</span> h.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb53-182"><a href="annex-i-compendium-of-r-scripts.html#cb53-182" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb53-183"><a href="annex-i-compendium-of-r-scripts.html#cb53-183" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb53-184"><a href="annex-i-compendium-of-r-scripts.html#cb53-184" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb53-185"><a href="annex-i-compendium-of-r-scripts.html#cb53-185" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb53-186"><a href="annex-i-compendium-of-r-scripts.html#cb53-186" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb53-187"><a href="annex-i-compendium-of-r-scripts.html#cb53-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-188"><a href="annex-i-compendium-of-r-scripts.html#cb53-188" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Compute Kullback-Leibler (KL) divergence</span></span>
<span id="cb53-189"><a href="annex-i-compendium-of-r-scripts.html#cb53-189" aria-hidden="true" tabindex="-1"></a>      kl.index <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb53-190"><a href="annex-i-compendium-of-r-scripts.html#cb53-190" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.df)) {</span>
<span id="cb53-191"><a href="annex-i-compendium-of-r-scripts.html#cb53-191" aria-hidden="true" tabindex="-1"></a>        kl <span class="ot">&lt;-</span>    <span class="fu">KL.empirical</span>(<span class="fu">c</span>(cov.mat[, i]), <span class="fu">c</span>(h.mat[, i]))</span>
<span id="cb53-192"><a href="annex-i-compendium-of-r-scripts.html#cb53-192" aria-hidden="true" tabindex="-1"></a>        kl.index <span class="ot">&lt;-</span> <span class="fu">c</span>(kl.index, kl)</span>
<span id="cb53-193"><a href="annex-i-compendium-of-r-scripts.html#cb53-193" aria-hidden="true" tabindex="-1"></a>        klo <span class="ot">&lt;-</span>  <span class="fu">mean</span>(kl.index)</span>
<span id="cb53-194"><a href="annex-i-compendium-of-r-scripts.html#cb53-194" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb53-195"><a href="annex-i-compendium-of-r-scripts.html#cb53-195" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-196"><a href="annex-i-compendium-of-r-scripts.html#cb53-196" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Calculate the proportion of &quot;env. variables&quot; in the covariate spectra that fall within the convex hull of variables in the &quot;environmental sample space&quot;</span></span>
<span id="cb53-197"><a href="annex-i-compendium-of-r-scripts.html#cb53-197" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Principal component of the data sample</span></span>
<span id="cb53-198"><a href="annex-i-compendium-of-r-scripts.html#cb53-198" aria-hidden="true" tabindex="-1"></a>      pca.s <span class="ot">=</span> <span class="fu">prcomp</span>(p.dat_I.df, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-199"><a href="annex-i-compendium-of-r-scripts.html#cb53-199" aria-hidden="true" tabindex="-1"></a>      scores_pca1 <span class="ot">=</span> <span class="fu">as.data.frame</span>(pca.s<span class="sc">$</span>x)</span>
<span id="cb53-200"><a href="annex-i-compendium-of-r-scripts.html#cb53-200" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Plot the first 2 principal components and convex hull</span></span>
<span id="cb53-201"><a href="annex-i-compendium-of-r-scripts.html#cb53-201" aria-hidden="true" tabindex="-1"></a>      rand.tr <span class="ot">&lt;-</span></span>
<span id="cb53-202"><a href="annex-i-compendium-of-r-scripts.html#cb53-202" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tri.mesh</span>(scores_pca1[, <span class="dv">1</span>], scores_pca1[, <span class="dv">2</span>], <span class="st">&quot;remove&quot;</span>) <span class="co"># Delaunay triangulation</span></span>
<span id="cb53-203"><a href="annex-i-compendium-of-r-scripts.html#cb53-203" aria-hidden="true" tabindex="-1"></a>      rand.ch <span class="ot">&lt;-</span> <span class="fu">convex.hull</span>(rand.tr, <span class="at">plot.it =</span> F) <span class="co"># convex hull</span></span>
<span id="cb53-204"><a href="annex-i-compendium-of-r-scripts.html#cb53-204" aria-hidden="true" tabindex="-1"></a>      pr_poly <span class="ot">&lt;-</span></span>
<span id="cb53-205"><a href="annex-i-compendium-of-r-scripts.html#cb53-205" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cbind</span>(<span class="at">x =</span> <span class="fu">c</span>(rand.ch<span class="sc">$</span>x), <span class="at">y =</span> <span class="fu">c</span>(rand.ch<span class="sc">$</span>y)) <span class="co"># save the convex hull vertices</span></span>
<span id="cb53-206"><a href="annex-i-compendium-of-r-scripts.html#cb53-206" aria-hidden="true" tabindex="-1"></a>      <span class="co"># PCA projection of study area population onto the principal components</span></span>
<span id="cb53-207"><a href="annex-i-compendium-of-r-scripts.html#cb53-207" aria-hidden="true" tabindex="-1"></a>      PCA_projection <span class="ot">&lt;-</span></span>
<span id="cb53-208"><a href="annex-i-compendium-of-r-scripts.html#cb53-208" aria-hidden="true" tabindex="-1"></a>        <span class="fu">predict</span>(pca.s, cov.dat.df) <span class="co"># Project study area population onto sample PC</span></span>
<span id="cb53-209"><a href="annex-i-compendium-of-r-scripts.html#cb53-209" aria-hidden="true" tabindex="-1"></a>      newScores <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x =</span> PCA_projection[, <span class="dv">1</span>], <span class="at">y =</span> PCA_projection[, <span class="dv">2</span>]) <span class="co"># PC scores of projected population</span></span>
<span id="cb53-210"><a href="annex-i-compendium-of-r-scripts.html#cb53-210" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Check which points fall within the polygon</span></span>
<span id="cb53-211"><a href="annex-i-compendium-of-r-scripts.html#cb53-211" aria-hidden="true" tabindex="-1"></a>      pip <span class="ot">&lt;-</span></span>
<span id="cb53-212"><a href="annex-i-compendium-of-r-scripts.html#cb53-212" aria-hidden="true" tabindex="-1"></a>        <span class="fu">point.in.polygon</span>(newScores[, <span class="dv">2</span>], newScores[, <span class="dv">1</span>], pr_poly[, <span class="dv">2</span>], pr_poly[, <span class="dv">1</span>], <span class="at">mode.checked =</span></span>
<span id="cb53-213"><a href="annex-i-compendium-of-r-scripts.html#cb53-213" aria-hidden="true" tabindex="-1"></a>                           <span class="cn">FALSE</span>)</span>
<span id="cb53-214"><a href="annex-i-compendium-of-r-scripts.html#cb53-214" aria-hidden="true" tabindex="-1"></a>      newScores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(newScores, pip))</span>
<span id="cb53-215"><a href="annex-i-compendium-of-r-scripts.html#cb53-215" aria-hidden="true" tabindex="-1"></a>      klo_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(klo_samples, klo)</span>
<span id="cb53-216"><a href="annex-i-compendium-of-r-scripts.html#cb53-216" aria-hidden="true" tabindex="-1"></a>      prop_explained <span class="ot">&lt;-</span></span>
<span id="cb53-217"><a href="annex-i-compendium-of-r-scripts.html#cb53-217" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(prop_explained, <span class="fu">sum</span>(newScores<span class="sc">$</span>pip) <span class="sc">/</span> <span class="fu">nrow</span>(newScores) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb53-218"><a href="annex-i-compendium-of-r-scripts.html#cb53-218" aria-hidden="true" tabindex="-1"></a>      number_of_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(number_of_samples, trial)</span>
<span id="cb53-219"><a href="annex-i-compendium-of-r-scripts.html#cb53-219" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(</span>
<span id="cb53-220"><a href="annex-i-compendium-of-r-scripts.html#cb53-220" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste</span>(</span>
<span id="cb53-221"><a href="annex-i-compendium-of-r-scripts.html#cb53-221" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;N samples = &quot;</span>,</span>
<span id="cb53-222"><a href="annex-i-compendium-of-r-scripts.html#cb53-222" aria-hidden="true" tabindex="-1"></a>          trial,</span>
<span id="cb53-223"><a href="annex-i-compendium-of-r-scripts.html#cb53-223" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot; out of &quot;</span>,</span>
<span id="cb53-224"><a href="annex-i-compendium-of-r-scripts.html#cb53-224" aria-hidden="true" tabindex="-1"></a>          final.n,</span>
<span id="cb53-225"><a href="annex-i-compendium-of-r-scripts.html#cb53-225" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;; iteration = &quot;</span>,</span>
<span id="cb53-226"><a href="annex-i-compendium-of-r-scripts.html#cb53-226" aria-hidden="true" tabindex="-1"></a>          iteration,</span>
<span id="cb53-227"><a href="annex-i-compendium-of-r-scripts.html#cb53-227" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;; KL = &quot;</span>,</span>
<span id="cb53-228"><a href="annex-i-compendium-of-r-scripts.html#cb53-228" aria-hidden="true" tabindex="-1"></a>          klo,</span>
<span id="cb53-229"><a href="annex-i-compendium-of-r-scripts.html#cb53-229" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;; Proportion = &quot;</span>,</span>
<span id="cb53-230"><a href="annex-i-compendium-of-r-scripts.html#cb53-230" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(newScores<span class="sc">$</span>pip) <span class="sc">/</span> <span class="fu">nrow</span>(newScores) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb53-231"><a href="annex-i-compendium-of-r-scripts.html#cb53-231" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-232"><a href="annex-i-compendium-of-r-scripts.html#cb53-232" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb53-233"><a href="annex-i-compendium-of-r-scripts.html#cb53-233" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-234"><a href="annex-i-compendium-of-r-scripts.html#cb53-234" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-235"><a href="annex-i-compendium-of-r-scripts.html#cb53-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-236"><a href="annex-i-compendium-of-r-scripts.html#cb53-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-237"><a href="annex-i-compendium-of-r-scripts.html#cb53-237" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Plot covariate diversity as PCA scores ===================================</span></span>
<span id="cb53-238"><a href="annex-i-compendium-of-r-scripts.html#cb53-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb53-239"><a href="annex-i-compendium-of-r-scripts.html#cb53-239" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">&quot;PCA 1&quot;</span>,</span>
<span id="cb53-240"><a href="annex-i-compendium-of-r-scripts.html#cb53-240" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">&quot;PCA 2&quot;</span>,</span>
<span id="cb53-241"><a href="annex-i-compendium-of-r-scripts.html#cb53-241" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T)),</span>
<span id="cb53-242"><a href="annex-i-compendium-of-r-scripts.html#cb53-242" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T)),</span>
<span id="cb53-243"><a href="annex-i-compendium-of-r-scripts.html#cb53-243" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">&#39;black&#39;</span>,</span>
<span id="cb53-244"><a href="annex-i-compendium-of-r-scripts.html#cb53-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&#39;Environmental space plots on convex hull of soil samples&#39;</span>)</span>
<span id="cb53-245"><a href="annex-i-compendium-of-r-scripts.html#cb53-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-246"><a href="annex-i-compendium-of-r-scripts.html#cb53-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(pr_poly, <span class="at">col =</span> <span class="st">&#39;#99999990&#39;</span>)</span>
<span id="cb53-247"><a href="annex-i-compendium-of-r-scripts.html#cb53-247" aria-hidden="true" tabindex="-1"></a><span class="co"># # Plot points outside convex hull</span></span>
<span id="cb53-248"><a href="annex-i-compendium-of-r-scripts.html#cb53-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(newScores[<span class="fu">which</span>(newScores<span class="sc">$</span>pip <span class="sc">==</span> <span class="dv">0</span>), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb53-249"><a href="annex-i-compendium-of-r-scripts.html#cb53-249" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="st">&#39;red&#39;</span>,</span>
<span id="cb53-250"><a href="annex-i-compendium-of-r-scripts.html#cb53-250" aria-hidden="true" tabindex="-1"></a>         <span class="at">pch =</span> <span class="dv">12</span>,</span>
<span id="cb53-251"><a href="annex-i-compendium-of-r-scripts.html#cb53-251" aria-hidden="true" tabindex="-1"></a>         <span class="at">cex =</span> <span class="dv">1</span>)</span>
<span id="cb53-252"><a href="annex-i-compendium-of-r-scripts.html#cb53-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-253"><a href="annex-i-compendium-of-r-scripts.html#cb53-253" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - KL divergence and % representativeness for growing N samples =============</span></span>
<span id="cb53-254"><a href="annex-i-compendium-of-r-scripts.html#cb53-254" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge data from number of samples, KL divergence and % representativeness</span></span>
<span id="cb53-255"><a href="annex-i-compendium-of-r-scripts.html#cb53-255" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(number_of_samples, klo_samples, prop_explained)</span>
<span id="cb53-256"><a href="annex-i-compendium-of-r-scripts.html#cb53-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;N&quot;</span>, <span class="st">&quot;KL&quot;</span>, <span class="st">&quot;Perc&quot;</span>)</span>
<span id="cb53-257"><a href="annex-i-compendium-of-r-scripts.html#cb53-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-258"><a href="annex-i-compendium-of-r-scripts.html#cb53-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate mean results by N size</span></span>
<span id="cb53-259"><a href="annex-i-compendium-of-r-scripts.html#cb53-259" aria-hidden="true" tabindex="-1"></a>    mean_result <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb53-260"><a href="annex-i-compendium-of-r-scripts.html#cb53-260" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(N) <span class="sc">%&gt;%</span></span>
<span id="cb53-261"><a href="annex-i-compendium-of-r-scripts.html#cb53-261" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize_all</span>(mean)</span>
<span id="cb53-262"><a href="annex-i-compendium-of-r-scripts.html#cb53-262" aria-hidden="true" tabindex="-1"></a>    mean_result</span>
<span id="cb53-263"><a href="annex-i-compendium-of-r-scripts.html#cb53-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-264"><a href="annex-i-compendium-of-r-scripts.html#cb53-264" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Plot dispersion on KL and % by N</span></span>
<span id="cb53-265"><a href="annex-i-compendium-of-r-scripts.html#cb53-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">6</span>))</span>
<span id="cb53-266"><a href="annex-i-compendium-of-r-scripts.html#cb53-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">boxplot</span>(</span>
<span id="cb53-267"><a href="annex-i-compendium-of-r-scripts.html#cb53-267" aria-hidden="true" tabindex="-1"></a>      Perc <span class="sc">~</span> N,</span>
<span id="cb53-268"><a href="annex-i-compendium-of-r-scripts.html#cb53-268" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> results,</span>
<span id="cb53-269"><a href="annex-i-compendium-of-r-scripts.html#cb53-269" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>),</span>
<span id="cb53-270"><a href="annex-i-compendium-of-r-scripts.html#cb53-270" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylab =</span> <span class="st">&quot;%&quot;</span></span>
<span id="cb53-271"><a href="annex-i-compendium-of-r-scripts.html#cb53-271" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-272"><a href="annex-i-compendium-of-r-scripts.html#cb53-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mtext</span>(<span class="st">&quot;KL divergence&quot;</span>, <span class="at">side =</span> <span class="dv">4</span>, <span class="at">line =</span> <span class="dv">3</span>)</span>
<span id="cb53-273"><a href="annex-i-compendium-of-r-scripts.html#cb53-273" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add new plot</span></span>
<span id="cb53-274"><a href="annex-i-compendium-of-r-scripts.html#cb53-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">new =</span> <span class="cn">TRUE</span>, <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">6</span>))</span>
<span id="cb53-275"><a href="annex-i-compendium-of-r-scripts.html#cb53-275" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Box plot</span></span>
<span id="cb53-276"><a href="annex-i-compendium-of-r-scripts.html#cb53-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">boxplot</span>(</span>
<span id="cb53-277"><a href="annex-i-compendium-of-r-scripts.html#cb53-277" aria-hidden="true" tabindex="-1"></a>      KL <span class="sc">~</span> N,</span>
<span id="cb53-278"><a href="annex-i-compendium-of-r-scripts.html#cb53-278" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> results,</span>
<span id="cb53-279"><a href="annex-i-compendium-of-r-scripts.html#cb53-279" aria-hidden="true" tabindex="-1"></a>      <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb53-280"><a href="annex-i-compendium-of-r-scripts.html#cb53-280" aria-hidden="true" tabindex="-1"></a>      <span class="at">outline =</span> <span class="cn">FALSE</span>,</span>
<span id="cb53-281"><a href="annex-i-compendium-of-r-scripts.html#cb53-281" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="fl">0.8</span>, <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>),</span>
<span id="cb53-282"><a href="annex-i-compendium-of-r-scripts.html#cb53-282" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylab =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb53-283"><a href="annex-i-compendium-of-r-scripts.html#cb53-283" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-284"><a href="annex-i-compendium-of-r-scripts.html#cb53-284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axis</span>(</span>
<span id="cb53-285"><a href="annex-i-compendium-of-r-scripts.html#cb53-285" aria-hidden="true" tabindex="-1"></a>      <span class="dv">4</span>,</span>
<span id="cb53-286"><a href="annex-i-compendium-of-r-scripts.html#cb53-286" aria-hidden="true" tabindex="-1"></a>      <span class="at">at =</span> <span class="fu">seq</span>(<span class="fl">0.02</span>, <span class="fl">0.36</span>, <span class="at">by =</span> .<span class="dv">06</span>),</span>
<span id="cb53-287"><a href="annex-i-compendium-of-r-scripts.html#cb53-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">seq</span>(<span class="fl">0.02</span>, <span class="fl">0.36</span>, <span class="at">by =</span> .<span class="dv">06</span>),</span>
<span id="cb53-288"><a href="annex-i-compendium-of-r-scripts.html#cb53-288" aria-hidden="true" tabindex="-1"></a>      <span class="at">las =</span> <span class="dv">3</span></span>
<span id="cb53-289"><a href="annex-i-compendium-of-r-scripts.html#cb53-289" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-290"><a href="annex-i-compendium-of-r-scripts.html#cb53-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-291"><a href="annex-i-compendium-of-r-scripts.html#cb53-291" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Model KL divergence ======================================================</span></span>
<span id="cb53-292"><a href="annex-i-compendium-of-r-scripts.html#cb53-292" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create an exponential decay function of the KL divergence</span></span>
<span id="cb53-293"><a href="annex-i-compendium-of-r-scripts.html#cb53-293" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> mean_result<span class="sc">$</span>N</span>
<span id="cb53-294"><a href="annex-i-compendium-of-r-scripts.html#cb53-294" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">=</span> (mean_result<span class="sc">$</span>KL <span class="sc">-</span> <span class="fu">min</span>(mean_result<span class="sc">$</span>KL)) <span class="sc">/</span> (<span class="fu">max</span>(mean_result<span class="sc">$</span>KL) <span class="sc">-</span> <span class="fu">min</span>(mean_result<span class="sc">$</span>KL)) <span class="co">#KL</span></span>
<span id="cb53-295"><a href="annex-i-compendium-of-r-scripts.html#cb53-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-296"><a href="annex-i-compendium-of-r-scripts.html#cb53-296" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parametrize Exponential decay function</span></span>
<span id="cb53-297"><a href="annex-i-compendium-of-r-scripts.html#cb53-297" aria-hidden="true" tabindex="-1"></a>    start <span class="ot">&lt;-</span>  <span class="fu">list</span>()     <span class="co"># Initialize an empty list for the starting values</span></span>
<span id="cb53-298"><a href="annex-i-compendium-of-r-scripts.html#cb53-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-299"><a href="annex-i-compendium-of-r-scripts.html#cb53-299" aria-hidden="true" tabindex="-1"></a>  <span class="co">#fit function</span></span>
<span id="cb53-300"><a href="annex-i-compendium-of-r-scripts.html#cb53-300" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb53-301"><a href="annex-i-compendium-of-r-scripts.html#cb53-301" aria-hidden="true" tabindex="-1"></a>    b0 <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb53-302"><a href="annex-i-compendium-of-r-scripts.html#cb53-302" aria-hidden="true" tabindex="-1"></a>    b1 <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb53-303"><a href="annex-i-compendium-of-r-scripts.html#cb53-303" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-304"><a href="annex-i-compendium-of-r-scripts.html#cb53-304" aria-hidden="true" tabindex="-1"></a>    fit1 <span class="ot">&lt;-</span></span>
<span id="cb53-305"><a href="annex-i-compendium-of-r-scripts.html#cb53-305" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nls</span>(</span>
<span id="cb53-306"><a href="annex-i-compendium-of-r-scripts.html#cb53-306" aria-hidden="true" tabindex="-1"></a>        y <span class="sc">~</span> k <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>b1 <span class="sc">*</span> x) <span class="sc">+</span> b0,</span>
<span id="cb53-307"><a href="annex-i-compendium-of-r-scripts.html#cb53-307" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> <span class="fu">list</span>(<span class="at">k =</span> k, <span class="at">b0 =</span> b0, <span class="at">b1 =</span> b1),</span>
<span id="cb53-308"><a href="annex-i-compendium-of-r-scripts.html#cb53-308" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxiter =</span> <span class="dv">500</span>),</span>
<span id="cb53-309"><a href="annex-i-compendium-of-r-scripts.html#cb53-309" aria-hidden="true" tabindex="-1"></a>        <span class="at">trace =</span> T</span>
<span id="cb53-310"><a href="annex-i-compendium-of-r-scripts.html#cb53-310" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb53-311"><a href="annex-i-compendium-of-r-scripts.html#cb53-311" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(fit1)</span>
<span id="cb53-312"><a href="annex-i-compendium-of-r-scripts.html#cb53-312" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-313"><a href="annex-i-compendium-of-r-scripts.html#cb53-313" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot fit</span></span>
<span id="cb53-314"><a href="annex-i-compendium-of-r-scripts.html#cb53-314" aria-hidden="true" tabindex="-1"></a>    xx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, final.n, <span class="dv">1</span>)</span>
<span id="cb53-315"><a href="annex-i-compendium-of-r-scripts.html#cb53-315" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(x, y)</span>
<span id="cb53-316"><a href="annex-i-compendium-of-r-scripts.html#cb53-316" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(xx, <span class="fu">predict</span>(fit1, <span class="fu">list</span>(<span class="at">x =</span> xx)))</span>
<span id="cb53-317"><a href="annex-i-compendium-of-r-scripts.html#cb53-317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict with vfit function</span></span>
<span id="cb53-318"><a href="annex-i-compendium-of-r-scripts.html#cb53-318" aria-hidden="true" tabindex="-1"></a>    jj <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit1, <span class="fu">list</span>(<span class="at">x =</span> xx))</span>
<span id="cb53-319"><a href="annex-i-compendium-of-r-scripts.html#cb53-319" aria-hidden="true" tabindex="-1"></a>    normalized <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> (jj <span class="sc">-</span> <span class="fu">min</span>(jj)) <span class="sc">/</span> (<span class="fu">max</span>(jj) <span class="sc">-</span> <span class="fu">min</span>(jj))</span>
<span id="cb53-320"><a href="annex-i-compendium-of-r-scripts.html#cb53-320" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-321"><a href="annex-i-compendium-of-r-scripts.html#cb53-321" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-322"><a href="annex-i-compendium-of-r-scripts.html#cb53-322" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Determine the minimum sample size to account for 95% of cumulative probability of the covariate diversity ====</span></span>
<span id="cb53-323"><a href="annex-i-compendium-of-r-scripts.html#cb53-323" aria-hidden="true" tabindex="-1"></a>    minimum_n <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">which</span>(normalized <span class="sc">&lt;</span> <span class="fl">0.95</span>)) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb53-324"><a href="annex-i-compendium-of-r-scripts.html#cb53-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-325"><a href="annex-i-compendium-of-r-scripts.html#cb53-325" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot cdf and minimum sampling point</span></span>
<span id="cb53-326"><a href="annex-i-compendium-of-r-scripts.html#cb53-326" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> xx</span>
<span id="cb53-327"><a href="annex-i-compendium-of-r-scripts.html#cb53-327" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> normalized</span>
<span id="cb53-328"><a href="annex-i-compendium-of-r-scripts.html#cb53-328" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-329"><a href="annex-i-compendium-of-r-scripts.html#cb53-329" aria-hidden="true" tabindex="-1"></a>    mydata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x, y)</span>
<span id="cb53-330"><a href="annex-i-compendium-of-r-scripts.html#cb53-330" aria-hidden="true" tabindex="-1"></a>    opti <span class="ot">&lt;-</span> mydata[mydata<span class="sc">$</span>x <span class="sc">==</span> minimum_n, ]</span>
<span id="cb53-331"><a href="annex-i-compendium-of-r-scripts.html#cb53-331" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-332"><a href="annex-i-compendium-of-r-scripts.html#cb53-332" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_ly</span>(</span>
<span id="cb53-333"><a href="annex-i-compendium-of-r-scripts.html#cb53-333" aria-hidden="true" tabindex="-1"></a>      mydata,</span>
<span id="cb53-334"><a href="annex-i-compendium-of-r-scripts.html#cb53-334" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="sc">~</span> x,</span>
<span id="cb53-335"><a href="annex-i-compendium-of-r-scripts.html#cb53-335" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="sc">~</span> normalized,</span>
<span id="cb53-336"><a href="annex-i-compendium-of-r-scripts.html#cb53-336" aria-hidden="true" tabindex="-1"></a>      <span class="at">mode =</span> <span class="st">&quot;lines+markers&quot;</span>,</span>
<span id="cb53-337"><a href="annex-i-compendium-of-r-scripts.html#cb53-337" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">&quot;scatter&quot;</span>,</span>
<span id="cb53-338"><a href="annex-i-compendium-of-r-scripts.html#cb53-338" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;CDF (1–KL divergence)&quot;</span></span>
<span id="cb53-339"><a href="annex-i-compendium-of-r-scripts.html#cb53-339" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb53-340"><a href="annex-i-compendium-of-r-scripts.html#cb53-340" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_trace</span>(</span>
<span id="cb53-341"><a href="annex-i-compendium-of-r-scripts.html#cb53-341" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="sc">~</span> x,</span>
<span id="cb53-342"><a href="annex-i-compendium-of-r-scripts.html#cb53-342" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">~</span> jj,</span>
<span id="cb53-343"><a href="annex-i-compendium-of-r-scripts.html#cb53-343" aria-hidden="true" tabindex="-1"></a>        <span class="at">mode =</span> <span class="st">&quot;lines+markers&quot;</span>,</span>
<span id="cb53-344"><a href="annex-i-compendium-of-r-scripts.html#cb53-344" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">&quot;scatter&quot;</span>,</span>
<span id="cb53-345"><a href="annex-i-compendium-of-r-scripts.html#cb53-345" aria-hidden="true" tabindex="-1"></a>        <span class="at">yaxis =</span> <span class="st">&quot;y2&quot;</span>,</span>
<span id="cb53-346"><a href="annex-i-compendium-of-r-scripts.html#cb53-346" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;KL divergence&quot;</span></span>
<span id="cb53-347"><a href="annex-i-compendium-of-r-scripts.html#cb53-347" aria-hidden="true" tabindex="-1"></a>      )  <span class="sc">%&gt;%</span></span>
<span id="cb53-348"><a href="annex-i-compendium-of-r-scripts.html#cb53-348" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_trace</span>(</span>
<span id="cb53-349"><a href="annex-i-compendium-of-r-scripts.html#cb53-349" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="sc">~</span> opti<span class="sc">$</span>x,</span>
<span id="cb53-350"><a href="annex-i-compendium-of-r-scripts.html#cb53-350" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">~</span> opti<span class="sc">$</span>y,</span>
<span id="cb53-351"><a href="annex-i-compendium-of-r-scripts.html#cb53-351" aria-hidden="true" tabindex="-1"></a>        <span class="at">yaxis =</span> <span class="st">&quot;y&quot;</span>,</span>
<span id="cb53-352"><a href="annex-i-compendium-of-r-scripts.html#cb53-352" aria-hidden="true" tabindex="-1"></a>        <span class="at">mode =</span> <span class="st">&quot;markers&quot;</span>,</span>
<span id="cb53-353"><a href="annex-i-compendium-of-r-scripts.html#cb53-353" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Minimum N&quot;</span>,</span>
<span id="cb53-354"><a href="annex-i-compendium-of-r-scripts.html#cb53-354" aria-hidden="true" tabindex="-1"></a>        <span class="at">marker =</span> <span class="fu">list</span>(</span>
<span id="cb53-355"><a href="annex-i-compendium-of-r-scripts.html#cb53-355" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">8</span>,</span>
<span id="cb53-356"><a href="annex-i-compendium-of-r-scripts.html#cb53-356" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">&#39;#d62728&#39;</span>,</span>
<span id="cb53-357"><a href="annex-i-compendium-of-r-scripts.html#cb53-357" aria-hidden="true" tabindex="-1"></a>          <span class="at">line =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">&#39;black&#39;</span>, <span class="at">width =</span> <span class="dv">1</span>)</span>
<span id="cb53-358"><a href="annex-i-compendium-of-r-scripts.html#cb53-358" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-359"><a href="annex-i-compendium-of-r-scripts.html#cb53-359" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb53-360"><a href="annex-i-compendium-of-r-scripts.html#cb53-360" aria-hidden="true" tabindex="-1"></a>      <span class="fu">layout</span>(</span>
<span id="cb53-361"><a href="annex-i-compendium-of-r-scripts.html#cb53-361" aria-hidden="true" tabindex="-1"></a>        <span class="at">xaxis =</span> <span class="fu">list</span>(</span>
<span id="cb53-362"><a href="annex-i-compendium-of-r-scripts.html#cb53-362" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">&quot;N&quot;</span>,</span>
<span id="cb53-363"><a href="annex-i-compendium-of-r-scripts.html#cb53-363" aria-hidden="true" tabindex="-1"></a>          <span class="at">showgrid =</span> T,</span>
<span id="cb53-364"><a href="annex-i-compendium-of-r-scripts.html#cb53-364" aria-hidden="true" tabindex="-1"></a>          <span class="at">dtick =</span> <span class="dv">50</span>,</span>
<span id="cb53-365"><a href="annex-i-compendium-of-r-scripts.html#cb53-365" aria-hidden="true" tabindex="-1"></a>          <span class="at">tickfont =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb53-366"><a href="annex-i-compendium-of-r-scripts.html#cb53-366" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb53-367"><a href="annex-i-compendium-of-r-scripts.html#cb53-367" aria-hidden="true" tabindex="-1"></a>        <span class="at">yaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">&quot;1–KL divergence (% CDF)&quot;</span>, <span class="at">showgrid =</span> F),</span>
<span id="cb53-368"><a href="annex-i-compendium-of-r-scripts.html#cb53-368" aria-hidden="true" tabindex="-1"></a>        <span class="at">yaxis2 =</span> <span class="fu">list</span>(</span>
<span id="cb53-369"><a href="annex-i-compendium-of-r-scripts.html#cb53-369" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">&quot;KL divergence&quot;</span>,</span>
<span id="cb53-370"><a href="annex-i-compendium-of-r-scripts.html#cb53-370" aria-hidden="true" tabindex="-1"></a>          <span class="at">overlaying =</span> <span class="st">&quot;y&quot;</span>,</span>
<span id="cb53-371"><a href="annex-i-compendium-of-r-scripts.html#cb53-371" aria-hidden="true" tabindex="-1"></a>          <span class="at">side =</span> <span class="st">&quot;right&quot;</span></span>
<span id="cb53-372"><a href="annex-i-compendium-of-r-scripts.html#cb53-372" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb53-373"><a href="annex-i-compendium-of-r-scripts.html#cb53-373" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend =</span> <span class="fu">list</span>(</span>
<span id="cb53-374"><a href="annex-i-compendium-of-r-scripts.html#cb53-374" aria-hidden="true" tabindex="-1"></a>          <span class="at">orientation =</span> <span class="st">&quot;h&quot;</span>,</span>
<span id="cb53-375"><a href="annex-i-compendium-of-r-scripts.html#cb53-375" aria-hidden="true" tabindex="-1"></a>          <span class="at">y =</span> <span class="fl">1.2</span>,</span>
<span id="cb53-376"><a href="annex-i-compendium-of-r-scripts.html#cb53-376" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> <span class="fl">0.1</span>,</span>
<span id="cb53-377"><a href="annex-i-compendium-of-r-scripts.html#cb53-377" aria-hidden="true" tabindex="-1"></a>          <span class="at">traceorder =</span> <span class="st">&quot;normal&quot;</span></span>
<span id="cb53-378"><a href="annex-i-compendium-of-r-scripts.html#cb53-378" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb53-379"><a href="annex-i-compendium-of-r-scripts.html#cb53-379" aria-hidden="true" tabindex="-1"></a>        <span class="at">margin =</span> <span class="fu">list</span>(</span>
<span id="cb53-380"><a href="annex-i-compendium-of-r-scripts.html#cb53-380" aria-hidden="true" tabindex="-1"></a>          <span class="at">t =</span> <span class="dv">50</span>,</span>
<span id="cb53-381"><a href="annex-i-compendium-of-r-scripts.html#cb53-381" aria-hidden="true" tabindex="-1"></a>          <span class="at">b =</span> <span class="dv">50</span>,</span>
<span id="cb53-382"><a href="annex-i-compendium-of-r-scripts.html#cb53-382" aria-hidden="true" tabindex="-1"></a>          <span class="at">r =</span> <span class="dv">100</span>,</span>
<span id="cb53-383"><a href="annex-i-compendium-of-r-scripts.html#cb53-383" aria-hidden="true" tabindex="-1"></a>          <span class="at">l =</span> <span class="dv">80</span></span>
<span id="cb53-384"><a href="annex-i-compendium-of-r-scripts.html#cb53-384" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb53-385"><a href="annex-i-compendium-of-r-scripts.html#cb53-385" aria-hidden="true" tabindex="-1"></a>        <span class="at">hovermode =</span> <span class="st">&#39;x&#39;</span></span>
<span id="cb53-386"><a href="annex-i-compendium-of-r-scripts.html#cb53-386" aria-hidden="true" tabindex="-1"></a>      )  <span class="sc">%&gt;%</span></span>
<span id="cb53-387"><a href="annex-i-compendium-of-r-scripts.html#cb53-387" aria-hidden="true" tabindex="-1"></a>      <span class="fu">config</span>(<span class="at">displayModeBar =</span> <span class="cn">FALSE</span>)</span>
<span id="cb53-388"><a href="annex-i-compendium-of-r-scripts.html#cb53-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-389"><a href="annex-i-compendium-of-r-scripts.html#cb53-389" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Determine the optimal iteration according to the minimum N size ==========</span></span>
<span id="cb53-390"><a href="annex-i-compendium-of-r-scripts.html#cb53-390" aria-hidden="true" tabindex="-1"></a>  optimal_iteration <span class="ot">&lt;-</span> results[<span class="fu">which</span>(<span class="fu">abs</span>(results<span class="sc">$</span>N <span class="sc">-</span> minimum_n) <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">abs</span>(results<span class="sc">$</span>N <span class="sc">-</span> minimum_n))), ] <span class="sc">%&gt;%</span></span>
<span id="cb53-391"><a href="annex-i-compendium-of-r-scripts.html#cb53-391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">IDX =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb53-392"><a href="annex-i-compendium-of-r-scripts.html#cb53-392" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Perc <span class="sc">==</span> <span class="fu">max</span>(Perc))</span>
<span id="cb53-393"><a href="annex-i-compendium-of-r-scripts.html#cb53-393" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-394"><a href="annex-i-compendium-of-r-scripts.html#cb53-394" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot minimum points from best iteration ==================================</span></span>
<span id="cb53-395"><a href="annex-i-compendium-of-r-scripts.html#cb53-395" aria-hidden="true" tabindex="-1"></a>  N_final <span class="ot">&lt;-</span> samples_storage[<span class="fu">paste0</span>(<span class="st">&quot;N&quot;</span>, optimal_iteration<span class="sc">$</span>N, <span class="st">&quot;_&quot;</span>, optimal_iteration<span class="sc">$</span>IDX)][[<span class="dv">1</span>]]</span>
<span id="cb53-396"><a href="annex-i-compendium-of-r-scripts.html#cb53-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]])</span>
<span id="cb53-397"><a href="annex-i-compendium-of-r-scripts.html#cb53-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(N_final)</span>
<span id="cb53-398"><a href="annex-i-compendium-of-r-scripts.html#cb53-398" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-399"><a href="annex-i-compendium-of-r-scripts.html#cb53-399" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="re">END</span></span></code></pre></div>
</div>
<div id="script-5-stratified-sampling-on-vector-data" class="section level2 unnumbered hasAnchor">
<h2>Script 5: Stratified sampling on vector data<a href="annex-i-compendium-of-r-scripts.html#script-5-stratified-sampling-on-vector-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This script uses soil and land use classes to define polygon ‘strata’ for an area weighted stratified sampling design.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="annex-i-compendium-of-r-scripts.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb54-2"><a href="annex-i-compendium-of-r-scripts.html#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb54-3"><a href="annex-i-compendium-of-r-scripts.html#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb54-4"><a href="annex-i-compendium-of-r-scripts.html#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified Sampling on &#39;soil-landuse&#39; strata</span></span>
<span id="cb54-5"><a href="annex-i-compendium-of-r-scripts.html#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb54-6"><a href="annex-i-compendium-of-r-scripts.html#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb54-7"><a href="annex-i-compendium-of-r-scripts.html#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">#          Marcos.Angelini@fao.org</span></span>
<span id="cb54-8"><a href="annex-i-compendium-of-r-scripts.html#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb54-9"><a href="annex-i-compendium-of-r-scripts.html#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="annex-i-compendium-of-r-scripts.html#cb54-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empty environment and cache </span></span>
<span id="cb54-11"><a href="annex-i-compendium-of-r-scripts.html#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb54-12"><a href="annex-i-compendium-of-r-scripts.html#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb54-13"><a href="annex-i-compendium-of-r-scripts.html#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="annex-i-compendium-of-r-scripts.html#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script =======================================================</span></span>
<span id="cb54-15"><a href="annex-i-compendium-of-r-scripts.html#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co"># The goal of this script is to perform random and regular stratified</span></span>
<span id="cb54-16"><a href="annex-i-compendium-of-r-scripts.html#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co"># soil sampling designs using soil/land-use classes as &#39;strata&#39;</span></span>
<span id="cb54-17"><a href="annex-i-compendium-of-r-scripts.html#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="co"># The distribution of samples on the strata is based on a</span></span>
<span id="cb54-18"><a href="annex-i-compendium-of-r-scripts.html#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co"># weighted area distribution with the requirement of at least 2 sampling points</span></span>
<span id="cb54-19"><a href="annex-i-compendium-of-r-scripts.html#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="co"># by strata. Small polygons (&lt; 100 has) are eliminated from calculations.</span></span>
<span id="cb54-20"><a href="annex-i-compendium-of-r-scripts.html#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Only &#39;strata&#39; classes prone to be samples are included in the analyses.</span></span>
<span id="cb54-21"><a href="annex-i-compendium-of-r-scripts.html#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co"># The final sample data includes &#39;target&#39; points - i.e. primary sampling points,</span></span>
<span id="cb54-22"><a href="annex-i-compendium-of-r-scripts.html#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="co"># and &#39;replacement&#39; points - i.e. points to be used as replacements in case</span></span>
<span id="cb54-23"><a href="annex-i-compendium-of-r-scripts.html#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="co"># that the corresponding &#39;target&#39; point cannot be sampled for any reason.</span></span>
<span id="cb54-24"><a href="annex-i-compendium-of-r-scripts.html#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb54-25"><a href="annex-i-compendium-of-r-scripts.html#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load packages</span></span>
<span id="cb54-26"><a href="annex-i-compendium-of-r-scripts.html#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb54-27"><a href="annex-i-compendium-of-r-scripts.html#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import data </span></span>
<span id="cb54-28"><a href="annex-i-compendium-of-r-scripts.html#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Delineate soil strata</span></span>
<span id="cb54-29"><a href="annex-i-compendium-of-r-scripts.html#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Delineate land-use strata </span></span>
<span id="cb54-30"><a href="annex-i-compendium-of-r-scripts.html#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Create sampling strata</span></span>
<span id="cb54-31"><a href="annex-i-compendium-of-r-scripts.html#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Accommodate strata to requirements</span></span>
<span id="cb54-32"><a href="annex-i-compendium-of-r-scripts.html#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Plot strata</span></span>
<span id="cb54-33"><a href="annex-i-compendium-of-r-scripts.html#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Stratified random sampling</span></span>
<span id="cb54-34"><a href="annex-i-compendium-of-r-scripts.html#cb54-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot points over strata</span></span>
<span id="cb54-35"><a href="annex-i-compendium-of-r-scripts.html#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 10 - Calculate replacement areas for points</span></span>
<span id="cb54-36"><a href="annex-i-compendium-of-r-scripts.html#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 11 - Stratified regular sampling</span></span>
<span id="cb54-37"><a href="annex-i-compendium-of-r-scripts.html#cb54-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 12 - Random Sampling based on a stratified raster</span></span>
<span id="cb54-38"><a href="annex-i-compendium-of-r-scripts.html#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb54-39"><a href="annex-i-compendium-of-r-scripts.html#cb54-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-40"><a href="annex-i-compendium-of-r-scripts.html#cb54-40" aria-hidden="true" tabindex="-1"></a>  start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb54-41"><a href="annex-i-compendium-of-r-scripts.html#cb54-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-42"><a href="annex-i-compendium-of-r-scripts.html#cb54-42" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load packages =================================</span></span>
<span id="cb54-43"><a href="annex-i-compendium-of-r-scripts.html#cb54-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb54-44"><a href="annex-i-compendium-of-r-scripts.html#cb54-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb54-45"><a href="annex-i-compendium-of-r-scripts.html#cb54-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb54-46"><a href="annex-i-compendium-of-r-scripts.html#cb54-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-47"><a href="annex-i-compendium-of-r-scripts.html#cb54-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define packages as a vector objects</span></span>
<span id="cb54-48"><a href="annex-i-compendium-of-r-scripts.html#cb54-48" aria-hidden="true" tabindex="-1"></a>    packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sf&quot;</span>, <span class="st">&quot;terra&quot;</span>, <span class="st">&quot;tidyverse&quot;</span>, <span class="st">&quot;rmapshaper&quot;</span>,</span>
<span id="cb54-49"><a href="annex-i-compendium-of-r-scripts.html#cb54-49" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;units&quot;</span>,<span class="st">&quot;plyr&quot;</span>, <span class="st">&quot;mapview&quot;</span>, <span class="st">&quot;leaflet&quot;</span>)</span>
<span id="cb54-50"><a href="annex-i-compendium-of-r-scripts.html#cb54-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load packages</span></span>
<span id="cb54-51"><a href="annex-i-compendium-of-r-scripts.html#cb54-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>) </span>
<span id="cb54-52"><a href="annex-i-compendium-of-r-scripts.html#cb54-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove object to save memory space </span></span>
<span id="cb54-53"><a href="annex-i-compendium-of-r-scripts.html#cb54-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(packages) </span>
<span id="cb54-54"><a href="annex-i-compendium-of-r-scripts.html#cb54-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-55"><a href="annex-i-compendium-of-r-scripts.html#cb54-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-56"><a href="annex-i-compendium-of-r-scripts.html#cb54-56" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb54-57"><a href="annex-i-compendium-of-r-scripts.html#cb54-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to rasters</span></span>
<span id="cb54-58"><a href="annex-i-compendium-of-r-scripts.html#cb54-58" aria-hidden="true" tabindex="-1"></a>  raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters/&quot;</span></span>
<span id="cb54-59"><a href="annex-i-compendium-of-r-scripts.html#cb54-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to shapes</span></span>
<span id="cb54-60"><a href="annex-i-compendium-of-r-scripts.html#cb54-60" aria-hidden="true" tabindex="-1"></a>  shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes/&quot;</span></span>
<span id="cb54-61"><a href="annex-i-compendium-of-r-scripts.html#cb54-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to results</span></span>
<span id="cb54-62"><a href="annex-i-compendium-of-r-scripts.html#cb54-62" aria-hidden="true" tabindex="-1"></a>  results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb54-63"><a href="annex-i-compendium-of-r-scripts.html#cb54-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the number of samples to allocate</span></span>
<span id="cb54-64"><a href="annex-i-compendium-of-r-scripts.html#cb54-64" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="dv">242</span></span>
<span id="cb54-65"><a href="annex-i-compendium-of-r-scripts.html#cb54-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-66"><a href="annex-i-compendium-of-r-scripts.html#cb54-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-67"><a href="annex-i-compendium-of-r-scripts.html#cb54-67" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Import data ====================================================</span></span>
<span id="cb54-68"><a href="annex-i-compendium-of-r-scripts.html#cb54-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List existing shapefiles</span></span>
<span id="cb54-69"><a href="annex-i-compendium-of-r-scripts.html#cb54-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list.files</span>(shp.path, <span class="at">pattern =</span> <span class="st">&quot;shp$&quot;</span>,<span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-70"><a href="annex-i-compendium-of-r-scripts.html#cb54-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-71"><a href="annex-i-compendium-of-r-scripts.html#cb54-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load soil map data</span></span>
<span id="cb54-72"><a href="annex-i-compendium-of-r-scripts.html#cb54-72" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/soils.shp&quot;</span>))</span>
<span id="cb54-73"><a href="annex-i-compendium-of-r-scripts.html#cb54-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load land-use data</span></span>
<span id="cb54-74"><a href="annex-i-compendium-of-r-scripts.html#cb54-74" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/landuses.shp&quot;</span>))</span>
<span id="cb54-75"><a href="annex-i-compendium-of-r-scripts.html#cb54-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-76"><a href="annex-i-compendium-of-r-scripts.html#cb54-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define a bounding area (optional).</span></span>
<span id="cb54-77"><a href="annex-i-compendium-of-r-scripts.html#cb54-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If BOUNDING = TRUE, then a bounding–area shapefile (bb) must be specified</span></span>
<span id="cb54-78"><a href="annex-i-compendium-of-r-scripts.html#cb54-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and the line in the code below must be uncommented</span></span>
<span id="cb54-79"><a href="annex-i-compendium-of-r-scripts.html#cb54-79" aria-hidden="true" tabindex="-1"></a>    BOUNDING <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb54-80"><a href="annex-i-compendium-of-r-scripts.html#cb54-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">#bb &lt;- st_read(paste0(shp.path,&quot;/your_bounding_area.shp&quot;))</span></span>
<span id="cb54-81"><a href="annex-i-compendium-of-r-scripts.html#cb54-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-82"><a href="annex-i-compendium-of-r-scripts.html#cb54-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute replacement areas (optional).</span></span>
<span id="cb54-83"><a href="annex-i-compendium-of-r-scripts.html#cb54-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If REPLACEMENT = TRUE, then replacement areas are calculated around a </span></span>
<span id="cb54-84"><a href="annex-i-compendium-of-r-scripts.html#cb54-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># specified buffer distance from target points within the same stratum class</span></span>
<span id="cb54-85"><a href="annex-i-compendium-of-r-scripts.html#cb54-85" aria-hidden="true" tabindex="-1"></a>    REPLACEMENT <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb54-86"><a href="annex-i-compendium-of-r-scripts.html#cb54-86" aria-hidden="true" tabindex="-1"></a>    distance.buffer <span class="ot">=</span> <span class="dv">500</span> <span class="co"># Distance must be adjusted to the coordinate system</span></span>
<span id="cb54-87"><a href="annex-i-compendium-of-r-scripts.html#cb54-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">#bb &lt;- st_read(paste0(shp.path,&quot;/your_bounding_area.shp&quot;))</span></span>
<span id="cb54-88"><a href="annex-i-compendium-of-r-scripts.html#cb54-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-89"><a href="annex-i-compendium-of-r-scripts.html#cb54-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-90"><a href="annex-i-compendium-of-r-scripts.html#cb54-90" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Delineate soil strata =====================================================</span></span>
<span id="cb54-91"><a href="annex-i-compendium-of-r-scripts.html#cb54-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-92"><a href="annex-i-compendium-of-r-scripts.html#cb54-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clip soil data  by bounding area if REPLACEMENT = TRUE</span></span>
<span id="cb54-93"><a href="annex-i-compendium-of-r-scripts.html#cb54-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (BOUNDING) {</span>
<span id="cb54-94"><a href="annex-i-compendium-of-r-scripts.html#cb54-94" aria-hidden="true" tabindex="-1"></a>      soil <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(soil, bb)</span>
<span id="cb54-95"><a href="annex-i-compendium-of-r-scripts.html#cb54-95" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb54-96"><a href="annex-i-compendium-of-r-scripts.html#cb54-96" aria-hidden="true" tabindex="-1"></a>      soil <span class="ot">&lt;-</span> soil</span>
<span id="cb54-97"><a href="annex-i-compendium-of-r-scripts.html#cb54-97" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-98"><a href="annex-i-compendium-of-r-scripts.html#cb54-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-99"><a href="annex-i-compendium-of-r-scripts.html#cb54-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify existing soil groups</span></span>
<span id="cb54-100"><a href="annex-i-compendium-of-r-scripts.html#cb54-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(soil<span class="sc">$</span>USDA_CLASS)</span>
<span id="cb54-101"><a href="annex-i-compendium-of-r-scripts.html#cb54-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make corrections on data</span></span>
<span id="cb54-102"><a href="annex-i-compendium-of-r-scripts.html#cb54-102" aria-hidden="true" tabindex="-1"></a>    soil<span class="sc">$</span>USDA_CLASS[soil<span class="sc">$</span>USDA_CLASS<span class="sc">==</span><span class="st">&quot;molisol&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;mollisol&quot;</span></span>
<span id="cb54-103"><a href="annex-i-compendium-of-r-scripts.html#cb54-103" aria-hidden="true" tabindex="-1"></a>    soil<span class="sc">$</span>USDA_CLASS[soil<span class="sc">$</span>USDA_CLASS<span class="sc">==</span><span class="st">&quot;mollisols&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;mollisol&quot;</span></span>
<span id="cb54-104"><a href="annex-i-compendium-of-r-scripts.html#cb54-104" aria-hidden="true" tabindex="-1"></a>    soil<span class="sc">$</span>USDA_CLASS[soil<span class="sc">$</span>USDA_CLASS<span class="sc">==</span><span class="st">&quot;ultisols&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;ultisol&quot;</span></span>
<span id="cb54-105"><a href="annex-i-compendium-of-r-scripts.html#cb54-105" aria-hidden="true" tabindex="-1"></a>    soil<span class="sc">$</span>USDA_CLASS[soil<span class="sc">$</span>USDA_CLASS<span class="sc">==</span><span class="st">&quot;histisol&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;histosol&quot;</span></span>
<span id="cb54-106"><a href="annex-i-compendium-of-r-scripts.html#cb54-106" aria-hidden="true" tabindex="-1"></a>    soil<span class="sc">$</span>USDA_CLASS[soil<span class="sc">$</span>SOIL_PH<span class="sc">==</span><span class="st">&quot;River Wash&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;riverwash&quot;</span></span>
<span id="cb54-107"><a href="annex-i-compendium-of-r-scripts.html#cb54-107" aria-hidden="true" tabindex="-1"></a>    soil<span class="sc">$</span>USDA_CLASS[<span class="fu">is.na</span>(soil<span class="sc">$</span>USDA_CLASS)] <span class="ot">&lt;-</span> <span class="st">&quot;undetermined&quot;</span></span>
<span id="cb54-108"><a href="annex-i-compendium-of-r-scripts.html#cb54-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(soil<span class="sc">$</span>USDA_CLASS)</span>
<span id="cb54-109"><a href="annex-i-compendium-of-r-scripts.html#cb54-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-110"><a href="annex-i-compendium-of-r-scripts.html#cb54-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select classes to use (NA and water are not used)</span></span>
<span id="cb54-111"><a href="annex-i-compendium-of-r-scripts.html#cb54-111" aria-hidden="true" tabindex="-1"></a>    selected.classes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;inceptisol&quot;</span>,<span class="st">&quot;vertisol&quot;</span>,<span class="st">&quot;entisol&quot;</span>,<span class="st">&quot;oxisol&quot;</span>,</span>
<span id="cb54-112"><a href="annex-i-compendium-of-r-scripts.html#cb54-112" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;mollisol&quot;</span>,<span class="st">&quot;alfisol&quot;</span>, <span class="st">&quot;ultisol&quot;</span>,<span class="st">&quot;histosol&quot;</span>,</span>
<span id="cb54-113"><a href="annex-i-compendium-of-r-scripts.html#cb54-113" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;undetermined&quot;</span>)</span>
<span id="cb54-114"><a href="annex-i-compendium-of-r-scripts.html#cb54-114" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> soil[<span class="fu">which</span>(soil<span class="sc">$</span>USDA_CLASS <span class="sc">%in%</span> selected.classes),]</span>
<span id="cb54-115"><a href="annex-i-compendium-of-r-scripts.html#cb54-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-116"><a href="annex-i-compendium-of-r-scripts.html#cb54-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check polygon geometry</span></span>
<span id="cb54-117"><a href="annex-i-compendium-of-r-scripts.html#cb54-117" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(soil)</span>
<span id="cb54-118"><a href="annex-i-compendium-of-r-scripts.html#cb54-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Explode polygons</span></span>
<span id="cb54-119"><a href="annex-i-compendium-of-r-scripts.html#cb54-119" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">ms_explode</span>(soil )</span>
<span id="cb54-120"><a href="annex-i-compendium-of-r-scripts.html#cb54-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cast geometry to polygon</span></span>
<span id="cb54-121"><a href="annex-i-compendium-of-r-scripts.html#cb54-121" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(soil, <span class="st">&#39;POLYGON&#39;</span>)</span>
<span id="cb54-122"><a href="annex-i-compendium-of-r-scripts.html#cb54-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write soil strata to disk</span></span>
<span id="cb54-123"><a href="annex-i-compendium-of-r-scripts.html#cb54-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(soil, <span class="fu">paste0</span>(results.path,<span class="st">&quot;soil_classes.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-124"><a href="annex-i-compendium-of-r-scripts.html#cb54-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-125"><a href="annex-i-compendium-of-r-scripts.html#cb54-125" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot aggregated soil classes</span></span>
<span id="cb54-126"><a href="annex-i-compendium-of-r-scripts.html#cb54-126" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">11.4</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb54-127"><a href="annex-i-compendium-of-r-scripts.html#cb54-127" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb54-128"><a href="annex-i-compendium-of-r-scripts.html#cb54-128" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil[<span class="st">&quot;USDA_CLASS&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T,</span>
<span id="cb54-129"><a href="annex-i-compendium-of-r-scripts.html#cb54-129" aria-hidden="true" tabindex="-1"></a>                  <span class="at">layer.name =</span> <span class="st">&quot;Soils&quot;</span>, <span class="at">map=</span>map)</span>
<span id="cb54-130"><a href="annex-i-compendium-of-r-scripts.html#cb54-130" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb54-131"><a href="annex-i-compendium-of-r-scripts.html#cb54-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-132"><a href="annex-i-compendium-of-r-scripts.html#cb54-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-133"><a href="annex-i-compendium-of-r-scripts.html#cb54-133" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Delineate land-use strata =================================================</span></span>
<span id="cb54-134"><a href="annex-i-compendium-of-r-scripts.html#cb54-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-135"><a href="annex-i-compendium-of-r-scripts.html#cb54-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clip land-use data  by bounding area if REPLACEMENT = TRUE</span></span>
<span id="cb54-136"><a href="annex-i-compendium-of-r-scripts.html#cb54-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (BOUNDING) {</span>
<span id="cb54-137"><a href="annex-i-compendium-of-r-scripts.html#cb54-137" aria-hidden="true" tabindex="-1"></a>      lc <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(lc, bb)</span>
<span id="cb54-138"><a href="annex-i-compendium-of-r-scripts.html#cb54-138" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb54-139"><a href="annex-i-compendium-of-r-scripts.html#cb54-139" aria-hidden="true" tabindex="-1"></a>      lc <span class="ot">&lt;-</span> lc</span>
<span id="cb54-140"><a href="annex-i-compendium-of-r-scripts.html#cb54-140" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-141"><a href="annex-i-compendium-of-r-scripts.html#cb54-141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify existing land-use groups </span></span>
<span id="cb54-142"><a href="annex-i-compendium-of-r-scripts.html#cb54-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(lc<span class="sc">$</span>DESCRIPTIO)</span>
<span id="cb54-143"><a href="annex-i-compendium-of-r-scripts.html#cb54-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load look-up table to reclassify land-use classes</span></span>
<span id="cb54-144"><a href="annex-i-compendium-of-r-scripts.html#cb54-144" aria-hidden="true" tabindex="-1"></a>    lu <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;../soil_sampling/JAM/lu_classes.csv&quot;</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb54-145"><a href="annex-i-compendium-of-r-scripts.html#cb54-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join shapefile and look-up table</span></span>
<span id="cb54-146"><a href="annex-i-compendium-of-r-scripts.html#cb54-146" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> <span class="fu">left_join</span>(lc,lu)</span>
<span id="cb54-147"><a href="annex-i-compendium-of-r-scripts.html#cb54-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(lc<span class="sc">$</span>LU)</span>
<span id="cb54-148"><a href="annex-i-compendium-of-r-scripts.html#cb54-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-149"><a href="annex-i-compendium-of-r-scripts.html#cb54-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine classes and delete classes # DELETE MANGROVES</span></span>
<span id="cb54-150"><a href="annex-i-compendium-of-r-scripts.html#cb54-150" aria-hidden="true" tabindex="-1"></a>    selected.classes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Agriculture&quot;</span>,<span class="st">&quot;Savanna&quot;</span>,<span class="st">&quot;Forest&quot;</span>,<span class="st">&quot;Grassland&quot;</span>)</span>
<span id="cb54-151"><a href="annex-i-compendium-of-r-scripts.html#cb54-151" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> lc[<span class="fu">which</span>(lc<span class="sc">$</span>LU <span class="sc">%in%</span> selected.classes),]</span>
<span id="cb54-152"><a href="annex-i-compendium-of-r-scripts.html#cb54-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(lc<span class="sc">$</span>LU)</span>
<span id="cb54-153"><a href="annex-i-compendium-of-r-scripts.html#cb54-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-154"><a href="annex-i-compendium-of-r-scripts.html#cb54-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check and simplify geometry</span></span>
<span id="cb54-155"><a href="annex-i-compendium-of-r-scripts.html#cb54-155" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(lc)</span>
<span id="cb54-156"><a href="annex-i-compendium-of-r-scripts.html#cb54-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cast to polygons</span></span>
<span id="cb54-157"><a href="annex-i-compendium-of-r-scripts.html#cb54-157" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(lc, <span class="st">&#39;POLYGON&#39;</span>)</span>
<span id="cb54-158"><a href="annex-i-compendium-of-r-scripts.html#cb54-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Omit empty polygons</span></span>
<span id="cb54-159"><a href="annex-i-compendium-of-r-scripts.html#cb54-159" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(lc)</span>
<span id="cb54-160"><a href="annex-i-compendium-of-r-scripts.html#cb54-160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-161"><a href="annex-i-compendium-of-r-scripts.html#cb54-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write land use strata as shapefile</span></span>
<span id="cb54-162"><a href="annex-i-compendium-of-r-scripts.html#cb54-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(lc, <span class="fu">paste0</span>(results.path,<span class="st">&quot;lc_classes.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-163"><a href="annex-i-compendium-of-r-scripts.html#cb54-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-164"><a href="annex-i-compendium-of-r-scripts.html#cb54-164" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot aggregated land-use classes   </span></span>
<span id="cb54-165"><a href="annex-i-compendium-of-r-scripts.html#cb54-165" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">11.4</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb54-166"><a href="annex-i-compendium-of-r-scripts.html#cb54-166" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb54-167"><a href="annex-i-compendium-of-r-scripts.html#cb54-167" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(lc[<span class="st">&quot;LU&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T,</span>
<span id="cb54-168"><a href="annex-i-compendium-of-r-scripts.html#cb54-168" aria-hidden="true" tabindex="-1"></a>                  <span class="at">layer.name =</span> <span class="st">&quot;Landuse&quot;</span>, <span class="at">map=</span>map)</span>
<span id="cb54-169"><a href="annex-i-compendium-of-r-scripts.html#cb54-169" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb54-170"><a href="annex-i-compendium-of-r-scripts.html#cb54-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-171"><a href="annex-i-compendium-of-r-scripts.html#cb54-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-172"><a href="annex-i-compendium-of-r-scripts.html#cb54-172" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Create sampling strata ===================================================</span></span>
<span id="cb54-173"><a href="annex-i-compendium-of-r-scripts.html#cb54-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-174"><a href="annex-i-compendium-of-r-scripts.html#cb54-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine soil and land use layers</span></span>
<span id="cb54-175"><a href="annex-i-compendium-of-r-scripts.html#cb54-175" aria-hidden="true" tabindex="-1"></a>    soil_lc <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(soil, lc)  </span>
<span id="cb54-176"><a href="annex-i-compendium-of-r-scripts.html#cb54-176" aria-hidden="true" tabindex="-1"></a>    soil_lc<span class="sc">$</span>soil_lc <span class="ot">&lt;-</span> <span class="fu">paste0</span>(soil_lc<span class="sc">$</span>USDA_CLASS, <span class="st">&quot;_&quot;</span>, soil_lc<span class="sc">$</span>LU)</span>
<span id="cb54-177"><a href="annex-i-compendium-of-r-scripts.html#cb54-177" aria-hidden="true" tabindex="-1"></a>    soil_lc <span class="ot">&lt;-</span> soil_lc <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(soil_lc, geometry)</span>
<span id="cb54-178"><a href="annex-i-compendium-of-r-scripts.html#cb54-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-179"><a href="annex-i-compendium-of-r-scripts.html#cb54-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-180"><a href="annex-i-compendium-of-r-scripts.html#cb54-180" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Accommodate strata to requirements =======================================</span></span>
<span id="cb54-181"><a href="annex-i-compendium-of-r-scripts.html#cb54-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-182"><a href="annex-i-compendium-of-r-scripts.html#cb54-182" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select by Area. Convert to area to ha and select polygons &gt; 100 has</span></span>
<span id="cb54-183"><a href="annex-i-compendium-of-r-scripts.html#cb54-183" aria-hidden="true" tabindex="-1"></a>    soil_lc<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(soil_lc)<span class="sc">/</span><span class="dv">10000</span> </span>
<span id="cb54-184"><a href="annex-i-compendium-of-r-scripts.html#cb54-184" aria-hidden="true" tabindex="-1"></a>    soil_lc<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(soil_lc<span class="sc">$</span>area)</span>
<span id="cb54-185"><a href="annex-i-compendium-of-r-scripts.html#cb54-185" aria-hidden="true" tabindex="-1"></a>    soil_lc <span class="ot">&lt;-</span> soil_lc <span class="sc">%&gt;%</span> </span>
<span id="cb54-186"><a href="annex-i-compendium-of-r-scripts.html#cb54-186" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(soil_lc) <span class="sc">%&gt;%</span> </span>
<span id="cb54-187"><a href="annex-i-compendium-of-r-scripts.html#cb54-187" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">area =</span> <span class="fu">sum</span>(area))</span>
<span id="cb54-188"><a href="annex-i-compendium-of-r-scripts.html#cb54-188" aria-hidden="true" tabindex="-1"></a>    soil_lc <span class="ot">&lt;-</span> soil_lc[soil_lc<span class="sc">$</span>area <span class="sc">&gt;</span> <span class="dv">100</span>,]</span>
<span id="cb54-189"><a href="annex-i-compendium-of-r-scripts.html#cb54-189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(soil_lc[<span class="dv">1</span>])</span>
<span id="cb54-190"><a href="annex-i-compendium-of-r-scripts.html#cb54-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-191"><a href="annex-i-compendium-of-r-scripts.html#cb54-191" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace blank spaces with underscore symbol to keep names uniform</span></span>
<span id="cb54-192"><a href="annex-i-compendium-of-r-scripts.html#cb54-192" aria-hidden="true" tabindex="-1"></a>    soil_lc<span class="sc">$</span>soil_lc <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(soil_lc<span class="sc">$</span>soil_lc, <span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>)</span>
<span id="cb54-193"><a href="annex-i-compendium-of-r-scripts.html#cb54-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-194"><a href="annex-i-compendium-of-r-scripts.html#cb54-194" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a column of strata numeric codes</span></span>
<span id="cb54-195"><a href="annex-i-compendium-of-r-scripts.html#cb54-195" aria-hidden="true" tabindex="-1"></a>    soil_lc<span class="sc">$</span>code <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(soil_lc<span class="sc">$</span>soil_lc)))</span>
<span id="cb54-196"><a href="annex-i-compendium-of-r-scripts.html#cb54-196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-197"><a href="annex-i-compendium-of-r-scripts.html#cb54-197" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List final strata</span></span>
<span id="cb54-198"><a href="annex-i-compendium-of-r-scripts.html#cb54-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(soil_lc<span class="sc">$</span>soil_lc)</span>
<span id="cb54-199"><a href="annex-i-compendium-of-r-scripts.html#cb54-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-200"><a href="annex-i-compendium-of-r-scripts.html#cb54-200" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write final sampling strata map</span></span>
<span id="cb54-201"><a href="annex-i-compendium-of-r-scripts.html#cb54-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(soil_lc, <span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-202"><a href="annex-i-compendium-of-r-scripts.html#cb54-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-203"><a href="annex-i-compendium-of-r-scripts.html#cb54-203" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Plot strata ==============================================================</span></span>
<span id="cb54-204"><a href="annex-i-compendium-of-r-scripts.html#cb54-204" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-205"><a href="annex-i-compendium-of-r-scripts.html#cb54-205" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot strata map</span></span>
<span id="cb54-206"><a href="annex-i-compendium-of-r-scripts.html#cb54-206" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">11.4</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb54-207"><a href="annex-i-compendium-of-r-scripts.html#cb54-207" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb54-208"><a href="annex-i-compendium-of-r-scripts.html#cb54-208" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T,</span>
<span id="cb54-209"><a href="annex-i-compendium-of-r-scripts.html#cb54-209" aria-hidden="true" tabindex="-1"></a>                  <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>, <span class="at">map=</span>map)</span>
<span id="cb54-210"><a href="annex-i-compendium-of-r-scripts.html#cb54-210" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb54-211"><a href="annex-i-compendium-of-r-scripts.html#cb54-211" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-212"><a href="annex-i-compendium-of-r-scripts.html#cb54-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-213"><a href="annex-i-compendium-of-r-scripts.html#cb54-213" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Stratified random sampling ===============================================</span></span>
<span id="cb54-214"><a href="annex-i-compendium-of-r-scripts.html#cb54-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-215"><a href="annex-i-compendium-of-r-scripts.html#cb54-215" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read already created strata shapefile</span></span>
<span id="cb54-216"><a href="annex-i-compendium-of-r-scripts.html#cb54-216" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>))</span>
<span id="cb54-217"><a href="annex-i-compendium-of-r-scripts.html#cb54-217" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(REPLACEMENT){</span>
<span id="cb54-218"><a href="annex-i-compendium-of-r-scripts.html#cb54-218" aria-hidden="true" tabindex="-1"></a>      polygons <span class="ot">=</span> <span class="fu">st_intersection</span>(polygons,distance.buffer)</span>
<span id="cb54-219"><a href="annex-i-compendium-of-r-scripts.html#cb54-219" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-220"><a href="annex-i-compendium-of-r-scripts.html#cb54-220" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-221"><a href="annex-i-compendium-of-r-scripts.html#cb54-221" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the area of each polygon  </span></span>
<span id="cb54-222"><a href="annex-i-compendium-of-r-scripts.html#cb54-222" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(polygons) </span>
<span id="cb54-223"><a href="annex-i-compendium-of-r-scripts.html#cb54-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-224"><a href="annex-i-compendium-of-r-scripts.html#cb54-224" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a new column to group polygons by a common attribute</span></span>
<span id="cb54-225"><a href="annex-i-compendium-of-r-scripts.html#cb54-225" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>group <span class="ot">&lt;-</span> polygons<span class="sc">$</span>soil_lc</span>
<span id="cb54-226"><a href="annex-i-compendium-of-r-scripts.html#cb54-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop units to allow computations</span></span>
<span id="cb54-227"><a href="annex-i-compendium-of-r-scripts.html#cb54-227" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">drop_units</span>(polygons)</span>
<span id="cb54-228"><a href="annex-i-compendium-of-r-scripts.html#cb54-228" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-229"><a href="annex-i-compendium-of-r-scripts.html#cb54-229" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the total area of all polygons in each group</span></span>
<span id="cb54-230"><a href="annex-i-compendium-of-r-scripts.html#cb54-230" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span></span>
<span id="cb54-231"><a href="annex-i-compendium-of-r-scripts.html#cb54-231" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(group)  <span class="sc">%&gt;%</span> </span>
<span id="cb54-232"><a href="annex-i-compendium-of-r-scripts.html#cb54-232" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">total_area =</span> <span class="fu">sum</span>(area))</span>
<span id="cb54-233"><a href="annex-i-compendium-of-r-scripts.html#cb54-233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a code to each group</span></span>
<span id="cb54-234"><a href="annex-i-compendium-of-r-scripts.html#cb54-234" aria-hidden="true" tabindex="-1"></a>    group_codes <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb54-235"><a href="annex-i-compendium-of-r-scripts.html#cb54-235" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">code =</span> <span class="fu">first</span>(code)) </span>
<span id="cb54-236"><a href="annex-i-compendium-of-r-scripts.html#cb54-236" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join polygon strata and codes   </span></span>
<span id="cb54-237"><a href="annex-i-compendium-of-r-scripts.html#cb54-237" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">st_drop_geometry</span>(group_codes), <span class="at">by =</span> <span class="st">&quot;group&quot;</span>)</span>
<span id="cb54-238"><a href="annex-i-compendium-of-r-scripts.html#cb54-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-239"><a href="annex-i-compendium-of-r-scripts.html#cb54-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure minimum of 2 samples at each polygon in each group</span></span>
<span id="cb54-240"><a href="annex-i-compendium-of-r-scripts.html#cb54-240" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb54-241"><a href="annex-i-compendium-of-r-scripts.html#cb54-241" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-242"><a href="annex-i-compendium-of-r-scripts.html#cb54-242" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the number of samples per group based on relative area</span></span>
<span id="cb54-243"><a href="annex-i-compendium-of-r-scripts.html#cb54-243" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> </span>
<span id="cb54-244"><a href="annex-i-compendium-of-r-scripts.html#cb54-244" aria-hidden="true" tabindex="-1"></a>      group_areas<span class="sc">$</span>sample_count <span class="sc">+</span> </span>
<span id="cb54-245"><a href="annex-i-compendium-of-r-scripts.html#cb54-245" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(group_areas<span class="sc">$</span>total_area<span class="sc">/</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>total_area) <span class="sc">*</span></span>
<span id="cb54-246"><a href="annex-i-compendium-of-r-scripts.html#cb54-246" aria-hidden="true" tabindex="-1"></a>              (n<span class="sc">-</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count)))</span>
<span id="cb54-247"><a href="annex-i-compendium-of-r-scripts.html#cb54-247" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Adjust sample size on classes</span></span>
<span id="cb54-248"><a href="annex-i-compendium-of-r-scripts.html#cb54-248" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">!=</span> n) {</span>
<span id="cb54-249"><a href="annex-i-compendium-of-r-scripts.html#cb54-249" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">&gt;</span> n) {</span>
<span id="cb54-250"><a href="annex-i-compendium-of-r-scripts.html#cb54-250" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Reduce sample count for the largest polygon until total count is n</span></span>
<span id="cb54-251"><a href="annex-i-compendium-of-r-scripts.html#cb54-251" aria-hidden="true" tabindex="-1"></a>        max_index <span class="ot">&lt;-</span> <span class="fu">which.max</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb54-252"><a href="annex-i-compendium-of-r-scripts.html#cb54-252" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[max_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[max_index] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb54-253"><a href="annex-i-compendium-of-r-scripts.html#cb54-253" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb54-254"><a href="annex-i-compendium-of-r-scripts.html#cb54-254" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Increase sample count for the smallest polygon until total count is n</span></span>
<span id="cb54-255"><a href="annex-i-compendium-of-r-scripts.html#cb54-255" aria-hidden="true" tabindex="-1"></a>        min_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb54-256"><a href="annex-i-compendium-of-r-scripts.html#cb54-256" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[min_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[min_index] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb54-257"><a href="annex-i-compendium-of-r-scripts.html#cb54-257" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb54-258"><a href="annex-i-compendium-of-r-scripts.html#cb54-258" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-259"><a href="annex-i-compendium-of-r-scripts.html#cb54-259" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count the total samples. It must be equal to the sampling size</span></span>
<span id="cb54-260"><a href="annex-i-compendium-of-r-scripts.html#cb54-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) </span>
<span id="cb54-261"><a href="annex-i-compendium-of-r-scripts.html#cb54-261" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-262"><a href="annex-i-compendium-of-r-scripts.html#cb54-262" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">left_join</span>(polygons, <span class="fu">st_drop_geometry</span>(group_areas),</span>
<span id="cb54-263"><a href="annex-i-compendium-of-r-scripts.html#cb54-263" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;soil_lc&quot;</span><span class="ot">=</span><span class="st">&quot;group&quot;</span>))</span>
<span id="cb54-264"><a href="annex-i-compendium-of-r-scripts.html#cb54-264" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(polygons, soil_lc, code.x, sample_count, geometry)</span>
<span id="cb54-265"><a href="annex-i-compendium-of-r-scripts.html#cb54-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-266"><a href="annex-i-compendium-of-r-scripts.html#cb54-266" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate random points within each strata of size 3 times</span></span>
<span id="cb54-267"><a href="annex-i-compendium-of-r-scripts.html#cb54-267" aria-hidden="true" tabindex="-1"></a>  <span class="co">#the required samples for each strata</span></span>
<span id="cb54-268"><a href="annex-i-compendium-of-r-scripts.html#cb54-268" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas),</span>
<span id="cb54-269"><a href="annex-i-compendium-of-r-scripts.html#cb54-269" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> group_areas<span class="sc">$</span>sample_count <span class="sc">*</span> <span class="dv">3</span>, <span class="at">method =</span> <span class="st">&quot;random&quot;</span>)</span>
<span id="cb54-270"><a href="annex-i-compendium-of-r-scripts.html#cb54-270" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-271"><a href="annex-i-compendium-of-r-scripts.html#cb54-271" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute sampling points for strata</span></span>
<span id="cb54-272"><a href="annex-i-compendium-of-r-scripts.html#cb54-272" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb54-273"><a href="annex-i-compendium-of-r-scripts.html#cb54-273" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb54-274"><a href="annex-i-compendium-of-r-scripts.html#cb54-274" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb54-275"><a href="annex-i-compendium-of-r-scripts.html#cb54-275" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb54-276"><a href="annex-i-compendium-of-r-scripts.html#cb54-276" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb54-277"><a href="annex-i-compendium-of-r-scripts.html#cb54-277" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb54-278"><a href="annex-i-compendium-of-r-scripts.html#cb54-278" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb54-279"><a href="annex-i-compendium-of-r-scripts.html#cb54-279" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb54-280"><a href="annex-i-compendium-of-r-scripts.html#cb54-280" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-281"><a href="annex-i-compendium-of-r-scripts.html#cb54-281" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find classes with missing samples</span></span>
<span id="cb54-282"><a href="annex-i-compendium-of-r-scripts.html#cb54-282" aria-hidden="true" tabindex="-1"></a>    missing.data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">data.frame</span>(z) <span class="sc">%&gt;%</span></span>
<span id="cb54-283"><a href="annex-i-compendium-of-r-scripts.html#cb54-283" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">filter</span>(type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-284"><a href="annex-i-compendium-of-r-scripts.html#cb54-284" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span></span>
<span id="cb54-285"><a href="annex-i-compendium-of-r-scripts.html#cb54-285" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">tally</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb54-286"><a href="annex-i-compendium-of-r-scripts.html#cb54-286" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diff=</span>sample_count<span class="sc">-</span>n)</span>
<span id="cb54-287"><a href="annex-i-compendium-of-r-scripts.html#cb54-287" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-288"><a href="annex-i-compendium-of-r-scripts.html#cb54-288" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine missing sampled strata</span></span>
<span id="cb54-289"><a href="annex-i-compendium-of-r-scripts.html#cb54-289" aria-hidden="true" tabindex="-1"></a>    missing.strata <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(missing.data<span class="sc">$</span>diff))</span>
<span id="cb54-290"><a href="annex-i-compendium-of-r-scripts.html#cb54-290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-291"><a href="annex-i-compendium-of-r-scripts.html#cb54-291" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine missing sampling point in strata (undersampled strata)</span></span>
<span id="cb54-292"><a href="annex-i-compendium-of-r-scripts.html#cb54-292" aria-hidden="true" tabindex="-1"></a>    missing.sample <span class="ot">=</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb54-293"><a href="annex-i-compendium-of-r-scripts.html#cb54-293" aria-hidden="true" tabindex="-1"></a>    missing.number <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">st_drop_geometry</span>(missing.data[(missing.sample <span class="ot">&lt;-</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)),<span class="dv">7</span>])))</span>
<span id="cb54-294"><a href="annex-i-compendium-of-r-scripts.html#cb54-294" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-295"><a href="annex-i-compendium-of-r-scripts.html#cb54-295" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute sampling points for missing sampled strata</span></span>
<span id="cb54-296"><a href="annex-i-compendium-of-r-scripts.html#cb54-296" aria-hidden="true" tabindex="-1"></a>    x.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb54-297"><a href="annex-i-compendium-of-r-scripts.html#cb54-297" aria-hidden="true" tabindex="-1"></a>    x.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-298"><a href="annex-i-compendium-of-r-scripts.html#cb54-298" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-299"><a href="annex-i-compendium-of-r-scripts.html#cb54-299" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.strata){</span>
<span id="cb54-300"><a href="annex-i-compendium-of-r-scripts.html#cb54-300" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb54-301"><a href="annex-i-compendium-of-r-scripts.html#cb54-301" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-302"><a href="annex-i-compendium-of-r-scripts.html#cb54-302" aria-hidden="true" tabindex="-1"></a>      nn<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb54-303"><a href="annex-i-compendium-of-r-scripts.html#cb54-303" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> </span>
<span id="cb54-304"><a href="annex-i-compendium-of-r-scripts.html#cb54-304" aria-hidden="true" tabindex="-1"></a>             group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>) {</span>
<span id="cb54-305"><a href="annex-i-compendium-of-r-scripts.html#cb54-305" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb54-306"><a href="annex-i-compendium-of-r-scripts.html#cb54-306" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span>(nn <span class="sc">&lt;</span> group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>){</span>
<span id="cb54-307"><a href="annex-i-compendium-of-r-scripts.html#cb54-307" aria-hidden="true" tabindex="-1"></a>          my.missing.strata <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb54-308"><a href="annex-i-compendium-of-r-scripts.html#cb54-308" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">size =</span>  group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>,</span>
<span id="cb54-309"><a href="annex-i-compendium-of-r-scripts.html#cb54-309" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">method =</span> <span class="st">&quot;random&quot;</span>)</span>
<span id="cb54-310"><a href="annex-i-compendium-of-r-scripts.html#cb54-310" aria-hidden="true" tabindex="-1"></a>          nn <span class="ot">&lt;-</span> nn <span class="sc">+</span> <span class="fu">nrow</span>(<span class="fu">data.frame</span>(my.missing.strata))</span>
<span id="cb54-311"><a href="annex-i-compendium-of-r-scripts.html#cb54-311" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb54-312"><a href="annex-i-compendium-of-r-scripts.html#cb54-312" aria-hidden="true" tabindex="-1"></a>        xx.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.strata,my.missing.strata)</span>
<span id="cb54-313"><a href="annex-i-compendium-of-r-scripts.html#cb54-313" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count))</span>
<span id="cb54-314"><a href="annex-i-compendium-of-r-scripts.html#cb54-314" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb54-315"><a href="annex-i-compendium-of-r-scripts.html#cb54-315" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb54-316"><a href="annex-i-compendium-of-r-scripts.html#cb54-316" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.strata)</span>
<span id="cb54-317"><a href="annex-i-compendium-of-r-scripts.html#cb54-317" aria-hidden="true" tabindex="-1"></a>      x.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.strata,xx.missing.strata)</span>
<span id="cb54-318"><a href="annex-i-compendium-of-r-scripts.html#cb54-318" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-319"><a href="annex-i-compendium-of-r-scripts.html#cb54-319" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-320"><a href="annex-i-compendium-of-r-scripts.html#cb54-320" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join initial sampling with missing sampling strata data</span></span>
<span id="cb54-321"><a href="annex-i-compendium-of-r-scripts.html#cb54-321" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.strata)</span>
<span id="cb54-322"><a href="annex-i-compendium-of-r-scripts.html#cb54-322" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-323"><a href="annex-i-compendium-of-r-scripts.html#cb54-323" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute sampling points for missing samples (random sampling)</span></span>
<span id="cb54-324"><a href="annex-i-compendium-of-r-scripts.html#cb54-324" aria-hidden="true" tabindex="-1"></a>    x.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb54-325"><a href="annex-i-compendium-of-r-scripts.html#cb54-325" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-326"><a href="annex-i-compendium-of-r-scripts.html#cb54-326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.sample){</span>
<span id="cb54-327"><a href="annex-i-compendium-of-r-scripts.html#cb54-327" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb54-328"><a href="annex-i-compendium-of-r-scripts.html#cb54-328" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-329"><a href="annex-i-compendium-of-r-scripts.html#cb54-329" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>)) {</span>
<span id="cb54-330"><a href="annex-i-compendium-of-r-scripts.html#cb54-330" aria-hidden="true" tabindex="-1"></a>        my.missing.sample <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb54-331"><a href="annex-i-compendium-of-r-scripts.html#cb54-331" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">size =</span> <span class="fu">as.numeric</span>(<span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,])[[<span class="dv">4</span>]])<span class="sc">+</span></span>
<span id="cb54-332"><a href="annex-i-compendium-of-r-scripts.html#cb54-332" aria-hidden="true" tabindex="-1"></a>                                          (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>), <span class="at">method =</span> <span class="st">&quot;random&quot;</span>)</span>
<span id="cb54-333"><a href="annex-i-compendium-of-r-scripts.html#cb54-333" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb54-334"><a href="annex-i-compendium-of-r-scripts.html#cb54-334" aria-hidden="true" tabindex="-1"></a>        xx.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.sample,my.missing.sample)</span>
<span id="cb54-335"><a href="annex-i-compendium-of-r-scripts.html#cb54-335" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count))</span>
<span id="cb54-336"><a href="annex-i-compendium-of-r-scripts.html#cb54-336" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb54-337"><a href="annex-i-compendium-of-r-scripts.html#cb54-337" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb54-338"><a href="annex-i-compendium-of-r-scripts.html#cb54-338" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.sample)</span>
<span id="cb54-339"><a href="annex-i-compendium-of-r-scripts.html#cb54-339" aria-hidden="true" tabindex="-1"></a>      x.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.sample,xx.missing.sample)</span>
<span id="cb54-340"><a href="annex-i-compendium-of-r-scripts.html#cb54-340" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-341"><a href="annex-i-compendium-of-r-scripts.html#cb54-341" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-342"><a href="annex-i-compendium-of-r-scripts.html#cb54-342" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join initial sampling with missing sampling strata data and with missing samples </span></span>
<span id="cb54-343"><a href="annex-i-compendium-of-r-scripts.html#cb54-343" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.sample)</span>
<span id="cb54-344"><a href="annex-i-compendium-of-r-scripts.html#cb54-344" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-345"><a href="annex-i-compendium-of-r-scripts.html#cb54-345" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove extra artificial replacements </span></span>
<span id="cb54-346"><a href="annex-i-compendium-of-r-scripts.html#cb54-346" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x[x<span class="sc">$</span>sample_count <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb54-347"><a href="annex-i-compendium-of-r-scripts.html#cb54-347" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-348"><a href="annex-i-compendium-of-r-scripts.html#cb54-348" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert and export to shapefile</span></span>
<span id="cb54-349"><a href="annex-i-compendium-of-r-scripts.html#cb54-349" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb54-350"><a href="annex-i-compendium-of-r-scripts.html#cb54-350" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb54-351"><a href="annex-i-compendium-of-r-scripts.html#cb54-351" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb54-352"><a href="annex-i-compendium-of-r-scripts.html#cb54-352" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb54-353"><a href="annex-i-compendium-of-r-scripts.html#cb54-353" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb54-354"><a href="annex-i-compendium-of-r-scripts.html#cb54-354" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb54-355"><a href="annex-i-compendium-of-r-scripts.html#cb54-355" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb54-356"><a href="annex-i-compendium-of-r-scripts.html#cb54-356" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb54-357"><a href="annex-i-compendium-of-r-scripts.html#cb54-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeVector</span>(z,</span>
<span id="cb54-358"><a href="annex-i-compendium-of-r-scripts.html#cb54-358" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(results.path,<span class="st">&quot;strat_randm_samples.shp&quot;</span>, <span class="at">overwrite=</span><span class="cn">TRUE</span>))</span>
<span id="cb54-359"><a href="annex-i-compendium-of-r-scripts.html#cb54-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-360"><a href="annex-i-compendium-of-r-scripts.html#cb54-360" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the number of initial target points equals the final target points </span></span>
<span id="cb54-361"><a href="annex-i-compendium-of-r-scripts.html#cb54-361" aria-hidden="true" tabindex="-1"></a>    n<span class="sc">==</span><span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb54-362"><a href="annex-i-compendium-of-r-scripts.html#cb54-362" aria-hidden="true" tabindex="-1"></a>    n;<span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb54-363"><a href="annex-i-compendium-of-r-scripts.html#cb54-363" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-364"><a href="annex-i-compendium-of-r-scripts.html#cb54-364" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot points over strata ==================================================</span></span>
<span id="cb54-365"><a href="annex-i-compendium-of-r-scripts.html#cb54-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-366"><a href="annex-i-compendium-of-r-scripts.html#cb54-366" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">11.4</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb54-367"><a href="annex-i-compendium-of-r-scripts.html#cb54-367" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb54-368"><a href="annex-i-compendium-of-r-scripts.html#cb54-368" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>) <span class="sc">+</span> </span>
<span id="cb54-369"><a href="annex-i-compendium-of-r-scripts.html#cb54-369" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(sf<span class="sc">::</span><span class="fu">st_as_sf</span>(z), <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;royalblue&#39;</span>, <span class="st">&#39;tomato&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Samples&quot;</span>)</span>
<span id="cb54-370"><a href="annex-i-compendium-of-r-scripts.html#cb54-370" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb54-371"><a href="annex-i-compendium-of-r-scripts.html#cb54-371" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-372"><a href="annex-i-compendium-of-r-scripts.html#cb54-372" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-373"><a href="annex-i-compendium-of-r-scripts.html#cb54-373" aria-hidden="true" tabindex="-1"></a><span class="co"># 10 - Calculate replacement areas for points ==================================    </span></span>
<span id="cb54-374"><a href="annex-i-compendium-of-r-scripts.html#cb54-374" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-375"><a href="annex-i-compendium-of-r-scripts.html#cb54-375" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(REPLACEMENT){</span>
<span id="cb54-376"><a href="annex-i-compendium-of-r-scripts.html#cb54-376" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Load strata</span></span>
<span id="cb54-377"><a href="annex-i-compendium-of-r-scripts.html#cb54-377" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>))</span>
<span id="cb54-378"><a href="annex-i-compendium-of-r-scripts.html#cb54-378" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-379"><a href="annex-i-compendium-of-r-scripts.html#cb54-379" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Read sampling. points from previous step</span></span>
<span id="cb54-380"><a href="annex-i-compendium-of-r-scripts.html#cb54-380" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strat_randm_samples.shp&quot;</span>))</span>
<span id="cb54-381"><a href="annex-i-compendium-of-r-scripts.html#cb54-381" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-382"><a href="annex-i-compendium-of-r-scripts.html#cb54-382" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Apply buffer of 500 meters</span></span>
<span id="cb54-383"><a href="annex-i-compendium-of-r-scripts.html#cb54-383" aria-hidden="true" tabindex="-1"></a>      buf.samples <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(z, <span class="at">dist=</span>distance.buffer)</span>
<span id="cb54-384"><a href="annex-i-compendium-of-r-scripts.html#cb54-384" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-385"><a href="annex-i-compendium-of-r-scripts.html#cb54-385" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Intersect buffers</span></span>
<span id="cb54-386"><a href="annex-i-compendium-of-r-scripts.html#cb54-386" aria-hidden="true" tabindex="-1"></a>      samples_buffer <span class="ot">=</span> <span class="fu">st_intersection</span>(soil_lc, buf.samples)</span>
<span id="cb54-387"><a href="annex-i-compendium-of-r-scripts.html#cb54-387" aria-hidden="true" tabindex="-1"></a>      samples_buffer <span class="ot">&lt;-</span> samples_buffer[samples_buffer<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,]</span>
<span id="cb54-388"><a href="annex-i-compendium-of-r-scripts.html#cb54-388" aria-hidden="true" tabindex="-1"></a>      samples_buffer <span class="ot">&lt;-</span> samples_buffer[samples_buffer<span class="sc">$</span>soil_lc<span class="sc">==</span>samples_buffer<span class="sc">$</span>group,]</span>
<span id="cb54-389"><a href="annex-i-compendium-of-r-scripts.html#cb54-389" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-390"><a href="annex-i-compendium-of-r-scripts.html#cb54-390" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save Sampling areas</span></span>
<span id="cb54-391"><a href="annex-i-compendium-of-r-scripts.html#cb54-391" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(samples_buffer, <span class="fu">paste0</span>(results.path,<span class="st">&quot;replacement_areas.shp&quot;</span>),</span>
<span id="cb54-392"><a href="annex-i-compendium-of-r-scripts.html#cb54-392" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-393"><a href="annex-i-compendium-of-r-scripts.html#cb54-393" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Write target points only</span></span>
<span id="cb54-394"><a href="annex-i-compendium-of-r-scripts.html#cb54-394" aria-hidden="true" tabindex="-1"></a>      targets <span class="ot">&lt;-</span> z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,]</span>
<span id="cb54-395"><a href="annex-i-compendium-of-r-scripts.html#cb54-395" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(targets, <span class="fu">paste0</span>(results.path,<span class="st">&quot;target_points.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-396"><a href="annex-i-compendium-of-r-scripts.html#cb54-396" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-397"><a href="annex-i-compendium-of-r-scripts.html#cb54-397" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-398"><a href="annex-i-compendium-of-r-scripts.html#cb54-398" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-399"><a href="annex-i-compendium-of-r-scripts.html#cb54-399" aria-hidden="true" tabindex="-1"></a><span class="co"># 11 - Stratified regular sampling ==================================    </span></span>
<span id="cb54-400"><a href="annex-i-compendium-of-r-scripts.html#cb54-400" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read already created strata shapefile</span></span>
<span id="cb54-401"><a href="annex-i-compendium-of-r-scripts.html#cb54-401" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>))</span>
<span id="cb54-402"><a href="annex-i-compendium-of-r-scripts.html#cb54-402" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(REPLACEMENT){</span>
<span id="cb54-403"><a href="annex-i-compendium-of-r-scripts.html#cb54-403" aria-hidden="true" tabindex="-1"></a>      polygons <span class="ot">=</span> <span class="fu">st_intersection</span>(polygons,distance.buffer)</span>
<span id="cb54-404"><a href="annex-i-compendium-of-r-scripts.html#cb54-404" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-405"><a href="annex-i-compendium-of-r-scripts.html#cb54-405" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-406"><a href="annex-i-compendium-of-r-scripts.html#cb54-406" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the area of each polygon  </span></span>
<span id="cb54-407"><a href="annex-i-compendium-of-r-scripts.html#cb54-407" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(polygons) </span>
<span id="cb54-408"><a href="annex-i-compendium-of-r-scripts.html#cb54-408" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-409"><a href="annex-i-compendium-of-r-scripts.html#cb54-409" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new column to group polygons by a common attribute</span></span>
<span id="cb54-410"><a href="annex-i-compendium-of-r-scripts.html#cb54-410" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>group <span class="ot">&lt;-</span> polygons<span class="sc">$</span>soil_lc</span>
<span id="cb54-411"><a href="annex-i-compendium-of-r-scripts.html#cb54-411" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop units to allow computations</span></span>
<span id="cb54-412"><a href="annex-i-compendium-of-r-scripts.html#cb54-412" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">drop_units</span>(polygons)</span>
<span id="cb54-413"><a href="annex-i-compendium-of-r-scripts.html#cb54-413" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-414"><a href="annex-i-compendium-of-r-scripts.html#cb54-414" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the total area of all polygons in each group</span></span>
<span id="cb54-415"><a href="annex-i-compendium-of-r-scripts.html#cb54-415" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span></span>
<span id="cb54-416"><a href="annex-i-compendium-of-r-scripts.html#cb54-416" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(group)  <span class="sc">%&gt;%</span> </span>
<span id="cb54-417"><a href="annex-i-compendium-of-r-scripts.html#cb54-417" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">total_area =</span> <span class="fu">sum</span>(area))</span>
<span id="cb54-418"><a href="annex-i-compendium-of-r-scripts.html#cb54-418" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a code to each group</span></span>
<span id="cb54-419"><a href="annex-i-compendium-of-r-scripts.html#cb54-419" aria-hidden="true" tabindex="-1"></a>    group_codes <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb54-420"><a href="annex-i-compendium-of-r-scripts.html#cb54-420" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">code =</span> <span class="fu">first</span>(code)) </span>
<span id="cb54-421"><a href="annex-i-compendium-of-r-scripts.html#cb54-421" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join polygon strata and codes   </span></span>
<span id="cb54-422"><a href="annex-i-compendium-of-r-scripts.html#cb54-422" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">st_drop_geometry</span>(group_codes), <span class="at">by =</span> <span class="st">&quot;group&quot;</span>)</span>
<span id="cb54-423"><a href="annex-i-compendium-of-r-scripts.html#cb54-423" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-424"><a href="annex-i-compendium-of-r-scripts.html#cb54-424" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure minimum of 2 samples at each polygon in each group</span></span>
<span id="cb54-425"><a href="annex-i-compendium-of-r-scripts.html#cb54-425" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb54-426"><a href="annex-i-compendium-of-r-scripts.html#cb54-426" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-427"><a href="annex-i-compendium-of-r-scripts.html#cb54-427" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the number of samples per group based on relative area</span></span>
<span id="cb54-428"><a href="annex-i-compendium-of-r-scripts.html#cb54-428" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> </span>
<span id="cb54-429"><a href="annex-i-compendium-of-r-scripts.html#cb54-429" aria-hidden="true" tabindex="-1"></a>      group_areas<span class="sc">$</span>sample_count <span class="sc">+</span> </span>
<span id="cb54-430"><a href="annex-i-compendium-of-r-scripts.html#cb54-430" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(group_areas<span class="sc">$</span>total_area<span class="sc">/</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>total_area) <span class="sc">*</span></span>
<span id="cb54-431"><a href="annex-i-compendium-of-r-scripts.html#cb54-431" aria-hidden="true" tabindex="-1"></a>              (n<span class="sc">-</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count)))</span>
<span id="cb54-432"><a href="annex-i-compendium-of-r-scripts.html#cb54-432" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust sample size on classes</span></span>
<span id="cb54-433"><a href="annex-i-compendium-of-r-scripts.html#cb54-433" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">!=</span> n) {</span>
<span id="cb54-434"><a href="annex-i-compendium-of-r-scripts.html#cb54-434" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">&gt;</span> n) {</span>
<span id="cb54-435"><a href="annex-i-compendium-of-r-scripts.html#cb54-435" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reduce sample count for the largest polygon until total count is n</span></span>
<span id="cb54-436"><a href="annex-i-compendium-of-r-scripts.html#cb54-436" aria-hidden="true" tabindex="-1"></a>        max_index <span class="ot">&lt;-</span> <span class="fu">which.max</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb54-437"><a href="annex-i-compendium-of-r-scripts.html#cb54-437" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[max_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[max_index] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb54-438"><a href="annex-i-compendium-of-r-scripts.html#cb54-438" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb54-439"><a href="annex-i-compendium-of-r-scripts.html#cb54-439" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Increase sample count for the smallest polygon until total count is n</span></span>
<span id="cb54-440"><a href="annex-i-compendium-of-r-scripts.html#cb54-440" aria-hidden="true" tabindex="-1"></a>        min_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb54-441"><a href="annex-i-compendium-of-r-scripts.html#cb54-441" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[min_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[min_index] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb54-442"><a href="annex-i-compendium-of-r-scripts.html#cb54-442" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb54-443"><a href="annex-i-compendium-of-r-scripts.html#cb54-443" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-444"><a href="annex-i-compendium-of-r-scripts.html#cb54-444" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count the total samples. It must be equal to the sampling size</span></span>
<span id="cb54-445"><a href="annex-i-compendium-of-r-scripts.html#cb54-445" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) </span>
<span id="cb54-446"><a href="annex-i-compendium-of-r-scripts.html#cb54-446" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-447"><a href="annex-i-compendium-of-r-scripts.html#cb54-447" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">left_join</span>(polygons, <span class="fu">st_drop_geometry</span>(group_areas),</span>
<span id="cb54-448"><a href="annex-i-compendium-of-r-scripts.html#cb54-448" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;soil_lc&quot;</span><span class="ot">=</span><span class="st">&quot;group&quot;</span>))</span>
<span id="cb54-449"><a href="annex-i-compendium-of-r-scripts.html#cb54-449" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(polygons, soil_lc, code.x, sample_count, geometry)</span>
<span id="cb54-450"><a href="annex-i-compendium-of-r-scripts.html#cb54-450" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-451"><a href="annex-i-compendium-of-r-scripts.html#cb54-451" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate regular points within each strata of size 3 times</span></span>
<span id="cb54-452"><a href="annex-i-compendium-of-r-scripts.html#cb54-452" aria-hidden="true" tabindex="-1"></a>    <span class="co">#the required samples for each strata</span></span>
<span id="cb54-453"><a href="annex-i-compendium-of-r-scripts.html#cb54-453" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas),</span>
<span id="cb54-454"><a href="annex-i-compendium-of-r-scripts.html#cb54-454" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> group_areas<span class="sc">$</span>sample_count <span class="sc">*</span> <span class="dv">3</span>, <span class="at">method =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb54-455"><a href="annex-i-compendium-of-r-scripts.html#cb54-455" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-456"><a href="annex-i-compendium-of-r-scripts.html#cb54-456" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points for strata</span></span>
<span id="cb54-457"><a href="annex-i-compendium-of-r-scripts.html#cb54-457" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb54-458"><a href="annex-i-compendium-of-r-scripts.html#cb54-458" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb54-459"><a href="annex-i-compendium-of-r-scripts.html#cb54-459" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb54-460"><a href="annex-i-compendium-of-r-scripts.html#cb54-460" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb54-461"><a href="annex-i-compendium-of-r-scripts.html#cb54-461" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb54-462"><a href="annex-i-compendium-of-r-scripts.html#cb54-462" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb54-463"><a href="annex-i-compendium-of-r-scripts.html#cb54-463" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb54-464"><a href="annex-i-compendium-of-r-scripts.html#cb54-464" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb54-465"><a href="annex-i-compendium-of-r-scripts.html#cb54-465" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-466"><a href="annex-i-compendium-of-r-scripts.html#cb54-466" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find classes with missing samples</span></span>
<span id="cb54-467"><a href="annex-i-compendium-of-r-scripts.html#cb54-467" aria-hidden="true" tabindex="-1"></a>    missing.data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">data.frame</span>(z) <span class="sc">%&gt;%</span></span>
<span id="cb54-468"><a href="annex-i-compendium-of-r-scripts.html#cb54-468" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">filter</span>(type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-469"><a href="annex-i-compendium-of-r-scripts.html#cb54-469" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span></span>
<span id="cb54-470"><a href="annex-i-compendium-of-r-scripts.html#cb54-470" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">tally</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb54-471"><a href="annex-i-compendium-of-r-scripts.html#cb54-471" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diff=</span>sample_count<span class="sc">-</span>n)</span>
<span id="cb54-472"><a href="annex-i-compendium-of-r-scripts.html#cb54-472" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-473"><a href="annex-i-compendium-of-r-scripts.html#cb54-473" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine missing sampled strata</span></span>
<span id="cb54-474"><a href="annex-i-compendium-of-r-scripts.html#cb54-474" aria-hidden="true" tabindex="-1"></a>    missing.strata <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(missing.data<span class="sc">$</span>diff))</span>
<span id="cb54-475"><a href="annex-i-compendium-of-r-scripts.html#cb54-475" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-476"><a href="annex-i-compendium-of-r-scripts.html#cb54-476" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine missing sampling point in strata (undersampled strata)</span></span>
<span id="cb54-477"><a href="annex-i-compendium-of-r-scripts.html#cb54-477" aria-hidden="true" tabindex="-1"></a>    missing.sample <span class="ot">=</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb54-478"><a href="annex-i-compendium-of-r-scripts.html#cb54-478" aria-hidden="true" tabindex="-1"></a>    missing.number <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">st_drop_geometry</span>(missing.data[(missing.sample <span class="ot">&lt;-</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)),<span class="dv">7</span>])))</span>
<span id="cb54-479"><a href="annex-i-compendium-of-r-scripts.html#cb54-479" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-480"><a href="annex-i-compendium-of-r-scripts.html#cb54-480" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points for missing sampled strata</span></span>
<span id="cb54-481"><a href="annex-i-compendium-of-r-scripts.html#cb54-481" aria-hidden="true" tabindex="-1"></a>    x.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb54-482"><a href="annex-i-compendium-of-r-scripts.html#cb54-482" aria-hidden="true" tabindex="-1"></a>    x.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-483"><a href="annex-i-compendium-of-r-scripts.html#cb54-483" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-484"><a href="annex-i-compendium-of-r-scripts.html#cb54-484" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.strata){</span>
<span id="cb54-485"><a href="annex-i-compendium-of-r-scripts.html#cb54-485" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb54-486"><a href="annex-i-compendium-of-r-scripts.html#cb54-486" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-487"><a href="annex-i-compendium-of-r-scripts.html#cb54-487" aria-hidden="true" tabindex="-1"></a>      nn<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb54-488"><a href="annex-i-compendium-of-r-scripts.html#cb54-488" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> </span>
<span id="cb54-489"><a href="annex-i-compendium-of-r-scripts.html#cb54-489" aria-hidden="true" tabindex="-1"></a>             group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>) {</span>
<span id="cb54-490"><a href="annex-i-compendium-of-r-scripts.html#cb54-490" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb54-491"><a href="annex-i-compendium-of-r-scripts.html#cb54-491" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span>(nn <span class="sc">&lt;</span> group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>){</span>
<span id="cb54-492"><a href="annex-i-compendium-of-r-scripts.html#cb54-492" aria-hidden="true" tabindex="-1"></a>          my.missing.strata <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb54-493"><a href="annex-i-compendium-of-r-scripts.html#cb54-493" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">size =</span>  group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>,</span>
<span id="cb54-494"><a href="annex-i-compendium-of-r-scripts.html#cb54-494" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">method =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb54-495"><a href="annex-i-compendium-of-r-scripts.html#cb54-495" aria-hidden="true" tabindex="-1"></a>          nn <span class="ot">&lt;-</span> nn <span class="sc">+</span> <span class="fu">nrow</span>(<span class="fu">data.frame</span>(my.missing.strata))</span>
<span id="cb54-496"><a href="annex-i-compendium-of-r-scripts.html#cb54-496" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb54-497"><a href="annex-i-compendium-of-r-scripts.html#cb54-497" aria-hidden="true" tabindex="-1"></a>        xx.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.strata,my.missing.strata)</span>
<span id="cb54-498"><a href="annex-i-compendium-of-r-scripts.html#cb54-498" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count))</span>
<span id="cb54-499"><a href="annex-i-compendium-of-r-scripts.html#cb54-499" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb54-500"><a href="annex-i-compendium-of-r-scripts.html#cb54-500" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb54-501"><a href="annex-i-compendium-of-r-scripts.html#cb54-501" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.strata)</span>
<span id="cb54-502"><a href="annex-i-compendium-of-r-scripts.html#cb54-502" aria-hidden="true" tabindex="-1"></a>      x.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.strata,xx.missing.strata)</span>
<span id="cb54-503"><a href="annex-i-compendium-of-r-scripts.html#cb54-503" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-504"><a href="annex-i-compendium-of-r-scripts.html#cb54-504" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-505"><a href="annex-i-compendium-of-r-scripts.html#cb54-505" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join initial sampling with missing sampling strata data</span></span>
<span id="cb54-506"><a href="annex-i-compendium-of-r-scripts.html#cb54-506" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.strata)</span>
<span id="cb54-507"><a href="annex-i-compendium-of-r-scripts.html#cb54-507" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-508"><a href="annex-i-compendium-of-r-scripts.html#cb54-508" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points for missing samples (regular sampling)</span></span>
<span id="cb54-509"><a href="annex-i-compendium-of-r-scripts.html#cb54-509" aria-hidden="true" tabindex="-1"></a>    x.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb54-510"><a href="annex-i-compendium-of-r-scripts.html#cb54-510" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-511"><a href="annex-i-compendium-of-r-scripts.html#cb54-511" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.sample){</span>
<span id="cb54-512"><a href="annex-i-compendium-of-r-scripts.html#cb54-512" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb54-513"><a href="annex-i-compendium-of-r-scripts.html#cb54-513" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-514"><a href="annex-i-compendium-of-r-scripts.html#cb54-514" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>)) {</span>
<span id="cb54-515"><a href="annex-i-compendium-of-r-scripts.html#cb54-515" aria-hidden="true" tabindex="-1"></a>        my.missing.sample <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb54-516"><a href="annex-i-compendium-of-r-scripts.html#cb54-516" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">size =</span> <span class="fu">as.numeric</span>(<span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,])[[<span class="dv">4</span>]])<span class="sc">+</span></span>
<span id="cb54-517"><a href="annex-i-compendium-of-r-scripts.html#cb54-517" aria-hidden="true" tabindex="-1"></a>                                          (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>), <span class="at">method =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb54-518"><a href="annex-i-compendium-of-r-scripts.html#cb54-518" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb54-519"><a href="annex-i-compendium-of-r-scripts.html#cb54-519" aria-hidden="true" tabindex="-1"></a>        xx.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.sample,my.missing.sample)</span>
<span id="cb54-520"><a href="annex-i-compendium-of-r-scripts.html#cb54-520" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count))</span>
<span id="cb54-521"><a href="annex-i-compendium-of-r-scripts.html#cb54-521" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb54-522"><a href="annex-i-compendium-of-r-scripts.html#cb54-522" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb54-523"><a href="annex-i-compendium-of-r-scripts.html#cb54-523" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.sample)</span>
<span id="cb54-524"><a href="annex-i-compendium-of-r-scripts.html#cb54-524" aria-hidden="true" tabindex="-1"></a>      x.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.sample,xx.missing.sample)</span>
<span id="cb54-525"><a href="annex-i-compendium-of-r-scripts.html#cb54-525" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-526"><a href="annex-i-compendium-of-r-scripts.html#cb54-526" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-527"><a href="annex-i-compendium-of-r-scripts.html#cb54-527" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join initial sampling with missing sampling strata data and with missing samples </span></span>
<span id="cb54-528"><a href="annex-i-compendium-of-r-scripts.html#cb54-528" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.sample)</span>
<span id="cb54-529"><a href="annex-i-compendium-of-r-scripts.html#cb54-529" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-530"><a href="annex-i-compendium-of-r-scripts.html#cb54-530" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove extra artificial replacements </span></span>
<span id="cb54-531"><a href="annex-i-compendium-of-r-scripts.html#cb54-531" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x[x<span class="sc">$</span>sample_count <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb54-532"><a href="annex-i-compendium-of-r-scripts.html#cb54-532" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-533"><a href="annex-i-compendium-of-r-scripts.html#cb54-533" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert and export to shapefile</span></span>
<span id="cb54-534"><a href="annex-i-compendium-of-r-scripts.html#cb54-534" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb54-535"><a href="annex-i-compendium-of-r-scripts.html#cb54-535" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb54-536"><a href="annex-i-compendium-of-r-scripts.html#cb54-536" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb54-537"><a href="annex-i-compendium-of-r-scripts.html#cb54-537" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb54-538"><a href="annex-i-compendium-of-r-scripts.html#cb54-538" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb54-539"><a href="annex-i-compendium-of-r-scripts.html#cb54-539" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb54-540"><a href="annex-i-compendium-of-r-scripts.html#cb54-540" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb54-541"><a href="annex-i-compendium-of-r-scripts.html#cb54-541" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb54-542"><a href="annex-i-compendium-of-r-scripts.html#cb54-542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeVector</span>(z,</span>
<span id="cb54-543"><a href="annex-i-compendium-of-r-scripts.html#cb54-543" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(results.path,<span class="st">&quot;strat_randm_samples.shp&quot;</span>, <span class="at">overwrite=</span><span class="cn">TRUE</span>))</span>
<span id="cb54-544"><a href="annex-i-compendium-of-r-scripts.html#cb54-544" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-545"><a href="annex-i-compendium-of-r-scripts.html#cb54-545" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the number of initial target points equals the final target points </span></span>
<span id="cb54-546"><a href="annex-i-compendium-of-r-scripts.html#cb54-546" aria-hidden="true" tabindex="-1"></a>    n<span class="sc">==</span><span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb54-547"><a href="annex-i-compendium-of-r-scripts.html#cb54-547" aria-hidden="true" tabindex="-1"></a>    n;<span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb54-548"><a href="annex-i-compendium-of-r-scripts.html#cb54-548" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-549"><a href="annex-i-compendium-of-r-scripts.html#cb54-549" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb54-550"><a href="annex-i-compendium-of-r-scripts.html#cb54-550" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">11.4</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb54-551"><a href="annex-i-compendium-of-r-scripts.html#cb54-551" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb54-552"><a href="annex-i-compendium-of-r-scripts.html#cb54-552" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>) <span class="sc">+</span> </span>
<span id="cb54-553"><a href="annex-i-compendium-of-r-scripts.html#cb54-553" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(sf<span class="sc">::</span><span class="fu">st_as_sf</span>(z), <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;royalblue&#39;</span>, <span class="st">&#39;tomato&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Samples&quot;</span>)</span>
<span id="cb54-554"><a href="annex-i-compendium-of-r-scripts.html#cb54-554" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb54-555"><a href="annex-i-compendium-of-r-scripts.html#cb54-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-556"><a href="annex-i-compendium-of-r-scripts.html#cb54-556" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-557"><a href="annex-i-compendium-of-r-scripts.html#cb54-557" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-558"><a href="annex-i-compendium-of-r-scripts.html#cb54-558" aria-hidden="true" tabindex="-1"></a><span class="co"># 12 - Random Sampling based on a stratified raster ================================== </span></span>
<span id="cb54-559"><a href="annex-i-compendium-of-r-scripts.html#cb54-559" aria-hidden="true" tabindex="-1"></a> <span class="co"># Load vector strata</span></span>
<span id="cb54-560"><a href="annex-i-compendium-of-r-scripts.html#cb54-560" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&quot;../soil_sampling/JAM/strata.shp&quot;</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-561"><a href="annex-i-compendium-of-r-scripts.html#cb54-561" aria-hidden="true" tabindex="-1"></a>    strata<span class="sc">$</span>code <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(strata<span class="sc">$</span>code)</span>
<span id="cb54-562"><a href="annex-i-compendium-of-r-scripts.html#cb54-562" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-563"><a href="annex-i-compendium-of-r-scripts.html#cb54-563" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform Vector to stratified raster </span></span>
<span id="cb54-564"><a href="annex-i-compendium-of-r-scripts.html#cb54-564" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">st_rasterize</span>(strata[<span class="st">&quot;code&quot;</span>],<span class="fu">st_as_stars</span>(<span class="fu">st_bbox</span>(strata), <span class="at">nx =</span> <span class="dv">250</span>, <span class="at">ny =</span> <span class="dv">250</span>)))</span>
<span id="cb54-565"><a href="annex-i-compendium-of-r-scripts.html#cb54-565" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(strata) <span class="ot">&lt;-</span> <span class="st">&quot;strata&quot;</span></span>
<span id="cb54-566"><a href="annex-i-compendium-of-r-scripts.html#cb54-566" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-567"><a href="annex-i-compendium-of-r-scripts.html#cb54-567" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create stratified random sampling</span></span>
<span id="cb54-568"><a href="annex-i-compendium-of-r-scripts.html#cb54-568" aria-hidden="true" tabindex="-1"></a>    srs <span class="ot">&lt;-</span> <span class="fu">sample_strat</span>(</span>
<span id="cb54-569"><a href="annex-i-compendium-of-r-scripts.html#cb54-569" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb54-570"><a href="annex-i-compendium-of-r-scripts.html#cb54-570" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSamp =</span> <span class="dv">200</span></span>
<span id="cb54-571"><a href="annex-i-compendium-of-r-scripts.html#cb54-571" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-572"><a href="annex-i-compendium-of-r-scripts.html#cb54-572" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-573"><a href="annex-i-compendium-of-r-scripts.html#cb54-573" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot samples over strata</span></span>
<span id="cb54-574"><a href="annex-i-compendium-of-r-scripts.html#cb54-574" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(strata, <span class="at">main=</span><span class="st">&quot;Strata and random samples&quot;</span>)</span>
<span id="cb54-575"><a href="annex-i-compendium-of-r-scripts.html#cb54-575" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(srs,<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb54-576"><a href="annex-i-compendium-of-r-scripts.html#cb54-576" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-577"><a href="annex-i-compendium-of-r-scripts.html#cb54-577" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Histogram of frequencies stratum vs samples</span></span>
<span id="cb54-578"><a href="annex-i-compendium-of-r-scripts.html#cb54-578" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_representation</span>(</span>
<span id="cb54-579"><a href="annex-i-compendium-of-r-scripts.html#cb54-579" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb54-580"><a href="annex-i-compendium-of-r-scripts.html#cb54-580" aria-hidden="true" tabindex="-1"></a>      <span class="at">existing =</span> srs,</span>
<span id="cb54-581"><a href="annex-i-compendium-of-r-scripts.html#cb54-581" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="cn">TRUE</span> </span>
<span id="cb54-582"><a href="annex-i-compendium-of-r-scripts.html#cb54-582" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-583"><a href="annex-i-compendium-of-r-scripts.html#cb54-583" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-584"><a href="annex-i-compendium-of-r-scripts.html#cb54-584" aria-hidden="true" tabindex="-1"></a><span class="do">####  Time required to compute the script</span></span>
<span id="cb54-585"><a href="annex-i-compendium-of-r-scripts.html#cb54-585" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>() <span class="sc">-</span> start_time </span></code></pre></div>
</div>
<div id="script-6-conditional-latin-hypercube-sampling" class="section level2 unnumbered hasAnchor">
<h2>Script 6: Conditional Latin Hypercube Sampling<a href="annex-i-compendium-of-r-scripts.html#script-6-conditional-latin-hypercube-sampling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="annex-i-compendium-of-r-scripts.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb55-2"><a href="annex-i-compendium-of-r-scripts.html#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb55-3"><a href="annex-i-compendium-of-r-scripts.html#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb55-4"><a href="annex-i-compendium-of-r-scripts.html#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># conditional Latin Hypercube Sampling</span></span>
<span id="cb55-5"><a href="annex-i-compendium-of-r-scripts.html#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb55-6"><a href="annex-i-compendium-of-r-scripts.html#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb55-7"><a href="annex-i-compendium-of-r-scripts.html#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb55-8"><a href="annex-i-compendium-of-r-scripts.html#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="annex-i-compendium-of-r-scripts.html#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb55-10"><a href="annex-i-compendium-of-r-scripts.html#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="annex-i-compendium-of-r-scripts.html#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empty environment and cache </span></span>
<span id="cb55-12"><a href="annex-i-compendium-of-r-scripts.html#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb55-13"><a href="annex-i-compendium-of-r-scripts.html#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb55-14"><a href="annex-i-compendium-of-r-scripts.html#cb55-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-15"><a href="annex-i-compendium-of-r-scripts.html#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script ========================================</span></span>
<span id="cb55-16"><a href="annex-i-compendium-of-r-scripts.html#cb55-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-17"><a href="annex-i-compendium-of-r-scripts.html#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Script for creating a sampling design based on conditioned Latin Hypercube Sampling.</span></span>
<span id="cb55-18"><a href="annex-i-compendium-of-r-scripts.html#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Given a suite of covariates this algorithm will assess the optimal location of</span></span>
<span id="cb55-19"><a href="annex-i-compendium-of-r-scripts.html#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  samples based on the amount of information in the set of covariates.</span></span>
<span id="cb55-20"><a href="annex-i-compendium-of-r-scripts.html#cb55-20" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb55-21"><a href="annex-i-compendium-of-r-scripts.html#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load packages</span></span>
<span id="cb55-22"><a href="annex-i-compendium-of-r-scripts.html#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb55-23"><a href="annex-i-compendium-of-r-scripts.html#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import national data </span></span>
<span id="cb55-24"><a href="annex-i-compendium-of-r-scripts.html#cb55-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Compute clhs</span></span>
<span id="cb55-25"><a href="annex-i-compendium-of-r-scripts.html#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Including existing legacy data in a cLHS sampling design </span></span>
<span id="cb55-26"><a href="annex-i-compendium-of-r-scripts.html#cb55-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Working with large raster data</span></span>
<span id="cb55-27"><a href="annex-i-compendium-of-r-scripts.html#cb55-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Cost–constrained cLHS sampling</span></span>
<span id="cb55-28"><a href="annex-i-compendium-of-r-scripts.html#cb55-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Replacement areas in cLHS design</span></span>
<span id="cb55-29"><a href="annex-i-compendium-of-r-scripts.html#cb55-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Polygonize replacement areas by similarity   </span></span>
<span id="cb55-30"><a href="annex-i-compendium-of-r-scripts.html#cb55-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Constrained cLHS sampling accounting for accessibility and legacy data  </span></span>
<span id="cb55-31"><a href="annex-i-compendium-of-r-scripts.html#cb55-31" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb55-32"><a href="annex-i-compendium-of-r-scripts.html#cb55-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-33"><a href="annex-i-compendium-of-r-scripts.html#cb55-33" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb55-34"><a href="annex-i-compendium-of-r-scripts.html#cb55-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-35"><a href="annex-i-compendium-of-r-scripts.html#cb55-35" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load packages =================================</span></span>
<span id="cb55-36"><a href="annex-i-compendium-of-r-scripts.html#cb55-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-37"><a href="annex-i-compendium-of-r-scripts.html#cb55-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#remotes::install_github(&quot;lemuscanovas/synoptReg&quot;)</span></span>
<span id="cb55-38"><a href="annex-i-compendium-of-r-scripts.html#cb55-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-39"><a href="annex-i-compendium-of-r-scripts.html#cb55-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb55-40"><a href="annex-i-compendium-of-r-scripts.html#cb55-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb55-41"><a href="annex-i-compendium-of-r-scripts.html#cb55-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb55-42"><a href="annex-i-compendium-of-r-scripts.html#cb55-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-43"><a href="annex-i-compendium-of-r-scripts.html#cb55-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of packages</span></span>
<span id="cb55-44"><a href="annex-i-compendium-of-r-scripts.html#cb55-44" aria-hidden="true" tabindex="-1"></a>  packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;terra&quot;</span>,<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sf&quot;</span>,<span class="st">&quot;clhs&quot;</span>, <span class="st">&quot;sgsR&quot;</span>,<span class="st">&quot;entropy&quot;</span>, <span class="st">&quot;tripack&quot;</span>,</span>
<span id="cb55-45"><a href="annex-i-compendium-of-r-scripts.html#cb55-45" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;manipulate&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;synoptReg&quot;</span>)</span>
<span id="cb55-46"><a href="annex-i-compendium-of-r-scripts.html#cb55-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages</span></span>
<span id="cb55-47"><a href="annex-i-compendium-of-r-scripts.html#cb55-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-48"><a href="annex-i-compendium-of-r-scripts.html#cb55-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove object to save memory space</span></span>
<span id="cb55-49"><a href="annex-i-compendium-of-r-scripts.html#cb55-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(packages) </span>
<span id="cb55-50"><a href="annex-i-compendium-of-r-scripts.html#cb55-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-51"><a href="annex-i-compendium-of-r-scripts.html#cb55-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-52"><a href="annex-i-compendium-of-r-scripts.html#cb55-52" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb55-53"><a href="annex-i-compendium-of-r-scripts.html#cb55-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to rasters</span></span>
<span id="cb55-54"><a href="annex-i-compendium-of-r-scripts.html#cb55-54" aria-hidden="true" tabindex="-1"></a>  raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters/&quot;</span></span>
<span id="cb55-55"><a href="annex-i-compendium-of-r-scripts.html#cb55-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to shapes</span></span>
<span id="cb55-56"><a href="annex-i-compendium-of-r-scripts.html#cb55-56" aria-hidden="true" tabindex="-1"></a>  shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes/&quot;</span></span>
<span id="cb55-57"><a href="annex-i-compendium-of-r-scripts.html#cb55-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to results</span></span>
<span id="cb55-58"><a href="annex-i-compendium-of-r-scripts.html#cb55-58" aria-hidden="true" tabindex="-1"></a>  results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb55-59"><a href="annex-i-compendium-of-r-scripts.html#cb55-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Buffer distance for replacement areas (clhs)</span></span>
<span id="cb55-60"><a href="annex-i-compendium-of-r-scripts.html#cb55-60" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co"># Buffer distance to calculate replacement areas </span></span>
<span id="cb55-61"><a href="annex-i-compendium-of-r-scripts.html#cb55-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the minimum sample size. By default it uses the value calculated previously</span></span>
<span id="cb55-62"><a href="annex-i-compendium-of-r-scripts.html#cb55-62" aria-hidden="true" tabindex="-1"></a>  minimum_n <span class="ot">&lt;-</span> <span class="dv">180</span></span>
<span id="cb55-63"><a href="annex-i-compendium-of-r-scripts.html#cb55-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregation factor for up-scaling raster covariates (optional)</span></span>
<span id="cb55-64"><a href="annex-i-compendium-of-r-scripts.html#cb55-64" aria-hidden="true" tabindex="-1"></a>  agg.factor <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb55-65"><a href="annex-i-compendium-of-r-scripts.html#cb55-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-66"><a href="annex-i-compendium-of-r-scripts.html#cb55-66" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Import national data ====================================================</span></span>
<span id="cb55-67"><a href="annex-i-compendium-of-r-scripts.html#cb55-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-68"><a href="annex-i-compendium-of-r-scripts.html#cb55-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb55-69"><a href="annex-i-compendium-of-r-scripts.html#cb55-69" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(raster.path, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-70"><a href="annex-i-compendium-of-r-scripts.html#cb55-70" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat) <span class="co"># SpatRaster from terra</span></span>
<span id="cb55-71"><a href="annex-i-compendium-of-r-scripts.html#cb55-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load shape of district</span></span>
<span id="cb55-72"><a href="annex-i-compendium-of-r-scripts.html#cb55-72" aria-hidden="true" tabindex="-1"></a>  nghe <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/Nghe_An.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-73"><a href="annex-i-compendium-of-r-scripts.html#cb55-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-74"><a href="annex-i-compendium-of-r-scripts.html#cb55-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crop covariates on administrative boundary</span></span>
<span id="cb55-75"><a href="annex-i-compendium-of-r-scripts.html#cb55-75" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-76"><a href="annex-i-compendium-of-r-scripts.html#cb55-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store elevation and slope separately</span></span>
<span id="cb55-77"><a href="annex-i-compendium-of-r-scripts.html#cb55-77" aria-hidden="true" tabindex="-1"></a>  elevation <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_elevation_250m</span>
<span id="cb55-78"><a href="annex-i-compendium-of-r-scripts.html#cb55-78" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_slope_250m</span>
<span id="cb55-79"><a href="annex-i-compendium-of-r-scripts.html#cb55-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-80"><a href="annex-i-compendium-of-r-scripts.html#cb55-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load roads</span></span>
<span id="cb55-81"><a href="annex-i-compendium-of-r-scripts.html#cb55-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">#roads &lt;-  vect(file.path(paste0(shp.path,&quot;/roads.shp&quot;)))</span></span>
<span id="cb55-82"><a href="annex-i-compendium-of-r-scripts.html#cb55-82" aria-hidden="true" tabindex="-1"></a>  <span class="co">#roads &lt;- crop(roads, nghe) </span></span>
<span id="cb55-83"><a href="annex-i-compendium-of-r-scripts.html#cb55-83" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span>  sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/roads.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-84"><a href="annex-i-compendium-of-r-scripts.html#cb55-84" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span>  <span class="fu">st_intersection</span>(roads, nghe)</span>
<span id="cb55-85"><a href="annex-i-compendium-of-r-scripts.html#cb55-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-86"><a href="annex-i-compendium-of-r-scripts.html#cb55-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simplify raster information with PCA</span></span>
<span id="cb55-87"><a href="annex-i-compendium-of-r-scripts.html#cb55-87" aria-hidden="true" tabindex="-1"></a>  pca <span class="ot">&lt;-</span> <span class="fu">raster_pca</span>(cov.dat)</span>
<span id="cb55-88"><a href="annex-i-compendium-of-r-scripts.html#cb55-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-89"><a href="annex-i-compendium-of-r-scripts.html#cb55-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get SpatRaster layers</span></span>
<span id="cb55-90"><a href="annex-i-compendium-of-r-scripts.html#cb55-90" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb55-91"><a href="annex-i-compendium-of-r-scripts.html#cb55-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a raster stack to be used as input in the clhs::clhs function </span></span>
<span id="cb55-92"><a href="annex-i-compendium-of-r-scripts.html#cb55-92" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat) </span>
<span id="cb55-93"><a href="annex-i-compendium-of-r-scripts.html#cb55-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset rasters</span></span>
<span id="cb55-94"><a href="annex-i-compendium-of-r-scripts.html#cb55-94" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb55-95"><a href="annex-i-compendium-of-r-scripts.html#cb55-95" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span>  cov.dat.ras[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb55-96"><a href="annex-i-compendium-of-r-scripts.html#cb55-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-97"><a href="annex-i-compendium-of-r-scripts.html#cb55-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate stack to simplify data rasters for calculations </span></span>
<span id="cb55-98"><a href="annex-i-compendium-of-r-scripts.html#cb55-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cov.dat &lt;- aggregate(cov.dat, fact=10, fun=&quot;mean&quot;)</span></span>
<span id="cb55-99"><a href="annex-i-compendium-of-r-scripts.html#cb55-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-100"><a href="annex-i-compendium-of-r-scripts.html#cb55-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot of covariates</span></span>
<span id="cb55-101"><a href="annex-i-compendium-of-r-scripts.html#cb55-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat)</span>
<span id="cb55-102"><a href="annex-i-compendium-of-r-scripts.html#cb55-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-103"><a href="annex-i-compendium-of-r-scripts.html#cb55-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-104"><a href="annex-i-compendium-of-r-scripts.html#cb55-104" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 - Compute clhs ============================================================</span></span>
<span id="cb55-105"><a href="annex-i-compendium-of-r-scripts.html#cb55-105" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb55-106"><a href="annex-i-compendium-of-r-scripts.html#cb55-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Distribute sampling points with clhs</span></span>
<span id="cb55-107"><a href="annex-i-compendium-of-r-scripts.html#cb55-107" aria-hidden="true" tabindex="-1"></a>  pts <span class="ot">&lt;-</span> <span class="fu">clhs</span>(cov.dat.ras, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-108"><a href="annex-i-compendium-of-r-scripts.html#cb55-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot of objective function</span></span>
<span id="cb55-109"><a href="annex-i-compendium-of-r-scripts.html#cb55-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(pts, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb55-110"><a href="annex-i-compendium-of-r-scripts.html#cb55-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot cLHS samples on map</span></span>
<span id="cb55-111"><a href="annex-i-compendium-of-r-scripts.html#cb55-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples&quot;</span>)</span>
<span id="cb55-112"><a href="annex-i-compendium-of-r-scripts.html#cb55-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(pts<span class="sc">$</span>sampled_data, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb55-113"><a href="annex-i-compendium-of-r-scripts.html#cb55-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-114"><a href="annex-i-compendium-of-r-scripts.html#cb55-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-115"><a href="annex-i-compendium-of-r-scripts.html#cb55-115" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 - Including existing legacy data in a cLHS sampling design ================</span></span>
<span id="cb55-116"><a href="annex-i-compendium-of-r-scripts.html#cb55-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-117"><a href="annex-i-compendium-of-r-scripts.html#cb55-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create an artificial legacy dataset of 50 samples over the study area as an example</span></span>
<span id="cb55-118"><a href="annex-i-compendium-of-r-scripts.html#cb55-118" aria-hidden="true" tabindex="-1"></a>  legacy.data <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(cov.dat, <span class="dv">50</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>,<span class="at">xy=</span><span class="cn">TRUE</span>,<span class="at">method=</span><span class="st">&quot;random&quot;</span>, <span class="at">as.points=</span>T) <span class="co"># works with SpatRaster </span></span>
<span id="cb55-119"><a href="annex-i-compendium-of-r-scripts.html#cb55-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-120"><a href="annex-i-compendium-of-r-scripts.html#cb55-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get covariates data as a points</span></span>
<span id="cb55-121"><a href="annex-i-compendium-of-r-scripts.html#cb55-121" aria-hidden="true" tabindex="-1"></a>  cov.df<span class="ot">&lt;-</span> <span class="fu">as.points</span>(cov.dat)</span>
<span id="cb55-122"><a href="annex-i-compendium-of-r-scripts.html#cb55-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-123"><a href="annex-i-compendium-of-r-scripts.html#cb55-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge legacy and covariate information</span></span>
<span id="cb55-124"><a href="annex-i-compendium-of-r-scripts.html#cb55-124" aria-hidden="true" tabindex="-1"></a>  leg.new <span class="ot">&lt;-</span>   <span class="fu">rbind</span>(legacy.data, cov.df)</span>
<span id="cb55-125"><a href="annex-i-compendium-of-r-scripts.html#cb55-125" aria-hidden="true" tabindex="-1"></a>  leg.new <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(leg.new,<span class="at">geom=</span><span class="st">&#39;XY&#39;</span>)</span>
<span id="cb55-126"><a href="annex-i-compendium-of-r-scripts.html#cb55-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Delete data from pixels outside the study area</span></span>
<span id="cb55-127"><a href="annex-i-compendium-of-r-scripts.html#cb55-127" aria-hidden="true" tabindex="-1"></a>  leg.new <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(leg.new)</span>
<span id="cb55-128"><a href="annex-i-compendium-of-r-scripts.html#cb55-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-129"><a href="annex-i-compendium-of-r-scripts.html#cb55-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate clhs 100 points plus locations of legacy data</span></span>
<span id="cb55-130"><a href="annex-i-compendium-of-r-scripts.html#cb55-130" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">clhs</span>(<span class="at">x =</span> leg.new, <span class="at">size =</span> <span class="dv">100</span> <span class="sc">+</span> <span class="fu">length</span>(legacy.data),  <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb55-131"><a href="annex-i-compendium-of-r-scripts.html#cb55-131" aria-hidden="true" tabindex="-1"></a>              <span class="at">must.include =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(legacy.data)))</span>
<span id="cb55-132"><a href="annex-i-compendium-of-r-scripts.html#cb55-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(res, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb55-133"><a href="annex-i-compendium-of-r-scripts.html#cb55-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get sampling points</span></span>
<span id="cb55-134"><a href="annex-i-compendium-of-r-scripts.html#cb55-134" aria-hidden="true" tabindex="-1"></a>  points <span class="ot">&lt;-</span> res<span class="sc">$</span>sampled_data</span>
<span id="cb55-135"><a href="annex-i-compendium-of-r-scripts.html#cb55-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-136"><a href="annex-i-compendium-of-r-scripts.html#cb55-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot points</span></span>
<span id="cb55-137"><a href="annex-i-compendium-of-r-scripts.html#cb55-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples (blue circles) and legacy samples (red diamonds)&quot;</span>)</span>
<span id="cb55-138"><a href="annex-i-compendium-of-r-scripts.html#cb55-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(points[,<span class="fu">c</span>(<span class="st">&quot;x&quot;</span>,<span class="st">&quot;y&quot;</span>)], <span class="at">col=</span><span class="st">&quot;navy&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb55-139"><a href="annex-i-compendium-of-r-scripts.html#cb55-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(legacy.data, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">5</span>, <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb55-140"><a href="annex-i-compendium-of-r-scripts.html#cb55-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-141"><a href="annex-i-compendium-of-r-scripts.html#cb55-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-142"><a href="annex-i-compendium-of-r-scripts.html#cb55-142" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 - Working with large raster data ==========================================</span></span>
<span id="cb55-143"><a href="annex-i-compendium-of-r-scripts.html#cb55-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-144"><a href="annex-i-compendium-of-r-scripts.html#cb55-144" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Scaling covariates</span></span>
<span id="cb55-145"><a href="annex-i-compendium-of-r-scripts.html#cb55-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregation of covariates by a factor of 10. </span></span>
<span id="cb55-146"><a href="annex-i-compendium-of-r-scripts.html#cb55-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The original grid resolution is up-scaled using the mean value of the pixels in the grid</span></span>
<span id="cb55-147"><a href="annex-i-compendium-of-r-scripts.html#cb55-147" aria-hidden="true" tabindex="-1"></a>    cov.dat2 <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(cov.dat, <span class="at">fact=</span><span class="dv">10</span>, <span class="at">fun=</span><span class="st">&quot;mean&quot;</span>)</span>
<span id="cb55-148"><a href="annex-i-compendium-of-r-scripts.html#cb55-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create clhs samples upon the resamples rasters  </span></span>
<span id="cb55-149"><a href="annex-i-compendium-of-r-scripts.html#cb55-149" aria-hidden="true" tabindex="-1"></a>    resampled.clhs <span class="ot">&lt;-</span> <span class="fu">clhs</span>(raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat2), <span class="at">size =</span> <span class="dv">100</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-150"><a href="annex-i-compendium-of-r-scripts.html#cb55-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(resampled.clhs, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb55-151"><a href="annex-i-compendium-of-r-scripts.html#cb55-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the points over the 1st raster</span></span>
<span id="cb55-152"><a href="annex-i-compendium-of-r-scripts.html#cb55-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat2[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;Regular resampled data&quot;</span>)</span>
<span id="cb55-153"><a href="annex-i-compendium-of-r-scripts.html#cb55-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(resampled.clhs<span class="sc">$</span>sampled_data , <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb55-154"><a href="annex-i-compendium-of-r-scripts.html#cb55-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-155"><a href="annex-i-compendium-of-r-scripts.html#cb55-155" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Sampling to regular points</span></span>
<span id="cb55-156"><a href="annex-i-compendium-of-r-scripts.html#cb55-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a regular grid of 1000 points on the covariate space</span></span>
<span id="cb55-157"><a href="annex-i-compendium-of-r-scripts.html#cb55-157" aria-hidden="true" tabindex="-1"></a>    regular.sample <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(cov.dat, <span class="at">size =</span> <span class="dv">1000</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">method=</span><span class="st">&quot;regular&quot;</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-158"><a href="annex-i-compendium-of-r-scripts.html#cb55-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot the points over the 1st raster</span></span>
<span id="cb55-159"><a href="annex-i-compendium-of-r-scripts.html#cb55-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;Regular resampled data&quot;</span>)</span>
<span id="cb55-160"><a href="annex-i-compendium-of-r-scripts.html#cb55-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(regular.sample, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb55-161"><a href="annex-i-compendium-of-r-scripts.html#cb55-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-162"><a href="annex-i-compendium-of-r-scripts.html#cb55-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create clhs samples upon the regular grid  </span></span>
<span id="cb55-163"><a href="annex-i-compendium-of-r-scripts.html#cb55-163" aria-hidden="true" tabindex="-1"></a>    regular.sample.clhs <span class="ot">&lt;-</span> <span class="fu">clhs</span>(regular.sample, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-164"><a href="annex-i-compendium-of-r-scripts.html#cb55-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(regular.sample.clhs, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb55-165"><a href="annex-i-compendium-of-r-scripts.html#cb55-165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot points of clhs samples</span></span>
<span id="cb55-166"><a href="annex-i-compendium-of-r-scripts.html#cb55-166" aria-hidden="true" tabindex="-1"></a>    points <span class="ot">&lt;-</span> regular.sample.clhs<span class="sc">$</span>sampled_data <span class="co"># Get point coordinates of clhs sampling</span></span>
<span id="cb55-167"><a href="annex-i-compendium-of-r-scripts.html#cb55-167" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples (red) and covariate resampled points (blue)&quot;</span>)</span>
<span id="cb55-168"><a href="annex-i-compendium-of-r-scripts.html#cb55-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(regular.sample, <span class="at">col=</span><span class="st">&quot;navy&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb55-169"><a href="annex-i-compendium-of-r-scripts.html#cb55-169" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(points, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">cex=</span><span class="dv">1</span>)</span>
<span id="cb55-170"><a href="annex-i-compendium-of-r-scripts.html#cb55-170" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb55-171"><a href="annex-i-compendium-of-r-scripts.html#cb55-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-172"><a href="annex-i-compendium-of-r-scripts.html#cb55-172" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Cost–constrained cLHS sampling</span></span>
<span id="cb55-173"><a href="annex-i-compendium-of-r-scripts.html#cb55-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a cost surface: &#39;Distance to roads&#39;</span></span>
<span id="cb55-174"><a href="annex-i-compendium-of-r-scripts.html#cb55-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-175"><a href="annex-i-compendium-of-r-scripts.html#cb55-175" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate distance to roads with te same spatial definition than the covariates</span></span>
<span id="cb55-176"><a href="annex-i-compendium-of-r-scripts.html#cb55-176" aria-hidden="true" tabindex="-1"></a>      <span class="co"># dist2access &lt;- terra::distance(cov.dat[[1]], roads, progress=TRUE)</span></span>
<span id="cb55-177"><a href="annex-i-compendium-of-r-scripts.html#cb55-177" aria-hidden="true" tabindex="-1"></a>      <span class="co"># names(dist2access) &lt;- &quot;dist2access&quot;</span></span>
<span id="cb55-178"><a href="annex-i-compendium-of-r-scripts.html#cb55-178" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save cost surface to disk</span></span>
<span id="cb55-179"><a href="annex-i-compendium-of-r-scripts.html#cb55-179" aria-hidden="true" tabindex="-1"></a>      <span class="co"># writeRaster(dist2access, paste0(results.path,&quot;nghe_d2roads.tif&quot;), overwrite=TRUE)</span></span>
<span id="cb55-180"><a href="annex-i-compendium-of-r-scripts.html#cb55-180" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb55-181"><a href="annex-i-compendium-of-r-scripts.html#cb55-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load pre-calculated distance–to–roads surface</span></span>
<span id="cb55-182"><a href="annex-i-compendium-of-r-scripts.html#cb55-182" aria-hidden="true" tabindex="-1"></a>    dist2access <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;nghe_d2roads.tif&quot;</span>))</span>
<span id="cb55-183"><a href="annex-i-compendium-of-r-scripts.html#cb55-183" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate to the same soatial definition</span></span>
<span id="cb55-184"><a href="annex-i-compendium-of-r-scripts.html#cb55-184" aria-hidden="true" tabindex="-1"></a>     <span class="co"># dist2access &lt;- aggregate(dist2access, fact=10, fun=&quot;mean&quot;)</span></span>
<span id="cb55-185"><a href="annex-i-compendium-of-r-scripts.html#cb55-185" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(dist2access)</span>
<span id="cb55-186"><a href="annex-i-compendium-of-r-scripts.html#cb55-186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(nghe, <span class="at">col=</span><span class="st">&quot;transparent&quot;</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-187"><a href="annex-i-compendium-of-r-scripts.html#cb55-187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-188"><a href="annex-i-compendium-of-r-scripts.html#cb55-188" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add cost surface as raster layer</span></span>
<span id="cb55-189"><a href="annex-i-compendium-of-r-scripts.html#cb55-189" aria-hidden="true" tabindex="-1"></a>    cov.dat.ras <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">addLayer</span>(cov.dat.ras,raster<span class="sc">::</span><span class="fu">raster</span>(dist2access))</span>
<span id="cb55-190"><a href="annex-i-compendium-of-r-scripts.html#cb55-190" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(cov.dat.ras)</span>
<span id="cb55-191"><a href="annex-i-compendium-of-r-scripts.html#cb55-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-192"><a href="annex-i-compendium-of-r-scripts.html#cb55-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Harmonize NAs</span></span>
<span id="cb55-193"><a href="annex-i-compendium-of-r-scripts.html#cb55-193" aria-hidden="true" tabindex="-1"></a>    cov.dat.ras<span class="sc">$</span>dist2access <span class="ot">&lt;-</span> cov.dat.ras<span class="sc">$</span>dist2access <span class="sc">*</span> cov.dat.ras[[<span class="dv">1</span>]]<span class="sc">/</span>cov.dat.ras[[<span class="dv">1</span>]]</span>
<span id="cb55-194"><a href="annex-i-compendium-of-r-scripts.html#cb55-194" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat.ras<span class="sc">$</span>dist2access)</span>
<span id="cb55-195"><a href="annex-i-compendium-of-r-scripts.html#cb55-195" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(nghe, <span class="at">col=</span><span class="st">&quot;transparent&quot;</span>,<span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-196"><a href="annex-i-compendium-of-r-scripts.html#cb55-196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-197"><a href="annex-i-compendium-of-r-scripts.html#cb55-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points</span></span>
<span id="cb55-198"><a href="annex-i-compendium-of-r-scripts.html#cb55-198" aria-hidden="true" tabindex="-1"></a>    cost.clhs <span class="ot">&lt;-</span> <span class="fu">clhs</span>(cov.dat.ras, <span class="at">size =</span> minimum_n, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>, <span class="at">cost =</span> <span class="st">&#39;dist2access&#39;</span>,  <span class="at">use.cpp =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-199"><a href="annex-i-compendium-of-r-scripts.html#cb55-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cost.clhs, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb55-200"><a href="annex-i-compendium-of-r-scripts.html#cb55-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get and plot the point of samples</span></span>
<span id="cb55-201"><a href="annex-i-compendium-of-r-scripts.html#cb55-201" aria-hidden="true" tabindex="-1"></a>    points <span class="ot">&lt;-</span> cost.clhs<span class="sc">$</span>sampled_data  <span class="co"># Get point coordinates of clhs sampling</span></span>
<span id="cb55-202"><a href="annex-i-compendium-of-r-scripts.html#cb55-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat.ras[[<span class="st">&#39;dist2access&#39;</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples with &#39;cost&#39; constraints&quot;</span>)</span>
<span id="cb55-203"><a href="annex-i-compendium-of-r-scripts.html#cb55-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(points, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">cex=</span><span class="dv">1</span>)</span>
<span id="cb55-204"><a href="annex-i-compendium-of-r-scripts.html#cb55-204" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-205"><a href="annex-i-compendium-of-r-scripts.html#cb55-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-206"><a href="annex-i-compendium-of-r-scripts.html#cb55-206" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Replacement areas in cLHS design  </span></span>
<span id="cb55-207"><a href="annex-i-compendium-of-r-scripts.html#cb55-207" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-208"><a href="annex-i-compendium-of-r-scripts.html#cb55-208" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the similarity to points in a buffer of distance &#39;D&#39;</span></span>
<span id="cb55-209"><a href="annex-i-compendium-of-r-scripts.html#cb55-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the buffers around points # cov25??</span></span>
<span id="cb55-210"><a href="annex-i-compendium-of-r-scripts.html#cb55-210" aria-hidden="true" tabindex="-1"></a>    gw <span class="ot">&lt;-</span> <span class="fu">similarity_buffer</span>(cov.dat.ras, cost.clhs<span class="sc">$</span>sampled_data, <span class="at">buffer =</span> D)</span>
<span id="cb55-211"><a href="annex-i-compendium-of-r-scripts.html#cb55-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-212"><a href="annex-i-compendium-of-r-scripts.html#cb55-212" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb55-213"><a href="annex-i-compendium-of-r-scripts.html#cb55-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(elevation, <span class="at">legend=</span><span class="cn">TRUE</span>,<span class="at">main=</span><span class="fu">paste</span>(<span class="st">&quot;Similarity probability over elevation&quot;</span>))</span>
<span id="cb55-214"><a href="annex-i-compendium-of-r-scripts.html#cb55-214" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Overlay points</span></span>
<span id="cb55-215"><a href="annex-i-compendium-of-r-scripts.html#cb55-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(cost.clhs<span class="sc">$</span>sampled_data[<span class="dv">1</span>], <span class="at">col =</span> <span class="st">&quot;dodgerblue&quot;</span>, <span class="at">pch =</span> <span class="dv">3</span>)</span>
<span id="cb55-216"><a href="annex-i-compendium-of-r-scripts.html#cb55-216" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Overlay probability stack for point 1</span></span>
<span id="cb55-217"><a href="annex-i-compendium-of-r-scripts.html#cb55-217" aria-hidden="true" tabindex="-1"></a>    colors <span class="ot">&lt;-</span> <span class="fu">c</span>((RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">9</span>, <span class="st">&quot;YlOrRd&quot;</span>)))</span>
<span id="cb55-218"><a href="annex-i-compendium-of-r-scripts.html#cb55-218" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">plot</span>(gw[[<span class="dv">1</span>]], <span class="at">add=</span><span class="cn">TRUE</span> ,  <span class="at">legend=</span><span class="cn">FALSE</span>, <span class="at">col=</span>colors)</span>
<span id="cb55-219"><a href="annex-i-compendium-of-r-scripts.html#cb55-219" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Overlay 1st cLHS point</span></span>
<span id="cb55-220"><a href="annex-i-compendium-of-r-scripts.html#cb55-220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(cost.clhs<span class="sc">$</span>sampled_data[<span class="dv">1</span>,<span class="dv">1</span>], <span class="at">col =</span> <span class="st">&quot;black&quot;</span>, <span class="at">pch =</span> <span class="dv">3</span>,<span class="at">cex=</span><span class="dv">1</span>)</span>
<span id="cb55-221"><a href="annex-i-compendium-of-r-scripts.html#cb55-221" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-222"><a href="annex-i-compendium-of-r-scripts.html#cb55-222" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Polygonize replacement areas by similarity    </span></span>
<span id="cb55-223"><a href="annex-i-compendium-of-r-scripts.html#cb55-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-224"><a href="annex-i-compendium-of-r-scripts.html#cb55-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine a threshold break to delineate replacement areas</span></span>
<span id="cb55-225"><a href="annex-i-compendium-of-r-scripts.html#cb55-225" aria-hidden="true" tabindex="-1"></a>    similarity_threshold <span class="ot">&lt;-</span> <span class="fl">0.90</span></span>
<span id="cb55-226"><a href="annex-i-compendium-of-r-scripts.html#cb55-226" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reclassify buffer raster data according to the threshold break of probability</span></span>
<span id="cb55-227"><a href="annex-i-compendium-of-r-scripts.html#cb55-227" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1 = similarity &gt;= similarity_break; NA =  similarity &lt;  similarity_break</span></span>
<span id="cb55-228"><a href="annex-i-compendium-of-r-scripts.html#cb55-228" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a vector with the break intervals and the output values (NA,1) </span></span>
<span id="cb55-229"><a href="annex-i-compendium-of-r-scripts.html#cb55-229" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, similarity_threshold, <span class="cn">NA</span>, similarity_threshold, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb55-230"><a href="annex-i-compendium-of-r-scripts.html#cb55-230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to a matrix</span></span>
<span id="cb55-231"><a href="annex-i-compendium-of-r-scripts.html#cb55-231" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">matrix</span>(breaks, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-232"><a href="annex-i-compendium-of-r-scripts.html#cb55-232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reclassify the data in the layers from probabilities to (NA,)</span></span>
<span id="cb55-233"><a href="annex-i-compendium-of-r-scripts.html#cb55-233" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">=</span> <span class="fu">stack</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>raster<span class="sc">::</span><span class="fu">nlayers</span>(gw), <span class="cf">function</span>(i){raster<span class="sc">::</span><span class="fu">reclassify</span>(gw[[i]], breaks, <span class="at">right=</span><span class="cn">FALSE</span>)}))</span>
<span id="cb55-234"><a href="annex-i-compendium-of-r-scripts.html#cb55-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-235"><a href="annex-i-compendium-of-r-scripts.html#cb55-235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Polygonize replacement areas </span></span>
<span id="cb55-236"><a href="annex-i-compendium-of-r-scripts.html#cb55-236" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">as.list</span>(s), rasterToPolygons, <span class="at">dissolve=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-237"><a href="annex-i-compendium-of-r-scripts.html#cb55-237" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">bind</span>(s,<span class="at">keepnames=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-238"><a href="annex-i-compendium-of-r-scripts.html#cb55-238" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the identifier of the corresponding target point</span></span>
<span id="cb55-239"><a href="annex-i-compendium-of-r-scripts.html#cb55-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(s)){</span>
<span id="cb55-240"><a href="annex-i-compendium-of-r-scripts.html#cb55-240" aria-hidden="true" tabindex="-1"></a>      s<span class="sc">@</span>data<span class="sc">$</span>ID[i] <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(stringr<span class="sc">::</span><span class="fu">str_replace</span>(s<span class="sc">@</span>polygons[[i]]<span class="sc">@</span>ID,<span class="st">&quot;1.&quot;</span>,<span class="st">&quot;&quot;</span>))</span>
<span id="cb55-241"><a href="annex-i-compendium-of-r-scripts.html#cb55-241" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb55-242"><a href="annex-i-compendium-of-r-scripts.html#cb55-242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean the data by storing target ID data only</span></span>
<span id="cb55-243"><a href="annex-i-compendium-of-r-scripts.html#cb55-243" aria-hidden="true" tabindex="-1"></a>    s<span class="sc">@</span>data <span class="ot">&lt;-</span> s<span class="sc">@</span>data[<span class="st">&quot;ID&quot;</span>]</span>
<span id="cb55-244"><a href="annex-i-compendium-of-r-scripts.html#cb55-244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-245"><a href="annex-i-compendium-of-r-scripts.html#cb55-245" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb55-246"><a href="annex-i-compendium-of-r-scripts.html#cb55-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="fu">paste</span>(<span class="st">&quot;cLHS samples and replacement areas for threshold = &quot;</span>, similarity_threshold))</span>
<span id="cb55-247"><a href="annex-i-compendium-of-r-scripts.html#cb55-247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(s,<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="cn">NA</span>, <span class="at">border=</span><span class="st">&quot;gray40&quot;</span>)</span>
<span id="cb55-248"><a href="annex-i-compendium-of-r-scripts.html#cb55-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(cost.clhs<span class="sc">$</span>sampled_data, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">3</span>)</span>
<span id="cb55-249"><a href="annex-i-compendium-of-r-scripts.html#cb55-249" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-250"><a href="annex-i-compendium-of-r-scripts.html#cb55-250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Export replacement areas to shapefile </span></span>
<span id="cb55-251"><a href="annex-i-compendium-of-r-scripts.html#cb55-251" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(s)</span>
<span id="cb55-252"><a href="annex-i-compendium-of-r-scripts.html#cb55-252" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(s, <span class="fu">file.path</span>(<span class="fu">paste0</span>(results.path,<span class="st">&#39;replacement_areas_&#39;</span>, D, <span class="st">&#39;.shp&#39;</span>)), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-253"><a href="annex-i-compendium-of-r-scripts.html#cb55-253" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-254"><a href="annex-i-compendium-of-r-scripts.html#cb55-254" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write cLHS sampling points to shapefile</span></span>
<span id="cb55-255"><a href="annex-i-compendium-of-r-scripts.html#cb55-255" aria-hidden="true" tabindex="-1"></a>    cost.clhs<span class="sc">$</span>sampled_data<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="fu">row</span>(cost.clhs<span class="sc">$</span>sampled_data)[,<span class="dv">1</span>] <span class="co"># Add identifier</span></span>
<span id="cb55-256"><a href="annex-i-compendium-of-r-scripts.html#cb55-256" aria-hidden="true" tabindex="-1"></a>    out.pts <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(cost.clhs<span class="sc">$</span>sampled_data)</span>
<span id="cb55-257"><a href="annex-i-compendium-of-r-scripts.html#cb55-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(out.pts, <span class="fu">paste0</span>(results.path,<span class="st">&#39;target_clhs.shp&#39;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-258"><a href="annex-i-compendium-of-r-scripts.html#cb55-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-259"><a href="annex-i-compendium-of-r-scripts.html#cb55-259" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb55-260"><a href="annex-i-compendium-of-r-scripts.html#cb55-260" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Constrained cLHS sampling taking into account accessibility and legacy data  </span></span>
<span id="cb55-261"><a href="annex-i-compendium-of-r-scripts.html#cb55-261" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load legacy data </span></span>
<span id="cb55-262"><a href="annex-i-compendium-of-r-scripts.html#cb55-262" aria-hidden="true" tabindex="-1"></a>    legacy <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/legacy_soils.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-263"><a href="annex-i-compendium-of-r-scripts.html#cb55-263" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-264"><a href="annex-i-compendium-of-r-scripts.html#cb55-264" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate distance to roads and delete NA in outputs</span></span>
<span id="cb55-265"><a href="annex-i-compendium-of-r-scripts.html#cb55-265" aria-hidden="true" tabindex="-1"></a>    cost <span class="ot">&lt;-</span> cov.dat </span>
<span id="cb55-266"><a href="annex-i-compendium-of-r-scripts.html#cb55-266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add distance to roads co the stack</span></span>
<span id="cb55-267"><a href="annex-i-compendium-of-r-scripts.html#cb55-267" aria-hidden="true" tabindex="-1"></a>    cost <span class="ot">&lt;-</span> <span class="fu">c</span>(cost, <span class="fu">rast</span>(cov.dat.ras<span class="sc">$</span>dist2access))</span>
<span id="cb55-268"><a href="annex-i-compendium-of-r-scripts.html#cb55-268" aria-hidden="true" tabindex="-1"></a>    cost<span class="sc">$</span>slope <span class="ot">&lt;-</span> slope</span>
<span id="cb55-269"><a href="annex-i-compendium-of-r-scripts.html#cb55-269" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate clhs points with legacy, cost and buffer to roads</span></span>
<span id="cb55-270"><a href="annex-i-compendium-of-r-scripts.html#cb55-270" aria-hidden="true" tabindex="-1"></a>    buff_inner<span class="ot">=</span><span class="dv">20</span>;</span>
<span id="cb55-271"><a href="annex-i-compendium-of-r-scripts.html#cb55-271" aria-hidden="true" tabindex="-1"></a>    buff_outer<span class="ot">=</span><span class="dv">3000</span></span>
<span id="cb55-272"><a href="annex-i-compendium-of-r-scripts.html#cb55-272" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert roads to sf object and cast to multilinestring</span></span>
<span id="cb55-273"><a href="annex-i-compendium-of-r-scripts.html#cb55-273" aria-hidden="true" tabindex="-1"></a>    roads2 <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(roads) <span class="sc">%&gt;%</span></span>
<span id="cb55-274"><a href="annex-i-compendium-of-r-scripts.html#cb55-274" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_cast</span>(<span class="st">&quot;MULTILINESTRING&quot;</span>) </span>
<span id="cb55-275"><a href="annex-i-compendium-of-r-scripts.html#cb55-275" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-276"><a href="annex-i-compendium-of-r-scripts.html#cb55-276" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate clhs samples using slope as cost surface, distance to roads as</span></span>
<span id="cb55-277"><a href="annex-i-compendium-of-r-scripts.html#cb55-277" aria-hidden="true" tabindex="-1"></a>    <span class="co"># access limitations, and including existing legacy data</span></span>
<span id="cb55-278"><a href="annex-i-compendium-of-r-scripts.html#cb55-278" aria-hidden="true" tabindex="-1"></a>    aa <span class="ot">&lt;-</span> sgsR<span class="sc">::</span><span class="fu">sample_clhs</span>(<span class="at">mraster =</span> cost, <span class="at">nSamp =</span> minimum_n, <span class="at">existing =</span> legacy,</span>
<span id="cb55-279"><a href="annex-i-compendium-of-r-scripts.html#cb55-279" aria-hidden="true" tabindex="-1"></a>                            <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">details =</span> <span class="cn">TRUE</span>, <span class="at">cost=</span><span class="st">&quot;slope&quot;</span>, <span class="at">access=</span>roads2,</span>
<span id="cb55-280"><a href="annex-i-compendium-of-r-scripts.html#cb55-280" aria-hidden="true" tabindex="-1"></a>                            <span class="at">buff_inner=</span>buff_inner, <span class="at">buff_outer=</span>buff_outer)</span>
<span id="cb55-281"><a href="annex-i-compendium-of-r-scripts.html#cb55-281" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-282"><a href="annex-i-compendium-of-r-scripts.html#cb55-282" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Plot distances, roads, clhs points and legacy data </span></span>
<span id="cb55-283"><a href="annex-i-compendium-of-r-scripts.html#cb55-283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cost<span class="sc">$</span>dist2access)</span>
<span id="cb55-284"><a href="annex-i-compendium-of-r-scripts.html#cb55-284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(roads,<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">&quot;black&quot;</span>)</span>
<span id="cb55-285"><a href="annex-i-compendium-of-r-scripts.html#cb55-285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(aa<span class="sc">$</span>samples[aa<span class="sc">$</span>samples<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;new&quot;</span>,], <span class="at">col=</span> <span class="st">&quot;tomato&quot;</span>,<span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb55-286"><a href="annex-i-compendium-of-r-scripts.html#cb55-286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(aa<span class="sc">$</span>samples[aa<span class="sc">$</span>samples<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;existing&quot;</span>,], <span class="at">col=</span> <span class="st">&quot;gray40&quot;</span>, <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">pch =</span> <span class="dv">5</span>, <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb55-287"><a href="annex-i-compendium-of-r-scripts.html#cb55-287" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-288"><a href="annex-i-compendium-of-r-scripts.html#cb55-288" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write samples as shapefile</span></span>
<span id="cb55-289"><a href="annex-i-compendium-of-r-scripts.html#cb55-289" aria-hidden="true" tabindex="-1"></a>    aa<span class="sc">$</span>samples[<span class="fu">c</span>(<span class="st">&quot;type&quot;</span>,<span class="st">&quot;dist2access&quot;</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb55-290"><a href="annex-i-compendium-of-r-scripts.html#cb55-290" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(<span class="fu">paste0</span>(results.path,<span class="st">&#39;const_clhs.shp&#39;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="conditioned-latin-hypercube-sampling.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/luislado/Sampling_Design_GSP/edit/master/11-Compendium-of-code.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Technical Manual Soil Sampling Design.pdf", "Technical Manual Soil Sampling Design.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "static"
}
});
});
</script>

</body>

</html>
