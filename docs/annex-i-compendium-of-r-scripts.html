<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Annex I: Compendium of R scripts |  Soil Sampling Design</title>
  <meta name="description" content="Soil Sampling Design - SoilFer Project" />
  <meta name="generator" content="bookdown 0.36 and GitBook 2.6.7" />

  <meta property="og:title" content="Annex I: Compendium of R scripts |  Soil Sampling Design" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/images/frontcover.png" />
  <meta property="og:description" content="Soil Sampling Design - SoilFer Project" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Annex I: Compendium of R scripts |  Soil Sampling Design" />
  
  <meta name="twitter:description" content="Soil Sampling Design - SoilFer Project" />
  <meta name="twitter:image" content="/images/frontcover.png" />

<meta name="author" content="Rodríguez Lado, L., Angelini, M.E, Naypewe, N., Luotto, I., Yigini, Y." />


<meta name="date" content="2024-01-04" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="conditioned-latin-hypercube-sampling.html"/>
<link rel="next" href="references.html"/>
<script src="assets/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="assets/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="assets/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="assets/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="assets/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="assets/plotly-binding-4.10.0/plotly.js"></script>
<script src="assets/typedarray-0.1/typedarray.min.js"></script>
<link href="assets/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="assets/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="assets/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="assets/plotly-main-2.5.1/plotly-latest.min.js"></script>
<link href="assets/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="assets/leaflet-1.3.1/leaflet.js"></script>
<link href="assets/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="assets/proj4-2.6.2/proj4.min.js"></script>
<script src="assets/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="assets/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="assets/leaflet-binding-2.1.1/leaflet.js"></script>
<link href="assets/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="assets/HomeButton-0.0.1/home-button.js"></script>
<script src="assets/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="assets/clipboard-0.0.1/setClipboardText.js"></script>
<link href="assets/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="assets/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="assets/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="assets/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil Samping Design</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#training-material"><i class="fa fa-check"></i><b>1.1</b> Training material</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html"><i class="fa fa-check"></i><b>2</b> Setting-up the software environment</a>
<ul>
<li class="chapter" data-level="2.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#use-of-r-rstudio-and-r-packages"><i class="fa fa-check"></i><b>2.1</b> Use of R, RStudio and R Packages</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-r"><i class="fa fa-check"></i><b>2.1.1</b> Obtaining and installing R</a></li>
<li class="chapter" data-level="2.1.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-rstudio"><i class="fa fa-check"></i><b>2.1.2</b> Obtaining and installing RStudio</a></li>
<li class="chapter" data-level="2.1.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#getting-started-with-r"><i class="fa fa-check"></i><b>2.1.3</b> Getting started with R</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-packages"><i class="fa fa-check"></i><b>2.2</b> R packages</a></li>
<li class="chapter" data-level="2.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#gee---google-earth-engine"><i class="fa fa-check"></i><b>2.3</b> GEE - google earth engine</a></li>
</ul></li>
<li class="part"><span><b>Part one – Soil Legacy Data</b></span></li>
<li class="chapter" data-level="3" data-path="legacy_data.html"><a href="legacy_data.html"><i class="fa fa-check"></i><b>3</b> Evaluating Soil Legacy Data Sampling for DSM</a>
<ul>
<li class="chapter" data-level="3.1" data-path="legacy_data.html"><a href="legacy_data.html#data-preparation"><i class="fa fa-check"></i><b>3.1</b> Data Preparation</a></li>
<li class="chapter" data-level="3.2" data-path="legacy_data.html"><a href="legacy_data.html#representativeness-of-the-legacy-soil-data"><i class="fa fa-check"></i><b>3.2</b> Representativeness of the Legacy Soil Data</a></li>
</ul></li>
<li class="part"><span><b>I Part two – Soil Sampling Design</b></span></li>
<li class="chapter" data-level="4" data-path="determining-the-minimum-sampling-size.html"><a href="determining-the-minimum-sampling-size.html"><i class="fa fa-check"></i><b>4</b> Determining the minimum sampling size</a></li>
<li class="chapter" data-level="5" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html"><i class="fa fa-check"></i><b>5</b> Stratified Sampling Design</a>
<ul>
<li class="chapter" data-level="5.1" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#general-procedure"><i class="fa fa-check"></i><b>5.1</b> General Procedure</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#strata-creation"><i class="fa fa-check"></i><b>5.1.1</b> Strata creation</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#stratified-random-sampling"><i class="fa fa-check"></i><b>5.2</b> Stratified random sampling</a></li>
<li class="chapter" data-level="5.3" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#stratified-random-sampling-for-large-areas"><i class="fa fa-check"></i><b>5.3</b> Stratified random sampling for large areas</a></li>
<li class="chapter" data-level="5.4" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#stratified-regular-sampling"><i class="fa fa-check"></i><b>5.4</b> Stratified regular sampling</a></li>
<li class="chapter" data-level="5.5" data-path="stratified-sampling-design.html"><a href="stratified-sampling-design.html#random-sampling-based-on-a-stratified-raster"><i class="fa fa-check"></i><b>5.5</b> Random Sampling based on a stratified raster</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html"><i class="fa fa-check"></i><b>6</b> Conditioned Latin Hypercube Sampling</a>
<ul>
<li class="chapter" data-level="6.1" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#clhs-design"><i class="fa fa-check"></i><b>6.1</b> cLHS Design</a></li>
<li class="chapter" data-level="6.2" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#including-existing-legacy-data-in-a-clhs-sampling-design"><i class="fa fa-check"></i><b>6.2</b> Including existing legacy data in a cLHS sampling design</a></li>
<li class="chapter" data-level="6.3" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#working-with-large-raster-data"><i class="fa fa-check"></i><b>6.3</b> Working with large raster data</a></li>
<li class="chapter" data-level="6.4" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#implementation-of-costconstrained-clhs-sampling"><i class="fa fa-check"></i><b>6.4</b> Implementation of cost–constrained cLHS sampling</a></li>
<li class="chapter" data-level="6.5" data-path="conditioned-latin-hypercube-sampling.html"><a href="conditioned-latin-hypercube-sampling.html#replacement-areas-in-clhs-design"><i class="fa fa-check"></i><b>6.5</b> Replacement areas in cLHS design</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html"><i class="fa fa-check"></i>Annex I: Compendium of R scripts</a>
<ul>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-1-introduction-to-r"><i class="fa fa-check"></i>Script 1: Introduction to R</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-2-download-environmental-covariates"><i class="fa fa-check"></i>Script 2: Download environmental covariates</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-3-evaluate-legacy-data"><i class="fa fa-check"></i>Script 3: Evaluate Legacy Data</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-4-calculate-minimum-sample-size"><i class="fa fa-check"></i>Script 4: Calculate Minimum Sample Size</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-5-stratified-sampling-on-vector-and-raster-data"><i class="fa fa-check"></i>Script 5: Stratified sampling on vector and raster data</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-6-conditional-latin-hypercube-sampling"><i class="fa fa-check"></i>Script 6: Conditional Latin Hypercube Sampling</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://www.fao.org/global-soil-partnership/" target="blank">Global Soil Partnership</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p><img src="images/frontcover.jpg" style="top:0px;height:150px;" align="right" />
Soil Sampling Design</p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="annex-i-compendium-of-r-scripts" class="section level1 unnumbered hasAnchor">
<h1>Annex I: Compendium of R scripts<a href="annex-i-compendium-of-r-scripts.html#annex-i-compendium-of-r-scripts" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter compiles the complete list of R scripts involved in the process of soil sampling design.</p>
<div id="script-1-introduction-to-r" class="section level2 unnumbered hasAnchor">
<h2>Script 1: Introduction to R<a href="annex-i-compendium-of-r-scripts.html#script-1-introduction-to-r" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="annex-i-compendium-of-r-scripts.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduction to R</span></span>
<span id="cb62-2"><a href="annex-i-compendium-of-r-scripts.html#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="annex-i-compendium-of-r-scripts.html#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 0. Playground =================================================</span></span>
<span id="cb62-4"><a href="annex-i-compendium-of-r-scripts.html#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="annex-i-compendium-of-r-scripts.html#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co"># learn important keyboard shortcuts</span></span>
<span id="cb62-6"><a href="annex-i-compendium-of-r-scripts.html#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ctrl + enter for running code</span></span>
<span id="cb62-7"><a href="annex-i-compendium-of-r-scripts.html#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co"># tab after writing the first three </span></span>
<span id="cb62-8"><a href="annex-i-compendium-of-r-scripts.html#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co"># characters of the function name</span></span>
<span id="cb62-9"><a href="annex-i-compendium-of-r-scripts.html#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="co"># F1 to access the help</span></span>
<span id="cb62-10"><a href="annex-i-compendium-of-r-scripts.html#cb62-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-11"><a href="annex-i-compendium-of-r-scripts.html#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="co"># explore the use of &lt;-, $, [], ==, !=, c(), :, </span></span>
<span id="cb62-12"><a href="annex-i-compendium-of-r-scripts.html#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="co"># data.frame(), list(), as.factor()</span></span>
<span id="cb62-13"><a href="annex-i-compendium-of-r-scripts.html#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="annex-i-compendium-of-r-scripts.html#cb62-14" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">15</span></span>
<span id="cb62-15"><a href="annex-i-compendium-of-r-scripts.html#cb62-15" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">2</span>]</span>
<span id="cb62-16"><a href="annex-i-compendium-of-r-scripts.html#cb62-16" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb62-17"><a href="annex-i-compendium-of-r-scripts.html#cb62-17" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;a&quot;</span>, a )</span>
<span id="cb62-18"><a href="annex-i-compendium-of-r-scripts.html#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(b)</span>
<span id="cb62-19"><a href="annex-i-compendium-of-r-scripts.html#cb62-19" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">column_a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="at">column_b =</span> b)</span>
<span id="cb62-20"><a href="annex-i-compendium-of-r-scripts.html#cb62-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-21"><a href="annex-i-compendium-of-r-scripts.html#cb62-21" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">1</span>]</span>
<span id="cb62-22"><a href="annex-i-compendium-of-r-scripts.html#cb62-22" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>column_b</span>
<span id="cb62-23"><a href="annex-i-compendium-of-r-scripts.html#cb62-23" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(df<span class="sc">$</span>column_b)</span>
<span id="cb62-24"><a href="annex-i-compendium-of-r-scripts.html#cb62-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df)</span>
<span id="cb62-25"><a href="annex-i-compendium-of-r-scripts.html#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="annex-i-compendium-of-r-scripts.html#cb62-26" aria-hidden="true" tabindex="-1"></a>df[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,]</span>
<span id="cb62-27"><a href="annex-i-compendium-of-r-scripts.html#cb62-27" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">1</span>]</span>
<span id="cb62-28"><a href="annex-i-compendium-of-r-scripts.html#cb62-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-29"><a href="annex-i-compendium-of-r-scripts.html#cb62-29" aria-hidden="true" tabindex="-1"></a><span class="fu">as.factor</span>(b)</span>
<span id="cb62-30"><a href="annex-i-compendium-of-r-scripts.html#cb62-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-31"><a href="annex-i-compendium-of-r-scripts.html#cb62-31" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">list</span>(a, b, df)</span>
<span id="cb62-32"><a href="annex-i-compendium-of-r-scripts.html#cb62-32" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb62-33"><a href="annex-i-compendium-of-r-scripts.html#cb62-33" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d)</span>
<span id="cb62-34"><a href="annex-i-compendium-of-r-scripts.html#cb62-34" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;numeric_vector&quot;</span>, <span class="st">&quot;character_vector&quot;</span>, <span class="st">&quot;dataframe&quot;</span>)</span>
<span id="cb62-35"><a href="annex-i-compendium-of-r-scripts.html#cb62-35" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb62-36"><a href="annex-i-compendium-of-r-scripts.html#cb62-36" aria-hidden="true" tabindex="-1"></a>d[[<span class="dv">1</span>]]</span>
<span id="cb62-37"><a href="annex-i-compendium-of-r-scripts.html#cb62-37" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>numeric_vector</span>
<span id="cb62-38"><a href="annex-i-compendium-of-r-scripts.html#cb62-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-39"><a href="annex-i-compendium-of-r-scripts.html#cb62-39" aria-hidden="true" tabindex="-1"></a>a <span class="sc">==</span> b</span>
<span id="cb62-40"><a href="annex-i-compendium-of-r-scripts.html#cb62-40" aria-hidden="true" tabindex="-1"></a>a <span class="sc">!=</span> b</span>
<span id="cb62-41"><a href="annex-i-compendium-of-r-scripts.html#cb62-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-42"><a href="annex-i-compendium-of-r-scripts.html#cb62-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Set working directory ======================================</span></span>
<span id="cb62-43"><a href="annex-i-compendium-of-r-scripts.html#cb62-43" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;C:/GIT/Digital-Soil-Mapping/&quot;</span>)</span>
<span id="cb62-44"><a href="annex-i-compendium-of-r-scripts.html#cb62-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-45"><a href="annex-i-compendium-of-r-scripts.html#cb62-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Install and load packages ==================================</span></span>
<span id="cb62-46"><a href="annex-i-compendium-of-r-scripts.html#cb62-46" aria-hidden="true" tabindex="-1"></a><span class="co"># readxl, tidyverse, and data.table packages using the functions</span></span>
<span id="cb62-47"><a href="annex-i-compendium-of-r-scripts.html#cb62-47" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb62-48"><a href="annex-i-compendium-of-r-scripts.html#cb62-48" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb62-49"><a href="annex-i-compendium-of-r-scripts.html#cb62-49" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;data.table&quot;</span>)</span>
<span id="cb62-50"><a href="annex-i-compendium-of-r-scripts.html#cb62-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb62-51"><a href="annex-i-compendium-of-r-scripts.html#cb62-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb62-52"><a href="annex-i-compendium-of-r-scripts.html#cb62-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb62-53"><a href="annex-i-compendium-of-r-scripts.html#cb62-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-54"><a href="annex-i-compendium-of-r-scripts.html#cb62-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Import an spreadsheet ======================================</span></span>
<span id="cb62-55"><a href="annex-i-compendium-of-r-scripts.html#cb62-55" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.1 Read the MS Excel file -----------------------------------</span></span>
<span id="cb62-56"><a href="annex-i-compendium-of-r-scripts.html#cb62-56" aria-hidden="true" tabindex="-1"></a><span class="co">#Read the soil_data.xlsx file, spreadsheet 2, using read_excel </span></span>
<span id="cb62-57"><a href="annex-i-compendium-of-r-scripts.html#cb62-57" aria-hidden="true" tabindex="-1"></a><span class="fu">read_excel</span>(<span class="at">path =</span> <span class="st">&quot;01-Data/soil_data.xlsx&quot;</span>, <span class="at">sheet =</span> <span class="dv">2</span>)</span>
<span id="cb62-58"><a href="annex-i-compendium-of-r-scripts.html#cb62-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-59"><a href="annex-i-compendium-of-r-scripts.html#cb62-59" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.2 Read the csv file with the native function ---------------</span></span>
<span id="cb62-60"><a href="annex-i-compendium-of-r-scripts.html#cb62-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 01-Data/horizon.csv</span></span>
<span id="cb62-61"><a href="annex-i-compendium-of-r-scripts.html#cb62-61" aria-hidden="true" tabindex="-1"></a><span class="fu">read.csv</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb62-62"><a href="annex-i-compendium-of-r-scripts.html#cb62-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-63"><a href="annex-i-compendium-of-r-scripts.html#cb62-63" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.3 Read the csv file with the tidyverse function ------------</span></span>
<span id="cb62-64"><a href="annex-i-compendium-of-r-scripts.html#cb62-64" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb62-65"><a href="annex-i-compendium-of-r-scripts.html#cb62-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-66"><a href="annex-i-compendium-of-r-scripts.html#cb62-66" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.4 Read the csv file with the data.table function -----------</span></span>
<span id="cb62-67"><a href="annex-i-compendium-of-r-scripts.html#cb62-67" aria-hidden="true" tabindex="-1"></a><span class="fu">fread</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb62-68"><a href="annex-i-compendium-of-r-scripts.html#cb62-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-69"><a href="annex-i-compendium-of-r-scripts.html#cb62-69" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.5 Assign the dataframe to an object called dat -------------</span></span>
<span id="cb62-70"><a href="annex-i-compendium-of-r-scripts.html#cb62-70" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb62-71"><a href="annex-i-compendium-of-r-scripts.html#cb62-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-72"><a href="annex-i-compendium-of-r-scripts.html#cb62-72" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Tidyverse functions ========================================</span></span>
<span id="cb62-73"><a href="annex-i-compendium-of-r-scripts.html#cb62-73" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.1 Select pid, hip, top, bottom, ph_h2o, cec from dat -------</span></span>
<span id="cb62-74"><a href="annex-i-compendium-of-r-scripts.html#cb62-74" aria-hidden="true" tabindex="-1"></a>dat_1 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb62-75"><a href="annex-i-compendium-of-r-scripts.html#cb62-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id_prof, id_hor, top, bottom, ph_h2o, cec)</span>
<span id="cb62-76"><a href="annex-i-compendium-of-r-scripts.html#cb62-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-77"><a href="annex-i-compendium-of-r-scripts.html#cb62-77" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.2 Filter: pick observations by their values ----------------</span></span>
<span id="cb62-78"><a href="annex-i-compendium-of-r-scripts.html#cb62-78" aria-hidden="true" tabindex="-1"></a><span class="co"># filter observations with cec &gt; 50 cmolc/100g</span></span>
<span id="cb62-79"><a href="annex-i-compendium-of-r-scripts.html#cb62-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-80"><a href="annex-i-compendium-of-r-scripts.html#cb62-80" aria-hidden="true" tabindex="-1"></a>dat_2 <span class="ot">&lt;-</span> dat_1 <span class="sc">%&gt;%</span> </span>
<span id="cb62-81"><a href="annex-i-compendium-of-r-scripts.html#cb62-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(cec <span class="sc">&gt;</span> <span class="dv">30</span>)</span>
<span id="cb62-82"><a href="annex-i-compendium-of-r-scripts.html#cb62-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-83"><a href="annex-i-compendium-of-r-scripts.html#cb62-83" aria-hidden="true" tabindex="-1"></a>dat_2</span>
<span id="cb62-84"><a href="annex-i-compendium-of-r-scripts.html#cb62-84" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.3 Mutate: create a new variable ----------------------------</span></span>
<span id="cb62-85"><a href="annex-i-compendium-of-r-scripts.html#cb62-85" aria-hidden="true" tabindex="-1"></a><span class="co"># thickness = top - bottom</span></span>
<span id="cb62-86"><a href="annex-i-compendium-of-r-scripts.html#cb62-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-87"><a href="annex-i-compendium-of-r-scripts.html#cb62-87" aria-hidden="true" tabindex="-1"></a>dat_3 <span class="ot">&lt;-</span> dat_2 <span class="sc">%&gt;%</span> </span>
<span id="cb62-88"><a href="annex-i-compendium-of-r-scripts.html#cb62-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">thickness =</span> bottom <span class="sc">-</span> top)</span>
<span id="cb62-89"><a href="annex-i-compendium-of-r-scripts.html#cb62-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-90"><a href="annex-i-compendium-of-r-scripts.html#cb62-90" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.4 Group_by and summarise -----------------------------------</span></span>
<span id="cb62-91"><a href="annex-i-compendium-of-r-scripts.html#cb62-91" aria-hidden="true" tabindex="-1"></a><span class="co"># group by variable pid</span></span>
<span id="cb62-92"><a href="annex-i-compendium-of-r-scripts.html#cb62-92" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise taking the mean of pH and cec</span></span>
<span id="cb62-93"><a href="annex-i-compendium-of-r-scripts.html#cb62-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-94"><a href="annex-i-compendium-of-r-scripts.html#cb62-94" aria-hidden="true" tabindex="-1"></a>dat_4 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb62-95"><a href="annex-i-compendium-of-r-scripts.html#cb62-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_prof) <span class="sc">%&gt;%</span> </span>
<span id="cb62-96"><a href="annex-i-compendium-of-r-scripts.html#cb62-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_ph =</span> <span class="fu">mean</span>(ph_h2o),</span>
<span id="cb62-97"><a href="annex-i-compendium-of-r-scripts.html#cb62-97" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_cec =</span> <span class="fu">mean</span>(cec))</span>
<span id="cb62-98"><a href="annex-i-compendium-of-r-scripts.html#cb62-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-99"><a href="annex-i-compendium-of-r-scripts.html#cb62-99" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.5 Reshape the table using pivot_longer ---------------------</span></span>
<span id="cb62-100"><a href="annex-i-compendium-of-r-scripts.html#cb62-100" aria-hidden="true" tabindex="-1"></a><span class="co"># use dat_3</span></span>
<span id="cb62-101"><a href="annex-i-compendium-of-r-scripts.html#cb62-101" aria-hidden="true" tabindex="-1"></a><span class="co"># put the names of the variables ph_h2o, </span></span>
<span id="cb62-102"><a href="annex-i-compendium-of-r-scripts.html#cb62-102" aria-hidden="true" tabindex="-1"></a><span class="co"># cec and thickness in the column </span></span>
<span id="cb62-103"><a href="annex-i-compendium-of-r-scripts.html#cb62-103" aria-hidden="true" tabindex="-1"></a><span class="co"># variable and keep the rest of the table. Save in dat_5 </span></span>
<span id="cb62-104"><a href="annex-i-compendium-of-r-scripts.html#cb62-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-105"><a href="annex-i-compendium-of-r-scripts.html#cb62-105" aria-hidden="true" tabindex="-1"></a>dat_5 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb62-106"><a href="annex-i-compendium-of-r-scripts.html#cb62-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(ph_h2o<span class="sc">:</span>thickness, <span class="at">names_to =</span> <span class="st">&quot;soil_property&quot;</span>,</span>
<span id="cb62-107"><a href="annex-i-compendium-of-r-scripts.html#cb62-107" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>)</span>
<span id="cb62-108"><a href="annex-i-compendium-of-r-scripts.html#cb62-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-109"><a href="annex-i-compendium-of-r-scripts.html#cb62-109" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.6 Join the table sites.csv with dat_3 ----------------------</span></span>
<span id="cb62-110"><a href="annex-i-compendium-of-r-scripts.html#cb62-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Load soil_phys_data030.csv (in 01-Data folder) </span></span>
<span id="cb62-111"><a href="annex-i-compendium-of-r-scripts.html#cb62-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Join its columns with dat_3 keeping all the rows of dat_3</span></span>
<span id="cb62-112"><a href="annex-i-compendium-of-r-scripts.html#cb62-112" aria-hidden="true" tabindex="-1"></a><span class="co"># save the result as dat_6</span></span>
<span id="cb62-113"><a href="annex-i-compendium-of-r-scripts.html#cb62-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-114"><a href="annex-i-compendium-of-r-scripts.html#cb62-114" aria-hidden="true" tabindex="-1"></a>phys <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/soil_phys_data030.csv&quot;</span>)</span>
<span id="cb62-115"><a href="annex-i-compendium-of-r-scripts.html#cb62-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-116"><a href="annex-i-compendium-of-r-scripts.html#cb62-116" aria-hidden="true" tabindex="-1"></a>phys <span class="ot">&lt;-</span> phys <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">id_prof =</span> <span class="st">&quot;ProfID&quot;</span>)</span>
<span id="cb62-117"><a href="annex-i-compendium-of-r-scripts.html#cb62-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-118"><a href="annex-i-compendium-of-r-scripts.html#cb62-118" aria-hidden="true" tabindex="-1"></a>dat_6 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb62-119"><a href="annex-i-compendium-of-r-scripts.html#cb62-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(phys)</span>
<span id="cb62-120"><a href="annex-i-compendium-of-r-scripts.html#cb62-120" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb62-121"><a href="annex-i-compendium-of-r-scripts.html#cb62-121" aria-hidden="true" tabindex="-1"></a>dat_6 <span class="ot">&lt;-</span> phys <span class="sc">%&gt;%</span> </span>
<span id="cb62-122"><a href="annex-i-compendium-of-r-scripts.html#cb62-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(dat_3)</span>
<span id="cb62-123"><a href="annex-i-compendium-of-r-scripts.html#cb62-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-124"><a href="annex-i-compendium-of-r-scripts.html#cb62-124" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Data visualization with ggplot2 ============================</span></span>
<span id="cb62-125"><a href="annex-i-compendium-of-r-scripts.html#cb62-125" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.1 1D plot: histograms --------------------------------------</span></span>
<span id="cb62-126"><a href="annex-i-compendium-of-r-scripts.html#cb62-126" aria-hidden="true" tabindex="-1"></a><span class="co"># histograms of cec and ph_h2o</span></span>
<span id="cb62-127"><a href="annex-i-compendium-of-r-scripts.html#cb62-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-128"><a href="annex-i-compendium-of-r-scripts.html#cb62-128" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x=</span>cec)) <span class="sc">+</span> <span class="fu">geom_histogram</span>()</span>
<span id="cb62-129"><a href="annex-i-compendium-of-r-scripts.html#cb62-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-130"><a href="annex-i-compendium-of-r-scripts.html#cb62-130" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.2 2D plot: scatterplot -------------------------------------</span></span>
<span id="cb62-131"><a href="annex-i-compendium-of-r-scripts.html#cb62-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot bottom vs. ph_h2o</span></span>
<span id="cb62-132"><a href="annex-i-compendium-of-r-scripts.html#cb62-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-133"><a href="annex-i-compendium-of-r-scripts.html#cb62-133" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o)) <span class="sc">+</span> </span>
<span id="cb62-134"><a href="annex-i-compendium-of-r-scripts.html#cb62-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() </span>
<span id="cb62-135"><a href="annex-i-compendium-of-r-scripts.html#cb62-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-136"><a href="annex-i-compendium-of-r-scripts.html#cb62-136" aria-hidden="true" tabindex="-1"></a><span class="co"># add a fitting line</span></span>
<span id="cb62-137"><a href="annex-i-compendium-of-r-scripts.html#cb62-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-138"><a href="annex-i-compendium-of-r-scripts.html#cb62-138" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o)) <span class="sc">+</span> </span>
<span id="cb62-139"><a href="annex-i-compendium-of-r-scripts.html#cb62-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb62-140"><a href="annex-i-compendium-of-r-scripts.html#cb62-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span> )</span>
<span id="cb62-141"><a href="annex-i-compendium-of-r-scripts.html#cb62-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-142"><a href="annex-i-compendium-of-r-scripts.html#cb62-142" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.3 3D plot: scatterplot -------------------------------------</span></span>
<span id="cb62-143"><a href="annex-i-compendium-of-r-scripts.html#cb62-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot bottom vs. ph_h2o, add clay as color </span></span>
<span id="cb62-144"><a href="annex-i-compendium-of-r-scripts.html#cb62-144" aria-hidden="true" tabindex="-1"></a><span class="co"># and size inside the </span></span>
<span id="cb62-145"><a href="annex-i-compendium-of-r-scripts.html#cb62-145" aria-hidden="true" tabindex="-1"></a><span class="co"># function aes()</span></span>
<span id="cb62-146"><a href="annex-i-compendium-of-r-scripts.html#cb62-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-147"><a href="annex-i-compendium-of-r-scripts.html#cb62-147" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, </span>
<span id="cb62-148"><a href="annex-i-compendium-of-r-scripts.html#cb62-148" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o, <span class="at">color =</span> cec, <span class="at">size =</span> cec)) <span class="sc">+</span> </span>
<span id="cb62-149"><a href="annex-i-compendium-of-r-scripts.html#cb62-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span>
<span id="cb62-150"><a href="annex-i-compendium-of-r-scripts.html#cb62-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-151"><a href="annex-i-compendium-of-r-scripts.html#cb62-151" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Geospatial data with terra =================================</span></span>
<span id="cb62-152"><a href="annex-i-compendium-of-r-scripts.html#cb62-152" aria-hidden="true" tabindex="-1"></a><span class="do">## Load packages (install them if needed)</span></span>
<span id="cb62-153"><a href="annex-i-compendium-of-r-scripts.html#cb62-153" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb62-154"><a href="annex-i-compendium-of-r-scripts.html#cb62-154" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.1 Load a raster and a vector layer -------------------------</span></span>
<span id="cb62-155"><a href="annex-i-compendium-of-r-scripts.html#cb62-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Load 01-Data/covs/grass.tif using rast() function, then plot it</span></span>
<span id="cb62-156"><a href="annex-i-compendium-of-r-scripts.html#cb62-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Load 01-Data/soil map/SoilTypes.shp using vect() function and </span></span>
<span id="cb62-157"><a href="annex-i-compendium-of-r-scripts.html#cb62-157" aria-hidden="true" tabindex="-1"></a><span class="co"># plot it </span></span>
<span id="cb62-158"><a href="annex-i-compendium-of-r-scripts.html#cb62-158" aria-hidden="true" tabindex="-1"></a><span class="co"># explore the attributes of these layers</span></span>
<span id="cb62-159"><a href="annex-i-compendium-of-r-scripts.html#cb62-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-160"><a href="annex-i-compendium-of-r-scripts.html#cb62-160" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/Macedonia/grass.tif&quot;</span>)</span>
<span id="cb62-161"><a href="annex-i-compendium-of-r-scripts.html#cb62-161" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb62-162"><a href="annex-i-compendium-of-r-scripts.html#cb62-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-163"><a href="annex-i-compendium-of-r-scripts.html#cb62-163" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">vect</span>(<span class="st">&quot;01-Data/Macedonia/SoilTypes.shp&quot;</span>)</span>
<span id="cb62-164"><a href="annex-i-compendium-of-r-scripts.html#cb62-164" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v)</span>
<span id="cb62-165"><a href="annex-i-compendium-of-r-scripts.html#cb62-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-166"><a href="annex-i-compendium-of-r-scripts.html#cb62-166" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.2 Load a raster and a vector layer -------------------------</span></span>
<span id="cb62-167"><a href="annex-i-compendium-of-r-scripts.html#cb62-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the current CRS (EPSG) of the raster and the vector. </span></span>
<span id="cb62-168"><a href="annex-i-compendium-of-r-scripts.html#cb62-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Find a *projected* CRS in http://epsg.io for Macedonia and </span></span>
<span id="cb62-169"><a href="annex-i-compendium-of-r-scripts.html#cb62-169" aria-hidden="true" tabindex="-1"></a><span class="co"># copy the number</span></span>
<span id="cb62-170"><a href="annex-i-compendium-of-r-scripts.html#cb62-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the Arguments of function project (?project) that need to</span></span>
<span id="cb62-171"><a href="annex-i-compendium-of-r-scripts.html#cb62-171" aria-hidden="true" tabindex="-1"></a><span class="co"># be defined</span></span>
<span id="cb62-172"><a href="annex-i-compendium-of-r-scripts.html#cb62-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the new object as r_proj and v_proj</span></span>
<span id="cb62-173"><a href="annex-i-compendium-of-r-scripts.html#cb62-173" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both objects</span></span>
<span id="cb62-174"><a href="annex-i-compendium-of-r-scripts.html#cb62-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-175"><a href="annex-i-compendium-of-r-scripts.html#cb62-175" aria-hidden="true" tabindex="-1"></a>r_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="at">x =</span> r, <span class="at">y =</span> <span class="st">&quot;epsg:6204&quot;</span>, <span class="at">method =</span> <span class="st">&quot;bilinear&quot;</span>,</span>
<span id="cb62-176"><a href="annex-i-compendium-of-r-scripts.html#cb62-176" aria-hidden="true" tabindex="-1"></a>                  <span class="at">res =</span> <span class="dv">250</span>)</span>
<span id="cb62-177"><a href="annex-i-compendium-of-r-scripts.html#cb62-177" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_proj)</span>
<span id="cb62-178"><a href="annex-i-compendium-of-r-scripts.html#cb62-178" aria-hidden="true" tabindex="-1"></a>v_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="at">x =</span> v, <span class="at">y =</span> <span class="st">&quot;epsg:6204&quot;</span>)</span>
<span id="cb62-179"><a href="annex-i-compendium-of-r-scripts.html#cb62-179" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v_proj, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb62-180"><a href="annex-i-compendium-of-r-scripts.html#cb62-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-181"><a href="annex-i-compendium-of-r-scripts.html#cb62-181" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.3 Cropping and masking a raster ----------------------------</span></span>
<span id="cb62-182"><a href="annex-i-compendium-of-r-scripts.html#cb62-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the area of the polygons in v_proj </span></span>
<span id="cb62-183"><a href="annex-i-compendium-of-r-scripts.html#cb62-183" aria-hidden="true" tabindex="-1"></a><span class="co"># (search for a function) and</span></span>
<span id="cb62-184"><a href="annex-i-compendium-of-r-scripts.html#cb62-184" aria-hidden="true" tabindex="-1"></a><span class="co"># assign the values to a new column named area</span></span>
<span id="cb62-185"><a href="annex-i-compendium-of-r-scripts.html#cb62-185" aria-hidden="true" tabindex="-1"></a><span class="co"># select the largest polygon using [], $, == and max() func. </span></span>
<span id="cb62-186"><a href="annex-i-compendium-of-r-scripts.html#cb62-186" aria-hidden="true" tabindex="-1"></a><span class="co"># and save it as pol</span></span>
<span id="cb62-187"><a href="annex-i-compendium-of-r-scripts.html#cb62-187" aria-hidden="true" tabindex="-1"></a><span class="co"># crop the raster with pol using the crop() function and save </span></span>
<span id="cb62-188"><a href="annex-i-compendium-of-r-scripts.html#cb62-188" aria-hidden="true" tabindex="-1"></a><span class="co">#it as r_pol</span></span>
<span id="cb62-189"><a href="annex-i-compendium-of-r-scripts.html#cb62-189" aria-hidden="true" tabindex="-1"></a><span class="co"># mask the raster r_pol with the polygon pol and save it </span></span>
<span id="cb62-190"><a href="annex-i-compendium-of-r-scripts.html#cb62-190" aria-hidden="true" tabindex="-1"></a><span class="co"># with the same name</span></span>
<span id="cb62-191"><a href="annex-i-compendium-of-r-scripts.html#cb62-191" aria-hidden="true" tabindex="-1"></a><span class="co"># plot each result</span></span>
<span id="cb62-192"><a href="annex-i-compendium-of-r-scripts.html#cb62-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-193"><a href="annex-i-compendium-of-r-scripts.html#cb62-193" aria-hidden="true" tabindex="-1"></a>v_proj<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">expanse</span>(v_proj, <span class="at">unit =</span> <span class="st">&quot;ha&quot;</span>)</span>
<span id="cb62-194"><a href="annex-i-compendium-of-r-scripts.html#cb62-194" aria-hidden="true" tabindex="-1"></a>pol <span class="ot">&lt;-</span> v_proj[v_proj<span class="sc">$</span>area <span class="sc">==</span> <span class="fu">max</span>(v_proj<span class="sc">$</span>area)]</span>
<span id="cb62-195"><a href="annex-i-compendium-of-r-scripts.html#cb62-195" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol)</span>
<span id="cb62-196"><a href="annex-i-compendium-of-r-scripts.html#cb62-196" aria-hidden="true" tabindex="-1"></a>r_pol <span class="ot">&lt;-</span> <span class="fu">crop</span>(r_proj, pol)</span>
<span id="cb62-197"><a href="annex-i-compendium-of-r-scripts.html#cb62-197" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb62-198"><a href="annex-i-compendium-of-r-scripts.html#cb62-198" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb62-199"><a href="annex-i-compendium-of-r-scripts.html#cb62-199" aria-hidden="true" tabindex="-1"></a>r_pol <span class="ot">&lt;-</span> <span class="fu">mask</span>(r_pol, pol)</span>
<span id="cb62-200"><a href="annex-i-compendium-of-r-scripts.html#cb62-200" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb62-201"><a href="annex-i-compendium-of-r-scripts.html#cb62-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-202"><a href="annex-i-compendium-of-r-scripts.html#cb62-202" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.4 Replace values in a raster by filtering their cells ------</span></span>
<span id="cb62-203"><a href="annex-i-compendium-of-r-scripts.html#cb62-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore the following link to understand how terra </span></span>
<span id="cb62-204"><a href="annex-i-compendium-of-r-scripts.html#cb62-204" aria-hidden="true" tabindex="-1"></a><span class="co">#manage cell values</span></span>
<span id="cb62-205"><a href="annex-i-compendium-of-r-scripts.html#cb62-205" aria-hidden="true" tabindex="-1"></a><span class="co"># https://rspatial.org/terra/pkg/4-algebra.html </span></span>
<span id="cb62-206"><a href="annex-i-compendium-of-r-scripts.html#cb62-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace values lower than 5 in r+pol by 0</span></span>
<span id="cb62-207"><a href="annex-i-compendium-of-r-scripts.html#cb62-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-208"><a href="annex-i-compendium-of-r-scripts.html#cb62-208" aria-hidden="true" tabindex="-1"></a>r_pol[r_pol<span class="sc">$</span>grass <span class="sc">&lt;</span> <span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb62-209"><a href="annex-i-compendium-of-r-scripts.html#cb62-209" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb62-210"><a href="annex-i-compendium-of-r-scripts.html#cb62-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-211"><a href="annex-i-compendium-of-r-scripts.html#cb62-211" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.5 Rasterize a vector layer ---------------------------------</span></span>
<span id="cb62-212"><a href="annex-i-compendium-of-r-scripts.html#cb62-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Use rasterize() function to convert v_proj to raster</span></span>
<span id="cb62-213"><a href="annex-i-compendium-of-r-scripts.html#cb62-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Use r_proj as reference raster</span></span>
<span id="cb62-214"><a href="annex-i-compendium-of-r-scripts.html#cb62-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Use field Symbol to assign cell values, and plot the new map</span></span>
<span id="cb62-215"><a href="annex-i-compendium-of-r-scripts.html#cb62-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-216"><a href="annex-i-compendium-of-r-scripts.html#cb62-216" aria-hidden="true" tabindex="-1"></a>v_class <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="at">x =</span> v_proj, <span class="at">y =</span> r_proj, <span class="at">field =</span> <span class="st">&quot;Symbol&quot;</span> )</span>
<span id="cb62-217"><a href="annex-i-compendium-of-r-scripts.html#cb62-217" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v_class)</span>
<span id="cb62-218"><a href="annex-i-compendium-of-r-scripts.html#cb62-218" aria-hidden="true" tabindex="-1"></a>v_class</span>
<span id="cb62-219"><a href="annex-i-compendium-of-r-scripts.html#cb62-219" aria-hidden="true" tabindex="-1"></a><span class="fu">activeCat</span>(v_class) <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb62-220"><a href="annex-i-compendium-of-r-scripts.html#cb62-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-221"><a href="annex-i-compendium-of-r-scripts.html#cb62-221" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.6 Extracting raster values using points --------------------</span></span>
<span id="cb62-222"><a href="annex-i-compendium-of-r-scripts.html#cb62-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Covert dat_6 to spatial points using vect() function </span></span>
<span id="cb62-223"><a href="annex-i-compendium-of-r-scripts.html#cb62-223" aria-hidden="true" tabindex="-1"></a><span class="co"># (check help of vect())</span></span>
<span id="cb62-224"><a href="annex-i-compendium-of-r-scripts.html#cb62-224" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the EPSG number is 6204</span></span>
<span id="cb62-225"><a href="annex-i-compendium-of-r-scripts.html#cb62-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the points as s</span></span>
<span id="cb62-226"><a href="annex-i-compendium-of-r-scripts.html#cb62-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot s and r_proj together in the same map (Argument add=TRUE)</span></span>
<span id="cb62-227"><a href="annex-i-compendium-of-r-scripts.html#cb62-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the values of the raster using extract() </span></span>
<span id="cb62-228"><a href="annex-i-compendium-of-r-scripts.html#cb62-228" aria-hidden="true" tabindex="-1"></a><span class="co"># function (check the help)</span></span>
<span id="cb62-229"><a href="annex-i-compendium-of-r-scripts.html#cb62-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the ID column of the extracted values</span></span>
<span id="cb62-230"><a href="annex-i-compendium-of-r-scripts.html#cb62-230" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the extracted data with s using cbind() function</span></span>
<span id="cb62-231"><a href="annex-i-compendium-of-r-scripts.html#cb62-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert s as a dataframe</span></span>
<span id="cb62-232"><a href="annex-i-compendium-of-r-scripts.html#cb62-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-233"><a href="annex-i-compendium-of-r-scripts.html#cb62-233" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">vect</span>(dat_6, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="st">&quot;epsg:6204&quot;</span>)</span>
<span id="cb62-234"><a href="annex-i-compendium-of-r-scripts.html#cb62-234" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_proj)</span>
<span id="cb62-235"><a href="annex-i-compendium-of-r-scripts.html#cb62-235" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(s, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb62-236"><a href="annex-i-compendium-of-r-scripts.html#cb62-236" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">extract</span>(r_proj,s, <span class="at">ID=</span><span class="cn">FALSE</span>)</span>
<span id="cb62-237"><a href="annex-i-compendium-of-r-scripts.html#cb62-237" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">cbind</span>(s,x)</span>
<span id="cb62-238"><a href="annex-i-compendium-of-r-scripts.html#cb62-238" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(s)</span>
<span id="cb62-239"><a href="annex-i-compendium-of-r-scripts.html#cb62-239" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb62-240"><a href="annex-i-compendium-of-r-scripts.html#cb62-240" aria-hidden="true" tabindex="-1"></a><span class="co">#GGally::ggscatmat(d)</span></span>
<span id="cb62-241"><a href="annex-i-compendium-of-r-scripts.html#cb62-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-242"><a href="annex-i-compendium-of-r-scripts.html#cb62-242" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.7 Zonal statistics using polygons and rasters --------------</span></span>
<span id="cb62-243"><a href="annex-i-compendium-of-r-scripts.html#cb62-243" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the extract() func. to estimate the mean value of </span></span>
<span id="cb62-244"><a href="annex-i-compendium-of-r-scripts.html#cb62-244" aria-hidden="true" tabindex="-1"></a><span class="co"># r_proj at each polygon</span></span>
<span id="cb62-245"><a href="annex-i-compendium-of-r-scripts.html#cb62-245" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the fun= argument (check the help)</span></span>
<span id="cb62-246"><a href="annex-i-compendium-of-r-scripts.html#cb62-246" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the cbind() func. to merge v_proj and the extracted values</span></span>
<span id="cb62-247"><a href="annex-i-compendium-of-r-scripts.html#cb62-247" aria-hidden="true" tabindex="-1"></a><span class="co"># convert v_proj to a dataframe</span></span>
<span id="cb62-248"><a href="annex-i-compendium-of-r-scripts.html#cb62-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a ggplot boxplot (geom_boxplot) with x=Symbol</span></span>
<span id="cb62-249"><a href="annex-i-compendium-of-r-scripts.html#cb62-249" aria-hidden="true" tabindex="-1"></a><span class="co"># and y=grass </span></span>
<span id="cb62-250"><a href="annex-i-compendium-of-r-scripts.html#cb62-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-251"><a href="annex-i-compendium-of-r-scripts.html#cb62-251" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">extract</span>(r_proj, v_proj, <span class="at">fun =</span> mean, <span class="at">ID=</span><span class="cn">FALSE</span>)</span>
<span id="cb62-252"><a href="annex-i-compendium-of-r-scripts.html#cb62-252" aria-hidden="true" tabindex="-1"></a>v_proj <span class="ot">&lt;-</span> <span class="fu">cbind</span>(v_proj, x)</span>
<span id="cb62-253"><a href="annex-i-compendium-of-r-scripts.html#cb62-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-254"><a href="annex-i-compendium-of-r-scripts.html#cb62-254" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(v_proj)</span>
<span id="cb62-255"><a href="annex-i-compendium-of-r-scripts.html#cb62-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-256"><a href="annex-i-compendium-of-r-scripts.html#cb62-256" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> </span>
<span id="cb62-257"><a href="annex-i-compendium-of-r-scripts.html#cb62-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span>Symbol, <span class="at">y =</span> grass, <span class="at">fill =</span> Symbol)) <span class="sc">+</span></span>
<span id="cb62-258"><a href="annex-i-compendium-of-r-scripts.html#cb62-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb62-259"><a href="annex-i-compendium-of-r-scripts.html#cb62-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Grass probability&quot;</span>)</span>
<span id="cb62-260"><a href="annex-i-compendium-of-r-scripts.html#cb62-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-261"><a href="annex-i-compendium-of-r-scripts.html#cb62-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-262"><a href="annex-i-compendium-of-r-scripts.html#cb62-262" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="re">END</span></span></code></pre></div>
</div>
<div id="script-2-download-environmental-covariates" class="section level2 unnumbered hasAnchor">
<h2>Script 2: Download environmental covariates<a href="annex-i-compendium-of-r-scripts.html#script-2-download-environmental-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb63"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb63-1"><a href="annex-i-compendium-of-r-scripts.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assets <span class="op">=</span> </span>
<span id="cb63-2"><a href="annex-i-compendium-of-r-scripts.html#cb63-2" aria-hidden="true" tabindex="-1"></a>[<span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio1&quot;</span><span class="op">,</span></span>
<span id="cb63-3"><a href="annex-i-compendium-of-r-scripts.html#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio12&quot;</span><span class="op">,</span></span>
<span id="cb63-4"><a href="annex-i-compendium-of-r-scripts.html#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio13&quot;</span><span class="op">,</span></span>
<span id="cb63-5"><a href="annex-i-compendium-of-r-scripts.html#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio14&quot;</span><span class="op">,</span></span>
<span id="cb63-6"><a href="annex-i-compendium-of-r-scripts.html#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio16&quot;</span><span class="op">,</span></span>
<span id="cb63-7"><a href="annex-i-compendium-of-r-scripts.html#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio17&quot;</span><span class="op">,</span></span>
<span id="cb63-8"><a href="annex-i-compendium-of-r-scripts.html#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio5&quot;</span><span class="op">,</span></span>
<span id="cb63-9"><a href="annex-i-compendium-of-r-scripts.html#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio6&quot;</span><span class="op">,</span></span>
<span id="cb63-10"><a href="annex-i-compendium-of-r-scripts.html#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/ngd10&quot;</span><span class="op">,</span></span>
<span id="cb63-11"><a href="annex-i-compendium-of-r-scripts.html#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_max&quot;</span><span class="op">,</span></span>
<span id="cb63-12"><a href="annex-i-compendium-of-r-scripts.html#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-13"><a href="annex-i-compendium-of-r-scripts.html#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_min&quot;</span><span class="op">,</span></span>
<span id="cb63-14"><a href="annex-i-compendium-of-r-scripts.html#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_range&quot;</span><span class="op">,</span></span>
<span id="cb63-15"><a href="annex-i-compendium-of-r-scripts.html#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_max&quot;</span><span class="op">,</span></span>
<span id="cb63-16"><a href="annex-i-compendium-of-r-scripts.html#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-17"><a href="annex-i-compendium-of-r-scripts.html#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_range&quot;</span><span class="op">,</span></span>
<span id="cb63-18"><a href="annex-i-compendium-of-r-scripts.html#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_030405_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-19"><a href="annex-i-compendium-of-r-scripts.html#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_030405_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-20"><a href="annex-i-compendium-of-r-scripts.html#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_060708_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-21"><a href="annex-i-compendium-of-r-scripts.html#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_060708_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-22"><a href="annex-i-compendium-of-r-scripts.html#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_091011_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-23"><a href="annex-i-compendium-of-r-scripts.html#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_091011_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-24"><a href="annex-i-compendium-of-r-scripts.html#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_120102_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-25"><a href="annex-i-compendium-of-r-scripts.html#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_120102_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-26"><a href="annex-i-compendium-of-r-scripts.html#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_030405_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-27"><a href="annex-i-compendium-of-r-scripts.html#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_030405_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-28"><a href="annex-i-compendium-of-r-scripts.html#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_060708_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-29"><a href="annex-i-compendium-of-r-scripts.html#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_060708_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-30"><a href="annex-i-compendium-of-r-scripts.html#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_091011_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-31"><a href="annex-i-compendium-of-r-scripts.html#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_091011_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-32"><a href="annex-i-compendium-of-r-scripts.html#cb63-32" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_120102_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-33"><a href="annex-i-compendium-of-r-scripts.html#cb63-33" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_120102_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-34"><a href="annex-i-compendium-of-r-scripts.html#cb63-34" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_030405_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-35"><a href="annex-i-compendium-of-r-scripts.html#cb63-35" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_030405_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-36"><a href="annex-i-compendium-of-r-scripts.html#cb63-36" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_060708_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-37"><a href="annex-i-compendium-of-r-scripts.html#cb63-37" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_060708_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-38"><a href="annex-i-compendium-of-r-scripts.html#cb63-38" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_091011_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-39"><a href="annex-i-compendium-of-r-scripts.html#cb63-39" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_091011_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-40"><a href="annex-i-compendium-of-r-scripts.html#cb63-40" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_120102_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-41"><a href="annex-i-compendium-of-r-scripts.html#cb63-41" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_120102_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-42"><a href="annex-i-compendium-of-r-scripts.html#cb63-42" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_030405_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-43"><a href="annex-i-compendium-of-r-scripts.html#cb63-43" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_030405_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-44"><a href="annex-i-compendium-of-r-scripts.html#cb63-44" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_060708_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-45"><a href="annex-i-compendium-of-r-scripts.html#cb63-45" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_060708_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-46"><a href="annex-i-compendium-of-r-scripts.html#cb63-46" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_091011_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-47"><a href="annex-i-compendium-of-r-scripts.html#cb63-47" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_091011_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-48"><a href="annex-i-compendium-of-r-scripts.html#cb63-48" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_120102_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-49"><a href="annex-i-compendium-of-r-scripts.html#cb63-49" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_120102_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb63-50"><a href="annex-i-compendium-of-r-scripts.html#cb63-50" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/snow_cover&quot;</span><span class="op">,</span></span>
<span id="cb63-51"><a href="annex-i-compendium-of-r-scripts.html#cb63-51" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/swir_060708_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb63-52"><a href="annex-i-compendium-of-r-scripts.html#cb63-52" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/crops&quot;</span><span class="op">,</span></span>
<span id="cb63-53"><a href="annex-i-compendium-of-r-scripts.html#cb63-53" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/flooded_vegetation&quot;</span><span class="op">,</span></span>
<span id="cb63-54"><a href="annex-i-compendium-of-r-scripts.html#cb63-54" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/grass&quot;</span><span class="op">,</span></span>
<span id="cb63-55"><a href="annex-i-compendium-of-r-scripts.html#cb63-55" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/shrub_and_scrub&quot;</span><span class="op">,</span></span>
<span id="cb63-56"><a href="annex-i-compendium-of-r-scripts.html#cb63-56" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/trees&quot;</span><span class="op">,</span></span>
<span id="cb63-57"><a href="annex-i-compendium-of-r-scripts.html#cb63-57" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_curvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-58"><a href="annex-i-compendium-of-r-scripts.html#cb63-58" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_downslopecurvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-59"><a href="annex-i-compendium-of-r-scripts.html#cb63-59" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_dvm2_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-60"><a href="annex-i-compendium-of-r-scripts.html#cb63-60" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_dvm_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-61"><a href="annex-i-compendium-of-r-scripts.html#cb63-61" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_elevation_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-62"><a href="annex-i-compendium-of-r-scripts.html#cb63-62" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_mrn_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-63"><a href="annex-i-compendium-of-r-scripts.html#cb63-63" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_neg_openness_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-64"><a href="annex-i-compendium-of-r-scripts.html#cb63-64" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_pos_openness_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-65"><a href="annex-i-compendium-of-r-scripts.html#cb63-65" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_slope_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-66"><a href="annex-i-compendium-of-r-scripts.html#cb63-66" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_tpi_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-67"><a href="annex-i-compendium-of-r-scripts.html#cb63-67" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_twi_500m&quot;</span><span class="op">,</span></span>
<span id="cb63-68"><a href="annex-i-compendium-of-r-scripts.html#cb63-68" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_upslopecurvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb63-69"><a href="annex-i-compendium-of-r-scripts.html#cb63-69" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_vbf_250m&quot;</span>]<span class="op">;</span></span>
<span id="cb63-70"><a href="annex-i-compendium-of-r-scripts.html#cb63-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-71"><a href="annex-i-compendium-of-r-scripts.html#cb63-71" aria-hidden="true" tabindex="-1"></a><span class="co">// Load borders </span></span>
<span id="cb63-72"><a href="annex-i-compendium-of-r-scripts.html#cb63-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-73"><a href="annex-i-compendium-of-r-scripts.html#cb63-73" aria-hidden="true" tabindex="-1"></a><span class="co">/// Using UN 2020 (replace the countries to download)</span></span>
<span id="cb63-74"><a href="annex-i-compendium-of-r-scripts.html#cb63-74" aria-hidden="true" tabindex="-1"></a><span class="co">/// var ISO = [&#39;ITA&#39;];</span></span>
<span id="cb63-75"><a href="annex-i-compendium-of-r-scripts.html#cb63-75" aria-hidden="true" tabindex="-1"></a><span class="co">/// var aoi =</span></span>
<span id="cb63-76"><a href="annex-i-compendium-of-r-scripts.html#cb63-76" aria-hidden="true" tabindex="-1"></a><span class="co">/// ee.FeatureCollection(</span></span>
<span id="cb63-77"><a href="annex-i-compendium-of-r-scripts.html#cb63-77" aria-hidden="true" tabindex="-1"></a><span class="co">/// &#39;projects/digital-soil-mapping-gsp-fao/assets/UN_BORDERS/BNDA_CTY&#39;</span></span>
<span id="cb63-78"><a href="annex-i-compendium-of-r-scripts.html#cb63-78" aria-hidden="true" tabindex="-1"></a><span class="co">/// )</span></span>
<span id="cb63-79"><a href="annex-i-compendium-of-r-scripts.html#cb63-79" aria-hidden="true" tabindex="-1"></a><span class="co">///   .filter(ee.Filter.inList(&#39;ISO3CD&#39;, ISO));</span></span>
<span id="cb63-80"><a href="annex-i-compendium-of-r-scripts.html#cb63-80" aria-hidden="true" tabindex="-1"></a><span class="co">/// var region = aoi.geometry();</span></span>
<span id="cb63-81"><a href="annex-i-compendium-of-r-scripts.html#cb63-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-82"><a href="annex-i-compendium-of-r-scripts.html#cb63-82" aria-hidden="true" tabindex="-1"></a><span class="co">/// Using a shapefile</span></span>
<span id="cb63-83"><a href="annex-i-compendium-of-r-scripts.html#cb63-83" aria-hidden="true" tabindex="-1"></a><span class="co">/// 1. Upload the borders of your countries as an asset</span></span>
<span id="cb63-84"><a href="annex-i-compendium-of-r-scripts.html#cb63-84" aria-hidden="true" tabindex="-1"></a><span class="co">/// 2. Replace &#39;your_shapefile&#39; with the path to your shapefile</span></span>
<span id="cb63-85"><a href="annex-i-compendium-of-r-scripts.html#cb63-85" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> shapefile <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;projects/digital-soil-mapping-gsp-fao/assets/Nghe_An&#39;</span>)<span class="op">;</span></span>
<span id="cb63-86"><a href="annex-i-compendium-of-r-scripts.html#cb63-86" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> region <span class="op">=</span> shapefile<span class="op">.</span><span class="fu">geometry</span>()<span class="op">.</span><span class="fu">bounds</span>()<span class="op">;</span></span>
<span id="cb63-87"><a href="annex-i-compendium-of-r-scripts.html#cb63-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-88"><a href="annex-i-compendium-of-r-scripts.html#cb63-88" aria-hidden="true" tabindex="-1"></a><span class="co">// Load assets as ImageCollection</span></span>
<span id="cb63-89"><a href="annex-i-compendium-of-r-scripts.html#cb63-89" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assetsCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(assets)<span class="op">;</span></span>
<span id="cb63-90"><a href="annex-i-compendium-of-r-scripts.html#cb63-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-91"><a href="annex-i-compendium-of-r-scripts.html#cb63-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Clip each image in the collection to the region of interest</span></span>
<span id="cb63-92"><a href="annex-i-compendium-of-r-scripts.html#cb63-92" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clippedCollection <span class="op">=</span> assetsCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(img){</span>
<span id="cb63-93"><a href="annex-i-compendium-of-r-scripts.html#cb63-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> img<span class="op">.</span><span class="fu">clip</span>(region)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb63-94"><a href="annex-i-compendium-of-r-scripts.html#cb63-94" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb63-95"><a href="annex-i-compendium-of-r-scripts.html#cb63-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-96"><a href="annex-i-compendium-of-r-scripts.html#cb63-96" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to replace masked values with zeroes for fpar bands</span></span>
<span id="cb63-97"><a href="annex-i-compendium-of-r-scripts.html#cb63-97" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">replaceMaskedFpar</span>(img) {</span>
<span id="cb63-98"><a href="annex-i-compendium-of-r-scripts.html#cb63-98" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> allBands <span class="op">=</span> img<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb63-99"><a href="annex-i-compendium-of-r-scripts.html#cb63-99" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fparBands <span class="op">=</span></span>
<span id="cb63-100"><a href="annex-i-compendium-of-r-scripts.html#cb63-100" aria-hidden="true" tabindex="-1"></a>  allBands<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">stringStartsWith</span>(<span class="st">&#39;item&#39;</span><span class="op">,</span> <span class="st">&#39;fpar&#39;</span>))<span class="op">;</span></span>
<span id="cb63-101"><a href="annex-i-compendium-of-r-scripts.html#cb63-101" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> nonFparBands <span class="op">=</span> allBands<span class="op">.</span><span class="fu">removeAll</span>(fparBands)<span class="op">;</span></span>
<span id="cb63-102"><a href="annex-i-compendium-of-r-scripts.html#cb63-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-103"><a href="annex-i-compendium-of-r-scripts.html#cb63-103" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fparImg <span class="op">=</span> img<span class="op">.</span><span class="fu">select</span>(fparBands)<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb63-104"><a href="annex-i-compendium-of-r-scripts.html#cb63-104" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> nonFparImg <span class="op">=</span> img<span class="op">.</span><span class="fu">select</span>(nonFparBands)<span class="op">;</span></span>
<span id="cb63-105"><a href="annex-i-compendium-of-r-scripts.html#cb63-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-106"><a href="annex-i-compendium-of-r-scripts.html#cb63-106" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If there are no fpar bands, return the original image</span></span>
<span id="cb63-107"><a href="annex-i-compendium-of-r-scripts.html#cb63-107" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(fparBands<span class="op">.</span><span class="fu">length</span>()<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb63-108"><a href="annex-i-compendium-of-r-scripts.html#cb63-108" aria-hidden="true" tabindex="-1"></a>                                 img<span class="op">,</span></span>
<span id="cb63-109"><a href="annex-i-compendium-of-r-scripts.html#cb63-109" aria-hidden="true" tabindex="-1"></a>                                 nonFparImg<span class="op">.</span><span class="fu">addBands</span>(fparImg))<span class="op">;</span></span>
<span id="cb63-110"><a href="annex-i-compendium-of-r-scripts.html#cb63-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-111"><a href="annex-i-compendium-of-r-scripts.html#cb63-111" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(result)<span class="op">;</span></span>
<span id="cb63-112"><a href="annex-i-compendium-of-r-scripts.html#cb63-112" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-113"><a href="annex-i-compendium-of-r-scripts.html#cb63-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-114"><a href="annex-i-compendium-of-r-scripts.html#cb63-114" aria-hidden="true" tabindex="-1"></a><span class="co">// Clip each image in the collection to the region of </span></span>
<span id="cb63-115"><a href="annex-i-compendium-of-r-scripts.html#cb63-115" aria-hidden="true" tabindex="-1"></a><span class="co">//interest and replace masked values for fpar bands</span></span>
<span id="cb63-116"><a href="annex-i-compendium-of-r-scripts.html#cb63-116" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clippedCollection <span class="op">=</span> assetsCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(img){</span>
<span id="cb63-117"><a href="annex-i-compendium-of-r-scripts.html#cb63-117" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> clippedImg <span class="op">=</span> img<span class="op">.</span><span class="fu">clip</span>(region)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb63-118"><a href="annex-i-compendium-of-r-scripts.html#cb63-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">replaceMaskedFpar</span>(clippedImg)<span class="op">;</span></span>
<span id="cb63-119"><a href="annex-i-compendium-of-r-scripts.html#cb63-119" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb63-120"><a href="annex-i-compendium-of-r-scripts.html#cb63-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-121"><a href="annex-i-compendium-of-r-scripts.html#cb63-121" aria-hidden="true" tabindex="-1"></a><span class="co">// Stack the layers and maintain the </span></span>
<span id="cb63-122"><a href="annex-i-compendium-of-r-scripts.html#cb63-122" aria-hidden="true" tabindex="-1"></a><span class="co">//layer names in the final file</span></span>
<span id="cb63-123"><a href="annex-i-compendium-of-r-scripts.html#cb63-123" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stacked <span class="op">=</span> clippedCollection<span class="op">.</span><span class="fu">toBands</span>()<span class="op">;</span></span>
<span id="cb63-124"><a href="annex-i-compendium-of-r-scripts.html#cb63-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-125"><a href="annex-i-compendium-of-r-scripts.html#cb63-125" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the list of asset names</span></span>
<span id="cb63-126"><a href="annex-i-compendium-of-r-scripts.html#cb63-126" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assetNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(assets)<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(asset) {</span>
<span id="cb63-127"><a href="annex-i-compendium-of-r-scripts.html#cb63-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">String</span>(asset)<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">get</span>(<span class="op">-</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb63-128"><a href="annex-i-compendium-of-r-scripts.html#cb63-128" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb63-129"><a href="annex-i-compendium-of-r-scripts.html#cb63-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-130"><a href="annex-i-compendium-of-r-scripts.html#cb63-130" aria-hidden="true" tabindex="-1"></a><span class="co">// Rename the bands with asset names</span></span>
<span id="cb63-131"><a href="annex-i-compendium-of-r-scripts.html#cb63-131" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> renamed <span class="op">=</span> stacked<span class="op">.</span><span class="fu">rename</span>(assetNames)<span class="op">;</span></span>
<span id="cb63-132"><a href="annex-i-compendium-of-r-scripts.html#cb63-132" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(renamed<span class="op">,</span> <span class="st">&#39;Covariates to be exported&#39;</span>)</span>
<span id="cb63-133"><a href="annex-i-compendium-of-r-scripts.html#cb63-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-134"><a href="annex-i-compendium-of-r-scripts.html#cb63-134" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize the result</span></span>
<span id="cb63-135"><a href="annex-i-compendium-of-r-scripts.html#cb63-135" aria-hidden="true" tabindex="-1"></a><span class="co">// Set a visualization parameter </span></span>
<span id="cb63-136"><a href="annex-i-compendium-of-r-scripts.html#cb63-136" aria-hidden="true" tabindex="-1"></a><span class="co">// (you can adjust the colors as desired)</span></span>
<span id="cb63-137"><a href="annex-i-compendium-of-r-scripts.html#cb63-137" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb63-138"><a href="annex-i-compendium-of-r-scripts.html#cb63-138" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> <span class="st">&#39;bio1&#39;</span><span class="op">,</span></span>
<span id="cb63-139"><a href="annex-i-compendium-of-r-scripts.html#cb63-139" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb63-140"><a href="annex-i-compendium-of-r-scripts.html#cb63-140" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb63-141"><a href="annex-i-compendium-of-r-scripts.html#cb63-141" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;yellow&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>]</span>
<span id="cb63-142"><a href="annex-i-compendium-of-r-scripts.html#cb63-142" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb63-143"><a href="annex-i-compendium-of-r-scripts.html#cb63-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-144"><a href="annex-i-compendium-of-r-scripts.html#cb63-144" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the layer to the map</span></span>
<span id="cb63-145"><a href="annex-i-compendium-of-r-scripts.html#cb63-145" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(renamed<span class="op">,</span> <span class="dv">6</span>)</span>
<span id="cb63-146"><a href="annex-i-compendium-of-r-scripts.html#cb63-146" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(renamed<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Covariates&#39;</span>)<span class="op">;</span></span>
<span id="cb63-147"><a href="annex-i-compendium-of-r-scripts.html#cb63-147" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the stacked image to Google Drive</span></span>
<span id="cb63-148"><a href="annex-i-compendium-of-r-scripts.html#cb63-148" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb63-149"><a href="annex-i-compendium-of-r-scripts.html#cb63-149" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> renamed<span class="op">,</span></span>
<span id="cb63-150"><a href="annex-i-compendium-of-r-scripts.html#cb63-150" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;covariates&#39;</span><span class="op">,</span></span>
<span id="cb63-151"><a href="annex-i-compendium-of-r-scripts.html#cb63-151" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;GEE&#39;</span><span class="op">,</span></span>
<span id="cb63-152"><a href="annex-i-compendium-of-r-scripts.html#cb63-152" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb63-153"><a href="annex-i-compendium-of-r-scripts.html#cb63-153" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span><span class="op">,</span></span>
<span id="cb63-154"><a href="annex-i-compendium-of-r-scripts.html#cb63-154" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> region</span>
<span id="cb63-155"><a href="annex-i-compendium-of-r-scripts.html#cb63-155" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb63-156"><a href="annex-i-compendium-of-r-scripts.html#cb63-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-157"><a href="annex-i-compendium-of-r-scripts.html#cb63-157" aria-hidden="true" tabindex="-1"></a><span class="co">/* Create mask for croplands ----------------------------*/</span></span>
<span id="cb63-158"><a href="annex-i-compendium-of-r-scripts.html#cb63-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-159"><a href="annex-i-compendium-of-r-scripts.html#cb63-159" aria-hidden="true" tabindex="-1"></a><span class="co">// Load the Copernicus Global Land Service image collection</span></span>
<span id="cb63-160"><a href="annex-i-compendium-of-r-scripts.html#cb63-160" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> imageCollection <span class="op">=</span> </span>
<span id="cb63-161"><a href="annex-i-compendium-of-r-scripts.html#cb63-161" aria-hidden="true" tabindex="-1"></a>ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;COPERNICUS/Landcover/100m/Proba-V-C3/Global/2019&quot;</span>)</span>
<span id="cb63-162"><a href="annex-i-compendium-of-r-scripts.html#cb63-162" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;discrete_classification&quot;</span>)</span>
<span id="cb63-163"><a href="annex-i-compendium-of-r-scripts.html#cb63-163" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>(region)</span>
<span id="cb63-164"><a href="annex-i-compendium-of-r-scripts.html#cb63-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-165"><a href="annex-i-compendium-of-r-scripts.html#cb63-165" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> crs <span class="op">=</span> <span class="st">&#39;EPSG:4326&#39;</span><span class="op">;</span> <span class="co">// WGS84</span></span>
<span id="cb63-166"><a href="annex-i-compendium-of-r-scripts.html#cb63-166" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> res <span class="op">=</span> <span class="dv">250</span><span class="op">;</span> <span class="co">// Resolution in decimal degrees</span></span>
<span id="cb63-167"><a href="annex-i-compendium-of-r-scripts.html#cb63-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-168"><a href="annex-i-compendium-of-r-scripts.html#cb63-168" aria-hidden="true" tabindex="-1"></a><span class="co">// Default resampling is nearest neighbor</span></span>
<span id="cb63-169"><a href="annex-i-compendium-of-r-scripts.html#cb63-169" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image1 <span class="op">=</span> imageCollection<span class="op">.</span><span class="fu">resample</span>()</span>
<span id="cb63-170"><a href="annex-i-compendium-of-r-scripts.html#cb63-170" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">reproject</span>({</span>
<span id="cb63-171"><a href="annex-i-compendium-of-r-scripts.html#cb63-171" aria-hidden="true" tabindex="-1"></a>    <span class="dt">crs</span><span class="op">:</span> crs<span class="op">,</span> <span class="co">// Add your desired CRS here</span></span>
<span id="cb63-172"><a href="annex-i-compendium-of-r-scripts.html#cb63-172" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> res <span class="co">// Add your desired scale here</span></span>
<span id="cb63-173"><a href="annex-i-compendium-of-r-scripts.html#cb63-173" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb63-174"><a href="annex-i-compendium-of-r-scripts.html#cb63-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-175"><a href="annex-i-compendium-of-r-scripts.html#cb63-175" aria-hidden="true" tabindex="-1"></a><span class="co">// Reclassify the land cover classes</span></span>
<span id="cb63-176"><a href="annex-i-compendium-of-r-scripts.html#cb63-176" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> inList <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">80</span><span class="op">,</span> <span class="dv">90</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> </span>
<span id="cb63-177"><a href="annex-i-compendium-of-r-scripts.html#cb63-177" aria-hidden="true" tabindex="-1"></a>               <span class="dv">111</span><span class="op">,</span> <span class="dv">112</span><span class="op">,</span> <span class="dv">113</span><span class="op">,</span> <span class="dv">114</span><span class="op">,</span> <span class="dv">115</span><span class="op">,</span> <span class="dv">116</span><span class="op">,</span> </span>
<span id="cb63-178"><a href="annex-i-compendium-of-r-scripts.html#cb63-178" aria-hidden="true" tabindex="-1"></a>              <span class="dv">121</span><span class="op">,</span> <span class="dv">122</span><span class="op">,</span> <span class="dv">123</span><span class="op">,</span> <span class="dv">124</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">126</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">;</span></span>
<span id="cb63-179"><a href="annex-i-compendium-of-r-scripts.html#cb63-179" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> outList <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb63-180"><a href="annex-i-compendium-of-r-scripts.html#cb63-180" aria-hidden="true" tabindex="-1"></a>               <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb63-181"><a href="annex-i-compendium-of-r-scripts.html#cb63-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-182"><a href="annex-i-compendium-of-r-scripts.html#cb63-182" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> FAO_lu <span class="op">=</span> image1<span class="op">.</span><span class="fu">remap</span>(inList<span class="op">,</span> outList)</span>
<span id="cb63-183"><a href="annex-i-compendium-of-r-scripts.html#cb63-183" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">toDouble</span>()</span>
<span id="cb63-184"><a href="annex-i-compendium-of-r-scripts.html#cb63-184" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>(region)<span class="op">;</span></span>
<span id="cb63-185"><a href="annex-i-compendium-of-r-scripts.html#cb63-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-186"><a href="annex-i-compendium-of-r-scripts.html#cb63-186" aria-hidden="true" tabindex="-1"></a><span class="co">// print(FAO_lu)</span></span>
<span id="cb63-187"><a href="annex-i-compendium-of-r-scripts.html#cb63-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-188"><a href="annex-i-compendium-of-r-scripts.html#cb63-188" aria-hidden="true" tabindex="-1"></a><span class="co">// Convert 0 to NA</span></span>
<span id="cb63-189"><a href="annex-i-compendium-of-r-scripts.html#cb63-189" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mask <span class="op">=</span> FAO_lu<span class="op">.</span><span class="fu">neq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb63-190"><a href="annex-i-compendium-of-r-scripts.html#cb63-190" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mask)</span>
<span id="cb63-191"><a href="annex-i-compendium-of-r-scripts.html#cb63-191" aria-hidden="true" tabindex="-1"></a>FAO_lu <span class="op">=</span> FAO_lu<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb63-192"><a href="annex-i-compendium-of-r-scripts.html#cb63-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-193"><a href="annex-i-compendium-of-r-scripts.html#cb63-193" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(FAO_lu<span class="op">,</span> <span class="st">&quot;Mask&quot;</span>)</span>
<span id="cb63-194"><a href="annex-i-compendium-of-r-scripts.html#cb63-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-195"><a href="annex-i-compendium-of-r-scripts.html#cb63-195" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb63-196"><a href="annex-i-compendium-of-r-scripts.html#cb63-196" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> <span class="st">&#39;remapped&#39;</span><span class="op">,</span></span>
<span id="cb63-197"><a href="annex-i-compendium-of-r-scripts.html#cb63-197" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb63-198"><a href="annex-i-compendium-of-r-scripts.html#cb63-198" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb63-199"><a href="annex-i-compendium-of-r-scripts.html#cb63-199" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;yellow&#39;</span>]</span>
<span id="cb63-200"><a href="annex-i-compendium-of-r-scripts.html#cb63-200" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb63-201"><a href="annex-i-compendium-of-r-scripts.html#cb63-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-202"><a href="annex-i-compendium-of-r-scripts.html#cb63-202" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the layer to the map</span></span>
<span id="cb63-203"><a href="annex-i-compendium-of-r-scripts.html#cb63-203" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(FAO_lu<span class="op">,</span>visParams <span class="op">,</span><span class="st">&#39;Mask&#39;</span>)<span class="op">;</span></span>
<span id="cb63-204"><a href="annex-i-compendium-of-r-scripts.html#cb63-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-205"><a href="annex-i-compendium-of-r-scripts.html#cb63-205" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the land cover image as a raster to Google Drive</span></span>
<span id="cb63-206"><a href="annex-i-compendium-of-r-scripts.html#cb63-206" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb63-207"><a href="annex-i-compendium-of-r-scripts.html#cb63-207" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> FAO_lu<span class="op">,</span></span>
<span id="cb63-208"><a href="annex-i-compendium-of-r-scripts.html#cb63-208" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;GEE&#39;</span><span class="op">,</span></span>
<span id="cb63-209"><a href="annex-i-compendium-of-r-scripts.html#cb63-209" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;mask&#39;</span><span class="op">,</span></span>
<span id="cb63-210"><a href="annex-i-compendium-of-r-scripts.html#cb63-210" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> res<span class="op">,</span> <span class="co">// Add your desired scale here</span></span>
<span id="cb63-211"><a href="annex-i-compendium-of-r-scripts.html#cb63-211" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb63-212"><a href="annex-i-compendium-of-r-scripts.html#cb63-212" aria-hidden="true" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> crs<span class="op">,</span> <span class="co">// Add your desired CRS here</span></span>
<span id="cb63-213"><a href="annex-i-compendium-of-r-scripts.html#cb63-213" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span> <span class="co">// Add a maximum number of pixels </span></span>
<span id="cb63-214"><a href="annex-i-compendium-of-r-scripts.html#cb63-214" aria-hidden="true" tabindex="-1"></a>  <span class="co">//for export if needed</span></span>
<span id="cb63-215"><a href="annex-i-compendium-of-r-scripts.html#cb63-215" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="script-3-evaluate-legacy-data" class="section level2 unnumbered hasAnchor">
<h2>Script 3: Evaluate Legacy Data<a href="annex-i-compendium-of-r-scripts.html#script-3-evaluate-legacy-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="annex-i-compendium-of-r-scripts.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb64-2"><a href="annex-i-compendium-of-r-scripts.html#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb64-3"><a href="annex-i-compendium-of-r-scripts.html#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb64-4"><a href="annex-i-compendium-of-r-scripts.html#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluation of Legacy Data</span></span>
<span id="cb64-5"><a href="annex-i-compendium-of-r-scripts.html#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb64-6"><a href="annex-i-compendium-of-r-scripts.html#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb64-7"><a href="annex-i-compendium-of-r-scripts.html#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb64-8"><a href="annex-i-compendium-of-r-scripts.html#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="annex-i-compendium-of-r-scripts.html#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb64-10"><a href="annex-i-compendium-of-r-scripts.html#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="annex-i-compendium-of-r-scripts.html#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Empty environment and cache </span></span>
<span id="cb64-12"><a href="annex-i-compendium-of-r-scripts.html#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb64-13"><a href="annex-i-compendium-of-r-scripts.html#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb64-14"><a href="annex-i-compendium-of-r-scripts.html#cb64-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-15"><a href="annex-i-compendium-of-r-scripts.html#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script ========================================</span></span>
<span id="cb64-16"><a href="annex-i-compendium-of-r-scripts.html#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="annex-i-compendium-of-r-scripts.html#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Script for evaluation the degree of representativeness of a soil legacy dataset</span></span>
<span id="cb64-18"><a href="annex-i-compendium-of-r-scripts.html#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="co"># relative to the diversity of the environmental conditions described in a set </span></span>
<span id="cb64-19"><a href="annex-i-compendium-of-r-scripts.html#cb64-19" aria-hidden="true" tabindex="-1"></a><span class="co"># of rasterb covariates.</span></span>
<span id="cb64-20"><a href="annex-i-compendium-of-r-scripts.html#cb64-20" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb64-21"><a href="annex-i-compendium-of-r-scripts.html#cb64-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load packages</span></span>
<span id="cb64-22"><a href="annex-i-compendium-of-r-scripts.html#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb64-23"><a href="annex-i-compendium-of-r-scripts.html#cb64-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Extract environmental data from rasters at soil locations</span></span>
<span id="cb64-24"><a href="annex-i-compendium-of-r-scripts.html#cb64-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Extract environmental data from rasters at soil locations</span></span>
<span id="cb64-25"><a href="annex-i-compendium-of-r-scripts.html#cb64-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Compute variability matrix in covariates</span></span>
<span id="cb64-26"><a href="annex-i-compendium-of-r-scripts.html#cb64-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Calculate hypercube of &quot;covariates&quot; distribution (P)</span></span>
<span id="cb64-27"><a href="annex-i-compendium-of-r-scripts.html#cb64-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Calculate hypercube of &quot;sample&quot; distribution (Q)</span></span>
<span id="cb64-28"><a href="annex-i-compendium-of-r-scripts.html#cb64-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Calculate Representativeness of the Legacy Dataset</span></span>
<span id="cb64-29"><a href="annex-i-compendium-of-r-scripts.html#cb64-29" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb64-30"><a href="annex-i-compendium-of-r-scripts.html#cb64-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-31"><a href="annex-i-compendium-of-r-scripts.html#cb64-31" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb64-32"><a href="annex-i-compendium-of-r-scripts.html#cb64-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-33"><a href="annex-i-compendium-of-r-scripts.html#cb64-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load packages =================================</span></span>
<span id="cb64-34"><a href="annex-i-compendium-of-r-scripts.html#cb64-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-35"><a href="annex-i-compendium-of-r-scripts.html#cb64-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#remotes::install_github(&quot;lemuscanovas/synoptReg&quot;)</span></span>
<span id="cb64-36"><a href="annex-i-compendium-of-r-scripts.html#cb64-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-37"><a href="annex-i-compendium-of-r-scripts.html#cb64-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb64-38"><a href="annex-i-compendium-of-r-scripts.html#cb64-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb64-39"><a href="annex-i-compendium-of-r-scripts.html#cb64-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb64-40"><a href="annex-i-compendium-of-r-scripts.html#cb64-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-41"><a href="annex-i-compendium-of-r-scripts.html#cb64-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of packages</span></span>
<span id="cb64-42"><a href="annex-i-compendium-of-r-scripts.html#cb64-42" aria-hidden="true" tabindex="-1"></a>  packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;terra&quot;</span>,<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sf&quot;</span>,<span class="st">&quot;clhs&quot;</span>, <span class="st">&quot;sgsR&quot;</span>,<span class="st">&quot;entropy&quot;</span>, <span class="st">&quot;tripack&quot;</span>,</span>
<span id="cb64-43"><a href="annex-i-compendium-of-r-scripts.html#cb64-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;manipulate&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;synoptReg&quot;</span>)</span>
<span id="cb64-44"><a href="annex-i-compendium-of-r-scripts.html#cb64-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages</span></span>
<span id="cb64-45"><a href="annex-i-compendium-of-r-scripts.html#cb64-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-46"><a href="annex-i-compendium-of-r-scripts.html#cb64-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove object to save memory space</span></span>
<span id="cb64-47"><a href="annex-i-compendium-of-r-scripts.html#cb64-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(packages) </span>
<span id="cb64-48"><a href="annex-i-compendium-of-r-scripts.html#cb64-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-49"><a href="annex-i-compendium-of-r-scripts.html#cb64-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-50"><a href="annex-i-compendium-of-r-scripts.html#cb64-50" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb64-51"><a href="annex-i-compendium-of-r-scripts.html#cb64-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to rasters</span></span>
<span id="cb64-52"><a href="annex-i-compendium-of-r-scripts.html#cb64-52" aria-hidden="true" tabindex="-1"></a>  raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters&quot;</span></span>
<span id="cb64-53"><a href="annex-i-compendium-of-r-scripts.html#cb64-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to shapes</span></span>
<span id="cb64-54"><a href="annex-i-compendium-of-r-scripts.html#cb64-54" aria-hidden="true" tabindex="-1"></a>  shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes&quot;</span></span>
<span id="cb64-55"><a href="annex-i-compendium-of-r-scripts.html#cb64-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to results</span></span>
<span id="cb64-56"><a href="annex-i-compendium-of-r-scripts.html#cb64-56" aria-hidden="true" tabindex="-1"></a>  results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb64-57"><a href="annex-i-compendium-of-r-scripts.html#cb64-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregation factor for up-scaling raster covariates (optional)</span></span>
<span id="cb64-58"><a href="annex-i-compendium-of-r-scripts.html#cb64-58" aria-hidden="true" tabindex="-1"></a>  agg.factor <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb64-59"><a href="annex-i-compendium-of-r-scripts.html#cb64-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-60"><a href="annex-i-compendium-of-r-scripts.html#cb64-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-61"><a href="annex-i-compendium-of-r-scripts.html#cb64-61" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Prepare data ============================================================</span></span>
<span id="cb64-62"><a href="annex-i-compendium-of-r-scripts.html#cb64-62" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Load raster covariate data</span></span>
<span id="cb64-63"><a href="annex-i-compendium-of-r-scripts.html#cb64-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb64-64"><a href="annex-i-compendium-of-r-scripts.html#cb64-64" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(raster.path, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-65"><a href="annex-i-compendium-of-r-scripts.html#cb64-65" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat) <span class="co"># SpatRaster from terra</span></span>
<span id="cb64-66"><a href="annex-i-compendium-of-r-scripts.html#cb64-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate stack to simplify data rasters for calculations </span></span>
<span id="cb64-67"><a href="annex-i-compendium-of-r-scripts.html#cb64-67" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(cov.dat, <span class="at">fact=</span>agg.factor, <span class="at">fun=</span><span class="st">&quot;mean&quot;</span>)</span>
<span id="cb64-68"><a href="annex-i-compendium-of-r-scripts.html#cb64-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-69"><a href="annex-i-compendium-of-r-scripts.html#cb64-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load shape of district</span></span>
<span id="cb64-70"><a href="annex-i-compendium-of-r-scripts.html#cb64-70" aria-hidden="true" tabindex="-1"></a>  nghe <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/Nghe_An.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb64-71"><a href="annex-i-compendium-of-r-scripts.html#cb64-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-72"><a href="annex-i-compendium-of-r-scripts.html#cb64-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crop covariates on administrative boundary</span></span>
<span id="cb64-73"><a href="annex-i-compendium-of-r-scripts.html#cb64-73" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb64-74"><a href="annex-i-compendium-of-r-scripts.html#cb64-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-75"><a href="annex-i-compendium-of-r-scripts.html#cb64-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform raster information with PCA</span></span>
<span id="cb64-76"><a href="annex-i-compendium-of-r-scripts.html#cb64-76" aria-hidden="true" tabindex="-1"></a>  pca <span class="ot">&lt;-</span> <span class="fu">raster_pca</span>(cov.dat)</span>
<span id="cb64-77"><a href="annex-i-compendium-of-r-scripts.html#cb64-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-78"><a href="annex-i-compendium-of-r-scripts.html#cb64-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get SpatRaster layers</span></span>
<span id="cb64-79"><a href="annex-i-compendium-of-r-scripts.html#cb64-79" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb64-80"><a href="annex-i-compendium-of-r-scripts.html#cb64-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a raster stack to be used as input in the clhs::clhs function </span></span>
<span id="cb64-81"><a href="annex-i-compendium-of-r-scripts.html#cb64-81" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat) </span>
<span id="cb64-82"><a href="annex-i-compendium-of-r-scripts.html#cb64-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset rasters</span></span>
<span id="cb64-83"><a href="annex-i-compendium-of-r-scripts.html#cb64-83" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb64-84"><a href="annex-i-compendium-of-r-scripts.html#cb64-84" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span>  cov.dat.ras[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb64-85"><a href="annex-i-compendium-of-r-scripts.html#cb64-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-86"><a href="annex-i-compendium-of-r-scripts.html#cb64-86" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 - Extract environmental data from rasters at soil locations ===============</span></span>
<span id="cb64-87"><a href="annex-i-compendium-of-r-scripts.html#cb64-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load legacy soil data</span></span>
<span id="cb64-88"><a href="annex-i-compendium-of-r-scripts.html#cb64-88" aria-hidden="true" tabindex="-1"></a>  p.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">vect</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/legacy_soils.shp&quot;</span>)))</span>
<span id="cb64-89"><a href="annex-i-compendium-of-r-scripts.html#cb64-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract data</span></span>
<span id="cb64-90"><a href="annex-i-compendium-of-r-scripts.html#cb64-90" aria-hidden="true" tabindex="-1"></a>  p.dat_I <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(cov.dat, p.dat)</span>
<span id="cb64-91"><a href="annex-i-compendium-of-r-scripts.html#cb64-91" aria-hidden="true" tabindex="-1"></a>  p.dat_I <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(p.dat_I) <span class="co"># Remove soil points outside study area</span></span>
<span id="cb64-92"><a href="annex-i-compendium-of-r-scripts.html#cb64-92" aria-hidden="true" tabindex="-1"></a>  p.dat_I.df <span class="ot">&lt;-</span> p.dat_I[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb64-93"><a href="annex-i-compendium-of-r-scripts.html#cb64-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>(p.dat_I.df)</span>
<span id="cb64-94"><a href="annex-i-compendium-of-r-scripts.html#cb64-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-95"><a href="annex-i-compendium-of-r-scripts.html#cb64-95" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 - Compute variability matrix in the covariates ====================================</span></span>
<span id="cb64-96"><a href="annex-i-compendium-of-r-scripts.html#cb64-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define Number of bins</span></span>
<span id="cb64-97"><a href="annex-i-compendium-of-r-scripts.html#cb64-97" aria-hidden="true" tabindex="-1"></a>  nb <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb64-98"><a href="annex-i-compendium-of-r-scripts.html#cb64-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Quantile matrix of the covariate data</span></span>
<span id="cb64-99"><a href="annex-i-compendium-of-r-scripts.html#cb64-99" aria-hidden="true" tabindex="-1"></a>  q.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> (nb <span class="sc">+</span> <span class="dv">1</span>), <span class="at">ncol =</span> <span class="fu">nlyr</span>(cov.dat))</span>
<span id="cb64-100"><a href="annex-i-compendium-of-r-scripts.html#cb64-100" aria-hidden="true" tabindex="-1"></a>  j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb64-101"><a href="annex-i-compendium-of-r-scripts.html#cb64-101" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(cov.dat)) {</span>
<span id="cb64-102"><a href="annex-i-compendium-of-r-scripts.html#cb64-102" aria-hidden="true" tabindex="-1"></a>    ran1 <span class="ot">&lt;-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>]</span>
<span id="cb64-103"><a href="annex-i-compendium-of-r-scripts.html#cb64-103" aria-hidden="true" tabindex="-1"></a>    step1 <span class="ot">&lt;-</span> ran1 <span class="sc">/</span> nb</span>
<span id="cb64-104"><a href="annex-i-compendium-of-r-scripts.html#cb64-104" aria-hidden="true" tabindex="-1"></a>    q.mat[, j] <span class="ot">&lt;-</span></span>
<span id="cb64-105"><a href="annex-i-compendium-of-r-scripts.html#cb64-105" aria-hidden="true" tabindex="-1"></a>      <span class="fu">seq</span>(<span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>],</span>
<span id="cb64-106"><a href="annex-i-compendium-of-r-scripts.html#cb64-106" aria-hidden="true" tabindex="-1"></a>          <span class="at">to =</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>],</span>
<span id="cb64-107"><a href="annex-i-compendium-of-r-scripts.html#cb64-107" aria-hidden="true" tabindex="-1"></a>          <span class="at">by =</span> step1)</span>
<span id="cb64-108"><a href="annex-i-compendium-of-r-scripts.html#cb64-108" aria-hidden="true" tabindex="-1"></a>    j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb64-109"><a href="annex-i-compendium-of-r-scripts.html#cb64-109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb64-110"><a href="annex-i-compendium-of-r-scripts.html#cb64-110" aria-hidden="true" tabindex="-1"></a>  q.mat</span>
<span id="cb64-111"><a href="annex-i-compendium-of-r-scripts.html#cb64-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-112"><a href="annex-i-compendium-of-r-scripts.html#cb64-112" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 - Calculate hypercube of &quot;covariates&quot; distribution (P)  ===================  </span></span>
<span id="cb64-113"><a href="annex-i-compendium-of-r-scripts.html#cb64-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert SpatRaster to dataframe for calculations</span></span>
<span id="cb64-114"><a href="annex-i-compendium-of-r-scripts.html#cb64-114" aria-hidden="true" tabindex="-1"></a>  cov.dat.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(cov.dat) </span>
<span id="cb64-115"><a href="annex-i-compendium-of-r-scripts.html#cb64-115" aria-hidden="true" tabindex="-1"></a>  cov.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb64-116"><a href="annex-i-compendium-of-r-scripts.html#cb64-116" aria-hidden="true" tabindex="-1"></a>  cov.dat.mx <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cov.dat.df)</span>
<span id="cb64-117"><a href="annex-i-compendium-of-r-scripts.html#cb64-117" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cov.dat.mx)) {</span>
<span id="cb64-118"><a href="annex-i-compendium-of-r-scripts.html#cb64-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.mx)) {</span>
<span id="cb64-119"><a href="annex-i-compendium-of-r-scripts.html#cb64-119" aria-hidden="true" tabindex="-1"></a>      dd <span class="ot">&lt;-</span> cov.dat.mx[[i, j]]</span>
<span id="cb64-120"><a href="annex-i-compendium-of-r-scripts.html#cb64-120" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb64-121"><a href="annex-i-compendium-of-r-scripts.html#cb64-121" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb64-122"><a href="annex-i-compendium-of-r-scripts.html#cb64-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb64-123"><a href="annex-i-compendium-of-r-scripts.html#cb64-123" aria-hidden="true" tabindex="-1"></a>          kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb64-124"><a href="annex-i-compendium-of-r-scripts.html#cb64-124" aria-hidden="true" tabindex="-1"></a>          ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb64-125"><a href="annex-i-compendium-of-r-scripts.html#cb64-125" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb64-126"><a href="annex-i-compendium-of-r-scripts.html#cb64-126" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb64-127"><a href="annex-i-compendium-of-r-scripts.html#cb64-127" aria-hidden="true" tabindex="-1"></a>            cov.mat[k, j] <span class="ot">&lt;-</span> cov.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb64-128"><a href="annex-i-compendium-of-r-scripts.html#cb64-128" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb64-129"><a href="annex-i-compendium-of-r-scripts.html#cb64-129" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb64-130"><a href="annex-i-compendium-of-r-scripts.html#cb64-130" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb64-131"><a href="annex-i-compendium-of-r-scripts.html#cb64-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb64-132"><a href="annex-i-compendium-of-r-scripts.html#cb64-132" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb64-133"><a href="annex-i-compendium-of-r-scripts.html#cb64-133" aria-hidden="true" tabindex="-1"></a>  cov.mat</span>
<span id="cb64-134"><a href="annex-i-compendium-of-r-scripts.html#cb64-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-135"><a href="annex-i-compendium-of-r-scripts.html#cb64-135" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 - Calculate hypercube of &quot;sample&quot; distribution (Q) ========================  </span></span>
<span id="cb64-136"><a href="annex-i-compendium-of-r-scripts.html#cb64-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-137"><a href="annex-i-compendium-of-r-scripts.html#cb64-137" aria-hidden="true" tabindex="-1"></a>  h.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb64-138"><a href="annex-i-compendium-of-r-scripts.html#cb64-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p.dat_I.df)) {</span>
<span id="cb64-139"><a href="annex-i-compendium-of-r-scripts.html#cb64-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(p.dat_I.df)) {</span>
<span id="cb64-140"><a href="annex-i-compendium-of-r-scripts.html#cb64-140" aria-hidden="true" tabindex="-1"></a>      dd <span class="ot">&lt;-</span> p.dat_I.df[i, j]</span>
<span id="cb64-141"><a href="annex-i-compendium-of-r-scripts.html#cb64-141" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb64-142"><a href="annex-i-compendium-of-r-scripts.html#cb64-142" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb64-143"><a href="annex-i-compendium-of-r-scripts.html#cb64-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb64-144"><a href="annex-i-compendium-of-r-scripts.html#cb64-144" aria-hidden="true" tabindex="-1"></a>          kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb64-145"><a href="annex-i-compendium-of-r-scripts.html#cb64-145" aria-hidden="true" tabindex="-1"></a>          ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb64-146"><a href="annex-i-compendium-of-r-scripts.html#cb64-146" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb64-147"><a href="annex-i-compendium-of-r-scripts.html#cb64-147" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb64-148"><a href="annex-i-compendium-of-r-scripts.html#cb64-148" aria-hidden="true" tabindex="-1"></a>            h.mat[k, j] <span class="ot">&lt;-</span> h.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb64-149"><a href="annex-i-compendium-of-r-scripts.html#cb64-149" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb64-150"><a href="annex-i-compendium-of-r-scripts.html#cb64-150" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb64-151"><a href="annex-i-compendium-of-r-scripts.html#cb64-151" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb64-152"><a href="annex-i-compendium-of-r-scripts.html#cb64-152" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb64-153"><a href="annex-i-compendium-of-r-scripts.html#cb64-153" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb64-154"><a href="annex-i-compendium-of-r-scripts.html#cb64-154" aria-hidden="true" tabindex="-1"></a>  h.mat </span>
<span id="cb64-155"><a href="annex-i-compendium-of-r-scripts.html#cb64-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-156"><a href="annex-i-compendium-of-r-scripts.html#cb64-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-157"><a href="annex-i-compendium-of-r-scripts.html#cb64-157" aria-hidden="true" tabindex="-1"></a><span class="do">## 7 - Calculate Representativeness of the Legacy Dataset ==================    </span></span>
<span id="cb64-158"><a href="annex-i-compendium-of-r-scripts.html#cb64-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-159"><a href="annex-i-compendium-of-r-scripts.html#cb64-159" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate the proportion of &quot;variables&quot; in the covariate spectra that fall within the convex hull of variables in the &quot;environmental sample space&quot;</span></span>
<span id="cb64-160"><a href="annex-i-compendium-of-r-scripts.html#cb64-160" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Principal component of the legacy data sample</span></span>
<span id="cb64-161"><a href="annex-i-compendium-of-r-scripts.html#cb64-161" aria-hidden="true" tabindex="-1"></a>  pca.s <span class="ot">=</span> <span class="fu">prcomp</span>(p.dat_I[,<span class="dv">2</span><span class="sc">:</span>(<span class="fu">ncol</span>(cov.dat.df)<span class="sc">+</span><span class="dv">1</span>)],<span class="at">scale=</span><span class="cn">TRUE</span>, <span class="at">center=</span><span class="cn">TRUE</span>)</span>
<span id="cb64-162"><a href="annex-i-compendium-of-r-scripts.html#cb64-162" aria-hidden="true" tabindex="-1"></a>  scores_pca1 <span class="ot">=</span> <span class="fu">as.data.frame</span>(pca.s<span class="sc">$</span>x)</span>
<span id="cb64-163"><a href="annex-i-compendium-of-r-scripts.html#cb64-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the first 2 principal components and convex hull</span></span>
<span id="cb64-164"><a href="annex-i-compendium-of-r-scripts.html#cb64-164" aria-hidden="true" tabindex="-1"></a>  rand.tr <span class="ot">&lt;-</span> <span class="fu">tri.mesh</span>(scores_pca1[,<span class="dv">1</span>],scores_pca1[,<span class="dv">2</span>],<span class="st">&quot;remove&quot;</span>) <span class="co"># Delaunay triangulation </span></span>
<span id="cb64-165"><a href="annex-i-compendium-of-r-scripts.html#cb64-165" aria-hidden="true" tabindex="-1"></a>  rand.ch <span class="ot">&lt;-</span> <span class="fu">convex.hull</span>(rand.tr, <span class="at">plot.it=</span>F) <span class="co"># convex hull</span></span>
<span id="cb64-166"><a href="annex-i-compendium-of-r-scripts.html#cb64-166" aria-hidden="true" tabindex="-1"></a>  pr_poly <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x=</span><span class="fu">c</span>(rand.ch<span class="sc">$</span>x),<span class="at">y=</span><span class="fu">c</span>(rand.ch<span class="sc">$</span>y)) <span class="co"># save the convex hull vertices</span></span>
<span id="cb64-167"><a href="annex-i-compendium-of-r-scripts.html#cb64-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(scores_pca1[,<span class="dv">1</span>], scores_pca1[,<span class="dv">2</span>], <span class="at">xlab=</span><span class="st">&quot;PCA 1&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;PCA 2&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])),<span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(scores_pca1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">main=</span><span class="st">&#39;Convex hull of soil legacy data&#39;</span>)</span>
<span id="cb64-168"><a href="annex-i-compendium-of-r-scripts.html#cb64-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">c</span>(rand.ch<span class="sc">$</span>x,rand.ch<span class="sc">$</span>x[<span class="dv">1</span>]), <span class="fu">c</span>(rand.ch<span class="sc">$</span>y,rand.ch<span class="sc">$</span>y[<span class="dv">1</span>]),<span class="at">col=</span><span class="st">&quot;red&quot;</span>,<span class="at">lwd=</span><span class="dv">1</span>) <span class="co"># draw the convex hull (domain of legacy data)</span></span>
<span id="cb64-169"><a href="annex-i-compendium-of-r-scripts.html#cb64-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-170"><a href="annex-i-compendium-of-r-scripts.html#cb64-170" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PCA projection of study area population onto the principal components</span></span>
<span id="cb64-171"><a href="annex-i-compendium-of-r-scripts.html#cb64-171" aria-hidden="true" tabindex="-1"></a>  PCA_projection <span class="ot">&lt;-</span> <span class="fu">predict</span>(pca.s, cov.dat.df) <span class="co"># Project study area population onto sample PC</span></span>
<span id="cb64-172"><a href="annex-i-compendium-of-r-scripts.html#cb64-172" aria-hidden="true" tabindex="-1"></a>  newScores <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x=</span>PCA_projection[,<span class="dv">1</span>],<span class="at">y=</span>PCA_projection[,<span class="dv">2</span>]) <span class="co"># PC scores of projected population</span></span>
<span id="cb64-173"><a href="annex-i-compendium-of-r-scripts.html#cb64-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-174"><a href="annex-i-compendium-of-r-scripts.html#cb64-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the polygon and all points to be checked</span></span>
<span id="cb64-175"><a href="annex-i-compendium-of-r-scripts.html#cb64-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(newScores, <span class="at">xlab=</span><span class="st">&quot;PCA 1&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;PCA 2&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])), <span class="at">col=</span><span class="st">&#39;black&#39;</span>, <span class="at">main=</span><span class="st">&#39;Environmental space plots over the convex hull of soil legacy data&#39;</span>)</span>
<span id="cb64-176"><a href="annex-i-compendium-of-r-scripts.html#cb64-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(pr_poly,<span class="at">col=</span><span class="st">&#39;#99999990&#39;</span>)</span>
<span id="cb64-177"><a href="annex-i-compendium-of-r-scripts.html#cb64-177" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check which points fall within the polygon</span></span>
<span id="cb64-178"><a href="annex-i-compendium-of-r-scripts.html#cb64-178" aria-hidden="true" tabindex="-1"></a>  pip <span class="ot">&lt;-</span> <span class="fu">point.in.polygon</span>(newScores[,<span class="dv">2</span>], newScores[,<span class="dv">1</span>], pr_poly[,<span class="dv">2</span>],pr_poly[,<span class="dv">1</span>],<span class="at">mode.checked=</span><span class="cn">FALSE</span>)</span>
<span id="cb64-179"><a href="annex-i-compendium-of-r-scripts.html#cb64-179" aria-hidden="true" tabindex="-1"></a>  newScores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(newScores, pip))</span>
<span id="cb64-180"><a href="annex-i-compendium-of-r-scripts.html#cb64-180" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot points outside convex hull  </span></span>
<span id="cb64-181"><a href="annex-i-compendium-of-r-scripts.html#cb64-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(newScores[<span class="fu">which</span>(newScores<span class="sc">$</span>pip<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="at">pch=</span><span class="st">&#39;X&#39;</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb64-182"><a href="annex-i-compendium-of-r-scripts.html#cb64-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-183"><a href="annex-i-compendium-of-r-scripts.html#cb64-183" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  Proportion of the conditions in the study area that fall within the convex hull of sample conditions</span></span>
<span id="cb64-184"><a href="annex-i-compendium-of-r-scripts.html#cb64-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">nrow</span>(newScores[newScores<span class="sc">$</span>pip<span class="sc">&gt;</span><span class="dv">0</span>,]))<span class="sc">/</span><span class="fu">nrow</span>(newScores)<span class="sc">*</span><span class="dv">100</span> </span>
<span id="cb64-185"><a href="annex-i-compendium-of-r-scripts.html#cb64-185" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-186"><a href="annex-i-compendium-of-r-scripts.html#cb64-186" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="re">END</span></span></code></pre></div>
</div>
<div id="script-4-calculate-minimum-sample-size" class="section level2 unnumbered hasAnchor">
<h2>Script 4: Calculate Minimum Sample Size<a href="annex-i-compendium-of-r-scripts.html#script-4-calculate-minimum-sample-size" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="annex-i-compendium-of-r-scripts.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb65-2"><a href="annex-i-compendium-of-r-scripts.html#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb65-3"><a href="annex-i-compendium-of-r-scripts.html#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb65-4"><a href="annex-i-compendium-of-r-scripts.html#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimizing Sample Size</span></span>
<span id="cb65-5"><a href="annex-i-compendium-of-r-scripts.html#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb65-6"><a href="annex-i-compendium-of-r-scripts.html#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb65-7"><a href="annex-i-compendium-of-r-scripts.html#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb65-8"><a href="annex-i-compendium-of-r-scripts.html#cb65-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-9"><a href="annex-i-compendium-of-r-scripts.html#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb65-10"><a href="annex-i-compendium-of-r-scripts.html#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="annex-i-compendium-of-r-scripts.html#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Empty environment and cache </span></span>
<span id="cb65-12"><a href="annex-i-compendium-of-r-scripts.html#cb65-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb65-13"><a href="annex-i-compendium-of-r-scripts.html#cb65-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb65-14"><a href="annex-i-compendium-of-r-scripts.html#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="annex-i-compendium-of-r-scripts.html#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script ========================================</span></span>
<span id="cb65-16"><a href="annex-i-compendium-of-r-scripts.html#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="co"># The goal of this script is to determine the minimum sample size required to describe an area</span></span>
<span id="cb65-17"><a href="annex-i-compendium-of-r-scripts.html#cb65-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># while retaining for a 95% of representativeness in the environmental variability of covariates</span></span>
<span id="cb65-18"><a href="annex-i-compendium-of-r-scripts.html#cb65-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in the area </span></span>
<span id="cb65-19"><a href="annex-i-compendium-of-r-scripts.html#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb65-20"><a href="annex-i-compendium-of-r-scripts.html#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load necessary packages</span></span>
<span id="cb65-21"><a href="annex-i-compendium-of-r-scripts.html#cb65-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb65-22"><a href="annex-i-compendium-of-r-scripts.html#cb65-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import national data </span></span>
<span id="cb65-23"><a href="annex-i-compendium-of-r-scripts.html#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Calculate the minimum sample size to describe the area</span></span>
<span id="cb65-24"><a href="annex-i-compendium-of-r-scripts.html#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Plot covariate diversity as PCA scores </span></span>
<span id="cb65-25"><a href="annex-i-compendium-of-r-scripts.html#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - KL divergence and % similarity results for growing N samples</span></span>
<span id="cb65-26"><a href="annex-i-compendium-of-r-scripts.html#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Model KL divergence</span></span>
<span id="cb65-27"><a href="annex-i-compendium-of-r-scripts.html#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Determine the minimum sample size for 95% representativeness</span></span>
<span id="cb65-28"><a href="annex-i-compendium-of-r-scripts.html#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Determine the optimal iteration according to the minimum N size </span></span>
<span id="cb65-29"><a href="annex-i-compendium-of-r-scripts.html#cb65-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot minimum points from best iteration</span></span>
<span id="cb65-30"><a href="annex-i-compendium-of-r-scripts.html#cb65-30" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb65-31"><a href="annex-i-compendium-of-r-scripts.html#cb65-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-32"><a href="annex-i-compendium-of-r-scripts.html#cb65-32" aria-hidden="true" tabindex="-1"></a> start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb65-33"><a href="annex-i-compendium-of-r-scripts.html#cb65-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-34"><a href="annex-i-compendium-of-r-scripts.html#cb65-34" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load necessary packages =======================</span></span>
<span id="cb65-35"><a href="annex-i-compendium-of-r-scripts.html#cb65-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-36"><a href="annex-i-compendium-of-r-scripts.html#cb65-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb65-37"><a href="annex-i-compendium-of-r-scripts.html#cb65-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb65-38"><a href="annex-i-compendium-of-r-scripts.html#cb65-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb65-39"><a href="annex-i-compendium-of-r-scripts.html#cb65-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-40"><a href="annex-i-compendium-of-r-scripts.html#cb65-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of packages</span></span>
<span id="cb65-41"><a href="annex-i-compendium-of-r-scripts.html#cb65-41" aria-hidden="true" tabindex="-1"></a>  packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;terra&quot;</span>,<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sf&quot;</span>,<span class="st">&quot;clhs&quot;</span>,</span>
<span id="cb65-42"><a href="annex-i-compendium-of-r-scripts.html#cb65-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;sgsR&quot;</span>,<span class="st">&quot;entropy&quot;</span>, <span class="st">&quot;tripack&quot;</span>,</span>
<span id="cb65-43"><a href="annex-i-compendium-of-r-scripts.html#cb65-43" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;manipulate&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;plotly&quot;</span>,<span class="st">&quot;synoptReg&quot;</span>)</span>
<span id="cb65-44"><a href="annex-i-compendium-of-r-scripts.html#cb65-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-45"><a href="annex-i-compendium-of-r-scripts.html#cb65-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages</span></span>
<span id="cb65-46"><a href="annex-i-compendium-of-r-scripts.html#cb65-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>) </span>
<span id="cb65-47"><a href="annex-i-compendium-of-r-scripts.html#cb65-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(packages) <span class="co"># Remove object to save memory space</span></span>
<span id="cb65-48"><a href="annex-i-compendium-of-r-scripts.html#cb65-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-49"><a href="annex-i-compendium-of-r-scripts.html#cb65-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-50"><a href="annex-i-compendium-of-r-scripts.html#cb65-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-51"><a href="annex-i-compendium-of-r-scripts.html#cb65-51" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb65-52"><a href="annex-i-compendium-of-r-scripts.html#cb65-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to rasters</span></span>
<span id="cb65-53"><a href="annex-i-compendium-of-r-scripts.html#cb65-53" aria-hidden="true" tabindex="-1"></a>  raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters/&quot;</span></span>
<span id="cb65-54"><a href="annex-i-compendium-of-r-scripts.html#cb65-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to shapes</span></span>
<span id="cb65-55"><a href="annex-i-compendium-of-r-scripts.html#cb65-55" aria-hidden="true" tabindex="-1"></a>  shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes/&quot;</span></span>
<span id="cb65-56"><a href="annex-i-compendium-of-r-scripts.html#cb65-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to results</span></span>
<span id="cb65-57"><a href="annex-i-compendium-of-r-scripts.html#cb65-57" aria-hidden="true" tabindex="-1"></a>  results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb65-58"><a href="annex-i-compendium-of-r-scripts.html#cb65-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregation factor for up-scaling raster covariates (optional)</span></span>
<span id="cb65-59"><a href="annex-i-compendium-of-r-scripts.html#cb65-59" aria-hidden="true" tabindex="-1"></a>  agg.factor <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb65-60"><a href="annex-i-compendium-of-r-scripts.html#cb65-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-61"><a href="annex-i-compendium-of-r-scripts.html#cb65-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Define parameters to determine minimum sampling size</span></span>
<span id="cb65-62"><a href="annex-i-compendium-of-r-scripts.html#cb65-62" aria-hidden="true" tabindex="-1"></a>  initial.n <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="co"># Initial sampling size to test</span></span>
<span id="cb65-63"><a href="annex-i-compendium-of-r-scripts.html#cb65-63" aria-hidden="true" tabindex="-1"></a>  final.n <span class="ot">&lt;-</span> <span class="dv">300</span> <span class="co"># Final sampling size to test</span></span>
<span id="cb65-64"><a href="annex-i-compendium-of-r-scripts.html#cb65-64" aria-hidden="true" tabindex="-1"></a>  by.n <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># Increment size</span></span>
<span id="cb65-65"><a href="annex-i-compendium-of-r-scripts.html#cb65-65" aria-hidden="true" tabindex="-1"></a>  iters <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># Number of trials on each size</span></span>
<span id="cb65-66"><a href="annex-i-compendium-of-r-scripts.html#cb65-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-67"><a href="annex-i-compendium-of-r-scripts.html#cb65-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-68"><a href="annex-i-compendium-of-r-scripts.html#cb65-68" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Import national data ====================================================</span></span>
<span id="cb65-69"><a href="annex-i-compendium-of-r-scripts.html#cb65-69" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Load raster covariate data</span></span>
<span id="cb65-70"><a href="annex-i-compendium-of-r-scripts.html#cb65-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb65-71"><a href="annex-i-compendium-of-r-scripts.html#cb65-71" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(raster.path, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-72"><a href="annex-i-compendium-of-r-scripts.html#cb65-72" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat) <span class="co"># SpatRaster from terra</span></span>
<span id="cb65-73"><a href="annex-i-compendium-of-r-scripts.html#cb65-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate stack to simplify data rasters for calculations </span></span>
<span id="cb65-74"><a href="annex-i-compendium-of-r-scripts.html#cb65-74" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(cov.dat, <span class="at">fact=</span>agg.factor, <span class="at">fun=</span><span class="st">&quot;mean&quot;</span>)</span>
<span id="cb65-75"><a href="annex-i-compendium-of-r-scripts.html#cb65-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load shape of district</span></span>
<span id="cb65-76"><a href="annex-i-compendium-of-r-scripts.html#cb65-76" aria-hidden="true" tabindex="-1"></a>  nghe <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/Nghe_An.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb65-77"><a href="annex-i-compendium-of-r-scripts.html#cb65-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-78"><a href="annex-i-compendium-of-r-scripts.html#cb65-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crop covariates on administrative boundary</span></span>
<span id="cb65-79"><a href="annex-i-compendium-of-r-scripts.html#cb65-79" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb65-80"><a href="annex-i-compendium-of-r-scripts.html#cb65-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store elevation and slope separately</span></span>
<span id="cb65-81"><a href="annex-i-compendium-of-r-scripts.html#cb65-81" aria-hidden="true" tabindex="-1"></a>  elevation <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_elevation_250m</span>
<span id="cb65-82"><a href="annex-i-compendium-of-r-scripts.html#cb65-82" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_slope_250m</span>
<span id="cb65-83"><a href="annex-i-compendium-of-r-scripts.html#cb65-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-84"><a href="annex-i-compendium-of-r-scripts.html#cb65-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load roads</span></span>
<span id="cb65-85"><a href="annex-i-compendium-of-r-scripts.html#cb65-85" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span>  <span class="fu">vect</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/roads.shp&quot;</span>)))</span>
<span id="cb65-86"><a href="annex-i-compendium-of-r-scripts.html#cb65-86" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span> <span class="fu">crop</span>(roads, nghe)</span>
<span id="cb65-87"><a href="annex-i-compendium-of-r-scripts.html#cb65-87" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb65-88"><a href="annex-i-compendium-of-r-scripts.html#cb65-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simplify raster information with PCA</span></span>
<span id="cb65-89"><a href="annex-i-compendium-of-r-scripts.html#cb65-89" aria-hidden="true" tabindex="-1"></a>  pca <span class="ot">&lt;-</span> <span class="fu">raster_pca</span>(cov.dat)</span>
<span id="cb65-90"><a href="annex-i-compendium-of-r-scripts.html#cb65-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-91"><a href="annex-i-compendium-of-r-scripts.html#cb65-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get SpatRaster layers</span></span>
<span id="cb65-92"><a href="annex-i-compendium-of-r-scripts.html#cb65-92" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb65-93"><a href="annex-i-compendium-of-r-scripts.html#cb65-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a raster stack to be used as input in the clhs::clhs function </span></span>
<span id="cb65-94"><a href="annex-i-compendium-of-r-scripts.html#cb65-94" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat) </span>
<span id="cb65-95"><a href="annex-i-compendium-of-r-scripts.html#cb65-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset rasters</span></span>
<span id="cb65-96"><a href="annex-i-compendium-of-r-scripts.html#cb65-96" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb65-97"><a href="annex-i-compendium-of-r-scripts.html#cb65-97" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span>  cov.dat.ras[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb65-98"><a href="annex-i-compendium-of-r-scripts.html#cb65-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot covariates</span></span>
<span id="cb65-99"><a href="annex-i-compendium-of-r-scripts.html#cb65-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat)</span>
<span id="cb65-100"><a href="annex-i-compendium-of-r-scripts.html#cb65-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-101"><a href="annex-i-compendium-of-r-scripts.html#cb65-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-102"><a href="annex-i-compendium-of-r-scripts.html#cb65-102" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Calculate the minimum sample size to describe the area ===================</span></span>
<span id="cb65-103"><a href="annex-i-compendium-of-r-scripts.html#cb65-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start computations ----</span></span>
<span id="cb65-104"><a href="annex-i-compendium-of-r-scripts.html#cb65-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize empty vectors to store results</span></span>
<span id="cb65-105"><a href="annex-i-compendium-of-r-scripts.html#cb65-105" aria-hidden="true" tabindex="-1"></a>  number_of_samples <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb65-106"><a href="annex-i-compendium-of-r-scripts.html#cb65-106" aria-hidden="true" tabindex="-1"></a>  prop_explained <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb65-107"><a href="annex-i-compendium-of-r-scripts.html#cb65-107" aria-hidden="true" tabindex="-1"></a>  klo_samples <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb65-108"><a href="annex-i-compendium-of-r-scripts.html#cb65-108" aria-hidden="true" tabindex="-1"></a>  samples_storage <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb65-109"><a href="annex-i-compendium-of-r-scripts.html#cb65-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-110"><a href="annex-i-compendium-of-r-scripts.html#cb65-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert SpatRaster to dataframe</span></span>
<span id="cb65-111"><a href="annex-i-compendium-of-r-scripts.html#cb65-111" aria-hidden="true" tabindex="-1"></a>  cov.dat.df <span class="ot">&lt;-</span>  <span class="fu">as.data.frame</span>(cov.dat)</span>
<span id="cb65-112"><a href="annex-i-compendium-of-r-scripts.html#cb65-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-113"><a href="annex-i-compendium-of-r-scripts.html#cb65-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start evaluation with growing sample sizes</span></span>
<span id="cb65-114"><a href="annex-i-compendium-of-r-scripts.html#cb65-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (trial <span class="cf">in</span> <span class="fu">seq</span>(initial.n, final.n, <span class="at">by =</span> by.n)) {</span>
<span id="cb65-115"><a href="annex-i-compendium-of-r-scripts.html#cb65-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (iteration <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>iters) {</span>
<span id="cb65-116"><a href="annex-i-compendium-of-r-scripts.html#cb65-116" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Generate stratified clhs samples</span></span>
<span id="cb65-117"><a href="annex-i-compendium-of-r-scripts.html#cb65-117" aria-hidden="true" tabindex="-1"></a>      p.dat_I <span class="ot">&lt;-</span>  <span class="fu">clhs</span>(cov.dat.ras,</span>
<span id="cb65-118"><a href="annex-i-compendium-of-r-scripts.html#cb65-118" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> trial, <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb65-119"><a href="annex-i-compendium-of-r-scripts.html#cb65-119" aria-hidden="true" tabindex="-1"></a>          <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb65-120"><a href="annex-i-compendium-of-r-scripts.html#cb65-120" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-121"><a href="annex-i-compendium-of-r-scripts.html#cb65-121" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Get covariate values and coordinates for each point</span></span>
<span id="cb65-122"><a href="annex-i-compendium-of-r-scripts.html#cb65-122" aria-hidden="true" tabindex="-1"></a>      p.dat_I <span class="ot">&lt;-</span> p.dat_I<span class="sc">$</span>sampled_data</span>
<span id="cb65-123"><a href="annex-i-compendium-of-r-scripts.html#cb65-123" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Get covariate values as dataframe and delete NAs</span></span>
<span id="cb65-124"><a href="annex-i-compendium-of-r-scripts.html#cb65-124" aria-hidden="true" tabindex="-1"></a>      p.dat_I.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(p.dat_I<span class="sc">@</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb65-125"><a href="annex-i-compendium-of-r-scripts.html#cb65-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">na.omit</span>()</span>
<span id="cb65-126"><a href="annex-i-compendium-of-r-scripts.html#cb65-126" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-127"><a href="annex-i-compendium-of-r-scripts.html#cb65-127" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Store samples as list</span></span>
<span id="cb65-128"><a href="annex-i-compendium-of-r-scripts.html#cb65-128" aria-hidden="true" tabindex="-1"></a>      samples_storage[[<span class="fu">paste0</span>(<span class="st">&quot;N&quot;</span>, trial, <span class="st">&quot;_&quot;</span>, iteration)]] <span class="ot">&lt;-</span> p.dat_I</span>
<span id="cb65-129"><a href="annex-i-compendium-of-r-scripts.html#cb65-129" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-130"><a href="annex-i-compendium-of-r-scripts.html#cb65-130" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Comparison of population and sample distributions - Kullback-Leibler (KL) divergence</span></span>
<span id="cb65-131"><a href="annex-i-compendium-of-r-scripts.html#cb65-131" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Define quantiles of the study area (number of bins)</span></span>
<span id="cb65-132"><a href="annex-i-compendium-of-r-scripts.html#cb65-132" aria-hidden="true" tabindex="-1"></a>      nb <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb65-133"><a href="annex-i-compendium-of-r-scripts.html#cb65-133" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Quantile matrix of the covariate data</span></span>
<span id="cb65-134"><a href="annex-i-compendium-of-r-scripts.html#cb65-134" aria-hidden="true" tabindex="-1"></a>      q.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> (nb <span class="sc">+</span> <span class="dv">1</span>), <span class="at">ncol =</span> <span class="fu">nlyr</span>(cov.dat))</span>
<span id="cb65-135"><a href="annex-i-compendium-of-r-scripts.html#cb65-135" aria-hidden="true" tabindex="-1"></a>      j <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb65-136"><a href="annex-i-compendium-of-r-scripts.html#cb65-136" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(cov.dat)) {</span>
<span id="cb65-137"><a href="annex-i-compendium-of-r-scripts.html#cb65-137" aria-hidden="true" tabindex="-1"></a>        ran1 <span class="ot">&lt;-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>]</span>
<span id="cb65-138"><a href="annex-i-compendium-of-r-scripts.html#cb65-138" aria-hidden="true" tabindex="-1"></a>        step1 <span class="ot">&lt;-</span> ran1 <span class="sc">/</span> nb</span>
<span id="cb65-139"><a href="annex-i-compendium-of-r-scripts.html#cb65-139" aria-hidden="true" tabindex="-1"></a>        q.mat[, j] <span class="ot">&lt;-</span></span>
<span id="cb65-140"><a href="annex-i-compendium-of-r-scripts.html#cb65-140" aria-hidden="true" tabindex="-1"></a>          <span class="fu">seq</span>(<span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">1</span>],</span>
<span id="cb65-141"><a href="annex-i-compendium-of-r-scripts.html#cb65-141" aria-hidden="true" tabindex="-1"></a>              <span class="at">to =</span> <span class="fu">minmax</span>(cov.dat[[i]])[<span class="dv">2</span>],</span>
<span id="cb65-142"><a href="annex-i-compendium-of-r-scripts.html#cb65-142" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> step1)</span>
<span id="cb65-143"><a href="annex-i-compendium-of-r-scripts.html#cb65-143" aria-hidden="true" tabindex="-1"></a>        j <span class="ot">&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb65-144"><a href="annex-i-compendium-of-r-scripts.html#cb65-144" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb65-145"><a href="annex-i-compendium-of-r-scripts.html#cb65-145" aria-hidden="true" tabindex="-1"></a>      <span class="co"># q.mat</span></span>
<span id="cb65-146"><a href="annex-i-compendium-of-r-scripts.html#cb65-146" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-147"><a href="annex-i-compendium-of-r-scripts.html#cb65-147" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Hypercube of covariates in study area</span></span>
<span id="cb65-148"><a href="annex-i-compendium-of-r-scripts.html#cb65-148" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Initialize the covariate matrix</span></span>
<span id="cb65-149"><a href="annex-i-compendium-of-r-scripts.html#cb65-149" aria-hidden="true" tabindex="-1"></a>      cov.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb65-150"><a href="annex-i-compendium-of-r-scripts.html#cb65-150" aria-hidden="true" tabindex="-1"></a>      cov.dat.mx <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cov.dat.df)</span>
<span id="cb65-151"><a href="annex-i-compendium-of-r-scripts.html#cb65-151" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cov.dat.mx)) {</span>
<span id="cb65-152"><a href="annex-i-compendium-of-r-scripts.html#cb65-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.mx)) {</span>
<span id="cb65-153"><a href="annex-i-compendium-of-r-scripts.html#cb65-153" aria-hidden="true" tabindex="-1"></a>          dd <span class="ot">&lt;-</span> cov.dat.mx[[i, j]]</span>
<span id="cb65-154"><a href="annex-i-compendium-of-r-scripts.html#cb65-154" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-155"><a href="annex-i-compendium-of-r-scripts.html#cb65-155" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb65-156"><a href="annex-i-compendium-of-r-scripts.html#cb65-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb65-157"><a href="annex-i-compendium-of-r-scripts.html#cb65-157" aria-hidden="true" tabindex="-1"></a>              kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb65-158"><a href="annex-i-compendium-of-r-scripts.html#cb65-158" aria-hidden="true" tabindex="-1"></a>              ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb65-159"><a href="annex-i-compendium-of-r-scripts.html#cb65-159" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb65-160"><a href="annex-i-compendium-of-r-scripts.html#cb65-160" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb65-161"><a href="annex-i-compendium-of-r-scripts.html#cb65-161" aria-hidden="true" tabindex="-1"></a>                cov.mat[k, j] <span class="ot">&lt;-</span> cov.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb65-162"><a href="annex-i-compendium-of-r-scripts.html#cb65-162" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb65-163"><a href="annex-i-compendium-of-r-scripts.html#cb65-163" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb65-164"><a href="annex-i-compendium-of-r-scripts.html#cb65-164" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb65-165"><a href="annex-i-compendium-of-r-scripts.html#cb65-165" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb65-166"><a href="annex-i-compendium-of-r-scripts.html#cb65-166" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb65-167"><a href="annex-i-compendium-of-r-scripts.html#cb65-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-168"><a href="annex-i-compendium-of-r-scripts.html#cb65-168" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compare whole study area covariate space with the selected sample</span></span>
<span id="cb65-169"><a href="annex-i-compendium-of-r-scripts.html#cb65-169" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Sample data hypercube (the same as for the raster data but on the sample data)</span></span>
<span id="cb65-170"><a href="annex-i-compendium-of-r-scripts.html#cb65-170" aria-hidden="true" tabindex="-1"></a>      h.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> nb, <span class="at">ncol =</span> <span class="fu">ncol</span>(q.mat))</span>
<span id="cb65-171"><a href="annex-i-compendium-of-r-scripts.html#cb65-171" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p.dat_I.df)) {</span>
<span id="cb65-172"><a href="annex-i-compendium-of-r-scripts.html#cb65-172" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(p.dat_I.df)) {</span>
<span id="cb65-173"><a href="annex-i-compendium-of-r-scripts.html#cb65-173" aria-hidden="true" tabindex="-1"></a>          dd <span class="ot">&lt;-</span> p.dat_I.df[i, j]</span>
<span id="cb65-174"><a href="annex-i-compendium-of-r-scripts.html#cb65-174" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb65-175"><a href="annex-i-compendium-of-r-scripts.html#cb65-175" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(dd)) {</span>
<span id="cb65-176"><a href="annex-i-compendium-of-r-scripts.html#cb65-176" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb) {</span>
<span id="cb65-177"><a href="annex-i-compendium-of-r-scripts.html#cb65-177" aria-hidden="true" tabindex="-1"></a>              kl <span class="ot">&lt;-</span> q.mat[k, j]</span>
<span id="cb65-178"><a href="annex-i-compendium-of-r-scripts.html#cb65-178" aria-hidden="true" tabindex="-1"></a>              ku <span class="ot">&lt;-</span> q.mat[k <span class="sc">+</span> <span class="dv">1</span>, j]</span>
<span id="cb65-179"><a href="annex-i-compendium-of-r-scripts.html#cb65-179" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb65-180"><a href="annex-i-compendium-of-r-scripts.html#cb65-180" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (dd <span class="sc">&gt;=</span> kl <span class="sc">&amp;&amp;</span> dd <span class="sc">&lt;=</span> ku) {</span>
<span id="cb65-181"><a href="annex-i-compendium-of-r-scripts.html#cb65-181" aria-hidden="true" tabindex="-1"></a>                h.mat[k, j] <span class="ot">&lt;-</span> h.mat[k, j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb65-182"><a href="annex-i-compendium-of-r-scripts.html#cb65-182" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb65-183"><a href="annex-i-compendium-of-r-scripts.html#cb65-183" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb65-184"><a href="annex-i-compendium-of-r-scripts.html#cb65-184" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb65-185"><a href="annex-i-compendium-of-r-scripts.html#cb65-185" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb65-186"><a href="annex-i-compendium-of-r-scripts.html#cb65-186" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb65-187"><a href="annex-i-compendium-of-r-scripts.html#cb65-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-188"><a href="annex-i-compendium-of-r-scripts.html#cb65-188" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Compute Kullback-Leibler (KL) divergence</span></span>
<span id="cb65-189"><a href="annex-i-compendium-of-r-scripts.html#cb65-189" aria-hidden="true" tabindex="-1"></a>      kl.index <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb65-190"><a href="annex-i-compendium-of-r-scripts.html#cb65-190" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(cov.dat.df)) {</span>
<span id="cb65-191"><a href="annex-i-compendium-of-r-scripts.html#cb65-191" aria-hidden="true" tabindex="-1"></a>        kl <span class="ot">&lt;-</span>    <span class="fu">KL.empirical</span>(<span class="fu">c</span>(cov.mat[, i]), <span class="fu">c</span>(h.mat[, i]))</span>
<span id="cb65-192"><a href="annex-i-compendium-of-r-scripts.html#cb65-192" aria-hidden="true" tabindex="-1"></a>        kl.index <span class="ot">&lt;-</span> <span class="fu">c</span>(kl.index, kl)</span>
<span id="cb65-193"><a href="annex-i-compendium-of-r-scripts.html#cb65-193" aria-hidden="true" tabindex="-1"></a>        klo <span class="ot">&lt;-</span>  <span class="fu">mean</span>(kl.index)</span>
<span id="cb65-194"><a href="annex-i-compendium-of-r-scripts.html#cb65-194" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb65-195"><a href="annex-i-compendium-of-r-scripts.html#cb65-195" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-196"><a href="annex-i-compendium-of-r-scripts.html#cb65-196" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Calculate the proportion of &quot;env. variables&quot; in the covariate spectra that fall within the convex hull of variables in the &quot;environmental sample space&quot;</span></span>
<span id="cb65-197"><a href="annex-i-compendium-of-r-scripts.html#cb65-197" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Principal component of the data sample</span></span>
<span id="cb65-198"><a href="annex-i-compendium-of-r-scripts.html#cb65-198" aria-hidden="true" tabindex="-1"></a>      pca.s <span class="ot">=</span> <span class="fu">prcomp</span>(p.dat_I.df, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-199"><a href="annex-i-compendium-of-r-scripts.html#cb65-199" aria-hidden="true" tabindex="-1"></a>      scores_pca1 <span class="ot">=</span> <span class="fu">as.data.frame</span>(pca.s<span class="sc">$</span>x)</span>
<span id="cb65-200"><a href="annex-i-compendium-of-r-scripts.html#cb65-200" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Plot the first 2 principal components and convex hull</span></span>
<span id="cb65-201"><a href="annex-i-compendium-of-r-scripts.html#cb65-201" aria-hidden="true" tabindex="-1"></a>      rand.tr <span class="ot">&lt;-</span></span>
<span id="cb65-202"><a href="annex-i-compendium-of-r-scripts.html#cb65-202" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tri.mesh</span>(scores_pca1[, <span class="dv">1</span>], scores_pca1[, <span class="dv">2</span>], <span class="st">&quot;remove&quot;</span>) <span class="co"># Delaunay triangulation</span></span>
<span id="cb65-203"><a href="annex-i-compendium-of-r-scripts.html#cb65-203" aria-hidden="true" tabindex="-1"></a>      rand.ch <span class="ot">&lt;-</span> <span class="fu">convex.hull</span>(rand.tr, <span class="at">plot.it =</span> F) <span class="co"># convex hull</span></span>
<span id="cb65-204"><a href="annex-i-compendium-of-r-scripts.html#cb65-204" aria-hidden="true" tabindex="-1"></a>      pr_poly <span class="ot">&lt;-</span></span>
<span id="cb65-205"><a href="annex-i-compendium-of-r-scripts.html#cb65-205" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cbind</span>(<span class="at">x =</span> <span class="fu">c</span>(rand.ch<span class="sc">$</span>x), <span class="at">y =</span> <span class="fu">c</span>(rand.ch<span class="sc">$</span>y)) <span class="co"># save the convex hull vertices</span></span>
<span id="cb65-206"><a href="annex-i-compendium-of-r-scripts.html#cb65-206" aria-hidden="true" tabindex="-1"></a>      <span class="co"># PCA projection of study area population onto the principal components</span></span>
<span id="cb65-207"><a href="annex-i-compendium-of-r-scripts.html#cb65-207" aria-hidden="true" tabindex="-1"></a>      PCA_projection <span class="ot">&lt;-</span></span>
<span id="cb65-208"><a href="annex-i-compendium-of-r-scripts.html#cb65-208" aria-hidden="true" tabindex="-1"></a>        <span class="fu">predict</span>(pca.s, cov.dat.df) <span class="co"># Project study area population onto sample PC</span></span>
<span id="cb65-209"><a href="annex-i-compendium-of-r-scripts.html#cb65-209" aria-hidden="true" tabindex="-1"></a>      newScores <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">x =</span> PCA_projection[, <span class="dv">1</span>], <span class="at">y =</span> PCA_projection[, <span class="dv">2</span>]) <span class="co"># PC scores of projected population</span></span>
<span id="cb65-210"><a href="annex-i-compendium-of-r-scripts.html#cb65-210" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Check which points fall within the polygon</span></span>
<span id="cb65-211"><a href="annex-i-compendium-of-r-scripts.html#cb65-211" aria-hidden="true" tabindex="-1"></a>      pip <span class="ot">&lt;-</span></span>
<span id="cb65-212"><a href="annex-i-compendium-of-r-scripts.html#cb65-212" aria-hidden="true" tabindex="-1"></a>        <span class="fu">point.in.polygon</span>(newScores[, <span class="dv">2</span>], newScores[, <span class="dv">1</span>], pr_poly[, <span class="dv">2</span>], pr_poly[, <span class="dv">1</span>], <span class="at">mode.checked =</span></span>
<span id="cb65-213"><a href="annex-i-compendium-of-r-scripts.html#cb65-213" aria-hidden="true" tabindex="-1"></a>                           <span class="cn">FALSE</span>)</span>
<span id="cb65-214"><a href="annex-i-compendium-of-r-scripts.html#cb65-214" aria-hidden="true" tabindex="-1"></a>      newScores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(newScores, pip))</span>
<span id="cb65-215"><a href="annex-i-compendium-of-r-scripts.html#cb65-215" aria-hidden="true" tabindex="-1"></a>      klo_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(klo_samples, klo)</span>
<span id="cb65-216"><a href="annex-i-compendium-of-r-scripts.html#cb65-216" aria-hidden="true" tabindex="-1"></a>      prop_explained <span class="ot">&lt;-</span></span>
<span id="cb65-217"><a href="annex-i-compendium-of-r-scripts.html#cb65-217" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(prop_explained, <span class="fu">sum</span>(newScores<span class="sc">$</span>pip) <span class="sc">/</span> <span class="fu">nrow</span>(newScores) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb65-218"><a href="annex-i-compendium-of-r-scripts.html#cb65-218" aria-hidden="true" tabindex="-1"></a>      number_of_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(number_of_samples, trial)</span>
<span id="cb65-219"><a href="annex-i-compendium-of-r-scripts.html#cb65-219" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(</span>
<span id="cb65-220"><a href="annex-i-compendium-of-r-scripts.html#cb65-220" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste</span>(</span>
<span id="cb65-221"><a href="annex-i-compendium-of-r-scripts.html#cb65-221" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;N samples = &quot;</span>,</span>
<span id="cb65-222"><a href="annex-i-compendium-of-r-scripts.html#cb65-222" aria-hidden="true" tabindex="-1"></a>          trial,</span>
<span id="cb65-223"><a href="annex-i-compendium-of-r-scripts.html#cb65-223" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot; out of &quot;</span>,</span>
<span id="cb65-224"><a href="annex-i-compendium-of-r-scripts.html#cb65-224" aria-hidden="true" tabindex="-1"></a>          final.n,</span>
<span id="cb65-225"><a href="annex-i-compendium-of-r-scripts.html#cb65-225" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;; iteration = &quot;</span>,</span>
<span id="cb65-226"><a href="annex-i-compendium-of-r-scripts.html#cb65-226" aria-hidden="true" tabindex="-1"></a>          iteration,</span>
<span id="cb65-227"><a href="annex-i-compendium-of-r-scripts.html#cb65-227" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;; KL = &quot;</span>,</span>
<span id="cb65-228"><a href="annex-i-compendium-of-r-scripts.html#cb65-228" aria-hidden="true" tabindex="-1"></a>          klo,</span>
<span id="cb65-229"><a href="annex-i-compendium-of-r-scripts.html#cb65-229" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;; Proportion = &quot;</span>,</span>
<span id="cb65-230"><a href="annex-i-compendium-of-r-scripts.html#cb65-230" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(newScores<span class="sc">$</span>pip) <span class="sc">/</span> <span class="fu">nrow</span>(newScores) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb65-231"><a href="annex-i-compendium-of-r-scripts.html#cb65-231" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-232"><a href="annex-i-compendium-of-r-scripts.html#cb65-232" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb65-233"><a href="annex-i-compendium-of-r-scripts.html#cb65-233" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb65-234"><a href="annex-i-compendium-of-r-scripts.html#cb65-234" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-235"><a href="annex-i-compendium-of-r-scripts.html#cb65-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-236"><a href="annex-i-compendium-of-r-scripts.html#cb65-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-237"><a href="annex-i-compendium-of-r-scripts.html#cb65-237" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Plot covariate diversity as PCA scores ===================================</span></span>
<span id="cb65-238"><a href="annex-i-compendium-of-r-scripts.html#cb65-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb65-239"><a href="annex-i-compendium-of-r-scripts.html#cb65-239" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">&quot;PCA 1&quot;</span>,</span>
<span id="cb65-240"><a href="annex-i-compendium-of-r-scripts.html#cb65-240" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">&quot;PCA 2&quot;</span>,</span>
<span id="cb65-241"><a href="annex-i-compendium-of-r-scripts.html#cb65-241" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T)),</span>
<span id="cb65-242"><a href="annex-i-compendium-of-r-scripts.html#cb65-242" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T), <span class="fu">max</span>(newScores[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">na.rm =</span> T)),</span>
<span id="cb65-243"><a href="annex-i-compendium-of-r-scripts.html#cb65-243" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">&#39;black&#39;</span>,</span>
<span id="cb65-244"><a href="annex-i-compendium-of-r-scripts.html#cb65-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&#39;Environmental space plots on convex hull of soil samples&#39;</span>)</span>
<span id="cb65-245"><a href="annex-i-compendium-of-r-scripts.html#cb65-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-246"><a href="annex-i-compendium-of-r-scripts.html#cb65-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(pr_poly, <span class="at">col =</span> <span class="st">&#39;#99999990&#39;</span>)</span>
<span id="cb65-247"><a href="annex-i-compendium-of-r-scripts.html#cb65-247" aria-hidden="true" tabindex="-1"></a><span class="co"># # Plot points outside convex hull</span></span>
<span id="cb65-248"><a href="annex-i-compendium-of-r-scripts.html#cb65-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(newScores[<span class="fu">which</span>(newScores<span class="sc">$</span>pip <span class="sc">==</span> <span class="dv">0</span>), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb65-249"><a href="annex-i-compendium-of-r-scripts.html#cb65-249" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="st">&#39;red&#39;</span>,</span>
<span id="cb65-250"><a href="annex-i-compendium-of-r-scripts.html#cb65-250" aria-hidden="true" tabindex="-1"></a>         <span class="at">pch =</span> <span class="dv">12</span>,</span>
<span id="cb65-251"><a href="annex-i-compendium-of-r-scripts.html#cb65-251" aria-hidden="true" tabindex="-1"></a>         <span class="at">cex =</span> <span class="dv">1</span>)</span>
<span id="cb65-252"><a href="annex-i-compendium-of-r-scripts.html#cb65-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-253"><a href="annex-i-compendium-of-r-scripts.html#cb65-253" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - KL divergence and % representativeness for growing N samples =============</span></span>
<span id="cb65-254"><a href="annex-i-compendium-of-r-scripts.html#cb65-254" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge data from number of samples, KL divergence and % representativeness</span></span>
<span id="cb65-255"><a href="annex-i-compendium-of-r-scripts.html#cb65-255" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(number_of_samples, klo_samples, prop_explained)</span>
<span id="cb65-256"><a href="annex-i-compendium-of-r-scripts.html#cb65-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;N&quot;</span>, <span class="st">&quot;KL&quot;</span>, <span class="st">&quot;Perc&quot;</span>)</span>
<span id="cb65-257"><a href="annex-i-compendium-of-r-scripts.html#cb65-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-258"><a href="annex-i-compendium-of-r-scripts.html#cb65-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate mean results by N size</span></span>
<span id="cb65-259"><a href="annex-i-compendium-of-r-scripts.html#cb65-259" aria-hidden="true" tabindex="-1"></a>    mean_result <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb65-260"><a href="annex-i-compendium-of-r-scripts.html#cb65-260" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(N) <span class="sc">%&gt;%</span></span>
<span id="cb65-261"><a href="annex-i-compendium-of-r-scripts.html#cb65-261" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize_all</span>(mean)</span>
<span id="cb65-262"><a href="annex-i-compendium-of-r-scripts.html#cb65-262" aria-hidden="true" tabindex="-1"></a>    mean_result</span>
<span id="cb65-263"><a href="annex-i-compendium-of-r-scripts.html#cb65-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-264"><a href="annex-i-compendium-of-r-scripts.html#cb65-264" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Plot dispersion on KL and % by N</span></span>
<span id="cb65-265"><a href="annex-i-compendium-of-r-scripts.html#cb65-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">6</span>))</span>
<span id="cb65-266"><a href="annex-i-compendium-of-r-scripts.html#cb65-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">boxplot</span>(</span>
<span id="cb65-267"><a href="annex-i-compendium-of-r-scripts.html#cb65-267" aria-hidden="true" tabindex="-1"></a>      Perc <span class="sc">~</span> N,</span>
<span id="cb65-268"><a href="annex-i-compendium-of-r-scripts.html#cb65-268" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> results,</span>
<span id="cb65-269"><a href="annex-i-compendium-of-r-scripts.html#cb65-269" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>),</span>
<span id="cb65-270"><a href="annex-i-compendium-of-r-scripts.html#cb65-270" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylab =</span> <span class="st">&quot;%&quot;</span></span>
<span id="cb65-271"><a href="annex-i-compendium-of-r-scripts.html#cb65-271" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-272"><a href="annex-i-compendium-of-r-scripts.html#cb65-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mtext</span>(<span class="st">&quot;KL divergence&quot;</span>, <span class="at">side =</span> <span class="dv">4</span>, <span class="at">line =</span> <span class="dv">3</span>)</span>
<span id="cb65-273"><a href="annex-i-compendium-of-r-scripts.html#cb65-273" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add new plot</span></span>
<span id="cb65-274"><a href="annex-i-compendium-of-r-scripts.html#cb65-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">new =</span> <span class="cn">TRUE</span>, <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">6</span>))</span>
<span id="cb65-275"><a href="annex-i-compendium-of-r-scripts.html#cb65-275" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Box plot</span></span>
<span id="cb65-276"><a href="annex-i-compendium-of-r-scripts.html#cb65-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">boxplot</span>(</span>
<span id="cb65-277"><a href="annex-i-compendium-of-r-scripts.html#cb65-277" aria-hidden="true" tabindex="-1"></a>      KL <span class="sc">~</span> N,</span>
<span id="cb65-278"><a href="annex-i-compendium-of-r-scripts.html#cb65-278" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> results,</span>
<span id="cb65-279"><a href="annex-i-compendium-of-r-scripts.html#cb65-279" aria-hidden="true" tabindex="-1"></a>      <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb65-280"><a href="annex-i-compendium-of-r-scripts.html#cb65-280" aria-hidden="true" tabindex="-1"></a>      <span class="at">outline =</span> <span class="cn">FALSE</span>,</span>
<span id="cb65-281"><a href="annex-i-compendium-of-r-scripts.html#cb65-281" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="fl">0.8</span>, <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>),</span>
<span id="cb65-282"><a href="annex-i-compendium-of-r-scripts.html#cb65-282" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylab =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb65-283"><a href="annex-i-compendium-of-r-scripts.html#cb65-283" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-284"><a href="annex-i-compendium-of-r-scripts.html#cb65-284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axis</span>(</span>
<span id="cb65-285"><a href="annex-i-compendium-of-r-scripts.html#cb65-285" aria-hidden="true" tabindex="-1"></a>      <span class="dv">4</span>,</span>
<span id="cb65-286"><a href="annex-i-compendium-of-r-scripts.html#cb65-286" aria-hidden="true" tabindex="-1"></a>      <span class="at">at =</span> <span class="fu">seq</span>(<span class="fl">0.02</span>, <span class="fl">0.36</span>, <span class="at">by =</span> .<span class="dv">06</span>),</span>
<span id="cb65-287"><a href="annex-i-compendium-of-r-scripts.html#cb65-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">seq</span>(<span class="fl">0.02</span>, <span class="fl">0.36</span>, <span class="at">by =</span> .<span class="dv">06</span>),</span>
<span id="cb65-288"><a href="annex-i-compendium-of-r-scripts.html#cb65-288" aria-hidden="true" tabindex="-1"></a>      <span class="at">las =</span> <span class="dv">3</span></span>
<span id="cb65-289"><a href="annex-i-compendium-of-r-scripts.html#cb65-289" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-290"><a href="annex-i-compendium-of-r-scripts.html#cb65-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-291"><a href="annex-i-compendium-of-r-scripts.html#cb65-291" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Model KL divergence ======================================================</span></span>
<span id="cb65-292"><a href="annex-i-compendium-of-r-scripts.html#cb65-292" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create an exponential decay function of the KL divergence</span></span>
<span id="cb65-293"><a href="annex-i-compendium-of-r-scripts.html#cb65-293" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> mean_result<span class="sc">$</span>N</span>
<span id="cb65-294"><a href="annex-i-compendium-of-r-scripts.html#cb65-294" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">=</span> (mean_result<span class="sc">$</span>KL <span class="sc">-</span> <span class="fu">min</span>(mean_result<span class="sc">$</span>KL)) <span class="sc">/</span> (<span class="fu">max</span>(mean_result<span class="sc">$</span>KL) <span class="sc">-</span> <span class="fu">min</span>(mean_result<span class="sc">$</span>KL)) <span class="co">#KL</span></span>
<span id="cb65-295"><a href="annex-i-compendium-of-r-scripts.html#cb65-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-296"><a href="annex-i-compendium-of-r-scripts.html#cb65-296" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parametrize Exponential decay function</span></span>
<span id="cb65-297"><a href="annex-i-compendium-of-r-scripts.html#cb65-297" aria-hidden="true" tabindex="-1"></a>    start <span class="ot">&lt;-</span>  <span class="fu">list</span>()     <span class="co"># Initialize an empty list for the starting values</span></span>
<span id="cb65-298"><a href="annex-i-compendium-of-r-scripts.html#cb65-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-299"><a href="annex-i-compendium-of-r-scripts.html#cb65-299" aria-hidden="true" tabindex="-1"></a>  <span class="co">#fit function</span></span>
<span id="cb65-300"><a href="annex-i-compendium-of-r-scripts.html#cb65-300" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb65-301"><a href="annex-i-compendium-of-r-scripts.html#cb65-301" aria-hidden="true" tabindex="-1"></a>    b0 <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb65-302"><a href="annex-i-compendium-of-r-scripts.html#cb65-302" aria-hidden="true" tabindex="-1"></a>    b1 <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb65-303"><a href="annex-i-compendium-of-r-scripts.html#cb65-303" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-304"><a href="annex-i-compendium-of-r-scripts.html#cb65-304" aria-hidden="true" tabindex="-1"></a>    fit1 <span class="ot">&lt;-</span></span>
<span id="cb65-305"><a href="annex-i-compendium-of-r-scripts.html#cb65-305" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nls</span>(</span>
<span id="cb65-306"><a href="annex-i-compendium-of-r-scripts.html#cb65-306" aria-hidden="true" tabindex="-1"></a>        y <span class="sc">~</span> k <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>b1 <span class="sc">*</span> x) <span class="sc">+</span> b0,</span>
<span id="cb65-307"><a href="annex-i-compendium-of-r-scripts.html#cb65-307" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> <span class="fu">list</span>(<span class="at">k =</span> k, <span class="at">b0 =</span> b0, <span class="at">b1 =</span> b1),</span>
<span id="cb65-308"><a href="annex-i-compendium-of-r-scripts.html#cb65-308" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxiter =</span> <span class="dv">500</span>),</span>
<span id="cb65-309"><a href="annex-i-compendium-of-r-scripts.html#cb65-309" aria-hidden="true" tabindex="-1"></a>        <span class="at">trace =</span> T</span>
<span id="cb65-310"><a href="annex-i-compendium-of-r-scripts.html#cb65-310" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb65-311"><a href="annex-i-compendium-of-r-scripts.html#cb65-311" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(fit1)</span>
<span id="cb65-312"><a href="annex-i-compendium-of-r-scripts.html#cb65-312" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-313"><a href="annex-i-compendium-of-r-scripts.html#cb65-313" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot fit</span></span>
<span id="cb65-314"><a href="annex-i-compendium-of-r-scripts.html#cb65-314" aria-hidden="true" tabindex="-1"></a>    xx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, final.n, <span class="dv">1</span>)</span>
<span id="cb65-315"><a href="annex-i-compendium-of-r-scripts.html#cb65-315" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(x, y)</span>
<span id="cb65-316"><a href="annex-i-compendium-of-r-scripts.html#cb65-316" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(xx, <span class="fu">predict</span>(fit1, <span class="fu">list</span>(<span class="at">x =</span> xx)))</span>
<span id="cb65-317"><a href="annex-i-compendium-of-r-scripts.html#cb65-317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict with vfit function</span></span>
<span id="cb65-318"><a href="annex-i-compendium-of-r-scripts.html#cb65-318" aria-hidden="true" tabindex="-1"></a>    jj <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit1, <span class="fu">list</span>(<span class="at">x =</span> xx))</span>
<span id="cb65-319"><a href="annex-i-compendium-of-r-scripts.html#cb65-319" aria-hidden="true" tabindex="-1"></a>    normalized <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> (jj <span class="sc">-</span> <span class="fu">min</span>(jj)) <span class="sc">/</span> (<span class="fu">max</span>(jj) <span class="sc">-</span> <span class="fu">min</span>(jj))</span>
<span id="cb65-320"><a href="annex-i-compendium-of-r-scripts.html#cb65-320" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-321"><a href="annex-i-compendium-of-r-scripts.html#cb65-321" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-322"><a href="annex-i-compendium-of-r-scripts.html#cb65-322" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Determine the minimum sample size to account for 95% of cumulative probability of the covariate diversity ====</span></span>
<span id="cb65-323"><a href="annex-i-compendium-of-r-scripts.html#cb65-323" aria-hidden="true" tabindex="-1"></a>    minimum_n <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">which</span>(normalized <span class="sc">&lt;</span> <span class="fl">0.95</span>)) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb65-324"><a href="annex-i-compendium-of-r-scripts.html#cb65-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-325"><a href="annex-i-compendium-of-r-scripts.html#cb65-325" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot cdf and minimum sampling point</span></span>
<span id="cb65-326"><a href="annex-i-compendium-of-r-scripts.html#cb65-326" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> xx</span>
<span id="cb65-327"><a href="annex-i-compendium-of-r-scripts.html#cb65-327" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> normalized</span>
<span id="cb65-328"><a href="annex-i-compendium-of-r-scripts.html#cb65-328" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-329"><a href="annex-i-compendium-of-r-scripts.html#cb65-329" aria-hidden="true" tabindex="-1"></a>    mydata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x, y)</span>
<span id="cb65-330"><a href="annex-i-compendium-of-r-scripts.html#cb65-330" aria-hidden="true" tabindex="-1"></a>    opti <span class="ot">&lt;-</span> mydata[mydata<span class="sc">$</span>x <span class="sc">==</span> minimum_n, ]</span>
<span id="cb65-331"><a href="annex-i-compendium-of-r-scripts.html#cb65-331" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-332"><a href="annex-i-compendium-of-r-scripts.html#cb65-332" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_ly</span>(</span>
<span id="cb65-333"><a href="annex-i-compendium-of-r-scripts.html#cb65-333" aria-hidden="true" tabindex="-1"></a>      mydata,</span>
<span id="cb65-334"><a href="annex-i-compendium-of-r-scripts.html#cb65-334" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="sc">~</span> x,</span>
<span id="cb65-335"><a href="annex-i-compendium-of-r-scripts.html#cb65-335" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="sc">~</span> normalized,</span>
<span id="cb65-336"><a href="annex-i-compendium-of-r-scripts.html#cb65-336" aria-hidden="true" tabindex="-1"></a>      <span class="at">mode =</span> <span class="st">&quot;lines+markers&quot;</span>,</span>
<span id="cb65-337"><a href="annex-i-compendium-of-r-scripts.html#cb65-337" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">&quot;scatter&quot;</span>,</span>
<span id="cb65-338"><a href="annex-i-compendium-of-r-scripts.html#cb65-338" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;CDF (1–KL divergence)&quot;</span></span>
<span id="cb65-339"><a href="annex-i-compendium-of-r-scripts.html#cb65-339" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb65-340"><a href="annex-i-compendium-of-r-scripts.html#cb65-340" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_trace</span>(</span>
<span id="cb65-341"><a href="annex-i-compendium-of-r-scripts.html#cb65-341" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="sc">~</span> x,</span>
<span id="cb65-342"><a href="annex-i-compendium-of-r-scripts.html#cb65-342" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">~</span> jj,</span>
<span id="cb65-343"><a href="annex-i-compendium-of-r-scripts.html#cb65-343" aria-hidden="true" tabindex="-1"></a>        <span class="at">mode =</span> <span class="st">&quot;lines+markers&quot;</span>,</span>
<span id="cb65-344"><a href="annex-i-compendium-of-r-scripts.html#cb65-344" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">&quot;scatter&quot;</span>,</span>
<span id="cb65-345"><a href="annex-i-compendium-of-r-scripts.html#cb65-345" aria-hidden="true" tabindex="-1"></a>        <span class="at">yaxis =</span> <span class="st">&quot;y2&quot;</span>,</span>
<span id="cb65-346"><a href="annex-i-compendium-of-r-scripts.html#cb65-346" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;KL divergence&quot;</span></span>
<span id="cb65-347"><a href="annex-i-compendium-of-r-scripts.html#cb65-347" aria-hidden="true" tabindex="-1"></a>      )  <span class="sc">%&gt;%</span></span>
<span id="cb65-348"><a href="annex-i-compendium-of-r-scripts.html#cb65-348" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_trace</span>(</span>
<span id="cb65-349"><a href="annex-i-compendium-of-r-scripts.html#cb65-349" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="sc">~</span> opti<span class="sc">$</span>x,</span>
<span id="cb65-350"><a href="annex-i-compendium-of-r-scripts.html#cb65-350" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">~</span> opti<span class="sc">$</span>y,</span>
<span id="cb65-351"><a href="annex-i-compendium-of-r-scripts.html#cb65-351" aria-hidden="true" tabindex="-1"></a>        <span class="at">yaxis =</span> <span class="st">&quot;y&quot;</span>,</span>
<span id="cb65-352"><a href="annex-i-compendium-of-r-scripts.html#cb65-352" aria-hidden="true" tabindex="-1"></a>        <span class="at">mode =</span> <span class="st">&quot;markers&quot;</span>,</span>
<span id="cb65-353"><a href="annex-i-compendium-of-r-scripts.html#cb65-353" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Minimum N&quot;</span>,</span>
<span id="cb65-354"><a href="annex-i-compendium-of-r-scripts.html#cb65-354" aria-hidden="true" tabindex="-1"></a>        <span class="at">marker =</span> <span class="fu">list</span>(</span>
<span id="cb65-355"><a href="annex-i-compendium-of-r-scripts.html#cb65-355" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">8</span>,</span>
<span id="cb65-356"><a href="annex-i-compendium-of-r-scripts.html#cb65-356" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">&#39;#d62728&#39;</span>,</span>
<span id="cb65-357"><a href="annex-i-compendium-of-r-scripts.html#cb65-357" aria-hidden="true" tabindex="-1"></a>          <span class="at">line =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">&#39;black&#39;</span>, <span class="at">width =</span> <span class="dv">1</span>)</span>
<span id="cb65-358"><a href="annex-i-compendium-of-r-scripts.html#cb65-358" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-359"><a href="annex-i-compendium-of-r-scripts.html#cb65-359" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb65-360"><a href="annex-i-compendium-of-r-scripts.html#cb65-360" aria-hidden="true" tabindex="-1"></a>      <span class="fu">layout</span>(</span>
<span id="cb65-361"><a href="annex-i-compendium-of-r-scripts.html#cb65-361" aria-hidden="true" tabindex="-1"></a>        <span class="at">xaxis =</span> <span class="fu">list</span>(</span>
<span id="cb65-362"><a href="annex-i-compendium-of-r-scripts.html#cb65-362" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">&quot;N&quot;</span>,</span>
<span id="cb65-363"><a href="annex-i-compendium-of-r-scripts.html#cb65-363" aria-hidden="true" tabindex="-1"></a>          <span class="at">showgrid =</span> T,</span>
<span id="cb65-364"><a href="annex-i-compendium-of-r-scripts.html#cb65-364" aria-hidden="true" tabindex="-1"></a>          <span class="at">dtick =</span> <span class="dv">50</span>,</span>
<span id="cb65-365"><a href="annex-i-compendium-of-r-scripts.html#cb65-365" aria-hidden="true" tabindex="-1"></a>          <span class="at">tickfont =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb65-366"><a href="annex-i-compendium-of-r-scripts.html#cb65-366" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb65-367"><a href="annex-i-compendium-of-r-scripts.html#cb65-367" aria-hidden="true" tabindex="-1"></a>        <span class="at">yaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">&quot;1–KL divergence (% CDF)&quot;</span>, <span class="at">showgrid =</span> F),</span>
<span id="cb65-368"><a href="annex-i-compendium-of-r-scripts.html#cb65-368" aria-hidden="true" tabindex="-1"></a>        <span class="at">yaxis2 =</span> <span class="fu">list</span>(</span>
<span id="cb65-369"><a href="annex-i-compendium-of-r-scripts.html#cb65-369" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">&quot;KL divergence&quot;</span>,</span>
<span id="cb65-370"><a href="annex-i-compendium-of-r-scripts.html#cb65-370" aria-hidden="true" tabindex="-1"></a>          <span class="at">overlaying =</span> <span class="st">&quot;y&quot;</span>,</span>
<span id="cb65-371"><a href="annex-i-compendium-of-r-scripts.html#cb65-371" aria-hidden="true" tabindex="-1"></a>          <span class="at">side =</span> <span class="st">&quot;right&quot;</span></span>
<span id="cb65-372"><a href="annex-i-compendium-of-r-scripts.html#cb65-372" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb65-373"><a href="annex-i-compendium-of-r-scripts.html#cb65-373" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend =</span> <span class="fu">list</span>(</span>
<span id="cb65-374"><a href="annex-i-compendium-of-r-scripts.html#cb65-374" aria-hidden="true" tabindex="-1"></a>          <span class="at">orientation =</span> <span class="st">&quot;h&quot;</span>,</span>
<span id="cb65-375"><a href="annex-i-compendium-of-r-scripts.html#cb65-375" aria-hidden="true" tabindex="-1"></a>          <span class="at">y =</span> <span class="fl">1.2</span>,</span>
<span id="cb65-376"><a href="annex-i-compendium-of-r-scripts.html#cb65-376" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> <span class="fl">0.1</span>,</span>
<span id="cb65-377"><a href="annex-i-compendium-of-r-scripts.html#cb65-377" aria-hidden="true" tabindex="-1"></a>          <span class="at">traceorder =</span> <span class="st">&quot;normal&quot;</span></span>
<span id="cb65-378"><a href="annex-i-compendium-of-r-scripts.html#cb65-378" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb65-379"><a href="annex-i-compendium-of-r-scripts.html#cb65-379" aria-hidden="true" tabindex="-1"></a>        <span class="at">margin =</span> <span class="fu">list</span>(</span>
<span id="cb65-380"><a href="annex-i-compendium-of-r-scripts.html#cb65-380" aria-hidden="true" tabindex="-1"></a>          <span class="at">t =</span> <span class="dv">50</span>,</span>
<span id="cb65-381"><a href="annex-i-compendium-of-r-scripts.html#cb65-381" aria-hidden="true" tabindex="-1"></a>          <span class="at">b =</span> <span class="dv">50</span>,</span>
<span id="cb65-382"><a href="annex-i-compendium-of-r-scripts.html#cb65-382" aria-hidden="true" tabindex="-1"></a>          <span class="at">r =</span> <span class="dv">100</span>,</span>
<span id="cb65-383"><a href="annex-i-compendium-of-r-scripts.html#cb65-383" aria-hidden="true" tabindex="-1"></a>          <span class="at">l =</span> <span class="dv">80</span></span>
<span id="cb65-384"><a href="annex-i-compendium-of-r-scripts.html#cb65-384" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb65-385"><a href="annex-i-compendium-of-r-scripts.html#cb65-385" aria-hidden="true" tabindex="-1"></a>        <span class="at">hovermode =</span> <span class="st">&#39;x&#39;</span></span>
<span id="cb65-386"><a href="annex-i-compendium-of-r-scripts.html#cb65-386" aria-hidden="true" tabindex="-1"></a>      )  <span class="sc">%&gt;%</span></span>
<span id="cb65-387"><a href="annex-i-compendium-of-r-scripts.html#cb65-387" aria-hidden="true" tabindex="-1"></a>      <span class="fu">config</span>(<span class="at">displayModeBar =</span> <span class="cn">FALSE</span>)</span>
<span id="cb65-388"><a href="annex-i-compendium-of-r-scripts.html#cb65-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-389"><a href="annex-i-compendium-of-r-scripts.html#cb65-389" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Determine the optimal iteration according to the minimum N size ==========</span></span>
<span id="cb65-390"><a href="annex-i-compendium-of-r-scripts.html#cb65-390" aria-hidden="true" tabindex="-1"></a>  optimal_iteration <span class="ot">&lt;-</span> results[<span class="fu">which</span>(<span class="fu">abs</span>(results<span class="sc">$</span>N <span class="sc">-</span> minimum_n) <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">abs</span>(results<span class="sc">$</span>N <span class="sc">-</span> minimum_n))), ] <span class="sc">%&gt;%</span></span>
<span id="cb65-391"><a href="annex-i-compendium-of-r-scripts.html#cb65-391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">IDX =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb65-392"><a href="annex-i-compendium-of-r-scripts.html#cb65-392" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Perc <span class="sc">==</span> <span class="fu">max</span>(Perc))</span>
<span id="cb65-393"><a href="annex-i-compendium-of-r-scripts.html#cb65-393" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-394"><a href="annex-i-compendium-of-r-scripts.html#cb65-394" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot minimum points from best iteration ==================================</span></span>
<span id="cb65-395"><a href="annex-i-compendium-of-r-scripts.html#cb65-395" aria-hidden="true" tabindex="-1"></a>  N_final <span class="ot">&lt;-</span> samples_storage[<span class="fu">paste0</span>(<span class="st">&quot;N&quot;</span>, optimal_iteration<span class="sc">$</span>N, <span class="st">&quot;_&quot;</span>, optimal_iteration<span class="sc">$</span>IDX)][[<span class="dv">1</span>]]</span>
<span id="cb65-396"><a href="annex-i-compendium-of-r-scripts.html#cb65-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]])</span>
<span id="cb65-397"><a href="annex-i-compendium-of-r-scripts.html#cb65-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(N_final)</span>
<span id="cb65-398"><a href="annex-i-compendium-of-r-scripts.html#cb65-398" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-399"><a href="annex-i-compendium-of-r-scripts.html#cb65-399" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="re">END</span></span></code></pre></div>
</div>
<div id="script-5-stratified-sampling-on-vector-and-raster-data" class="section level2 unnumbered hasAnchor">
<h2>Script 5: Stratified sampling on vector and raster data<a href="annex-i-compendium-of-r-scripts.html#script-5-stratified-sampling-on-vector-and-raster-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This script uses soil and land use classes to define polygon ‘strata’ for an area weighted stratified sampling design.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="annex-i-compendium-of-r-scripts.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb66-2"><a href="annex-i-compendium-of-r-scripts.html#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb66-3"><a href="annex-i-compendium-of-r-scripts.html#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb66-4"><a href="annex-i-compendium-of-r-scripts.html#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified Sampling on &#39;soil-landuse&#39; strata</span></span>
<span id="cb66-5"><a href="annex-i-compendium-of-r-scripts.html#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb66-6"><a href="annex-i-compendium-of-r-scripts.html#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb66-7"><a href="annex-i-compendium-of-r-scripts.html#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co">#          Marcos.Angelini@fao.org</span></span>
<span id="cb66-8"><a href="annex-i-compendium-of-r-scripts.html#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb66-9"><a href="annex-i-compendium-of-r-scripts.html#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="annex-i-compendium-of-r-scripts.html#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empty environment and cache </span></span>
<span id="cb66-11"><a href="annex-i-compendium-of-r-scripts.html#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb66-12"><a href="annex-i-compendium-of-r-scripts.html#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb66-13"><a href="annex-i-compendium-of-r-scripts.html#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="annex-i-compendium-of-r-scripts.html#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script =======================================================</span></span>
<span id="cb66-15"><a href="annex-i-compendium-of-r-scripts.html#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="co"># The goal of this script is to perform random and regular stratified</span></span>
<span id="cb66-16"><a href="annex-i-compendium-of-r-scripts.html#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="co"># soil sampling designs using soil/land-use classes as &#39;strata&#39;</span></span>
<span id="cb66-17"><a href="annex-i-compendium-of-r-scripts.html#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co"># The distribution of samples on the strata is based on a</span></span>
<span id="cb66-18"><a href="annex-i-compendium-of-r-scripts.html#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="co"># weighted area distribution with the requirement of at least 2 sampling points</span></span>
<span id="cb66-19"><a href="annex-i-compendium-of-r-scripts.html#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="co"># by strata. Small polygons (&lt; 100 has) are eliminated from calculations.</span></span>
<span id="cb66-20"><a href="annex-i-compendium-of-r-scripts.html#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Only &#39;strata&#39; classes prone to be samples are included in the analyses.</span></span>
<span id="cb66-21"><a href="annex-i-compendium-of-r-scripts.html#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="co"># The final sample data includes &#39;target&#39; points - i.e. primary sampling points,</span></span>
<span id="cb66-22"><a href="annex-i-compendium-of-r-scripts.html#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="co"># and &#39;replacement&#39; points - i.e. points to be used as replacements in case</span></span>
<span id="cb66-23"><a href="annex-i-compendium-of-r-scripts.html#cb66-23" aria-hidden="true" tabindex="-1"></a><span class="co"># that the corresponding &#39;target&#39; point cannot be sampled for any reason.</span></span>
<span id="cb66-24"><a href="annex-i-compendium-of-r-scripts.html#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb66-25"><a href="annex-i-compendium-of-r-scripts.html#cb66-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load packages</span></span>
<span id="cb66-26"><a href="annex-i-compendium-of-r-scripts.html#cb66-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb66-27"><a href="annex-i-compendium-of-r-scripts.html#cb66-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import data </span></span>
<span id="cb66-28"><a href="annex-i-compendium-of-r-scripts.html#cb66-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Delineate soil strata</span></span>
<span id="cb66-29"><a href="annex-i-compendium-of-r-scripts.html#cb66-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Delineate land-use strata </span></span>
<span id="cb66-30"><a href="annex-i-compendium-of-r-scripts.html#cb66-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Create sampling strata</span></span>
<span id="cb66-31"><a href="annex-i-compendium-of-r-scripts.html#cb66-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Accommodate strata to requirements</span></span>
<span id="cb66-32"><a href="annex-i-compendium-of-r-scripts.html#cb66-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Plot strata</span></span>
<span id="cb66-33"><a href="annex-i-compendium-of-r-scripts.html#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Stratified random sampling</span></span>
<span id="cb66-34"><a href="annex-i-compendium-of-r-scripts.html#cb66-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot points over strata</span></span>
<span id="cb66-35"><a href="annex-i-compendium-of-r-scripts.html#cb66-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 10 - Calculate replacement areas for points</span></span>
<span id="cb66-36"><a href="annex-i-compendium-of-r-scripts.html#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 11 - Stratified regular sampling</span></span>
<span id="cb66-37"><a href="annex-i-compendium-of-r-scripts.html#cb66-37" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb66-38"><a href="annex-i-compendium-of-r-scripts.html#cb66-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-39"><a href="annex-i-compendium-of-r-scripts.html#cb66-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-40"><a href="annex-i-compendium-of-r-scripts.html#cb66-40" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load packages =================================</span></span>
<span id="cb66-41"><a href="annex-i-compendium-of-r-scripts.html#cb66-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-42"><a href="annex-i-compendium-of-r-scripts.html#cb66-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages as a vector objects</span></span>
<span id="cb66-43"><a href="annex-i-compendium-of-r-scripts.html#cb66-43" aria-hidden="true" tabindex="-1"></a>    packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sf&quot;</span>, <span class="st">&quot;terra&quot;</span>, <span class="st">&quot;tidyverse&quot;</span>, <span class="st">&quot;rmapshaper&quot;</span>,</span>
<span id="cb66-44"><a href="annex-i-compendium-of-r-scripts.html#cb66-44" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;units&quot;</span>,<span class="st">&quot;plyr&quot;</span>, <span class="st">&quot;mapview&quot;</span>, <span class="st">&quot;leaflet&quot;</span>)</span>
<span id="cb66-45"><a href="annex-i-compendium-of-r-scripts.html#cb66-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>) <span class="co"># Load packages</span></span>
<span id="cb66-46"><a href="annex-i-compendium-of-r-scripts.html#cb66-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(packages) <span class="co"># Remove object to save memory space </span></span>
<span id="cb66-47"><a href="annex-i-compendium-of-r-scripts.html#cb66-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-48"><a href="annex-i-compendium-of-r-scripts.html#cb66-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb66-49"><a href="annex-i-compendium-of-r-scripts.html#cb66-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb66-50"><a href="annex-i-compendium-of-r-scripts.html#cb66-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-51"><a href="annex-i-compendium-of-r-scripts.html#cb66-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-52"><a href="annex-i-compendium-of-r-scripts.html#cb66-52" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb66-53"><a href="annex-i-compendium-of-r-scripts.html#cb66-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Path to rasters</span></span>
<span id="cb66-54"><a href="annex-i-compendium-of-r-scripts.html#cb66-54" aria-hidden="true" tabindex="-1"></a>    raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters&quot;</span></span>
<span id="cb66-55"><a href="annex-i-compendium-of-r-scripts.html#cb66-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Path to shapes</span></span>
<span id="cb66-56"><a href="annex-i-compendium-of-r-scripts.html#cb66-56" aria-hidden="true" tabindex="-1"></a>    shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes&quot;</span></span>
<span id="cb66-57"><a href="annex-i-compendium-of-r-scripts.html#cb66-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Path to results</span></span>
<span id="cb66-58"><a href="annex-i-compendium-of-r-scripts.html#cb66-58" aria-hidden="true" tabindex="-1"></a>    results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb66-59"><a href="annex-i-compendium-of-r-scripts.html#cb66-59" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="dv">242</span></span>
<span id="cb66-60"><a href="annex-i-compendium-of-r-scripts.html#cb66-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-61"><a href="annex-i-compendium-of-r-scripts.html#cb66-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-62"><a href="annex-i-compendium-of-r-scripts.html#cb66-62" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Import data ====================================================</span></span>
<span id="cb66-63"><a href="annex-i-compendium-of-r-scripts.html#cb66-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load soil data</span></span>
<span id="cb66-64"><a href="annex-i-compendium-of-r-scripts.html#cb66-64" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/soils.shp&quot;</span>),<span class="at">promote_to_multi =</span> <span class="cn">FALSE</span>)  </span>
<span id="cb66-65"><a href="annex-i-compendium-of-r-scripts.html#cb66-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load Landcover data</span></span>
<span id="cb66-66"><a href="annex-i-compendium-of-r-scripts.html#cb66-66" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/landcover.shp&quot;</span>))</span>
<span id="cb66-67"><a href="annex-i-compendium-of-r-scripts.html#cb66-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-68"><a href="annex-i-compendium-of-r-scripts.html#cb66-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define a bounding area (optional).</span></span>
<span id="cb66-69"><a href="annex-i-compendium-of-r-scripts.html#cb66-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If BOUNDING = TRUE, then a bounding–area shapefile (bb) must be specified</span></span>
<span id="cb66-70"><a href="annex-i-compendium-of-r-scripts.html#cb66-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and the line in the code below must be uncommented</span></span>
<span id="cb66-71"><a href="annex-i-compendium-of-r-scripts.html#cb66-71" aria-hidden="true" tabindex="-1"></a>    BOUNDING <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb66-72"><a href="annex-i-compendium-of-r-scripts.html#cb66-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">#bb &lt;- st_read(paste0(shp.path,&quot;/your_bounding_area.shp&quot;))</span></span>
<span id="cb66-73"><a href="annex-i-compendium-of-r-scripts.html#cb66-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-74"><a href="annex-i-compendium-of-r-scripts.html#cb66-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute replacement areas (optional).</span></span>
<span id="cb66-75"><a href="annex-i-compendium-of-r-scripts.html#cb66-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If REPLACEMENT = TRUE, then replacement areas are calculated around a </span></span>
<span id="cb66-76"><a href="annex-i-compendium-of-r-scripts.html#cb66-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># specified buffer distance from target points within the same stratum class</span></span>
<span id="cb66-77"><a href="annex-i-compendium-of-r-scripts.html#cb66-77" aria-hidden="true" tabindex="-1"></a>    REPLACEMENT <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb66-78"><a href="annex-i-compendium-of-r-scripts.html#cb66-78" aria-hidden="true" tabindex="-1"></a>    distance.buffer <span class="ot">=</span> <span class="dv">500</span> <span class="co"># Distance must be adjusted to the coordinate system</span></span>
<span id="cb66-79"><a href="annex-i-compendium-of-r-scripts.html#cb66-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">#bb &lt;- st_read(paste0(shp.path,&quot;/your_bounding_area.shp&quot;))</span></span>
<span id="cb66-80"><a href="annex-i-compendium-of-r-scripts.html#cb66-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-81"><a href="annex-i-compendium-of-r-scripts.html#cb66-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-82"><a href="annex-i-compendium-of-r-scripts.html#cb66-82" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Delineate soil strata =====================================================</span></span>
<span id="cb66-83"><a href="annex-i-compendium-of-r-scripts.html#cb66-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-84"><a href="annex-i-compendium-of-r-scripts.html#cb66-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clip soil data  by bounding area if defined</span></span>
<span id="cb66-85"><a href="annex-i-compendium-of-r-scripts.html#cb66-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (BOUNDING) {</span>
<span id="cb66-86"><a href="annex-i-compendium-of-r-scripts.html#cb66-86" aria-hidden="true" tabindex="-1"></a>      soil <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(soil, bb)</span>
<span id="cb66-87"><a href="annex-i-compendium-of-r-scripts.html#cb66-87" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb66-88"><a href="annex-i-compendium-of-r-scripts.html#cb66-88" aria-hidden="true" tabindex="-1"></a>      soil <span class="ot">&lt;-</span> soil</span>
<span id="cb66-89"><a href="annex-i-compendium-of-r-scripts.html#cb66-89" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-90"><a href="annex-i-compendium-of-r-scripts.html#cb66-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check geometry</span></span>
<span id="cb66-91"><a href="annex-i-compendium-of-r-scripts.html#cb66-91" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(soil)</span>
<span id="cb66-92"><a href="annex-i-compendium-of-r-scripts.html#cb66-92" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(soil, <span class="st">&quot;MULTIPOLYGON&quot;</span>)</span>
<span id="cb66-93"><a href="annex-i-compendium-of-r-scripts.html#cb66-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Aggregate information by reference soil group (SRG)</span></span>
<span id="cb66-94"><a href="annex-i-compendium-of-r-scripts.html#cb66-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">#unique(soil$RSG)</span></span>
<span id="cb66-95"><a href="annex-i-compendium-of-r-scripts.html#cb66-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove NAs (water bodies are deleted)</span></span>
<span id="cb66-96"><a href="annex-i-compendium-of-r-scripts.html#cb66-96" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> soil[<span class="sc">!</span><span class="fu">is.na</span>(soil<span class="sc">$</span>RSG),]</span>
<span id="cb66-97"><a href="annex-i-compendium-of-r-scripts.html#cb66-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">#unique(soil$RSG)</span></span>
<span id="cb66-98"><a href="annex-i-compendium-of-r-scripts.html#cb66-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dissolve polygons by reference soil group</span></span>
<span id="cb66-99"><a href="annex-i-compendium-of-r-scripts.html#cb66-99" aria-hidden="true" tabindex="-1"></a>    soil <span class="ot">&lt;-</span> soil <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(RSG) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">summarize</span>() </span>
<span id="cb66-100"><a href="annex-i-compendium-of-r-scripts.html#cb66-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write soil strata to disk</span></span>
<span id="cb66-101"><a href="annex-i-compendium-of-r-scripts.html#cb66-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(soil, <span class="fu">paste0</span>(results.path,<span class="st">&quot;soil_classes.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-102"><a href="annex-i-compendium-of-r-scripts.html#cb66-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-103"><a href="annex-i-compendium-of-r-scripts.html#cb66-103" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Plot aggregated soil classes</span></span>
<span id="cb66-104"><a href="annex-i-compendium-of-r-scripts.html#cb66-104" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="dv">8</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb66-105"><a href="annex-i-compendium-of-r-scripts.html#cb66-105" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb66-106"><a href="annex-i-compendium-of-r-scripts.html#cb66-106" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil[<span class="st">&quot;RSG&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;soils&quot;</span>, <span class="at">map=</span>map)</span>
<span id="cb66-107"><a href="annex-i-compendium-of-r-scripts.html#cb66-107" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb66-108"><a href="annex-i-compendium-of-r-scripts.html#cb66-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ggplot() + geom_sf(data=soil, aes(fill = factor(RSG)))</span></span>
<span id="cb66-109"><a href="annex-i-compendium-of-r-scripts.html#cb66-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-110"><a href="annex-i-compendium-of-r-scripts.html#cb66-110" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Delineate land-use strata =================================================</span></span>
<span id="cb66-111"><a href="annex-i-compendium-of-r-scripts.html#cb66-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-112"><a href="annex-i-compendium-of-r-scripts.html#cb66-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clip land use data  by bounding area if exist</span></span>
<span id="cb66-113"><a href="annex-i-compendium-of-r-scripts.html#cb66-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (BOUNDING) {</span>
<span id="cb66-114"><a href="annex-i-compendium-of-r-scripts.html#cb66-114" aria-hidden="true" tabindex="-1"></a>      lc <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(lc, bb)</span>
<span id="cb66-115"><a href="annex-i-compendium-of-r-scripts.html#cb66-115" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb66-116"><a href="annex-i-compendium-of-r-scripts.html#cb66-116" aria-hidden="true" tabindex="-1"></a>      lc <span class="ot">&lt;-</span> lc</span>
<span id="cb66-117"><a href="annex-i-compendium-of-r-scripts.html#cb66-117" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-118"><a href="annex-i-compendium-of-r-scripts.html#cb66-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check geometry</span></span>
<span id="cb66-119"><a href="annex-i-compendium-of-r-scripts.html#cb66-119" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(lc)</span>
<span id="cb66-120"><a href="annex-i-compendium-of-r-scripts.html#cb66-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Agregate units</span></span>
<span id="cb66-121"><a href="annex-i-compendium-of-r-scripts.html#cb66-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(lc<span class="sc">$</span>landcover)</span>
<span id="cb66-122"><a href="annex-i-compendium-of-r-scripts.html#cb66-122" aria-hidden="true" tabindex="-1"></a>    lc<span class="sc">$</span>landcover[lc<span class="sc">$</span>landcover<span class="sc">==</span><span class="st">&quot;Broadleaf forest&quot;</span>]<span class="ot">&lt;-</span> <span class="st">&quot;Forest&quot;</span></span>
<span id="cb66-123"><a href="annex-i-compendium-of-r-scripts.html#cb66-123" aria-hidden="true" tabindex="-1"></a>    lc<span class="sc">$</span>landcover[lc<span class="sc">$</span>landcover<span class="sc">==</span><span class="st">&quot;Needleleaf forest&quot;</span>]<span class="ot">&lt;-</span> <span class="st">&quot;Forest&quot;</span></span>
<span id="cb66-124"><a href="annex-i-compendium-of-r-scripts.html#cb66-124" aria-hidden="true" tabindex="-1"></a>    lc<span class="sc">$</span>landcover[lc<span class="sc">$</span>landcover<span class="sc">==</span><span class="st">&quot;Mixed forest&quot;</span>]<span class="ot">&lt;-</span> <span class="st">&quot;Forest&quot;</span></span>
<span id="cb66-125"><a href="annex-i-compendium-of-r-scripts.html#cb66-125" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> lc[lc<span class="sc">$</span>landcover<span class="sc">!=</span><span class="st">&quot;Water body&quot;</span>,]</span>
<span id="cb66-126"><a href="annex-i-compendium-of-r-scripts.html#cb66-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(lc<span class="sc">$</span>landcover)</span>
<span id="cb66-127"><a href="annex-i-compendium-of-r-scripts.html#cb66-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-128"><a href="annex-i-compendium-of-r-scripts.html#cb66-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dissolve polygons by reference soil group</span></span>
<span id="cb66-129"><a href="annex-i-compendium-of-r-scripts.html#cb66-129" aria-hidden="true" tabindex="-1"></a>    lc <span class="ot">&lt;-</span> lc <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(landcover) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">summarize</span>() </span>
<span id="cb66-130"><a href="annex-i-compendium-of-r-scripts.html#cb66-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-131"><a href="annex-i-compendium-of-r-scripts.html#cb66-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write land use strata as shapefile</span></span>
<span id="cb66-132"><a href="annex-i-compendium-of-r-scripts.html#cb66-132" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(lc, <span class="fu">paste0</span>(results.path,<span class="st">&quot;lc_classes.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-133"><a href="annex-i-compendium-of-r-scripts.html#cb66-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-134"><a href="annex-i-compendium-of-r-scripts.html#cb66-134" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Plot map with the land cover information</span></span>
<span id="cb66-135"><a href="annex-i-compendium-of-r-scripts.html#cb66-135" aria-hidden="true" tabindex="-1"></a>      map <span class="ot">=</span> <span class="fu">leaflet</span>() <span class="sc">%&gt;%</span></span>
<span id="cb66-136"><a href="annex-i-compendium-of-r-scripts.html#cb66-136" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addTiles</span>()</span>
<span id="cb66-137"><a href="annex-i-compendium-of-r-scripts.html#cb66-137" aria-hidden="true" tabindex="-1"></a>      mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(lc[<span class="st">&quot;landcover&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Landcover&quot;</span>, <span class="at">map=</span>map)</span>
<span id="cb66-138"><a href="annex-i-compendium-of-r-scripts.html#cb66-138" aria-hidden="true" tabindex="-1"></a>      mv<span class="sc">@</span>map</span>
<span id="cb66-139"><a href="annex-i-compendium-of-r-scripts.html#cb66-139" aria-hidden="true" tabindex="-1"></a>      <span class="co">#ggplot() + geom_sf(data=lc, aes(fill = factor(landcover)))</span></span>
<span id="cb66-140"><a href="annex-i-compendium-of-r-scripts.html#cb66-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-141"><a href="annex-i-compendium-of-r-scripts.html#cb66-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-142"><a href="annex-i-compendium-of-r-scripts.html#cb66-142" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Create sampling strata ===================================================</span></span>
<span id="cb66-143"><a href="annex-i-compendium-of-r-scripts.html#cb66-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-144"><a href="annex-i-compendium-of-r-scripts.html#cb66-144" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Combine soil and land use layers</span></span>
<span id="cb66-145"><a href="annex-i-compendium-of-r-scripts.html#cb66-145" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sf_use_s2</span>(<span class="cn">FALSE</span>)</span>
<span id="cb66-146"><a href="annex-i-compendium-of-r-scripts.html#cb66-146" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(<span class="fu">st_make_valid</span>(soil), <span class="fu">st_make_valid</span>(lc))  </span>
<span id="cb66-147"><a href="annex-i-compendium-of-r-scripts.html#cb66-147" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>soil_lc <span class="ot">&lt;-</span> <span class="fu">paste0</span>(soil_lc<span class="sc">$</span>RSG, <span class="st">&quot;_&quot;</span>, soil_lc<span class="sc">$</span>landcover)</span>
<span id="cb66-148"><a href="annex-i-compendium-of-r-scripts.html#cb66-148" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> soil_lc <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(soil_lc, geometry)</span>
<span id="cb66-149"><a href="annex-i-compendium-of-r-scripts.html#cb66-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-150"><a href="annex-i-compendium-of-r-scripts.html#cb66-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-151"><a href="annex-i-compendium-of-r-scripts.html#cb66-151" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Accommodate strata to requirements =======================================</span></span>
<span id="cb66-152"><a href="annex-i-compendium-of-r-scripts.html#cb66-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-153"><a href="annex-i-compendium-of-r-scripts.html#cb66-153" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Select by Area. Convert to area to ha and select polygons with more than 100 has</span></span>
<span id="cb66-154"><a href="annex-i-compendium-of-r-scripts.html#cb66-154" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(soil_lc)<span class="sc">/</span><span class="dv">10000</span> </span>
<span id="cb66-155"><a href="annex-i-compendium-of-r-scripts.html#cb66-155" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(soil_lc<span class="sc">$</span>area)</span>
<span id="cb66-156"><a href="annex-i-compendium-of-r-scripts.html#cb66-156" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> soil_lc <span class="sc">%&gt;%</span> </span>
<span id="cb66-157"><a href="annex-i-compendium-of-r-scripts.html#cb66-157" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(soil_lc) <span class="sc">%&gt;%</span> </span>
<span id="cb66-158"><a href="annex-i-compendium-of-r-scripts.html#cb66-158" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">area =</span> <span class="fu">sum</span>(area))</span>
<span id="cb66-159"><a href="annex-i-compendium-of-r-scripts.html#cb66-159" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> soil_lc[soil_lc<span class="sc">$</span>area <span class="sc">&gt;</span> <span class="dv">100</span>,]</span>
<span id="cb66-160"><a href="annex-i-compendium-of-r-scripts.html#cb66-160" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(soil_lc[<span class="dv">1</span>])</span>
<span id="cb66-161"><a href="annex-i-compendium-of-r-scripts.html#cb66-161" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-162"><a href="annex-i-compendium-of-r-scripts.html#cb66-162" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Replace blank spaces with underscore symbol to keep names uniform</span></span>
<span id="cb66-163"><a href="annex-i-compendium-of-r-scripts.html#cb66-163" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>soil_lc <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(soil_lc<span class="sc">$</span>soil_lc, <span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>)</span>
<span id="cb66-164"><a href="annex-i-compendium-of-r-scripts.html#cb66-164" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-165"><a href="annex-i-compendium-of-r-scripts.html#cb66-165" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create a column of strata numeric codes</span></span>
<span id="cb66-166"><a href="annex-i-compendium-of-r-scripts.html#cb66-166" aria-hidden="true" tabindex="-1"></a>      soil_lc<span class="sc">$</span>code <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(soil_lc<span class="sc">$</span>soil_lc)))</span>
<span id="cb66-167"><a href="annex-i-compendium-of-r-scripts.html#cb66-167" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-168"><a href="annex-i-compendium-of-r-scripts.html#cb66-168" aria-hidden="true" tabindex="-1"></a>      <span class="co"># List final strata</span></span>
<span id="cb66-169"><a href="annex-i-compendium-of-r-scripts.html#cb66-169" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unique</span>(soil_lc<span class="sc">$</span>soil_lc)</span>
<span id="cb66-170"><a href="annex-i-compendium-of-r-scripts.html#cb66-170" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-171"><a href="annex-i-compendium-of-r-scripts.html#cb66-171" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Write final sampling strata map</span></span>
<span id="cb66-172"><a href="annex-i-compendium-of-r-scripts.html#cb66-172" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(soil_lc, <span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-173"><a href="annex-i-compendium-of-r-scripts.html#cb66-173" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-174"><a href="annex-i-compendium-of-r-scripts.html#cb66-174" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Plot strata ==============================================================</span></span>
<span id="cb66-175"><a href="annex-i-compendium-of-r-scripts.html#cb66-175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-176"><a href="annex-i-compendium-of-r-scripts.html#cb66-176" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Plot final map of stratum</span></span>
<span id="cb66-177"><a href="annex-i-compendium-of-r-scripts.html#cb66-177" aria-hidden="true" tabindex="-1"></a>      map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">8.3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb66-178"><a href="annex-i-compendium-of-r-scripts.html#cb66-178" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addTiles</span>()</span>
<span id="cb66-179"><a href="annex-i-compendium-of-r-scripts.html#cb66-179" aria-hidden="true" tabindex="-1"></a>      mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>, <span class="at">map=</span>map)</span>
<span id="cb66-180"><a href="annex-i-compendium-of-r-scripts.html#cb66-180" aria-hidden="true" tabindex="-1"></a>      mv<span class="sc">@</span>map</span>
<span id="cb66-181"><a href="annex-i-compendium-of-r-scripts.html#cb66-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-182"><a href="annex-i-compendium-of-r-scripts.html#cb66-182" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Stratified random sampling ===============================================</span></span>
<span id="cb66-183"><a href="annex-i-compendium-of-r-scripts.html#cb66-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-184"><a href="annex-i-compendium-of-r-scripts.html#cb66-184" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read already created strata shapefile</span></span>
<span id="cb66-185"><a href="annex-i-compendium-of-r-scripts.html#cb66-185" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>))</span>
<span id="cb66-186"><a href="annex-i-compendium-of-r-scripts.html#cb66-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(REPLACEMENT){</span>
<span id="cb66-187"><a href="annex-i-compendium-of-r-scripts.html#cb66-187" aria-hidden="true" tabindex="-1"></a>      polygons <span class="ot">=</span> <span class="fu">st_intersection</span>(polygons,distance.buffer)</span>
<span id="cb66-188"><a href="annex-i-compendium-of-r-scripts.html#cb66-188" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-189"><a href="annex-i-compendium-of-r-scripts.html#cb66-189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-190"><a href="annex-i-compendium-of-r-scripts.html#cb66-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the area of each polygon  </span></span>
<span id="cb66-191"><a href="annex-i-compendium-of-r-scripts.html#cb66-191" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(polygons) </span>
<span id="cb66-192"><a href="annex-i-compendium-of-r-scripts.html#cb66-192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-193"><a href="annex-i-compendium-of-r-scripts.html#cb66-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a new column to group polygons by a common attribute</span></span>
<span id="cb66-194"><a href="annex-i-compendium-of-r-scripts.html#cb66-194" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>group <span class="ot">&lt;-</span> polygons<span class="sc">$</span>soil_lc</span>
<span id="cb66-195"><a href="annex-i-compendium-of-r-scripts.html#cb66-195" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop units to allow computations</span></span>
<span id="cb66-196"><a href="annex-i-compendium-of-r-scripts.html#cb66-196" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">drop_units</span>(polygons)</span>
<span id="cb66-197"><a href="annex-i-compendium-of-r-scripts.html#cb66-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-198"><a href="annex-i-compendium-of-r-scripts.html#cb66-198" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the total area of all polygons in each group</span></span>
<span id="cb66-199"><a href="annex-i-compendium-of-r-scripts.html#cb66-199" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span></span>
<span id="cb66-200"><a href="annex-i-compendium-of-r-scripts.html#cb66-200" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(group)  <span class="sc">%&gt;%</span> </span>
<span id="cb66-201"><a href="annex-i-compendium-of-r-scripts.html#cb66-201" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">total_area =</span> <span class="fu">sum</span>(area))</span>
<span id="cb66-202"><a href="annex-i-compendium-of-r-scripts.html#cb66-202" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a code to each group</span></span>
<span id="cb66-203"><a href="annex-i-compendium-of-r-scripts.html#cb66-203" aria-hidden="true" tabindex="-1"></a>    group_codes <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb66-204"><a href="annex-i-compendium-of-r-scripts.html#cb66-204" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">code =</span> <span class="fu">first</span>(code)) </span>
<span id="cb66-205"><a href="annex-i-compendium-of-r-scripts.html#cb66-205" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join polygon strata and codes   </span></span>
<span id="cb66-206"><a href="annex-i-compendium-of-r-scripts.html#cb66-206" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">st_drop_geometry</span>(group_codes), <span class="at">by =</span> <span class="st">&quot;group&quot;</span>)</span>
<span id="cb66-207"><a href="annex-i-compendium-of-r-scripts.html#cb66-207" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-208"><a href="annex-i-compendium-of-r-scripts.html#cb66-208" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure minimum of 2 samples at each polygon in each group</span></span>
<span id="cb66-209"><a href="annex-i-compendium-of-r-scripts.html#cb66-209" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb66-210"><a href="annex-i-compendium-of-r-scripts.html#cb66-210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-211"><a href="annex-i-compendium-of-r-scripts.html#cb66-211" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the number of samples per group based on relative area</span></span>
<span id="cb66-212"><a href="annex-i-compendium-of-r-scripts.html#cb66-212" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> </span>
<span id="cb66-213"><a href="annex-i-compendium-of-r-scripts.html#cb66-213" aria-hidden="true" tabindex="-1"></a>      group_areas<span class="sc">$</span>sample_count <span class="sc">+</span> </span>
<span id="cb66-214"><a href="annex-i-compendium-of-r-scripts.html#cb66-214" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(group_areas<span class="sc">$</span>total_area<span class="sc">/</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>total_area) <span class="sc">*</span></span>
<span id="cb66-215"><a href="annex-i-compendium-of-r-scripts.html#cb66-215" aria-hidden="true" tabindex="-1"></a>              (n<span class="sc">-</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count)))</span>
<span id="cb66-216"><a href="annex-i-compendium-of-r-scripts.html#cb66-216" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Adjust sample size on classes</span></span>
<span id="cb66-217"><a href="annex-i-compendium-of-r-scripts.html#cb66-217" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">!=</span> n) {</span>
<span id="cb66-218"><a href="annex-i-compendium-of-r-scripts.html#cb66-218" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">&gt;</span> n) {</span>
<span id="cb66-219"><a href="annex-i-compendium-of-r-scripts.html#cb66-219" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Reduce sample count for the largest polygon until total count is n</span></span>
<span id="cb66-220"><a href="annex-i-compendium-of-r-scripts.html#cb66-220" aria-hidden="true" tabindex="-1"></a>        max_index <span class="ot">&lt;-</span> <span class="fu">which.max</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb66-221"><a href="annex-i-compendium-of-r-scripts.html#cb66-221" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[max_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[max_index] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb66-222"><a href="annex-i-compendium-of-r-scripts.html#cb66-222" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb66-223"><a href="annex-i-compendium-of-r-scripts.html#cb66-223" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Increase sample count for the smallest polygon until total count is n</span></span>
<span id="cb66-224"><a href="annex-i-compendium-of-r-scripts.html#cb66-224" aria-hidden="true" tabindex="-1"></a>        min_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb66-225"><a href="annex-i-compendium-of-r-scripts.html#cb66-225" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[min_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[min_index] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb66-226"><a href="annex-i-compendium-of-r-scripts.html#cb66-226" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-227"><a href="annex-i-compendium-of-r-scripts.html#cb66-227" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-228"><a href="annex-i-compendium-of-r-scripts.html#cb66-228" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count the total samples. It must be equal to the sampling size</span></span>
<span id="cb66-229"><a href="annex-i-compendium-of-r-scripts.html#cb66-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) </span>
<span id="cb66-230"><a href="annex-i-compendium-of-r-scripts.html#cb66-230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-231"><a href="annex-i-compendium-of-r-scripts.html#cb66-231" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">left_join</span>(polygons, <span class="fu">st_drop_geometry</span>(group_areas),</span>
<span id="cb66-232"><a href="annex-i-compendium-of-r-scripts.html#cb66-232" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;soil_lc&quot;</span><span class="ot">=</span><span class="st">&quot;group&quot;</span>))</span>
<span id="cb66-233"><a href="annex-i-compendium-of-r-scripts.html#cb66-233" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(polygons, soil_lc, code.x, sample_count, geometry)</span>
<span id="cb66-234"><a href="annex-i-compendium-of-r-scripts.html#cb66-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-235"><a href="annex-i-compendium-of-r-scripts.html#cb66-235" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate random points within each strata of size 3 times</span></span>
<span id="cb66-236"><a href="annex-i-compendium-of-r-scripts.html#cb66-236" aria-hidden="true" tabindex="-1"></a>  <span class="co">#the required samples for each strata</span></span>
<span id="cb66-237"><a href="annex-i-compendium-of-r-scripts.html#cb66-237" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas),</span>
<span id="cb66-238"><a href="annex-i-compendium-of-r-scripts.html#cb66-238" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> group_areas<span class="sc">$</span>sample_count <span class="sc">*</span> <span class="dv">3</span>, <span class="at">method =</span> <span class="st">&quot;random&quot;</span>)</span>
<span id="cb66-239"><a href="annex-i-compendium-of-r-scripts.html#cb66-239" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-240"><a href="annex-i-compendium-of-r-scripts.html#cb66-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute sampling points for strata</span></span>
<span id="cb66-241"><a href="annex-i-compendium-of-r-scripts.html#cb66-241" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb66-242"><a href="annex-i-compendium-of-r-scripts.html#cb66-242" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-243"><a href="annex-i-compendium-of-r-scripts.html#cb66-243" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb66-244"><a href="annex-i-compendium-of-r-scripts.html#cb66-244" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb66-245"><a href="annex-i-compendium-of-r-scripts.html#cb66-245" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb66-246"><a href="annex-i-compendium-of-r-scripts.html#cb66-246" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb66-247"><a href="annex-i-compendium-of-r-scripts.html#cb66-247" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-248"><a href="annex-i-compendium-of-r-scripts.html#cb66-248" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb66-249"><a href="annex-i-compendium-of-r-scripts.html#cb66-249" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-250"><a href="annex-i-compendium-of-r-scripts.html#cb66-250" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find classes with missing samples</span></span>
<span id="cb66-251"><a href="annex-i-compendium-of-r-scripts.html#cb66-251" aria-hidden="true" tabindex="-1"></a>    missing.data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">data.frame</span>(z) <span class="sc">%&gt;%</span></span>
<span id="cb66-252"><a href="annex-i-compendium-of-r-scripts.html#cb66-252" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">filter</span>(type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb66-253"><a href="annex-i-compendium-of-r-scripts.html#cb66-253" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span></span>
<span id="cb66-254"><a href="annex-i-compendium-of-r-scripts.html#cb66-254" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">tally</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb66-255"><a href="annex-i-compendium-of-r-scripts.html#cb66-255" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diff=</span>sample_count<span class="sc">-</span>n)</span>
<span id="cb66-256"><a href="annex-i-compendium-of-r-scripts.html#cb66-256" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-257"><a href="annex-i-compendium-of-r-scripts.html#cb66-257" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine missing sampled strata</span></span>
<span id="cb66-258"><a href="annex-i-compendium-of-r-scripts.html#cb66-258" aria-hidden="true" tabindex="-1"></a>    missing.strata <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(missing.data<span class="sc">$</span>diff))</span>
<span id="cb66-259"><a href="annex-i-compendium-of-r-scripts.html#cb66-259" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-260"><a href="annex-i-compendium-of-r-scripts.html#cb66-260" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine missing sampling point in strata (undersampled strata)</span></span>
<span id="cb66-261"><a href="annex-i-compendium-of-r-scripts.html#cb66-261" aria-hidden="true" tabindex="-1"></a>    missing.sample <span class="ot">=</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb66-262"><a href="annex-i-compendium-of-r-scripts.html#cb66-262" aria-hidden="true" tabindex="-1"></a>    missing.number <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">st_drop_geometry</span>(missing.data[(missing.sample <span class="ot">&lt;-</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)),<span class="dv">7</span>])))</span>
<span id="cb66-263"><a href="annex-i-compendium-of-r-scripts.html#cb66-263" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-264"><a href="annex-i-compendium-of-r-scripts.html#cb66-264" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute sampling points for missing sampled strata</span></span>
<span id="cb66-265"><a href="annex-i-compendium-of-r-scripts.html#cb66-265" aria-hidden="true" tabindex="-1"></a>    x.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb66-266"><a href="annex-i-compendium-of-r-scripts.html#cb66-266" aria-hidden="true" tabindex="-1"></a>    x.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb66-267"><a href="annex-i-compendium-of-r-scripts.html#cb66-267" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-268"><a href="annex-i-compendium-of-r-scripts.html#cb66-268" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.strata){</span>
<span id="cb66-269"><a href="annex-i-compendium-of-r-scripts.html#cb66-269" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb66-270"><a href="annex-i-compendium-of-r-scripts.html#cb66-270" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb66-271"><a href="annex-i-compendium-of-r-scripts.html#cb66-271" aria-hidden="true" tabindex="-1"></a>      nn<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb66-272"><a href="annex-i-compendium-of-r-scripts.html#cb66-272" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> </span>
<span id="cb66-273"><a href="annex-i-compendium-of-r-scripts.html#cb66-273" aria-hidden="true" tabindex="-1"></a>             group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>) {</span>
<span id="cb66-274"><a href="annex-i-compendium-of-r-scripts.html#cb66-274" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-275"><a href="annex-i-compendium-of-r-scripts.html#cb66-275" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span>(nn <span class="sc">&lt;</span> group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>){</span>
<span id="cb66-276"><a href="annex-i-compendium-of-r-scripts.html#cb66-276" aria-hidden="true" tabindex="-1"></a>          my.missing.strata <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb66-277"><a href="annex-i-compendium-of-r-scripts.html#cb66-277" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">size =</span>  group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>,</span>
<span id="cb66-278"><a href="annex-i-compendium-of-r-scripts.html#cb66-278" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">method =</span> <span class="st">&quot;random&quot;</span>)</span>
<span id="cb66-279"><a href="annex-i-compendium-of-r-scripts.html#cb66-279" aria-hidden="true" tabindex="-1"></a>          nn <span class="ot">&lt;-</span> nn <span class="sc">+</span> <span class="fu">nrow</span>(<span class="fu">data.frame</span>(my.missing.strata))</span>
<span id="cb66-280"><a href="annex-i-compendium-of-r-scripts.html#cb66-280" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb66-281"><a href="annex-i-compendium-of-r-scripts.html#cb66-281" aria-hidden="true" tabindex="-1"></a>        xx.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.strata,my.missing.strata)</span>
<span id="cb66-282"><a href="annex-i-compendium-of-r-scripts.html#cb66-282" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count))</span>
<span id="cb66-283"><a href="annex-i-compendium-of-r-scripts.html#cb66-283" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-284"><a href="annex-i-compendium-of-r-scripts.html#cb66-284" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb66-285"><a href="annex-i-compendium-of-r-scripts.html#cb66-285" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.strata)</span>
<span id="cb66-286"><a href="annex-i-compendium-of-r-scripts.html#cb66-286" aria-hidden="true" tabindex="-1"></a>      x.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.strata,xx.missing.strata)</span>
<span id="cb66-287"><a href="annex-i-compendium-of-r-scripts.html#cb66-287" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-288"><a href="annex-i-compendium-of-r-scripts.html#cb66-288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-289"><a href="annex-i-compendium-of-r-scripts.html#cb66-289" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join initial sampling with missing sampling strata data</span></span>
<span id="cb66-290"><a href="annex-i-compendium-of-r-scripts.html#cb66-290" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.strata)</span>
<span id="cb66-291"><a href="annex-i-compendium-of-r-scripts.html#cb66-291" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-292"><a href="annex-i-compendium-of-r-scripts.html#cb66-292" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute sampling points for missing samples (random sampling)</span></span>
<span id="cb66-293"><a href="annex-i-compendium-of-r-scripts.html#cb66-293" aria-hidden="true" tabindex="-1"></a>    x.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb66-294"><a href="annex-i-compendium-of-r-scripts.html#cb66-294" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-295"><a href="annex-i-compendium-of-r-scripts.html#cb66-295" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.sample){</span>
<span id="cb66-296"><a href="annex-i-compendium-of-r-scripts.html#cb66-296" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb66-297"><a href="annex-i-compendium-of-r-scripts.html#cb66-297" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb66-298"><a href="annex-i-compendium-of-r-scripts.html#cb66-298" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>)) {</span>
<span id="cb66-299"><a href="annex-i-compendium-of-r-scripts.html#cb66-299" aria-hidden="true" tabindex="-1"></a>        my.missing.sample <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb66-300"><a href="annex-i-compendium-of-r-scripts.html#cb66-300" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">size =</span> <span class="fu">as.numeric</span>(<span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,])[[<span class="dv">4</span>]])<span class="sc">+</span></span>
<span id="cb66-301"><a href="annex-i-compendium-of-r-scripts.html#cb66-301" aria-hidden="true" tabindex="-1"></a>                                          (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>), <span class="at">method =</span> <span class="st">&quot;random&quot;</span>)</span>
<span id="cb66-302"><a href="annex-i-compendium-of-r-scripts.html#cb66-302" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-303"><a href="annex-i-compendium-of-r-scripts.html#cb66-303" aria-hidden="true" tabindex="-1"></a>        xx.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.sample,my.missing.sample)</span>
<span id="cb66-304"><a href="annex-i-compendium-of-r-scripts.html#cb66-304" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count))</span>
<span id="cb66-305"><a href="annex-i-compendium-of-r-scripts.html#cb66-305" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-306"><a href="annex-i-compendium-of-r-scripts.html#cb66-306" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb66-307"><a href="annex-i-compendium-of-r-scripts.html#cb66-307" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.sample)</span>
<span id="cb66-308"><a href="annex-i-compendium-of-r-scripts.html#cb66-308" aria-hidden="true" tabindex="-1"></a>      x.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.sample,xx.missing.sample)</span>
<span id="cb66-309"><a href="annex-i-compendium-of-r-scripts.html#cb66-309" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-310"><a href="annex-i-compendium-of-r-scripts.html#cb66-310" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-311"><a href="annex-i-compendium-of-r-scripts.html#cb66-311" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join initial sampling with missing sampling strata data and with missing samples </span></span>
<span id="cb66-312"><a href="annex-i-compendium-of-r-scripts.html#cb66-312" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.sample)</span>
<span id="cb66-313"><a href="annex-i-compendium-of-r-scripts.html#cb66-313" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-314"><a href="annex-i-compendium-of-r-scripts.html#cb66-314" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove extra artificial replacements </span></span>
<span id="cb66-315"><a href="annex-i-compendium-of-r-scripts.html#cb66-315" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x[x<span class="sc">$</span>sample_count <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb66-316"><a href="annex-i-compendium-of-r-scripts.html#cb66-316" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-317"><a href="annex-i-compendium-of-r-scripts.html#cb66-317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert and export to shapefile</span></span>
<span id="cb66-318"><a href="annex-i-compendium-of-r-scripts.html#cb66-318" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb66-319"><a href="annex-i-compendium-of-r-scripts.html#cb66-319" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-320"><a href="annex-i-compendium-of-r-scripts.html#cb66-320" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb66-321"><a href="annex-i-compendium-of-r-scripts.html#cb66-321" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb66-322"><a href="annex-i-compendium-of-r-scripts.html#cb66-322" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb66-323"><a href="annex-i-compendium-of-r-scripts.html#cb66-323" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb66-324"><a href="annex-i-compendium-of-r-scripts.html#cb66-324" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-325"><a href="annex-i-compendium-of-r-scripts.html#cb66-325" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb66-326"><a href="annex-i-compendium-of-r-scripts.html#cb66-326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeVector</span>(z,</span>
<span id="cb66-327"><a href="annex-i-compendium-of-r-scripts.html#cb66-327" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(results.path,<span class="st">&quot;strat_randm_samples.shp&quot;</span>, <span class="at">overwrite=</span><span class="cn">TRUE</span>))</span>
<span id="cb66-328"><a href="annex-i-compendium-of-r-scripts.html#cb66-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-329"><a href="annex-i-compendium-of-r-scripts.html#cb66-329" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the number of initial target points equals the final target points </span></span>
<span id="cb66-330"><a href="annex-i-compendium-of-r-scripts.html#cb66-330" aria-hidden="true" tabindex="-1"></a>    n<span class="sc">==</span><span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb66-331"><a href="annex-i-compendium-of-r-scripts.html#cb66-331" aria-hidden="true" tabindex="-1"></a>    n;<span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb66-332"><a href="annex-i-compendium-of-r-scripts.html#cb66-332" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-333"><a href="annex-i-compendium-of-r-scripts.html#cb66-333" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Plot points over strata ==================================================</span></span>
<span id="cb66-334"><a href="annex-i-compendium-of-r-scripts.html#cb66-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-335"><a href="annex-i-compendium-of-r-scripts.html#cb66-335" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">11.4</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb66-336"><a href="annex-i-compendium-of-r-scripts.html#cb66-336" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb66-337"><a href="annex-i-compendium-of-r-scripts.html#cb66-337" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>) <span class="sc">+</span> </span>
<span id="cb66-338"><a href="annex-i-compendium-of-r-scripts.html#cb66-338" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(sf<span class="sc">::</span><span class="fu">st_as_sf</span>(z), <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;royalblue&#39;</span>, <span class="st">&#39;tomato&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Samples&quot;</span>)</span>
<span id="cb66-339"><a href="annex-i-compendium-of-r-scripts.html#cb66-339" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb66-340"><a href="annex-i-compendium-of-r-scripts.html#cb66-340" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-341"><a href="annex-i-compendium-of-r-scripts.html#cb66-341" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-342"><a href="annex-i-compendium-of-r-scripts.html#cb66-342" aria-hidden="true" tabindex="-1"></a><span class="co"># 10 - Calculate replacement areas for points ==================================    </span></span>
<span id="cb66-343"><a href="annex-i-compendium-of-r-scripts.html#cb66-343" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-344"><a href="annex-i-compendium-of-r-scripts.html#cb66-344" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(REPLACEMENT){</span>
<span id="cb66-345"><a href="annex-i-compendium-of-r-scripts.html#cb66-345" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Load strata</span></span>
<span id="cb66-346"><a href="annex-i-compendium-of-r-scripts.html#cb66-346" aria-hidden="true" tabindex="-1"></a>      soil_lc <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>))</span>
<span id="cb66-347"><a href="annex-i-compendium-of-r-scripts.html#cb66-347" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-348"><a href="annex-i-compendium-of-r-scripts.html#cb66-348" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Read sampling. points from previous step</span></span>
<span id="cb66-349"><a href="annex-i-compendium-of-r-scripts.html#cb66-349" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strat_randm_samples.shp&quot;</span>))</span>
<span id="cb66-350"><a href="annex-i-compendium-of-r-scripts.html#cb66-350" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-351"><a href="annex-i-compendium-of-r-scripts.html#cb66-351" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Apply buffer of 500 meters</span></span>
<span id="cb66-352"><a href="annex-i-compendium-of-r-scripts.html#cb66-352" aria-hidden="true" tabindex="-1"></a>      buf.samples <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(z, <span class="at">dist=</span>distance.buffer)</span>
<span id="cb66-353"><a href="annex-i-compendium-of-r-scripts.html#cb66-353" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-354"><a href="annex-i-compendium-of-r-scripts.html#cb66-354" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Intersect buffers</span></span>
<span id="cb66-355"><a href="annex-i-compendium-of-r-scripts.html#cb66-355" aria-hidden="true" tabindex="-1"></a>      samples_buffer <span class="ot">=</span> <span class="fu">st_intersection</span>(soil_lc, buf.samples)</span>
<span id="cb66-356"><a href="annex-i-compendium-of-r-scripts.html#cb66-356" aria-hidden="true" tabindex="-1"></a>      samples_buffer <span class="ot">&lt;-</span> samples_buffer[samples_buffer<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,]</span>
<span id="cb66-357"><a href="annex-i-compendium-of-r-scripts.html#cb66-357" aria-hidden="true" tabindex="-1"></a>      samples_buffer <span class="ot">&lt;-</span> samples_buffer[samples_buffer<span class="sc">$</span>soil_lc<span class="sc">==</span>samples_buffer<span class="sc">$</span>group,]</span>
<span id="cb66-358"><a href="annex-i-compendium-of-r-scripts.html#cb66-358" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-359"><a href="annex-i-compendium-of-r-scripts.html#cb66-359" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save Sampling areas</span></span>
<span id="cb66-360"><a href="annex-i-compendium-of-r-scripts.html#cb66-360" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(samples_buffer, <span class="fu">paste0</span>(results.path,<span class="st">&quot;replacement_areas.shp&quot;</span>),</span>
<span id="cb66-361"><a href="annex-i-compendium-of-r-scripts.html#cb66-361" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-362"><a href="annex-i-compendium-of-r-scripts.html#cb66-362" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Write target points only</span></span>
<span id="cb66-363"><a href="annex-i-compendium-of-r-scripts.html#cb66-363" aria-hidden="true" tabindex="-1"></a>      targets <span class="ot">&lt;-</span> z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,]</span>
<span id="cb66-364"><a href="annex-i-compendium-of-r-scripts.html#cb66-364" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(targets, <span class="fu">paste0</span>(results.path,<span class="st">&quot;target_points.shp&quot;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-365"><a href="annex-i-compendium-of-r-scripts.html#cb66-365" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-366"><a href="annex-i-compendium-of-r-scripts.html#cb66-366" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-367"><a href="annex-i-compendium-of-r-scripts.html#cb66-367" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-368"><a href="annex-i-compendium-of-r-scripts.html#cb66-368" aria-hidden="true" tabindex="-1"></a><span class="co"># 11 - Stratified regular sampling ==================================    </span></span>
<span id="cb66-369"><a href="annex-i-compendium-of-r-scripts.html#cb66-369" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read already created strata shapefile</span></span>
<span id="cb66-370"><a href="annex-i-compendium-of-r-scripts.html#cb66-370" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>))</span>
<span id="cb66-371"><a href="annex-i-compendium-of-r-scripts.html#cb66-371" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(REPLACEMENT){</span>
<span id="cb66-372"><a href="annex-i-compendium-of-r-scripts.html#cb66-372" aria-hidden="true" tabindex="-1"></a>      polygons <span class="ot">=</span> <span class="fu">st_intersection</span>(polygons,distance.buffer)</span>
<span id="cb66-373"><a href="annex-i-compendium-of-r-scripts.html#cb66-373" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-374"><a href="annex-i-compendium-of-r-scripts.html#cb66-374" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-375"><a href="annex-i-compendium-of-r-scripts.html#cb66-375" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the area of each polygon  </span></span>
<span id="cb66-376"><a href="annex-i-compendium-of-r-scripts.html#cb66-376" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(polygons) </span>
<span id="cb66-377"><a href="annex-i-compendium-of-r-scripts.html#cb66-377" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-378"><a href="annex-i-compendium-of-r-scripts.html#cb66-378" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new column to group polygons by a common attribute</span></span>
<span id="cb66-379"><a href="annex-i-compendium-of-r-scripts.html#cb66-379" aria-hidden="true" tabindex="-1"></a>    polygons<span class="sc">$</span>group <span class="ot">&lt;-</span> polygons<span class="sc">$</span>soil_lc</span>
<span id="cb66-380"><a href="annex-i-compendium-of-r-scripts.html#cb66-380" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop units to allow computations</span></span>
<span id="cb66-381"><a href="annex-i-compendium-of-r-scripts.html#cb66-381" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">drop_units</span>(polygons)</span>
<span id="cb66-382"><a href="annex-i-compendium-of-r-scripts.html#cb66-382" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-383"><a href="annex-i-compendium-of-r-scripts.html#cb66-383" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the total area of all polygons in each group</span></span>
<span id="cb66-384"><a href="annex-i-compendium-of-r-scripts.html#cb66-384" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span></span>
<span id="cb66-385"><a href="annex-i-compendium-of-r-scripts.html#cb66-385" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(group)  <span class="sc">%&gt;%</span> </span>
<span id="cb66-386"><a href="annex-i-compendium-of-r-scripts.html#cb66-386" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">total_area =</span> <span class="fu">sum</span>(area))</span>
<span id="cb66-387"><a href="annex-i-compendium-of-r-scripts.html#cb66-387" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a code to each group</span></span>
<span id="cb66-388"><a href="annex-i-compendium-of-r-scripts.html#cb66-388" aria-hidden="true" tabindex="-1"></a>    group_codes <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb66-389"><a href="annex-i-compendium-of-r-scripts.html#cb66-389" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">code =</span> <span class="fu">first</span>(code)) </span>
<span id="cb66-390"><a href="annex-i-compendium-of-r-scripts.html#cb66-390" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join polygon strata and codes   </span></span>
<span id="cb66-391"><a href="annex-i-compendium-of-r-scripts.html#cb66-391" aria-hidden="true" tabindex="-1"></a>    group_areas <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">st_drop_geometry</span>(group_codes), <span class="at">by =</span> <span class="st">&quot;group&quot;</span>)</span>
<span id="cb66-392"><a href="annex-i-compendium-of-r-scripts.html#cb66-392" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-393"><a href="annex-i-compendium-of-r-scripts.html#cb66-393" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure minimum of 2 samples at each polygon in each group</span></span>
<span id="cb66-394"><a href="annex-i-compendium-of-r-scripts.html#cb66-394" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb66-395"><a href="annex-i-compendium-of-r-scripts.html#cb66-395" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-396"><a href="annex-i-compendium-of-r-scripts.html#cb66-396" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the number of samples per group based on relative area</span></span>
<span id="cb66-397"><a href="annex-i-compendium-of-r-scripts.html#cb66-397" aria-hidden="true" tabindex="-1"></a>    group_areas<span class="sc">$</span>sample_count <span class="ot">&lt;-</span> </span>
<span id="cb66-398"><a href="annex-i-compendium-of-r-scripts.html#cb66-398" aria-hidden="true" tabindex="-1"></a>      group_areas<span class="sc">$</span>sample_count <span class="sc">+</span> </span>
<span id="cb66-399"><a href="annex-i-compendium-of-r-scripts.html#cb66-399" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(group_areas<span class="sc">$</span>total_area<span class="sc">/</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>total_area) <span class="sc">*</span></span>
<span id="cb66-400"><a href="annex-i-compendium-of-r-scripts.html#cb66-400" aria-hidden="true" tabindex="-1"></a>              (n<span class="sc">-</span><span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count)))</span>
<span id="cb66-401"><a href="annex-i-compendium-of-r-scripts.html#cb66-401" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust sample size on classes</span></span>
<span id="cb66-402"><a href="annex-i-compendium-of-r-scripts.html#cb66-402" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">!=</span> n) {</span>
<span id="cb66-403"><a href="annex-i-compendium-of-r-scripts.html#cb66-403" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) <span class="sc">&gt;</span> n) {</span>
<span id="cb66-404"><a href="annex-i-compendium-of-r-scripts.html#cb66-404" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reduce sample count for the largest polygon until total count is n</span></span>
<span id="cb66-405"><a href="annex-i-compendium-of-r-scripts.html#cb66-405" aria-hidden="true" tabindex="-1"></a>        max_index <span class="ot">&lt;-</span> <span class="fu">which.max</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb66-406"><a href="annex-i-compendium-of-r-scripts.html#cb66-406" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[max_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[max_index] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb66-407"><a href="annex-i-compendium-of-r-scripts.html#cb66-407" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb66-408"><a href="annex-i-compendium-of-r-scripts.html#cb66-408" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Increase sample count for the smallest polygon until total count is n</span></span>
<span id="cb66-409"><a href="annex-i-compendium-of-r-scripts.html#cb66-409" aria-hidden="true" tabindex="-1"></a>        min_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(group_areas<span class="sc">$</span>sample_count)</span>
<span id="cb66-410"><a href="annex-i-compendium-of-r-scripts.html#cb66-410" aria-hidden="true" tabindex="-1"></a>        group_areas<span class="sc">$</span>sample_count[min_index] <span class="ot">&lt;-</span> group_areas<span class="sc">$</span>sample_count[min_index] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb66-411"><a href="annex-i-compendium-of-r-scripts.html#cb66-411" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-412"><a href="annex-i-compendium-of-r-scripts.html#cb66-412" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-413"><a href="annex-i-compendium-of-r-scripts.html#cb66-413" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count the total samples. It must be equal to the sampling size</span></span>
<span id="cb66-414"><a href="annex-i-compendium-of-r-scripts.html#cb66-414" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(group_areas<span class="sc">$</span>sample_count) </span>
<span id="cb66-415"><a href="annex-i-compendium-of-r-scripts.html#cb66-415" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-416"><a href="annex-i-compendium-of-r-scripts.html#cb66-416" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> <span class="fu">left_join</span>(polygons, <span class="fu">st_drop_geometry</span>(group_areas),</span>
<span id="cb66-417"><a href="annex-i-compendium-of-r-scripts.html#cb66-417" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;soil_lc&quot;</span><span class="ot">=</span><span class="st">&quot;group&quot;</span>))</span>
<span id="cb66-418"><a href="annex-i-compendium-of-r-scripts.html#cb66-418" aria-hidden="true" tabindex="-1"></a>    polygons <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(polygons, soil_lc, code.x, sample_count, geometry)</span>
<span id="cb66-419"><a href="annex-i-compendium-of-r-scripts.html#cb66-419" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-420"><a href="annex-i-compendium-of-r-scripts.html#cb66-420" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate regular points within each strata of size 3 times</span></span>
<span id="cb66-421"><a href="annex-i-compendium-of-r-scripts.html#cb66-421" aria-hidden="true" tabindex="-1"></a>    <span class="co">#the required samples for each strata</span></span>
<span id="cb66-422"><a href="annex-i-compendium-of-r-scripts.html#cb66-422" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas),</span>
<span id="cb66-423"><a href="annex-i-compendium-of-r-scripts.html#cb66-423" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> group_areas<span class="sc">$</span>sample_count <span class="sc">*</span> <span class="dv">3</span>, <span class="at">method =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb66-424"><a href="annex-i-compendium-of-r-scripts.html#cb66-424" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-425"><a href="annex-i-compendium-of-r-scripts.html#cb66-425" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points for strata</span></span>
<span id="cb66-426"><a href="annex-i-compendium-of-r-scripts.html#cb66-426" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb66-427"><a href="annex-i-compendium-of-r-scripts.html#cb66-427" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-428"><a href="annex-i-compendium-of-r-scripts.html#cb66-428" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb66-429"><a href="annex-i-compendium-of-r-scripts.html#cb66-429" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb66-430"><a href="annex-i-compendium-of-r-scripts.html#cb66-430" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb66-431"><a href="annex-i-compendium-of-r-scripts.html#cb66-431" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb66-432"><a href="annex-i-compendium-of-r-scripts.html#cb66-432" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-433"><a href="annex-i-compendium-of-r-scripts.html#cb66-433" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb66-434"><a href="annex-i-compendium-of-r-scripts.html#cb66-434" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-435"><a href="annex-i-compendium-of-r-scripts.html#cb66-435" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find classes with missing samples</span></span>
<span id="cb66-436"><a href="annex-i-compendium-of-r-scripts.html#cb66-436" aria-hidden="true" tabindex="-1"></a>    missing.data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(group_areas,<span class="fu">data.frame</span>(z) <span class="sc">%&gt;%</span></span>
<span id="cb66-437"><a href="annex-i-compendium-of-r-scripts.html#cb66-437" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">filter</span>(type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb66-438"><a href="annex-i-compendium-of-r-scripts.html#cb66-438" aria-hidden="true" tabindex="-1"></a>                                dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span></span>
<span id="cb66-439"><a href="annex-i-compendium-of-r-scripts.html#cb66-439" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">tally</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb66-440"><a href="annex-i-compendium-of-r-scripts.html#cb66-440" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diff=</span>sample_count<span class="sc">-</span>n)</span>
<span id="cb66-441"><a href="annex-i-compendium-of-r-scripts.html#cb66-441" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-442"><a href="annex-i-compendium-of-r-scripts.html#cb66-442" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine missing sampled strata</span></span>
<span id="cb66-443"><a href="annex-i-compendium-of-r-scripts.html#cb66-443" aria-hidden="true" tabindex="-1"></a>    missing.strata <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(missing.data<span class="sc">$</span>diff))</span>
<span id="cb66-444"><a href="annex-i-compendium-of-r-scripts.html#cb66-444" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-445"><a href="annex-i-compendium-of-r-scripts.html#cb66-445" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine missing sampling point in strata (undersampled strata)</span></span>
<span id="cb66-446"><a href="annex-i-compendium-of-r-scripts.html#cb66-446" aria-hidden="true" tabindex="-1"></a>    missing.sample <span class="ot">=</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb66-447"><a href="annex-i-compendium-of-r-scripts.html#cb66-447" aria-hidden="true" tabindex="-1"></a>    missing.number <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">st_drop_geometry</span>(missing.data[(missing.sample <span class="ot">&lt;-</span> <span class="fu">which</span>(missing.data<span class="sc">$</span>diff <span class="sc">!=</span> <span class="dv">0</span>)),<span class="dv">7</span>])))</span>
<span id="cb66-448"><a href="annex-i-compendium-of-r-scripts.html#cb66-448" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-449"><a href="annex-i-compendium-of-r-scripts.html#cb66-449" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points for missing sampled strata</span></span>
<span id="cb66-450"><a href="annex-i-compendium-of-r-scripts.html#cb66-450" aria-hidden="true" tabindex="-1"></a>    x.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb66-451"><a href="annex-i-compendium-of-r-scripts.html#cb66-451" aria-hidden="true" tabindex="-1"></a>    x.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb66-452"><a href="annex-i-compendium-of-r-scripts.html#cb66-452" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-453"><a href="annex-i-compendium-of-r-scripts.html#cb66-453" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.strata){</span>
<span id="cb66-454"><a href="annex-i-compendium-of-r-scripts.html#cb66-454" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb66-455"><a href="annex-i-compendium-of-r-scripts.html#cb66-455" aria-hidden="true" tabindex="-1"></a>      xx.missing.strata<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb66-456"><a href="annex-i-compendium-of-r-scripts.html#cb66-456" aria-hidden="true" tabindex="-1"></a>      nn<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb66-457"><a href="annex-i-compendium-of-r-scripts.html#cb66-457" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> </span>
<span id="cb66-458"><a href="annex-i-compendium-of-r-scripts.html#cb66-458" aria-hidden="true" tabindex="-1"></a>             group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>) {</span>
<span id="cb66-459"><a href="annex-i-compendium-of-r-scripts.html#cb66-459" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-460"><a href="annex-i-compendium-of-r-scripts.html#cb66-460" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span>(nn <span class="sc">&lt;</span> group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>){</span>
<span id="cb66-461"><a href="annex-i-compendium-of-r-scripts.html#cb66-461" aria-hidden="true" tabindex="-1"></a>          my.missing.strata <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb66-462"><a href="annex-i-compendium-of-r-scripts.html#cb66-462" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">size =</span>  group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">5</span>,</span>
<span id="cb66-463"><a href="annex-i-compendium-of-r-scripts.html#cb66-463" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">method =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb66-464"><a href="annex-i-compendium-of-r-scripts.html#cb66-464" aria-hidden="true" tabindex="-1"></a>          nn <span class="ot">&lt;-</span> nn <span class="sc">+</span> <span class="fu">nrow</span>(<span class="fu">data.frame</span>(my.missing.strata))</span>
<span id="cb66-465"><a href="annex-i-compendium-of-r-scripts.html#cb66-465" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb66-466"><a href="annex-i-compendium-of-r-scripts.html#cb66-466" aria-hidden="true" tabindex="-1"></a>        xx.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.strata,my.missing.strata)</span>
<span id="cb66-467"><a href="annex-i-compendium-of-r-scripts.html#cb66-467" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.strata<span class="sc">$</span>sample_count))</span>
<span id="cb66-468"><a href="annex-i-compendium-of-r-scripts.html#cb66-468" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-469"><a href="annex-i-compendium-of-r-scripts.html#cb66-469" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb66-470"><a href="annex-i-compendium-of-r-scripts.html#cb66-470" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.strata)</span>
<span id="cb66-471"><a href="annex-i-compendium-of-r-scripts.html#cb66-471" aria-hidden="true" tabindex="-1"></a>      x.missing.strata <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.strata,xx.missing.strata)</span>
<span id="cb66-472"><a href="annex-i-compendium-of-r-scripts.html#cb66-472" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-473"><a href="annex-i-compendium-of-r-scripts.html#cb66-473" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-474"><a href="annex-i-compendium-of-r-scripts.html#cb66-474" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join initial sampling with missing sampling strata data</span></span>
<span id="cb66-475"><a href="annex-i-compendium-of-r-scripts.html#cb66-475" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.strata)</span>
<span id="cb66-476"><a href="annex-i-compendium-of-r-scripts.html#cb66-476" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-477"><a href="annex-i-compendium-of-r-scripts.html#cb66-477" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points for missing samples (regular sampling)</span></span>
<span id="cb66-478"><a href="annex-i-compendium-of-r-scripts.html#cb66-478" aria-hidden="true" tabindex="-1"></a>    x.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb66-479"><a href="annex-i-compendium-of-r-scripts.html#cb66-479" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-480"><a href="annex-i-compendium-of-r-scripts.html#cb66-480" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> missing.sample){</span>
<span id="cb66-481"><a href="annex-i-compendium-of-r-scripts.html#cb66-481" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb66-482"><a href="annex-i-compendium-of-r-scripts.html#cb66-482" aria-hidden="true" tabindex="-1"></a>      xx.missing.sample<span class="sc">$</span>sample_count<span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb66-483"><a href="annex-i-compendium-of-r-scripts.html#cb66-483" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count) <span class="sc">&lt;</span> (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>)) {</span>
<span id="cb66-484"><a href="annex-i-compendium-of-r-scripts.html#cb66-484" aria-hidden="true" tabindex="-1"></a>        my.missing.sample <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> <span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,]),</span>
<span id="cb66-485"><a href="annex-i-compendium-of-r-scripts.html#cb66-485" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">size =</span> <span class="fu">as.numeric</span>(<span class="fu">vect</span>(group_areas[group_areas<span class="sc">$</span>code <span class="sc">%in%</span> i,])[[<span class="dv">4</span>]])<span class="sc">+</span></span>
<span id="cb66-486"><a href="annex-i-compendium-of-r-scripts.html#cb66-486" aria-hidden="true" tabindex="-1"></a>                                          (group_areas[group_areas<span class="sc">$</span>code<span class="sc">==</span>i,][[<span class="st">&quot;sample_count&quot;</span>]]<span class="sc">*</span><span class="dv">3</span>), <span class="at">method =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb66-487"><a href="annex-i-compendium-of-r-scripts.html#cb66-487" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-488"><a href="annex-i-compendium-of-r-scripts.html#cb66-488" aria-hidden="true" tabindex="-1"></a>        xx.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(xx.missing.sample,my.missing.sample)</span>
<span id="cb66-489"><a href="annex-i-compendium-of-r-scripts.html#cb66-489" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">sum</span>(xx.missing.sample<span class="sc">$</span>sample_count))</span>
<span id="cb66-490"><a href="annex-i-compendium-of-r-scripts.html#cb66-490" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-491"><a href="annex-i-compendium-of-r-scripts.html#cb66-491" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(i)</span>
<span id="cb66-492"><a href="annex-i-compendium-of-r-scripts.html#cb66-492" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(xx.missing.sample)</span>
<span id="cb66-493"><a href="annex-i-compendium-of-r-scripts.html#cb66-493" aria-hidden="true" tabindex="-1"></a>      x.missing.sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x.missing.sample,xx.missing.sample)</span>
<span id="cb66-494"><a href="annex-i-compendium-of-r-scripts.html#cb66-494" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-495"><a href="annex-i-compendium-of-r-scripts.html#cb66-495" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-496"><a href="annex-i-compendium-of-r-scripts.html#cb66-496" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join initial sampling with missing sampling strata data and with missing samples </span></span>
<span id="cb66-497"><a href="annex-i-compendium-of-r-scripts.html#cb66-497" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, x.missing.sample)</span>
<span id="cb66-498"><a href="annex-i-compendium-of-r-scripts.html#cb66-498" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-499"><a href="annex-i-compendium-of-r-scripts.html#cb66-499" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove extra artificial replacements </span></span>
<span id="cb66-500"><a href="annex-i-compendium-of-r-scripts.html#cb66-500" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x[x<span class="sc">$</span>sample_count <span class="sc">&gt;</span> <span class="dv">0</span>,]</span>
<span id="cb66-501"><a href="annex-i-compendium-of-r-scripts.html#cb66-501" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-502"><a href="annex-i-compendium-of-r-scripts.html#cb66-502" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert and export to shapefile</span></span>
<span id="cb66-503"><a href="annex-i-compendium-of-r-scripts.html#cb66-503" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb66-504"><a href="annex-i-compendium-of-r-scripts.html#cb66-504" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-505"><a href="annex-i-compendium-of-r-scripts.html#cb66-505" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span> </span>
<span id="cb66-506"><a href="annex-i-compendium-of-r-scripts.html#cb66-506" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">as.numeric</span>(sample_count),</span>
<span id="cb66-507"><a href="annex-i-compendium-of-r-scripts.html#cb66-507" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(code),</span>
<span id="cb66-508"><a href="annex-i-compendium-of-r-scripts.html#cb66-508" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(code, <span class="st">&quot;.&quot;</span>, order),</span>
<span id="cb66-509"><a href="annex-i-compendium-of-r-scripts.html#cb66-509" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">ifelse</span>(sample_count <span class="sc">&gt;=</span> order, <span class="st">&quot;Target&quot;</span>, <span class="st">&quot;Replacement&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-510"><a href="annex-i-compendium-of-r-scripts.html#cb66-510" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb66-511"><a href="annex-i-compendium-of-r-scripts.html#cb66-511" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeVector</span>(z,</span>
<span id="cb66-512"><a href="annex-i-compendium-of-r-scripts.html#cb66-512" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(results.path,<span class="st">&quot;strat_randm_samples.shp&quot;</span>, <span class="at">overwrite=</span><span class="cn">TRUE</span>))</span>
<span id="cb66-513"><a href="annex-i-compendium-of-r-scripts.html#cb66-513" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-514"><a href="annex-i-compendium-of-r-scripts.html#cb66-514" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the number of initial target points equals the final target points </span></span>
<span id="cb66-515"><a href="annex-i-compendium-of-r-scripts.html#cb66-515" aria-hidden="true" tabindex="-1"></a>    n<span class="sc">==</span><span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb66-516"><a href="annex-i-compendium-of-r-scripts.html#cb66-516" aria-hidden="true" tabindex="-1"></a>    n;<span class="fu">nrow</span>(z[z<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;Target&quot;</span>,])</span>
<span id="cb66-517"><a href="annex-i-compendium-of-r-scripts.html#cb66-517" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-518"><a href="annex-i-compendium-of-r-scripts.html#cb66-518" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb66-519"><a href="annex-i-compendium-of-r-scripts.html#cb66-519" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">11.4</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb66-520"><a href="annex-i-compendium-of-r-scripts.html#cb66-520" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb66-521"><a href="annex-i-compendium-of-r-scripts.html#cb66-521" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>) <span class="sc">+</span> </span>
<span id="cb66-522"><a href="annex-i-compendium-of-r-scripts.html#cb66-522" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(sf<span class="sc">::</span><span class="fu">st_as_sf</span>(z), <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;royalblue&#39;</span>, <span class="st">&#39;tomato&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Samples&quot;</span>)</span>
<span id="cb66-523"><a href="annex-i-compendium-of-r-scripts.html#cb66-523" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span>
<span id="cb66-524"><a href="annex-i-compendium-of-r-scripts.html#cb66-524" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-525"><a href="annex-i-compendium-of-r-scripts.html#cb66-525" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-526"><a href="annex-i-compendium-of-r-scripts.html#cb66-526" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Random Sampling based on a stratified raster</span></span>
<span id="cb66-527"><a href="annex-i-compendium-of-r-scripts.html#cb66-527" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;strata.shp&quot;</span>),<span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-528"><a href="annex-i-compendium-of-r-scripts.html#cb66-528" aria-hidden="true" tabindex="-1"></a>    strata<span class="sc">$</span>code <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(strata<span class="sc">$</span>code)</span>
<span id="cb66-529"><a href="annex-i-compendium-of-r-scripts.html#cb66-529" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-530"><a href="annex-i-compendium-of-r-scripts.html#cb66-530" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create stratification raster </span></span>
<span id="cb66-531"><a href="annex-i-compendium-of-r-scripts.html#cb66-531" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">st_rasterize</span>(strata[<span class="st">&quot;code&quot;</span>],<span class="fu">st_as_stars</span>(<span class="fu">st_bbox</span>(strata), <span class="at">nx =</span> <span class="dv">250</span>, <span class="at">ny =</span> <span class="dv">250</span>)))</span>
<span id="cb66-532"><a href="annex-i-compendium-of-r-scripts.html#cb66-532" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(strata) <span class="ot">&lt;-</span> <span class="st">&quot;strata&quot;</span></span>
<span id="cb66-533"><a href="annex-i-compendium-of-r-scripts.html#cb66-533" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> <span class="fu">crop</span>(strata, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-534"><a href="annex-i-compendium-of-r-scripts.html#cb66-534" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-535"><a href="annex-i-compendium-of-r-scripts.html#cb66-535" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create stratified random sampling</span></span>
<span id="cb66-536"><a href="annex-i-compendium-of-r-scripts.html#cb66-536" aria-hidden="true" tabindex="-1"></a>    target <span class="ot">&lt;-</span> <span class="fu">sample_strat</span>(</span>
<span id="cb66-537"><a href="annex-i-compendium-of-r-scripts.html#cb66-537" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb66-538"><a href="annex-i-compendium-of-r-scripts.html#cb66-538" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSamp =</span> <span class="dv">200</span></span>
<span id="cb66-539"><a href="annex-i-compendium-of-r-scripts.html#cb66-539" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb66-540"><a href="annex-i-compendium-of-r-scripts.html#cb66-540" aria-hidden="true" tabindex="-1"></a>    target<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;target&quot;</span></span>
<span id="cb66-541"><a href="annex-i-compendium-of-r-scripts.html#cb66-541" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-542"><a href="annex-i-compendium-of-r-scripts.html#cb66-542" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Histogram of frequencies for targets</span></span>
<span id="cb66-543"><a href="annex-i-compendium-of-r-scripts.html#cb66-543" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_representation</span>(</span>
<span id="cb66-544"><a href="annex-i-compendium-of-r-scripts.html#cb66-544" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb66-545"><a href="annex-i-compendium-of-r-scripts.html#cb66-545" aria-hidden="true" tabindex="-1"></a>      <span class="at">existing =</span> target,</span>
<span id="cb66-546"><a href="annex-i-compendium-of-r-scripts.html#cb66-546" aria-hidden="true" tabindex="-1"></a>      <span class="at">drop=</span><span class="dv">0</span>,</span>
<span id="cb66-547"><a href="annex-i-compendium-of-r-scripts.html#cb66-547" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="cn">TRUE</span> </span>
<span id="cb66-548"><a href="annex-i-compendium-of-r-scripts.html#cb66-548" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb66-549"><a href="annex-i-compendium-of-r-scripts.html#cb66-549" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-550"><a href="annex-i-compendium-of-r-scripts.html#cb66-550" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add index by strata</span></span>
<span id="cb66-551"><a href="annex-i-compendium-of-r-scripts.html#cb66-551" aria-hidden="true" tabindex="-1"></a>    target <span class="ot">&lt;-</span> target <span class="sc">%&gt;%</span> </span>
<span id="cb66-552"><a href="annex-i-compendium-of-r-scripts.html#cb66-552" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-553"><a href="annex-i-compendium-of-r-scripts.html#cb66-553" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(strata) <span class="sc">%&gt;%</span> </span>
<span id="cb66-554"><a href="annex-i-compendium-of-r-scripts.html#cb66-554" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">sum</span>(n),</span>
<span id="cb66-555"><a href="annex-i-compendium-of-r-scripts.html#cb66-555" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(strata),</span>
<span id="cb66-556"><a href="annex-i-compendium-of-r-scripts.html#cb66-556" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(strata, <span class="st">&quot;.&quot;</span>, order)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-557"><a href="annex-i-compendium-of-r-scripts.html#cb66-557" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb66-558"><a href="annex-i-compendium-of-r-scripts.html#cb66-558" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-559"><a href="annex-i-compendium-of-r-scripts.html#cb66-559" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Histogram of frequencies for replacements</span></span>
<span id="cb66-560"><a href="annex-i-compendium-of-r-scripts.html#cb66-560" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_representation</span>(</span>
<span id="cb66-561"><a href="annex-i-compendium-of-r-scripts.html#cb66-561" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb66-562"><a href="annex-i-compendium-of-r-scripts.html#cb66-562" aria-hidden="true" tabindex="-1"></a>      <span class="at">existing =</span> replacement,</span>
<span id="cb66-563"><a href="annex-i-compendium-of-r-scripts.html#cb66-563" aria-hidden="true" tabindex="-1"></a>      <span class="at">drop=</span><span class="dv">0</span>,</span>
<span id="cb66-564"><a href="annex-i-compendium-of-r-scripts.html#cb66-564" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="cn">TRUE</span> </span>
<span id="cb66-565"><a href="annex-i-compendium-of-r-scripts.html#cb66-565" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb66-566"><a href="annex-i-compendium-of-r-scripts.html#cb66-566" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-567"><a href="annex-i-compendium-of-r-scripts.html#cb66-567" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add index by strata</span></span>
<span id="cb66-568"><a href="annex-i-compendium-of-r-scripts.html#cb66-568" aria-hidden="true" tabindex="-1"></a>    replacement <span class="ot">&lt;-</span> replacement <span class="sc">%&gt;%</span> </span>
<span id="cb66-569"><a href="annex-i-compendium-of-r-scripts.html#cb66-569" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-570"><a href="annex-i-compendium-of-r-scripts.html#cb66-570" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(strata) <span class="sc">%&gt;%</span> </span>
<span id="cb66-571"><a href="annex-i-compendium-of-r-scripts.html#cb66-571" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_count =</span> <span class="fu">sum</span>(n),</span>
<span id="cb66-572"><a href="annex-i-compendium-of-r-scripts.html#cb66-572" aria-hidden="true" tabindex="-1"></a>                    <span class="at">order =</span> <span class="fu">seq_along</span>(strata),</span>
<span id="cb66-573"><a href="annex-i-compendium-of-r-scripts.html#cb66-573" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ID =</span> <span class="fu">paste0</span>(strata, <span class="st">&quot;.&quot;</span>, order)) <span class="sc">%&gt;%</span> </span>
<span id="cb66-574"><a href="annex-i-compendium-of-r-scripts.html#cb66-574" aria-hidden="true" tabindex="-1"></a>      <span class="fu">vect</span>()</span>
<span id="cb66-575"><a href="annex-i-compendium-of-r-scripts.html#cb66-575" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-576"><a href="annex-i-compendium-of-r-scripts.html#cb66-576" aria-hidden="true" tabindex="-1"></a>    replacement <span class="ot">&lt;-</span> <span class="fu">sample_strat</span>(</span>
<span id="cb66-577"><a href="annex-i-compendium-of-r-scripts.html#cb66-577" aria-hidden="true" tabindex="-1"></a>      <span class="at">sraster =</span> strata,</span>
<span id="cb66-578"><a href="annex-i-compendium-of-r-scripts.html#cb66-578" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSamp =</span> <span class="dv">200</span><span class="sc">*</span><span class="dv">3</span></span>
<span id="cb66-579"><a href="annex-i-compendium-of-r-scripts.html#cb66-579" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb66-580"><a href="annex-i-compendium-of-r-scripts.html#cb66-580" aria-hidden="true" tabindex="-1"></a>    replacement<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;replacement&quot;</span></span>
<span id="cb66-581"><a href="annex-i-compendium-of-r-scripts.html#cb66-581" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-582"><a href="annex-i-compendium-of-r-scripts.html#cb66-582" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot samples over strata</span></span>
<span id="cb66-583"><a href="annex-i-compendium-of-r-scripts.html#cb66-583" aria-hidden="true" tabindex="-1"></a>      <span class="co"># plot(strata, main=&quot;Strata and random samples&quot;)</span></span>
<span id="cb66-584"><a href="annex-i-compendium-of-r-scripts.html#cb66-584" aria-hidden="true" tabindex="-1"></a>      <span class="co"># plot(nghe[1], col=&quot;transparent&quot;, add=TRUE)</span></span>
<span id="cb66-585"><a href="annex-i-compendium-of-r-scripts.html#cb66-585" aria-hidden="true" tabindex="-1"></a>      <span class="co"># points(target,col=&quot;red&quot;)</span></span>
<span id="cb66-586"><a href="annex-i-compendium-of-r-scripts.html#cb66-586" aria-hidden="true" tabindex="-1"></a>      <span class="co"># points(replacement,col=&quot;dodgerblue&quot;)</span></span>
<span id="cb66-587"><a href="annex-i-compendium-of-r-scripts.html#cb66-587" aria-hidden="true" tabindex="-1"></a>      <span class="co"># legend(&quot;topleft&quot;, legend = c(&quot;target&quot;,&quot;replacement&quot;), pch = 20, xpd=NA, bg=&quot;white&quot;, col=c(&quot;red&quot;,&quot;dodgerblue&quot;))</span></span>
<span id="cb66-588"><a href="annex-i-compendium-of-r-scripts.html#cb66-588" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-589"><a href="annex-i-compendium-of-r-scripts.html#cb66-589" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">=</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">minZoom =</span> <span class="fl">8.3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb66-590"><a href="annex-i-compendium-of-r-scripts.html#cb66-590" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>()</span>
<span id="cb66-591"><a href="annex-i-compendium-of-r-scripts.html#cb66-591" aria-hidden="true" tabindex="-1"></a>    mv <span class="ot">&lt;-</span> <span class="fu">mapview</span>(soil_lc[<span class="st">&quot;soil_lc&quot;</span>], <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">homebutton=</span>T, <span class="at">layer.name =</span> <span class="st">&quot;Strata&quot;</span>) <span class="sc">+</span> </span>
<span id="cb66-592"><a href="annex-i-compendium-of-r-scripts.html#cb66-592" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(target, <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;tomato&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Target&quot;</span>) <span class="sc">+</span> </span>
<span id="cb66-593"><a href="annex-i-compendium-of-r-scripts.html#cb66-593" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapview</span>(replacement, <span class="at">zcol =</span> <span class="st">&#39;type&#39;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">col.regions =</span> <span class="fu">c</span>(<span class="st">&#39;royalblue&#39;</span>), <span class="at">cex=</span><span class="dv">3</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>,<span class="at">layer.name =</span> <span class="st">&quot;Replacement&quot;</span>)</span>
<span id="cb66-594"><a href="annex-i-compendium-of-r-scripts.html#cb66-594" aria-hidden="true" tabindex="-1"></a>    mv<span class="sc">@</span>map</span></code></pre></div>
</div>
<div id="script-6-conditional-latin-hypercube-sampling" class="section level2 unnumbered hasAnchor">
<h2>Script 6: Conditional Latin Hypercube Sampling<a href="annex-i-compendium-of-r-scripts.html#script-6-conditional-latin-hypercube-sampling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="annex-i-compendium-of-r-scripts.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb67-2"><a href="annex-i-compendium-of-r-scripts.html#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb67-3"><a href="annex-i-compendium-of-r-scripts.html#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Sampling Design</span></span>
<span id="cb67-4"><a href="annex-i-compendium-of-r-scripts.html#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># conditional Latin Hypercube Sampling</span></span>
<span id="cb67-5"><a href="annex-i-compendium-of-r-scripts.html#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb67-6"><a href="annex-i-compendium-of-r-scripts.html#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb67-7"><a href="annex-i-compendium-of-r-scripts.html#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Luis.RodriguezLado@fao.org</span></span>
<span id="cb67-8"><a href="annex-i-compendium-of-r-scripts.html#cb67-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-9"><a href="annex-i-compendium-of-r-scripts.html#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb67-10"><a href="annex-i-compendium-of-r-scripts.html#cb67-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-11"><a href="annex-i-compendium-of-r-scripts.html#cb67-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empty environment and cache </span></span>
<span id="cb67-12"><a href="annex-i-compendium-of-r-scripts.html#cb67-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb67-13"><a href="annex-i-compendium-of-r-scripts.html#cb67-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb67-14"><a href="annex-i-compendium-of-r-scripts.html#cb67-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-15"><a href="annex-i-compendium-of-r-scripts.html#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script ========================================</span></span>
<span id="cb67-16"><a href="annex-i-compendium-of-r-scripts.html#cb67-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-17"><a href="annex-i-compendium-of-r-scripts.html#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Script for creating a sampling design based on conditioned Latin Hypercube Sampling.</span></span>
<span id="cb67-18"><a href="annex-i-compendium-of-r-scripts.html#cb67-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Given a suite of covariates this algorithm will assess the optimal location of</span></span>
<span id="cb67-19"><a href="annex-i-compendium-of-r-scripts.html#cb67-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  samples based on the amount of information in the set of covariates.</span></span>
<span id="cb67-20"><a href="annex-i-compendium-of-r-scripts.html#cb67-20" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb67-21"><a href="annex-i-compendium-of-r-scripts.html#cb67-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory and load packages</span></span>
<span id="cb67-22"><a href="annex-i-compendium-of-r-scripts.html#cb67-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - User-defined variables </span></span>
<span id="cb67-23"><a href="annex-i-compendium-of-r-scripts.html#cb67-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import national data </span></span>
<span id="cb67-24"><a href="annex-i-compendium-of-r-scripts.html#cb67-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Compute clhs</span></span>
<span id="cb67-25"><a href="annex-i-compendium-of-r-scripts.html#cb67-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Including existing legacy data in a cLHS sampling design </span></span>
<span id="cb67-26"><a href="annex-i-compendium-of-r-scripts.html#cb67-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Working with large raster data</span></span>
<span id="cb67-27"><a href="annex-i-compendium-of-r-scripts.html#cb67-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Cost–constrained cLHS sampling</span></span>
<span id="cb67-28"><a href="annex-i-compendium-of-r-scripts.html#cb67-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Replacement areas in cLHS design</span></span>
<span id="cb67-29"><a href="annex-i-compendium-of-r-scripts.html#cb67-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Polygonize replacement areas by similarity   </span></span>
<span id="cb67-30"><a href="annex-i-compendium-of-r-scripts.html#cb67-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Constrained cLHS sampling accounting for accessibility and legacy data  </span></span>
<span id="cb67-31"><a href="annex-i-compendium-of-r-scripts.html#cb67-31" aria-hidden="true" tabindex="-1"></a><span class="co">#________________________________________________________________</span></span>
<span id="cb67-32"><a href="annex-i-compendium-of-r-scripts.html#cb67-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-33"><a href="annex-i-compendium-of-r-scripts.html#cb67-33" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb67-34"><a href="annex-i-compendium-of-r-scripts.html#cb67-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-35"><a href="annex-i-compendium-of-r-scripts.html#cb67-35" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 - Set working directory and load packages =================================</span></span>
<span id="cb67-36"><a href="annex-i-compendium-of-r-scripts.html#cb67-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-37"><a href="annex-i-compendium-of-r-scripts.html#cb67-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#remotes::install_github(&quot;lemuscanovas/synoptReg&quot;)</span></span>
<span id="cb67-38"><a href="annex-i-compendium-of-r-scripts.html#cb67-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-39"><a href="annex-i-compendium-of-r-scripts.html#cb67-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set working directory to source file location</span></span>
<span id="cb67-40"><a href="annex-i-compendium-of-r-scripts.html#cb67-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb67-41"><a href="annex-i-compendium-of-r-scripts.html#cb67-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setwd</span>(<span class="st">&quot;../&quot;</span>) <span class="co"># Move wd down to main folder</span></span>
<span id="cb67-42"><a href="annex-i-compendium-of-r-scripts.html#cb67-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-43"><a href="annex-i-compendium-of-r-scripts.html#cb67-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of packages</span></span>
<span id="cb67-44"><a href="annex-i-compendium-of-r-scripts.html#cb67-44" aria-hidden="true" tabindex="-1"></a>  packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sp&quot;</span>,<span class="st">&quot;terra&quot;</span>,<span class="st">&quot;raster&quot;</span>,<span class="st">&quot;sf&quot;</span>,<span class="st">&quot;clhs&quot;</span>, <span class="st">&quot;sgsR&quot;</span>,<span class="st">&quot;entropy&quot;</span>, <span class="st">&quot;tripack&quot;</span>,</span>
<span id="cb67-45"><a href="annex-i-compendium-of-r-scripts.html#cb67-45" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;manipulate&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;synoptReg&quot;</span>)</span>
<span id="cb67-46"><a href="annex-i-compendium-of-r-scripts.html#cb67-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load packages</span></span>
<span id="cb67-47"><a href="annex-i-compendium-of-r-scripts.html#cb67-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(packages, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-48"><a href="annex-i-compendium-of-r-scripts.html#cb67-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove object to save memory space</span></span>
<span id="cb67-49"><a href="annex-i-compendium-of-r-scripts.html#cb67-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(packages) </span>
<span id="cb67-50"><a href="annex-i-compendium-of-r-scripts.html#cb67-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-51"><a href="annex-i-compendium-of-r-scripts.html#cb67-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-52"><a href="annex-i-compendium-of-r-scripts.html#cb67-52" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 - User-defined variables ==================================================</span></span>
<span id="cb67-53"><a href="annex-i-compendium-of-r-scripts.html#cb67-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to rasters</span></span>
<span id="cb67-54"><a href="annex-i-compendium-of-r-scripts.html#cb67-54" aria-hidden="true" tabindex="-1"></a>  raster.path <span class="ot">&lt;-</span> <span class="st">&quot;data/rasters/&quot;</span></span>
<span id="cb67-55"><a href="annex-i-compendium-of-r-scripts.html#cb67-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to shapes</span></span>
<span id="cb67-56"><a href="annex-i-compendium-of-r-scripts.html#cb67-56" aria-hidden="true" tabindex="-1"></a>  shp.path <span class="ot">&lt;-</span> <span class="st">&quot;data/shapes/&quot;</span></span>
<span id="cb67-57"><a href="annex-i-compendium-of-r-scripts.html#cb67-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path to results</span></span>
<span id="cb67-58"><a href="annex-i-compendium-of-r-scripts.html#cb67-58" aria-hidden="true" tabindex="-1"></a>  results.path <span class="ot">&lt;-</span> <span class="st">&quot;data/results/&quot;</span></span>
<span id="cb67-59"><a href="annex-i-compendium-of-r-scripts.html#cb67-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Buffer distance for replacement areas (clhs)</span></span>
<span id="cb67-60"><a href="annex-i-compendium-of-r-scripts.html#cb67-60" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co"># Buffer distance to calculate replacement areas </span></span>
<span id="cb67-61"><a href="annex-i-compendium-of-r-scripts.html#cb67-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the minimum sample size. By default it uses the value calculated previously</span></span>
<span id="cb67-62"><a href="annex-i-compendium-of-r-scripts.html#cb67-62" aria-hidden="true" tabindex="-1"></a>  minimum_n <span class="ot">&lt;-</span> <span class="dv">180</span></span>
<span id="cb67-63"><a href="annex-i-compendium-of-r-scripts.html#cb67-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregation factor for up-scaling raster covariates (optional)</span></span>
<span id="cb67-64"><a href="annex-i-compendium-of-r-scripts.html#cb67-64" aria-hidden="true" tabindex="-1"></a>  agg.factor <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb67-65"><a href="annex-i-compendium-of-r-scripts.html#cb67-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-66"><a href="annex-i-compendium-of-r-scripts.html#cb67-66" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 - Import national data ====================================================</span></span>
<span id="cb67-67"><a href="annex-i-compendium-of-r-scripts.html#cb67-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-68"><a href="annex-i-compendium-of-r-scripts.html#cb67-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read Spatial data covariates as rasters with terra</span></span>
<span id="cb67-69"><a href="annex-i-compendium-of-r-scripts.html#cb67-69" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span>  <span class="fu">list.files</span>(raster.path, <span class="at">pattern =</span> <span class="st">&quot;tif$&quot;</span>,  <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-70"><a href="annex-i-compendium-of-r-scripts.html#cb67-70" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(cov.dat) <span class="co"># SpatRaster from terra</span></span>
<span id="cb67-71"><a href="annex-i-compendium-of-r-scripts.html#cb67-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load shape of district</span></span>
<span id="cb67-72"><a href="annex-i-compendium-of-r-scripts.html#cb67-72" aria-hidden="true" tabindex="-1"></a>  nghe <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/Nghe_An.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-73"><a href="annex-i-compendium-of-r-scripts.html#cb67-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-74"><a href="annex-i-compendium-of-r-scripts.html#cb67-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crop covariates on administrative boundary</span></span>
<span id="cb67-75"><a href="annex-i-compendium-of-r-scripts.html#cb67-75" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> <span class="fu">crop</span>(cov.dat, nghe, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-76"><a href="annex-i-compendium-of-r-scripts.html#cb67-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store elevation and slope separately</span></span>
<span id="cb67-77"><a href="annex-i-compendium-of-r-scripts.html#cb67-77" aria-hidden="true" tabindex="-1"></a>  elevation <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_elevation_250m</span>
<span id="cb67-78"><a href="annex-i-compendium-of-r-scripts.html#cb67-78" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> cov.dat<span class="sc">$</span>dtm_slope_250m</span>
<span id="cb67-79"><a href="annex-i-compendium-of-r-scripts.html#cb67-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-80"><a href="annex-i-compendium-of-r-scripts.html#cb67-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load roads</span></span>
<span id="cb67-81"><a href="annex-i-compendium-of-r-scripts.html#cb67-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">#roads &lt;-  vect(file.path(paste0(shp.path,&quot;/roads.shp&quot;)))</span></span>
<span id="cb67-82"><a href="annex-i-compendium-of-r-scripts.html#cb67-82" aria-hidden="true" tabindex="-1"></a>  <span class="co">#roads &lt;- crop(roads, nghe) </span></span>
<span id="cb67-83"><a href="annex-i-compendium-of-r-scripts.html#cb67-83" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span>  sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/roads.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-84"><a href="annex-i-compendium-of-r-scripts.html#cb67-84" aria-hidden="true" tabindex="-1"></a>  roads <span class="ot">&lt;-</span>  <span class="fu">st_intersection</span>(roads, nghe)</span>
<span id="cb67-85"><a href="annex-i-compendium-of-r-scripts.html#cb67-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-86"><a href="annex-i-compendium-of-r-scripts.html#cb67-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simplify raster information with PCA</span></span>
<span id="cb67-87"><a href="annex-i-compendium-of-r-scripts.html#cb67-87" aria-hidden="true" tabindex="-1"></a>  pca <span class="ot">&lt;-</span> <span class="fu">raster_pca</span>(cov.dat)</span>
<span id="cb67-88"><a href="annex-i-compendium-of-r-scripts.html#cb67-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-89"><a href="annex-i-compendium-of-r-scripts.html#cb67-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get SpatRaster layers</span></span>
<span id="cb67-90"><a href="annex-i-compendium-of-r-scripts.html#cb67-90" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA</span>
<span id="cb67-91"><a href="annex-i-compendium-of-r-scripts.html#cb67-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a raster stack to be used as input in the clhs::clhs function </span></span>
<span id="cb67-92"><a href="annex-i-compendium-of-r-scripts.html#cb67-92" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat) </span>
<span id="cb67-93"><a href="annex-i-compendium-of-r-scripts.html#cb67-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset rasters</span></span>
<span id="cb67-94"><a href="annex-i-compendium-of-r-scripts.html#cb67-94" aria-hidden="true" tabindex="-1"></a>  cov.dat <span class="ot">&lt;-</span> pca<span class="sc">$</span>PCA[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb67-95"><a href="annex-i-compendium-of-r-scripts.html#cb67-95" aria-hidden="true" tabindex="-1"></a>  cov.dat.ras <span class="ot">&lt;-</span>  cov.dat.ras[[<span class="dv">1</span><span class="sc">:</span><span class="fu">first</span>(<span class="fu">which</span>(pca<span class="sc">$</span>summaryPCA[<span class="dv">3</span>,]<span class="sc">&gt;</span><span class="fl">0.99</span>))]]</span>
<span id="cb67-96"><a href="annex-i-compendium-of-r-scripts.html#cb67-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-97"><a href="annex-i-compendium-of-r-scripts.html#cb67-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregate stack to simplify data rasters for calculations </span></span>
<span id="cb67-98"><a href="annex-i-compendium-of-r-scripts.html#cb67-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cov.dat &lt;- aggregate(cov.dat, fact=10, fun=&quot;mean&quot;)</span></span>
<span id="cb67-99"><a href="annex-i-compendium-of-r-scripts.html#cb67-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-100"><a href="annex-i-compendium-of-r-scripts.html#cb67-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot of covariates</span></span>
<span id="cb67-101"><a href="annex-i-compendium-of-r-scripts.html#cb67-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat)</span>
<span id="cb67-102"><a href="annex-i-compendium-of-r-scripts.html#cb67-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-103"><a href="annex-i-compendium-of-r-scripts.html#cb67-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-104"><a href="annex-i-compendium-of-r-scripts.html#cb67-104" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 - Compute clhs ============================================================</span></span>
<span id="cb67-105"><a href="annex-i-compendium-of-r-scripts.html#cb67-105" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb67-106"><a href="annex-i-compendium-of-r-scripts.html#cb67-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Distribute sampling points with clhs</span></span>
<span id="cb67-107"><a href="annex-i-compendium-of-r-scripts.html#cb67-107" aria-hidden="true" tabindex="-1"></a>  pts <span class="ot">&lt;-</span> <span class="fu">clhs</span>(cov.dat.ras, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb67-108"><a href="annex-i-compendium-of-r-scripts.html#cb67-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot of objective function</span></span>
<span id="cb67-109"><a href="annex-i-compendium-of-r-scripts.html#cb67-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(pts, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb67-110"><a href="annex-i-compendium-of-r-scripts.html#cb67-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot cLHS samples on map</span></span>
<span id="cb67-111"><a href="annex-i-compendium-of-r-scripts.html#cb67-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples&quot;</span>)</span>
<span id="cb67-112"><a href="annex-i-compendium-of-r-scripts.html#cb67-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(pts<span class="sc">$</span>sampled_data, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb67-113"><a href="annex-i-compendium-of-r-scripts.html#cb67-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-114"><a href="annex-i-compendium-of-r-scripts.html#cb67-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-115"><a href="annex-i-compendium-of-r-scripts.html#cb67-115" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 - Including existing legacy data in a cLHS sampling design ================</span></span>
<span id="cb67-116"><a href="annex-i-compendium-of-r-scripts.html#cb67-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-117"><a href="annex-i-compendium-of-r-scripts.html#cb67-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create an artificial legacy dataset of 50 samples over the study area as an example</span></span>
<span id="cb67-118"><a href="annex-i-compendium-of-r-scripts.html#cb67-118" aria-hidden="true" tabindex="-1"></a>  legacy.data <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(cov.dat, <span class="dv">50</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>,<span class="at">xy=</span><span class="cn">TRUE</span>,<span class="at">method=</span><span class="st">&quot;random&quot;</span>, <span class="at">as.points=</span>T) <span class="co"># works with SpatRaster </span></span>
<span id="cb67-119"><a href="annex-i-compendium-of-r-scripts.html#cb67-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-120"><a href="annex-i-compendium-of-r-scripts.html#cb67-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get covariates data as a points</span></span>
<span id="cb67-121"><a href="annex-i-compendium-of-r-scripts.html#cb67-121" aria-hidden="true" tabindex="-1"></a>  cov.df<span class="ot">&lt;-</span> <span class="fu">as.points</span>(cov.dat)</span>
<span id="cb67-122"><a href="annex-i-compendium-of-r-scripts.html#cb67-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-123"><a href="annex-i-compendium-of-r-scripts.html#cb67-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge legacy and covariate information</span></span>
<span id="cb67-124"><a href="annex-i-compendium-of-r-scripts.html#cb67-124" aria-hidden="true" tabindex="-1"></a>  leg.new <span class="ot">&lt;-</span>   <span class="fu">rbind</span>(legacy.data, cov.df)</span>
<span id="cb67-125"><a href="annex-i-compendium-of-r-scripts.html#cb67-125" aria-hidden="true" tabindex="-1"></a>  leg.new <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(leg.new,<span class="at">geom=</span><span class="st">&#39;XY&#39;</span>)</span>
<span id="cb67-126"><a href="annex-i-compendium-of-r-scripts.html#cb67-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Delete data from pixels outside the study area</span></span>
<span id="cb67-127"><a href="annex-i-compendium-of-r-scripts.html#cb67-127" aria-hidden="true" tabindex="-1"></a>  leg.new <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(leg.new)</span>
<span id="cb67-128"><a href="annex-i-compendium-of-r-scripts.html#cb67-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-129"><a href="annex-i-compendium-of-r-scripts.html#cb67-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate clhs 100 points plus locations of legacy data</span></span>
<span id="cb67-130"><a href="annex-i-compendium-of-r-scripts.html#cb67-130" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">clhs</span>(<span class="at">x =</span> leg.new, <span class="at">size =</span> <span class="dv">100</span> <span class="sc">+</span> <span class="fu">length</span>(legacy.data),  <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb67-131"><a href="annex-i-compendium-of-r-scripts.html#cb67-131" aria-hidden="true" tabindex="-1"></a>              <span class="at">must.include =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(legacy.data)))</span>
<span id="cb67-132"><a href="annex-i-compendium-of-r-scripts.html#cb67-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(res, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb67-133"><a href="annex-i-compendium-of-r-scripts.html#cb67-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get sampling points</span></span>
<span id="cb67-134"><a href="annex-i-compendium-of-r-scripts.html#cb67-134" aria-hidden="true" tabindex="-1"></a>  points <span class="ot">&lt;-</span> res<span class="sc">$</span>sampled_data</span>
<span id="cb67-135"><a href="annex-i-compendium-of-r-scripts.html#cb67-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-136"><a href="annex-i-compendium-of-r-scripts.html#cb67-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot points</span></span>
<span id="cb67-137"><a href="annex-i-compendium-of-r-scripts.html#cb67-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples (blue circles) and legacy samples (red diamonds)&quot;</span>)</span>
<span id="cb67-138"><a href="annex-i-compendium-of-r-scripts.html#cb67-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(points[,<span class="fu">c</span>(<span class="st">&quot;x&quot;</span>,<span class="st">&quot;y&quot;</span>)], <span class="at">col=</span><span class="st">&quot;navy&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb67-139"><a href="annex-i-compendium-of-r-scripts.html#cb67-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(legacy.data, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">5</span>, <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb67-140"><a href="annex-i-compendium-of-r-scripts.html#cb67-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-141"><a href="annex-i-compendium-of-r-scripts.html#cb67-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-142"><a href="annex-i-compendium-of-r-scripts.html#cb67-142" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 - Working with large raster data ==========================================</span></span>
<span id="cb67-143"><a href="annex-i-compendium-of-r-scripts.html#cb67-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-144"><a href="annex-i-compendium-of-r-scripts.html#cb67-144" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Scaling covariates</span></span>
<span id="cb67-145"><a href="annex-i-compendium-of-r-scripts.html#cb67-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregation of covariates by a factor of 10. </span></span>
<span id="cb67-146"><a href="annex-i-compendium-of-r-scripts.html#cb67-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The original grid resolution is up-scaled using the mean value of the pixels in the grid</span></span>
<span id="cb67-147"><a href="annex-i-compendium-of-r-scripts.html#cb67-147" aria-hidden="true" tabindex="-1"></a>    cov.dat2 <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(cov.dat, <span class="at">fact=</span><span class="dv">10</span>, <span class="at">fun=</span><span class="st">&quot;mean&quot;</span>)</span>
<span id="cb67-148"><a href="annex-i-compendium-of-r-scripts.html#cb67-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create clhs samples upon the resamples rasters  </span></span>
<span id="cb67-149"><a href="annex-i-compendium-of-r-scripts.html#cb67-149" aria-hidden="true" tabindex="-1"></a>    resampled.clhs <span class="ot">&lt;-</span> <span class="fu">clhs</span>(raster<span class="sc">::</span><span class="fu">stack</span>(cov.dat2), <span class="at">size =</span> <span class="dv">100</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb67-150"><a href="annex-i-compendium-of-r-scripts.html#cb67-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(resampled.clhs, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb67-151"><a href="annex-i-compendium-of-r-scripts.html#cb67-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the points over the 1st raster</span></span>
<span id="cb67-152"><a href="annex-i-compendium-of-r-scripts.html#cb67-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat2[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;Regular resampled data&quot;</span>)</span>
<span id="cb67-153"><a href="annex-i-compendium-of-r-scripts.html#cb67-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(resampled.clhs<span class="sc">$</span>sampled_data , <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb67-154"><a href="annex-i-compendium-of-r-scripts.html#cb67-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-155"><a href="annex-i-compendium-of-r-scripts.html#cb67-155" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Sampling to regular points</span></span>
<span id="cb67-156"><a href="annex-i-compendium-of-r-scripts.html#cb67-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a regular grid of 1000 points on the covariate space</span></span>
<span id="cb67-157"><a href="annex-i-compendium-of-r-scripts.html#cb67-157" aria-hidden="true" tabindex="-1"></a>    regular.sample <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(cov.dat, <span class="at">size =</span> <span class="dv">1000</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">method=</span><span class="st">&quot;regular&quot;</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-158"><a href="annex-i-compendium-of-r-scripts.html#cb67-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot the points over the 1st raster</span></span>
<span id="cb67-159"><a href="annex-i-compendium-of-r-scripts.html#cb67-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;Regular resampled data&quot;</span>)</span>
<span id="cb67-160"><a href="annex-i-compendium-of-r-scripts.html#cb67-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(regular.sample, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb67-161"><a href="annex-i-compendium-of-r-scripts.html#cb67-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-162"><a href="annex-i-compendium-of-r-scripts.html#cb67-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create clhs samples upon the regular grid  </span></span>
<span id="cb67-163"><a href="annex-i-compendium-of-r-scripts.html#cb67-163" aria-hidden="true" tabindex="-1"></a>    regular.sample.clhs <span class="ot">&lt;-</span> <span class="fu">clhs</span>(regular.sample, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>)</span>
<span id="cb67-164"><a href="annex-i-compendium-of-r-scripts.html#cb67-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(regular.sample.clhs, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb67-165"><a href="annex-i-compendium-of-r-scripts.html#cb67-165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot points of clhs samples</span></span>
<span id="cb67-166"><a href="annex-i-compendium-of-r-scripts.html#cb67-166" aria-hidden="true" tabindex="-1"></a>    points <span class="ot">&lt;-</span> regular.sample.clhs<span class="sc">$</span>sampled_data <span class="co"># Get point coordinates of clhs sampling</span></span>
<span id="cb67-167"><a href="annex-i-compendium-of-r-scripts.html#cb67-167" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples (red) and covariate resampled points (blue)&quot;</span>)</span>
<span id="cb67-168"><a href="annex-i-compendium-of-r-scripts.html#cb67-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(regular.sample, <span class="at">col=</span><span class="st">&quot;navy&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>)</span>
<span id="cb67-169"><a href="annex-i-compendium-of-r-scripts.html#cb67-169" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(points, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">cex=</span><span class="dv">1</span>)</span>
<span id="cb67-170"><a href="annex-i-compendium-of-r-scripts.html#cb67-170" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb67-171"><a href="annex-i-compendium-of-r-scripts.html#cb67-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-172"><a href="annex-i-compendium-of-r-scripts.html#cb67-172" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Cost–constrained cLHS sampling</span></span>
<span id="cb67-173"><a href="annex-i-compendium-of-r-scripts.html#cb67-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a cost surface: &#39;Distance to roads&#39;</span></span>
<span id="cb67-174"><a href="annex-i-compendium-of-r-scripts.html#cb67-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-175"><a href="annex-i-compendium-of-r-scripts.html#cb67-175" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate distance to roads with te same spatial definition than the covariates</span></span>
<span id="cb67-176"><a href="annex-i-compendium-of-r-scripts.html#cb67-176" aria-hidden="true" tabindex="-1"></a>      <span class="co"># dist2access &lt;- terra::distance(cov.dat[[1]], roads, progress=TRUE)</span></span>
<span id="cb67-177"><a href="annex-i-compendium-of-r-scripts.html#cb67-177" aria-hidden="true" tabindex="-1"></a>      <span class="co"># names(dist2access) &lt;- &quot;dist2access&quot;</span></span>
<span id="cb67-178"><a href="annex-i-compendium-of-r-scripts.html#cb67-178" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save cost surface to disk</span></span>
<span id="cb67-179"><a href="annex-i-compendium-of-r-scripts.html#cb67-179" aria-hidden="true" tabindex="-1"></a>      <span class="co"># writeRaster(dist2access, paste0(results.path,&quot;nghe_d2roads.tif&quot;), overwrite=TRUE)</span></span>
<span id="cb67-180"><a href="annex-i-compendium-of-r-scripts.html#cb67-180" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb67-181"><a href="annex-i-compendium-of-r-scripts.html#cb67-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load pre-calculated distance–to–roads surface</span></span>
<span id="cb67-182"><a href="annex-i-compendium-of-r-scripts.html#cb67-182" aria-hidden="true" tabindex="-1"></a>    dist2access <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="fu">paste0</span>(results.path,<span class="st">&quot;nghe_d2roads.tif&quot;</span>))</span>
<span id="cb67-183"><a href="annex-i-compendium-of-r-scripts.html#cb67-183" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate to the same soatial definition</span></span>
<span id="cb67-184"><a href="annex-i-compendium-of-r-scripts.html#cb67-184" aria-hidden="true" tabindex="-1"></a>     <span class="co"># dist2access &lt;- aggregate(dist2access, fact=10, fun=&quot;mean&quot;)</span></span>
<span id="cb67-185"><a href="annex-i-compendium-of-r-scripts.html#cb67-185" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(dist2access)</span>
<span id="cb67-186"><a href="annex-i-compendium-of-r-scripts.html#cb67-186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(nghe, <span class="at">col=</span><span class="st">&quot;transparent&quot;</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-187"><a href="annex-i-compendium-of-r-scripts.html#cb67-187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-188"><a href="annex-i-compendium-of-r-scripts.html#cb67-188" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add cost surface as raster layer</span></span>
<span id="cb67-189"><a href="annex-i-compendium-of-r-scripts.html#cb67-189" aria-hidden="true" tabindex="-1"></a>    cov.dat.ras <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">addLayer</span>(cov.dat.ras,raster<span class="sc">::</span><span class="fu">raster</span>(dist2access))</span>
<span id="cb67-190"><a href="annex-i-compendium-of-r-scripts.html#cb67-190" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(cov.dat.ras)</span>
<span id="cb67-191"><a href="annex-i-compendium-of-r-scripts.html#cb67-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-192"><a href="annex-i-compendium-of-r-scripts.html#cb67-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Harmonize NAs</span></span>
<span id="cb67-193"><a href="annex-i-compendium-of-r-scripts.html#cb67-193" aria-hidden="true" tabindex="-1"></a>    cov.dat.ras<span class="sc">$</span>dist2access <span class="ot">&lt;-</span> cov.dat.ras<span class="sc">$</span>dist2access <span class="sc">*</span> cov.dat.ras[[<span class="dv">1</span>]]<span class="sc">/</span>cov.dat.ras[[<span class="dv">1</span>]]</span>
<span id="cb67-194"><a href="annex-i-compendium-of-r-scripts.html#cb67-194" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat.ras<span class="sc">$</span>dist2access)</span>
<span id="cb67-195"><a href="annex-i-compendium-of-r-scripts.html#cb67-195" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(nghe, <span class="at">col=</span><span class="st">&quot;transparent&quot;</span>,<span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-196"><a href="annex-i-compendium-of-r-scripts.html#cb67-196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-197"><a href="annex-i-compendium-of-r-scripts.html#cb67-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sampling points</span></span>
<span id="cb67-198"><a href="annex-i-compendium-of-r-scripts.html#cb67-198" aria-hidden="true" tabindex="-1"></a>    cost.clhs <span class="ot">&lt;-</span> <span class="fu">clhs</span>(cov.dat.ras, <span class="at">size =</span> minimum_n, <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>, <span class="at">simple =</span> <span class="cn">FALSE</span>, <span class="at">cost =</span> <span class="st">&#39;dist2access&#39;</span>,  <span class="at">use.cpp =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-199"><a href="annex-i-compendium-of-r-scripts.html#cb67-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cost.clhs, <span class="fu">c</span>(<span class="st">&#39;obj&#39;</span>))</span>
<span id="cb67-200"><a href="annex-i-compendium-of-r-scripts.html#cb67-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get and plot the point of samples</span></span>
<span id="cb67-201"><a href="annex-i-compendium-of-r-scripts.html#cb67-201" aria-hidden="true" tabindex="-1"></a>    points <span class="ot">&lt;-</span> cost.clhs<span class="sc">$</span>sampled_data  <span class="co"># Get point coordinates of clhs sampling</span></span>
<span id="cb67-202"><a href="annex-i-compendium-of-r-scripts.html#cb67-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat.ras[[<span class="st">&#39;dist2access&#39;</span>]], <span class="at">main=</span><span class="st">&quot;cLHS samples with &#39;cost&#39; constraints&quot;</span>)</span>
<span id="cb67-203"><a href="annex-i-compendium-of-r-scripts.html#cb67-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(points, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">cex=</span><span class="dv">1</span>)</span>
<span id="cb67-204"><a href="annex-i-compendium-of-r-scripts.html#cb67-204" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-205"><a href="annex-i-compendium-of-r-scripts.html#cb67-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-206"><a href="annex-i-compendium-of-r-scripts.html#cb67-206" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Replacement areas in cLHS design  </span></span>
<span id="cb67-207"><a href="annex-i-compendium-of-r-scripts.html#cb67-207" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-208"><a href="annex-i-compendium-of-r-scripts.html#cb67-208" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the similarity to points in a buffer of distance &#39;D&#39;</span></span>
<span id="cb67-209"><a href="annex-i-compendium-of-r-scripts.html#cb67-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the buffers around points # cov25??</span></span>
<span id="cb67-210"><a href="annex-i-compendium-of-r-scripts.html#cb67-210" aria-hidden="true" tabindex="-1"></a>    gw <span class="ot">&lt;-</span> <span class="fu">similarity_buffer</span>(cov.dat.ras, cost.clhs<span class="sc">$</span>sampled_data, <span class="at">buffer =</span> D)</span>
<span id="cb67-211"><a href="annex-i-compendium-of-r-scripts.html#cb67-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-212"><a href="annex-i-compendium-of-r-scripts.html#cb67-212" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb67-213"><a href="annex-i-compendium-of-r-scripts.html#cb67-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(elevation, <span class="at">legend=</span><span class="cn">TRUE</span>,<span class="at">main=</span><span class="fu">paste</span>(<span class="st">&quot;Similarity probability over elevation&quot;</span>))</span>
<span id="cb67-214"><a href="annex-i-compendium-of-r-scripts.html#cb67-214" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Overlay points</span></span>
<span id="cb67-215"><a href="annex-i-compendium-of-r-scripts.html#cb67-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(cost.clhs<span class="sc">$</span>sampled_data[<span class="dv">1</span>], <span class="at">col =</span> <span class="st">&quot;dodgerblue&quot;</span>, <span class="at">pch =</span> <span class="dv">3</span>)</span>
<span id="cb67-216"><a href="annex-i-compendium-of-r-scripts.html#cb67-216" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Overlay probability stack for point 1</span></span>
<span id="cb67-217"><a href="annex-i-compendium-of-r-scripts.html#cb67-217" aria-hidden="true" tabindex="-1"></a>    colors <span class="ot">&lt;-</span> <span class="fu">c</span>((RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">9</span>, <span class="st">&quot;YlOrRd&quot;</span>)))</span>
<span id="cb67-218"><a href="annex-i-compendium-of-r-scripts.html#cb67-218" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">plot</span>(gw[[<span class="dv">1</span>]], <span class="at">add=</span><span class="cn">TRUE</span> ,  <span class="at">legend=</span><span class="cn">FALSE</span>, <span class="at">col=</span>colors)</span>
<span id="cb67-219"><a href="annex-i-compendium-of-r-scripts.html#cb67-219" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Overlay 1st cLHS point</span></span>
<span id="cb67-220"><a href="annex-i-compendium-of-r-scripts.html#cb67-220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(cost.clhs<span class="sc">$</span>sampled_data[<span class="dv">1</span>,<span class="dv">1</span>], <span class="at">col =</span> <span class="st">&quot;black&quot;</span>, <span class="at">pch =</span> <span class="dv">3</span>,<span class="at">cex=</span><span class="dv">1</span>)</span>
<span id="cb67-221"><a href="annex-i-compendium-of-r-scripts.html#cb67-221" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-222"><a href="annex-i-compendium-of-r-scripts.html#cb67-222" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Polygonize replacement areas by similarity    </span></span>
<span id="cb67-223"><a href="annex-i-compendium-of-r-scripts.html#cb67-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-224"><a href="annex-i-compendium-of-r-scripts.html#cb67-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine a threshold break to delineate replacement areas</span></span>
<span id="cb67-225"><a href="annex-i-compendium-of-r-scripts.html#cb67-225" aria-hidden="true" tabindex="-1"></a>    similarity_threshold <span class="ot">&lt;-</span> <span class="fl">0.90</span></span>
<span id="cb67-226"><a href="annex-i-compendium-of-r-scripts.html#cb67-226" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reclassify buffer raster data according to the threshold break of probability</span></span>
<span id="cb67-227"><a href="annex-i-compendium-of-r-scripts.html#cb67-227" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1 = similarity &gt;= similarity_break; NA =  similarity &lt;  similarity_break</span></span>
<span id="cb67-228"><a href="annex-i-compendium-of-r-scripts.html#cb67-228" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a vector with the break intervals and the output values (NA,1) </span></span>
<span id="cb67-229"><a href="annex-i-compendium-of-r-scripts.html#cb67-229" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, similarity_threshold, <span class="cn">NA</span>, similarity_threshold, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb67-230"><a href="annex-i-compendium-of-r-scripts.html#cb67-230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to a matrix</span></span>
<span id="cb67-231"><a href="annex-i-compendium-of-r-scripts.html#cb67-231" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">matrix</span>(breaks, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-232"><a href="annex-i-compendium-of-r-scripts.html#cb67-232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reclassify the data in the layers from probabilities to (NA,)</span></span>
<span id="cb67-233"><a href="annex-i-compendium-of-r-scripts.html#cb67-233" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">=</span> <span class="fu">stack</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>raster<span class="sc">::</span><span class="fu">nlayers</span>(gw), <span class="cf">function</span>(i){raster<span class="sc">::</span><span class="fu">reclassify</span>(gw[[i]], breaks, <span class="at">right=</span><span class="cn">FALSE</span>)}))</span>
<span id="cb67-234"><a href="annex-i-compendium-of-r-scripts.html#cb67-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-235"><a href="annex-i-compendium-of-r-scripts.html#cb67-235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Polygonize replacement areas </span></span>
<span id="cb67-236"><a href="annex-i-compendium-of-r-scripts.html#cb67-236" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">as.list</span>(s), rasterToPolygons, <span class="at">dissolve=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-237"><a href="annex-i-compendium-of-r-scripts.html#cb67-237" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">bind</span>(s,<span class="at">keepnames=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-238"><a href="annex-i-compendium-of-r-scripts.html#cb67-238" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the identifier of the corresponding target point</span></span>
<span id="cb67-239"><a href="annex-i-compendium-of-r-scripts.html#cb67-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(s)){</span>
<span id="cb67-240"><a href="annex-i-compendium-of-r-scripts.html#cb67-240" aria-hidden="true" tabindex="-1"></a>      s<span class="sc">@</span>data<span class="sc">$</span>ID[i] <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(stringr<span class="sc">::</span><span class="fu">str_replace</span>(s<span class="sc">@</span>polygons[[i]]<span class="sc">@</span>ID,<span class="st">&quot;1.&quot;</span>,<span class="st">&quot;&quot;</span>))</span>
<span id="cb67-241"><a href="annex-i-compendium-of-r-scripts.html#cb67-241" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb67-242"><a href="annex-i-compendium-of-r-scripts.html#cb67-242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean the data by storing target ID data only</span></span>
<span id="cb67-243"><a href="annex-i-compendium-of-r-scripts.html#cb67-243" aria-hidden="true" tabindex="-1"></a>    s<span class="sc">@</span>data <span class="ot">&lt;-</span> s<span class="sc">@</span>data[<span class="st">&quot;ID&quot;</span>]</span>
<span id="cb67-244"><a href="annex-i-compendium-of-r-scripts.html#cb67-244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-245"><a href="annex-i-compendium-of-r-scripts.html#cb67-245" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb67-246"><a href="annex-i-compendium-of-r-scripts.html#cb67-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cov.dat[[<span class="dv">1</span>]], <span class="at">main=</span><span class="fu">paste</span>(<span class="st">&quot;cLHS samples and replacement areas for threshold = &quot;</span>, similarity_threshold))</span>
<span id="cb67-247"><a href="annex-i-compendium-of-r-scripts.html#cb67-247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(s,<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="cn">NA</span>, <span class="at">border=</span><span class="st">&quot;gray40&quot;</span>)</span>
<span id="cb67-248"><a href="annex-i-compendium-of-r-scripts.html#cb67-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(cost.clhs<span class="sc">$</span>sampled_data, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch =</span> <span class="dv">3</span>)</span>
<span id="cb67-249"><a href="annex-i-compendium-of-r-scripts.html#cb67-249" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-250"><a href="annex-i-compendium-of-r-scripts.html#cb67-250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Export replacement areas to shapefile </span></span>
<span id="cb67-251"><a href="annex-i-compendium-of-r-scripts.html#cb67-251" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(s)</span>
<span id="cb67-252"><a href="annex-i-compendium-of-r-scripts.html#cb67-252" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(s, <span class="fu">file.path</span>(<span class="fu">paste0</span>(results.path,<span class="st">&#39;replacement_areas_&#39;</span>, D, <span class="st">&#39;.shp&#39;</span>)), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-253"><a href="annex-i-compendium-of-r-scripts.html#cb67-253" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-254"><a href="annex-i-compendium-of-r-scripts.html#cb67-254" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write cLHS sampling points to shapefile</span></span>
<span id="cb67-255"><a href="annex-i-compendium-of-r-scripts.html#cb67-255" aria-hidden="true" tabindex="-1"></a>    cost.clhs<span class="sc">$</span>sampled_data<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="fu">row</span>(cost.clhs<span class="sc">$</span>sampled_data)[,<span class="dv">1</span>] <span class="co"># Add identifier</span></span>
<span id="cb67-256"><a href="annex-i-compendium-of-r-scripts.html#cb67-256" aria-hidden="true" tabindex="-1"></a>    out.pts <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(cost.clhs<span class="sc">$</span>sampled_data)</span>
<span id="cb67-257"><a href="annex-i-compendium-of-r-scripts.html#cb67-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(out.pts, <span class="fu">paste0</span>(results.path,<span class="st">&#39;target_clhs.shp&#39;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-258"><a href="annex-i-compendium-of-r-scripts.html#cb67-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-259"><a href="annex-i-compendium-of-r-scripts.html#cb67-259" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb67-260"><a href="annex-i-compendium-of-r-scripts.html#cb67-260" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 - Constrained cLHS sampling taking into account accessibility and legacy data  </span></span>
<span id="cb67-261"><a href="annex-i-compendium-of-r-scripts.html#cb67-261" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load legacy data </span></span>
<span id="cb67-262"><a href="annex-i-compendium-of-r-scripts.html#cb67-262" aria-hidden="true" tabindex="-1"></a>    legacy <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">file.path</span>(<span class="fu">paste0</span>(shp.path,<span class="st">&quot;/legacy_soils.shp&quot;</span>)),<span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-263"><a href="annex-i-compendium-of-r-scripts.html#cb67-263" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-264"><a href="annex-i-compendium-of-r-scripts.html#cb67-264" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate distance to roads and delete NA in outputs</span></span>
<span id="cb67-265"><a href="annex-i-compendium-of-r-scripts.html#cb67-265" aria-hidden="true" tabindex="-1"></a>    cost <span class="ot">&lt;-</span> cov.dat </span>
<span id="cb67-266"><a href="annex-i-compendium-of-r-scripts.html#cb67-266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add distance to roads co the stack</span></span>
<span id="cb67-267"><a href="annex-i-compendium-of-r-scripts.html#cb67-267" aria-hidden="true" tabindex="-1"></a>    cost <span class="ot">&lt;-</span> <span class="fu">c</span>(cost, <span class="fu">rast</span>(cov.dat.ras<span class="sc">$</span>dist2access))</span>
<span id="cb67-268"><a href="annex-i-compendium-of-r-scripts.html#cb67-268" aria-hidden="true" tabindex="-1"></a>    cost<span class="sc">$</span>slope <span class="ot">&lt;-</span> slope</span>
<span id="cb67-269"><a href="annex-i-compendium-of-r-scripts.html#cb67-269" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate clhs points with legacy, cost and buffer to roads</span></span>
<span id="cb67-270"><a href="annex-i-compendium-of-r-scripts.html#cb67-270" aria-hidden="true" tabindex="-1"></a>    buff_inner<span class="ot">=</span><span class="dv">20</span>;</span>
<span id="cb67-271"><a href="annex-i-compendium-of-r-scripts.html#cb67-271" aria-hidden="true" tabindex="-1"></a>    buff_outer<span class="ot">=</span><span class="dv">3000</span></span>
<span id="cb67-272"><a href="annex-i-compendium-of-r-scripts.html#cb67-272" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert roads to sf object and cast to multilinestring</span></span>
<span id="cb67-273"><a href="annex-i-compendium-of-r-scripts.html#cb67-273" aria-hidden="true" tabindex="-1"></a>    roads2 <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(roads) <span class="sc">%&gt;%</span></span>
<span id="cb67-274"><a href="annex-i-compendium-of-r-scripts.html#cb67-274" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_cast</span>(<span class="st">&quot;MULTILINESTRING&quot;</span>) </span>
<span id="cb67-275"><a href="annex-i-compendium-of-r-scripts.html#cb67-275" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-276"><a href="annex-i-compendium-of-r-scripts.html#cb67-276" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate clhs samples using slope as cost surface, distance to roads as</span></span>
<span id="cb67-277"><a href="annex-i-compendium-of-r-scripts.html#cb67-277" aria-hidden="true" tabindex="-1"></a>    <span class="co"># access limitations, and including existing legacy data</span></span>
<span id="cb67-278"><a href="annex-i-compendium-of-r-scripts.html#cb67-278" aria-hidden="true" tabindex="-1"></a>    aa <span class="ot">&lt;-</span> sgsR<span class="sc">::</span><span class="fu">sample_clhs</span>(<span class="at">mraster =</span> cost, <span class="at">nSamp =</span> minimum_n, <span class="at">existing =</span> legacy,</span>
<span id="cb67-279"><a href="annex-i-compendium-of-r-scripts.html#cb67-279" aria-hidden="true" tabindex="-1"></a>                            <span class="at">iter =</span> <span class="dv">10000</span>, <span class="at">details =</span> <span class="cn">TRUE</span>, <span class="at">cost=</span><span class="st">&quot;slope&quot;</span>, <span class="at">access=</span>roads2,</span>
<span id="cb67-280"><a href="annex-i-compendium-of-r-scripts.html#cb67-280" aria-hidden="true" tabindex="-1"></a>                            <span class="at">buff_inner=</span>buff_inner, <span class="at">buff_outer=</span>buff_outer)</span>
<span id="cb67-281"><a href="annex-i-compendium-of-r-scripts.html#cb67-281" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-282"><a href="annex-i-compendium-of-r-scripts.html#cb67-282" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Plot distances, roads, clhs points and legacy data </span></span>
<span id="cb67-283"><a href="annex-i-compendium-of-r-scripts.html#cb67-283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cost<span class="sc">$</span>dist2access)</span>
<span id="cb67-284"><a href="annex-i-compendium-of-r-scripts.html#cb67-284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(roads,<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">&quot;black&quot;</span>)</span>
<span id="cb67-285"><a href="annex-i-compendium-of-r-scripts.html#cb67-285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(aa<span class="sc">$</span>samples[aa<span class="sc">$</span>samples<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;new&quot;</span>,], <span class="at">col=</span> <span class="st">&quot;tomato&quot;</span>,<span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb67-286"><a href="annex-i-compendium-of-r-scripts.html#cb67-286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(aa<span class="sc">$</span>samples[aa<span class="sc">$</span>samples<span class="sc">$</span>type<span class="sc">==</span><span class="st">&quot;existing&quot;</span>,], <span class="at">col=</span> <span class="st">&quot;gray40&quot;</span>, <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">pch =</span> <span class="dv">5</span>, <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb67-287"><a href="annex-i-compendium-of-r-scripts.html#cb67-287" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-288"><a href="annex-i-compendium-of-r-scripts.html#cb67-288" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write samples as shapefile</span></span>
<span id="cb67-289"><a href="annex-i-compendium-of-r-scripts.html#cb67-289" aria-hidden="true" tabindex="-1"></a>    aa<span class="sc">$</span>samples[<span class="fu">c</span>(<span class="st">&quot;type&quot;</span>,<span class="st">&quot;dist2access&quot;</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb67-290"><a href="annex-i-compendium-of-r-scripts.html#cb67-290" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_write</span>(<span class="fu">paste0</span>(results.path,<span class="st">&#39;const_clhs.shp&#39;</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="conditioned-latin-hypercube-sampling.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/luislado/Sampling_Design_GSP/edit/master/11-Compendium-of-code.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Technical Manual Soil Sampling Design.pdf", "Technical Manual Soil Sampling Design.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "static"
}
});
});
</script>

</body>

</html>
